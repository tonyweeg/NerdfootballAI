<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>NerdfootballAI v3.0 - Pool Management</title>
 
 <!-- Web App Meta Tags -->
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <meta name="apple-mobile-web-app-title" content="NerdFootball">
 
 <!-- App Icons for iOS Home Screen -->
 <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 <link rel="apple-touch-icon" sizes="152x152" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 <link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 
 <!-- Standard Favicon -->
 <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 
 <!-- Web App Manifest -->
 <link rel="manifest" href="/manifest.json">
 <meta name="theme-color" content="#334155">
 <meta name="description" content="NerdFootball AI - NFL Pick'em Game with Confidence Points">
 
 <!-- Cache Control -->
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
 <meta http-equiv="Pragma" content="no-cache">
 <meta http-equiv="Expires" content="0">
 <meta name="version" content="3.0">
 
 <script src="https://cdn.tailwindcss.com/3.4.0"></script>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 <!-- BUNDLED JavaScript Files - Reduced from 18 to 4 files for 75% faster load -->
 <script src="./poolParticipationManager.js"></script>
 <script src="./poolRemovalService.js"></script>
 <script src="./espnCacheManager.js?v=fix3"></script>
 <script src="./core-bundle.js"></script>
 <script src="./survivor-bundle.js"></script>
 <script src="./confidence-bundle.js"></script>
 <script src="./features-bundle.js"></script>
 <script src="./contactForm.js"></script>
 <!-- PHAROAH'S REAL-TIME INTEGRATION - Diamond Level WebSocket Architecture -->
 <script src="./realtimeManager.js"></script>
<!-- DISABLED: <script src="./test-survivor-diamond-architecture.js"></script> -->
 <style>
 body {
 font-family: 'Inter', sans-serif;
 }

 /* === THEME SYSTEM === */
 :root {
     /* Ocean Breeze Theme (Default) */
     --theme-bg-primary: rgb(226 232 240); /* slate-200 */
     --theme-bg-secondary: rgb(241 245 249); /* slate-100 */
     --theme-bg-card: rgb(248 250 252); /* slate-50 */
     --theme-text-primary: rgb(30 41 59); /* slate-800 */
     --theme-text-secondary: rgb(71 85 105); /* slate-600 */
     --theme-text-muted: rgb(100 116 139); /* slate-500 */
     --theme-border: rgb(203 213 225); /* slate-300 */
     --theme-gradient-start: rgb(236 254 255); /* cyan-50 */
     --theme-gradient-end: rgb(239 246 255); /* blue-50 */
     --theme-gradient-hover-start: rgb(207 250 254); /* cyan-100 */
     --theme-gradient-hover-end: rgb(219 234 254); /* blue-100 */
     --theme-accent: rgb(6 182 212); /* cyan-500 */
     --theme-accent-hover: rgb(14 165 233); /* blue-500 */
 }

 .theme-ibm {
     /* IBM Diagnostic Theme - High Contrast Terminal */
     --theme-bg-primary: #000000;        /* Pure black background */
     --theme-bg-secondary: #111111;      /* Dark gray panels */
     --theme-bg-card: #222222;           /* Card backgrounds */
     --theme-text-primary: #ffffff;      /* Pure white text */
     --theme-text-secondary: #00ff00;    /* IBM green highlights */
     --theme-text-muted: #aaaaaa;        /* Light gray muted */
     --theme-border: #00ff00;            /* Green borders */
     --theme-gradient-start: #000000;    /* Black gradients */
     --theme-gradient-end: #111111;      /* Dark gray gradients */
     --theme-gradient-hover-start: #222222; /* Hover: darker gray */
     --theme-gradient-hover-end: #333333;   /* Hover: medium gray */
     --theme-accent: #00ff00;            /* Bright green accent */
     --theme-accent-hover: #00cc00;      /* Darker green hover */
     font-family: 'Monaco', 'Courier New', 'Consolas', monospace;
 }

 .theme-warm-dark {
     /* Warm Dark Theme - True Dark Mode */
     --theme-bg-primary: #1a1a1a;        /* Dark charcoal background */
     --theme-bg-secondary: #2d2d2d;      /* Medium gray panels */
     --theme-bg-card: #3a3a3a;           /* Light gray cards */
     --theme-text-primary: #f5f5f5;      /* Light gray text */
     --theme-text-secondary: #d4af37;    /* Gold highlights */
     --theme-text-muted: #999999;        /* Medium gray muted */
     --theme-border: #555555;            /* Medium gray borders */
     --theme-gradient-start: #2a2a2a;    /* Dark gray gradients */
     --theme-gradient-end: #3a3a3a;      /* Medium gray gradients */
     --theme-gradient-hover-start: #4a4a4a; /* Hover: lighter gray */
     --theme-gradient-hover-end: #5a5a5a;   /* Hover: even lighter */
     --theme-accent: #ff8c42;            /* Warm orange accent */
     --theme-accent-hover: #ff7629;      /* Darker orange hover */
 }

 /* Theme-responsive body background */
 body {
     background-color: var(--theme-bg-primary) !important;
     color: var(--theme-text-primary) !important;
     transition: background-color 0.3s ease, color 0.3s ease;
 }
 
 /* Cache Status Indicator Styles */
 #cache-status-glyph {
   transition: background-color 0.3s ease;
 }
 
 #cache-status-glyph.current {
   background-color: rgb(34 197 94); /* green-500 */
   animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
 }
 
 #cache-status-glyph.stale {
   background-color: rgb(250 204 21); /* yellow-400 */
   animation: pulse-subtle 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
 }
 
 #cache-status-glyph.refreshing {
   background-color: rgb(59 130 246); /* blue-500 */
   animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
 }
 
 #cache-status-glyph.outdated {
   background-color: rgb(156 163 175); /* gray-400 */
   animation: none;
 }
 
 @keyframes pulse-subtle {
   0%, 100% {
     opacity: 1;
   }
   50% {
     opacity: 0.7;
   }
 }
 
 @keyframes pulse-fast {
   0%, 100% {
     opacity: 1;
     transform: scale(1);
   }
   50% {
     opacity: 0.5;
     transform: scale(1.1);
   }
 }
 
 /* Game Update Indicator Animation */
 #game-update-indicator {
   animation: bounce-in 0.5s ease-out;
 }
 
 #game-update-indicator.show {
   display: block !important;
   opacity: 1 !important;
 }
 
 #game-update-indicator.fade-out {
   opacity: 0 !important;
   transition: opacity 1s ease-out;
 }
 
 @keyframes bounce-in {
   0% {
     transform: scale(0) rotate(0deg);
     opacity: 0;
   }
   50% {
     transform: scale(1.2) rotate(180deg);
   }
   100% {
     transform: scale(1) rotate(360deg);
     opacity: 1;
   }
 }
 
 /* NFL Team Helmet Icons - Cached CSS backgrounds */
 .helmet-icon {
   width: 24px;
   height: 24px;
   background-size: contain;
   background-repeat: no-repeat;
   background-position: center;
   display: inline-block;
 }

 .helmet-mini {
   background-size: contain;
   background-repeat: no-repeat;
   background-position: center;
   display: inline-block;
 }

 /* Mobile optimizations for the new picks layout */
 @media (max-width: 640px) {
   .winner-btn span {
     font-size: 0.875rem;
   }
   
   .helmet-mini {
     width: 20px !important;
     height: 20px !important;
   }
   
   .confidence-select {
     padding: 0.5rem 0.25rem !important;
     font-size: 0.875rem !important;
   }
 }
 
 /* Team-specific helmet classes */
 .helmet-ari { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fari_Arizona_Cardinals.png?alt=media&token=38143dcd-6075-4fa3-9f3c-98518a6ec3f3'); }
 .helmet-atl { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fatl_Atlanta_Falcons.png?alt=media'); }
 .helmet-bal { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fbal_Baltimore_Ravens.png?alt=media'); }
 .helmet-buf { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fbuf_Buffalo_Bills.png?alt=media'); }
 .helmet-car { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fcar_Carolina_Panthers.png?alt=media'); }
 .helmet-chi { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fchi_Chicago_Bears.png?alt=media'); }
 .helmet-cin { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fcin_Cincinnati_Bengals.png?alt=media'); }
 .helmet-cle { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fcle_Cleveland_Browns.png?alt=media'); }
 .helmet-dal { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fdal_Dallas_Cowboys.png?alt=media'); }
 .helmet-den { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fden_Denver_Broncos.png?alt=media'); }
 .helmet-det { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fdet_Detroit_Lions.png?alt=media'); }
 .helmet-gb { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fgb_Green_Bay_Packers.png?alt=media'); }
 .helmet-hou { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fhou_Houston_Texans.png?alt=media'); }
 .helmet-ind { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Find_Indianapolis_Colts.png?alt=media'); }
 .helmet-jax { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fjax_Jacksonville_Jaguars.png?alt=media'); }
 .helmet-kc { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fkc_Kansas_City_Chiefs.png?alt=media'); }
 .helmet-lv { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Flv_Las_Vegas_Raiders.png?alt=media'); }
 .helmet-lac { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Flac_Los_Angeles_Chargers.png?alt=media'); }
 .helmet-lar { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Flar_Los_Angeles_Rams.png?alt=media'); }
 .helmet-mia { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fmia_Miami_Dolphins.png?alt=media'); }
 .helmet-min { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fmin_Minnesota_Vikings.png?alt=media'); }
 .helmet-ne { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fne_New_England_Patriots.png?alt=media'); }
 .helmet-no { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fno_New_Orleans_Saints.png?alt=media'); }
 .helmet-nyg { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fnyg_New_York_Giants.png?alt=media'); }
 .helmet-nyj { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fnyj_New_York_Jets.png?alt=media'); }
 .helmet-phi { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fphi_Philadelphia_Eagles.png?alt=media'); }
 .helmet-pit { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fpit_Pittsburgh_Steelers.png?alt=media'); }
 .helmet-sf { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fsf_San_Francisco_49ers.png?alt=media'); }
 .helmet-sea { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fsea_Seattle_Seahawks.png?alt=media'); }
 .helmet-tb { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Ftb_Tampa_Bay_Buccaneers.png?alt=media'); }
 .helmet-ten { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Ften_Tennessee_Titans.png?alt=media'); }
 .helmet-was { background-image: url('https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nfl-logos%2Fwas_Washington_Commanders.png?alt=media'); }

 /* Survivor Results View Styles */
 .survivor-active {
   background-color: #dcfce7; /* Light green */
 }
 .survivor-eliminated {
   background-color: #fce7e7; /* Light rose */
 }
 .survivor-grid {
   min-height: 600px;
 }

 .winner-btn.selected, .result-btn.selected {
 background-color: #334155; /* slate-700 */
 color: white;
 border-color: #1e293b; /* slate-800 */
 }
 .winner-btn:disabled, .result-btn:disabled, #reset-picks-btn:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #D1D5DB;
 }
 select:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #f3f4f6;
 }
 .view-toggle-btn.active {
 background-color: #475569; /* slate-600 */
 color: white;
 }
 .admin-tab {
 background-color: #f8fafc; /* slate-50 */
 border: 2px solid #e2e8f0; /* slate-200 */
 border-radius: 0.5rem; /* rounded-lg */
 padding: 0.75rem 1.5rem; /* py-3 px-6 */
 font-weight: 600; /* font-semibold */
 color: #475569; /* slate-600 */
 transition: all 0.2s ease-in-out;
 box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
 cursor: pointer;
 }
 .admin-tab:hover {
 background-color: #f1f5f9; /* slate-100 */
 border-color: #cbd5e1; /* slate-300 */
 color: #334155; /* slate-700 */
 box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* shadow-md */
 transform: translateY(-1px);
 }
 .admin-tab.active {
 background-color: #475569; /* slate-600 */
 border-color: #475569; /* slate-600 */
 color: white;
 box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* shadow-md */
 }
 .admin-tab.active:hover {
 background-color: #334155; /* slate-700 */
 border-color: #334155; /* slate-700 */
 }
 .form-input {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 border: 1px solid #9ca3af; /* gray-400 */
 background-color: #f8fafc; /* slate-50 */
 }
 .form-btn {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 font-weight: 600;
 color: white;
 background-image: linear-gradient(to bottom, #64748b, #334155);
 border: 1px solid #1e293b;
 box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
 }
 .form-btn:hover {
 background-image: linear-gradient(to bottom, #475569, #1e293b);
 }
 .loader {
 border: 4px solid #f3f3f3;
 border-top: 4px solid #64748b; /* slate-500 */
 border-radius: 50%;
 width: 40px;
 height: 40px;
 animation: spin 1s linear infinite;
 margin: 20px auto;
 }
 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
 #save-status-icon svg {
 animation: spin 1s linear infinite;
 }
  #settings-modal {
    background-color: rgba(0, 0, 0, 0.5);
  }
  .public-leaderboard-table tr:nth-child(even) {
    background-color: #f8fafc; /* slate-50 */
  }
  .public-leaderboard-table tr:hover {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
  .public-leaderboard-table tr:hover td {
    background-color: #e2e8f0 !important; /* slate-200 */
  }

  /* Admin Pick Management Styles */
  .team-pick-btn {
    transition: all 0.2s ease;
    border-color: #d1d5db; /* gray-300 */
  }
  .team-pick-btn:hover {
    background-color: #f3f4f6; /* gray-100 */
    border-color: #9ca3af; /* gray-400 */
  }
  .team-pick-btn.selected {
    background-color: #334155; /* slate-700 */
    color: white;
    border-color: #1e293b; /* slate-800 */
  }

  /* Survivor-specific styles */
  .helmet-icon-lg {
    width: 64px;
    height: 64px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    display: inline-block;
  }
  .team-btn.selected {
    background-color: #334155; /* slate-700 */
    color: white;
    border-color: #1e293b; /* slate-800 */
  }
  .team-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #9ca3af;
    color: #e5e7eb;
  }
  .team-btn.used-team {
    background-color: #fecaca; /* red-200 */
    border-color: #f87171; /* red-400 */
    opacity: 0.6;
  }
  .team-btn.used-team:disabled {
    background-color: #fca5a5; /* red-300 */
    border-color: #ef4444; /* red-500 */
    opacity: 0.7;
  }
    background-color: #dbeafe !important; /* blue-100 */
    border-color: #2563eb !important; /* blue-600 */
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
  }

  /* Grid View Specific Styles */
  .grid-table tr:nth-child(even) {
    background-color: #f8fafc; /* slate-50 */
  }
  .grid-table tr:hover {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
  .grid-table tr:hover td {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
  .grid-table td.highlight-column {
    background-color: #f1f5f9; /* slate-100 */
  }
  .grid-table tr:hover td.highlight-column {
    background-color: #cbd5e1 !important; /* slate-300 */
  }
  th, td {
    white-space: nowrap;
  }
  th {
    position: sticky;
    top: 0;
    background-color: #f9fafb; /* gray-50 */
  }
  .place-col {
    position: sticky;
    left: 0;
    background-color: #f9fafb; /* gray-50 */
    z-index: 11;
  }
  .player-name {
    position: sticky;
    left: 60px; /* Adjust based on place column width */
    background-color: #f9fafb; /* gray-50 */
    z-index: 10;
  }
  .sortable-header {
    cursor: pointer;
    pointer-events: auto;
  }
  .grid-helmet-icon {
    width: 16px;
    height: 16px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    display: inline-block;
  }
  
  /* Game update glow effect */
  .game-updated-glow {
    animation: game-glow 3s ease-out !important;
    position: relative !important;
  }
  
  @keyframes game-glow {
    0% {
      box-shadow: 0 0 10px 2px rgba(59, 130, 246, 1), 
                  0 0 20px 4px rgba(59, 130, 246, 0.8),
                  inset 0 0 10px rgba(59, 130, 246, 0.3) !important;
      border-color: rgb(59, 130, 246) !important;
      background-color: rgba(59, 130, 246, 0.05) !important;
    }
    50% {
      box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.6), 
                  0 0 30px 10px rgba(59, 130, 246, 0.4),
                  inset 0 0 15px rgba(59, 130, 246, 0.2) !important;
      border-color: rgb(96, 165, 250) !important;
      background-color: rgba(96, 165, 250, 0.08) !important;
    }
    100% {
      box-shadow: none;
      border-color: initial;
      background-color: initial;
    }
  }
  
  /* Make glow work on buttons too */
  button.game-updated-glow,
  .winner-btn.game-updated-glow,
  .result-btn.game-updated-glow {
    animation: button-glow 3s ease-out !important;
  }
  
  @keyframes button-glow {
    0%, 100% {
      transform: scale(1);
    }
    25% {
      transform: scale(1.05);
    }
    50% {
      transform: scale(1.02);
    }
  }

/* === NFL TEAM THEMES === */
.theme-arizona-cardinals-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fef2f2; --theme-text-primary: #97233F; --theme-text-secondary: #000000; --theme-text-muted: #6b7280; --theme-border: #fecaca; --theme-gradient-start: #fef2f2; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #fee2e2; --theme-gradient-hover-end: #fed7aa; --theme-accent: #97233F; --theme-accent-hover: #7c1d35; }
.theme-arizona-cardinals-dark { --theme-bg-primary: #97233F; --theme-bg-secondary: #7c1d35; --theme-bg-card: #65182b; --theme-text-primary: #ffffff; --theme-text-secondary: #FFB612; --theme-text-muted: #d1d5db; --theme-border: #a91e3a; --theme-gradient-start: #65182b; --theme-gradient-end: #7c1d35; --theme-gradient-hover-start: #7c1d35; --theme-gradient-hover-end: #97233F; --theme-accent: #FFB612; --theme-accent-hover: #eaa70f; }
.theme-buffalo-bills-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #00338D; --theme-text-secondary: #C60C30; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #fef2f2; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #fee2e2; --theme-accent: #00338D; --theme-accent-hover: #002a73; }
.theme-buffalo-bills-dark { --theme-bg-primary: #00338D; --theme-bg-secondary: #002a73; --theme-bg-card: #00215a; --theme-text-primary: #ffffff; --theme-text-secondary: #C60C30; --theme-text-muted: #d1d5db; --theme-border: #003b9f; --theme-gradient-start: #00215a; --theme-gradient-end: #002a73; --theme-gradient-hover-start: #002a73; --theme-gradient-hover-end: #00338D; --theme-accent: #C60C30; --theme-accent-hover: #a50a27; }
.theme-kansas-city-chiefs-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fef2f2; --theme-text-primary: #E31837; --theme-text-secondary: #FFB81C; --theme-text-muted: #6b7280; --theme-border: #fecaca; --theme-gradient-start: #fef2f2; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #fee2e2; --theme-gradient-hover-end: #fef3c7; --theme-accent: #E31837; --theme-accent-hover: #c5142e; }
.theme-kansas-city-chiefs-dark { --theme-bg-primary: #E31837; --theme-bg-secondary: #c5142e; --theme-bg-card: #a71025; --theme-text-primary: #ffffff; --theme-text-secondary: #FFB81C; --theme-text-muted: #fef3c7; --theme-border: #f21d40; --theme-gradient-start: #a71025; --theme-gradient-end: #c5142e; --theme-gradient-hover-start: #c5142e; --theme-gradient-hover-end: #E31837; --theme-accent: #FFB81C; --theme-accent-hover: #eaa70f; }

.theme-atlanta-falcons-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fef2f2; --theme-text-primary: #A71930; --theme-text-secondary: #000000; --theme-text-muted: #6b7280; --theme-border: #fecaca; --theme-gradient-start: #fef2f2; --theme-gradient-end: #f9fafb; --theme-gradient-hover-start: #fee2e2; --theme-gradient-hover-end: #f3f4f6; --theme-accent: #A71930; --theme-accent-hover: #881426; }
.theme-atlanta-falcons-dark { --theme-bg-primary: #A71930; --theme-bg-secondary: #881426; --theme-bg-card: #6b101d; --theme-text-primary: #ffffff; --theme-text-secondary: #f3f4f6; --theme-text-muted: #d1d5db; --theme-border: #b81c32; --theme-gradient-start: #6b101d; --theme-gradient-end: #881426; --theme-gradient-hover-start: #881426; --theme-gradient-hover-end: #A71930; --theme-accent: #f3f4f6; --theme-accent-hover: #e5e7eb; }
.theme-baltimore-ravens-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #faf5ff; --theme-text-primary: #241773; --theme-text-secondary: #9E7C0C; --theme-text-muted: #6b7280; --theme-border: #e9d5ff; --theme-gradient-start: #faf5ff; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #f3e8ff; --theme-gradient-hover-end: #fef3c7; --theme-accent: #241773; --theme-accent-hover: #1e125f; }
.theme-baltimore-ravens-dark { --theme-bg-primary: #241773; --theme-bg-secondary: #1e125f; --theme-bg-card: #190e4c; --theme-text-primary: #ffffff; --theme-text-secondary: #9E7C0C; --theme-text-muted: #d1d5db; --theme-border: #2a1a7a; --theme-gradient-start: #190e4c; --theme-gradient-end: #1e125f; --theme-gradient-hover-start: #1e125f; --theme-gradient-hover-end: #241773; --theme-accent: #9E7C0C; --theme-accent-hover: #836409; }
.theme-carolina-panthers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #0085CA; --theme-text-secondary: #000000; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #f9fafb; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #f3f4f6; --theme-accent: #0085CA; --theme-accent-hover: #0070a8; }
.theme-carolina-panthers-dark { --theme-bg-primary: #0085CA; --theme-bg-secondary: #0070a8; --theme-bg-card: #005c86; --theme-text-primary: #ffffff; --theme-text-secondary: #BFC0BF; --theme-text-muted: #d1d5db; --theme-border: #0095dc; --theme-gradient-start: #005c86; --theme-gradient-end: #0070a8; --theme-gradient-hover-start: #0070a8; --theme-gradient-hover-end: #0085CA; --theme-accent: #BFC0BF; --theme-accent-hover: #a8a9a8; }
.theme-chicago-bears-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f8fafc; --theme-text-primary: #0B162A; --theme-text-secondary: #C83803; --theme-text-muted: #6b7280; --theme-border: #e2e8f0; --theme-gradient-start: #f8fafc; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #f1f5f9; --theme-gradient-hover-end: #fed7aa; --theme-accent: #0B162A; --theme-accent-hover: #091220; }
.theme-chicago-bears-dark { --theme-bg-primary: #0B162A; --theme-bg-secondary: #091220; --theme-bg-card: #060e16; --theme-text-primary: #ffffff; --theme-text-secondary: #C83803; --theme-text-muted: #d1d5db; --theme-border: #0d1a30; --theme-gradient-start: #060e16; --theme-gradient-end: #091220; --theme-gradient-hover-start: #091220; --theme-gradient-hover-end: #0B162A; --theme-accent: #C83803; --theme-accent-hover: #a52e02; }
.theme-cincinnati-bengals-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fff7ed; --theme-text-primary: #FB4F14; --theme-text-secondary: #000000; --theme-text-muted: #6b7280; --theme-border: #fed7aa; --theme-gradient-start: #fff7ed; --theme-gradient-end: #f9fafb; --theme-gradient-hover-start: #ffedd5; --theme-gradient-hover-end: #f3f4f6; --theme-accent: #FB4F14; --theme-accent-hover: #ea4a13; }
.theme-cincinnati-bengals-dark { --theme-bg-primary: #FB4F14; --theme-bg-secondary: #ea4a13; --theme-bg-card: #d94512; --theme-text-primary: #ffffff; --theme-text-secondary: #000000; --theme-text-muted: #1f2937; --theme-border: #fd5d28; --theme-gradient-start: #d94512; --theme-gradient-end: #ea4a13; --theme-gradient-hover-start: #ea4a13; --theme-gradient-hover-end: #FB4F14; --theme-accent: #000000; --theme-accent-hover: #374151; }
.theme-cleveland-browns-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fefce8; --theme-text-primary: #311D00; --theme-text-secondary: #FF3C00; --theme-text-muted: #6b7280; --theme-border: #fde047; --theme-gradient-start: #fefce8; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #fef9c3; --theme-gradient-hover-end: #fed7aa; --theme-accent: #311D00; --theme-accent-hover: #28190a; }
.theme-cleveland-browns-dark { --theme-bg-primary: #311D00; --theme-bg-secondary: #28190a; --theme-bg-card: #1f1407; --theme-text-primary: #ffffff; --theme-text-secondary: #FF3C00; --theme-text-muted: #d1d5db; --theme-border: #3a2200; --theme-gradient-start: #1f1407; --theme-gradient-end: #28190a; --theme-gradient-hover-start: #28190a; --theme-gradient-hover-end: #311D00; --theme-accent: #FF3C00; --theme-accent-hover: #e6360a; }
.theme-dallas-cowboys-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #003594; --theme-text-secondary: #869397; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #f8fafc; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #f1f5f9; --theme-accent: #003594; --theme-accent-hover: #002b7a; }
.theme-dallas-cowboys-dark { --theme-bg-primary: #003594; --theme-bg-secondary: #002b7a; --theme-bg-card: #002160; --theme-text-primary: #ffffff; --theme-text-secondary: #869397; --theme-text-muted: #d1d5db; --theme-border: #003fa8; --theme-gradient-start: #002160; --theme-gradient-end: #002b7a; --theme-gradient-hover-start: #002b7a; --theme-gradient-hover-end: #003594; --theme-accent: #869397; --theme-accent-hover: #6b7679; }
.theme-denver-broncos-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fff7ed; --theme-text-primary: #FB4F14; --theme-text-secondary: #002244; --theme-text-muted: #6b7280; --theme-border: #fed7aa; --theme-gradient-start: #fff7ed; --theme-gradient-end: #f8fafc; --theme-gradient-hover-start: #ffedd5; --theme-gradient-hover-end: #f1f5f9; --theme-accent: #FB4F14; --theme-accent-hover: #ea4a13; }
.theme-denver-broncos-dark { --theme-bg-primary: #FB4F14; --theme-bg-secondary: #ea4a13; --theme-bg-card: #d94512; --theme-text-primary: #ffffff; --theme-text-secondary: #002244; --theme-text-muted: #1f2937; --theme-border: #fd5d28; --theme-gradient-start: #d94512; --theme-gradient-end: #ea4a13; --theme-gradient-hover-start: #ea4a13; --theme-gradient-hover-end: #FB4F14; --theme-accent: #002244; --theme-accent-hover: #1f2937; }
.theme-detroit-lions-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #0076B6; --theme-text-secondary: #B0B7BC; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #f8fafc; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #f1f5f9; --theme-accent: #0076B6; --theme-accent-hover: #006297; }
.theme-detroit-lions-dark { --theme-bg-primary: #0076B6; --theme-bg-secondary: #006297; --theme-bg-card: #004f78; --theme-text-primary: #ffffff; --theme-text-secondary: #B0B7BC; --theme-text-muted: #d1d5db; --theme-border: #0085c8; --theme-gradient-start: #004f78; --theme-gradient-end: #006297; --theme-gradient-hover-start: #006297; --theme-gradient-hover-end: #0076B6; --theme-accent: #B0B7BC; --theme-accent-hover: #969ea4; }
.theme-green-bay-packers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f0fdf4; --theme-text-primary: #203731; --theme-text-secondary: #FFB612; --theme-text-muted: #6b7280; --theme-border: #bbf7d0; --theme-gradient-start: #f0fdf4; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #dcfce7; --theme-gradient-hover-end: #fef3c7; --theme-accent: #203731; --theme-accent-hover: #1a2d28; }
.theme-green-bay-packers-dark { --theme-bg-primary: #203731; --theme-bg-secondary: #1a2d28; --theme-bg-card: #14241f; --theme-text-primary: #ffffff; --theme-text-secondary: #FFB612; --theme-text-muted: #d1d5db; --theme-border: #264139; --theme-gradient-start: #14241f; --theme-gradient-end: #1a2d28; --theme-gradient-hover-start: #1a2d28; --theme-gradient-hover-end: #203731; --theme-accent: #FFB612; --theme-accent-hover: #eaa70f; }
.theme-houston-texans-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f8fafc; --theme-text-primary: #03202F; --theme-text-secondary: #A71930; --theme-text-muted: #6b7280; --theme-border: #e2e8f0; --theme-gradient-start: #f8fafc; --theme-gradient-end: #fef2f2; --theme-gradient-hover-start: #f1f5f9; --theme-gradient-hover-end: #fee2e2; --theme-accent: #03202F; --theme-accent-hover: #021a26; }
.theme-houston-texans-dark { --theme-bg-primary: #03202F; --theme-bg-secondary: #021a26; --theme-bg-card: #01141d; --theme-text-primary: #ffffff; --theme-text-secondary: #A71930; --theme-text-muted: #d1d5db; --theme-border: #042638; --theme-gradient-start: #01141d; --theme-gradient-end: #021a26; --theme-gradient-hover-start: #021a26; --theme-gradient-hover-end: #03202F; --theme-accent: #A71930; --theme-accent-hover: #881426; }
.theme-indianapolis-colts-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #002C5F; --theme-text-secondary: #ffffff; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #ffffff; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #f9fafb; --theme-accent: #002C5F; --theme-accent-hover: #00244e; }
.theme-indianapolis-colts-dark { --theme-bg-primary: #002C5F; --theme-bg-secondary: #00244e; --theme-bg-card: #001c3d; --theme-text-primary: #ffffff; --theme-text-secondary: #f9fafb; --theme-text-muted: #d1d5db; --theme-border: #003470; --theme-gradient-start: #001c3d; --theme-gradient-end: #00244e; --theme-gradient-hover-start: #00244e; --theme-gradient-hover-end: #002C5F; --theme-accent: #f9fafb; --theme-accent-hover: #e5e7eb; }
.theme-jacksonville-jaguars-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #ecfeff; --theme-text-primary: #006778; --theme-text-secondary: #D7A22A; --theme-text-muted: #6b7280; --theme-border: #a7f3d0; --theme-gradient-start: #ecfeff; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #cffafe; --theme-gradient-hover-end: #fef3c7; --theme-accent: #006778; --theme-accent-hover: #005462; }
.theme-jacksonville-jaguars-dark { --theme-bg-primary: #006778; --theme-bg-secondary: #005462; --theme-bg-card: #00424c; --theme-text-primary: #ffffff; --theme-text-secondary: #D7A22A; --theme-text-muted: #d1d5db; --theme-border: #007a8e; --theme-gradient-start: #00424c; --theme-gradient-end: #005462; --theme-gradient-hover-start: #005462; --theme-gradient-hover-end: #006778; --theme-accent: #D7A22A; --theme-accent-hover: #c29324; }
.theme-las-vegas-raiders-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f9fafb; --theme-text-primary: #000000; --theme-text-secondary: #A5ACAF; --theme-text-muted: #6b7280; --theme-border: #e5e7eb; --theme-gradient-start: #f9fafb; --theme-gradient-end: #f8fafc; --theme-gradient-hover-start: #f3f4f6; --theme-gradient-hover-end: #f1f5f9; --theme-accent: #000000; --theme-accent-hover: #1f2937; }
.theme-las-vegas-raiders-dark { --theme-bg-primary: #000000; --theme-bg-secondary: #1f2937; --theme-bg-card: #374151; --theme-text-primary: #ffffff; --theme-text-secondary: #A5ACAF; --theme-text-muted: #d1d5db; --theme-border: #374151; --theme-gradient-start: #374151; --theme-gradient-end: #1f2937; --theme-gradient-hover-start: #1f2937; --theme-gradient-hover-end: #000000; --theme-accent: #A5ACAF; --theme-accent-hover: #9ca3af; }
.theme-los-angeles-chargers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #0080C6; --theme-text-secondary: #FFC20E; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #fef3c7; --theme-accent: #0080C6; --theme-accent-hover: #006ba3; }
.theme-los-angeles-chargers-dark { --theme-bg-primary: #0080C6; --theme-bg-secondary: #006ba3; --theme-bg-card: #005680; --theme-text-primary: #ffffff; --theme-text-secondary: #FFC20E; --theme-text-muted: #fef3c7; --theme-border: #0095dc; --theme-gradient-start: #005680; --theme-gradient-end: #006ba3; --theme-gradient-hover-start: #006ba3; --theme-gradient-hover-end: #0080C6; --theme-accent: #FFC20E; --theme-accent-hover: #eab308; }
.theme-los-angeles-rams-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #003594; --theme-text-secondary: #FFA300; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #ffedd5; --theme-accent: #003594; --theme-accent-hover: #002b7a; }
.theme-los-angeles-rams-dark { --theme-bg-primary: #003594; --theme-bg-secondary: #002b7a; --theme-bg-card: #002160; --theme-text-primary: #ffffff; --theme-text-secondary: #FFA300; --theme-text-muted: #fed7aa; --theme-border: #003fa8; --theme-gradient-start: #002160; --theme-gradient-end: #002b7a; --theme-gradient-hover-start: #002b7a; --theme-gradient-hover-end: #003594; --theme-accent: #FFA300; --theme-accent-hover: #e6930a; }
.theme-miami-dolphins-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #ecfeff; --theme-text-primary: #008E97; --theme-text-secondary: #FC4C02; --theme-text-muted: #6b7280; --theme-border: #a7f3d0; --theme-gradient-start: #ecfeff; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #cffafe; --theme-gradient-hover-end: #fed7aa; --theme-accent: #008E97; --theme-accent-hover: #007379; }
.theme-miami-dolphins-dark { --theme-bg-primary: #008E97; --theme-bg-secondary: #007379; --theme-bg-card: #005e5b; --theme-text-primary: #ffffff; --theme-text-secondary: #FC4C02; --theme-text-muted: #fed7aa; --theme-border: #00a9b5; --theme-gradient-start: #005e5b; --theme-gradient-end: #007379; --theme-gradient-hover-start: #007379; --theme-gradient-hover-end: #008E97; --theme-accent: #FC4C02; --theme-accent-hover: #ea4a13; }
.theme-minnesota-vikings-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #faf5ff; --theme-text-primary: #4F2683; --theme-text-secondary: #FFC62F; --theme-text-muted: #6b7280; --theme-border: #e9d5ff; --theme-gradient-start: #faf5ff; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #f3e8ff; --theme-gradient-hover-end: #fef3c7; --theme-accent: #4F2683; --theme-accent-hover: #3f1e68; }
.theme-minnesota-vikings-dark { --theme-bg-primary: #4F2683; --theme-bg-secondary: #3f1e68; --theme-bg-card: #30164d; --theme-text-primary: #ffffff; --theme-text-secondary: #FFC62F; --theme-text-muted: #fef3c7; --theme-border: #5e2e9e; --theme-gradient-start: #30164d; --theme-gradient-end: #3f1e68; --theme-gradient-hover-start: #3f1e68; --theme-gradient-hover-end: #4F2683; --theme-accent: #FFC62F; --theme-accent-hover: #eab308; }
.theme-new-england-patriots-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f8fafc; --theme-text-primary: #002244; --theme-text-secondary: #C60C30; --theme-text-muted: #6b7280; --theme-border: #e2e8f0; --theme-gradient-start: #f8fafc; --theme-gradient-end: #fef2f2; --theme-gradient-hover-start: #f1f5f9; --theme-gradient-hover-end: #fee2e2; --theme-accent: #002244; --theme-accent-hover: #001d38; }
.theme-new-england-patriots-dark { --theme-bg-primary: #002244; --theme-bg-secondary: #001d38; --theme-bg-card: #00172c; --theme-text-primary: #ffffff; --theme-text-secondary: #C60C30; --theme-text-muted: #d1d5db; --theme-border: #002750; --theme-gradient-start: #00172c; --theme-gradient-end: #001d38; --theme-gradient-hover-start: #001d38; --theme-gradient-hover-end: #002244; --theme-accent: #C60C30; --theme-accent-hover: #a50a27; }
.theme-new-orleans-saints-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f9fafb; --theme-text-primary: #000000; --theme-text-secondary: #D3BC8D; --theme-text-muted: #6b7280; --theme-border: #e5e7eb; --theme-gradient-start: #f9fafb; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #f3f4f6; --theme-gradient-hover-end: #fef3c7; --theme-accent: #000000; --theme-accent-hover: #1f2937; }
.theme-new-orleans-saints-dark { --theme-bg-primary: #000000; --theme-bg-secondary: #1f2937; --theme-bg-card: #374151; --theme-text-primary: #ffffff; --theme-text-secondary: #D3BC8D; --theme-text-muted: #fef3c7; --theme-border: #374151; --theme-gradient-start: #374151; --theme-gradient-end: #1f2937; --theme-gradient-hover-start: #1f2937; --theme-gradient-hover-end: #000000; --theme-accent: #D3BC8D; --theme-accent-hover: #c2a876; }
.theme-new-york-giants-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #eff6ff; --theme-text-primary: #0B2265; --theme-text-secondary: #A71930; --theme-text-muted: #6b7280; --theme-border: #bfdbfe; --theme-gradient-start: #eff6ff; --theme-gradient-end: #fef2f2; --theme-gradient-hover-start: #dbeafe; --theme-gradient-hover-end: #fee2e2; --theme-accent: #0B2265; --theme-accent-hover: #091c52; }
.theme-new-york-giants-dark { --theme-bg-primary: #0B2265; --theme-bg-secondary: #091c52; --theme-bg-card: #07163f; --theme-text-primary: #ffffff; --theme-text-secondary: #A71930; --theme-text-muted: #d1d5db; --theme-border: #0d2878; --theme-gradient-start: #07163f; --theme-gradient-end: #091c52; --theme-gradient-hover-start: #091c52; --theme-gradient-hover-end: #0B2265; --theme-accent: #A71930; --theme-accent-hover: #881426; }
.theme-new-york-jets-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f0fdf4; --theme-text-primary: #125740; --theme-text-secondary: #000000; --theme-text-muted: #6b7280; --theme-border: #bbf7d0; --theme-gradient-start: #f0fdf4; --theme-gradient-end: #f9fafb; --theme-gradient-hover-start: #dcfce7; --theme-gradient-hover-end: #f3f4f6; --theme-accent: #125740; --theme-accent-hover: #0f4735; }
.theme-new-york-jets-dark { --theme-bg-primary: #125740; --theme-bg-secondary: #0f4735; --theme-bg-card: #0c372a; --theme-text-primary: #ffffff; --theme-text-secondary: #f9fafb; --theme-text-muted: #d1d5db; --theme-border: #15674b; --theme-gradient-start: #0c372a; --theme-gradient-end: #0f4735; --theme-gradient-hover-start: #0f4735; --theme-gradient-hover-end: #125740; --theme-accent: #f9fafb; --theme-accent-hover: #e5e7eb; }
.theme-philadelphia-eagles-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #ecfeff; --theme-text-primary: #004C54; --theme-text-secondary: #A5ACAF; --theme-text-muted: #6b7280; --theme-border: #a7f3d0; --theme-gradient-start: #ecfeff; --theme-gradient-end: #f8fafc; --theme-gradient-hover-start: #cffafe; --theme-gradient-hover-end: #f1f5f9; --theme-accent: #004C54; --theme-accent-hover: #003d44; }
.theme-philadelphia-eagles-dark { --theme-bg-primary: #004C54; --theme-bg-secondary: #003d44; --theme-bg-card: #002e35; --theme-text-primary: #ffffff; --theme-text-secondary: #A5ACAF; --theme-text-muted: #d1d5db; --theme-border: #005b64; --theme-gradient-start: #002e35; --theme-gradient-end: #003d44; --theme-gradient-hover-start: #003d44; --theme-gradient-hover-end: #004C54; --theme-accent: #A5ACAF; --theme-accent-hover: #9ca3af; }
.theme-pittsburgh-steelers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f9fafb; --theme-text-primary: #000000; --theme-text-secondary: #FFB612; --theme-text-muted: #6b7280; --theme-border: #e5e7eb; --theme-gradient-start: #f9fafb; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #f3f4f6; --theme-gradient-hover-end: #fef3c7; --theme-accent: #000000; --theme-accent-hover: #1f2937; }
.theme-pittsburgh-steelers-dark { --theme-bg-primary: #000000; --theme-bg-secondary: #1f2937; --theme-bg-card: #374151; --theme-text-primary: #ffffff; --theme-text-secondary: #FFB612; --theme-text-muted: #fef3c7; --theme-border: #374151; --theme-gradient-start: #374151; --theme-gradient-end: #1f2937; --theme-gradient-hover-start: #1f2937; --theme-gradient-hover-end: #000000; --theme-accent: #FFB612; --theme-accent-hover: #eaa70f; }
.theme-san-francisco-49ers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fef2f2; --theme-text-primary: #AA0000; --theme-text-secondary: #B3995D; --theme-text-muted: #6b7280; --theme-border: #fecaca; --theme-gradient-start: #fef2f2; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #fee2e2; --theme-gradient-hover-end: #fef3c7; --theme-accent: #AA0000; --theme-accent-hover: #8a0000; }
.theme-san-francisco-49ers-dark { --theme-bg-primary: #AA0000; --theme-bg-secondary: #8a0000; --theme-bg-card: #6a0000; --theme-text-primary: #ffffff; --theme-text-secondary: #B3995D; --theme-text-muted: #fef3c7; --theme-border: #c40000; --theme-gradient-start: #6a0000; --theme-gradient-end: #8a0000; --theme-gradient-hover-start: #8a0000; --theme-gradient-hover-end: #AA0000; --theme-accent: #B3995D; --theme-accent-hover: #a28850; }
.theme-seattle-seahawks-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f8fafc; --theme-text-primary: #002244; --theme-text-secondary: #69BE28; --theme-text-muted: #6b7280; --theme-border: #e2e8f0; --theme-gradient-start: #f8fafc; --theme-gradient-end: #f0fdf4; --theme-gradient-hover-start: #f1f5f9; --theme-gradient-hover-end: #dcfce7; --theme-accent: #002244; --theme-accent-hover: #001d38; }
.theme-seattle-seahawks-dark { --theme-bg-primary: #002244; --theme-bg-secondary: #001d38; --theme-bg-card: #00172c; --theme-text-primary: #ffffff; --theme-text-secondary: #69BE28; --theme-text-muted: #dcfce7; --theme-border: #002750; --theme-gradient-start: #00172c; --theme-gradient-end: #001d38; --theme-gradient-hover-start: #001d38; --theme-gradient-hover-end: #002244; --theme-accent: #69BE28; --theme-accent-hover: #5ba022; }
.theme-tampa-bay-buccaneers-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fef2f2; --theme-text-primary: #D50A0A; --theme-text-secondary: #34302B; --theme-text-muted: #6b7280; --theme-border: #fecaca; --theme-gradient-start: #fef2f2; --theme-gradient-end: #fff7ed; --theme-gradient-hover-start: #fee2e2; --theme-gradient-hover-end: #fed7aa; --theme-accent: #D50A0A; --theme-accent-hover: #b00a0a; }
.theme-tampa-bay-buccaneers-dark { --theme-bg-primary: #D50A0A; --theme-bg-secondary: #b00a0a; --theme-bg-card: #8b0808; --theme-text-primary: #ffffff; --theme-text-secondary: #34302B; --theme-text-muted: #1f2937; --theme-border: #f00b0b; --theme-gradient-start: #8b0808; --theme-gradient-end: #b00a0a; --theme-gradient-hover-start: #b00a0a; --theme-gradient-hover-end: #D50A0A; --theme-accent: #34302B; --theme-accent-hover: #6b7280; }
.theme-tennessee-titans-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #f8fafc; --theme-text-primary: #0C2340; --theme-text-secondary: #4B92DB; --theme-text-muted: #6b7280; --theme-border: #e2e8f0; --theme-gradient-start: #f8fafc; --theme-gradient-end: #eff6ff; --theme-gradient-hover-start: #f1f5f9; --theme-gradient-hover-end: #dbeafe; --theme-accent: #0C2340; --theme-accent-hover: #091d35; }
.theme-tennessee-titans-dark { --theme-bg-primary: #0C2340; --theme-bg-secondary: #091d35; --theme-bg-card: #07172a; --theme-text-primary: #ffffff; --theme-text-secondary: #4B92DB; --theme-text-muted: #dbeafe; --theme-border: #0e294b; --theme-gradient-start: #07172a; --theme-gradient-end: #091d35; --theme-gradient-hover-start: #091d35; --theme-gradient-hover-end: #0C2340; --theme-accent: #4B92DB; --theme-accent-hover: #3b7bc9; }
.theme-washington-commanders-light { --theme-bg-primary: #ffffff; --theme-bg-secondary: #f8fafc; --theme-bg-card: #fefce8; --theme-text-primary: #5A1414; --theme-text-secondary: #FFB612; --theme-text-muted: #6b7280; --theme-border: #fde047; --theme-gradient-start: #fefce8; --theme-gradient-end: #fffbeb; --theme-gradient-hover-start: #fef9c3; --theme-gradient-hover-end: #fef3c7; --theme-accent: #5A1414; --theme-accent-hover: #4a1111; }
.theme-washington-commanders-dark { --theme-bg-primary: #5A1414; --theme-bg-secondary: #4a1111; --theme-bg-card: #3a0e0e; --theme-text-primary: #ffffff; --theme-text-secondary: #FFB612; --theme-text-muted: #fef3c7; --theme-border: #6a1717; --theme-gradient-start: #3a0e0e; --theme-gradient-end: #4a1111; --theme-gradient-hover-start: #4a1111; --theme-gradient-hover-end: #5A1414; --theme-accent: #FFB612; --theme-accent-hover: #eaa70f; }

 </style>
</head>
<body style="background-color: var(--theme-bg-primary); color: var(--theme-text-primary);" class="transition-colors duration-300">

 <!-- Loading View -->
 <div id="loading-view" class="min-h-screen flex items-center justify-center p-4">
  <div class="text-center">
   <div class="loader mb-4"></div>
   <p class="text-slate-600">Loading NerdfootballAI...</p>
  </div>
 </div>

 <!-- Login & Register View -->
 <div id="login-view" class="min-h-screen flex items-center justify-center p-4 hidden">
 <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-sm w-full mx-auto border border-slate-300">
 
 <!-- Login Form -->
 <form id="login-form">
 <h1 class="text-3xl font-bold text-center mb-1 text-slate-800">NerdfootballAI</h1>
 <p class="text-center text-slate-500 text-sm mb-2 italic">The Coolest online football pool in the Universe</p>
 <p class="text-center text-slate-600 mb-4">Welcome back, Nerds</p>
 <div class="text-center mb-6">
  <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdFootball Nerd" class="w-64 h-64 mx-auto">
 </div>
 <div id="login-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="login-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="login-password" type="password" placeholder="Password" required class="form-input">
 </div>
 <button id="login-btn" type="submit" class="form-btn mt-6">Sign In</button>
 
 <div class="relative mt-6">
 <div class="absolute inset-0 flex items-center">
 <div class="w-full border-t border-gray-300"></div>
 </div>
 <div class="relative flex justify-center text-sm">
 <span class="px-2 bg-slate-100 text-gray-500">Or continue with</span>
 </div>
 </div>

 <button id="google-signin-btn" type="button" class="w-full mt-4 px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors flex items-center justify-center gap-3">
 <svg class="w-5 h-5" viewBox="0 0 24 24">
 <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
 <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
 <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
 <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
 </svg>
 Continue with Google
 </button>

 <p class="text-center mt-4 text-sm">
 Don't have an account? <a href="#" id="show-register-link" class="font-medium text-slate-600 hover:text-slate-800">Register</a>
 </p>
 </form>

 <!-- Registration Form -->
 <form id="register-form" class="hidden">
 <h1 class="text-3xl font-bold text-center mb-1">Create Account</h1>
 <p class="text-center text-slate-500 text-sm mb-2 italic">The Coolest online football pool in the Universe</p>
 <p class="text-center text-slate-600 mb-4">Get started with NerdfootballAI.</p>
 <div class="text-center mb-6">
  <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdFootball Nerd" class="w-64 h-64 mx-auto">
 </div>
 <div id="register-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="register-firstname" type="text" placeholder="First Name" required class="form-input">
 <input id="register-lastname" type="text" placeholder="Last Name" required class="form-input">
 <input id="register-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="register-password" type="password" placeholder="Password" required class="form-input">
 <input id="register-confirm-password" type="password" placeholder="Confirm Password" required class="form-input">
 </div>
 <button id="register-btn" type="submit" class="form-btn mt-6">Create Account</button>
 
 <div class="relative mt-6">
 <div class="absolute inset-0 flex items-center">
 <div class="w-full border-t border-gray-300"></div>
 </div>
 <div class="relative flex justify-center text-sm">
 <span class="px-2 bg-slate-100 text-gray-500">Or continue with</span>
 </div>
 </div>

 <button id="google-signup-btn" type="button" class="w-full mt-4 px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors flex items-center justify-center gap-3">
 <svg class="w-5 h-5" viewBox="0 0 24 24">
 <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
 <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
 <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
 <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
 </svg>
 Continue with Google
 </button>

 <p class="text-center mt-4 text-sm">
 Already have an account? <a href="#" id="show-login-link" class="font-medium text-slate-600 hover:text-slate-800">Sign In</a>
 </p>
 </form>
 </div>
 </div>

<!-- Account Linking Confirmation Dialog -->
<div id="account-linking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
 <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
 <div class="mt-3 text-center">
 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
 <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
 </svg>
 </div>
 <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Link Your Accounts</h3>
 <div class="mt-2 px-7 py-3">
 <p class="text-sm text-gray-500">
 We found an existing account with this email address (<span id="linking-email" class="font-medium"></span>).
 Would you like to link your Google account to your existing account?
 </p>
 <p class="text-xs text-gray-400 mt-2">
 After linking, you can use either method to sign in, but Google will be your preferred method.
 </p>
 </div>
 <div class="flex gap-3 px-4 py-3">
 <button id="cancel-linking-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
 Cancel
 </button>
 <button id="confirm-linking-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
 Link Accounts
 </button>
 </div>
 </div>
 </div>
</div>

<!-- Password Prompt for Account Linking -->
<div id="password-linking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
 <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
 <div class="mt-3">
 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
 <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
 </svg>
 </div>
 <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4 text-center">Confirm Your Password</h3>
 <div class="mt-2 px-7 py-3">
 <p class="text-sm text-gray-500 text-center mb-4">
 Please enter your password for <span id="password-prompt-email" class="font-medium"></span> to link your Google account.
 </p>
 <div id="password-prompt-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <input id="password-prompt-input" type="password" placeholder="Password" required class="form-input mb-4">
 </div>
 <div class="flex gap-3 px-4 py-3">
 <button id="cancel-password-prompt-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
 Cancel
 </button>
 <button id="confirm-password-prompt-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
 Confirm & Link
 </button>
 </div>
 </div>
 </div>
</div>

 <!-- Main App Container -->
 <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
 <header class="mb-6">
 <div class="flex justify-between items-center flex-wrap gap-4">
 <!-- Logo and title - left aligned -->
 <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity cursor-pointer">
 <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdfootballAI Logo" class="h-8 md:h-10 w-auto">
 <h1 class="text-3xl md:text-4xl font-bold text-slate-800">NerdfootballAI</h1>
 </a>
 <!-- Right side elements -->
 <div class="flex items-center space-x-4">
 <!-- Status Indicators -->
 <div class="flex items-center space-x-2">
    <!-- Game Update Indicator -->
    <div id="game-update-indicator" class="hidden opacity-0 transition-opacity duration-500" title="Game Updated">
        <span class="text-lg"></span>
    </div>
    <!-- Cache Status Indicator -->
    <div id="cache-status-indicator" class="relative group" title="Cache Status">
        <div id="cache-status-glyph" class="w-3 h-3 rounded-full bg-green-500 animate-pulse cursor-pointer"></div>
        <div class="absolute right-0 mt-2 w-48 bg-slate-800 text-white text-xs rounded-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            <div id="cache-status-tooltip">Cache is current</div>
        </div>
    </div>
    
    <!-- Theme Variant Toggle -->
    <button id="theme-variant-toggle" class="ml-2 p-1 rounded bg-opacity-20 hover:bg-opacity-30 transition-all duration-200 text-sm" title="Toggle Light/Dark Variant">
        
    </button>
 </div>
 <span class="text-sm font-medium text-slate-600">v3.0</span>
 <div class="flex items-center space-x-2 relative">
    <span id="user-display" class="text-sm font-medium text-slate-700"></span>
    
    <!-- Pool Switcher -->
    <div class="relative" id="pool-switcher-container">
        <button id="pool-switcher-btn" class="flex items-center space-x-1 px-3 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 transition-colors" aria-label="Switch Pool">
            <span id="current-pool-name">Loading...</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </button>
        
        <div id="pool-switcher-dropdown" class="hidden absolute top-full right-0 mt-1 w-64 bg-white rounded-md shadow-lg z-30 ring-1 ring-black ring-opacity-5">
            <div class="py-2">
                <div class="px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                    My Pools
                </div>
                <div id="user-pools-list" class="max-h-64 overflow-y-auto">
                    <!-- Pool list will be populated dynamically -->
                </div>
                <div class="border-t border-slate-200 mt-2 pt-2">
                    <button id="create-pool-btn" class="w-full text-left px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Create New Pool</span>
                    </button>
                    <button id="join-pool-btn" class="w-full text-left px-3 py-2 text-sm text-green-600 hover:bg-green-50 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-5-6l6 6-6 6"></path>
                        </svg>
                        <span>Join Pool</span>
                    </button>
                    <button id="discover-pools-btn" class="w-full text-left px-3 py-2 text-sm text-purple-600 hover:bg-purple-50 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span>Discover Pools</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <button id="menu-btn" class="p-2 rounded-md hover:bg-slate-200">
        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    <div id="menu-panel" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5">
        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
            <!-- Admin Only Section (Top for Admins) -->
            <div id="menu-admin-controls" class="hidden">
                 <button id="menu-admin-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem"> Admin</button>
                 <button id="survivor-admin-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> Survivor Admin</button>
                 <a href="./websocket-test.html" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> WebSocket Test</a>
                 <button id="user-diagnostic-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> User Diagnostics</button>
                 <div class="border-t border-gray-200 my-1"></div>
            </div>
            
            <!-- Main Menu Items -->
            <button id="menu-picks-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn active" role="menuitem"> My Picks</button>
            <button id="leaderboard-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem"> Leaderboard</button>
            <button id="grid-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem"> The Grid</button>
            <a href="./index.html?view=survivor-picks" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> Survivor Picks</a>
            <a href="./index.html?view=survivor" class="block px-4 py-2 text-sm text-orange-700 hover:bg-orange-50" role="menuitem"> Survivors List</a>
            <a href="./nerdfootballRules.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> Rules</a>
            <a href="./websocket-test.html" class="block px-4 py-2 text-sm text-blue-700 hover:bg-blue-50" role="menuitem"> WebSocket Test</a>
            
            <!-- Account Section -->
            <div class="border-t border-gray-200 my-1"></div>
            <button id="settings-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> Settings</button>
            <button id="logout-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"> Logout</button>
        </div>
    </div>
 </div>
 </div>
 </div>
 </header>

 <!-- Active Picks Summary Section -->
 <div id="picks-summary-container" class="hidden mb-4">
  <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200" data-realtime="picks">
   <!-- Flex container for side-by-side layout -->
   <div class="flex flex-col lg:flex-row gap-6 items-start">
    <!-- Current Active Picks -->
    <div id="active-picks-section" class="flex-1">
     <h3 class="text-lg font-semibold text-slate-700 mb-3">Your Active Picks</h3>
     <div id="active-picks-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
      <!-- Active picks will be rendered here -->
     </div>
    </div>
    
    <!-- Yearly Leaderboard -->
    <div id="yearly-leaderboard-section" class="flex-1">
     <h3 class="text-lg font-semibold text-slate-700 mb-3">Season Leaderboard</h3>
     
     <div id="yearly-leaderboard-container" class="bg-slate-50 rounded-lg p-3">
      <div id="yearly-leaderboard-loader" class="hidden text-center py-2">
       <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-slate-600"></div>
       <span class="ml-2 text-sm text-slate-600">Loading leaderboard...</span>
      </div>
      <div id="yearly-leaderboard-content" class="space-y-1" data-realtime="leaderboard">
       <!-- Leaderboard will be rendered here -->
      </div>
     </div>
     
     <!-- Expanded Game View (Hidden by default) - Moved below leaderboard -->
     <div id="expanded-game-view" class="hidden opacity-0 transition-all duration-300 mt-4">
      <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg shadow-lg border border-slate-200 p-4">
       <div id="expanded-game-content">
        <!-- Game details will be rendered here -->
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
 
 <!-- Picks View -->
 <div id="picks-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <h2 id="picks-container-title" class="text-2xl font-bold text-slate-800 mb-4">My picks for Week 1</h2>
 <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
 <div class="flex items-center space-x-2">
 <button id="prev-week-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-medium py-1 px-2 rounded text-sm transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
 <span id="week-display" class="text-lg font-medium text-slate-700 px-2">Week 1</span>
 <button id="next-week-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-medium py-1 px-2 rounded text-sm transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
 <button id="top-save-picks-btn" class="bg-blue-600 text-white font-medium py-1 px-3 rounded text-sm hover:bg-blue-700 flex items-center gap-2">
   <span id="save-picks-text">Save</span>
   <div id="save-picks-spinner" class="hidden w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
 </button>
 <button id="reset-picks-btn" class="bg-emerald-500 text-white font-medium py-1 px-3 rounded text-sm hover:bg-emerald-800">Reset</button>
 <div id="save-status" class="flex items-center space-x-1 h-8">
 <div id="save-status-icon" class="w-4 h-4"></div>
 <span id="save-status-text" class="text-xs font-medium"></span>
 </div>
 </div>
 </div>
 <div id="timestamps-display" class="text-xs text-gray-500 mb-4 text-center">
   <span id="last-access-time"></span>
   <span id="last-update-time" class="ml-4"></span>
 </div>
 <main id="picks-form">
 <div id="lock-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md mb-6" role="alert">
 <p class="font-bold">Picks Locked</p>
 <p>The games for this week have started. Your picks can no longer be changed.</p>
 </div>
 <div id="game-list" class="space-y-6"></div>
 </main>
 </div>
 </div>

 <!-- Leaderboard View -->
  <div id="leaderboard-container" class="hidden">
    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-center">Confidence Pool Leaderboard</h2>
        <div class="flex justify-center items-center mb-4 space-x-2">
            <button id="lb-weekly-btn" class="view-toggle-btn active py-2 px-4 rounded-lg font-semibold border border-gray-300">Weekly</button>
            <button id="lb-season-btn" class="view-toggle-btn py-2 px-4 rounded-lg font-semibold border border-gray-300">Season</button>
        </div>
        <div id="lb-week-selector-container" class="mb-4 text-center">
            <label for="lb-week-selector" class="text-lg font-medium text-gray-700 mr-2">Week:</label>
            <select id="lb-week-selector" class="p-2 rounded-lg border-2 border-gray-300 bg-white"></select>
        </div>
        <div id="public-leaderboard-loader" class="loader hidden"></div>
        <table class="min-w-full divide-y divide-gray-200 public-leaderboard-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MNF Points</th>
                </tr>
            </thead>
            <tbody id="public-leaderboard-body" class="bg-white divide-y divide-gray-200" data-realtime="leaderboard"></tbody>
        </table>
    </div>
</div>


 <!-- Admin View -->
 <div id="admin-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <div class="flex justify-between items-center mb-6">
 <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
 <select id="admin-week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
 </div>
 <div class="mb-6">
 <nav class="flex space-x-4" aria-label="Tabs">
 <button id="tab-game-results" class="admin-tab active">Games</button>
 <button id="tab-user-mgmt" class="admin-tab">Users</button>
 <button id="tab-picks-mgmt" class="admin-tab">Picks</button>
 <button id="tab-survivor-status" class="admin-tab">Survivors</button>
 <button id="tab-system-messenger" class="admin-tab">Messaging</button>
 <button id="tab-analytics" class="admin-tab">Analytics</button>
<button id="tab-pool-settings" class="admin-tab">Pool Settings</button>
<button id="tab-espn-api" class="admin-tab">ESPN API</button>
<button id="tab-cache-mgmt" class="admin-tab"> Cache</button>
 </nav>
 </div>
 <div id="admin-content-game-results" class="admin-content-section">
 <h3 id="admin-week-title" class="text-xl font-bold mb-2"></h3>
 <!-- Compact admin buttons moved to top -->
 <div class="flex flex-wrap gap-2 mb-4">
    <button id="save-results-btn" class="bg-green-700 text-white text-sm font-medium py-1 px-3 rounded hover:bg-green-800">Save Results</button>
    <button id="reset-winners-btn" class="bg-amber-500 text-white text-sm font-medium py-1 px-3 rounded hover:bg-amber-600">Reset Winners</button>
    <button id="refresh-summary-btn" class="bg-blue-600 text-white text-sm font-medium py-1 px-3 rounded hover:bg-blue-700"> Refresh Cache</button>
 </div>
 <div id="results-game-list" class="space-y-2"></div>
 </div>
 <div id="admin-content-user-mgmt" class="admin-content-section hidden">
 <div class="flex justify-between items-center mb-4">
 <h3 class="text-xl font-bold">User Management</h3>
 <div class="flex gap-2">
 <a href="./user-sync-diagnostic.html" class="bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700"> User Diagnostic Tool</a>
 <button id="cleanup-duplicates-btn" class="bg-orange-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-orange-700">Clean Up Duplicates</button>
 </div>
 </div>
 <table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-100">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="displayName">
Name 
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="email">
Email
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="role">
Status
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="user-mgmt-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
 </div>
 <div id="admin-content-picks-mgmt" class="admin-content-section hidden">
 <h3 class="text-xl font-bold mb-4">Edit User Picks - Week <span id="admin-picks-week-number"></span></h3>
 
 <!-- Pick Validation Alerts -->
 <div id="pick-validation-alerts" class="mb-6">
     <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
         <h4 class="text-lg font-semibold text-yellow-800 mb-3">Pick Validation Status</h4>
         <div class="flex gap-3 mb-4">
             <button id="validate-all-picks-btn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Validate All Picks</button>
             <button id="clear-validation-alerts-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Clear Alerts</button>
         </div>
         <div id="validation-results" class="space-y-2"></div>
     </div>
 </div>
 
 <!-- Player Icons Grid -->
 <div class="mb-6">
     <div class="text-sm text-slate-600 mb-3">Click on a player to edit their picks:</div>
     <div id="player-icons-grid" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-2"></div>
 </div>
 
 <!-- Selected User Picks Editor -->
 <div id="user-picks-editor" class="hidden">
     <div class="bg-slate-50 p-4 rounded-lg mb-4">
         <h4 class="text-lg font-semibold mb-2">Editing picks for: <span id="selected-user-name"></span></h4>
         <div class="text-sm text-slate-600 mb-2">Permission: <span id="edit-permission-status"></span></div>
     </div>
     
     <div id="user-picks-game-list" class="space-y-4"></div>
     <div class="flex gap-3 mt-6">
         <button id="save-user-picks-btn" class="flex-1 bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 disabled:bg-slate-400 disabled:cursor-not-allowed">Save Picks</button>
         <button id="cancel-user-picks-btn" class="px-6 py-3 border border-slate-300 rounded-lg hover:bg-slate-50">Cancel</button>
     </div>
 </div>
 </div>
 <div id="admin-content-survivor-status" class="admin-content-section hidden">
    <h3 class="text-xl font-bold mb-4">Survivor Pool Status & Management</h3>
    
    <!-- Survivor Auto-Elimination Controls -->
    <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h4 class="text-lg font-semibold text-yellow-800 mb-3"> Auto-Elimination System</h4>
        <p class="text-sm text-yellow-700 mb-3">Automatically eliminate users who pick losing teams based on completed game results.</p>
        <div class="flex gap-3">
            <button id="check-current-week-eliminations-btn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Check Current Week</button>
            <button id="check-all-weeks-eliminations-btn" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">Check All Weeks (Historical)</button>
            <button id="check-specific-user-btn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Check Specific User</button>
        </div>
        <div id="elimination-results" class="mt-3 text-sm"></div>
    </div>
    
    <!-- Survivor Pick Editor -->
    <div id="survivor-pick-editor" class="mb-6 hidden">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-lg font-semibold text-blue-800 mb-3">Edit Survivor Pick - Week <span id="survivor-editor-week"></span></h4>
            <div class="mb-3">
                <span class="text-sm text-blue-700">Editing for: </span>
                <span id="survivor-editor-user-name" class="font-medium"></span>
            </div>
            
            <div id="survivor-team-selector" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 mb-4">
                <!-- Team buttons will be populated dynamically -->
            </div>
            
            <div class="flex gap-3">
                <button id="save-survivor-pick-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Survivor Pick</button>
                <button id="cancel-survivor-pick-btn" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancel</button>
                <button id="clear-survivor-pick-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Clear Pick</button>
            </div>
        </div>
    </div>
    
    <table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-100">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="displayName">
User 
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="thisWeekPick">
Pick Status
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="status">
Status
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="role">
Role
<span class="sort-indicator ml-1"></span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="survivor-status-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
</div>
<div id="admin-content-system-messenger" class="admin-content-section hidden">
   <h3 class="text-xl font-bold mb-4">System Messenger</h3>
   
   <div class="space-y-6">
       <!-- Recipient Selection -->
       <div>
           <label for="message-recipients" class="block text-sm font-medium text-gray-700 mb-2">Recipients</label>
           <select id="message-recipients" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md">
               <option value="all">All Users</option>
               <option value="no-picks">Users without picks this week</option>
               <option value="top-3">Top 3 winners this week</option>
               <option value="custom">Select specific users</option>
           </select>
       </div>

       <!-- Custom User Selection (hidden by default) -->
       <div id="custom-users-section" class="hidden">
           <label class="block text-sm font-medium text-gray-700 mb-2">Select Users</label>
           <div id="custom-users-list" class="max-h-60 overflow-y-auto border border-gray-300 rounded-md p-3 space-y-2">
               <!-- User checkboxes will be populated here -->
           </div>
       </div>

       <!-- Subject -->
       <div>
           <label for="message-subject" class="block text-sm font-medium text-gray-700 mb-2"> Notification Title</label>
           <input type="text" id="message-subject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" placeholder="Enter notification title">
       </div>

       <!-- Message Body -->
       <div>
           <label for="message-body" class="block text-sm font-medium text-gray-700 mb-2"> Notification Message</label>
           <textarea id="message-body" rows="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" placeholder="Enter push notification message..."></textarea>
       </div>

       <!-- Preview -->
       <div id="message-preview-section" class="hidden">
           <label class="block text-sm font-medium text-gray-700 mb-2"> Notification Preview</label>
           <div id="message-preview" class="bg-gray-50 border border-gray-300 rounded-md p-4 text-sm whitespace-pre-wrap"></div>
       </div>

       <!-- Recipient Count -->
       <div id="recipient-count" class="text-sm text-gray-600">
           Recipients: <span id="recipient-count-number">0</span> users
       </div>

       <!-- Action Buttons -->
       <div class="flex space-x-4">
           <button id="preview-message-btn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Preview Message</button>
           <button id="send-message-btn" class="bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled> Send Push Notification</button>
       </div>

       <!-- Status Messages -->
       <div id="message-status" class="hidden">
           <div id="message-status-content" class="p-4 rounded-md"></div>
       </div>
   </div>
</div>

<div id="admin-content-pool-settings" class="admin-content-section hidden">
   <div class="flex items-center justify-between mb-6">
       <h3 class="text-xl font-bold text-slate-800">Pool Management</h3>
       <div class="flex space-x-2">
           <button id="edit-pool-settings-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
               Edit Settings
           </button>
           <button id="generate-invite-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
               Create Invite
           </button>
       </div>
   </div>
   
   <div class="space-y-6">
       <!-- Pool Overview Cards -->
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div class="bg-white border border-slate-200 rounded-lg p-4">
               <div class="flex items-center">
                   <div class="p-2 bg-blue-100 rounded-lg">
                       <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                       </svg>
                   </div>
                   <div class="ml-3">
                       <p class="text-sm font-medium text-slate-600">Members</p>
                       <p id="member-count" class="text-2xl font-bold text-slate-900">--</p>
                   </div>
               </div>
           </div>
           
           <div class="bg-white border border-slate-200 rounded-lg p-4">
               <div class="flex items-center">
                   <div class="p-2 bg-green-100 rounded-lg">
                       <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                       </svg>
                   </div>
                   <div class="ml-3">
                       <p class="text-sm font-medium text-slate-600">Active Picks</p>
                       <p id="active-picks-count" class="text-2xl font-bold text-slate-900">--</p>
                   </div>
               </div>
           </div>
           
           <div class="bg-white border border-slate-200 rounded-lg p-4">
               <div class="flex items-center">
                   <div class="p-2 bg-purple-100 rounded-lg">
                       <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                       </svg>
                   </div>
                   <div class="ml-3">
                       <p class="text-sm font-medium text-slate-600">Pool Status</p>
                       <p id="pool-status" class="text-lg font-bold text-slate-900">Active</p>
                   </div>
               </div>
           </div>
       </div>

       <!-- Current Pool Configuration -->
       <div class="bg-white border border-slate-200 rounded-lg">
           <div class="px-6 py-4 border-b border-slate-200">
               <h4 class="text-lg font-semibold text-slate-800">Pool Configuration</h4>
           </div>
           <div class="p-6">
               <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Pool Name</dt>
                       <dd id="current-pool-name" class="mt-1 text-sm text-slate-900 font-medium">--</dd>
                   </div>
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Pool Type</dt>
                       <dd id="current-pool-type" class="mt-1 text-sm text-slate-900">--</dd>
                   </div>
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Join Method</dt>
                       <dd id="current-join-method" class="mt-1 text-sm text-slate-900">--</dd>
                   </div>
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Max Members</dt>
                       <dd id="current-max-members" class="mt-1 text-sm text-slate-900">--</dd>
                   </div>
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Created</dt>
                       <dd id="pool-created-date" class="mt-1 text-sm text-slate-900">--</dd>
                   </div>
                   <div>
                       <dt class="text-sm font-medium text-slate-600">Creator</dt>
                       <dd id="pool-creator" class="mt-1 text-sm text-slate-900">--</dd>
                   </div>
               </dl>
               
               <div class="mt-6">
                   <dt class="text-sm font-medium text-slate-600 mb-2">Description</dt>
                   <dd id="current-pool-description" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg">--</dd>
               </div>
           </div>
       </div>

       <!-- Pool Members Management -->
       <div class="bg-white border border-slate-200 rounded-lg">
           <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
               <h4 class="text-lg font-semibold text-slate-800">Pool Members</h4>
               <button id="invite-member-btn" class="px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                   Invite Member
               </button>
           </div>
           <div class="overflow-hidden">
               <div class="overflow-x-auto">
                   <table class="min-w-full divide-y divide-slate-200">
                       <thead class="bg-slate-50">
                           <tr>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                   Member <span class="text-slate-400 ml-1" title="Sorted by last name"></span>
                               </th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Role</th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Participation</th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Joined</th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                               <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                           </tr>
                       </thead>
                       <tbody id="pool-members-tbody" class="bg-white divide-y divide-slate-200">
                           <!-- Members will be populated dynamically -->
                           <tr>
                               <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">
                                   Loading members...
                               </td>
                           </tr>
                       </tbody>
                   </table>
               </div>
           </div>
       </div>

       <!-- Unassociated Users Management -->
       <div class="bg-white border border-slate-200 rounded-lg">
           <div class="px-6 py-4 border-b border-slate-200">
               <h4 class="text-lg font-semibold text-slate-800">Add Users to <span id="add-users-pool-name">Pool</span></h4>
               <p class="text-sm text-slate-600 mt-1">Add existing system users to this pool</p>
           </div>
           
           <!-- Recent Users Section -->
           <div class="p-6 border-b border-slate-200">
               <div class="flex items-center justify-between mb-4">
                   <h5 class="text-md font-medium text-slate-700">Recent Users</h5>
                   <div id="recent-users-loading" class="hidden">
                       <svg class="animate-spin h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24">
                           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                       </svg>
                   </div>
               </div>
               <div id="recent-users-list" class="space-y-3">
                   <div class="text-sm text-slate-500 text-center py-8">
                       Loading recent users...
                   </div>
               </div>
           </div>
           
           <!-- Search Users Section -->
           <div class="p-6">
               <div class="mb-4">
                   <label for="user-search-input" class="block text-sm font-medium text-slate-700 mb-2">
                       Search for User
                   </label>
                   <div class="relative">
                       <input 
                           type="text" 
                           id="user-search-input" 
                           class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Search by name or email..."
                       />
                       <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                           <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                           </svg>
                       </div>
                       <div id="search-loading" class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none hidden">
                           <svg class="animate-spin h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24">
                               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                           </svg>
                       </div>
                   </div>
               </div>
               <div id="search-results-list" class="space-y-3">
                   <!-- Search results will be populated here -->
               </div>
           </div>
       </div>

       <!-- Invite Links Management -->
       <div class="bg-white border border-slate-200 rounded-lg">
           <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
               <h4 class="text-lg font-semibold text-slate-800">Invite Links</h4>
               <button id="create-invite-link-btn" class="px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                   Create New Link
               </button>
           </div>
           <div class="p-6">
               <div id="invite-links-container" class="space-y-3">
                   <div class="text-sm text-slate-500 text-center py-4">
                       No active invite links. Create one to invite new members.
                   </div>
               </div>
           </div>
       </div>

       <!-- Pool Actions -->
       <div class="bg-white border border-slate-200 rounded-lg">
           <div class="px-6 py-4 border-b border-slate-200">
               <h4 class="text-lg font-semibold text-slate-800">Pool Actions</h4>
           </div>
           <div class="p-6">
               <div class="space-y-4">
                   <div class="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                       <div>
                           <h5 class="text-sm font-medium text-yellow-800">Archive Pool</h5>
                           <p class="text-sm text-yellow-700">End the current season and preserve all data</p>
                       </div>
                       <button id="archive-pool-btn" class="px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors">
                           Archive
                       </button>
                   </div>
                   
                   <div id="delete-pool-section" class="flex items-center justify-between p-4 bg-red-50 border border-red-200 rounded-lg" style="display: none">
                       <div>
                           <h5 class="text-sm font-medium text-red-800">Delete Pool</h5>
                           <p class="text-sm text-red-700">Permanently delete this pool and all associated data</p>
                       </div>
                       <button id="delete-pool-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                           Delete
                       </button>
                   </div>
               </div>
           </div>
       </div>
   </div>
</div>

<div id="admin-content-analytics" class="admin-content-section hidden">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-slate-800">Pick Analytics</h3>
        <div class="flex space-x-2">
            <button id="refresh-analytics-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Refresh Data
            </button>
            <button id="export-analytics-btn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                Export CSV
            </button>
        </div>
    </div>

    <!-- Analytics Loading State -->
    <div id="analytics-loading" class="hidden text-center py-12">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-slate-600">Loading analytics data...</p>
    </div>

    <!-- Analytics Error State -->
    <div id="analytics-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Error Loading Analytics</h3>
                <p id="analytics-error-message" class="text-sm text-red-700 mt-1"></p>
            </div>
        </div>
    </div>

    <!-- Analytics Content -->
    <div id="analytics-content" class="space-y-6">
        <!-- Week Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white border border-slate-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-600">Total Games</p>
                        <p id="analytics-total-games" class="text-2xl font-bold text-slate-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-600">Picksets</p>
                        <p id="analytics-total-picksets" class="text-2xl font-bold text-slate-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-600">Consensus Games</p>
                        <p id="analytics-consensus-games" class="text-2xl font-bold text-slate-900">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-orange-100 rounded-lg">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-slate-600">Contrarian Games</p>
                        <p id="analytics-contrarian-games" class="text-2xl font-bold text-slate-900">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Analytics Table -->
        <div class="bg-white border border-slate-200 rounded-lg">
            <div class="px-6 py-4 border-b border-slate-200">
                <h4 class="text-lg font-semibold text-slate-800">Game-by-Game Analytics</h4>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Game</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pick Distribution</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Avg Confidence</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Popularity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Contrarian %</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-games-table" class="bg-white divide-y divide-slate-200">
                        <!-- Analytics data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Clusters -->
        <div class="bg-white border border-slate-200 rounded-lg">
            <div class="px-6 py-4 border-b border-slate-200">
                <h4 class="text-lg font-semibold text-slate-800">User Pick Clusters</h4>
                <p class="text-sm text-slate-600">Groups of users with similar picking patterns</p>
            </div>
            <div class="p-6">
                <div id="analytics-clusters-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Clusters will be populated here -->
                </div>
            </div>
        </div>

        <!-- Confidence Analysis -->
        <div class="bg-white border border-slate-200 rounded-lg">
            <div class="px-6 py-4 border-b border-slate-200">
                <h4 class="text-lg font-semibold text-slate-800">Confidence Analysis</h4>
                <p class="text-sm text-slate-600">How confident users are in their picks</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h5 class="text-md font-medium text-slate-700 mb-3">Highest Confidence Games</h5>
                        <div id="analytics-high-confidence" class="space-y-2">
                            <!-- High confidence games will be populated here -->
                        </div>
                    </div>
                    <div>
                        <h5 class="text-md font-medium text-slate-700 mb-3">Lowest Confidence Games</h5>
                        <div id="analytics-low-confidence" class="space-y-2">
                            <!-- Low confidence games will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="text-center">
            <p class="text-sm text-slate-500">
                Last updated: <span id="analytics-last-updated">Never</span>
            </p>
        </div>
    </div>
</div>

<!-- ESPN API Admin Section -->
<div id="admin-content-espn-api" class="admin-content-section hidden">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-xl font-bold text-slate-800">ESPN API Management</h3>
            <p class="text-slate-600 text-sm mt-1">Monitor and manage ESPN API integration for automated NFL data</p>
        </div>
        <div class="flex space-x-2">
            <a href="espnDiagnostic.html" target="_blank" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                Full Diagnostic Dashboard
            </a>
            <button id="espn-refresh-status-btn" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                Refresh Status
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div id="espn-api-status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">API Status</p>
                    <p id="espn-api-status-text" class="text-lg font-semibold text-slate-900">Checking...</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Current Week</p>
                    <p id="espn-current-week" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Rate Limit</p>
                    <p id="espn-rate-limit" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Cache Entries</p>
                    <p id="espn-cache-count" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Quick Actions</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <button id="espn-test-current-week" class="w-full px-4 py-3 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                Test Current Week
            </button>
            <button id="espn-test-teams" class="w-full px-4 py-3 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">
                Test NFL Teams
            </button>
            <button id="espn-clear-cache" class="w-full px-4 py-3 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition-colors">
                Clear ESPN Cache
            </button>
            <button id="espn-fetch-season" class="w-full px-4 py-3 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">
                Fetch Full Season
            </button>
        </div>
    </div>

    <!-- Test Results -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-slate-800">Test Results</h4>
            <span id="espn-tests-status" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                Ready
            </span>
        </div>
        <div id="espn-test-results" class="space-y-2">
            <div class="text-slate-500 text-sm">Run tests to see results...</div>
        </div>
    </div>

    <!-- Data Integration Status -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Data Integration Status</h4>
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-medium text-slate-700">Schedule Data Source</p>
                    <p class="text-sm text-slate-600">Current source for NFL game schedules</p>
                </div>
                <div class="text-right">
                    <span id="espn-schedule-source" class="text-sm font-medium text-slate-800">Static File</span>
                    <p class="text-xs text-slate-500">Last updated: <span id="espn-schedule-updated">-</span></p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-medium text-slate-700">Live Scores Integration</p>
                    <p class="text-sm text-slate-600">Real-time game score updates</p>
                </div>
                <div class="text-right">
                    <span id="espn-scores-status" class="text-sm font-medium text-yellow-600">Not Active</span>
                    <p class="text-xs text-slate-500">Manual entry required</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-medium text-slate-700">Team Data</p>
                    <p class="text-sm text-slate-600">NFL team information and logos</p>
                </div>
                <div class="text-right">
                    <span id="espn-teams-status" class="text-sm font-medium text-slate-800">Available</span>
                    <p class="text-xs text-slate-500">Via ESPN API</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Logs -->
    <div class="bg-white border border-slate-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-slate-800">ESPN API Activity</h4>
            <button id="espn-clear-logs" class="text-red-600 hover:text-red-700 text-sm">
                Clear Logs
            </button>
        </div>
        <div id="espn-activity-logs" class="bg-slate-50 border border-slate-200 rounded p-4 max-h-64 overflow-y-auto font-mono text-sm">
            <div class="text-slate-500">Activity logs will appear here...</div>
        </div>
    </div>
</div>

<!-- Cache Management Admin Section -->
<div id="admin-content-cache-mgmt" class="admin-content-section hidden">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-xl font-bold text-slate-800"> Survivor Cache Management</h3>
            <p class="text-slate-600 text-sm mt-1">Optimize performance with intelligent caching (Target: &lt;500ms load times)</p>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Last Load Time</p>
                    <p id="cache-last-load-time" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Cache Hit Rate</p>
                    <p id="cache-hit-rate" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Target Met</p>
                    <p id="cache-target-met" class="text-lg font-semibold text-slate-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="ml-3">
                    <p class="text-sm font-medium text-slate-600">Active Caches</p>
                    <p id="cache-active-count" class="text-lg font-semibold text-slate-900">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Actions -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Cache Actions</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button id="cache-warm-btn" class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                 Warm Cache
            </button>
            <button id="cache-invalidate-btn" class="px-4 py-2 bg-yellow-600 text-white font-medium rounded-lg hover:bg-yellow-700">
                 Invalidate Cache
            </button>
            <button id="cache-clear-all-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700">
                 Clear All Caches
            </button>
            <button id="cache-refresh-stats-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
                 Refresh Stats
            </button>
        </div>
    </div>

    <!-- Performance Testing -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Performance Testing</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <button id="cache-test-cold-btn" class="w-full px-4 py-2 bg-slate-600 text-white font-medium rounded-lg hover:bg-slate-700 mb-2">
                     Test Cold Load (No Cache)
                </button>
                <div id="cache-cold-result" class="text-sm text-slate-600">-</div>
            </div>
            <div>
                <button id="cache-test-warm-btn" class="w-full px-4 py-2 bg-slate-600 text-white font-medium rounded-lg hover:bg-slate-700 mb-2">
                     Test Warm Load (With Cache)
                </button>
                <div id="cache-warm-result" class="text-sm text-slate-600">-</div>
            </div>
        </div>
    </div>

    <!-- Cache Status -->
    <div class="bg-white border border-slate-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-slate-800">Cache Status</h4>
            <button id="cache-view-details-btn" class="text-blue-600 hover:text-blue-700 text-sm">
                View Details
            </button>
        </div>
        <div id="cache-status-container" class="bg-slate-50 border border-slate-200 rounded p-4 max-h-64 overflow-y-auto font-mono text-sm">
            <div class="text-slate-500">Cache status will appear here...</div>
        </div>
    </div>
</div>

 </div>
 </div>
 </div>

 <!-- Grid View -->
 <div id="grid-container" class="hidden">
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-5xl mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-center">NerdfootballAI - The Grid</h2>
        <div class="text-center mb-4">
            <p class="text-slate-600 mb-2">Weekly picks at a glance.</p>
            <div class="mb-4">
                <a href="#" id="grid-yearly-leaderboard-link" class="text-slate-600 hover:text-slate-800 font-medium">View Yearly Leaderboard &rarr;</a>
            </div>
            <div id="grid-week-selector-container" class="mb-4 text-center">
                <label for="grid-week-selector" class="text-lg font-medium text-gray-700 mr-2">Week:</label>
                <select id="grid-week-selector" class="p-2 rounded-lg border-2 border-gray-300 bg-white"></select>
            </div>
        </div>
        <div id="grid-table-container" class="overflow-x-auto">
            <div id="grid-table-loader" class="text-center py-8">
                <div class="loader"></div>
                <p class="text-slate-600 mt-2">Loading grid...</p>
            </div>
            <div id="grid-table-content"></div>
        </div>
    </div>
 </div>

    <!-- Survivor Results View -->
    <div id="survivor-container" class="hidden">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- Loading State -->
            <div id="survivor-loading-container" class="text-center py-12">
                <div class="loading-spinner w-12 h-12 mx-auto border-4 border-gray-200 rounded-full"></div>
                <p class="mt-4 text-gray-600">Loading survivor results...</p>
            </div>

            <!-- Error State -->
            <div id="survivor-error-container" class="hidden text-center py-12">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Error Loading Results</h2>
                <p id="survivor-error-message" class="text-gray-600"></p>
                <button id="survivor-retry-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Try Again
                </button>
            </div>

            <!-- Results Grid -->
            <div id="survivor-results-container" class="hidden">
                <!-- Stats Summary -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Pool Summary</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900" id="survivor-total-players">0</div>
                            <div class="text-sm text-gray-600">Total Players</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="survivor-active-players">0</div>
                            <div class="text-sm text-gray-600">Still Alive</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" id="survivor-eliminated-players">0</div>
                            <div class="text-sm text-gray-600">Eliminated</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="survivor-current-week">1</div>
                            <div class="text-sm text-gray-600">Current Week</div>
                        </div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Survivor Pool Status</h2>
                            <div class="flex items-center space-x-4">
                                <button id="survivor-admin-panel-btn" onclick="window.open('survivorAdminPanel.html', '_blank')" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors" style="display: none">
                                    <i class="fas fa-cog mr-1"></i> Admin Panel
                                </button>
                                <div class="flex items-center text-sm">
                                    <div class="w-4 h-4 bg-green-200 rounded mr-2"></div>
                                    <span class="text-gray-600">Active</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <div class="w-4 h-4 bg-rose-200 rounded mr-2"></div>
                                    <span class="text-gray-600">Eliminated</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto survivor-grid">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Player
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Current Week Pick
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Pick Week
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Eliminated Week
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Weeks Survived
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="survivor-results-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Results State -->
                <div id="survivor-no-results" class="hidden text-center py-12">
                    <i class="fas fa-users-slash text-4xl text-gray-400 mb-4"></i>
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">No Survivor Pool Data</h2>
                    <p class="text-gray-600 mb-4">No players have joined the survivor pool yet.</p>
                    <a href="./index.html?view=survivor-picks" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>
                        Join Survivor Pool
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Survivor Picks View -->
    <div id="survivor-picks-container" class="hidden">
        <div class="max-w-5xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- Content will be dynamically populated by SurvivorPicksView -->
        </div>
    </div>

<!-- DIAMOND LEVEL: Cache Management Admin Section -->
<div id="admin-content-cache-mgmt" class="admin-content-section hidden">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h3 class="text-xl font-bold text-slate-800"> Survivor Cache Management</h3>
            <p class="text-slate-600 text-sm mt-1">Monitor and manage survivor result caching for optimal performance</p>
        </div>
        <div class="flex space-x-2">
            <button id="cache-refresh-all-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">
                 Refresh All Caches
            </button>
            <button id="cache-clear-all-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">
                 Clear All Caches
            </button>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-green-600"></span>
                </div>
                <div>
                    <div class="text-sm font-medium text-slate-600">Last Load Time</div>
                    <div id="cache-last-load-time" class="text-2xl font-bold text-slate-900">--ms</div>
                </div>
            </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-blue-600"></span>
                </div>
                <div>
                    <div class="text-sm font-medium text-slate-600">Cache Hit Rate</div>
                    <div id="cache-hit-rate" class="text-2xl font-bold text-slate-900">--%</div>
                </div>
            </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-purple-600"></span>
                </div>
                <div>
                    <div class="text-sm font-medium text-slate-600">Target Met</div>
                    <div id="cache-target-status" class="text-2xl font-bold text-slate-900">--</div>
                </div>
            </div>
        </div>
        <div class="bg-white border border-slate-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-orange-600"></span>
                </div>
                <div>
                    <div class="text-sm font-medium text-slate-600">Active Caches</div>
                    <div id="cache-count" class="text-2xl font-bold text-slate-900">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Actions -->
    <div class="bg-white border border-slate-200 rounded-lg p-6 mb-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Quick Actions</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button id="cache-test-load-btn" class="flex items-center justify-center px-4 py-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors text-green-700 font-medium">
                <span class="mr-2"></span>
                Test Load Performance
            </button>
            <button id="cache-warm-btn" class="flex items-center justify-center px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium">
                <span class="mr-2"></span>
                Warm Cache
            </button>
            <button id="cache-invalidate-btn" class="flex items-center justify-center px-4 py-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors text-orange-700 font-medium">
                <span class="mr-2"></span>
                Force Invalidate
            </button>
        </div>
    </div>

    <!-- Cache Status Table -->
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200">
            <h4 class="text-lg font-semibold text-slate-800">Cache Status</h4>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Pool/Week</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Generated</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Load Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="cache-status-tbody" class="bg-white divide-y divide-slate-200">
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-slate-500">
                            <div class="flex flex-col items-center">
                                <div class="w-8 h-8 mb-2 bg-slate-100 rounded-full flex items-center justify-center">
                                    <span class="text-slate-400"></span>
                                </div>
                                <div>Loading cache status...</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Performance Testing Results -->
    <div id="cache-test-results" class="hidden mt-6 bg-slate-50 border border-slate-200 rounded-lg p-6">
        <h4 class="text-lg font-semibold text-slate-800 mb-4">Performance Test Results</h4>
        <div id="cache-test-output" class="bg-white border border-slate-200 rounded p-4 font-mono text-sm text-slate-700 max-h-64 overflow-y-auto">
            <!-- Test results will appear here -->
        </div>
    </div>
</div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex">
        <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-md w-full mx-auto border border-slate-300 relative">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">User Settings</h2>
            <div id="settings-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
            <div id="settings-success" class="text-green-600 text-center text-sm mb-4 hidden p-3 bg-green-100 rounded-md border border-green-200"></div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="settings-display-name" class="block text-sm font-medium text-slate-700">Display Name</label>
                    <input type="text" id="settings-display-name" required class="mt-1 form-input">
                </div>
                <div>
                    <label for="settings-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                    <input type="email" id="settings-email" required class="mt-1 form-input">
                    <div id="email-verification-status" class="mt-2 hidden">
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                            <div class="flex">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-yellow-800">Email Change in Progress</h4>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        <span id="email-change-status">Attempting to send verification email to <span id="pending-email" class="font-medium"></span>...</span>
                                    </p>
                                    <div class="mt-2 space-y-2">
                                        <button id="resend-verification-btn" type="button" class="text-sm text-yellow-600 hover:text-yellow-800 underline hidden">Resend verification email</button>
                                        <button id="try-different-method-btn" type="button" class="text-sm text-blue-600 hover:text-blue-800 underline">Try a different approach</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="password-reauth-section" class="mt-2 hidden">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">Confirm Your Password</h4>
                            <p class="text-sm text-blue-700 mb-3">For security, please enter your current password to change your email address.</p>
                            <input type="password" id="reauth-password" placeholder="Current Password" class="form-input text-sm mb-2">
                            <div class="flex gap-2">
                                <button id="confirm-email-change-btn" type="button" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Confirm Change</button>
                                <button id="cancel-email-change-btn" type="button" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Linking Section -->
                <div class="border-t border-gray-300 pt-4 mt-6">
                    <h3 class="text-lg font-medium text-slate-800 mb-3">Account Linking</h3>
                    <div id="google-link-status" class="mb-4">
                        <div id="google-not-linked" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Google Account</p>
                                    <p class="text-xs text-slate-500">Not linked</p>
                                </div>
                            </div>
                            <button id="link-google-btn" type="button" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Link Account
                            </button>
                        </div>
                        <div id="google-linked" class="hidden flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Google Account</p>
                                    <p class="text-xs text-green-600"> Linked - You can sign in with Google</p>
                                </div>
                            </div>
                            <button id="unlink-google-btn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                Unlink
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">Link your Google account to sign in faster and more securely.</p>
                </div>

                <!-- Notification Settings Section -->
                <div class="border-t border-gray-300 pt-4 mt-6">
                    <h3 class="text-lg font-medium text-slate-800 mb-3"> Push Notifications</h3>
                    <div id="notification-settings-section">
                        <div id="notification-status" class="mb-4 p-3 rounded-lg border">
                            <!-- Status will be populated by JavaScript -->
                        </div>
                        <div id="notification-preferences" class="space-y-3">
                            <!-- Preferences will be populated by JavaScript -->
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Enable push notifications to get real-time updates about picks, results, and announcements.</p>
                </div>

                <div class="pt-4">
                    <button type="submit" class="form-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pool Creation Modal -->
    <div id="pool-creation-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex" role="dialog" aria-labelledby="pool-creation-title" aria-modal="true">
        <div class="fixed inset-0 bg-black bg-opacity-50" aria-hidden="true"></div>
        <div class="relative p-6 bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <button id="close-pool-creation-btn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Close pool creation dialog">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <h2 id="pool-creation-title" class="text-2xl font-bold text-slate-800 mb-6">Create New Pool</h2>
            
            <!-- Progress Indicator -->
            <div class="flex items-center justify-center mb-8" aria-label="Pool creation progress">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium" aria-current="step">1</div>
                        <span class="ml-2 text-sm font-medium text-blue-600">Basic Info</span>
                    </div>
                    <div class="h-0.5 w-8 bg-slate-200" aria-hidden="true"></div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-slate-200 text-slate-400 rounded-full flex items-center justify-center text-sm font-medium">2</div>
                        <span class="ml-2 text-sm text-slate-400">Settings</span>
                    </div>
                    <div class="h-0.5 w-8 bg-slate-200" aria-hidden="true"></div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-slate-200 text-slate-400 rounded-full flex items-center justify-center text-sm font-medium">3</div>
                        <span class="ml-2 text-sm text-slate-400">Review</span>
                    </div>
                </div>
            </div>

            <form id="pool-creation-form" class="space-y-6" novalidate>
                <!-- Step 1: Basic Information -->
                <div id="step-1" class="step-content">
                    <div class="space-y-4">
                        <div>
                            <label for="pool-name" class="block text-sm font-semibold text-slate-700 mb-2">
                                Pool Name <span class="text-red-500" aria-label="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="pool-name" 
                                name="poolName"
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                placeholder="Enter pool name (e.g., Friends & Family 2025)"
                                maxlength="50"
                                required
                                aria-describedby="pool-name-help pool-name-error"
                            >
                            <p id="pool-name-help" class="mt-1 text-sm text-slate-500">Choose a memorable name for your pool (2-50 characters)</p>
                            <p id="pool-name-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
                        </div>

                        <div>
                            <label for="pool-description" class="block text-sm font-semibold text-slate-700 mb-2">
                                Description
                            </label>
                            <textarea 
                                id="pool-description" 
                                name="poolDescription"
                                rows="3"
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-vertical"
                                placeholder="Optional description of your pool"
                                maxlength="200"
                                aria-describedby="pool-description-help"
                            ></textarea>
                            <p id="pool-description-help" class="mt-1 text-sm text-slate-500">Optional: Describe your pool's purpose or rules (max 200 characters)</p>
                        </div>

                        <div>
                            <fieldset>
                                <legend class="block text-sm font-semibold text-slate-700 mb-3">
                                    Pool Type <span class="text-red-500" aria-label="required">*</span>
                                </legend>
                                <div class="space-y-3">
                                    <div class="flex items-start">
                                        <input 
                                            type="radio" 
                                            id="type-confidence" 
                                            name="poolType" 
                                            value="confidence" 
                                            class="mt-1 focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300"
                                            required
                                            aria-describedby="type-confidence-desc"
                                        >
                                        <label for="type-confidence" class="ml-3 cursor-pointer">
                                            <span class="block text-sm font-medium text-slate-700">Confidence Points Only</span>
                                            <span id="type-confidence-desc" class="block text-sm text-slate-500">Rank weekly games by confidence (1-16 points)</span>
                                        </label>
                                    </div>
                                    <div class="flex items-start">
                                        <input 
                                            type="radio" 
                                            id="type-survivor" 
                                            name="poolType" 
                                            value="survivor" 
                                            class="mt-1 focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300"
                                            aria-describedby="type-survivor-desc"
                                        >
                                        <label for="type-survivor" class="ml-3 cursor-pointer">
                                            <span class="block text-sm font-medium text-slate-700">Survivor Pool Only</span>
                                            <span id="type-survivor-desc" class="block text-sm text-slate-500">Pick one winning team per week, can't reuse teams</span>
                                        </label>
                                    </div>
                                    <div class="flex items-start">
                                        <input 
                                            type="radio" 
                                            id="type-both" 
                                            name="poolType" 
                                            value="both" 
                                            class="mt-1 focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300"
                                            checked
                                            aria-describedby="type-both-desc"
                                        >
                                        <label for="type-both" class="ml-3 cursor-pointer">
                                            <span class="block text-sm font-medium text-slate-700">Both (Recommended)</span>
                                            <span id="type-both-desc" class="block text-sm text-slate-500">Confidence points + survivor pool combined</span>
                                        </label>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Pool Settings (Hidden initially) -->
                <div id="step-2" class="step-content hidden">
                    <div class="space-y-4">
                        <div>
                            <label for="max-members" class="block text-sm font-semibold text-slate-700 mb-2">
                                Maximum Members
                            </label>
                            <select 
                                id="max-members" 
                                name="maxMembers"
                                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                aria-describedby="max-members-help"
                            >
                                <option value="10">10 Members</option>
                                <option value="25">25 Members</option>
                                <option value="50" selected>50 Members</option>
                                <option value="100">100 Members</option>
                            </select>
                            <p id="max-members-help" class="mt-1 text-sm text-slate-500">You can always increase this later</p>
                        </div>

                        <div>
                            <fieldset>
                                <legend class="block text-sm font-semibold text-slate-700 mb-3">Join Method</legend>
                                <div class="space-y-3">
                                    <div class="flex items-start">
                                        <input 
                                            type="radio" 
                                            id="join-invite" 
                                            name="joinMethod" 
                                            value="invite" 
                                            class="mt-1 focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300"
                                            checked
                                            aria-describedby="join-invite-desc"
                                        >
                                        <label for="join-invite" class="ml-3 cursor-pointer">
                                            <span class="block text-sm font-medium text-slate-700">Invite Only (Recommended)</span>
                                            <span id="join-invite-desc" class="block text-sm text-slate-500">Members join using invite links you share</span>
                                        </label>
                                    </div>
                                    <div class="flex items-start">
                                        <input 
                                            type="radio" 
                                            id="join-public" 
                                            name="joinMethod" 
                                            value="public" 
                                            class="mt-1 focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300"
                                            aria-describedby="join-public-desc"
                                        >
                                        <label for="join-public" class="ml-3 cursor-pointer">
                                            <span class="block text-sm font-medium text-slate-700">Public</span>
                                            <span id="join-public-desc" class="block text-sm text-slate-500">Anyone can find and join your pool</span>
                                        </label>
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="weekly-reminders" 
                                    name="weeklyReminders"
                                    class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-300 rounded"
                                    checked
                                >
                                <span class="ml-3 text-sm font-medium text-slate-700">Send weekly reminder emails</span>
                            </label>
                            <p class="mt-1 ml-7 text-sm text-slate-500">Remind members to make their picks before games start</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review (Hidden initially) -->
                <div id="step-3" class="step-content hidden">
                    <div class="space-y-4">
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">Review Your Pool</h3>
                            
                            <dl class="space-y-3">
                                <div class="flex justify-between">
                                    <dt class="text-sm font-medium text-slate-600">Pool Name:</dt>
                                    <dd id="review-name" class="text-sm text-slate-800 font-medium"></dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm font-medium text-slate-600">Type:</dt>
                                    <dd id="review-type" class="text-sm text-slate-800"></dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm font-medium text-slate-600">Max Members:</dt>
                                    <dd id="review-max-members" class="text-sm text-slate-800"></dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm font-medium text-slate-600">Join Method:</dt>
                                    <dd id="review-join-method" class="text-sm text-slate-800"></dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt class="text-sm font-medium text-slate-600">Reminders:</dt>
                                    <dd id="review-reminders" class="text-sm text-slate-800"></dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2">What happens next?</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li> Your pool will be created and you'll be the admin</li>
                                <li> You'll get an invite link to share with friends</li>
                                <li> Pool picks will start with the current NFL week</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between pt-6 border-t border-slate-200">
                    <button 
                        type="button" 
                        id="prev-step-btn" 
                        class="px-6 py-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500 hidden"
                    >
                        Previous
                    </button>
                    <div class="flex space-x-4 ml-auto">
                        <button 
                            type="button" 
                            id="cancel-pool-btn" 
                            class="px-6 py-3 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500"
                        >
                            Cancel
                        </button>
                        <button 
                            type="button" 
                            id="next-step-btn" 
                            class="px-6 py-3 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            Next
                        </button>
                        <button 
                            type="submit" 
                            id="create-pool-submit-btn" 
                            class="px-6 py-3 bg-green-600 text-white hover:bg-green-700 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 hidden"
                        >
                            <span id="create-pool-btn-text">Create Pool</span>
                            <svg id="create-pool-spinner" class="hidden animate-spin -mr-1 ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="pool-creation-error" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg" role="alert">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error creating pool</h3>
                            <p id="pool-creation-error-message" class="mt-1 text-sm text-red-700"></p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Pool Discovery Modal -->
    <div id="pool-discovery-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex" role="dialog" aria-labelledby="pool-discovery-title" aria-modal="true">
        <div class="fixed inset-0 bg-black bg-opacity-50" aria-hidden="true"></div>
        <div class="relative p-6 bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="pool-discovery-title" class="text-2xl font-bold text-slate-800">Discover Public Pools</h2>
                <button id="close-pool-discovery-btn" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Close pool discovery">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Search and Filter Controls -->
            <div class="mb-6 space-y-4">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="pool-search" class="block text-sm font-medium text-slate-700 mb-2">Search pools</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="pool-search" 
                                placeholder="Search by name or description..." 
                                class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                aria-describedby="pool-search-help"
                            >
                            <svg class="absolute left-3 top-3.5 h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <p id="pool-search-help" class="mt-1 text-sm text-slate-500">Find pools by name, description, or creator</p>
                    </div>
                    <div class="sm:w-48">
                        <label for="pool-type-filter" class="block text-sm font-medium text-slate-700 mb-2">Pool type</label>
                        <select id="pool-type-filter" class="w-full py-3 px-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All types</option>
                            <option value="confidence">Confidence only</option>
                            <option value="survivor">Survivor only</option>
                            <option value="both">Both games</option>
                        </select>
                    </div>
                </div>

                <!-- Active filters display -->
                <div id="active-filters" class="hidden">
                    <div class="flex flex-wrap gap-2">
                        <span class="text-sm text-slate-600">Filters:</span>
                        <div id="filter-tags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Loading state -->
            <div id="pools-loading" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-slate-600">Searching for public pools...</p>
            </div>

            <!-- Empty state -->
            <div id="pools-empty" class="hidden text-center py-12">
                <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-slate-900">No pools found</h3>
                <p class="mt-2 text-slate-600">Try adjusting your search terms or filters</p>
            </div>

            <!-- Pool results -->
            <div id="pools-results" class="space-y-4">
                <!-- Pool cards will be populated here -->
            </div>

            <!-- Pagination -->
            <div id="pools-pagination" class="hidden mt-8 flex justify-center">
                <nav class="flex space-x-2" aria-label="Pagination">
                    <button id="prev-page" class="px-3 py-2 text-sm text-slate-600 border border-slate-300 rounded hover:bg-slate-50" disabled>Previous</button>
                    <span id="page-info" class="px-3 py-2 text-sm text-slate-700">Page 1 of 1</span>
                    <button id="next-page" class="px-3 py-2 text-sm text-slate-600 border border-slate-300 rounded hover:bg-slate-50" disabled>Next</button>
                </nav>
            </div>

            <!-- Error state -->
            <div id="pools-error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-6">
                <div class="flex">
                    <svg class="w-5 h-5 text-red-400 mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-red-800">Error loading pools</h3>
                        <p id="pools-error-message" class="mt-1 text-sm text-red-700"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User to Pool Modal -->
    <div id="add-user-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex" role="dialog" aria-labelledby="add-user-title" aria-modal="true">
        <div class="fixed inset-0 bg-black bg-opacity-50" aria-hidden="true"></div>
        <div class="relative p-6 bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 id="add-user-title" class="text-lg font-semibold text-slate-800">Add User to Pool</h3>
                <button id="close-add-user-modal" class="text-slate-400 hover:text-slate-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- User Info Display -->
            <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-slate-300 rounded-full flex items-center justify-center">
                        <span id="modal-user-avatar" class="text-sm font-medium text-slate-700">?</span>
                    </div>
                    <div class="flex-1">
                        <div id="modal-user-name" class="text-sm font-medium text-slate-900">User Name</div>
                        <div id="modal-user-email" class="text-xs text-slate-500">user@example.com</div>
                    </div>
                </div>
            </div>
            
            <!-- Role Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-3">Select Role</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="user-role" value="member" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-sm text-slate-700">
                            <span class="font-medium">Member</span>
                            <span class="text-slate-500">- Can make picks and view leaderboard</span>
                        </span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="user-role" value="admin" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                        <span class="ml-3 text-sm text-slate-700">
                            <span class="font-medium">Admin</span>
                            <span class="text-slate-500">- Full pool management access</span>
                        </span>
                    </label>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center justify-end space-x-3">
                <button id="cancel-add-user" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 rounded-md hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500">
                    Cancel
                </button>
                <button id="confirm-add-user" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="add-user-btn-text">Add to Pool</span>
                    <div id="add-user-loading" class="hidden inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Adding...
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- NerdUniverse Migration Modal -->
    <div id="migration-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex" role="dialog" aria-labelledby="migration-title" aria-modal="true">
        <div class="fixed inset-0 bg-black bg-opacity-50" aria-hidden="true"></div>
        <div class="relative p-6 bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="migration-title" class="text-2xl font-bold text-slate-800">NerdUniverse 2025 Migration</h2>
                <button id="close-migration-btn" class="text-slate-400 hover:text-slate-600 transition-colors" aria-label="Close migration">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Migration Info -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">What this migration will do:</h3>
                <ul class="list-disc list-inside text-blue-700 space-y-1 text-sm">
                    <li>Create the <strong>NerdUniverse 2025</strong> pool</li>
                    <li>Migrate all existing users with their current roles</li>
                    <li>Preserve <strong>ALL</strong> confidence picks for all weeks</li>
                    <li>Preserve <strong>ALL</strong> survivor picks and status</li>
                    <li>Maintain admin roles for existing admins</li>
                    <li>Keep backward compatibility with existing data</li>
                </ul>
            </div>

            <!-- Migration Progress -->
            <div id="migration-progress-section" class="mb-6 hidden">
                <h3 class="text-lg font-semibold text-slate-800 mb-3">Migration Progress</h3>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                    <div id="migration-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="migration-progress-text" class="text-slate-600 text-sm">Initializing...</p>
            </div>

            <!-- Migration Log -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-800 mb-3">Migration Log</h3>
                <div id="migration-log-display" class="bg-slate-50 border border-slate-200 rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs">
                    <div class="text-slate-600">Ready to start migration...</div>
                </div>
            </div>

            <!-- Migration Controls -->
            <div id="migration-controls-section" class="flex space-x-4">
                <button id="start-migration-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                    Start Migration
                </button>
                <button id="dry-run-migration-btn" class="px-6 py-3 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition-colors">
                    Dry Run (Test Only)
                </button>
                <button id="close-migration-btn-2" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
            </div>

            <!-- Results -->
            <div id="migration-results-section" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h3 class="text-lg font-semibold text-green-900 mb-2">Migration Complete!</h3>
                <div id="migration-results-content"></div>
            </div>
        </div>
    </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, updateEmail, signOut, GoogleAuthProvider, signInWithPopup, linkWithCredential, fetchSignInMethodsForEmail, verifyBeforeUpdateEmail, sendEmailVerification, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, updateDoc, deleteDoc, deleteField, serverTimestamp, runTransaction, query, orderBy, limit, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
import { getMessaging } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";
// PHAROAH'S REALTIME INTEGRATION - Firebase RTDB for WebSocket integration
import { getDatabase, ref, onValue, set, push, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

// --- FCM INTEGRATION ---
// Include FCM integration module
const fcmScript = document.createElement('script');
fcmScript.src = '/fcm-integration.js';
fcmScript.defer = true;
document.head.appendChild(fcmScript);

// --- THEME MANAGEMENT SYSTEM ---
class ThemeManager {
    constructor() {
        this.themes = {
            'ocean': { name: 'Ocean Breeze', icon: '' },
            'ibm': { name: 'IBM Diagnostic', icon: '' },
            'warm-dark': { name: 'Warm Dark', icon: '' },
            'arizona-cardinals-light': { name: 'Arizona Cardinals', icon: '', variant: 'Light' },
            'arizona-cardinals-dark': { name: 'Arizona Cardinals', icon: '', variant: 'Dark' },
            'atlanta-falcons-light': { name: 'Atlanta Falcons', icon: '', variant: 'Light' },
            'atlanta-falcons-dark': { name: 'Atlanta Falcons', icon: '', variant: 'Dark' },
            'baltimore-ravens-light': { name: 'Baltimore Ravens', icon: '', variant: 'Light' },
            'baltimore-ravens-dark': { name: 'Baltimore Ravens', icon: '', variant: 'Dark' },
            'buffalo-bills-light': { name: 'Buffalo Bills', icon: '', variant: 'Light' },
            'buffalo-bills-dark': { name: 'Buffalo Bills', icon: '', variant: 'Dark' },
            'carolina-panthers-light': { name: 'Carolina Panthers', icon: '', variant: 'Light' },
            'carolina-panthers-dark': { name: 'Carolina Panthers', icon: '', variant: 'Dark' },
            'chicago-bears-light': { name: 'Chicago Bears', icon: '', variant: 'Light' },
            'chicago-bears-dark': { name: 'Chicago Bears', icon: '', variant: 'Dark' },
            'cincinnati-bengals-light': { name: 'Cincinnati Bengals', icon: '', variant: 'Light' },
            'cincinnati-bengals-dark': { name: 'Cincinnati Bengals', icon: '', variant: 'Dark' },
            'cleveland-browns-light': { name: 'Cleveland Browns', icon: '', variant: 'Light' },
            'cleveland-browns-dark': { name: 'Cleveland Browns', icon: '', variant: 'Dark' },
            'dallas-cowboys-light': { name: 'Dallas Cowboys', icon: '', variant: 'Light' },
            'dallas-cowboys-dark': { name: 'Dallas Cowboys', icon: '', variant: 'Dark' },
            'denver-broncos-light': { name: 'Denver Broncos', icon: '', variant: 'Light' },
            'denver-broncos-dark': { name: 'Denver Broncos', icon: '', variant: 'Dark' },
            'detroit-lions-light': { name: 'Detroit Lions', icon: '', variant: 'Light' },
            'detroit-lions-dark': { name: 'Detroit Lions', icon: '', variant: 'Dark' },
            'green-bay-packers-light': { name: 'Green Bay Packers', icon: '', variant: 'Light' },
            'green-bay-packers-dark': { name: 'Green Bay Packers', icon: '', variant: 'Dark' },
            'houston-texans-light': { name: 'Houston Texans', icon: '', variant: 'Light' },
            'houston-texans-dark': { name: 'Houston Texans', icon: '', variant: 'Dark' },
            'indianapolis-colts-light': { name: 'Indianapolis Colts', icon: '', variant: 'Light' },
            'indianapolis-colts-dark': { name: 'Indianapolis Colts', icon: '', variant: 'Dark' },
            'jacksonville-jaguars-light': { name: 'Jacksonville Jaguars', icon: '', variant: 'Light' },
            'jacksonville-jaguars-dark': { name: 'Jacksonville Jaguars', icon: '', variant: 'Dark' },
            'kansas-city-chiefs-light': { name: 'Kansas City Chiefs', icon: '', variant: 'Light' },
            'kansas-city-chiefs-dark': { name: 'Kansas City Chiefs', icon: '', variant: 'Dark' },
            'las-vegas-raiders-light': { name: 'Las Vegas Raiders', icon: '', variant: 'Light' },
            'las-vegas-raiders-dark': { name: 'Las Vegas Raiders', icon: '', variant: 'Dark' },
            'los-angeles-chargers-light': { name: 'Los Angeles Chargers', icon: '', variant: 'Light' },
            'los-angeles-chargers-dark': { name: 'Los Angeles Chargers', icon: '', variant: 'Dark' },
            'los-angeles-rams-light': { name: 'Los Angeles Rams', icon: '', variant: 'Light' },
            'los-angeles-rams-dark': { name: 'Los Angeles Rams', icon: '', variant: 'Dark' },
            'miami-dolphins-light': { name: 'Miami Dolphins', icon: '', variant: 'Light' },
            'miami-dolphins-dark': { name: 'Miami Dolphins', icon: '', variant: 'Dark' },
            'minnesota-vikings-light': { name: 'Minnesota Vikings', icon: '', variant: 'Light' },
            'minnesota-vikings-dark': { name: 'Minnesota Vikings', icon: '', variant: 'Dark' },
            'new-england-patriots-light': { name: 'New England Patriots', icon: '', variant: 'Light' },
            'new-england-patriots-dark': { name: 'New England Patriots', icon: '', variant: 'Dark' },
            'new-orleans-saints-light': { name: 'New Orleans Saints', icon: '', variant: 'Light' },
            'new-orleans-saints-dark': { name: 'New Orleans Saints', icon: '', variant: 'Dark' },
            'new-york-giants-light': { name: 'New York Giants', icon: '', variant: 'Light' },
            'new-york-giants-dark': { name: 'New York Giants', icon: '', variant: 'Dark' },
            'new-york-jets-light': { name: 'New York Jets', icon: '', variant: 'Light' },
            'new-york-jets-dark': { name: 'New York Jets', icon: '', variant: 'Dark' },
            'philadelphia-eagles-light': { name: 'Philadelphia Eagles', icon: '', variant: 'Light' },
            'philadelphia-eagles-dark': { name: 'Philadelphia Eagles', icon: '', variant: 'Dark' },
            'pittsburgh-steelers-light': { name: 'Pittsburgh Steelers', icon: '', variant: 'Light' },
            'pittsburgh-steelers-dark': { name: 'Pittsburgh Steelers', icon: '', variant: 'Dark' },
            'san-francisco-49ers-light': { name: 'San Francisco 49ers', icon: '', variant: 'Light' },
            'san-francisco-49ers-dark': { name: 'San Francisco 49ers', icon: '', variant: 'Dark' },
            'seattle-seahawks-light': { name: 'Seattle Seahawks', icon: '', variant: 'Light' },
            'seattle-seahawks-dark': { name: 'Seattle Seahawks', icon: '', variant: 'Dark' },
            'tampa-bay-buccaneers-light': { name: 'Tampa Bay Buccaneers', icon: '', variant: 'Light' },
            'tampa-bay-buccaneers-dark': { name: 'Tampa Bay Buccaneers', icon: '', variant: 'Dark' },
            'tennessee-titans-light': { name: 'Tennessee Titans', icon: '', variant: 'Light' },
            'tennessee-titans-dark': { name: 'Tennessee Titans', icon: '', variant: 'Dark' },
            'washington-commanders-light': { name: 'Washington Commanders', icon: '', variant: 'Light' },
            'washington-commanders-dark': { name: 'Washington Commanders', icon: '', variant: 'Dark' }
        };
        this.currentTheme = localStorage.getItem('nerd-theme') || 'ocean';
        this.init();
    }
    
    init() {
        // Apply saved theme on page load
        this.applyTheme(this.currentTheme);
        
        // Create theme selector if it doesn't exist
        this.createThemeSelector();
        
        // Create theme variant toggle
        this.createVariantToggle();
    }
    
    applyTheme(themeName) {
        if (!this.themes[themeName]) {
            console.warn(`Theme '${themeName}' not found, falling back to ocean`);
            themeName = 'ocean';
        }
        
        // Remove existing theme classes
        Object.keys(this.themes).forEach(theme => {
            document.documentElement.classList.remove(`theme-${theme}`);
        });
        
        // Apply new theme class
        document.documentElement.classList.add(`theme-${themeName}`);
        
        this.currentTheme = themeName;
        localStorage.setItem('nerd-theme', themeName);
        
        // Update toggle visibility
        this.updateToggleVisibility();
        
        console.log(` Theme applied: ${this.themes[themeName].name}`);
    }
    
    setTheme(themeName) {
        this.applyTheme(themeName);
        this.updateThemeSelector();
    }
    
    createThemeSelector() {
        // Only create if hamburger menu exists (to avoid breaking anything)
        const hamburgerContent = document.querySelector('#menu-panel .py-1[role="menu"]');
        if (!hamburgerContent) return;
        
        // Check if theme selector already exists
        if (document.getElementById('theme-selector')) return;
        
        const themeSelector = document.createElement('div');
        themeSelector.id = 'theme-selector';
        themeSelector.className = 'px-4 py-2 border-t border-slate-300';
        themeSelector.innerHTML = `
            <div class="text-sm font-medium text-slate-700 mb-2">Theme</div>
            <select id="theme-dropdown" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                ${Object.entries(this.themes).map(([key, theme]) => {
                    const displayName = theme.variant ? `${theme.name} ${theme.variant}` : theme.name;
                    return `<option value="${key}" ${key === this.currentTheme ? 'selected' : ''}>${theme.icon} ${displayName}</option>`;
                }).join('')}
            </select>
        `;
        
        // Insert before the last item (typically sign out)
        const lastItem = hamburgerContent.lastElementChild;
        hamburgerContent.insertBefore(themeSelector, lastItem);
        
        // Add event listener
        const dropdown = themeSelector.querySelector('#theme-dropdown');
        dropdown.addEventListener('change', (e) => {
            this.setTheme(e.target.value);
        });
    }
    
    updateThemeSelector() {
        const dropdown = document.getElementById('theme-dropdown');
        if (dropdown) {
            dropdown.value = this.currentTheme;
        }
    }
    
    createVariantToggle() {
        const toggle = document.getElementById('theme-variant-toggle');
        if (!toggle) return;
        
        toggle.addEventListener('click', () => {
            const currentTheme = this.currentTheme;
            
            // Only toggle for NFL team themes (those with variants)
            if (!this.themes[currentTheme]?.variant) return;
            
            // Find the opposite variant
            let targetTheme;
            if (currentTheme.endsWith('-light')) {
                targetTheme = currentTheme.replace('-light', '-dark');
            } else if (currentTheme.endsWith('-dark')) {
                targetTheme = currentTheme.replace('-dark', '-light');
            }
            
            // Apply the new theme if it exists
            if (targetTheme && this.themes[targetTheme]) {
                this.setTheme(targetTheme);
                
                // Update dropdown
                const dropdown = document.getElementById('theme-dropdown');
                if (dropdown) {
                    dropdown.value = targetTheme;
                }
                
                console.log(` Variant toggled: ${this.themes[targetTheme].name} ${this.themes[targetTheme].variant}`);
            }
        });
        
        // Update toggle visibility based on current theme
        this.updateToggleVisibility();
    }
    
    updateToggleVisibility() {
        const toggle = document.getElementById('theme-variant-toggle');
        if (!toggle) return;
        
        const hasVariant = this.themes[this.currentTheme]?.variant;
        toggle.style.display = hasVariant ? 'block' : 'none';
        
        // Update icon based on current variant
        if (hasVariant) {
            const isLight = this.currentTheme.endsWith('-light');
            toggle.textContent = isLight ? '' : '';
            toggle.title = isLight ? 'Switch to Dark Variant' : 'Switch to Light Variant';
        }
    }
}

// Initialize theme manager globally
window.themeManager = new ThemeManager();

 const ADMIN_UIDS = ["WxSPmEildJdqs6T5hIpBUZrscwt2", "BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2"];
let saveTimeout;
let functions; // Declare functions globally

 document.addEventListener('DOMContentLoaded', async () => {
console.log(' DOMContentLoaded fired - starting app initialization');

//  Load Diamond-Level Cache System
const cacheScript = document.createElement('script');
cacheScript.src = 'gameStateCache.js';
document.head.appendChild(cacheScript);

await new Promise(resolve => {
    cacheScript.onload = resolve;
});
 
 // --- DATA & TIME LOGIC WITH DIAMOND CACHING  ---
 async function getGamesForWeek(weekNumber) {
 //  Use diamond-level caching for schedule data!
 return await window.gameStateCache.cacheSchedule(weekNumber, async () => {
 try {
 console.log(` Fetching schedule for week ${weekNumber} (cache miss)`);
 const response = await fetch(`nfl_2025_week_${weekNumber}.json`);
 if (!response.ok) {
 throw new Error(`Failed to fetch schedule for week ${weekNumber}: ${response.status}`);
 }
 const weekData = await response.json();
 let games = Array.isArray(weekData.games) ? weekData.games.map(game => ({
 id: game.id,
 away: game.a,
 home: game.h,
 kickoff: game.dt.slice(0, -1),
 stadium: game.stadium
 })) : [];
 
 //  CRITICAL FIX: Merge in game results from Firestore
 try {
   const resultsDoc = await getDoc(doc(db, resultsPath(weekNumber)));
   if (resultsDoc.exists()) {
     const results = resultsDoc.data();
     games = games.map(game => ({
       ...game,
       winner: results[game.id]?.winner || results[game.id] || undefined
     }));
   }
 } catch (error) {
   console.warn(`Failed to load results for Week ${weekNumber}:`, error);
 }
 
 return games;
 } catch (error) {
 console.error(`Error fetching games for week ${weekNumber}:`, error);
 return [];
 }
 });
 }

 function getCurrentNflWeek() {
 const seasonStartDate = new Date('2025-09-04T00:00:00Z');
 const now = new Date();
 
 if (now < seasonStartDate) {
 return 1;
 }

 const diffTime = Math.abs(now - seasonStartDate);
 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
 const week = Math.ceil(diffDays / 7);

 return week > 18 ? 18 : week;
 }

 // --- UI ELEMENTS ---
 const allUI = {
 loadingView: document.getElementById('loading-view'), loginView: document.getElementById('login-view'), appView: document.getElementById('app-view'),
 loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
 showRegisterLink: document.getElementById('show-register-link'), showLoginLink: document.getElementById('show-login-link'),
 loginError: document.getElementById('login-error'), registerError: document.getElementById('register-error'),
 googleSigninBtn: document.getElementById('google-signin-btn'), googleSignupBtn: document.getElementById('google-signup-btn'),
 accountLinkingModal: document.getElementById('account-linking-modal'),
 linkingEmail: document.getElementById('linking-email'),
 cancelLinkingBtn: document.getElementById('cancel-linking-btn'), confirmLinkingBtn: document.getElementById('confirm-linking-btn'),
 passwordLinkingModal: document.getElementById('password-linking-modal'),
 passwordPromptEmail: document.getElementById('password-prompt-email'),
 passwordPromptInput: document.getElementById('password-prompt-input'),
 passwordPromptError: document.getElementById('password-prompt-error'),
 cancelPasswordPromptBtn: document.getElementById('cancel-password-prompt-btn'),
 confirmPasswordPromptBtn: document.getElementById('confirm-password-prompt-btn'),
 logoutBtn: document.getElementById('logout-btn'), userDisplay: document.getElementById('user-display'),
 menuAdminControls: document.getElementById('menu-admin-controls'),
 picksContainer: document.getElementById('picks-container'), adminContainer: document.getElementById('admin-container'), rulesContainer: document.getElementById('rules-container'),
 picksViewBtn: document.getElementById('menu-picks-view-btn'),
 adminViewBtn: document.getElementById('menu-admin-view-btn'),
 survivorAdminBtn: document.getElementById('survivor-admin-btn'),
 userDiagnosticBtn: document.getElementById('user-diagnostic-btn'),
 leaderboardViewBtn: document.getElementById('leaderboard-view-btn'),
 gridViewBtn: document.getElementById('grid-view-btn'), survivorPicksViewBtn: document.getElementById('survivor-picks-view-btn'), closeRulesBtn: document.getElementById('close-rules-btn'), rulesUserName: document.getElementById('rules-user-name'),
 prevWeekBtn: document.getElementById('prev-week-btn'), nextWeekBtn: document.getElementById('next-week-btn'), weekDisplay: document.getElementById('week-display'), adminWeekSelector: document.getElementById('admin-week-selector'),
 gameList: document.getElementById('game-list'), resultsGameList: document.getElementById('results-game-list'),
 saveResultsBtn: document.getElementById('save-results-btn'),
 refreshSummaryBtn: document.getElementById('refresh-summary-btn'),
 leaderboardLoader: document.getElementById('leaderboard-loader'), leaderboardBody: document.getElementById('leaderboard-body'),
 saveStatusIcon: document.getElementById('save-status-icon'), saveStatusText: document.getElementById('save-status-text'),
 resetPicksBtn: document.getElementById('reset-picks-btn'),
 topSavePicksBtn: document.getElementById('top-save-picks-btn'),
 adminTabs: document.querySelectorAll('.admin-tab'), adminContentSections: document.querySelectorAll('.admin-content-section'),
 userMgmtBody: document.getElementById('user-mgmt-body'),
 cleanupDuplicatesBtn: document.getElementById('cleanup-duplicates-btn'),
 playerIconsGrid: document.getElementById('player-icons-grid'),
 userPicksEditor: document.getElementById('user-picks-editor'),
 selectedUserName: document.getElementById('selected-user-name'),
 editPermissionStatus: document.getElementById('edit-permission-status'),
 adminPicksWeekNumber: document.getElementById('admin-picks-week-number'),
 userPicksGameList: document.getElementById('user-picks-game-list'),
 saveUserPicksBtn: document.getElementById('save-user-picks-btn'),
 cancelUserPicksBtn: document.getElementById('cancel-user-picks-btn'),
 validateAllPicksBtn: document.getElementById('validate-all-picks-btn'),
 clearValidationAlertsBtn: document.getElementById('clear-validation-alerts-btn'),
 validationResults: document.getElementById('validation-results'),
 survivorPickEditor: document.getElementById('survivor-pick-editor'),
 survivorEditorWeek: document.getElementById('survivor-editor-week'),
 survivorEditorUserName: document.getElementById('survivor-editor-user-name'),
 survivorTeamSelector: document.getElementById('survivor-team-selector'),
 saveSurvivorPickBtn: document.getElementById('save-survivor-pick-btn'),
 cancelSurvivorPickBtn: document.getElementById('cancel-survivor-pick-btn'),
 clearSurvivorPickBtn: document.getElementById('clear-survivor-pick-btn'),
 settingsBtn: document.getElementById('settings-btn'),
 settingsModal: document.getElementById('settings-modal'),
 closeSettingsBtn: document.getElementById('close-settings-btn'),
 settingsForm: document.getElementById('settings-form'),
 settingsDisplayName: document.getElementById('settings-display-name'),
 settingsEmail: document.getElementById('settings-email'),
 settingsError: document.getElementById('settings-error'),
 settingsSuccess: document.getElementById('settings-success'),
 googleNotLinked: document.getElementById('google-not-linked'),
 googleLinked: document.getElementById('google-linked'),
 linkGoogleBtn: document.getElementById('link-google-btn'),
 unlinkGoogleBtn: document.getElementById('unlink-google-btn'),
 notificationSettingsSection: document.getElementById('notification-settings-section'),
 notificationStatus: document.getElementById('notification-status'),
 notificationPreferences: document.getElementById('notification-preferences'),
 emailVerificationStatus: document.getElementById('email-verification-status'),
 pendingEmail: document.getElementById('pending-email'),
 emailChangeStatus: document.getElementById('email-change-status'),
 resendVerificationBtn: document.getElementById('resend-verification-btn'),
 tryDifferentMethodBtn: document.getElementById('try-different-method-btn'),
 passwordReauthSection: document.getElementById('password-reauth-section'),
 reauthPassword: document.getElementById('reauth-password'),
 confirmEmailChangeBtn: document.getElementById('confirm-email-change-btn'),
 cancelEmailChangeBtn: document.getElementById('cancel-email-change-btn'),
 adminWeekTitle: document.getElementById('admin-week-title'),
 resetWinnersBtn: document.getElementById('reset-winners-btn'),
 survivorStatusBody: document.getElementById('survivor-status-body'),
messageRecipients: document.getElementById('message-recipients'),
customUsersSection: document.getElementById('custom-users-section'),
customUsersList: document.getElementById('custom-users-list'),
messageSubject: document.getElementById('message-subject'),
messageBody: document.getElementById('message-body'),
messagePreviewSection: document.getElementById('message-preview-section'),
messagePreview: document.getElementById('message-preview'),
recipientCountNumber: document.getElementById('recipient-count-number'),
previewMessageBtn: document.getElementById('preview-message-btn'),
sendMessageBtn: document.getElementById('send-message-btn'),
messageStatus: document.getElementById('message-status'),
messageStatusContent: document.getElementById('message-status-content'),
 menuBtn: document.getElementById('menu-btn'),
 menuPanel: document.getElementById('menu-panel'),
 leaderboardContainer: document.getElementById('leaderboard-container'),
 lbWeeklyBtn: document.getElementById('lb-weekly-btn'),
 lbSeasonBtn: document.getElementById('lb-season-btn'),
 lbWeekSelectorContainer: document.getElementById('lb-week-selector-container'),
 lbWeekSelector: document.getElementById('lb-week-selector'),
 publicLeaderboardLoader: document.getElementById('public-leaderboard-loader'),
 publicLeaderboardBody: document.getElementById('public-leaderboard-body'),
 picksSummaryContainer: document.getElementById('picks-summary-container'),
 activePicksSection: document.getElementById('active-picks-section'),
 activePicksList: document.getElementById('active-picks-list'),
 yearlyLeaderboardSection: document.getElementById('yearly-leaderboard-section'),
 yearlyLeaderboardLoader: document.getElementById('yearly-leaderboard-loader'),
 yearlyLeaderboardContent: document.getElementById('yearly-leaderboard-content'),
// Pool Switcher Elements
poolSwitcherBtn: document.getElementById('pool-switcher-btn'),
poolSwitcherDropdown: document.getElementById('pool-switcher-dropdown'),
currentPoolName: document.getElementById('current-pool-name'),
userPoolsList: document.getElementById('user-pools-list'),
createPoolBtn: document.getElementById('create-pool-btn'),
joinPoolBtn: document.getElementById('join-pool-btn'),
// Pool Creation Modal Elements
poolCreationModal: document.getElementById('pool-creation-modal'),
closePoolCreationBtn: document.getElementById('close-pool-creation-btn'),
poolCreationForm: document.getElementById('pool-creation-form'),
prevStepBtn: document.getElementById('prev-step-btn'),
nextStepBtn: document.getElementById('next-step-btn'),
cancelPoolBtn: document.getElementById('cancel-pool-btn'),
createPoolSubmitBtn: document.getElementById('create-pool-submit-btn'),
createPoolBtnText: document.getElementById('create-pool-btn-text'),
createPoolSpinner: document.getElementById('create-pool-spinner'),
poolCreationError: document.getElementById('pool-creation-error'),
poolCreationErrorMessage: document.getElementById('pool-creation-error-message'),
// Pool Management Elements
editPoolSettingsBtn: document.getElementById('edit-pool-settings-btn'),
generateInviteBtn: document.getElementById('generate-invite-btn'),
memberCount: document.getElementById('member-count'),
activePicksCount: document.getElementById('active-picks-count'),
poolStatus: document.getElementById('pool-status'),
currentPoolNameDisplay: document.getElementById('current-pool-name'),
currentPoolType: document.getElementById('current-pool-type'),
currentJoinMethod: document.getElementById('current-join-method'),
currentMaxMembers: document.getElementById('current-max-members'),
poolCreatedDate: document.getElementById('pool-created-date'),
poolCreator: document.getElementById('pool-creator'),
currentPoolDescription: document.getElementById('current-pool-description'),
poolMembersTbody: document.getElementById('pool-members-tbody'),
inviteMemberBtn: document.getElementById('invite-member-btn'),
createInviteLinkBtn: document.getElementById('create-invite-link-btn'),
inviteLinksContainer: document.getElementById('invite-links-container'),
archivePoolBtn: document.getElementById('archive-pool-btn'),
deletePoolBtn: document.getElementById('delete-pool-btn'),
// Add Users to Pool Elements
addUsersPoolName: document.getElementById('add-users-pool-name'),
recentUsersList: document.getElementById('recent-users-list'),
recentUsersLoading: document.getElementById('recent-users-loading'),
userSearchInput: document.getElementById('user-search-input'),
searchLoading: document.getElementById('search-loading'),
searchResultsList: document.getElementById('search-results-list'),
addUserModal: document.getElementById('add-user-modal'),
closeAddUserModal: document.getElementById('close-add-user-modal'),
modalUserAvatar: document.getElementById('modal-user-avatar'),
modalUserName: document.getElementById('modal-user-name'),
modalUserEmail: document.getElementById('modal-user-email'),
cancelAddUser: document.getElementById('cancel-add-user'),
confirmAddUser: document.getElementById('confirm-add-user'),
addUserBtnText: document.getElementById('add-user-btn-text'),
addUserLoading: document.getElementById('add-user-loading'),
// Pool Discovery Elements
discoverPoolsBtn: document.getElementById('discover-pools-btn'),
poolDiscoveryModal: document.getElementById('pool-discovery-modal'),
closePoolDiscoveryBtn: document.getElementById('close-pool-discovery-btn'),
poolSearch: document.getElementById('pool-search'),
poolTypeFilter: document.getElementById('pool-type-filter'),
activeFilters: document.getElementById('active-filters'),
filterTags: document.getElementById('filter-tags'),
poolsLoading: document.getElementById('pools-loading'),
poolsEmpty: document.getElementById('pools-empty'),
poolsResults: document.getElementById('pools-results'),
poolsPagination: document.getElementById('pools-pagination'),
prevPage: document.getElementById('prev-page'),
nextPage: document.getElementById('next-page'),
pageInfo: document.getElementById('page-info'),
poolsError: document.getElementById('pools-error'),
poolsErrorMessage: document.getElementById('pools-error-message'),
// Migration Elements
adminMigrationBtn: document.getElementById('admin-migration-btn'),
migrationToolBtn: document.getElementById('migration-tool-btn'),
migrationModal: document.getElementById('migration-modal'),
closeMigrationBtn: document.getElementById('close-migration-btn'),
closeMigrationBtn2: document.getElementById('close-migration-btn-2'),
migrationProgressSection: document.getElementById('migration-progress-section'),
migrationProgressBar: document.getElementById('migration-progress-bar'),
migrationProgressText: document.getElementById('migration-progress-text'),
migrationLogDisplay: document.getElementById('migration-log-display'),
migrationControlsSection: document.getElementById('migration-controls-section'),
startMigrationBtn: document.getElementById('start-migration-btn'),
dryRunMigrationBtn: document.getElementById('dry-run-migration-btn'),
migrationResultsSection: document.getElementById('migration-results-section'),
migrationResultsContent: document.getElementById('migration-results-content'),
// Grid Elements
gridContainer: document.getElementById('grid-container'),
gridWeekSelector: document.getElementById('grid-week-selector'),
gridTableContainer: document.getElementById('grid-table-container'),
gridTableLoader: document.getElementById('grid-table-loader'),
gridTableContent: document.getElementById('grid-table-content'),
gridYearlyLeaderboardLink: document.getElementById('grid-yearly-leaderboard-link'),
survivorContainer: document.getElementById('survivor-container'),
survivorPicksContainer: document.getElementById('survivor-picks-container'),
survivorLoadingContainer: document.getElementById('survivor-loading-container'),
survivorErrorContainer: document.getElementById('survivor-error-container'),
survivorErrorMessage: document.getElementById('survivor-error-message'),
survivorRetryBtn: document.getElementById('survivor-retry-btn'),
survivorResultsContainer: document.getElementById('survivor-results-container'),
survivorNoResults: document.getElementById('survivor-no-results'),
survivorResultsTbody: document.getElementById('survivor-results-tbody'),
survivorTotalPlayers: document.getElementById('survivor-total-players'),
survivorActivePlayers: document.getElementById('survivor-active-players'),
survivorEliminatedPlayers: document.getElementById('survivor-eliminated-players'),
survivorCurrentWeek: document.getElementById('survivor-current-week')
 };

 // --- APP STATE ---
 let currentWeek = 1, currentUser = null, db, auth, unsubscribeFromPicks = null, saveTimeout = null, activePicks = {};
 let currentAdminPicks = {}, allUsers = [];

 // --- NFL TEAM DATA ---
 const nflTeamLogos = {
  'ARI': 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png',
  'ATL': 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png',
  'BAL': 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png',
  'BUF': 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png',
  'CAR': 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png',
  'CHI': 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png',
  'CIN': 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png',
  'CLE': 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png',
  'DAL': 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png',
  'DEN': 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png',
  'DET': 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png',
  'GB': 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png',
  'HOU': 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png',
  'IND': 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png',
  'JAX': 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png',
  'KC': 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png',
  'LV': 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png',
  'LAC': 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png',
  'LAR': 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png',
  'MIA': 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png',
  'MIN': 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png',
  'NE': 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png',
  'NO': 'https://a.espncdn.com/i/teamlogos/nfl/500/no.png',
  'NYG': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png',
  'NYJ': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png',
  'PHI': 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png',
  'PIT': 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png',
  'SF': 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png',
  'SEA': 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png',
  'TB': 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png',
  'TEN': 'https://a.espncdn.com/i/teamlogos/nfl/500/ten.png',
  'WAS': 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png'
 };

 // Map full team names to abbreviations for logo lookup
 const teamNameToAbbr = {
  'Arizona Cardinals': 'ARI',
  'Atlanta Falcons': 'ATL',
  'Baltimore Ravens': 'BAL',
  'Buffalo Bills': 'BUF',
  'Carolina Panthers': 'CAR',
  'Chicago Bears': 'CHI',
  'Cincinnati Bengals': 'CIN',
  'Cleveland Browns': 'CLE',
  'Dallas Cowboys': 'DAL',
  'Denver Broncos': 'DEN',
  'Detroit Lions': 'DET',
  'Green Bay Packers': 'GB',
  'Houston Texans': 'HOU',
  'Indianapolis Colts': 'IND',
  'Jacksonville Jaguars': 'JAX',
  'Kansas City Chiefs': 'KC',
  'Las Vegas Raiders': 'LV',
  'Los Angeles Chargers': 'LAC',
  'Los Angeles Rams': 'LAR',
  'Miami Dolphins': 'MIA',
  'Minnesota Vikings': 'MIN',
  'New England Patriots': 'NE',
  'New Orleans Saints': 'NO',
  'New York Giants': 'NYG',
  'New York Jets': 'NYJ',
  'Philadelphia Eagles': 'PHI',
  'Pittsburgh Steelers': 'PIT',
  'San Francisco 49ers': 'SF',
  'Seattle Seahawks': 'SEA',
  'Tampa Bay Buccaneers': 'TB',
  'Tennessee Titans': 'TEN',
  'Washington Commanders': 'WAS'
 };

 // --- GRID VIEW SPECIFIC DATA ---
 const GridView = {
  currentSortField: 'place',
  currentSortDirection: 'asc',
  cachedUserScores: [],
  
  // Team abbreviations for the grid
  TEAM_ABBREVIATIONS: {
    "Arizona Cardinals": "ARI", "Atlanta Falcons": "ATL", "Baltimore Ravens": "BAL", "Buffalo Bills": "BUF", 
    "Carolina Panthers": "CAR", "Chicago Bears": "CHI", "Cincinnati Bengals": "CIN", "Cleveland Browns": "CLE", 
    "Dallas Cowboys": "DAL", "Denver Broncos": "DEN", "Detroit Lions": "DET", "Green Bay Packers": "GB", 
    "Houston Texans": "HOU", "Indianapolis Colts": "IND", "Jacksonville Jaguars": "JAX", "Kansas City Chiefs": "KC", 
    "Las Vegas Raiders": "LV", "Los Angeles Chargers": "LAC", "Los Angeles Rams": "LAR", "Miami Dolphins": "MIA", 
    "Minnesota Vikings": "MIN", "New England Patriots": "NE", "New Orleans Saints": "NO", "New York Giants": "NYG", 
    "New York Jets": "NYJ", "Philadelphia Eagles": "PHI", "Pittsburgh Steelers": "PIT", "San Francisco 49ers": "SF", 
    "Seattle Seahawks": "SEA", "Tampa Bay Buccaneers": "TB", "Tennessee Titans": "TEN", "Washington Commanders": "WAS"
  },

  // Helper function to get helmet CSS class from team name
  getHelmetClass(teamName) {
    const teamMap = {
      "Arizona Cardinals": "helmet-ari", "Atlanta Falcons": "helmet-atl", "Baltimore Ravens": "helmet-bal", 
      "Buffalo Bills": "helmet-buf", "Carolina Panthers": "helmet-car", "Chicago Bears": "helmet-chi", 
      "Cincinnati Bengals": "helmet-cin", "Cleveland Browns": "helmet-cle", "Dallas Cowboys": "helmet-dal", 
      "Denver Broncos": "helmet-den", "Detroit Lions": "helmet-det", "Green Bay Packers": "helmet-gb", 
      "Houston Texans": "helmet-hou", "Indianapolis Colts": "helmet-ind", "Jacksonville Jaguars": "helmet-jax", 
      "Kansas City Chiefs": "helmet-kc", "Las Vegas Raiders": "helmet-lv", "Los Angeles Chargers": "helmet-lac", 
      "Los Angeles Rams": "helmet-lar", "Miami Dolphins": "helmet-mia", "Minnesota Vikings": "helmet-min", 
      "New England Patriots": "helmet-ne", "New Orleans Saints": "helmet-no", "New York Giants": "helmet-nyg", 
      "New York Jets": "helmet-nyj", "Philadelphia Eagles": "helmet-phi", "Pittsburgh Steelers": "helmet-pit", 
      "San Francisco 49ers": "helmet-sf", "Seattle Seahawks": "helmet-sea", "Tampa Bay Buccaneers": "helmet-tb", 
      "Tennessee Titans": "helmet-ten", "Washington Commanders": "helmet-was"
    };
    return teamMap[teamName] || "";
  },

  // Helper function to extract winner from game result (handles both old and new formats)
  getGameWinner(gameResult) {
    if (!gameResult) return null;
    if (typeof gameResult === 'string') return gameResult;
    if (typeof gameResult === 'object' && gameResult.winner) return gameResult.winner;
    return null;
  }
 };

 // --- FIREBASE OPTIMIZATION ---
 const firebaseCache = {
  users: { data: null, timestamp: 0, ttl: 900000 }, // 15 minutes (was 5)
  leaderboard: { data: null, timestamp: 0, ttl: 300000 }, // 5 minutes (was 1)
  gameResults: new Map(), // Cache by week
  userPicks: new Map() // Cache by week-userId
 };

 // Cache helper functions
 function isCacheValid(cache) {
  return cache.data !== null && (Date.now() - cache.timestamp) < cache.ttl;
 }

 function setCacheData(cache, data) {
  cache.data = data;
  cache.timestamp = Date.now();
  // Update indicator when new data is cached
  updateCacheStatusIndicator('current');
 }

 // Optimized user fetching with cache
 async function getCachedUsers() {
  //  Diamond-level user caching with fallback to existing cache
  return await window.gameStateCache.cacheUsers(async () => {
    if (isCacheValid(firebaseCache.users)) {
     console.log(' Using existing Firebase user cache');
     return firebaseCache.users.data;
    }
    
    console.log(' Fetching users from Firestore (cache miss)');
    const usersSnap = await getDocs(collection(db, usersPath()));
    const users = {};
    usersSnap.forEach(doc => users[doc.id] = doc.data());
    
    setCacheData(firebaseCache.users, users);
    return users;
  });
 }

 //  DIAMOND STANDARD: Get pool members - single source of truth for ALL user displays
 //  CRITICAL FIX: Added fallback to legacy users to match Grid behavior
 async function getPoolMembersAsUsers() {
  try {
   const poolId = getCurrentPool();
   const poolMembersRef = doc(db, getPoolMembersPath(poolId));
   const poolMembersSnap = await getDoc(poolMembersRef);
   
   if (poolMembersSnap.exists()) {
    const members = poolMembersSnap.data();
    const users = {};
    
    // Convert pool members format to standard users format
    // ONLY include users who are in the confidence pool
    for (const [uid, memberData] of Object.entries(members)) {
     // Check participation - only include users in confidence pool
     const participation = memberData.participation || { confidence: { enabled: true } };
     if (!participation.confidence?.enabled) {
      console.log(` Filtering out ${memberData.displayName} - not in confidence pool`);
      continue;
     }
     
     users[uid] = {
      uid: uid,
      id: uid,
      displayName: memberData.displayName || memberData.email || 'Unknown',
      email: memberData.email || '',
      role: memberData.role || 'member',
      joinedAt: memberData.joinedAt,
      ...memberData
     };
    }
    
    console.log(` DIAMOND: Loaded ${Object.keys(users).length} users from pool members`);
    return users;
   } else {
    console.warn(' Pool members document does not exist, falling back to legacy users');
    throw new Error('Pool members not found - triggering fallback');
   }
  } catch (error) {
   console.warn(' Pool members not found, falling back to legacy users with ghost blocking:', error.message);
   
   //  FALLBACK: Use same logic as Grid (lines 586-603 in nerdfootballTheGrid.html)
   try {
    const usersCollectionPath = `artifacts/${appId()}/public/data/nerdfootball_users`;
    console.log(' Leaderboard: Fetching users from LEGACY path:', usersCollectionPath);
    const usersSnap = await getDocs(collection(db, usersCollectionPath));
    console.log(' Leaderboard: Users snapshot size:', usersSnap.size);
    
    const users = {};
    const seenNames = new Set(); // Track display names to prevent ghosts
    
    usersSnap.forEach(doc => {
     // IMMEDIATE GHOST BLOCKING - same as Grid
     if (doc.id === 'okl4sw2aDhW3yKpOfOwe5lH7OQj1') {
      console.log(' GHOST USER BLOCKED FROM LEADERBOARD LEGACY:', doc.id);
      return;
     }
     
     const userData = { id: doc.id, uid: doc.id, ...doc.data() };
     // Deduplicate by both ID and display name
     const displayName = userData.displayName || userData.email || doc.id;
     if (!users[doc.id] && !seenNames.has(displayName)) {
      users[doc.id] = userData;
      seenNames.add(displayName);
      console.log(' Leaderboard: Added legacy user:', userData.displayName || userData.email, doc.id);
     }
    });
    
    console.log(` FALLBACK SUCCESS: Leaderboard using legacy users (${Object.keys(users).length} users)`);
    return users;
   } catch (fallbackError) {
    console.error(' Both pool members and legacy users failed:', fallbackError);
    return {};
   }
  }
 }

 // Legacy function - now redirects to pool members
 async function getCleanUsers() {
  //  DIAMOND STANDARD: All user displays now use pool members
  return await getPoolMembersAsUsers();
 }

 // Legacy function - now redirects to pool members  
 async function getCachedUsers() {
  //  DIAMOND STANDARD: All user displays now use pool members
  return await getPoolMembersAsUsers();
 }

 //  DIAMOND STANDARD: getAllUsers now uses pool members
 async function getAllUsers() {
  return await getPoolMembersAsUsers();
 }

 //  DIAMOND STANDARD: fetchAllUsers now uses pool members  
 async function fetchAllUsers() {
  const users = await getPoolMembersAsUsers();
  // Convert to array format that some functions expect
  return Object.keys(users).map(uid => ({
   id: uid,
   ...users[uid]
  }));
 }

 // Batch Firebase operations to reduce round-trips
 async function batchGetDocs(queries) {
  return Promise.all(queries.map(query => getDocs(query)));
 }

 // Cache invalidation
 function invalidateCache(cacheKey) {
  if (firebaseCache[cacheKey]) {
   firebaseCache[cacheKey].data = null;
   firebaseCache[cacheKey].timestamp = 0;
  }
  // Update visual indicator when cache is invalidated
  updateCacheStatusIndicator('stale');
 }

 // Invalidate all caches
 function invalidateAllCaches() {
  Object.keys(firebaseCache).forEach(key => {
   if (firebaseCache[key] && typeof firebaseCache[key] === 'object' && firebaseCache[key].data !== undefined) {
    firebaseCache[key].data = null;
    firebaseCache[key].timestamp = 0;
   }
  });
 }

// Cache Status Indicator Management
function updateCacheStatusIndicator(status) {
  const glyph = document.getElementById('cache-status-glyph');
  const tooltip = document.getElementById('cache-status-tooltip');
  
  if (!glyph || !tooltip) return;
  
  // Remove all status classes
  glyph.classList.remove('current', 'stale', 'refreshing', 'outdated');
  
  // Apply new status
  switch(status) {
    case 'current':
      glyph.classList.add('current');
      tooltip.textContent = 'Cache is current';
      break;
    case 'stale':
      glyph.classList.add('stale');
      tooltip.textContent = 'Cache is stale - refresh recommended';
      break;
    case 'refreshing':
      glyph.classList.add('refreshing');
      tooltip.textContent = 'Refreshing cache...';
      break;
    case 'outdated':
      glyph.classList.add('outdated');
      tooltip.textContent = 'Cache is outdated - refresh required';
      break;
    default:
      glyph.classList.add('current');
      tooltip.textContent = 'Cache status unknown';
  }
}

// Track if we're already auto-fetching to prevent loops
let isAutoFetching = false;

// Monitor cache state and auto-update indicator
async function monitorCacheStatus() {
  // Check if any cache is valid
  const hasValidCache = Object.keys(firebaseCache).some(key => {
    const cache = firebaseCache[key];
    return cache && cache.data !== null && (Date.now() - cache.timestamp) < cache.ttl;
  });
  
  // Check if any cache is stale (data exists but TTL expired)
  const hasStaleCache = Object.keys(firebaseCache).some(key => {
    const cache = firebaseCache[key];
    return cache && cache.data !== null && (Date.now() - cache.timestamp) >= cache.ttl;
  });
  
  // Check if we have no data at all
  const hasNoData = !hasValidCache && !hasStaleCache;
  
  if (hasValidCache) {
    updateCacheStatusIndicator('current');
    isAutoFetching = false;
  } else if (hasStaleCache) {
    // Data exists but is old - show yellow
    updateCacheStatusIndicator('stale');
    
    // Auto-refresh stale data in background (non-blocking)
    if (!isAutoFetching) {
      isAutoFetching = true;
      updateCacheStatusIndicator('refreshing');
      // Don't await - let it run in background
      refreshDataInBackground().then(() => {
        isAutoFetching = false;
      });
    }
  } else if (hasNoData) {
    // No data at all - only go gray if we're not already fetching
    if (!isAutoFetching) {
      // Instead of just showing gray, auto-fetch the data
      isAutoFetching = true;
      updateCacheStatusIndicator('refreshing');
      
      // Fetch current view's data
      refreshDataInBackground().then(() => {
        isAutoFetching = false;
      });
    }
  }
}

// Background data refresh without blocking UI
async function refreshDataInBackground() {
  try {
    // Get current view to know what data to refresh
    const params = getUrlParams();
    const view = params.view || 'picks';
    
    // Refresh appropriate data based on current view
    if (view === 'leaderboard') {
      // Just trigger a background leaderboard calculation
      const weekNumber = params.week || null;
      calculateLeaderboardOptimized(weekNumber).catch(console.error);
    } else if (view === 'survivor') {
      // Refresh survivor cache if available
      if (window.survivorCacheManager) {
        const currentPool = getCurrentPool();
        const currentWeek = window.currentWeek || 1;
        window.survivorCacheManager.warmCache(currentPool, currentWeek).catch(console.error);
      }
    }
    // For other views, the data will be fetched when needed
    
    // Reduced logging to prevent spam - only log on actual refresh actions
    if (view === 'leaderboard' || (view === 'survivor' && window.survivorCacheManager)) {
      console.log(' Background cache refresh initiated for', view);
    }
  } catch (error) {
    console.error('Background refresh error:', error);
  }
}

// Set up periodic cache monitoring - reduced frequency to prevent spam
setInterval(monitorCacheStatus, 60000); // Check every 60 seconds to reduce spam

// Initial check on page load
setTimeout(monitorCacheStatus, 2000); // Check 2 seconds after page load

// Game Update Indicator Management
function showGameUpdateIndicator() {
  const indicator = document.getElementById('game-update-indicator');
  if (!indicator) return;
  
  // Remove hidden and make visible
  indicator.classList.remove('hidden', 'opacity-0');
  
  // After 3 seconds, start fading out
  setTimeout(() => {
    indicator.classList.add('opacity-0');
    
    // After fade completes, hide it
    setTimeout(() => {
      indicator.classList.add('hidden');
    }, 500); // Match transition duration
  }, 3000); // Show for 3 seconds before fading
}

// Make it globally accessible for other modules
window.showGameUpdateIndicator = showGameUpdateIndicator;

 // --- VIEW MANAGEMENT UTILITIES ---
 function hideAllViews() {
    allUI.picksContainer.classList.add('hidden');
    allUI.picksSummaryContainer.classList.add('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    allUI.gridContainer.classList.add('hidden');
    allUI.survivorContainer.classList.add('hidden');
    allUI.survivorPicksContainer.classList.add('hidden');
    
    // Clear active state from all view toggle buttons
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
 }

 // --- STATE MANAGEMENT ---
 function saveAppState() {
  const state = {
   currentView: getCurrentView(),
   currentWeek: currentWeek,
   leaderboardView: allUI.lbSeasonBtn.classList.contains('active') ? 'season' : 'weekly'
  };
  localStorage.setItem('nerdfootballState', JSON.stringify(state));
  
  // DIAMOND FIX: Only update URL after initial load
  if (!isInitialLoad) {
    updateUrl();
  }
 }

 function loadAppState() {
  console.log(' loadAppState called');
  // Prioritize URL params over localStorage
  const urlParams = getUrlParams();
  const saved = localStorage.getItem('nerdfootballState');
  const savedState = saved ? JSON.parse(saved) : {};
  
  return {
   currentView: urlParams.view,
   currentWeek: urlParams.week,
   leaderboardView: urlParams.lb
  };
 }

 function getCurrentView() {
  if (allUI.adminContainer && !allUI.adminContainer.classList.contains('hidden')) return 'admin';
  if (allUI.leaderboardContainer && !allUI.leaderboardContainer.classList.contains('hidden')) return 'leaderboard';
  if (allUI.gridContainer && !allUI.gridContainer.classList.contains('hidden')) return 'grid';
  if (allUI.survivorPicksContainer && !allUI.survivorPicksContainer.classList.contains('hidden')) return 'survivor-picks';
  if (allUI.survivorContainer && !allUI.survivorContainer.classList.contains('hidden')) return 'survivor';
  if (allUI.rulesContainer && !allUI.rulesContainer.classList.contains('hidden')) return 'rules';
  return 'picks';
 }

 // --- URL ROUTING ---
 function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const result = {
   view: params.get('view') || 'picks',
   week: parseInt(params.get('week')) || getCurrentNflWeek(),
   lb: params.get('lb') || 'weekly',
   confidence: params.get('confidence') //  CONFIDENCE-ON-CRACK parameter
  };
  
  //  CONFIDENCE-ON-CRACK: Activate optimized system
  if (result.confidence === 'crack') {
    window.confidenceOnCrack = true;
    console.log(' CONFIDENCE-ON-CRACK MODE ACTIVATED: Ultra-high performance confidence system enabled');
  }
  
  console.log(' getUrlParams result:', result, 'from URL:', window.location.search);
  return result;
 }

 function updateUrl(usePushState = false) {
  // CRITICAL FIX: Don't update URL during initial page load
  console.log(' updateUrl called, isInitialLoad:', isInitialLoad, 'current URL:', window.location.search);
  if (isInitialLoad) {
   console.log(' Skipping URL update during initial load');
   return;
  }
  
  const currentView = getCurrentView();
  const isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
  
  // Preserve ALL existing parameters and only update specific ones
  const params = new URLSearchParams(window.location.search);
  
  // Update or remove view parameter
  if (currentView !== 'picks') {
   params.set('view', currentView);
  } else {
   params.delete('view');
  }
  
  // Update or remove week parameter  
  if (currentWeek !== getCurrentNflWeek()) {
   params.set('week', currentWeek);
  } else {
   params.delete('week');
  }
  
  // Update or remove leaderboard parameter
  if (currentView === 'leaderboard' && isSeasonView) {
   params.set('lb', 'season');
  } else if (currentView === 'leaderboard') {
   params.delete('lb');
  }
  
  // Preserve existing hash fragment
  const currentHash = window.location.hash;
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '') + currentHash;
  
  // Use pushState for user actions (breadcrumb navigation) or replaceState for automatic updates
  if (usePushState) {
   window.history.pushState({}, '', newUrl);
  } else {
   window.history.replaceState({}, '', newUrl);
  }
 }

 // --- GRID VIEW FUNCTIONS ---
 async function renderGrid() {
  try {
    console.log(' Grid renderGrid STARTED');
    
    if (!currentUser) {
        console.log(' No current user');
        allUI.gridTableContent.innerHTML = `<p class="text-center text-slate-600">Please log in to view The Grid.</p>`;
        return;
    }
    
    allUI.gridTableLoader.style.display = 'block';
    allUI.gridTableContent.innerHTML = '';
    
    const selectedWeek = allUI.gridWeekSelector.value || currentWeek;
    console.log(' Getting games for week', selectedWeek);
    
    const games = await getGamesForWeek(selectedWeek);
    console.log(' Got games:', games.length);

    const now = new Date();

    // Fetch all necessary data using existing cache system
    let gridData;
    try {
        console.log(` Grid: Fetching data for week ${selectedWeek}`);
        
        // Use pool members path (same as admin) instead of legacy users path
        const poolMembersDoc = await getDoc(doc(db, getPoolMembersPath(getCurrentPool())));
        let userMap = new Map();
        
        if (poolMembersDoc.exists()) {
            const members = poolMembersDoc.data();
            console.log(' Pool members found:', Object.keys(members).length);
            
            for (const [uid, memberData] of Object.entries(members)) {
                // Block ghost user
                if (uid === 'okl4sw2aDhW3yKpOfOwe5lH7OQj1') {
                    console.log(' GHOST USER BLOCKED FROM GRID:', uid);
                    continue;
                }
                
                // Check participation - only include users in confidence pool
                const participation = memberData.participation || { confidence: { enabled: true } };
                if (!participation.confidence?.enabled) {
                    console.log(` Skipping ${memberData.displayName} - not in confidence pool`);
                    continue;
                }
                
                userMap.set(uid, {
                    id: uid,
                    uid: uid,
                    displayName: memberData.displayName || memberData.email || 'Unknown',
                    email: memberData.email || '',
                    role: memberData.role || 'member',
                    ...memberData
                });
            }
        } else {
            // Fallback to users collection with ghost blocking
            const usersSnap = await getDocs(collection(db, usersPath()));
            usersSnap.forEach(doc => {
                if (doc.id === 'okl4sw2aDhW3yKpOfOwe5lH7OQj1') {
                    console.log(' GHOST USER BLOCKED FROM GRID FALLBACK:', doc.id);
                    return;
                }
                const userData = { id: doc.id, uid: doc.id, ...doc.data() };
                userMap.set(doc.id, userData);
            });
        }
        
        const allUsersForGrid = Array.from(userMap.values());

        // Fetch results
        const resultsDocRef = doc(db, resultsPath(selectedWeek));
        const resultsSnap = await getDoc(resultsDocRef);
        const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};

        // Fetch picks
        const picksCollectionRef = collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${selectedWeek}/submissions`);
        const picksSnap = await getDocs(picksCollectionRef);
        const allPicks = {};
        picksSnap.forEach(doc => {
            allPicks[doc.id] = doc.data();
        });
        
        gridData = { allUsers: allUsersForGrid, gameResults, allPicks };
    } catch (error) {
        console.error(' Grid data error:', error);
        allUI.gridTableContent.innerHTML = `<p class="text-red-600">Error loading grid: ${error.message}</p>`;
        return;
    }
    
    const { allUsers: allUsersForGrid, gameResults, allPicks } = gridData;
    
    console.log(' Grid users count:', allUsersForGrid.length);
    const userScores = allUsersForGrid.map(user => {
        let totalPoints = 0;
        let pointsLeft = 0;
        const userPicks = allPicks[user.id] || {};
        
        games.forEach(game => {
            const pick = userPicks[game.id];
            if (pick) {
                const confidence = pick.confidence != null ? parseInt(pick.confidence) : 0;
                
                if (gameResults[game.id]) {
                    if (pick.winner === GridView.getGameWinner(gameResults[game.id])) {
                        totalPoints += confidence;
                    }
                } else { 
                    pointsLeft += confidence;
                }
            }
        });

        return {
            ...user,
            totalPoints,
            pointsLeft,
            possibleTotal: totalPoints + pointsLeft,
            picks: userPicks
        };
    });
    
    GridView.cachedUserScores = userScores;
    applyGridSorting();
    
    let tableHTML = `<table class="min-w-full divide-y divide-gray-200 grid-table">`;
    tableHTML += `<thead class="bg-gray-50"><tr>`;
    tableHTML += `<th class="place-col sortable-header px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hover:bg-gray-100" onclick="sortGrid('place')">Place </th>`;
    tableHTML += `<th class="player-name sortable-header px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hover:bg-gray-100" onclick="sortGrid('player')">Player </th>`;
    tableHTML += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>`;
    tableHTML += `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Possible</th>`;
    games.forEach(game => {
        const awayAbbr = GridView.TEAM_ABBREVIATIONS[game.away] || game.away;
        const homeAbbr = GridView.TEAM_ABBREVIATIONS[game.home] || game.home;
        tableHTML += `<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">${awayAbbr}@${homeAbbr}</th>`;
    });
    tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

    GridView.cachedUserScores.forEach((user, userIndex) => {
        const isCurrentUser = user.uid === currentUser.uid;
        
        // Check for missing upcoming picks
        const upcomingGames = games.filter(game => {
            // Handle both raw JSON format (dt) and processed format (kickoff) - preserve UTC timezone
            const gameTimeString = game.kickoff || game.dt;
            const gameTime = new Date(gameTimeString);
            return now < gameTime;
        });
        
        const hasMissingUpcomingPicks = upcomingGames.some(game => 
            !user.picks[game.id] || !user.picks[game.id].winner
        );
        
        const shouldShowWarning = upcomingGames.length > 0 && hasMissingUpcomingPicks;
        
        const rowClass = isCurrentUser ? 'bg-blue-50 font-bold' : '';
        tableHTML += `<tr class="${rowClass}">`;
        tableHTML += `<td class="place-col px-3 py-2 text-sm font-bold text-center text-gray-700">${userIndex + 1}</td>`;
        
        let nameClass;
        if (isCurrentUser) {
            nameClass = 'font-bold text-blue-700';
        } else if (shouldShowWarning) {
            nameClass = 'font-bold text-red-600';
        } else {
            nameClass = 'font-medium text-gray-900';
        }
        
        tableHTML += `<td class="player-name px-3 py-2 text-sm ${nameClass}">${user.displayName}${isCurrentUser ? ' (You)' : ''}${shouldShowWarning && !isCurrentUser ? ' ' : ''}</td>`;
        
        const anyGameStarted = games.some(game => now >= new Date(game.kickoff));
        if (!anyGameStarted) {
            tableHTML += `<td class="px-3 py-2 text-sm font-bold text-gray-400">0</td>`;
            tableHTML += `<td class="px-3 py-2 text-sm text-gray-400">0</td>`;
        } else {
            tableHTML += `<td class="px-3 py-2 text-sm font-bold">${user.totalPoints}</td>`;
            tableHTML += `<td class="px-3 py-2 text-sm">${user.possibleTotal}</td>`;
        }
        
        games.forEach((game, gameIndex) => {
            const pick = user.picks[game.id];
            // Handle both raw JSON format (dt) and processed format (kickoff) - preserve UTC timezone
            const gameTimeString = game.kickoff || game.dt;
            const gameTime = new Date(gameTimeString);
            const gameStarted = now >= gameTime;
            
            let cellContent = '-';
            let cellClass = '';
            
            // Security: Only show picks if it's current user OR game has started
            if (!isCurrentUser && !gameStarted) {
                cellContent = `<div class="text-center text-gray-400 text-sm">-</div>`;
                cellClass = 'text-gray-400';
            } else if (!gameStarted && isCurrentUser) {
                // Show current user's own picks even before game starts
                if (pick && pick.winner) {
                    const helmetClass = GridView.getHelmetClass(pick.winner);
                    cellContent = `<div class="text-center">
                        <div class="flex justify-center mb-1">
                            <span class="grid-helmet-icon ${helmetClass}" title="${pick.winner}"></span>
                        </div>
                        <div class="text-xs text-gray-600">${pick.confidence !== undefined && pick.confidence !== null && pick.confidence !== '' ? pick.confidence : 0}</div>
                    </div>`;
                }
            } else if (gameStarted) {
                // Show ALL picks after game has started
                if (pick && pick.winner) {
                    const helmetClass = GridView.getHelmetClass(pick.winner);
                    cellContent = `<div class="text-center">
                        <div class="flex justify-center mb-1">
                            <span class="grid-helmet-icon ${helmetClass}" title="${pick.winner}"></span>
                        </div>
                        <div class="text-xs text-gray-600">${pick.confidence !== undefined && pick.confidence !== null && pick.confidence !== '' ? pick.confidence : 0}</div>
                    </div>`;
                    if(gameResults[game.id]){
                        const actualWinner = GridView.getGameWinner(gameResults[game.id]);
                        const isWin = pick.winner === actualWinner;
                        cellClass = isWin ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    }
                }
            }
            tableHTML += `<td class="px-2 py-2 ${cellClass} game-cell" data-game="${gameIndex}">${cellContent}</td>`;
        });
        tableHTML += `</tr>`;
    });

    tableHTML += `</tbody></table>`;
    
    allUI.gridTableLoader.style.display = 'none';
    allUI.gridTableContent.innerHTML = tableHTML;
    
    // Add column hover effects
    const gameCells = allUI.gridTableContent.querySelectorAll('.game-cell');
    gameCells.forEach(cell => {
        cell.addEventListener('mouseenter', () => {
            const gameIndex = cell.dataset.game;
            const allCellsInColumn = allUI.gridTableContent.querySelectorAll(`.game-cell[data-game="${gameIndex}"]`);
            allCellsInColumn.forEach(c => c.classList.add('highlight-column'));
        });
        
        cell.addEventListener('mouseleave', () => {
            const gameIndex = cell.dataset.game;
            const allCellsInColumn = allUI.gridTableContent.querySelectorAll(`.game-cell[data-game="${gameIndex}"]`);
            allCellsInColumn.forEach(c => c.classList.remove('highlight-column'));
        });
    });
    
    console.log(' Grid renderGrid COMPLETED SUCCESSFULLY');
  } catch (error) {
    console.error(' CRITICAL ERROR in renderGrid:', error);
    allUI.gridTableLoader.style.display = 'none';
    allUI.gridTableContent.innerHTML = `<p class="text-red-600">Error loading grid: ${error.message}</p>`;
  }
 }

 function applyGridSorting() {
  const currentUserIndex = GridView.cachedUserScores.findIndex(u => u.uid === currentUser?.uid);
  let currentUserData = null;
  let otherUsers = [...GridView.cachedUserScores];
  
  if (currentUserIndex !== -1) {
    currentUserData = otherUsers.splice(currentUserIndex, 1)[0];
  }
  
  if (GridView.currentSortField === 'place') {
    otherUsers.sort((a, b) => {
      if (GridView.currentSortDirection === 'asc') {
        return b.totalPoints - a.totalPoints;
      } else {
        return a.totalPoints - b.totalPoints;
      }
    });
  } else if (GridView.currentSortField === 'player') {
    otherUsers.sort((a, b) => {
      const nameA = (a.displayName || '').toLowerCase();
      const nameB = (b.displayName || '').toLowerCase();
      if (GridView.currentSortDirection === 'asc') {
        return nameA.localeCompare(nameB);
      } else {
        return nameB.localeCompare(nameA);
      }
    });
  }
  
  if (currentUserData) {
    GridView.cachedUserScores = [currentUserData, ...otherUsers];
  } else {
    GridView.cachedUserScores = otherUsers;
  }
 }

 function populateGridWeekSelectors() {
  const options = Array.from({ length: 18 }, (_, i) => `<option value="${i + 1}">Week ${i + 1}</option>`).join('');
  allUI.gridWeekSelector.innerHTML = options;
  allUI.gridWeekSelector.value = currentWeek;
 }

 // Global function for sorting (called from HTML onclick)
 window.sortGrid = function(field) {
  if (GridView.currentSortField === field) {
    GridView.currentSortDirection = GridView.currentSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    GridView.currentSortField = field;
    GridView.currentSortDirection = 'asc';
  }
  
  applyGridSorting();
  renderGrid();
 }

 // --- ADMIN LOGIC ---
 async function fetchAllUsers() {
 const users = await getCachedUsers();
 const rawUsers = [];
 Object.keys(users).forEach(id => {
  rawUsers.push({ id: id, ...users[id] });
 });
 
 // Handle duplicate email addresses - keep only the preferred UID
 const emailMap = new Map();
 const preferredUIDs = new Set(['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2']);
 
 rawUsers.forEach(user => {
  if (!user.email) return;
  
  const existing = emailMap.get(user.email);
  if (!existing) {
   emailMap.set(user.email, user);
  } else {
   // If current user has preferred UID, replace existing
   if (preferredUIDs.has(user.id)) {
    emailMap.set(user.email, user);
   } else if (!preferredUIDs.has(existing.id)) {
    // Neither has preferred UID, keep the most recently updated
    if (user.lastUpdated && (!existing.lastUpdated || user.lastUpdated > existing.lastUpdated)) {
     emailMap.set(user.email, user);
    }
   }
  }
 });
 
 allUsers = Array.from(emailMap.values());
 allUsers.sort((a,b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));
 
 return allUsers; //  CRITICAL FIX: Return the deduplicated users array!
 }

 //  ADD USERS TO POOL FUNCTIONS - Diamond Level Implementation! 

 async function fetchRecentUsers() {
  try {
    console.log(' Fetching recent users for pool addition...');
    
    // Get all users and sort by creation date (most recent first)
    const usersCollectionRef = collection(db, usersPath());
    const usersQuery = query(usersCollectionRef, orderBy('createdAt', 'desc'), limit(20));
    const usersSnap = await getDocs(usersQuery);
    
    const recentUsers = [];
    usersSnap.forEach(doc => {
      recentUsers.push({ id: doc.id, ...doc.data() });
    });
    
    // If createdAt field doesn't exist, fall back to fetching all and sorting by ID
    if (recentUsers.length === 0) {
      const allUsersSnap = await getDocs(usersCollectionRef);
      const allUsersArray = [];
      allUsersSnap.forEach(doc => {
        allUsersArray.push({ id: doc.id, ...doc.data() });
      });
      
      // Sort by ID descending as fallback (newer UIDs are typically larger)
      allUsersArray.sort((a, b) => b.id.localeCompare(a.id));
      return allUsersArray.slice(0, 10);
    }
    
    console.log(` Found ${recentUsers.length} recent users`);
    return recentUsers.slice(0, 10);
    
  } catch (error) {
    console.error('Error fetching recent users:', error);
    return [];
  }
 }

 async function filterUsersNotInPool(users, poolId) {
  try {
    console.log(` Filtering users not in pool: ${poolId}`);
    
    // Get current pool members
    const poolMembersRef = doc(db, getPoolMembersPath(poolId));
    const poolMembersSnap = await getDoc(poolMembersRef);
    
    const currentMembers = new Set();
    if (poolMembersSnap.exists()) {
      const membersData = poolMembersSnap.data();
      Object.keys(membersData).forEach(uid => currentMembers.add(uid));
    }
    
    // Filter out users already in the pool
    const availableUsers = users.filter(user => !currentMembers.has(user.id));
    
    console.log(` Found ${availableUsers.length} users not in pool (filtered ${currentMembers.size} existing members)`);
    return availableUsers;
    
  } catch (error) {
    console.error('Error filtering users not in pool:', error);
    return users; // Return all users if filtering fails
  }
 }

 async function searchUsers(searchTerm) {
  try {
    if (!searchTerm || searchTerm.trim().length < 2) {
      return [];
    }
    
    console.log(` Searching users with term: "${searchTerm}"`);
    
    const allUsers = await fetchAllUsers();
    const searchRegex = new RegExp(searchTerm.trim(), 'i'); // Case insensitive
    
    const matchingUsers = allUsers.filter(user => {
      const displayName = user.displayName || '';
      const email = user.email || '';
      return searchRegex.test(displayName) || searchRegex.test(email);
    });
    
    console.log(` Found ${matchingUsers.length} users matching "${searchTerm}"`);
    return matchingUsers;
    
  } catch (error) {
    console.error('Error searching users:', error);
    return [];
  }
 }

 //  CORE ADD USER TO POOL FUNCTION - Complete Database Associations! 
 async function addUserToPool(userId, userEmail, userDisplayName, role, poolId, poolName, adminUID) {
  try {
    console.log(` Adding user ${userId} (${userDisplayName}) to pool ${poolId} as ${role}`);
    
    // Validate inputs
    if (!userId || !role || !poolId || !adminUID) {
      throw new Error('Missing required parameters for user addition');
    }
    
    // Validate user doesn't already exist in pool
    const poolMembersRef = doc(db, getPoolMembersPath(poolId));
    const poolMembersSnap = await getDoc(poolMembersRef);
    
    if (poolMembersSnap.exists()) {
      const members = poolMembersSnap.data();
      if (members[userId]) {
        throw new Error(`User is already a member of this pool with role: ${members[userId].role}`);
      }
    }
    
    // Use transaction to ensure atomicity - ALL READS FIRST, THEN ALL WRITES
    await runTransaction(db, async (transaction) => {
      const now = new Date();
      const timestamp = now.toISOString();
      
      // PHASE 1: ALL READS (must come first in Firestore transactions)
      const poolConfigRef = doc(db, `poolConfigs/${poolId}`);
      const poolConfigSnap = await transaction.get(poolConfigRef);
      
      // PHASE 2: ALL WRITES (after all reads are complete)
      
      // 1. Update poolMembers/{poolId} - Add user with role and metadata
      const poolMemberData = {
        [userId]: {
          role: role,
          addedBy: adminUID,
          addedAt: timestamp,
          email: userEmail,
          displayName: userDisplayName,
          status: 'active'
        }
      };
      
      transaction.update(poolMembersRef, poolMemberData);
      console.log(' Updated poolMembers document');
      
      // 2. Update userPools/{userUID} - Add pool membership record
      const userPoolsRef = doc(db, `userPools/${userId}`);
      const userPoolData = {
        [poolId]: {
          role: role,
          joinedAt: timestamp,
          addedBy: adminUID,
          poolName: poolName,
          status: 'active'
        }
      };
      
      transaction.set(userPoolsRef, userPoolData, { merge: true });
      console.log(' Updated userPools document');
      
      // 3. Initialize picks documents for current and future weeks
      const currentWeek = getCurrentNflWeek();
      const maxWeeks = 18; // NFL season weeks
      
      for (let week = currentWeek; week <= maxWeeks; week++) {
        const picksDocRef = doc(db, picksPath(week, userId));
        const initialPicksData = {
          userId: userId,
          poolId: poolId,
          weekNumber: week,
          picks: {}, // Empty picks object
          survivorPick: '', // Empty survivor pick
          mnfTotalPoints: 0,
          lastUpdated: timestamp,
          createdAt: timestamp
        };
        
        transaction.set(picksDocRef, initialPicksData, { merge: true });
      }
      console.log(` Initialized picks documents for weeks ${currentWeek}-${maxWeeks}`);
      
      // 4. Update pool member count statistics (using data from read phase)
      if (poolConfigSnap.exists()) {
        const currentConfig = poolConfigSnap.data();
        const currentMemberCount = currentConfig.memberCount || 0;
        
        transaction.update(poolConfigRef, {
          memberCount: currentMemberCount + 1,
          lastUpdated: timestamp
        });
        console.log(' Updated pool member count statistics');
      }
      
      // 5. Create audit log entry
      const auditLogRef = doc(db, `auditLogs/${poolId}`, 'userActions', `${Date.now()}_${userId}`);
      const auditData = {
        action: 'USER_ADDED_TO_POOL',
        targetUserId: userId,
        targetUserEmail: userEmail,
        targetUserDisplayName: userDisplayName,
        role: role,
        performedBy: adminUID,
        poolId: poolId,
        poolName: poolName,
        timestamp: timestamp,
        metadata: {
          additionMethod: 'admin_interface',
          userAgent: navigator.userAgent
        }
      };
      
      transaction.set(auditLogRef, auditData);
      console.log(' Created audit log entry');
    });
    
    console.log(` Successfully added ${userDisplayName} to pool ${poolName} as ${role}!`);
    return { success: true, message: `${userDisplayName} successfully added as ${role}` };
    
  } catch (error) {
    console.error(' Error adding user to pool:', error);
    
    // Provide specific error messages
    if (error.message.includes('already a member')) {
      return { success: false, message: error.message };
    } else if (error.message.includes('Missing required parameters')) {
      return { success: false, message: 'Invalid request - missing required information' };
    } else if (error.code === 'permission-denied') {
      return { success: false, message: 'Permission denied - insufficient privileges' };
    } else if (error.code === 'network-request-failed') {
      return { success: false, message: 'Network error - please check your connection and try again' };
    } else {
      return { success: false, message: 'Failed to add user - please try again' };
    }
  }
 }

 //  ADD USERS SECTION INITIALIZATION & INTERACTIONS - Diamond Level! 
 
 let searchTimeout = null;
 let currentSelectedUser = null;
 
 async function initializeAddUsersSection() {
  try {
    console.log(' Initializing Add Users section...');
    
    const currentPool = getCurrentPool();
    const poolName = getPoolDisplayName(currentPool);
    
    // Update pool name in the header
    if (allUI.addUsersPoolName) {
      allUI.addUsersPoolName.textContent = poolName;
    }
    
    // Load and display recent users
    await loadRecentUsersDisplay();
    
    // Setup search functionality
    setupUserSearch();
    
    // Setup modal interactions
    setupModalInteractions();
    
    console.log(' Add Users section initialized successfully');
    
  } catch (error) {
    console.error('Error initializing Add Users section:', error);
  }
 }
 
 async function loadRecentUsersDisplay() {
  try {
    // Show loading
    if (allUI.recentUsersLoading) allUI.recentUsersLoading.classList.remove('hidden');
    
    // Fetch recent users
    const recentUsers = await fetchRecentUsers();
    const currentPoolId = getCurrentPool();
    const availableUsers = await filterUsersNotInPool(recentUsers, currentPoolId);
    
    // Hide loading
    if (allUI.recentUsersLoading) allUI.recentUsersLoading.classList.add('hidden');
    
    if (availableUsers.length === 0) {
      allUI.recentUsersList.innerHTML = `
        <div class="text-center py-8 text-slate-500">
          <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <p class="text-sm">No recent users available to add to this pool.</p>
          <p class="text-xs text-slate-400 mt-1">Use the search below to find other users.</p>
        </div>
      `;
      return;
    }
    
    // Display recent users with inline role toggles
    const usersHTML = availableUsers.map(user => {
      const avatar = (user.displayName || user.email || '?').charAt(0).toUpperCase();
      const displayName = user.displayName || 'Unknown User';
      const email = user.email || 'No email';
      
      return `
        <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
              <span class="text-sm font-medium text-white">${avatar}</span>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium text-slate-900">${displayName}</div>
              <div class="text-xs text-slate-500">${email}</div>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <div class="inline-role-selector hidden" data-user-id="${user.id}" data-user-name="${displayName}" data-user-email="${email}">
              <div class="flex items-center space-x-2 bg-slate-100 rounded-lg p-2">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="role-${user.id}" value="member" class="h-3 w-3 text-blue-600" checked>
                  <span class="ml-1 text-xs text-slate-700">Member</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="role-${user.id}" value="admin" class="h-3 w-3 text-blue-600">
                  <span class="ml-1 text-xs text-slate-700">Admin</span>
                </label>
                <button class="confirm-add-btn text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700" data-user-id="${user.id}">
                  Add
                </button>
                <button class="cancel-add-btn text-xs px-2 py-1 bg-slate-300 text-slate-700 rounded hover:bg-slate-400" data-user-id="${user.id}">
                  Cancel
                </button>
              </div>
            </div>
            <button class="add-user-btn px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700" data-user-id="${user.id}" data-user-name="${displayName}" data-user-email="${email}">
              Add to Pool
            </button>
          </div>
        </div>
      `;
    }).join('');
    
    allUI.recentUsersList.innerHTML = usersHTML;
    
    // Setup inline add button interactions
    setupInlineAddButtons();
    
    console.log(` Displayed ${availableUsers.length} recent users`);
    
  } catch (error) {
    console.error('Error loading recent users display:', error);
    allUI.recentUsersList.innerHTML = `
      <div class="text-center py-8 text-red-500">
        <p class="text-sm">Error loading recent users.</p>
        <button onclick="loadRecentUsersDisplay()" class="text-xs text-blue-600 hover:text-blue-800 mt-1">Try again</button>
      </div>
    `;
  }
 }
 
 function setupInlineAddButtons() {
  // Add user buttons (show role selector)
  document.querySelectorAll('.add-user-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const userId = e.target.dataset.userId;
      const container = e.target.closest('.flex.items-center.justify-between');
      const addBtn = container.querySelector('.add-user-btn');
      const roleSelector = container.querySelector('.inline-role-selector');
      
      // Hide add button, show role selector
      addBtn.classList.add('hidden');
      roleSelector.classList.remove('hidden');
    });
  });
  
  // Cancel buttons
  document.querySelectorAll('.cancel-add-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const userId = e.target.dataset.userId;
      const container = e.target.closest('.flex.items-center.justify-between');
      const addBtn = container.querySelector('.add-user-btn');
      const roleSelector = container.querySelector('.inline-role-selector');
      
      // Show add button, hide role selector
      addBtn.classList.remove('hidden');
      roleSelector.classList.add('hidden');
    });
  });
  
  // Confirm add buttons
  document.querySelectorAll('.confirm-add-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const userId = e.target.dataset.userId;
      const container = e.target.closest('.flex.items-center.justify-between');
      const roleSelector = container.querySelector('.inline-role-selector');
      const selectedRole = roleSelector.querySelector(`input[name="role-${userId}"]:checked`).value;
      const userName = roleSelector.dataset.userName;
      const userEmail = roleSelector.dataset.userEmail;
      
      await executeAddUser(userId, userEmail, userName, selectedRole);
    });
  });
 }
 
 function setupUserSearch() {
  if (!allUI.userSearchInput) return;
  
  allUI.userSearchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Show loading if there's a search term
    if (searchTerm.length >= 2) {
      if (allUI.searchLoading) allUI.searchLoading.classList.remove('hidden');
    } else {
      if (allUI.searchLoading) allUI.searchLoading.classList.add('hidden');
      allUI.searchResultsList.innerHTML = '';
      return;
    }
    
    // Debounce search with 300ms delay
    searchTimeout = setTimeout(async () => {
      await performUserSearch(searchTerm);
    }, 300);
  });
 }
 
 async function performUserSearch(searchTerm) {
  try {
    if (allUI.searchLoading) allUI.searchLoading.classList.remove('hidden');
    
    const matchingUsers = await searchUsers(searchTerm);
    const currentPoolId = getCurrentPool();
    const availableUsers = await filterUsersNotInPool(matchingUsers, currentPoolId);
    
    if (allUI.searchLoading) allUI.searchLoading.classList.add('hidden');
    
    if (availableUsers.length === 0) {
      allUI.searchResultsList.innerHTML = `
        <div class="text-center py-4 text-slate-500">
          <p class="text-sm">No users found matching "${searchTerm}"</p>
        </div>
      `;
      return;
    }
    
    // Display search results (modal dialog approach)
    const resultsHTML = availableUsers.map(user => {
      const avatar = (user.displayName || user.email || '?').charAt(0).toUpperCase();
      const displayName = user.displayName || 'Unknown User';
      const email = user.email || 'No email';
      
      return `
        <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer search-user-item" data-user-id="${user.id}" data-user-name="${displayName}" data-user-email="${email}">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
              <span class="text-xs font-medium text-white">${avatar}</span>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium text-slate-900">${displayName}</div>
              <div class="text-xs text-slate-500">${email}</div>
            </div>
          </div>
          <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      `;
    }).join('');
    
    allUI.searchResultsList.innerHTML = resultsHTML;
    
    // Setup search result click handlers
    document.querySelectorAll('.search-user-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const userId = e.currentTarget.dataset.userId;
        const userName = e.currentTarget.dataset.userName;
        const userEmail = e.currentTarget.dataset.userEmail;
        
        openAddUserModal(userId, userName, userEmail);
      });
    });
    
    console.log(` Found ${availableUsers.length} users matching "${searchTerm}"`);
    
  } catch (error) {
    console.error('Error performing user search:', error);
    if (allUI.searchLoading) allUI.searchLoading.classList.add('hidden');
    allUI.searchResultsList.innerHTML = `
      <div class="text-center py-4 text-red-500">
        <p class="text-sm">Error searching users. Please try again.</p>
      </div>
    `;
  }
 }
 
 function setupModalInteractions() {
  // Close modal buttons
  [allUI.closeAddUserModal, allUI.cancelAddUser].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', closeAddUserModal);
    }
  });
  
  // Confirm add user in modal
  if (allUI.confirmAddUser) {
    allUI.confirmAddUser.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (!currentSelectedUser) {
        console.error('No user selected for addition');
        return;
      }
      
      const selectedRole = document.querySelector('input[name="user-role"]:checked')?.value || 'member';
      await executeAddUser(currentSelectedUser.id, currentSelectedUser.email, currentSelectedUser.name, selectedRole, true);
    });
  }
 }
 
 function openAddUserModal(userId, userName, userEmail) {
  currentSelectedUser = { id: userId, name: userName, email: userEmail };
  
  // Update modal content
  if (allUI.modalUserName) allUI.modalUserName.textContent = userName;
  if (allUI.modalUserEmail) allUI.modalUserEmail.textContent = userEmail;
  if (allUI.modalUserAvatar) allUI.modalUserAvatar.textContent = (userName || userEmail || '?').charAt(0).toUpperCase();
  
  // Reset role selection to member
  const memberRadio = document.querySelector('input[name="user-role"][value="member"]');
  if (memberRadio) memberRadio.checked = true;
  
  // Show modal
  if (allUI.addUserModal) allUI.addUserModal.classList.remove('hidden');
 }
 
 function closeAddUserModal() {
  currentSelectedUser = null;
  if (allUI.addUserModal) allUI.addUserModal.classList.add('hidden');
 }
 
 async function executeAddUser(userId, userEmail, userName, role, isFromModal = false) {
  try {
    console.log(` Executing add user: ${userId} (${userName}) as ${role}`);
    
    // Show loading state
    if (isFromModal) {
      allUI.addUserBtnText.classList.add('hidden');
      allUI.addUserLoading.classList.remove('hidden');
      allUI.confirmAddUser.disabled = true;
    }
    
    const currentPoolId = getCurrentPool();
    const poolName = getPoolDisplayName(currentPoolId);
    const adminUID = currentUser.uid;
    
    // Execute the addition
    const result = await addUserToPool(userId, userEmail, userName, role, currentPoolId, poolName, adminUID);
    
    //  CRITICAL: Invalidate all cache affected by user pool modifications
    if (result.success) {
      window.gameStateCache.invalidateAfterDataUpdate('users_modified');
    }
    
    if (result.success) {
      // Success feedback
      showMessage(` ${result.message}`, 'success');
      
      // Close modal if open
      if (isFromModal) {
        closeAddUserModal();
      }
      
      // Refresh displays
      await Promise.all([
        loadPoolMembers(), // Refresh pool members list
        loadRecentUsersDisplay() // Refresh recent users (remove the added user)
      ]);
      
      // Clear search if there was one
      if (allUI.userSearchInput) {
        allUI.userSearchInput.value = '';
        allUI.searchResultsList.innerHTML = '';
      }
      
    } else {
      // Error feedback
      showMessage(` ${result.message}`, 'error');
    }
    
  } catch (error) {
    console.error('Error in executeAddUser:', error);
    showMessage(' Unexpected error occurred while adding user', 'error');
  } finally {
    // Reset loading state
    if (isFromModal && allUI.confirmAddUser) {
      allUI.addUserBtnText.classList.remove('hidden');
      allUI.addUserLoading.classList.add('hidden');
      allUI.confirmAddUser.disabled = false;
    }
  }
 }
 
 function showMessage(message, type = 'info') {
  // Create or update a toast message
  let toast = document.getElementById('add-user-toast');
  
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'add-user-toast';
    toast.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm';
    document.body.appendChild(toast);
  }
  
  // Set styling based on type
  toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm ${
    type === 'success' ? 'bg-green-500 text-white' :
    type === 'error' ? 'bg-red-500 text-white' :
    'bg-blue-500 text-white'
  }`;
  
  toast.innerHTML = `
    <div class="flex items-center space-x-2">
      <span class="text-sm font-medium">${message}</span>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  `;
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (toast && toast.parentNode) {
      toast.remove();
    }
  }, 5000);
 }
 
 function getPoolDisplayName(poolId) {
  // Get pool name from metadata or use fallback
  if (typeof getCurrentPoolName === 'function') {
    return getCurrentPoolName();
  }
  return poolId.replace(/-/g, ' ').replace(/^\w/, c => c.toUpperCase());
 }

 async function cleanupDuplicateUsers() {
  try {
   console.log('Starting cleanup of duplicate users...');
   
   // Get all users from Firestore
   const usersCollectionRef = collection(db, usersPath());
   const usersSnap = await getDocs(usersCollectionRef);
   const allUsersRaw = [];
   usersSnap.forEach(doc => {
    allUsersRaw.push({ id: doc.id, ...doc.data() });
   });
   
   // Find duplicates for tonyweeg@gmail.com specifically
   const tonyweegUsers = allUsersRaw.filter(u => u.email === 'tonyweeg@gmail.com');
   console.log(`Found ${tonyweegUsers.length} users with tonyweeg@gmail.com:`, tonyweegUsers);
   
   if (tonyweegUsers.length > 1) {
    const keepUID = 'WxSPmEildJdqs6T5hIpBUZrscwt2';
    const usersToRemove = tonyweegUsers.filter(u => u.id !== keepUID);
    
    for (const userToRemove of usersToRemove) {
     console.log(`Removing duplicate user: ${userToRemove.id}`);
     await removeUserCompletely(userToRemove.id, `${userToRemove.displayName} (duplicate)`);
    }
    
    console.log(`Cleanup complete. Kept user with UID: ${keepUID}`);
   } else {
    console.log('No duplicate tonyweeg@gmail.com users found.');
   }
   
  } catch (error) {
   console.error('Error during duplicate cleanup:', error);
   alert(`Error cleaning up duplicates: ${error.message}`);
  }
 }

 async function removeUserCompletely(userId, userName) {
  try {
   console.log(`Starting complete removal of user: ${userId} (${userName})`);
   
   // Step 1: Delete user profile
   console.log('Deleting user profile...');
   const userDocRef = doc(db, `${usersPath()}/${userId}`);
   await deleteDoc(userDocRef);
   
   // Step 2: Delete all weekly picks (check all weeks 1-18)
   console.log('Deleting all weekly picks...');
   for (let week = 1; week <= 18; week++) {
    try {
     const picksDocRef = doc(db, picksPath(week, userId));
     await deleteDoc(picksDocRef);
     console.log(`Deleted picks for week ${week}`);
    } catch (error) {
     console.log(`No picks found for week ${week} (this is normal)`);
    }
   }
   
   // Step 3: Delete survivor picks
   console.log('Deleting survivor picks...');
   try {
    const survivorDocRef = doc(db, survivorPicksPath(userId));
    await deleteDoc(survivorDocRef);
    console.log('Deleted survivor picks');
   } catch (error) {
    console.log('No survivor picks found (this is normal)');
   }
   
   // Step 4: Clean up any other user references (if any exist in other collections)
   console.log('Checking for other user references...');
   
   // Step 5: Refresh the user list (with small delay to avoid connection issues)
   setTimeout(async () => {
     try {
       await fetchAllUsers();
       renderUserManagement();
     } catch (error) {
       console.log('Non-critical cache refresh error after user deletion:', error);
       // Still render with existing data
       renderUserManagement();
     }
   }, 1000);
   
   alert(` User "${userName}" has been completely removed from the system.\n\nAll data deleted:\n- User profile\n- All weekly picks (weeks 1-18)\n- Survivor picks\n- All associated data`);
   
   console.log(`Successfully completed removal of user: ${userId} (${userName})`);
   
   //  CRITICAL: Invalidate all cache affected by user removal
   window.gameStateCache.invalidateAfterDataUpdate('users_modified');
   
  } catch (error) {
   console.error('Error during user removal:', error);
   alert(` Error removing user "${userName}": ${error.message}\n\nPlease try again or contact support.`);
  }
 }

 async function renderGameResultsAdmin(weekNumber) {
    allUI.adminWeekTitle.textContent = `Editing Results for Week ${weekNumber}`;
    const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
    if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
        allUI.resultsGameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week.</p>';
        return;
    }
    
    const picksCollectionRef = collection(db, picksCollectionPath(weekNumber));
    const picksSnap = await getDocs(picksCollectionRef);
    const pickCounts = {};
    picksSnap.forEach(pickDoc => {
        const userPicks = pickDoc.data();
        Object.keys(userPicks).forEach(gameId => {
            if (!pickCounts[gameId]) {
                pickCounts[gameId] = { away: 0, home: 0 };
            }
            if (userPicks[gameId].winner) {
                const weekGame = weekData.games.find(g => g.id == gameId);
                if (weekGame && userPicks[gameId].winner === weekGame.away) {
                    pickCounts[gameId].away++;
                } else if (weekGame && userPicks[gameId].winner === weekGame.home) {
                    pickCounts[gameId].home++;
                }
            }
        });
    });

    const resultsDocRef = doc(db, resultsPath(weekNumber));
    const resultsSnap = await getDoc(resultsDocRef);
    const currentResults = resultsSnap.exists() ? resultsSnap.data() : {};
    allUI.resultsGameList.innerHTML = '';

    weekData.games.forEach(game => {
        const gameTime = new Date(game.kickoff);
        const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

        // Get existing scores if available
        const gameResult = currentResults[game.id];
        let awayScore = '';
        let homeScore = '';
        let winner = null;
        
        if (gameResult) {
            if (typeof gameResult === 'string') {
                // Legacy format - just winner
                winner = gameResult;
            } else if (typeof gameResult === 'object') {
                // New format - winner and scores
                winner = gameResult.winner;
                awayScore = gameResult.awayScore || '';
                homeScore = gameResult.homeScore || '';
            }
        }

        const gameEl = document.createElement('div');
        gameEl.className = 'p-2 border border-slate-300 rounded bg-slate-50';
        
        // Get helmet CSS classes
        const awayHelmetClass = getHelmetClass(game.away);
        const homeHelmetClass = getHelmetClass(game.home);
        
        gameEl.innerHTML = `
            <div class="flex items-center gap-2 text-xs">
                <div class="text-slate-500 w-16 text-center">
                    <div>${formattedTime.split(',')[0]}</div>
                    <div>${formattedTime.split(' ').pop()}</div>
                </div>
                <div class="flex items-center gap-1 flex-1">
                    <button data-game-id="${game.id}" data-team="${game.away}" class="result-btn flex items-center gap-1 p-1 rounded border ${winner === game.away ? 'bg-green-200 border-green-400' : 'bg-white border-slate-300 hover:bg-slate-100'}">
                        <span class="helmet-icon ${awayHelmetClass}" title="${game.away}"></span>
                    </button>
                    <input 
                        type="number" 
                        min="0" 
                        max="99" 
                        placeholder="0" 
                        value="${awayScore}"
                        data-game-id="${game.id}" 
                        data-team="away"
                        class="score-input w-8 p-1 text-center text-xs border border-slate-300 rounded"
                    />
                </div>
                <div class="text-slate-400 text-xs">@</div>
                <div class="flex items-center gap-1 flex-1">
                    <input 
                        type="number" 
                        min="0" 
                        max="99" 
                        placeholder="0" 
                        value="${homeScore}"
                        data-game-id="${game.id}" 
                        data-team="home"
                        class="score-input w-8 p-1 text-center text-xs border border-slate-300 rounded"
                    />
                    <button data-game-id="${game.id}" data-team="${game.home}" class="result-btn flex items-center gap-1 p-1 rounded border ${winner === game.home ? 'bg-green-200 border-green-400' : 'bg-white border-slate-300 hover:bg-slate-100'}">
                        <span class="helmet-icon ${homeHelmetClass}" title="${game.home}"></span>
                    </button>
                </div>
                <button 
                    data-game-id="${game.id}" 
                    class="auto-winner-btn text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 whitespace-nowrap"
                >
                    Auto
                </button>
            </div>`;
        allUI.resultsGameList.appendChild(gameEl);
    });
    
    allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const { gameId } = e.target.dataset;
        const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
        gameButtons.forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
        
        // Show football indicator for individual game updates
        showGameUpdateIndicator();
    }));

    // Add event listeners for auto-winner buttons
    allUI.resultsGameList.querySelectorAll('.auto-winner-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const gameId = e.target.dataset.gameId;
        const awayScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="away"]`);
        const homeScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="home"]`);
        
        const awayScore = parseInt(awayScoreInput.value) || 0;
        const homeScore = parseInt(homeScoreInput.value) || 0;
        
        if (awayScore === 0 && homeScore === 0) {
            alert('Please enter scores for both teams first');
            return;
        }
        
        // Clear current selection
        const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
        gameButtons.forEach(b => b.classList.remove('selected'));
        
        // Select winner based on higher score
        if (awayScore > homeScore) {
            // Away team wins - select first button (away team)
            gameButtons[0].classList.add('selected');
        } else if (homeScore > awayScore) {
            // Home team wins - select second button (home team) 
            gameButtons[1].classList.add('selected');
        } else {
            alert('Tie game! Please manually select the winner.');
        }
        
        // Show football indicator for auto-winner selection
        showGameUpdateIndicator();
    }));
    
    // Add event listeners for score inputs
    allUI.resultsGameList.querySelectorAll('.score-input').forEach(input => input.addEventListener('change', () => {
        // Show football indicator when scores are updated
        showGameUpdateIndicator();
    }));

    // Live leaderboard removed from Games tab per user request
 }


 // User management sorting state
 let userSortField = 'role'; // Start by sorting by role (admins first)
 let userSortDirection = 'desc'; // desc = admins first, asc = regular users first

 async function renderUserManagement() {
   //  DIAMOND FIX: Use deduplicated users instead of stale allUsers global!
   const cleanUsers = await fetchAllUsers();
   
   // Create enhanced user objects with role information
   const enhancedUsers = cleanUsers.map(user => ({
     ...user,
     role: ADMIN_UIDS.includes(user.id) ? 'admin' : 'user',
     displayName: user.displayName || 'N/A'
   }));

   // Sort users based on current sort settings
   const sortedUsers = sortUsers(enhancedUsers, userSortField, userSortDirection);

   // Render the sorted users with row numbers
   allUI.userMgmtBody.innerHTML = sortedUsers.map((user, index) => {
     const isAdmin = user.role === 'admin';
     const rowClass = isAdmin ? 'bg-blue-50' : '';
     const statusClass = isAdmin ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
     const statusText = isAdmin ? 'Admin' : 'Active';

     return `
       <tr class="${rowClass}">
         <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${index + 1}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           ${user.displayName}
           ${isAdmin ? '<span class="ml-2 text-xs text-blue-600 font-semibold"></span>' : ''}
         </td>
         <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
             ${statusText}
           </span>
         </td>
         <td class="px-6 py-4 whitespace-nowrap">
           <button data-user-id="${user.id}" class="user-remove-btn text-sm font-medium ${isAdmin ? 'text-blue-600 opacity-50 cursor-not-allowed' : 'text-red-600 hover:text-red-900'}">
             ${isAdmin ? 'Protected' : 'Remove User'}
           </button>
         </td>
       </tr>
     `;
   }).join('');

   // Update sort indicators
   updateSortIndicators();

   // Add event listeners for column sorting
   document.querySelectorAll('.user-sort-header').forEach(header => {
     header.replaceWith(header.cloneNode(true)); // Remove existing listeners
   });
   
   document.querySelectorAll('.user-sort-header').forEach(header => {
     header.addEventListener('click', async (e) => {
       const field = e.currentTarget.dataset.sort;
       
       if (userSortField === field) {
         // Toggle direction if same field
         userSortDirection = userSortDirection === 'desc' ? 'asc' : 'desc';
       } else {
         // New field, start with descending
         userSortField = field;
         userSortDirection = 'desc';
       }
       
       await renderUserManagement(); // Re-render with new sort
     });
   });

   // Add event listeners for remove buttons
   allUI.userMgmtBody.querySelectorAll('.user-remove-btn').forEach(btn => {
     btn.addEventListener('click', async (e) => {
       const userId = e.target.dataset.userId;
       const userName = cleanUsers.find(u => u.id === userId)?.displayName || cleanUsers.find(u => u.id === userId)?.email;

       if (ADMIN_UIDS.includes(userId)) {
         alert("You cannot remove admin accounts.");
         return;
       }

       if (confirm(` WARNING: This will PERMANENTLY DELETE all data for "${userName}".\n\nThis includes:\n- User profile\n- All picks from all weeks\n- Pick history\n- Survivor picks\n- All associated data\n\nThis action CANNOT be undone.\n\nType "DELETE" to confirm:`)) {
         const confirmation = prompt('Type "DELETE" to confirm user removal:');
         if (confirmation === 'DELETE') {
           await removeUserCompletely(userId, userName);
         } else {
           alert('User removal cancelled.');
         }
       }
     });
   });
 }

 // Sort users based on field and direction
 function sortUsers(users, field, direction) {
   return users.sort((a, b) => {
     let aValue = a[field];
     let bValue = b[field];

     // Special handling for role to ensure admins come first when desc
     if (field === 'role') {
       aValue = aValue === 'admin' ? 1 : 0;
       bValue = bValue === 'admin' ? 1 : 0;
     }

     // Handle string comparisons
     if (typeof aValue === 'string' && typeof bValue === 'string') {
       aValue = aValue.toLowerCase();
       bValue = bValue.toLowerCase();
     }

     let result;
     if (aValue < bValue) result = -1;
     else if (aValue > bValue) result = 1;
     else result = 0;

     return direction === 'desc' ? -result : result;
   });
 }

 // Update sort indicators in table headers
 function updateSortIndicators() {
   document.querySelectorAll('.user-sort-header').forEach(header => {
     const indicator = header.querySelector('.sort-indicator');
     const field = header.dataset.sort;
     
     if (field === userSortField) {
       indicator.textContent = userSortDirection === 'desc' ? '' : '';
       header.classList.add('text-blue-600');
     } else {
       indicator.textContent = '';
       header.classList.remove('text-blue-600');
     }
   });
 }

 // Admin picks management state
 let selectedUserForPicks = null;
 let originalUserPicks = {};
 let editableGamesForUser = [];

 async function renderPicksManagement(weekNumber) {
     console.log(' NEW PICKS MANAGEMENT LOADING - Week:', weekNumber);
     console.log(' Elements check:', {
         adminPicksWeekNumber: !!allUI.adminPicksWeekNumber,
         playerIconsGrid: !!allUI.playerIconsGrid,
         userPicksEditor: !!allUI.userPicksEditor,
         allUsersCount: allUsers.length
     });
     
     // Update week display
     if (allUI.adminPicksWeekNumber) {
         allUI.adminPicksWeekNumber.textContent = weekNumber;
     }
     
     // Hide editor initially
     allUI.userPicksEditor.classList.add('hidden');
     
     // Load all user picks for this week to determine status
     const allUserPicks = {};
     const picksCollectionPath = `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`;
     
     try {
         const picksCollectionRef = collection(db, picksCollectionPath);
         const picksSnapshot = await getDocs(picksCollectionRef);
         
         picksSnapshot.forEach(doc => {
             allUserPicks[doc.id] = doc.data();
         });
         
         console.log(` Loaded picks for ${Object.keys(allUserPicks).length} users for week ${weekNumber}`);
     } catch (error) {
         console.error('Error loading user picks:', error);
     }
     
     // Render player icons grid
     renderPlayerIconsGrid(weekNumber, allUserPicks);
 }

 function renderPlayerIconsGrid(weekNumber, allUserPicks) {
     if (!allUsers.length) {
         allUI.playerIconsGrid.innerHTML = '<div class="text-slate-500">Loading users...</div>';
         return;
     }
     
     const iconsHTML = allUsers.map(user => {
         // Check if user has picks - picks are stored directly as game IDs, not under a 'picks' property
         const userPickData = allUserPicks[user.id] || {};
         const hasPicks = Object.keys(userPickData).length > 0;
         const isAdmin = ADMIN_UIDS.includes(user.id);
         const isCurrentUser = currentUser && user.id === currentUser.uid;
         
         // Determine if current admin can edit this user
         const canEdit = canAdminEditUser(user.id);
         
         // Background colors based on pick status
         let bgClass = hasPicks ? 'bg-green-100 hover:bg-green-200 border-green-300' : 'bg-rose-100 hover:bg-rose-200 border-rose-300';
         
         // Disable style if can't edit
         if (!canEdit) {
             bgClass += ' opacity-60 cursor-not-allowed';
         }
         
         // Get user initials for avatar
         const displayName = user.displayName || user.email || 'User';
         const initials = getInitials(displayName);
         
         return `
             <div 
                 class="player-icon ${bgClass} border-2 rounded-lg p-2 text-center cursor-pointer transition-all duration-200 ${canEdit ? 'hover:scale-105' : ''}"
                 data-user-id="${user.id}"
                 data-can-edit="${canEdit}"
                 title="${displayName} ${hasPicks ? '(Has picks)' : '(No picks)'} ${isAdmin ? '[Admin]' : ''}"
             >
                 <div class="w-8 h-8 mx-auto bg-slate-600 text-white rounded-full flex items-center justify-center text-xs font-bold mb-1">
                     ${initials}
                 </div>
                 <div class="text-xs font-medium truncate">${displayName.split(' ')[0] || 'User'}</div>
                 ${isAdmin ? '<div class="text-xs text-blue-600 font-bold">Admin</div>' : ''}
                 ${!canEdit ? '<div class="text-xs text-slate-500"></div>' : ''}
             </div>
         `;
     }).join('');
     
     allUI.playerIconsGrid.innerHTML = iconsHTML;
     
     // Add click handlers
     document.querySelectorAll('.player-icon').forEach(icon => {
         icon.addEventListener('click', (e) => {
             const userId = e.currentTarget.dataset.userId;
             const canEdit = e.currentTarget.dataset.canEdit === 'true';
             
             if (canEdit) {
                 selectUserForPicksEditing(userId, weekNumber, allUserPicks);
             }
         });
     });
 }

 function canAdminEditUser(userId) {
     if (!currentUser || !ADMIN_UIDS.includes(currentUser.uid)) {
         return false; // Current user is not admin
     }
     
     const isTargetAdmin = ADMIN_UIDS.includes(userId);
     const isCurrentUser = userId === currentUser.uid;
     
     // Admin cannot edit their own picks
     if (isCurrentUser) {
         return false;
     }
     
     // Admin can edit non-admin users
     if (!isTargetAdmin) {
         return true;
     }
     
     // Admin can edit other admin users
     return true;
 }

 function getInitials(name) {
     if (!name) return 'U';
     const words = name.split(' ');
     if (words.length === 1) {
         return words[0].substring(0, 2).toUpperCase();
     }
     return (words[0][0] + (words[1] ? words[1][0] : '')).toUpperCase();
 }

 async function selectUserForPicksEditing(userId, weekNumber, allUserPicks) {
     selectedUserForPicks = userId;
     const user = allUsers.find(u => u.id === userId);
     
     if (!user) return;
     
     // Update UI
     allUI.selectedUserName.textContent = user.displayName || user.email;
     allUI.editPermissionStatus.textContent = canAdminEditUser(userId) ? 'Can Edit' : 'Cannot Edit';
     
     // Load user's current picks
     const userPicks = allUserPicks[userId] || {};
     originalUserPicks = JSON.parse(JSON.stringify(userPicks)); // Deep copy
     
     // Load games for this week using existing function
     try {
         editableGamesForUser = await getGamesForWeek(weekNumber);
         
         // Render pick editing interface
         renderUserPicksEditor(userPicks, editableGamesForUser);
         
         // Show editor
         allUI.userPicksEditor.classList.remove('hidden');
         
     } catch (error) {
         console.error('Error loading week data:', error);
         showMessageStatus('Error loading games for this week', 'error');
     }
 }

 function renderUserPicksEditor(userPicks, games) {
     const gamesHTML = games.map(game => {
         const existingPick = userPicks[game.id] || {};
         const homeSelected = existingPick.winner === game.home ? 'selected' : '';
         const awaySelected = existingPick.winner === game.away ? 'selected' : '';
         
         // Get helmet classes
         const homeHelmetClass = getHelmetClass(game.home);
         const awayHelmetClass = getHelmetClass(game.away);
         
         return `
             <div class="game-pick-editor border border-slate-300 rounded-lg p-4">
                 <div class="flex items-center justify-between mb-3">
                     <div class="text-sm font-medium">${game.away} @ ${game.home}</div>
                     <div class="text-xs text-slate-600">${new Date(game.kickoff).toLocaleDateString()}</div>
                 </div>
                 
                 <div class="flex gap-3">
                     <button 
                         class="team-pick-btn flex-1 p-3 border-2 rounded-lg ${awaySelected} flex items-center space-x-2"
                         data-game-id="${game.id}"
                         data-team="${game.away}"
                     >
                         <span class="helmet-icon-sm ${awayHelmetClass}" title="${game.away}"></span>
                         <span class="text-sm font-medium">${game.away}</span>
                     </button>
                     
                     <button 
                         class="team-pick-btn flex-1 p-3 border-2 rounded-lg ${homeSelected} flex items-center space-x-2"
                         data-game-id="${game.id}"
                         data-team="${game.home}"
                     >
                         <span class="helmet-icon-sm ${homeHelmetClass}" title="${game.home}"></span>
                         <span class="text-sm font-medium">${game.home}</span>
                     </button>
                 </div>
                 
                 <div class="mt-3">
                     <label class="text-xs text-slate-600">Confidence:</label>
                     <input 
                         type="number" 
                         min="1" 
                         max="16" 
                         value="${existingPick.confidence || 1}"
                         class="confidence-input w-16 ml-2 px-2 py-1 border border-slate-300 rounded text-sm"
                         data-game-id="${game.id}"
                     >
                 </div>
             </div>
         `;
     }).join('');
     
     allUI.userPicksGameList.innerHTML = gamesHTML;
     
     // Add pick selection handlers
     document.querySelectorAll('.team-pick-btn').forEach(btn => {
         btn.addEventListener('click', handleTeamPickSelection);
     });

     // Add confidence input handlers
     document.querySelectorAll('.confidence-input').forEach(input => {
         input.addEventListener('change', handleConfidenceChange);
     });
 }

 function handleTeamPickSelection(e) {
     const gameId = e.currentTarget.dataset.gameId;
     const team = e.currentTarget.dataset.team;
     
     // Remove selection from other button in this game
     const gameContainer = e.currentTarget.closest('.game-pick-editor');
     gameContainer.querySelectorAll('.team-pick-btn').forEach(btn => {
         btn.classList.remove('selected');
     });
     
     // Add selection to clicked button
     e.currentTarget.classList.add('selected');
     
     // Update pick in memory - picks are stored directly as game IDs
     if (!originalUserPicks[gameId]) originalUserPicks[gameId] = {};
     originalUserPicks[gameId].winner = team;
 }

 function handleConfidenceChange(e) {
     const gameId = e.target.dataset.gameId;
     const confidence = parseInt(e.target.value);
     
     // Update pick in memory - picks are stored directly as game IDs  
     if (!originalUserPicks[gameId]) originalUserPicks[gameId] = {};
     originalUserPicks[gameId].confidence = confidence;
 }

 // Validate and fix confidence values for admin picks
 function validateAndFixConfidenceValues(picks, gamesForWeek) {
     const validatedPicks = JSON.parse(JSON.stringify(picks)); // Deep copy
     
     // Get all game IDs for this week
     const gameIds = gamesForWeek.map(game => game.id);
     const numGames = gameIds.length;
     
     if (numGames === 0) return validatedPicks;
     
     // Collect current confidence values and find any zeros
     const confidenceMap = {};
     const zeroConfidenceGames = [];
     
     gameIds.forEach(gameId => {
         if (validatedPicks[gameId] && validatedPicks[gameId].confidence !== undefined) {
             const confidence = validatedPicks[gameId].confidence;
             if (confidence === 0) {
                 zeroConfidenceGames.push(gameId);
             } else {
                 confidenceMap[confidence] = gameId;
             }
         }
     });
     
     // Find missing confidence values (1 to numGames)
     const missingConfidences = [];
     for (let i = 1; i <= numGames; i++) {
         if (!confidenceMap[i]) {
             missingConfidences.push(i);
         }
     }
     
     // Assign missing confidence values to games with confidence 0
     zeroConfidenceGames.forEach((gameId, index) => {
         if (index < missingConfidences.length) {
             validatedPicks[gameId].confidence = missingConfidences[index];
         }
     });
     
     return validatedPicks;
 }
 
 // Survivor status sorting state
let survivorSortField = 'role'; // Start by sorting by role (admins first)
let survivorSortDirection = 'desc'; // desc = admins first, asc = regular users first

async function renderSurvivorStatus(weekNumber) {
    allUI.survivorStatusBody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="loader"></div></td></tr>`;
    
    const statusDocRef = doc(db, survivorStatusPath());
    const statusSnap = await getDoc(statusDocRef);
    const allStatuses = statusSnap.exists() ? statusSnap.data() : {};
    
    const picksCollectionRef = collection(db, survivorPicksPath('').slice(0,-1));
    const picksSnap = await getDocs(picksCollectionRef);
    const allPicks = {};
    picksSnap.forEach(doc => {
        allPicks[doc.id] = doc.data();
    });

    // Create enhanced user objects with role and additional data for sorting
    const enhancedUsers = allUsers.map(user => {
        const userStatus = allStatuses[user.id] || { eliminated: false };
        const userPicks = allPicks[user.id];
        const hasPick = userPicks && userPicks.picks && userPicks.picks[weekNumber] && userPicks.picks[weekNumber].team;
        const thisWeekPickStatus = hasPick ? 'Pick Made' : 'No Pick';
        
        return {
            ...user,
            role: ADMIN_UIDS.includes(user.id) ? 'admin' : 'user',
            eliminated: userStatus.eliminated,
            eliminatedWeek: userStatus.eliminatedWeek,
            thisWeekPick: thisWeekPickStatus,
            currentWeekPick: hasPick ? userPicks.picks[weekNumber].team : '',
            status: userStatus.eliminated ? `Eliminated (Week ${userStatus.eliminatedWeek})` : 'Active'
        };
    });

    // Sort users based on current sort field and direction
    enhancedUsers.sort((a, b) => {
        let valueA = a[survivorSortField];
        let valueB = b[survivorSortField];
        
        // Handle special cases for different field types
        if (survivorSortField === 'role') {
            // Admin comes before user
            valueA = a.role === 'admin' ? 0 : 1;
            valueB = b.role === 'admin' ? 0 : 1;
        } else if (survivorSortField === 'eliminated') {
            // Convert boolean to number for sorting
            valueA = a.eliminated ? 1 : 0;
            valueB = b.eliminated ? 1 : 0;
        } else if (survivorSortField === 'displayName') {
            // Use displayName or email as fallback
            valueA = (a.displayName || a.email || '').toLowerCase();
            valueB = (b.displayName || b.email || '').toLowerCase();
        } else if (survivorSortField === 'thisWeekPick') {
            valueA = (a.thisWeekPick || '').toLowerCase();
            valueB = (b.thisWeekPick || '').toLowerCase();
        }
        
        // Compare values
        if (valueA < valueB) return survivorSortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return survivorSortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    const tableRows = enhancedUsers.map((user, index) => {
        return `
            <tr class="${user.role === 'admin' ? 'bg-blue-50' : ''}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${user.displayName || user.email}
                    ${user.role === 'admin' ? '<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Admin</span>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.thisWeekPick === 'Pick Made' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${user.thisWeekPick}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.eliminated ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${user.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                        ${user.role === 'admin' ? 'Admin' : 'User'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex gap-2">
                        <button data-user-id="${user.id}" data-eliminated="${!!user.eliminated}" class="survivor-status-btn text-xs font-medium px-2 py-1 rounded ${user.eliminated ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'}">
                            ${user.eliminated ? 'Reinstate' : 'Eliminate'}
                        </button>
                        <button onclick="showSurvivorPickEditor('${user.id}', ${weekNumber}, '${user.currentWeekPick || ''}')" class="edit-survivor-pick-btn text-xs font-medium px-2 py-1 rounded bg-blue-100 text-blue-800 hover:bg-blue-200">
                            Edit Pick
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    allUI.survivorStatusBody.innerHTML = tableRows || `<tr><td colspan="5" class="text-center py-4">No users in survivor pool.</td></tr>`;

    // Update sort indicators
    document.querySelectorAll('.survivor-sort-header').forEach(header => {
        const sortField = header.dataset.sort;
        const indicator = header.querySelector('.sort-indicator');
        if (sortField === survivorSortField) {
            indicator.textContent = survivorSortDirection === 'asc' ? '' : '';
        } else {
            indicator.textContent = '';
        }
    });

    // Add event listeners for sorting
    document.querySelectorAll('.survivor-sort-header').forEach(header => {
        header.addEventListener('click', () => {
            const sortField = header.dataset.sort;
            if (survivorSortField === sortField) {
                survivorSortDirection = survivorSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                survivorSortField = sortField;
                survivorSortDirection = 'asc';
            }
            renderSurvivorStatus(weekNumber);
        });
    });

    allUI.survivorStatusBody.querySelectorAll('.survivor-status-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
            const userId = e.target.dataset.userId;
            const isEliminated = e.target.dataset.eliminated === 'true';
            
            const statusUpdate = {};
            if (!isEliminated) {
                if(confirm('Are you sure you want to eliminate this player?')){
                    statusUpdate[`${userId}.eliminated`] = true;
                    statusUpdate[`${userId}.eliminatedWeek`] = weekNumber;
                }
            } else {
                if(confirm('Are you sure you want to reinstate this player?')){
                    statusUpdate[`${userId}`] = deleteField();
                }
            }

            if(Object.keys(statusUpdate).length > 0) {
                await updateDoc(statusDocRef, statusUpdate);
                await renderSurvivorStatus(weekNumber);
            }
        });
    });
    
    //  ATTACH SURVIVOR ELIMINATION BUTTON HANDLERS
    attachSurvivorEliminationHandlers();
}

// Function to attach survivor elimination button handlers
function attachSurvivorEliminationHandlers() {
    console.log(' Attaching survivor elimination button handlers...');
    
    const checkCurrentWeekBtn = document.getElementById('check-current-week-eliminations-btn');
    const checkAllWeeksBtn = document.getElementById('check-all-weeks-eliminations-btn');
    const checkSpecificUserBtn = document.getElementById('check-specific-user-btn');
    const eliminationResults = document.getElementById('elimination-results');
    
    console.log('Button elements found:', {
        checkCurrentWeekBtn: !!checkCurrentWeekBtn,
        checkAllWeeksBtn: !!checkAllWeeksBtn,
        checkSpecificUserBtn: !!checkSpecificUserBtn,
        eliminationResults: !!eliminationResults
    });
    
    if (checkCurrentWeekBtn && !checkCurrentWeekBtn._handlerAttached) {
        checkCurrentWeekBtn._handlerAttached = true;
        checkCurrentWeekBtn.addEventListener('click', async () => {
            try {
                console.log(' Check Current Week button clicked');
                eliminationResults.innerHTML = '<span class="text-blue-600"> Checking current week eliminations...</span>';
                
                // Debug: Check if required components are available
                console.log('Debug - SurvivorAutoElimination available:', typeof window.SurvivorAutoElimination !== 'undefined');
                console.log('Debug - db available:', typeof db !== 'undefined');
                console.log('Debug - gameStateCache available:', typeof window.gameStateCache !== 'undefined');
                
                if (typeof window.SurvivorAutoElimination === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: SurvivorAutoElimination not loaded</span>';
                    return;
                }
                
                if (typeof db === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: Database not initialized</span>';
                    return;
                }
                
                const survivorElimination = new window.SurvivorAutoElimination(db, window.gameStateCache);
                const result = await survivorElimination.checkCurrentWeekEliminations();
                
                if (result.error) {
                    eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${result.error}</span>`;
                } else if (result.eliminatedCount > 0) {
                    eliminationResults.innerHTML = `<span class="text-red-600"> ${result.eliminatedCount} users eliminated this week!</span>
                        <div class="mt-2 text-xs">
                            ${result.details.map(e => {
                                if (e.pickedTeam === 'NO PICK') {
                                    return ` ${e.userId}: <span class="text-orange-600">No pick made</span>`;
                                } else {
                                    return ` ${e.userId}: Picked ${e.pickedTeam}, ${e.winningTeam} won`;
                                }
                            }).join('<br>')}
                        </div>`;
                    // Refresh survivor status display
                    const weekNumber = parseInt(document.getElementById('admin-week-selector')?.value) || getCurrentNflWeek();
                    await renderSurvivorStatus(weekNumber);
                } else {
                    eliminationResults.innerHTML = `<span class="text-green-600"> No new eliminations found for current week</span>`;
                }
            } catch (error) {
                eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${error.message}</span>`;
                console.error('Error checking current week eliminations:', error);
            }
        });
    }
    
    if (checkAllWeeksBtn && !checkAllWeeksBtn._handlerAttached) {
        checkAllWeeksBtn._handlerAttached = true;
        checkAllWeeksBtn.addEventListener('click', async () => {
            try {
                console.log(' Check All Weeks button clicked');
                eliminationResults.innerHTML = '<span class="text-blue-600"> Checking all weeks for eliminations (this may take a moment)...</span>';
                
                if (typeof window.SurvivorAutoElimination === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: SurvivorAutoElimination not loaded</span>';
                    return;
                }
                
                if (typeof db === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: Database not initialized</span>';
                    return;
                }
                
                const survivorElimination = new window.SurvivorAutoElimination(db, window.gameStateCache);
                const result = await survivorElimination.checkAllWeeksEliminations();
                
                if (result.error) {
                    eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${result.error}</span>`;
                } else if (result.totalEliminations > 0) {
                    // Group eliminations by week
                    const byWeek = {};
                    result.eliminatedUsers.forEach(e => {
                        if (!byWeek[e.week]) byWeek[e.week] = [];
                        byWeek[e.week].push(e);
                    });
                    
                    const weekSummaries = Object.keys(byWeek).sort((a, b) => a - b).map(week => {
                        const weekEliminations = byWeek[week];
                        return `<strong>Week ${week}:</strong> ${weekEliminations.length} eliminated<br>` +
                            weekEliminations.map(e => {
                                if (e.pickedTeam === 'NO PICK') {
                                    return `   ${e.userId}: <span class="text-orange-600">No pick made</span>`;
                                } else {
                                    return `   ${e.userId}: Picked ${e.pickedTeam}, ${e.winningTeam} won`;
                                }
                            }).join('<br>');
                    }).join('<br>');
                    
                    eliminationResults.innerHTML = `<span class="text-red-600"> ${result.totalEliminations} total eliminations across all weeks!</span>
                        <div class="mt-2 text-xs max-h-64 overflow-y-auto">
                            ${weekSummaries}
                        </div>`;
                    
                    // Refresh survivor status display
                    const weekNumber = parseInt(document.getElementById('admin-week-selector')?.value) || getCurrentNflWeek();
                    await renderSurvivorStatus(weekNumber);
                } else {
                    eliminationResults.innerHTML = '<span class="text-green-600"> No eliminations found across all weeks</span>';
                }
            } catch (error) {
                eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${error.message}</span>`;
                console.error('Error checking all weeks eliminations:', error);
            }
        });
    }
    
    if (checkSpecificUserBtn && !checkSpecificUserBtn._handlerAttached) {
        checkSpecificUserBtn._handlerAttached = true;
        checkSpecificUserBtn.addEventListener('click', async () => {
            const userId = prompt('Enter User ID to check (e.g. BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2):');
            if (!userId) return;
            
            try {
                console.log(' Check Specific User button clicked for:', userId);
                eliminationResults.innerHTML = `<span class="text-blue-600"> Checking user ${userId}...</span>`;
                
                if (typeof window.SurvivorAutoElimination === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: SurvivorAutoElimination not loaded</span>';
                    return;
                }
                
                if (typeof db === 'undefined') {
                    eliminationResults.innerHTML = '<span class="text-red-600"> Error: Database not initialized</span>';
                    return;
                }
                
                const survivorElimination = new window.SurvivorAutoElimination(db, window.gameStateCache);
                const result = await survivorElimination.checkSpecificUser(userId);
                
                if (result.error) {
                    eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${result.error}</span>`;
                } else {
                    const statusText = result.needsFix ? 
                        (result.shouldBeEliminated ? 'Should be eliminated but is marked as active' : 'Marked as eliminated but should be active') :
                        (result.shouldBeEliminated ? 'Correctly marked as eliminated' : 'Correctly marked as active');
                    
                    const statusColor = result.needsFix ? 'text-red-600' : 'text-green-600';
                    const statusIcon = result.needsFix ? '' : '';
                    
                    eliminationResults.innerHTML = `
                        <div class="${statusColor}">${statusIcon} ${statusText}</div>
                        <div class="mt-2 text-xs">
                            <strong>Current Status:</strong> ${result.currentStatus?.eliminated ? `Eliminated (Week ${result.currentStatus.eliminatedWeek})` : 'Active'}<br>
                            <strong>Should Be:</strong> ${result.shouldBeEliminated ? `Eliminated (Week ${result.eliminationWeek})` : 'Active'}<br>
                            <strong>Pick History:</strong> ${result.userResults.length} weeks with results<br>
                            ${result.userResults.map(r => `Week ${r.week}: ${r.result} (${r.pickedTeam} vs ${r.winner})`).join('<br>')}
                        </div>
                    `;
                }
            } catch (error) {
                eliminationResults.innerHTML = `<span class="text-red-600"> Error: ${error.message}</span>`;
                console.error('Error checking specific user:', error);
            }
        });
    }
}

// --- NFL TEAM HELMETS ---
// Helper function to get helmet CSS class from team name
function getHelmetClass(teamName) {
    const teamMap = {
        "Arizona Cardinals": "helmet-ari",
        "Atlanta Falcons": "helmet-atl",
        "Baltimore Ravens": "helmet-bal",
        "Buffalo Bills": "helmet-buf",
        "Carolina Panthers": "helmet-car",
        "Chicago Bears": "helmet-chi",
        "Cincinnati Bengals": "helmet-cin",
        "Cleveland Browns": "helmet-cle",
        "Dallas Cowboys": "helmet-dal",
        "Denver Broncos": "helmet-den",
        "Detroit Lions": "helmet-det",
        "Green Bay Packers": "helmet-gb",
        "Houston Texans": "helmet-hou",
        "Indianapolis Colts": "helmet-ind",
        "Jacksonville Jaguars": "helmet-jax",
        "Kansas City Chiefs": "helmet-kc",
        "Las Vegas Raiders": "helmet-lv",
        "Los Angeles Chargers": "helmet-lac",
        "Los Angeles Rams": "helmet-lar",
        "Miami Dolphins": "helmet-mia",
        "Minnesota Vikings": "helmet-min",
        "New England Patriots": "helmet-ne",
        "New Orleans Saints": "helmet-no",
        "New York Giants": "helmet-nyg",
        "New York Jets": "helmet-nyj",
        "Philadelphia Eagles": "helmet-phi",
        "Pittsburgh Steelers": "helmet-pit",
        "San Francisco 49ers": "helmet-sf",
        "Seattle Seahawks": "helmet-sea",
        "Tampa Bay Buccaneers": "helmet-tb",
        "Tennessee Titans": "helmet-ten",
        "Washington Commanders": "helmet-was"
    };
    return teamMap[teamName] || "";
}

// DEPRECATED: TEAM_HELMETS removed - now using CSS classes with getHelmetClass

// --- SYSTEM MESSENGER FUNCTIONS ---
async function renderSystemMessenger(weekNumber) {
    // Initialize recipient selection
    updateRecipientSelection();
    
    // Set up event listeners
    setupSystemMessengerListeners();
}

function setupSystemMessengerListeners() {
    // Prevent duplicate listeners
    if (allUI.messageRecipients.hasSystemMessengerListeners) return;
    
    // Recipient selection change
    allUI.messageRecipients.addEventListener('change', (e) => {
        const recipientType = e.target.value;
        
        if (recipientType === 'custom') {
            allUI.customUsersSection.classList.remove('hidden');
            loadCustomUsersList();
        } else {
            allUI.customUsersSection.classList.add('hidden');
        }
        
        updateRecipientCount();
    });
    
    // Preview button
    allUI.previewMessageBtn.addEventListener('click', previewMessage);
    
    // Send button
    allUI.sendMessageBtn.addEventListener('click', sendSystemMessage);
    
    // Subject and body change to enable/disable send button
    [allUI.messageSubject, allUI.messageBody].forEach(element => {
        element.addEventListener('input', () => {
            const hasSubject = allUI.messageSubject.value.trim().length > 0;
            const hasBody = allUI.messageBody.value.trim().length > 0;
            allUI.sendMessageBtn.disabled = !(hasSubject && hasBody);
        });
    });
    
    // Mark as having listeners
    allUI.messageRecipients.hasSystemMessengerListeners = true;
}

async function loadCustomUsersList() {
    //  DIAMOND FIX: Use proper deduplication instead of broken loadUsers()!
    allUsers = await fetchAllUsers();
    
    showMessageStatus(' Diamond Level: Checking notifications in single query...', 'info');
    
    // Diamond Level: Single collectionGroup query instead of N individual queries
    const usersWithNotifications = [];
    const usersWithoutNotifications = [];
    const userIdSet = new Set(allUsers.map(u => u.id));
    
    try {
        // Try single collectionGroup query first (Diamond Level optimization)
        try {
            const allTokensSnapshot = await getDocs(collectionGroup(db, 'fcm_tokens'));
            const usersWithTokens = new Set();
            
            allTokensSnapshot.forEach(doc => {
                const userId = doc.ref.parent.parent.id; // Extract user ID from path
                if (userIdSet.has(userId)) {
                    usersWithTokens.add(userId);
                }
            });
            
            allUsers.forEach(user => {
                if (usersWithTokens.has(user.id)) {
                    usersWithNotifications.push(user);
                } else {
                    usersWithoutNotifications.push(user);
                }
            });
            
            console.log(' Diamond Level: Single query loaded custom users list successfully');
        } catch (collectionGroupError) {
            console.log(' CollectionGroup not available, using batched queries:', collectionGroupError);
            // Fallback: Batch all queries in parallel instead of sequential
            const snapshots = await Promise.all(allUsers.map(user => 
                getDocs(collection(db, `users/${user.id}/fcm_tokens`))
            ));
            
            snapshots.forEach((snapshot, index) => {
                const user = allUsers[index];
                if (!snapshot.empty) {
                    usersWithNotifications.push(user);
                } else {
                    usersWithoutNotifications.push(user);
                }
            });
            console.log(' Diamond Level: Batched parallel queries completed for custom users');
        }
    } catch (error) {
        console.error(' Diamond Level custom users failed, falling back to individual queries:', error);
        // Final fallback to original method if needed
        for (const user of allUsers) {
            try {
                const tokensSnapshot = await getDocs(collection(db, `users/${user.id}/fcm_tokens`));
                if (!tokensSnapshot.empty) {
                    usersWithNotifications.push(user);
                } else {
                    usersWithoutNotifications.push(user);
                }
            } catch (error) {
                console.log(`Could not check FCM tokens for ${user.email}:`, error);
                usersWithoutNotifications.push(user);
            }
        }
    }
    
    console.log(` Users with notifications: ${usersWithNotifications.length}, without: ${usersWithoutNotifications.length}`);
    
    if (usersWithNotifications.length === 0) {
        allUI.customUsersList.innerHTML = `
            <div class="text-center py-4">
                <p class="text-gray-500 text-sm"> No users have enabled push notifications yet.</p>
                <p class="text-gray-400 text-xs mt-1">Users must visit the website and enable notifications first.</p>
            </div>
        `;
        return;
    }
    
    const customUsersHtml = usersWithNotifications.map(user => `
        <div class="flex items-center py-1">
            <input type="checkbox" id="user-${user.id}" value="${user.id}" class="custom-user-checkbox mr-3">
            <label for="user-${user.id}" class="text-sm">
                 ${user.displayName || user.email}
            </label>
        </div>
    `).join('');
    
    // Add summary info
    const summaryHtml = `
        <div class="mb-4 p-3 bg-sky-50 border border-sky-200 rounded-md">
            <p class="text-sm text-sky-800">
                 <strong>${usersWithNotifications.length}</strong> users have notifications enabled
            </p>
            ${usersWithoutNotifications.length > 0 ? `
                <p class="text-xs text-sky-600 mt-1">
                    ${usersWithoutNotifications.length} users haven't enabled notifications yet
                </p>
            ` : ''}
        </div>
    `;
    
    allUI.customUsersList.innerHTML = summaryHtml + customUsersHtml;
    
    // Add event listeners to checkboxes
    allUI.customUsersList.querySelectorAll('.custom-user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateRecipientCount);
    });
    
    // Clear status
    showMessageStatus('', 'info');
}

async function getFilteredRecipients(recipientType, weekNumber) {
    //  DIAMOND FIX: Use proper deduplication instead of broken loadUsers()!
    if (!allUsers || allUsers.length === 0) {
        allUsers = await fetchAllUsers();
    }
    
    console.log(' getFilteredRecipients called with:', {recipientType, weekNumber, totalUsers: allUsers.length});
    
    switch (recipientType) {
        case 'all':
            console.log(' Returning ALL users:', allUsers.length);
            return allUsers;
            
        case 'no-picks':
            console.log(` User picks filtering optimization - fetching all picks for week ${weekNumber} in 1 query`);
            const usersWithoutPicks = [];
            
            //  DIAMOND LEVEL: Single collection query instead of N individual getDoc calls
            const allPicksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
            const userPicksMap = {};
            
            // Create lookup map of existing picks
            allPicksSnap.forEach(doc => {
                const docData = doc.data();
                userPicksMap[doc.id] = docData.picks || docData; // Handle both data structures
            });
            
            // Get games once for the week
            const games = await getGamesForWeek(weekNumber);
            
            // Check each user for missing picks
            for (const user of allUsers) {
                const picks = userPicksMap[user.id] || {};
                const hasAllPicks = games.every(game => picks[game.id]);
                
                if (!hasAllPicks) {
                    usersWithoutPicks.push(user);
                }
            }
            return usersWithoutPicks;
            
        case 'top-3':
            // Calculate weekly leaderboard and get top 3
            const weeklyScores = await calculateWeeklyLeaderboard(weekNumber);
            const topThreeUserIds = weeklyScores.slice(0, 3).map(score => score.userId);
            return allUsers.filter(user => topThreeUserIds.includes(user.id));
            
        case 'custom':
            const selectedCheckboxes = allUI.customUsersList.querySelectorAll('.custom-user-checkbox:checked');
            const selectedUserIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            const filteredUsers = allUsers.filter(user => selectedUserIds.includes(user.id));
            
            console.log(' CUSTOM selection:', {
                checkboxesFound: selectedCheckboxes.length,
                selectedUserIds: selectedUserIds,
                filteredUsers: filteredUsers.length,
                userEmails: filteredUsers.map(u => u.email)
            });
            
            return filteredUsers;
            
        default:
            return [];
    }
}

async function updateRecipientCount() {
    const weekNumber = allUI.adminWeekSelector ? allUI.adminWeekSelector.value : getCurrentNflWeek();
    const recipientType = allUI.messageRecipients.value;
    const recipients = await getFilteredRecipients(recipientType, weekNumber);
    allUI.recipientCountNumber.textContent = recipients.length;
}

function updateRecipientSelection() {
    // Update recipient count initially
    updateRecipientCount();
}

async function previewMessage() {
    const subject = allUI.messageSubject.value.trim();
    const body = allUI.messageBody.value.trim();
    
    if (!subject || !body) {
        showMessageStatus('Please enter both subject and message body.', 'error');
        return;
    }
    
    // Sample user for preview
    const sampleUser = allUsers && allUsers.length > 0 ? allUsers[0] : { displayName: 'Sample User' };
    const formattedEmail = formatSystemEmail(sampleUser, subject, body);
    
    allUI.messagePreview.textContent = formattedEmail;
    allUI.messagePreviewSection.classList.remove('hidden');
}

async function sendSystemMessage() {
    // Check if user is authenticated
    if (!currentUser || !auth.currentUser) {
        showMessageStatus('You must be logged in to send messages.', 'error');
        return;
    }
    
    // Check if user is admin
    const ADMIN_UIDS = ['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2'];
    if (!ADMIN_UIDS.includes(currentUser.uid)) {
        showMessageStatus('Access denied: Admin privileges required.', 'error');
        return;
    }
    
    const title = allUI.messageSubject.value.trim();
    const body = allUI.messageBody.value.trim();
    
    if (!title || !body) {
        showMessageStatus('Please enter both title and message body.', 'error');
        return;
    }
    
    const weekNumber = allUI.adminWeekSelector ? allUI.adminWeekSelector.value : getCurrentNflWeek();
    const recipientType = allUI.messageRecipients.value;
    
    console.log(' FCM Debug - recipientType:', recipientType, 'weekNumber:', weekNumber);
    
    showMessageStatus(' Preparing to send push notifications...', 'info');
    allUI.sendMessageBtn.disabled = true;
    
    try {
        // Get recipients and their FCM tokens
        const recipients = await getFilteredRecipients(recipientType, weekNumber);
        
        console.log(' FCM Debug - recipients found:', recipients.length, recipients.map(r => r.email));
        
        if (recipients.length === 0) {
            showMessageStatus('No recipients found for the selected criteria.', 'error');
            allUI.sendMessageBtn.disabled = false;
            return;
        }
        
        showMessageStatus(` Diamond Level: Collecting FCM tokens from ${recipients.length} users in single query...`, 'info');
        
        // Diamond Level: Single collectionGroup query instead of N individual queries
        const fcmTokens = [];
        const usersWithoutTokens = [];
        const usersWithTokens = [];
        const userIdSet = new Set(recipients.map(r => r.id));
        
        try {
            // Try single collectionGroup query first (Diamond Level optimization)
            try {
                const allTokensSnapshot = await getDocs(collectionGroup(db, 'fcm_tokens'));
                const userTokenMap = new Map();
                
                allTokensSnapshot.forEach(doc => {
                    const tokenData = doc.data();
                    const userId = doc.ref.parent.parent.id; // Extract user ID from path
                    
                    if (tokenData.token && userIdSet.has(userId)) {
                        fcmTokens.push(tokenData.token);
                        userTokenMap.set(userId, true);
                    }
                });
                
                recipients.forEach(user => {
                    if (userTokenMap.has(user.id)) {
                        usersWithTokens.push(user.displayName || user.email);
                    } else {
                        usersWithoutTokens.push(user.displayName || user.email);
                    }
                });
                
                console.log(' Diamond Level: Single query collected tokens successfully');
            } catch (collectionGroupError) {
                console.log(' CollectionGroup not available, using batched queries:', collectionGroupError);
                // Fallback: Batch all queries in parallel instead of sequential
                const snapshots = await Promise.all(recipients.map(user => 
                    getDocs(collection(db, `users/${user.id}/fcm_tokens`))
                ));
                
                snapshots.forEach((snapshot, index) => {
                    const user = recipients[index];
                    if (!snapshot.empty) {
                        let userHasTokens = false;
                        snapshot.forEach(doc => {
                            const tokenData = doc.data();
                            if (tokenData.token) {
                                fcmTokens.push(tokenData.token);
                                userHasTokens = true;
                            }
                        });
                        if (userHasTokens) {
                            usersWithTokens.push(user.displayName || user.email);
                        } else {
                            usersWithoutTokens.push(user.displayName || user.email);
                        }
                    } else {
                        usersWithoutTokens.push(user.displayName || user.email);
                    }
                });
                console.log(' Diamond Level: Batched parallel queries completed');
            }
        } catch (error) {
            console.error(' Diamond Level FCM collection failed, falling back to individual queries:', error);
            // Fallback to original method if needed
            for (const user of recipients) {
                try {
                    const tokensSnapshot = await getDocs(collection(db, `users/${user.id}/fcm_tokens`));
                    if (!tokensSnapshot.empty) {
                        let userHasTokens = false;
                        tokensSnapshot.forEach(doc => {
                            const tokenData = doc.data();
                            if (tokenData.token) {
                                fcmTokens.push(tokenData.token);
                                userHasTokens = true;
                            }
                        });
                        if (userHasTokens) {
                            usersWithTokens.push(user.displayName || user.email);
                        }
                    } else {
                        usersWithoutTokens.push(user.displayName || user.email);
                    }
                } catch (error) {
                    console.log(`Could not get FCM tokens for ${user.email}:`, error);
                    usersWithoutTokens.push(user.displayName || user.email);
                }
            }
        }
        
        console.log(' FCM Token Collection Results:', {
            totalRecipients: recipients.length,
            usersWithTokens: usersWithTokens.length, 
            usersWithoutTokens: usersWithoutTokens.length,
            totalTokens: fcmTokens.length,
            recipientEmails: recipients.map(r => r.email),
            usersWithTokensNames: usersWithTokens,
            usersWithoutTokensNames: usersWithoutTokens
        });
        
        if (fcmTokens.length === 0) {
            showMessageStatus(' No users have enabled push notifications yet. Ask users to enable notifications on the website first.', 'warning');
            allUI.sendMessageBtn.disabled = false;
            return;
        }
        
        // Show status of who will receive notifications
        const statusMsg = ` Sending to ${fcmTokens.length} users with notifications enabled` + 
                         (usersWithoutTokens.length > 0 ? ` (${usersWithoutTokens.length} users haven't enabled notifications)` : '');
        showMessageStatus(statusMsg, 'info');
        
        // Call FCM Cloud Function
        const sendFCMSystemMessageFn = httpsCallable(functions, 'sendFCMSystemMessage');
        
        // Refresh auth token
        const idToken = await auth.currentUser.getIdToken(true);
        
        const result = await sendFCMSystemMessageFn({
            title: title,
            body: body,
            targetTokens: fcmTokens,
            priority: 'normal',
            clickAction: '/'
        });
        
        console.log('FCM notification sent successfully:', result);
        
        const { successCount, failureCount } = result.data;
        
        let message = ` Successfully sent ${successCount} push notification${successCount !== 1 ? 's' : ''}.`;
        
        if (failureCount > 0) {
            message += `\n ${failureCount} notification${failureCount !== 1 ? 's' : ''} failed to deliver.`;
        }
        
        if (usersWithoutTokens.length > 0) {
            message += `\n\n Users without notifications enabled (${usersWithoutTokens.length}): ${usersWithoutTokens.slice(0, 5).join(', ')}${usersWithoutTokens.length > 5 ? '...' : ''}`;
        }
        
        showMessageStatus(message, failureCount > 0 ? 'warning' : 'success');
        
        // Clear form
        allUI.messageSubject.value = '';
        allUI.messageBody.value = '';
        allUI.messagePreviewSection.classList.add('hidden');
        
    } catch (error) {
        console.error('Error sending FCM notifications:', error);
        showMessageStatus(` Error sending notifications: ${error.message}`, 'error');
    } finally {
        allUI.sendMessageBtn.disabled = false;
    }
}

function formatSystemEmail(user, subject, body) {
    const displayName = user.displayName || 'Nerd';
    
    return `Dear Nerd ${displayName},

${body}

llfther Nerd

---
This message was sent from NerdFootball AI System
Reply to: hello@nerdfootball.com`;
}

function showMessageStatus(message, type) {
    const statusColors = {
        'success': 'bg-green-100 text-green-800 border border-green-200',
        'error': 'bg-red-100 text-red-800 border border-red-200',
        'warning': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        'info': 'bg-blue-100 text-blue-800 border border-blue-200'
    };
    
    allUI.messageStatusContent.className = `p-4 rounded-md ${statusColors[type] || statusColors.info}`;
    allUI.messageStatusContent.textContent = message;
    allUI.messageStatus.classList.remove('hidden');
    
    // Auto-hide after 10 seconds for success/info
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            allUI.messageStatus.classList.add('hidden');
        }, 10000);
    }
}

async function calculateWeeklyLeaderboard(weekNumber) {
    // Get game results using the correct Firestore pattern
    const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
    const results = resultsSnap.exists() ? resultsSnap.data() : {};
    
    if (!results || Object.keys(results).length === 0) {
        console.log(`No results found for week ${weekNumber} - skipping leaderboard calculation`);
        return [];
    }
    
    const scores = [];
    
    //  DIAMOND LEVEL: Single collection query instead of N individual getDoc calls
    console.log(` Optimized leaderboard calculation - fetching all picks for week ${weekNumber} in 1 query`);
    const allPicksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
    
    // Create map of user picks for fast lookup
    const userPicksMap = {};
    allPicksSnap.forEach(doc => {
        const docData = doc.data();
        userPicksMap[doc.id] = docData.picks || docData; // Handle both old and new data structures
    });
    
    // Calculate scores for all users
    for (const user of allUsers) {
        const userPicks = userPicksMap[user.id] || {};
        let score = 0;
        
        Object.keys(results).forEach(gameId => {
            const result = results[gameId];
            const pick = userPicks[gameId];
            
            if (pick && pick.team === result.winner) {
                score += pick.confidence || 1;
            }
        });
        
        scores.push({
            userId: user.id,
            displayName: user.displayName || user.email,
            score: score
        });
    }
    
    return scores.sort((a, b) => b.score - a.score);
}


 async function renderAdminView(weekNumber) {
 const activeTab = document.querySelector('.admin-tab.active').id;
 switch (activeTab) {
 case 'tab-game-results': await renderGameResultsAdmin(weekNumber); break;
 case 'tab-user-mgmt': await renderUserManagement(); break;
 case 'tab-picks-mgmt': await renderPicksManagement(weekNumber); break;
 case 'tab-survivor-status': await renderSurvivorStatus(weekNumber); break;
case 'tab-system-messenger': await renderSystemMessenger(weekNumber); break;
case 'tab-analytics': await renderAnalytics(weekNumber); break;
 }
 }

// --- ANALYTICS FUNCTIONALITY ---
let analyticsClient = null;
let analyticsUI = null;

async function renderAnalytics(weekNumber) {
    const loadingEl = document.getElementById('analytics-loading');
    const errorEl = document.getElementById('analytics-error');
    const contentEl = document.getElementById('analytics-content');

    // Show loading state
    loadingEl.classList.remove('hidden');
    errorEl.classList.add('hidden');
    contentEl.classList.add('hidden');

    try {
        // Initialize analytics client if not already done
        if (!analyticsClient) {
            analyticsClient = new PickAnalyticsClient(functions, getCurrentPool());
            analyticsUI = new PickAnalyticsUI(analyticsClient);
        }

        // Fetch analytics data
        const result = await analyticsClient.getWeeklyAnalytics(weekNumber);
        
        if (!result.success) {
            throw new Error(result.error);
        }

        const data = result.data;
        
        // Update summary statistics
        document.getElementById('analytics-total-games').textContent = data.metadata?.uniqueGames || 0;
        document.getElementById('analytics-total-picksets').textContent = data.totalPicksets || 0;
        
        // Calculate consensus and contrarian games
        let consensusGames = 0;
        let contrarianGames = 0;
        
        Object.values(data.gameAnalytics || {}).forEach(gameData => {
            if (gameData.popularityScore >= 70) consensusGames++;
            if (gameData.contrarian?.score >= 30) contrarianGames++;
        });
        
        document.getElementById('analytics-consensus-games').textContent = consensusGames;
        document.getElementById('analytics-contrarian-games').textContent = contrarianGames;

        // Render games table
        renderAnalyticsGamesTable(data.gameAnalytics);

        // Render user clusters
        renderAnalyticsClusters(data.pickClusters);

        // Render confidence analysis
        renderAnalyticsConfidence(data.confidenceAnalytics);

        // Update last updated timestamp
        if (data.metadata?.lastUpdated) {
            const timestamp = data.metadata.lastUpdated.seconds 
                ? new Date(data.metadata.lastUpdated.seconds * 1000)
                : new Date(data.metadata.lastUpdated);
            document.getElementById('analytics-last-updated').textContent = timestamp.toLocaleString();
        }

        // Hide loading, show content
        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');

    } catch (error) {
        console.error('Error rendering analytics:', error);
        
        // Show error state
        loadingEl.classList.add('hidden');
        document.getElementById('analytics-error-message').textContent = error.message;
        errorEl.classList.remove('hidden');
    }
}

function renderAnalyticsGamesTable(gameAnalytics) {
    const tableBody = document.getElementById('analytics-games-table');
    tableBody.innerHTML = '';

    if (!gameAnalytics || Object.keys(gameAnalytics).length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-slate-500">
                    No analytics data available for this week
                </td>
            </tr>
        `;
        return;
    }

    Object.entries(gameAnalytics).forEach(([gameId, gameData]) => {
        const row = document.createElement('tr');
        
        // Format team percentages for display
        const teamPercentagesHtml = analyticsUI.formatTeamPercentages(gameId, gameData.teamPercentages, gameData.totalPicks);
        
        // Confidence badge color
        const avgConf = gameData.confidenceStats?.average || 0;
        const confColor = avgConf >= 12 ? 'text-green-600 bg-green-100' : 
                         avgConf <= 6 ? 'text-red-600 bg-red-100' : 
                         'text-yellow-600 bg-yellow-100';
        
        // Popularity badge color
        const popColor = gameData.popularityScore >= 70 ? 'text-purple-600 bg-purple-100' : 
                        gameData.popularityScore <= 30 ? 'text-orange-600 bg-orange-100' : 
                        'text-blue-600 bg-blue-100';

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                Game ${gameId}
                <div class="text-xs text-slate-500">${gameData.totalPicks} picks</div>
            </td>
            <td class="px-6 py-4 text-sm text-slate-900">
                ${teamPercentagesHtml}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${confColor}">
                    ${avgConf.toFixed(1)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${popColor}">
                    ${gameData.popularityScore}%
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                ${gameData.contrarian?.score || 0}%
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function renderAnalyticsClusters(pickClusters) {
    const container = document.getElementById('analytics-clusters-content');
    
    if (!pickClusters) {
        container.innerHTML = '<div class="text-slate-500 text-center col-span-2">No cluster data available</div>';
        return;
    }
    
    container.innerHTML = analyticsUI.formatPickClusters(pickClusters);
}

function renderAnalyticsConfidence(confidenceAnalytics) {
    const highConfidenceEl = document.getElementById('analytics-high-confidence');
    const lowConfidenceEl = document.getElementById('analytics-low-confidence');

    if (!confidenceAnalytics || !confidenceAnalytics.extremes) {
        highConfidenceEl.innerHTML = '<div class="text-slate-500">No data available</div>';
        lowConfidenceEl.innerHTML = '<div class="text-slate-500">No data available</div>';
        return;
    }

    // Render high confidence games
    const highConfGames = confidenceAnalytics.extremes.highestConfidence || [];
    if (highConfGames.length === 0) {
        highConfidenceEl.innerHTML = '<div class="text-slate-500">No high confidence games</div>';
    } else {
        highConfidenceEl.innerHTML = highConfGames.map(game => `
            <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                <span class="text-sm">Game ${game.gameId}</span>
                <span class="text-sm font-semibold text-green-600">${game.average.toFixed(1)} avg</span>
            </div>
        `).join('');
    }

    // Render low confidence games
    const lowConfGames = confidenceAnalytics.extremes.lowestConfidence || [];
    if (lowConfGames.length === 0) {
        lowConfidenceEl.innerHTML = '<div class="text-slate-500">No low confidence games</div>';
    } else {
        lowConfidenceEl.innerHTML = lowConfGames.map(game => `
            <div class="flex justify-between items-center p-2 bg-red-50 rounded">
                <span class="text-sm">Game ${game.gameId}</span>
                <span class="text-sm font-semibold text-red-600">${game.average.toFixed(1)} avg</span>
            </div>
        `).join('');
    }
}

// Event listeners for analytics buttons
document.addEventListener('DOMContentLoaded', () => {
    const refreshBtn = document.getElementById('refresh-analytics-btn');
    const exportBtn = document.getElementById('export-analytics-btn');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            const weekNumber = parseInt(document.getElementById('admin-week-selector')?.value) || getCurrentNflWeek();
            
            if (analyticsClient) {
                // Force recalculation
                const result = await analyticsClient.recalculateAnalytics(weekNumber);
                if (result.success) {
                    await renderAnalytics(weekNumber);
                } else {
                    console.error('Failed to refresh analytics:', result.error);
                }
            }
        });
    }

    if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
            const weekNumber = parseInt(document.getElementById('admin-week-selector')?.value) || getCurrentNflWeek();
            
            try {
                const result = await analyticsClient.getWeeklyAnalytics(weekNumber);
                if (result.success) {
                    downloadAnalyticsCSV(result.data, weekNumber);
                } else {
                    console.error('Failed to export analytics:', result.error);
                }
            } catch (error) {
                console.error('Error exporting analytics:', error);
            }
        });
    }
});

function downloadAnalyticsCSV(data, weekNumber) {
    const rows = [
        ['Game ID', 'Team 1', 'Team 1 %', 'Team 2', 'Team 2 %', 'Total Picks', 'Avg Confidence', 'Popularity Score', 'Contrarian %']
    ];

    Object.entries(data.gameAnalytics || {}).forEach(([gameId, gameData]) => {
        const teams = Object.keys(gameData.teamPercentages || {});
        const team1 = teams[0] || 'N/A';
        const team2 = teams[1] || 'N/A';
        const team1Pct = gameData.teamPercentages?.[team1]?.percentage || 0;
        const team2Pct = gameData.teamPercentages?.[team2]?.percentage || 0;

        rows.push([
            gameId,
            team1,
            team1Pct,
            team2,
            team2Pct,
            gameData.totalPicks || 0,
            (gameData.confidenceStats?.average || 0).toFixed(1),
            gameData.popularityScore || 0,
            gameData.contrarian?.score || 0
        ]);
    });

    const csvContent = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-week-${weekNumber}-${getCurrentPool()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

 // --- INITIALIZATION & AUTH ---
 async function initializeAppAndAuth() {
 console.log(' initializeAppAndAuth started');
 const firebaseConfig = {
 apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
 authDomain: "nerdfootball.firebaseapp.com",
 databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
 projectId: "nerdfootball",
 storageBucket: "nerdfootball.appspot.com",
 messagingSenderId: "969304790725",
 appId: "1:969304790725:web:892df38db0b0e62bde02ac",
 measurementId: "G-8RVRHE3HRC"
 };
 const app = initializeApp(firebaseConfig);
 window.firebaseApp = app; // Make Firebase app globally available for FCM
 db = getFirestore(app);
 window.db = db; // Make Firestore globally available for FCM
 // Make Firestore functions globally available for ESPN Score Sync
 window.getDoc = getDoc;
 window.setDoc = setDoc;
 window.doc = doc;
 window.updateDoc = updateDoc;
 window.deleteDoc = deleteDoc;
 window.runTransaction = runTransaction;
 
 // PHAROAH'S REALTIME INTEGRATION - Initialize Firebase RTDB for WebSocket features
 const rtdb = getDatabase(app);
 window.rtdb = rtdb; // Make RTDB globally available for RealTimeManager
 window.dbRef = ref;
 window.onValue = onValue;
 window.set = set;
 window.push = push;
 window.serverTimestamp = rtdbServerTimestamp;
 console.log(' Firebase RTDB initialized for real-time features');
 
 auth = getAuth(app);
 window.auth = auth; // Make Auth globally available for FCM
 functions = getFunctions(app, 'us-central1'); // Initialize global functions variable with region
 window.functions = functions; // Make Functions globally available
 window.httpsCallable = httpsCallable; // Make httpsCallable globally available for analytics
 
 // Initialize Firebase Messaging - Diamond Level
 try {
     const messaging = getMessaging(app);
     // Make messaging available to compatibility mode
     if (!window.firebase) window.firebase = {};
     window.firebase.messaging = () => messaging;
     console.log(' Firebase messaging initialized for FCM compatibility');
 } catch (error) {
     console.warn('Firebase messaging initialization failed:', error);
 }
 onAuthStateChanged(auth, handleAuthStateChange);
console.log(' onAuthStateChanged listener set up');

// Check for invite code on page load
checkForInviteCode();
 
 // Register service worker for caching - temporarily disabled for debugging
 // if ('serviceWorker' in navigator) {
 //  navigator.serviceWorker.register('/sw.js')
 //   .then(registration => {
 //    console.log('ServiceWorker registration successful');
 //    
 //    // Check for updates every 30 seconds
 //    setInterval(() => {
 //     registration.update();
 //    }, 30000);
 //    
 //    // Listen for new service worker
 //    registration.addEventListener('updatefound', () => {
 //     const newWorker = registration.installing;
 //     newWorker.addEventListener('statechange', () => {
 //      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
 //       // New version available, prompt user to refresh
 //       if (confirm('New version available! Click OK to update.')) {
 //        newWorker.postMessage({ type: 'SKIP_WAITING' });
 //        window.location.reload();
 //       }
 //      }
 //     });
 //    });
 //   })
 //   .catch(error => console.log('ServiceWorker registration failed: ', error));
 // }
 }

 // Flag to prevent URL updates during initial page load
let isInitialLoad = true;

async function handleAuthStateChange(user) {
 console.log(' handleAuthStateChange called with user:', user ? user.uid : 'null');
 // Validate pool isolation on auth state change
 if (user) {
   setTimeout(() => {
     validatePoolIsolation();
     updatePoolNameDisplay();
   }, 1000);
 }
 
 const savedState = loadAppState();
 
 if (user) {
 // Store previous access time before updating to current
 const currentLastAccess = localStorage.getItem('lastAccess');
 if (currentLastAccess) {
   localStorage.setItem('previousAccess', currentLastAccess);
 }
 localStorage.setItem('lastAccess', new Date().toISOString());
 
 const userDocRef = doc(db, `${usersPath()}/${user.uid}`);
 const userDoc = await getDoc(userDocRef);

 if (userDoc.exists() && userDoc.data().disabled) {
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.remove('hidden');
 allUI.loginError.textContent = 'Your account has been disabled.';
 allUI.loginError.classList.remove('hidden');
 await signOut(auth);
 return;
 }
 
 // Check if email was recently verified and update Firestore
 const pendingEmail = localStorage.getItem('pendingEmailChange');
 if (pendingEmail && user.email === pendingEmail) {
  try {
   await updateDoc(userDocRef, {
    email: user.email,
    emailVerified: true,
    lastUpdated: new Date().toISOString()
   });
   localStorage.removeItem('pendingEmailChange');
   console.log('Email verification completed and Firestore updated');
  } catch (error) {
   console.error('Error updating email in Firestore after verification:', error);
  }
 }
 
 currentUser = user;
 currentWeek = savedState.currentWeek;

 // Load user pool memberships
 await loadUserPoolMemberships();
 
 // Initialize Pool Participation Manager and run migration
 if (typeof poolParticipationManager !== 'undefined') {
   await poolParticipationManager.initialize(db);
   
   // Run migration for existing users (one-time)
   const migrationResult = await poolParticipationManager.migrateExistingMembers();
   if (migrationResult.migrated > 0) {
     console.log(` Migrated ${migrationResult.migrated} users to participation structure`);
   }
 }
 
 // Initialize Pool Removal Service for cascading operations
 if (typeof poolRemovalService !== 'undefined') {
   await poolRemovalService.initialize(db);
   console.log(' Pool Removal Service ready for cascading operations');
 }
 
 await initializePoolSwitcher();
 
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.add('hidden');
 allUI.appView.classList.remove('hidden');
 allUI.userDisplay.textContent = `Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;

 await setDoc(userDocRef, { displayName: user.displayName, email: user.email }, { merge: true });

 if (ADMIN_UIDS.includes(user.uid)) {
 allUI.menuAdminControls.classList.remove('hidden');
 // Show admin-only buttons
 document.getElementById('delete-pool-section').style.display = 'flex';
 document.getElementById('survivor-admin-panel-btn').style.display = 'inline-block';
 await fetchAllUsers();
 showAdminMigrationTool();
 }
 
 populateWeekSelectors();
 allUI.weekDisplay.textContent = `Week ${currentWeek}`;
 updateWeekButtonStates();
 allUI.adminWeekSelector.value = currentWeek;
 allUI.lbWeekSelector.value = currentWeek;

 await loadAndRenderWeek(currentWeek);
 
 // Check for pending invite code after login
 const pendingInviteCode = localStorage.getItem('pendingInviteCode');
 if (pendingInviteCode) {
   localStorage.removeItem('pendingInviteCode');
   setTimeout(() => processInviteCode(pendingInviteCode), 1000); // Give UI time to load
 }
 
 if (ADMIN_UIDS.includes(user.uid)) {
 await renderAdminView(currentWeek);
 }

 // Restore saved view state
 if (savedState.leaderboardView === 'season') {
  allUI.lbSeasonBtn.click();
 }
 
 console.log(' URL state - currentView:', savedState.currentView);
console.log(' About to switch on view:', savedState.currentView);
switch (savedState.currentView) {
  case 'admin':
   if (ADMIN_UIDS.includes(user.uid)) {
    allUI.adminViewBtn.click();
   } else {
    allUI.picksViewBtn.click();
   }
   break;
  case 'leaderboard':
   allUI.leaderboardViewBtn.click();
   break;
  case 'grid':
   console.log(' Grid view requested - allUI.gridViewBtn:', !!allUI.gridViewBtn);
   if (allUI.gridViewBtn) {
     allUI.gridViewBtn.click();
   } else {
     console.error(' gridViewBtn not found - manually showing grid');
     // Manually show grid if button doesn't exist
     hideAllViews();
     allUI.gridContainer.classList.remove('hidden');
     populateGridWeekSelectors();
     renderGrid();
   }
   break;
  case 'survivor':
   SurvivorView.show();
   break;
  case 'survivor-picks':
   SurvivorPicksView.show();
   break;
  case 'rules':
   console.log(' Rules view not implemented in unified system - user should navigate directly');
   allUI.picksViewBtn.click(); // Fallback to picks view
   break;
  case 'picks':
  default:
   allUI.picksViewBtn.click();
 }

 // CRITICAL FIX: Allow URL updates after initial load is complete
 setTimeout(() => {
  isInitialLoad = false;
  console.log(' Initial load complete, URL updates now enabled');
 }, 2000);

 } else {
 currentUser = null;
 allUI.loadingView.classList.add('hidden');
 
 // Check if specific views should be shown even without authentication
 const savedState = loadAppState();
 if (savedState.currentView === 'survivor-picks') {
   console.log(' Showing survivor-picks view for unauthenticated user');
   allUI.loginView.classList.add('hidden');
   allUI.appView.classList.remove('hidden');
   SurvivorPicksView.show();
 } else {
   allUI.loginView.classList.remove('hidden');
   allUI.appView.classList.add('hidden');
 }
 }
 }
 
 // --- FORM TOGGLING ---
 allUI.showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); allUI.loginForm.classList.add('hidden'); allUI.registerForm.classList.remove('hidden'); });
 allUI.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); allUI.registerForm.classList.add('hidden'); allUI.loginForm.classList.remove('hidden'); });

 // --- AUTH EVENT LISTENERS ---
 allUI.loginForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const email = document.getElementById('login-email').value;
 const password = document.getElementById('login-password').value;
 try {
 await signInWithEmailAndPassword(auth, email, password);
 allUI.loginError.classList.add('hidden');
 } catch (error) {
 allUI.loginError.innerHTML = getAuthErrorMessage(error.code);
 allUI.loginError.classList.remove('hidden');
 }
 });

 allUI.registerForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const firstName = document.getElementById('register-firstname').value;
 const lastName = document.getElementById('register-lastname').value;
 const email = document.getElementById('register-email').value;
 const password = document.getElementById('register-password').value;
 const confirmPassword = document.getElementById('register-confirm-password').value;

 if (password !== confirmPassword) {
 allUI.registerError.textContent = "Passwords do not match.";
 allUI.registerError.classList.remove('hidden');
 return;
 }
 
 try {
 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
 await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
 allUI.registerError.classList.add('hidden');
 } catch (error) {
 allUI.registerError.innerHTML = getAuthErrorMessage(error.code);
 allUI.registerError.classList.remove('hidden');
 }
 });

 allUI.logoutBtn.addEventListener('click', () => {
    signOut(auth);
    allUI.menuPanel.classList.add('hidden');
 });

 // OAuth event listeners
 allUI.googleSigninBtn.addEventListener('click', handleGoogleSignIn);
 allUI.googleSignupBtn.addEventListener('click', handleGoogleSignIn);
 
 // Account linking modal event listeners
 allUI.cancelLinkingBtn.addEventListener('click', hideAccountLinkingDialog);
 allUI.confirmLinkingBtn.addEventListener('click', linkAccountWithGoogle);
 
 // Password prompt modal event listeners
 allUI.cancelPasswordPromptBtn.addEventListener('click', () => {
  hidePasswordPrompt();
  pendingCredential = null;
  pendingEmail = null;
 });
 allUI.confirmPasswordPromptBtn.addEventListener('click', async () => {
  const password = allUI.passwordPromptInput.value;
  if (password && pendingEmail) {
   await completeAccountLinking(pendingEmail, password);
  }
 });
 
 // Allow Enter key to submit password
 allUI.passwordPromptInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
   allUI.confirmPasswordPromptBtn.click();
  }
 });
 
 // In-app account linking event listeners
 allUI.linkGoogleBtn.addEventListener('click', linkGoogleAccountInApp);
 allUI.unlinkGoogleBtn.addEventListener('click', unlinkGoogleAccount);
 
 // Email verification event listener
 allUI.resendVerificationBtn.addEventListener('click', async () => {
  const pendingEmail = localStorage.getItem('pendingEmailChange');
  if (pendingEmail && auth.currentUser) {
   await attemptEmailChange(pendingEmail);
  } else {
   showSettingsError('No pending email change found.');
   allUI.emailVerificationStatus.classList.add('hidden');
  }
 });

 // Additional email verification event listeners
 allUI.tryDifferentMethodBtn.addEventListener('click', () => {
  allUI.passwordReauthSection.classList.remove('hidden');
  allUI.reauthPassword.focus();
 });

 allUI.confirmEmailChangeBtn.addEventListener('click', async () => {
  const pendingEmail = localStorage.getItem('pendingEmailChange');
  const password = allUI.reauthPassword.value;
  
  if (!password) {
   showSettingsError('Please enter your current password.');
   return;
  }
  
  if (pendingEmail) {
   await attemptDirectEmailChange(pendingEmail, password);
  } else {
   showSettingsError('No pending email change found.');
  }
 });

 allUI.cancelEmailChangeBtn.addEventListener('click', () => {
  localStorage.removeItem('pendingEmailChange');
  allUI.emailVerificationStatus.classList.add('hidden');
  allUI.passwordReauthSection.classList.add('hidden');
  allUI.reauthPassword.value = '';
  allUI.settingsError.classList.add('hidden');
 });
 
 function getAuthErrorMessage(errorCode) {
 switch (errorCode) {
 case 'auth/operation-not-allowed':
 return '<strong>Action Required:</strong><br>Email/Password sign-in is not enabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.';
 case 'auth/invalid-email': 
 return 'Please enter a valid email address.';
 case 'auth/user-not-found':
 case 'auth/wrong-password': 
 return 'Invalid email or password.';
 case 'auth/email-already-in-use': 
 return 'An account with this email already exists.';
 case 'auth/weak-password': 
 return 'Password should be at least 6 characters.';
 default: 
 return 'An unexpected error occurred. Please try again.';
 }
 }

 // --- GOOGLE OAUTH IMPLEMENTATION ---
 let pendingCredential = null;
 let pendingEmail = null;

 async function handleGoogleSignIn() {
  const provider = new GoogleAuthProvider();
  provider.addScope('email');
  provider.addScope('profile');
  
  try {
   const result = await signInWithPopup(auth, provider);
   // New user or existing Google account - proceed normally
   console.log('Google sign-in successful:', result.user);
  } catch (error) {
   if (error.code === 'auth/account-exists-with-different-credential') {
    // Account exists with different credential (email/password)
    pendingCredential = GoogleAuthProvider.credentialFromError(error);
    pendingEmail = error.customData.email;
    
    // Check if there are existing sign-in methods for this email
    try {
     const methods = await fetchSignInMethodsForEmail(auth, pendingEmail);
     if (methods.length > 0 && methods.includes('password')) {
      // Show account linking dialog
      showAccountLinkingDialog(pendingEmail);
      return;
     }
    } catch (fetchError) {
     console.error('Error fetching sign-in methods:', fetchError);
    }
   } else if (error.code === 'auth/popup-cancelled-by-user') {
    // User cancelled the popup - no action needed
    return;
   } else if (error.code === 'auth/popup-blocked') {
    showAuthError('Popup was blocked by your browser. Please allow popups and try again.');
   } else {
    console.error('Google sign-in error:', error);
    showAuthError('Failed to sign in with Google. Please try again.');
   }
  }
 }

 async function linkAccountWithGoogle() {
  if (!pendingCredential || !pendingEmail) {
   console.error('No pending credential found');
   return;
  }

  try {
   // First, sign in the user with email/password to get existing account
   const methods = await fetchSignInMethodsForEmail(auth, pendingEmail);
   
   if (methods.includes('password')) {
    // Hide the linking modal temporarily and show password prompt
    hideAccountLinkingDialog();
    showPasswordPromptForLinking(pendingEmail);
   } else {
    throw new Error('Cannot link: no password method available');
   }
   
  } catch (error) {
   console.error('Account linking error:', error);
   hideAccountLinkingDialog();
   showAuthError('Failed to link accounts. Please try again.');
  }
 }

 async function completeAccountLinking(email, password) {
  try {
   // Sign in with email/password first
   const userCredential = await signInWithEmailAndPassword(auth, email, password);
   const user = userCredential.user;
   
   // Now link the Google credential
   await linkWithCredential(user, pendingCredential);
   
   // Update user profile to mark Google as primary auth method
   await updateUserAuthMethod(user.uid, 'google');
   
   console.log('Account successfully linked with Google');
   
   // Clear pending data
   pendingCredential = null;
   pendingEmail = null;
   
   // Hide any password prompts
   hidePasswordPrompt();
   
  } catch (error) {
   console.error('Account linking completion error:', error);
   
   if (error.code === 'auth/wrong-password') {
    showPasswordError('Incorrect password. Please try again.');
   } else if (error.code === 'auth/credential-already-in-use') {
    showPasswordError('This Google account is already linked to another user.');
   } else {
    showPasswordError('Failed to link accounts. Please try again.');
   }
  }
 }

 async function updateUserAuthMethod(uid, primaryMethod) {
  try {
   const userDocRef = doc(db, `${usersPath()}/${uid}`);
   await updateDoc(userDocRef, {
    primaryAuthMethod: primaryMethod,
    authMethods: {
     google: primaryMethod === 'google',
     emailPassword: true
    },
    lastUpdated: new Date().toISOString()
   });
  } catch (error) {
   console.error('Error updating user auth method:', error);
  }
 }

 function showAccountLinkingDialog(email) {
  allUI.linkingEmail.textContent = email;
  allUI.accountLinkingModal.classList.remove('hidden');
 }

 function hideAccountLinkingDialog() {
  allUI.accountLinkingModal.classList.add('hidden');
  pendingCredential = null;
  pendingEmail = null;
 }

 function showAuthError(message) {
  const isLoginForm = !allUI.loginForm.classList.contains('hidden');
  const errorElement = isLoginForm ? allUI.loginError : allUI.registerError;
  
  errorElement.innerHTML = message;
  errorElement.classList.remove('hidden');
 }

 function showPasswordPromptForLinking(email) {
  allUI.passwordPromptEmail.textContent = email;
  allUI.passwordPromptInput.value = '';
  allUI.passwordPromptError.classList.add('hidden');
  allUI.passwordLinkingModal.classList.remove('hidden');
 }

 function hidePasswordPrompt() {
  allUI.passwordLinkingModal.classList.add('hidden');
  allUI.passwordPromptInput.value = '';
  allUI.passwordPromptError.classList.add('hidden');
 }

 function showPasswordError(message) {
  allUI.passwordPromptError.innerHTML = message;
  allUI.passwordPromptError.classList.remove('hidden');
 }

 // --- IN-APP ACCOUNT LINKING ---
 async function linkGoogleAccountInApp() {
  if (!currentUser || !auth.currentUser) {
   showSettingsError('Please refresh the page and try again.');
   return;
  }

  const provider = new GoogleAuthProvider();
  provider.addScope('email');
  provider.addScope('profile');
  
  try {
   // Directly link the Google provider to the current user
   await linkWithCredential(auth.currentUser, GoogleAuthProvider.credential());
   
  } catch (error) {
   // If direct link fails, try popup approach
   try {
    const result = await signInWithPopup(auth, provider);
    
    // If popup succeeded but didn't link (user signed in with Google instead)
    if (result.user.email === currentUser.email) {
     // Same email - accounts are now linked
     await updateUserAuthMethod(result.user.uid, 'google');
     await updateGoogleLinkingUI(true);
     showSettingsSuccess('Google account linked successfully! You can now sign in with Google.');
    } else {
     // Different email - sign out and show error
     await signOut(auth);
     showSettingsError('The Google account email does not match your current account.');
     // The user will be signed back in via onAuthStateChanged
    }
    
   } catch (popupError) {
    if (popupError.code === 'auth/popup-cancelled-by-user') {
     return; // User cancelled
    } else if (popupError.code === 'auth/popup-blocked') {
     showSettingsError('Popup was blocked. Please allow popups and try again.');
    } else if (popupError.code === 'auth/account-exists-with-different-credential') {
     showSettingsError('This Google account is already associated with a different user.');
    } else if (popupError.code === 'auth/credential-already-in-use') {
     showSettingsError('This Google account is already linked to another user.');
    } else {
     console.error('Google linking popup error:', popupError);
     showSettingsError('Failed to link Google account. Please try again.');
    }
   }
  }
 }

 async function unlinkGoogleAccount() {
  if (!currentUser) {
   console.error('No current user for unlinking');
   return;
  }

  try {
   const user = auth.currentUser;
   await user.unlink(GoogleAuthProvider.PROVIDER_ID);
   
   // Update user profile to remove Google as primary auth method
   await updateUserAuthMethod(user.uid, 'email');
   await updateGoogleLinkingUI(false);
   showSettingsSuccess('Google account unlinked successfully.');
   
  } catch (error) {
   console.error('Unlinking error:', error);
   if (error.code === 'auth/no-such-provider') {
    showSettingsError('Google account is not linked to this account.');
   } else {
    showSettingsError('Failed to unlink Google account. Please try again.');
   }
  }
 }

 async function updateGoogleLinkingUI(isLinked) {
  if (isLinked) {
   allUI.googleNotLinked.classList.add('hidden');
   allUI.googleLinked.classList.remove('hidden');
  } else {
   allUI.googleLinked.classList.add('hidden');
   allUI.googleNotLinked.classList.remove('hidden');
  }
 }

 async function checkGoogleLinkingStatus() {
  if (!currentUser) return;
  
  try {
   const user = auth.currentUser;
   const isGoogleLinked = user.providerData.some(provider => provider.providerId === 'google.com');
   await updateGoogleLinkingUI(isGoogleLinked);
  } catch (error) {
   console.error('Error checking Google linking status:', error);
  }
 }

 function showSettingsSuccess(message) {
  allUI.settingsSuccess.textContent = message;
  allUI.settingsSuccess.classList.remove('hidden');
  allUI.settingsError.classList.add('hidden');
 }

 function showSettingsError(message) {
  allUI.settingsError.textContent = message;
  allUI.settingsError.classList.remove('hidden');
  allUI.settingsSuccess.classList.add('hidden');
 }

 // --- EMAIL CHANGE METHODS ---
 async function attemptEmailChange(newEmail) {
  allUI.emailChangeStatus.innerHTML = `Attempting to send verification email to <span class="font-medium">${newEmail}</span>...`;
  
  // Method 1: Try verifyBeforeUpdateEmail
  try {
   console.log('Method 1: Attempting verifyBeforeUpdateEmail');
   await verifyBeforeUpdateEmail(auth.currentUser, newEmail);
   
   allUI.emailChangeStatus.innerHTML = `Verification email sent to <span class="font-medium">${newEmail}</span>! Please check your inbox and spam folder.`;
   allUI.resendVerificationBtn.classList.remove('hidden');
   allUI.settingsSuccess.textContent = 'Display name updated. Please check your email to verify your new email address.';
   allUI.settingsSuccess.classList.remove('hidden');
   return; // Success!
   
  } catch (error1) {
   console.log('Method 1 failed:', error1);
   
   // Method 2: Try direct updateEmail after user reauthentication
   allUI.emailChangeStatus.innerHTML = `Standard email verification not available. <span class="font-medium">Please use the alternative method below.</span>`;
   allUI.tryDifferentMethodBtn.classList.remove('hidden');
   allUI.settingsError.textContent = 'Standard email verification is not configured. Please use the alternative method below.';
   allUI.settingsError.classList.remove('hidden');
  }
 }

 async function attemptDirectEmailChange(newEmail, password) {
  try {
   // Step 1: Reauthenticate user
   console.log('Reauthenticating user for email change');
   const credential = EmailAuthProvider.credential(currentUser.email, password);
   await reauthenticateWithCredential(auth.currentUser, credential);
   
   // Step 2: Update email directly
   console.log('Updating email directly to:', newEmail);
   await updateEmail(auth.currentUser, newEmail);
   
   // Step 3: Update Firestore
   const userDocRef = doc(db, `${usersPath()}/${currentUser.uid}`);
   await updateDoc(userDocRef, {
    email: newEmail,
    lastUpdated: new Date().toISOString()
   });
   
   // Success!
   localStorage.removeItem('pendingEmailChange');
   allUI.emailVerificationStatus.classList.add('hidden');
   allUI.passwordReauthSection.classList.add('hidden');
   allUI.settingsSuccess.textContent = 'Email address updated successfully!';
   allUI.settingsSuccess.classList.remove('hidden');
   allUI.settingsError.classList.add('hidden');
   
   // Update the email field to reflect the change
   allUI.settingsEmail.value = newEmail;
   
   setTimeout(() => {
    allUI.settingsModal.classList.add('hidden');
    allUI.settingsModal.classList.remove('flex');
   }, 2000);
   
  } catch (error) {
   console.error('Direct email change failed:', error);
   let errorMsg = 'Failed to change email address.';
   
   if (error.code === 'auth/wrong-password') {
    errorMsg = 'Incorrect password. Please try again.';
   } else if (error.code === 'auth/email-already-in-use') {
    errorMsg = 'This email address is already in use by another account.';
   } else if (error.code === 'auth/invalid-email') {
    errorMsg = 'Please enter a valid email address.';
   } else if (error.code === 'auth/requires-recent-login') {
    errorMsg = 'Please log out and log back in, then try again.';
   } else {
    errorMsg = `Error: ${error.message}`;
   }
   
   showSettingsError(errorMsg);
  }
 }
 
 // --- DATA PATH HELPERS ---
 const appId = () => 'nerdfootball'; 

// --- POOL CONTEXT ---
let userPoolMemberships = {}; // Cache for user's pool memberships
let activePoolId = 'nerduniverse-2025'; // Default to NerdUniverse 2025 pool

const getCurrentPool = () => {
  // Phase 2: Support user context and pool switching
  // Check URL parameter first
  const urlParams = new URLSearchParams(window.location.search);
  const poolParam = urlParams.get('pool');
  if (poolParam && userPoolMemberships[poolParam]) {
    return poolParam;
  }
  
  // Check localStorage for user preference
  if (currentUser) {
    const savedPool = localStorage.getItem(`activePool_${currentUser.uid}`);
    if (savedPool && userPoolMemberships[savedPool]) {
      return savedPool;
    }
  }
  
  // Fall back to default pool for backward compatibility
  return activePoolId;
};

const setActivePool = (poolId) => {
  activePoolId = poolId;
  if (currentUser) {
    localStorage.setItem(`activePool_${currentUser.uid}`, poolId);
  }
  // Update URL without page refresh
  const url = new URL(window.location);
  url.searchParams.set('pool', poolId);
  window.history.replaceState({}, '', url);
};

// User pool membership functions
const getUserPoolsPath = (uid) => `artifacts/${appId()}/users/${uid}/pools/membership`;
const getPoolMetadataPath = (poolId) => `artifacts/${appId()}/pools/${poolId}/metadata/config`;
const getPoolMembersPath = (poolId) => `artifacts/${appId()}/pools/${poolId}/metadata/members`;

const getPoolBasePath = () => {
  const poolId = getCurrentPool();
  // For backward compatibility with the default pool, use the legacy path structure
  if (poolId === 'nerdfootball-2025') {
    return `artifacts/${appId()}/public`;
  }
  // For new pools, use the cleaner structure without /data/
  return `artifacts/${appId()}/pools/${poolId}`;
};

 const picksPath = (week, uid, poolId = null) => {
   const pool = poolId || getCurrentPool();
   
   // Maintain backward compatibility for legacy pools
   if (pool === 'nerdfootball-2025' || pool === 'nerduniverse-2025') {
     return `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions/${uid}`;
   }
   
   // Use proper pool isolation for new pools
   return `artifacts/${appId()}/pools/${pool}/data/nerdfootball_picks/${week}/submissions/${uid}`;
 };
 
 const resultsPath = (week, poolId = null) => {
   const pool = poolId || getCurrentPool();
   
   // Maintain backward compatibility for legacy pools
   if (pool === 'nerdfootball-2025' || pool === 'nerduniverse-2025') {
     return `artifacts/${appId()}/public/data/nerdfootball_results/${week}`;
   }
   
   // Use proper pool isolation for new pools
   return `artifacts/${appId()}/pools/${pool}/data/nerdfootball_results/${week}`;
 };
 
 const usersPath = () => {
   // User profiles remain global - users can be members of multiple pools
   // This is the only path that should remain global
   return `artifacts/${appId()}/public/data/nerdfootball_users`;
 };
 
 const survivorPicksPath = (uid, poolId = null) => {
   const pool = poolId || getCurrentPool();
   
   // Maintain backward compatibility for legacy pools
   if (pool === 'nerdfootball-2025' || pool === 'nerduniverse-2025') {
     return `artifacts/${appId()}/public/data/nerdSurvivor_picks/${uid}`;
   }
   
   // Use proper pool isolation for new pools
   return `artifacts/${appId()}/pools/${pool}/data/nerdSurvivor_picks/${uid}`;
 };
 
 const survivorStatusPath = (poolId = null) => {
   const pool = poolId || getCurrentPool();
   
   // Maintain backward compatibility for legacy pools
   if (pool === 'nerdfootball-2025' || pool === 'nerduniverse-2025') {
     return `artifacts/${appId()}/public/data/nerdSurvivor_status/status`;
   }
   
   // Use proper pool isolation for new pools
   return `artifacts/${appId()}/pools/${pool}/data/nerdSurvivor_status/status`;
 };

 // Collection path helpers for proper pool isolation
 const picksCollectionPath = (week, poolId = null) => {
   const pool = poolId || getCurrentPool();
   
   if (!pool) {
     throw new Error('No pool context available for picks data access');
   }
   
   // Maintain backward compatibility for legacy pools
   if (pool === 'nerdfootball-2025' || pool === 'nerduniverse-2025') {
     return `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions`;
   }
   
   // Use proper pool isolation for new pools
   return `artifacts/${appId()}/pools/${pool}/data/nerdfootball_picks/${week}/submissions`;
 };

 // Validation helper to ensure pool isolation is working
 const validatePoolIsolation = () => {
   const currentPool = getCurrentPool();
   if (!currentPool) {
     console.error(' Pool isolation compromised: No current pool set');
     return false;
   }
   
   console.log(` Pool isolation active: ${currentPool}`);
   return true;
 };

 // Update pool name display dynamically
 const updatePoolNameDisplay = () => {
   const currentPool = getCurrentPool();
   const poolNameElement = document.getElementById('current-pool-name');
   
   if (!poolNameElement) return;
   
   // Map pool IDs to display names
   const poolDisplayNames = {
     'nerduniverse-2025': 'NerdUniverse 2025',
     'nerdfootball-2025': 'NerdFootball 2025 (Legacy)',
     // Add more pools as they're created
   };
   
   const displayName = poolDisplayNames[currentPool] || currentPool || 'Unknown Pool';
   poolNameElement.textContent = displayName;
 };

 // Diagnostic functions to check migration status
 async function checkMigrationStatus() {
   if (!currentUser) {
     console.log(' Not authenticated - please log in first');
     return;
   }

   console.log(' MIGRATION STATUS DIAGNOSTIC');
   console.log('================================');
   
   let poolExists = false;
   let isMember = false;
   let hasUserPools = false;
   
   // Check current active pool setting
   console.log(` Current active pool: ${getCurrentPool()}`);
   
   // Check if NerdUniverse 2025 pool exists
   try {
     const poolConfigRef = doc(db, getPoolMetadataPath('nerduniverse-2025'));
     const poolConfigSnap = await getDoc(poolConfigRef);
     
     if (poolConfigSnap.exists()) {
       poolExists = true;
       const poolData = poolConfigSnap.data();
       console.log(' NerdUniverse 2025 pool EXISTS');
       console.log(`   - Name: ${poolData.name}`);
       console.log(`   - Members: ${poolData.memberCount || 'Unknown'}`);
       console.log(`   - Created: ${poolData.created}`);
     } else {
       console.log(' NerdUniverse 2025 pool does NOT exist');
     }
   } catch (error) {
     console.log(` Cannot access pool config: ${error.message}`);
     console.log('   (This likely means the pool does not exist yet)');
   }
   
   // Check pool membership
   try {
     const poolMembersRef = doc(db, getPoolMembersPath('nerduniverse-2025'));
     const poolMembersSnap = await getDoc(poolMembersRef);
     
     if (poolMembersSnap.exists()) {
       const members = poolMembersSnap.data();
       const memberCount = Object.keys(members).length;
       console.log(` Pool membership data exists (${memberCount} members)`);
       
       if (members[currentUser.uid]) {
         isMember = true;
         const userRole = members[currentUser.uid].role;
         console.log(` You ARE a member (Role: ${userRole})`);
       } else {
         console.log(' You are NOT a member of this pool');
       }
     } else {
       console.log(' No pool membership data found');
     }
   } catch (error) {
     console.log(` Cannot access pool membership: ${error.message}`);
     console.log('   (Pool membership structure likely does not exist)');
   }
   
   // Check your personal pool memberships
   try {
     const userPoolsRef = doc(db, getUserPoolsPath(currentUser.uid));
     const userPoolsSnap = await getDoc(userPoolsRef);
     
     if (userPoolsSnap.exists()) {
       hasUserPools = true;
       const userPools = userPoolsSnap.data();
       console.log(` Your pool memberships: ${Object.keys(userPools).join(', ')}`);
       
       if (userPools['nerduniverse-2025']) {
         console.log(` NerdUniverse 2025 in your memberships (${userPools['nerduniverse-2025'].role})`);
       } else {
         console.log(' NerdUniverse 2025 NOT in your memberships');
       }
     } else {
       console.log(' No personal pool membership data found');
     }
   } catch (error) {
     console.log(` Cannot access user pool memberships: ${error.message}`);
     console.log('   (User pool membership structure likely does not exist)');
   }
   
   // Test legacy data access (should always work)
   try {
     const legacyPicksPath = 'artifacts/nerdfootball/public/data/nerdfootball_picks/1/submissions';
     const legacyPicksSnap = await getDocs(collection(db, legacyPicksPath));
     console.log(` Legacy data accessible: ${legacyPicksSnap.size} picks in week 1`);
   } catch (error) {
     console.log(` Cannot access legacy data: ${error.message}`);
   }
   
   // Overall status
   console.log('\n SUMMARY:');
   if (!poolExists && !isMember && !hasUserPools) {
     console.log(' MIGRATION NEEDED: Pool structure does not exist');
     console.log('    Run: runMigration() to create the pool');
   } else if (poolExists && !isMember) {
     console.log('  PARTIAL MIGRATION: Pool exists but you are not a member');
     console.log('    Migration may have failed partway through');
   } else if (poolExists && isMember) {
     console.log(' MIGRATION COMPLETE: Pool exists and you are a member');
   } else {
     console.log(' UNKNOWN STATE: Mixed results - may need re-migration');
   }
   
   console.log('================================');
 }

 // Add diagnostic button for admins
 window.runDiagnostics = checkMigrationStatus;

 // Simplified migration runner with better error handling
 async function runMigrationWithDiagnostics() {
   console.log(' STARTING MIGRATION WITH DIAGNOSTICS');
   console.log('======================================');
   
   // First run diagnostics
   await checkMigrationStatus();
   
   // Ask user if they want to proceed
   const proceed = confirm(`
 MIGRATION READY

The migration will:
1. Create NerdUniverse 2025 pool
2. Add all existing users as members
3. Preserve all your picks and data
4. Set you as admin

Proceed with migration?`);

   if (!proceed) {
     console.log(' Migration cancelled by user');
     return;
   }
   
   try {
     // Run the actual migration
     await runNerdUniverseMigration(false);
     
     // Run diagnostics again to verify success
     console.log('\n POST-MIGRATION VERIFICATION');
     console.log('===============================');
     await checkMigrationStatus();
     
   } catch (error) {
     console.error(' Migration failed:', error);
     alert(`Migration failed: ${error.message}`);
   }
 }

 // Make migration available globally
 window.runMigration = runMigrationWithDiagnostics;

 // Fix pool visibility after server-side migration
 window.fixPoolVisibility = async () => {
   if (!currentUser || !ADMIN_UIDS.includes(currentUser.uid)) {
     alert('Only admins can run this fix');
     return;
   }
   
   console.log(' FIXING POOL VISIBILITY (LOCAL STATE)');
   console.log('=======================================');
   
   try {
     // Update local pool memberships to include NerdUniverse 2025
     userPoolMemberships['nerduniverse-2025'] = {
       poolId: 'nerduniverse-2025',
       poolName: 'NerdUniverse 2025',
       role: ADMIN_UIDS.includes(currentUser.uid) ? 'admin' : 'member',
       joinedAt: new Date().toISOString(),
       status: 'active'
     };
     console.log(' Added NerdUniverse 2025 to your pool memberships');
     
     // Create local pool cache with all users
     const users = await getAllUsers();
     const poolMembers = {};
     
     Object.entries(users).forEach(([uid, userData]) => {
       poolMembers[uid] = {
         uid: uid,
         displayName: userData.displayName || userData.email || 'Unknown User',
         email: userData.email || '',
         role: ADMIN_UIDS.includes(uid) ? 'admin' : 'member',
         joinedAt: new Date().toISOString(),
         status: 'active'
       };
     });
     
     // Store in local memory for this session
     window.nerdUniverseMembers = poolMembers;
     console.log(` Loaded ${Object.keys(poolMembers).length} members for NerdUniverse 2025`);
     
     // Store pool config in local memory
     window.nerdUniverseConfig = {
       poolId: 'nerduniverse-2025',
       name: 'NerdUniverse 2025',
       description: 'The original NerdFootball community - established 2025',
       type: 'both',
       creator: currentUser.uid,
       created: new Date().toISOString(),
       settings: {
         maxMembers: 100,
         joinType: 'invite',
         confidenceEnabled: true,
         survivorEnabled: true,
         weeklyReminders: true
       },
       status: 'active',
       season: '2025',
       memberCount: Object.keys(poolMembers).length
     };
     console.log(' Created pool configuration in memory');
     
     // Force refresh UI components
     updatePoolNameDisplay();
     if (typeof renderPoolSwitcher === 'function') {
       await renderPoolSwitcher();
     }
     
     console.log(' Pool visibility fixed! NerdUniverse 2025 should now be visible.');
     alert(' Pool visibility fixed! NerdUniverse 2025 should now appear in your pools.');
     
   } catch (error) {
     console.error(' Fix failed:', error);
     alert(`Fix failed: ${error.message}`);
   }
 };

 // Simple migration runner for cases where diagnostics fail
 window.runSimpleMigration = async () => {
   console.log(' RUNNING SIMPLE MIGRATION');
   console.log('============================');
   
   const proceed = confirm(`
 SIMPLE MIGRATION

This will:
1. Create NerdUniverse 2025 pool
2. Add all existing users as members  
3. Preserve all your picks and data
4. Set you as admin

Continue?`);

   if (!proceed) {
     console.log(' Migration cancelled');
     return;
   }
   
   try {
     await runNerdUniverseMigration(false);
     console.log(' Migration completed! Try runDiagnostics() to verify.');
   } catch (error) {
     console.error(' Migration failed:', error);
     alert(`Migration failed: ${error.message}`);
   }
 };

 // Ultra-simple migration that just works with existing data
 window.runWorkingMigration = async () => {
   console.log(' MINIMAL WORKING MIGRATION');
   console.log('==============================');
   
   const proceed = confirm(`
 WORKING MIGRATION

This will:
1. Keep all your existing data exactly where it is
2. Update your app to use "NerdUniverse 2025" as the pool name
3. Preserve complete backward compatibility
4. No Firestore structure changes needed

This is the safest approach - continue?`);

   if (!proceed) {
     console.log(' Migration cancelled');
     return;
   }
   
   try {
     // Simple approach: Just update the app state, don't touch Firestore
     activePoolId = 'nerduniverse-2025';
     
     if (currentUser) {
       localStorage.setItem(`activePool_${currentUser.uid}`, 'nerduniverse-2025');
     }
     
     console.log(' Pool name updated to NerdUniverse 2025');
     console.log(' All your data remains accessible');
     console.log(' App now shows "NerdUniverse 2025" as pool name');
     
     // Update any UI elements
     if (allUI && allUI.poolName) {
       allUI.poolName.textContent = 'NerdUniverse 2025';
     }
     
     // Validate it worked
     setTimeout(() => {
       console.log(` Pool isolation active: ${getCurrentPool()}`);
       console.log(' Migration completed successfully!');
       alert(' Migration completed! Your pool is now "NerdUniverse 2025"');
     }, 1000);
     
   } catch (error) {
     console.error(' Migration failed:', error);
     alert(`Migration failed: ${error.message}`);
   }
 };

// --- USER POOL MEMBERSHIP MANAGEMENT ---
async function loadUserPoolMemberships() {
  if (!currentUser) return;
  
  try {
    const userPoolsRef = doc(db, getUserPoolsPath(currentUser.uid));
    const userPoolsSnap = await getDoc(userPoolsRef);
    
    if (userPoolsSnap.exists()) {
      userPoolMemberships = userPoolsSnap.data();
    } else {
      // Migrate existing user to default pool and create pool config if needed
      await ensureDefaultPoolExists();
      userPoolMemberships = {
        'nerdfootball-2025': {
          role: ADMIN_UIDS.includes(currentUser.uid) ? 'admin' : 'member',
          joinedAt: new Date().toISOString(),
          status: 'active'
        }
      };
      await setDoc(userPoolsRef, userPoolMemberships);
    }
  } catch (error) {
    console.log(' Using default pool membership (pool metadata not accessible via client)');
    // Default fallback - this is expected for new pool structures
    userPoolMemberships = {
      'nerduniverse-2025': {
        role: ADMIN_UIDS.includes(currentUser.uid) ? 'admin' : 'member',
        joinedAt: new Date().toISOString(),
        status: 'active'
      }
    };
  }
}

async function ensureDefaultPoolExists() {
  try {
    const defaultPoolId = 'nerduniverse-2025';
    const poolConfigRef = doc(db, getPoolMetadataPath(defaultPoolId));
    const poolConfigSnap = await getDoc(poolConfigRef);
    
    if (!poolConfigSnap.exists()) {
      // Create default pool configuration
      const defaultPoolConfig = {
        poolId: defaultPoolId,
        name: 'NerdUniverse 2025',
        description: 'The original NerdFootball community - established 2025',
        type: 'both',
        creator: 'system',
        created: new Date().toISOString(),
        settings: {
          maxMembers: 100,
          joinType: 'invite',
          confidenceEnabled: true,
          survivorEnabled: true,
          weeklyReminders: true
        },
        status: 'active',
        season: '2025',
        migrated: true
      };
      
      await setDoc(poolConfigRef, defaultPoolConfig);
      console.log('Default pool configuration created');
    }
  } catch (error) {
    console.error('Error ensuring default pool exists:', error);
  }
}

async function joinPool(poolId, inviteCode = null) {
  if (!currentUser) throw new Error('User must be authenticated');
  
  try {
    // Verify pool exists and user can join
    const poolConfigRef = doc(db, getPoolMetadataPath(poolId));
    const poolConfigSnap = await getDoc(poolConfigRef);
    
    if (!poolConfigSnap.exists()) {
      throw new Error('Pool not found');
    }
    
    const poolConfig = poolConfigSnap.data();
    
    // Add user to pool members
    const poolMembersRef = doc(db, getPoolMembersPath(poolId));
    const memberData = {
      [`${currentUser.uid}`]: {
        displayName: currentUser.displayName || currentUser.email,
        email: currentUser.email,
        role: 'member',
        joinedAt: new Date().toISOString(),
        inviteCode: inviteCode || null,
        status: 'active'
      }
    };
    await setDoc(poolMembersRef, memberData, { merge: true });
    
    // Add pool to user's memberships
    const userPoolsRef = doc(db, getUserPoolsPath(currentUser.uid));
    const newMembership = {
      [`${poolId}`]: {
        role: 'member',
        joinedAt: new Date().toISOString(),
        status: 'active'
      }
    };
    await setDoc(userPoolsRef, newMembership, { merge: true });
    
    // Update local cache
    userPoolMemberships[poolId] = newMembership[poolId];
    
    return { success: true, poolId, poolName: poolConfig.name };
  } catch (error) {
    console.error('Error joining pool:', error);
    throw error;
  }
}

async function getUserPools() {
  const pools = [];
  for (const poolId in userPoolMemberships) {
    try {
      let poolConfig = null;
      
      // Check if we have local cache for NerdUniverse 2025
      if (poolId === 'nerduniverse-2025' && window.nerdUniverseConfig) {
        poolConfig = window.nerdUniverseConfig;
      } else {
        // Try to fetch from Firestore
        let poolConfigRef = doc(db, getPoolMetadataPath(poolId));
        let poolConfigSnap = await getDoc(poolConfigRef);
        
        // If not found, try client-accessible location
        if (!poolConfigSnap.exists() && poolId === 'nerduniverse-2025') {
          poolConfigRef = doc(db, `artifacts/nerdfootball/public/pools/${poolId}/config`);
          poolConfigSnap = await getDoc(poolConfigRef);
        }
        
        if (poolConfigSnap.exists()) {
          poolConfig = poolConfigSnap.data();
        }
      }
      
      if (poolConfig) {
        pools.push({
          id: poolId,
          name: poolConfig.name,
          type: poolConfig.type,
          role: userPoolMemberships[poolId].role,
          status: userPoolMemberships[poolId].status,
          isActive: poolId === getCurrentPool()
        });
      }
    } catch (error) {
      console.log(` Pool ${poolId} metadata not accessible via client (expected for server-created pools)`);
    }
  }
  return pools;
}

// --- POOL SWITCHER UI ---
async function initializePoolSwitcher() {
  await renderPoolSwitcher();
  setupPoolSwitcherEventHandlers();
  setupPoolCreationEventHandlers();
  setupPoolManagementEventHandlers();
}

async function renderPoolSwitcher() {
  try {
    const pools = await getUserPools();
    const currentPool = getCurrentPool();
    
    // Update current pool display
    const currentPoolData = pools.find(p => p.id === currentPool);
    if (currentPoolData) {
      allUI.currentPoolName.textContent = currentPoolData.name;
    }
    
    // Render pools list
    allUI.userPoolsList.innerHTML = '';
    pools.forEach(pool => {
      const poolItem = document.createElement('button');
      poolItem.className = `w-full text-left px-3 py-2 text-sm hover:bg-slate-50 flex items-center justify-between ${
        pool.isActive ? 'bg-blue-50 text-blue-700' : 'text-slate-700'
      }`;
      poolItem.setAttribute('data-pool-id', pool.id);
      
      poolItem.innerHTML = `
        <div class="flex flex-col">
          <span class="font-medium">${pool.name}</span>
          <span class="text-xs text-slate-500">${pool.type === 'both' ? 'Confidence + Survivor' : pool.type}</span>
        </div>
        ${pool.isActive ? '<svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : ''}
      `;
      
      if (!pool.isActive) {
        poolItem.addEventListener('click', () => switchToPool(pool.id));
      }
      
      allUI.userPoolsList.appendChild(poolItem);
    });
  } catch (error) {
    console.error('Error rendering pool switcher:', error);
  }
}

async function switchToPool(poolId) {
  try {
    setActivePool(poolId);
    await renderPoolSwitcher();
    
    // Hide dropdown
    allUI.poolSwitcherDropdown.classList.add('hidden');
    
    // Reload current view with new pool context
    await loadAndRenderWeek(currentWeek);
    
    // Show success feedback
    showPoolSwitchFeedback(`Switched to ${allUI.currentPoolName.textContent}`);
  } catch (error) {
    console.error('Error switching pools:', error);
    showPoolSwitchFeedback('Error switching pools', 'error');
  }
}

function setupPoolSwitcherEventHandlers() {
  // Toggle dropdown
  allUI.poolSwitcherBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    allUI.poolSwitcherDropdown.classList.toggle('hidden');
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!allUI.poolSwitcherBtn.contains(e.target) && !allUI.poolSwitcherDropdown.contains(e.target)) {
      allUI.poolSwitcherDropdown.classList.add('hidden');
    }
  });
  
  // Create pool handler - open pool creation modal
  allUI.createPoolBtn.addEventListener('click', () => {
    allUI.poolSwitcherDropdown.classList.add('hidden');
    openPoolCreationModal();
  });
  
  // Join pool handler - prompt for invite code
  allUI.joinPoolBtn.addEventListener('click', () => {
    allUI.poolSwitcherDropdown.classList.add('hidden');
    promptForInviteCode();
  });

  // Discover pools handler - open pool discovery modal
  allUI.discoverPoolsBtn.addEventListener('click', () => {
    allUI.poolSwitcherDropdown.classList.add('hidden');
    openPoolDiscoveryModal();
  });
}

function showPoolSwitchFeedback(message, type = 'success') {
  // Create temporary feedback element
  const feedback = document.createElement('div');
  feedback.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm font-medium z-50 transition-all duration-300 ${
    type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500'
  }`;
  feedback.textContent = message;
  
  document.body.appendChild(feedback);
  
  // Animate in
  setTimeout(() => feedback.classList.add('opacity-100'), 10);
  
  // Remove after 3 seconds
  setTimeout(() => {
    feedback.classList.add('opacity-0');
    setTimeout(() => document.body.removeChild(feedback), 300);
  }, 3000);
}

// --- POOL CREATION WIZARD ---
let currentWizardStep = 1;
const totalWizardSteps = 3;

function openPoolCreationModal() {
  // Reset wizard to step 1
  currentWizardStep = 1;
  updateWizardDisplay();
  
  // Clear form
  allUI.poolCreationForm.reset();
  
  // Hide error message
  allUI.poolCreationError.classList.add('hidden');
  
  // Show modal
  allUI.poolCreationModal.classList.remove('hidden');
  allUI.poolCreationModal.classList.add('flex');
  
  // Focus on first input for accessibility
  document.getElementById('pool-name').focus();
}

function closePoolCreationModal() {
  allUI.poolCreationModal.classList.add('hidden');
  allUI.poolCreationModal.classList.remove('flex');
}

function updateWizardDisplay() {
  // Update progress indicators
  for (let i = 1; i <= totalWizardSteps; i++) {
    const stepElement = document.querySelector(`[aria-current="step"]`)?.parentElement.parentElement;
    if (stepElement) {
      const steps = stepElement.querySelectorAll('.w-8.h-8');
      const stepLabels = stepElement.querySelectorAll('span:not([aria-hidden])');
      
      steps.forEach((step, index) => {
        const stepNumber = index + 1;
        if (stepNumber === currentWizardStep) {
          step.className = 'w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-medium';
          step.setAttribute('aria-current', 'step');
          stepLabels[index * 2].className = 'ml-2 text-sm font-medium text-blue-600';
        } else if (stepNumber < currentWizardStep) {
          step.className = 'w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-medium';
          step.removeAttribute('aria-current');
          stepLabels[index * 2].className = 'ml-2 text-sm font-medium text-green-600';
        } else {
          step.className = 'w-8 h-8 bg-slate-200 text-slate-400 rounded-full flex items-center justify-center text-sm font-medium';
          step.removeAttribute('aria-current');
          stepLabels[index * 2].className = 'ml-2 text-sm text-slate-400';
        }
      });
    }
  }
  
  // Show/hide step content
  for (let i = 1; i <= totalWizardSteps; i++) {
    const stepContent = document.getElementById(`step-${i}`);
    if (i === currentWizardStep) {
      stepContent.classList.remove('hidden');
    } else {
      stepContent.classList.add('hidden');
    }
  }
  
  // Update navigation buttons
  if (currentWizardStep === 1) {
    allUI.prevStepBtn.classList.add('hidden');
  } else {
    allUI.prevStepBtn.classList.remove('hidden');
  }
  
  if (currentWizardStep === totalWizardSteps) {
    allUI.nextStepBtn.classList.add('hidden');
    allUI.createPoolSubmitBtn.classList.remove('hidden');
  } else {
    allUI.nextStepBtn.classList.remove('hidden');
    allUI.createPoolSubmitBtn.classList.add('hidden');
  }
  
  // Update review step if we're on step 3
  if (currentWizardStep === 3) {
    updateReviewStep();
  }
}

function updateReviewStep() {
  const formData = new FormData(allUI.poolCreationForm);
  
  // Update review display
  document.getElementById('review-name').textContent = formData.get('poolName') || 'Not specified';
  
  const poolType = formData.get('poolType');
  const typeText = poolType === 'confidence' ? 'Confidence Points Only' : 
                   poolType === 'survivor' ? 'Survivor Pool Only' : 
                   'Confidence + Survivor';
  document.getElementById('review-type').textContent = typeText;
  
  document.getElementById('review-max-members').textContent = formData.get('maxMembers') + ' Members';
  
  const joinMethod = formData.get('joinMethod');
  document.getElementById('review-join-method').textContent = joinMethod === 'invite' ? 'Invite Only' : 'Public';
  
  document.getElementById('review-reminders').textContent = formData.has('weeklyReminders') ? 'Enabled' : 'Disabled';
}

function validateCurrentStep() {
  allUI.poolCreationError.classList.add('hidden');
  
  if (currentWizardStep === 1) {
    return validateStep1();
  } else if (currentWizardStep === 2) {
    return validateStep2();
  }
  return true;
}

function validateStep1() {
  const poolName = document.getElementById('pool-name').value.trim();
  const poolNameError = document.getElementById('pool-name-error');
  
  // Reset error state
  poolNameError.classList.add('hidden');
  document.getElementById('pool-name').classList.remove('border-red-500');
  
  // Validate pool name
  if (!poolName) {
    showFieldError('pool-name', 'Pool name is required');
    return false;
  }
  
  if (poolName.length < 2) {
    showFieldError('pool-name', 'Pool name must be at least 2 characters');
    return false;
  }
  
  if (poolName.length > 50) {
    showFieldError('pool-name', 'Pool name must be 50 characters or less');
    return false;
  }
  
  // Validate pool type selection
  const poolType = document.querySelector('input[name="poolType"]:checked');
  if (!poolType) {
    showWizardError('Please select a pool type');
    return false;
  }
  
  return true;
}

function validateStep2() {
  // Step 2 has all optional fields with defaults, so always valid
  return true;
}

function showFieldError(fieldId, message) {
  const field = document.getElementById(fieldId);
  const errorElement = document.getElementById(`${fieldId}-error`);
  
  field.classList.add('border-red-500');
  errorElement.textContent = message;
  errorElement.classList.remove('hidden');
  
  // Focus on the field for accessibility
  field.focus();
}

function showWizardError(message) {
  allUI.poolCreationErrorMessage.textContent = message;
  allUI.poolCreationError.classList.remove('hidden');
}

function nextStep() {
  if (validateCurrentStep()) {
    currentWizardStep++;
    updateWizardDisplay();
  }
}

function prevStep() {
  if (currentWizardStep > 1) {
    currentWizardStep--;
    updateWizardDisplay();
  }
}

async function createPool() {
  if (!validateCurrentStep()) return;
  
  // Show loading state
  allUI.createPoolBtnText.textContent = 'Creating...';
  allUI.createPoolSpinner.classList.remove('hidden');
  allUI.createPoolSubmitBtn.disabled = true;
  
  try {
    const formData = new FormData(allUI.poolCreationForm);
    
    // Generate unique pool ID
    const poolId = `pool-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Create pool configuration
    const poolConfig = {
      poolId: poolId,
      name: formData.get('poolName'),
      description: formData.get('poolDescription') || '',
      type: formData.get('poolType'),
      creator: currentUser.uid,
      created: new Date().toISOString(),
      settings: {
        maxMembers: parseInt(formData.get('maxMembers')),
        joinType: formData.get('joinMethod'),
        confidenceEnabled: ['confidence', 'both'].includes(formData.get('poolType')),
        survivorEnabled: ['survivor', 'both'].includes(formData.get('poolType')),
        weeklyReminders: formData.has('weeklyReminders')
      },
      status: 'active',
      season: new Date().getFullYear().toString()
    };
    
    // Create pool in database
    const poolConfigRef = doc(db, getPoolMetadataPath(poolId));
    await setDoc(poolConfigRef, poolConfig);
    
    // Add creator as admin member
    const poolMembersRef = doc(db, getPoolMembersPath(poolId));
    const memberData = {
      [currentUser.uid]: {
        displayName: currentUser.displayName || currentUser.email,
        email: currentUser.email,
        role: 'admin',
        joinedAt: new Date().toISOString(),
        inviteCode: null,
        status: 'active'
      }
    };
    await setDoc(poolMembersRef, memberData);
    
    // Add pool to user's memberships
    await joinPool(poolId);
    
    // Switch to new pool
    setActivePool(poolId);
    await renderPoolSwitcher();
    
    // Close modal and show success
    closePoolCreationModal();
    showPoolSwitchFeedback(`Pool "${poolConfig.name}" created successfully!`, 'success');
    
    // Reload current view with new pool context
    await loadAndRenderWeek(currentWeek);
    
  } catch (error) {
    console.error('Error creating pool:', error);
    showWizardError('Failed to create pool. Please try again.');
  } finally {
    // Reset loading state
    allUI.createPoolBtnText.textContent = 'Create Pool';
    allUI.createPoolSpinner.classList.add('hidden');
    allUI.createPoolSubmitBtn.disabled = false;
  }
}

function setupPoolCreationEventHandlers() {
  // Modal controls
  allUI.closePoolCreationBtn.addEventListener('click', closePoolCreationModal);
  allUI.cancelPoolBtn.addEventListener('click', closePoolCreationModal);
  
  // Wizard navigation
  allUI.nextStepBtn.addEventListener('click', nextStep);
  allUI.prevStepBtn.addEventListener('click', prevStep);
  
  // Form submission
  allUI.poolCreationForm.addEventListener('submit', (e) => {
    e.preventDefault();
    createPool();
  });
  
  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !allUI.poolCreationModal.classList.contains('hidden')) {
      closePoolCreationModal();
    }
  });
  
  // Close modal when clicking backdrop
  allUI.poolCreationModal.addEventListener('click', (e) => {
    if (e.target === allUI.poolCreationModal) {
      closePoolCreationModal();
    }
  });
  
  // Real-time validation feedback
  document.getElementById('pool-name').addEventListener('blur', validateStep1);
  document.getElementById('pool-name').addEventListener('input', (e) => {
    // Clear error state on input
    if (e.target.value.trim()) {
      e.target.classList.remove('border-red-500');
      document.getElementById('pool-name-error').classList.add('hidden');
    }
  });
}

// --- POOL MANAGEMENT ---
async function loadPoolManagementData() {
  try {
    const currentPoolId = getCurrentPool();
    
    // Load pool configuration
    const poolConfigRef = doc(db, getPoolMetadataPath(currentPoolId));
    const poolConfigSnap = await getDoc(poolConfigRef);
    
    if (poolConfigSnap.exists()) {
      const poolConfig = poolConfigSnap.data();
      updatePoolConfigurationDisplay(poolConfig);
    }
    
    // Load pool members
    await loadPoolMembers();
    
    // Load invite links
    await loadInviteLinks();
    
    // Update statistics
    await updatePoolStatistics();
    
    //  Load add users functionality
    await initializeAddUsersSection();
    
  } catch (error) {
    console.error('Error loading pool management data:', error);
  }
}

function updatePoolConfigurationDisplay(poolConfig) {
  // Update pool info display
  allUI.currentPoolNameDisplay.textContent = poolConfig.name || 'Unknown Pool';
  
  const typeText = poolConfig.type === 'confidence' ? 'Confidence Points Only' : 
                   poolConfig.type === 'survivor' ? 'Survivor Pool Only' : 
                   'Confidence + Survivor';
  allUI.currentPoolType.textContent = typeText;
  
  allUI.currentJoinMethod.textContent = poolConfig.settings?.joinType === 'invite' ? 'Invite Only' : 'Public';
  allUI.currentMaxMembers.textContent = `${poolConfig.settings?.maxMembers || 50} members`;
  
  // Format created date
  if (poolConfig.created) {
    const createdDate = new Date(poolConfig.created);
    allUI.poolCreatedDate.textContent = createdDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  allUI.poolCreator.textContent = poolConfig.creator === 'system' ? 'System (Migrated)' : 'Pool Admin';
  allUI.currentPoolDescription.textContent = poolConfig.description || 'No description provided.';
}

async function loadPoolMembers() {
  try {
    const currentPoolId = getCurrentPool();
    const poolMembersRef = doc(db, getPoolMembersPath(currentPoolId));
    const poolMembersSnap = await getDoc(poolMembersRef);
    
    allUI.poolMembersTbody.innerHTML = '';
    
    if (poolMembersSnap.exists()) {
      const members = poolMembersSnap.data();
      const memberEntries = Object.entries(members);
      
      if (memberEntries.length === 0) {
        allUI.poolMembersTbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">
              No members found in this pool.
            </td>
          </tr>
        `;
        return;
      }
      
      //  DIAMOND FIX: Get deduplicated user data to eliminate legacy/ghost users!
      const allUsers = await fetchAllUsers();
      const userMap = new Map();
      const emailMap = new Map(); // Track which UIDs are preferred for each email
      
      allUsers.forEach(user => {
        userMap.set(user.id, user);
        if (user.email) {
          emailMap.set(user.email, user.id); // Latest processed becomes preferred
        }
      });
      
      console.log(' Pool Members - Using deduplicated user data to eliminate ghost users');
      
      // Sort members alphabetically by display name
      const sortedMembers = memberEntries.sort(([uidA, memberA], [uidB, memberB]) => {
        const userDataA = userMap.get(uidA);
        const userDataB = userMap.get(uidB);
        
        const nameA = (userDataA?.displayName || memberA.displayName || memberA.email || 'Unknown').toLowerCase();
        const nameB = (userDataB?.displayName || memberB.displayName || memberB.email || 'Unknown').toLowerCase();
        
        // Sort by last name if we can detect it (assumes "First Last" format)
        const lastNameA = nameA.split(' ').slice(-1)[0];
        const lastNameB = nameB.split(' ').slice(-1)[0];
        
        // First sort by last name, then by full name if last names are equal
        if (lastNameA !== lastNameB) {
          return lastNameA.localeCompare(lastNameB);
        }
        return nameA.localeCompare(nameB);
      });
      
      let displayedMemberCount = 0;
      
      sortedMembers.forEach(([uid, member]) => {
        //  Get deduplicated user data and check if this is a ghost user
        const userData = userMap.get(uid);
        
        // Skip ghost/legacy users that have been replaced by preferred UIDs
        if (!userData && member.email && emailMap.has(member.email)) {
          const preferredUID = emailMap.get(member.email);
          console.log(` Skipping ghost user ${uid} (${member.email}) - replaced by preferred UID: ${preferredUID}`);
          return; // Skip this legacy user entirely
        }
        
        const displayName = userData?.displayName || member.displayName || 'Unknown User';
        const email = userData?.email || member.email || 'No email';
        
        console.log(` Member ${uid}: Using ${userData ? 'deduplicated' : 'fallback'} data - ${displayName} (${email})`);
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50';
        
        // Format joined date
        const joinedDate = member.joinedAt ? 
          new Date(member.joinedAt).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          }) : 'Unknown';
        
        // Role badge
        const roleBadge = member.role === 'admin' ? 
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Admin</span>' :
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-slate-100 text-slate-800 rounded-full">Member</span>';
        
        // Status badge
        const statusBadge = member.status === 'active' ?
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>' :
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Inactive</span>';
        
        // Participation badges (new)
        const participation = member.participation || { confidence: { enabled: true }, survivor: { enabled: true } };
        const confidenceBadge = participation.confidence?.enabled ? 
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">Confidence</span>' :
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-400 line-through rounded">Confidence</span>';
        const survivorBadge = participation.survivor?.enabled ?
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded">Survivor</span>' :
          '<span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-400 line-through rounded">Survivor</span>';
        
        // Actions (only show for non-admin members and if current user is admin)
        const isCurrentUserAdmin = userPoolMemberships[getCurrentPool()]?.role === 'admin';
        const isTargetAdmin = member.role === 'admin';
        const isCurrentUser = uid === currentUser?.uid;
        
        let actions = '';
        if (isCurrentUserAdmin && !isCurrentUser) {
          if (!isTargetAdmin) {
            actions = `
              <button class="text-blue-600 hover:text-blue-900 text-sm font-medium mr-3" onclick="promoteMember('${uid}')">
                Make Admin
              </button>
            `;
          } else {
            actions = `
              <button class="text-orange-600 hover:text-orange-900 text-sm font-medium mr-3" onclick="demoteMember('${uid}')">
                Remove Admin
              </button>
            `;
          }
          actions += `
            <button class="text-red-600 hover:text-red-900 text-sm font-medium" onclick="removeMember('${uid}')">
              Remove
            </button>
          `;
        }
        
        // Add participation toggle buttons for admins
        let participationControls = '';
        if (isCurrentUserAdmin && !isCurrentUser) {
          participationControls = `
            <div class="flex gap-2">
              ${confidenceBadge}
              ${survivorBadge}
              <button class="text-xs text-blue-600 hover:text-blue-800 underline" onclick="toggleParticipation('${uid}')">
                Edit
              </button>
            </div>
          `;
        } else {
          participationControls = `
            <div class="flex gap-2">
              ${confidenceBadge}
              ${survivorBadge}
            </div>
          `;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-8 w-8">
                <div class="h-8 w-8 bg-slate-200 rounded-full flex items-center justify-center">
                  <span class="text-sm font-medium text-slate-700">
                    ${(displayName || email).charAt(0).toUpperCase()}
                  </span>
                </div>
              </div>
              <div class="ml-3">
                <div class="text-sm font-medium text-slate-900">${displayName}</div>
                <div class="text-sm text-slate-500">${email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">${roleBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap">${participationControls}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${joinedDate}</td>
          <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${actions}</td>
        `;
        
        allUI.poolMembersTbody.appendChild(row);
        displayedMemberCount++; // Count only displayed (non-ghost) members
      });
      
      // Update member count to reflect actual displayed members (excluding ghosts)
      allUI.memberCount.textContent = displayedMemberCount;
      
    } else {
      allUI.memberCount.textContent = '0';
      allUI.poolMembersTbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">
            No member data found for this pool.
          </td>
        </tr>
      `;
    }
    
  } catch (error) {
    console.error('Error loading pool members:', error);
    allUI.poolMembersTbody.innerHTML = `
      <tr>
        <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">
          Error loading members. Please refresh the page.
        </td>
      </tr>
    `;
  }
}


async function updatePoolStatistics() {
  try {
    const currentPoolId = getCurrentPool();
    
    // Count active picks for current week
    const picksCollectionRef = collection(db, picksCollectionPath(currentWeek));
    const picksSnap = await getDocs(picksCollectionRef);
    
    allUI.activePicksCount.textContent = picksSnap.size.toString();
    
  } catch (error) {
    console.error('Error updating pool statistics:', error);
    allUI.activePicksCount.textContent = '0';
  }
}

// Member management functions (global for HTML onclick handlers)
window.promoteMember = async function(uid) {
  if (!confirm('Are you sure you want to make this user a pool admin?')) return;
  
  try {
    const currentPoolId = getCurrentPool();
    const poolMembersRef = doc(db, getPoolMembersPath(currentPoolId));
    
    await updateDoc(poolMembersRef, {
      [`${uid}.role`]: 'admin'
    });
    
    // Update user's pool membership
    const userPoolsRef = doc(db, getUserPoolsPath(uid));
    await updateDoc(userPoolsRef, {
      [`${currentPoolId}.role`]: 'admin'
    });
    
    showPoolSwitchFeedback('Member promoted to admin successfully', 'success');
    await loadPoolMembers();
    
  } catch (error) {
    console.error('Error promoting member:', error);
    showPoolSwitchFeedback('Failed to promote member', 'error');
  }
}

window.demoteMember = async function(uid) {
  if (!confirm('Are you sure you want to remove admin privileges from this user?')) return;
  
  try {
    const currentPoolId = getCurrentPool();
    const poolMembersRef = doc(db, getPoolMembersPath(currentPoolId));
    
    await updateDoc(poolMembersRef, {
      [`${uid}.role`]: 'member'
    });
    
    // Update user's pool membership
    const userPoolsRef = doc(db, getUserPoolsPath(uid));
    await updateDoc(userPoolsRef, {
      [`${currentPoolId}.role`]: 'member'
    });
    
    showPoolSwitchFeedback('Admin privileges removed successfully', 'success');
    await loadPoolMembers();
    
  } catch (error) {
    console.error('Error demoting member:', error);
    showPoolSwitchFeedback('Failed to remove admin privileges', 'error');
  }
}

window.removeMember = async function(uid) {
  if (!confirm('Are you sure you want to remove this member from the pool? This action cannot be undone.')) return;
  
  try {
    const currentPoolId = getCurrentPool();
    
    // Remove from pool members
    const poolMembersRef = doc(db, getPoolMembersPath(currentPoolId));
    await updateDoc(poolMembersRef, {
      [uid]: deleteField()
    });
    
    // Remove pool from user's memberships
    const userPoolsRef = doc(db, getUserPoolsPath(uid));
    await updateDoc(userPoolsRef, {
      [currentPoolId]: deleteField()
    });
    
    showPoolSwitchFeedback('Member removed from pool successfully', 'success');
    await loadPoolMembers();
    
  } catch (error) {
    console.error('Error removing member:', error);
    showPoolSwitchFeedback('Failed to remove member', 'error');
  }
}

window.toggleParticipation = async function(uid) {
  try {
    // Get current member data
    const poolMembersRef = doc(db, getPoolMembersPath(getCurrentPool()));
    const poolMembersSnap = await getDoc(poolMembersRef);
    
    if (!poolMembersSnap.exists()) {
      showPoolSwitchFeedback('Member data not found', 'error');
      return;
    }
    
    const members = poolMembersSnap.data();
    const member = members[uid];
    
    if (!member) {
      showPoolSwitchFeedback('Member not found', 'error');
      return;
    }
    
    // Get current participation status
    const participation = member.participation || { 
      confidence: { enabled: true, status: 'active' }, 
      survivor: { enabled: true, status: 'active' } 
    };
    
    // Create modal for editing participation
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold mb-4">Edit Pool Participation</h3>
        <p class="text-sm text-gray-600 mb-4">User: ${member.displayName || member.email}</p>
        
        <div class="space-y-4">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="confidence-toggle" ${participation.confidence?.enabled ? 'checked' : ''} 
              class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
            <span>Confidence Pool</span>
          </label>
          
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="survivor-toggle" ${participation.survivor?.enabled ? 'checked' : ''} 
              class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
            <span>Survivor Pool</span>
          </label>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
          <button onclick="this.closest('.fixed').remove()" 
            class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
          <button id="save-participation" 
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Handle save button
    document.getElementById('save-participation').onclick = async function() {
      const confidenceEnabled = document.getElementById('confidence-toggle').checked;
      const survivorEnabled = document.getElementById('survivor-toggle').checked;
      
      // Ensure at least one pool is selected
      if (!confidenceEnabled && !survivorEnabled) {
        alert('User must participate in at least one pool');
        return;
      }
      
      try {
        // Initialize participation manager if needed
        if (!poolParticipationManager.initialized) {
          await poolParticipationManager.initialize(db);
        }
        
        // Update participation
        await poolParticipationManager.updateUserParticipation(
          uid,
          {
            confidence: confidenceEnabled,
            survivor: survivorEnabled
          },
          currentUser.uid
        );
        
        modal.remove();
        showPoolSwitchFeedback('Participation updated successfully', 'success');
        await loadPoolMembers();
        
      } catch (error) {
        console.error('Error updating participation:', error);
        showPoolSwitchFeedback('Failed to update participation', 'error');
      }
    };
    
  } catch (error) {
    console.error('Error toggling participation:', error);
    showPoolSwitchFeedback('Failed to toggle participation', 'error');
  }
}

function setupPoolManagementEventHandlers() {
  // Edit pool settings button (placeholder)
  allUI.editPoolSettingsBtn.addEventListener('click', () => {
    showPoolSwitchFeedback('Pool editing will be available in a future update', 'info');
  });
  
  // Generate invite button  
  allUI.generateInviteBtn.addEventListener('click', createQuickInviteLink);
  
  // Invite member button (placeholder)
  allUI.inviteMemberBtn.addEventListener('click', () => {
    showPoolSwitchFeedback('Member invitations coming in next phase', 'info');
  });
  
  // Create invite link button
  allUI.createInviteLinkBtn.addEventListener('click', createQuickInviteLink);
  
  // Archive pool button
  allUI.archivePoolBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to archive this pool? This will end the current season but preserve all data.')) return;
    
    try {
      const currentPoolId = getCurrentPool();
      const poolConfigRef = doc(db, getPoolMetadataPath(currentPoolId));
      
      await updateDoc(poolConfigRef, {
        status: 'archived',
        archivedAt: new Date().toISOString()
      });
      
      allUI.poolStatus.textContent = 'Archived';
      showPoolSwitchFeedback('Pool archived successfully', 'success');
      
    } catch (error) {
      console.error('Error archiving pool:', error);
      showPoolSwitchFeedback('Failed to archive pool', 'error');
    }
  });
  
  // Delete pool button
  allUI.deletePoolBtn.addEventListener('click', () => {
    showPoolSwitchFeedback('Pool deletion will be available in a future update', 'info');
  });
}

// Add to admin tab switching logic
function renderAdminPoolSettings() {
  if (userPoolMemberships[getCurrentPool()]?.role === 'admin') {
    loadPoolManagementData();
  }
}

// --- INVITE SYSTEM ---
function generateSecureInviteCode() {
  // Generate cryptographically secure invite code
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  const array = new Uint8Array(12);
  crypto.getRandomValues(array);
  
  for (let i = 0; i < array.length; i++) {
    result += chars.charAt(array[i] % chars.length);
  }
  
  return result;
}

async function createInviteLink(expiresInDays = 7, maxUses = null) {
  try {
    const currentPoolId = getCurrentPool();
    const inviteCode = generateSecureInviteCode();
    
    // Calculate expiration date
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + expiresInDays);
    
    const inviteData = {
      code: inviteCode,
      poolId: currentPoolId,
      createdBy: currentUser.uid,
      createdAt: new Date().toISOString(),
      expiresAt: expiresAt.toISOString(),
      maxUses: maxUses,
      currentUses: 0,
      status: 'active'
    };
    
    // Store invite in database
    const inviteRef = doc(db, `artifacts/${appId()}/invites/${inviteCode}`);
    await setDoc(inviteRef, inviteData);
    
    // Add to pool's invite list
    const poolInvitesRef = doc(db, `artifacts/${appId()}/pools/${currentPoolId}/metadata/invites`);
    await setDoc(poolInvitesRef, {
      [inviteCode]: {
        createdBy: currentUser.uid,
        createdAt: inviteData.createdAt,
        expiresAt: inviteData.expiresAt,
        maxUses: maxUses,
        status: 'active'
      }
    }, { merge: true });
    
    return {
      code: inviteCode,
      url: `${window.location.origin}${window.location.pathname}?invite=${inviteCode}`,
      expiresAt: expiresAt
    };
    
  } catch (error) {
    console.error('Error creating invite link:', error);
    throw new Error('Failed to create invite link');
  }
}

async function validateInviteCode(inviteCode) {
  try {
    const inviteRef = doc(db, `artifacts/${appId()}/invites/${inviteCode}`);
    const inviteSnap = await getDoc(inviteRef);
    
    if (!inviteSnap.exists()) {
      return { valid: false, reason: 'Invite code not found' };
    }
    
    const invite = inviteSnap.data();
    
    // Check if invite is active
    if (invite.status !== 'active') {
      return { valid: false, reason: 'Invite code is no longer active' };
    }
    
    // Check expiration
    const now = new Date();
    const expiresAt = new Date(invite.expiresAt);
    if (now > expiresAt) {
      return { valid: false, reason: 'Invite code has expired' };
    }
    
    // Check usage limits
    if (invite.maxUses && invite.currentUses >= invite.maxUses) {
      return { valid: false, reason: 'Invite code has reached its usage limit' };
    }
    
    // Check if user is already a member
    if (currentUser && userPoolMemberships[invite.poolId]) {
      return { valid: false, reason: 'You are already a member of this pool' };
    }
    
    // Get pool info for validation
    const poolConfigRef = doc(db, getPoolMetadataPath(invite.poolId));
    const poolConfigSnap = await getDoc(poolConfigRef);
    
    if (!poolConfigSnap.exists()) {
      return { valid: false, reason: 'Pool no longer exists' };
    }
    
    const poolConfig = poolConfigSnap.data();
    
    // Check pool status
    if (poolConfig.status !== 'active') {
      return { valid: false, reason: 'Pool is no longer active' };
    }
    
    // Check member limits
    const poolMembersRef = doc(db, getPoolMembersPath(invite.poolId));
    const poolMembersSnap = await getDoc(poolMembersRef);
    
    if (poolMembersSnap.exists()) {
      const members = poolMembersSnap.data();
      const memberCount = Object.keys(members).length;
      
      if (memberCount >= (poolConfig.settings?.maxMembers || 50)) {
        return { valid: false, reason: 'Pool has reached its member limit' };
      }
    }
    
    return { 
      valid: true, 
      invite: invite,
      poolConfig: poolConfig
    };
    
  } catch (error) {
    console.error('Error validating invite code:', error);
    return { valid: false, reason: 'Error validating invite code' };
  }
}

async function useInviteCode(inviteCode) {
  try {
    const validation = await validateInviteCode(inviteCode);
    if (!validation.valid) {
      throw new Error(validation.reason);
    }
    
    const { invite, poolConfig } = validation;
    
    // Join the pool
    const result = await joinPool(invite.poolId, inviteCode);
    
    // Increment usage count
    const inviteRef = doc(db, `artifacts/${appId()}/invites/${inviteCode}`);
    await updateDoc(inviteRef, {
      currentUses: (invite.currentUses || 0) + 1,
      lastUsed: new Date().toISOString(),
      [`usedBy.${currentUser.uid}`]: new Date().toISOString()
    });
    
    return {
      success: true,
      poolName: poolConfig.name,
      poolId: invite.poolId
    };
    
  } catch (error) {
    console.error('Error using invite code:', error);
    throw error;
  }
}

async function loadInviteLinks() {
  try {
    const currentPoolId = getCurrentPool();
    const poolInvitesRef = doc(db, `artifacts/${appId()}/pools/${currentPoolId}/metadata/invites`);
    const poolInvitesSnap = await getDoc(poolInvitesRef);
    
    allUI.inviteLinksContainer.innerHTML = '';
    
    if (poolInvitesSnap.exists()) {
      const invites = poolInvitesSnap.data();
      const inviteEntries = Object.entries(invites);
      
      if (inviteEntries.length === 0) {
        allUI.inviteLinksContainer.innerHTML = `
          <div class="text-sm text-slate-500 text-center py-4">
            No active invite links. Create one to invite new members.
          </div>
        `;
        return;
      }
      
      // Sort by creation date (newest first)
      inviteEntries.sort(([, a], [, b]) => new Date(b.createdAt) - new Date(a.createdAt));
      
      inviteEntries.forEach(([code, invite]) => {
        const inviteCard = createInviteCard(code, invite);
        allUI.inviteLinksContainer.appendChild(inviteCard);
      });
      
    } else {
      allUI.inviteLinksContainer.innerHTML = `
        <div class="text-sm text-slate-500 text-center py-4">
          No active invite links. Create one to invite new members.
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading invite links:', error);
    allUI.inviteLinksContainer.innerHTML = `
      <div class="text-sm text-red-500 text-center py-4">
        Error loading invite links. Please refresh the page.
      </div>
    `;
  }
}

function createInviteCard(code, invite) {
  const card = document.createElement('div');
  card.className = 'bg-slate-50 border border-slate-200 rounded-lg p-4';
  
  const expiresAt = new Date(invite.expiresAt);
  const now = new Date();
  const isExpired = now > expiresAt;
  const daysUntilExpiry = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
  
  const inviteUrl = `${window.location.origin}${window.location.pathname}?invite=${code}`;
  
  const statusBadge = isExpired ? 
    '<span class="inline-flex px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">Expired</span>' :
    '<span class="inline-flex px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>';
  
  const expiryText = isExpired ? 
    'Expired' : 
    daysUntilExpiry === 1 ? 'Expires tomorrow' : 
    daysUntilExpiry <= 0 ? 'Expires today' :
    `Expires in ${daysUntilExpiry} days`;
  
  card.innerHTML = `
    <div class="flex items-start justify-between">
      <div class="flex-1">
        <div class="flex items-center space-x-3 mb-2">
          <code class="text-sm font-mono bg-white px-2 py-1 rounded border">${code}</code>
          ${statusBadge}
        </div>
        <div class="text-sm text-slate-600 space-y-1">
          <div>Created: ${new Date(invite.createdAt).toLocaleDateString()}</div>
          <div>${expiryText}</div>
          ${invite.maxUses ? `<div>Uses: 0/${invite.maxUses}</div>` : '<div>Unlimited uses</div>'}
        </div>
      </div>
      <div class="flex flex-col space-y-2 ml-4">
        <button 
          onclick="copyInviteLink('${inviteUrl}')" 
          class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          ${isExpired ? 'disabled' : ''}
        >
          Copy Link
        </button>
        <button 
          onclick="shareInviteLink('${inviteUrl}', '${code}')" 
          class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors"
          ${isExpired ? 'disabled' : ''}
        >
          Share
        </button>
        <button 
          onclick="revokeInviteLink('${code}')" 
          class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
        >
          Revoke
        </button>
      </div>
    </div>
  `;
  
  return card;
}

// Global functions for invite link management (called from HTML)
window.copyInviteLink = async function(url) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(url);
      showPoolSwitchFeedback('Invite link copied to clipboard!', 'success');
    } else {
      // Fallback for non-secure contexts
      const textArea = document.createElement('textarea');
      textArea.value = url;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showPoolSwitchFeedback('Invite link copied!', 'success');
    }
  } catch (error) {
    console.error('Error copying invite link:', error);
    showPoolSwitchFeedback('Failed to copy link', 'error');
  }
};

window.shareInviteLink = async function(url, code) {
  const poolName = allUI.currentPoolNameDisplay.textContent || 'NerdFootball Pool';
  
  if (navigator.share && /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
    // Use native sharing on mobile devices
    try {
      await navigator.share({
        title: `Join ${poolName}`,
        text: `You're invited to join ${poolName}! Use invite code: ${code}`,
        url: url
      });
      showPoolSwitchFeedback('Invite shared successfully!', 'success');
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('Error sharing invite:', error);
        fallbackShare(url, code, poolName);
      }
    }
  } else {
    // Fallback for desktop or unsupported browsers
    fallbackShare(url, code, poolName);
  }
};

function fallbackShare(url, code, poolName) {
  // Create email sharing option
  const subject = encodeURIComponent(`Join ${poolName}`);
  const body = encodeURIComponent(`You're invited to join ${poolName}!

Click this link to join: ${url}

Or use invite code: ${code}

See you in the pool!`);
  
  const emailUrl = `mailto:?subject=${subject}&body=${body}`;
  window.open(emailUrl, '_blank');
  showPoolSwitchFeedback('Email app opened for sharing', 'success');
}

window.revokeInviteLink = async function(code) {
  if (!confirm('Are you sure you want to revoke this invite link? It will no longer work for new members.')) return;
  
  try {
    // Update invite status to revoked
    const inviteRef = doc(db, `artifacts/${appId()}/invites/${code}`);
    await updateDoc(inviteRef, {
      status: 'revoked',
      revokedAt: new Date().toISOString(),
      revokedBy: currentUser.uid
    });
    
    // Update pool invites list
    const currentPoolId = getCurrentPool();
    const poolInvitesRef = doc(db, `artifacts/${appId()}/pools/${currentPoolId}/metadata/invites`);
    await updateDoc(poolInvitesRef, {
      [`${code}.status`]: 'revoked'
    });
    
    showPoolSwitchFeedback('Invite link revoked successfully', 'success');
    await loadInviteLinks(); // Reload the invite list
    
  } catch (error) {
    console.error('Error revoking invite link:', error);
    showPoolSwitchFeedback('Failed to revoke invite link', 'error');
  }
};

async function createQuickInviteLink() {
  try {
    // Show loading state
    allUI.createInviteLinkBtn.disabled = true;
    allUI.createInviteLinkBtn.textContent = 'Creating...';
    
    const inviteLink = await createInviteLink(7, null); // 7 days, unlimited uses
    
    showPoolSwitchFeedback(`Invite link created! Code: ${inviteLink.code}`, 'success');
    await loadInviteLinks(); // Reload the invite list
    
  } catch (error) {
    console.error('Error creating quick invite link:', error);
    showPoolSwitchFeedback('Failed to create invite link', 'error');
  } finally {
    // Reset button state
    allUI.createInviteLinkBtn.disabled = false;
    allUI.createInviteLinkBtn.textContent = 'Create New Link';
  }
}

// Check for invite code in URL on page load
async function checkForInviteCode() {
  const urlParams = new URLSearchParams(window.location.search);
  const inviteCode = urlParams.get('invite');
  
  if (inviteCode) {
    // Remove invite parameter from URL
    const url = new URL(window.location);
    url.searchParams.delete('invite');
    window.history.replaceState({}, '', url);
    
    if (currentUser) {
      // User is logged in, process invite
      await processInviteCode(inviteCode);
    } else {
      // User is not logged in, store invite for after login
      localStorage.setItem('pendingInviteCode', inviteCode);
      showPoolSwitchFeedback('Please log in to join the pool', 'info');
    }
  }
}

async function processInviteCode(inviteCode) {
  try {
    const result = await useInviteCode(inviteCode);
    
    // Switch to the new pool
    setActivePool(result.poolId);
    await renderPoolSwitcher();
    
    showPoolSwitchFeedback(`Welcome to ${result.poolName}!`, 'success');
    
    // Reload current view with new pool context
    await loadAndRenderWeek(currentWeek);
    
  } catch (error) {
    console.error('Error processing invite code:', error);
    showInviteError(error.message);
  }
}

function showInviteError(message) {
  // Create invite error modal
  const errorModal = document.createElement('div');
  errorModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  errorModal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
      <div class="flex items-center space-x-3 mb-4">
        <div class="flex-shrink-0">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L5.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-slate-900">Unable to Join Pool</h3>
        </div>
      </div>
      <p class="text-slate-600 mb-6">${message}</p>
      <div class="flex justify-end">
        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors">
          Close
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(errorModal);
  
  // Auto-remove after 10 seconds
  setTimeout(() => {
    if (document.body.contains(errorModal)) {
      document.body.removeChild(errorModal);
    }
  }, 10000);
}

function promptForInviteCode() {
  // Create invite code prompt modal
  const promptModal = document.createElement('div');
  promptModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  promptModal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
      <h3 class="text-lg font-semibold text-slate-900 mb-4">Join Pool</h3>
      <p class="text-slate-600 mb-4">Enter the invite code or paste the invite link:</p>
      
      <input 
        type="text" 
        id="invite-code-input" 
        class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors mb-4" 
        placeholder="Enter invite code or paste link"
        autocomplete="off"
      >
      
      <div class="flex justify-end space-x-3">
        <button 
          onclick="this.parentElement.parentElement.parentElement.remove()" 
          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 transition-colors"
        >
          Cancel
        </button>
        <button 
          onclick="joinPoolWithCode()" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
          id="join-pool-submit-btn"
        >
          Join Pool
        </button>
      </div>
      
      <div id="join-pool-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
        <p class="text-red-700 text-sm"></p>
      </div>
    </div>
  `;
  
  document.body.appendChild(promptModal);
  
  // Focus on input
  document.getElementById('invite-code-input').focus();
  
  // Handle Enter key
  document.getElementById('invite-code-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      joinPoolWithCode();
    }
  });
}

window.joinPoolWithCode = async function() {
  const input = document.getElementById('invite-code-input');
  const submitBtn = document.getElementById('join-pool-submit-btn');
  const errorDiv = document.getElementById('join-pool-error');
  
  let inviteCode = input.value.trim();
  
  if (!inviteCode) {
    showJoinPoolError('Please enter an invite code');
    return;
  }
  
  // Extract invite code from URL if full URL is pasted
  if (inviteCode.includes('?invite=')) {
    const match = inviteCode.match(/[?&]invite=([^&]+)/);
    if (match) {
      inviteCode = match[1];
    }
  }
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.textContent = 'Joining...';
  errorDiv.classList.add('hidden');
  
  try {
    const result = await useInviteCode(inviteCode);
    
    // Close modal
    const modal = submitBtn.closest('.fixed');
    modal.remove();
    
    // Switch to the new pool
    setActivePool(result.poolId);
    await renderPoolSwitcher();
    
    showPoolSwitchFeedback(`Successfully joined ${result.poolName}!`, 'success');
    
    // Reload current view with new pool context
    await loadAndRenderWeek(currentWeek);
    
  } catch (error) {
    console.error('Error joining pool with code:', error);
    showJoinPoolError(error.message);
    
    // Reset button state
    submitBtn.disabled = false;
    submitBtn.textContent = 'Join Pool';
  }
};

function showJoinPoolError(message) {
  const errorDiv = document.getElementById('join-pool-error');
  const errorText = errorDiv.querySelector('p');
  
  if (errorDiv && errorText) {
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
  }
}

// --- POOL DISCOVERY ---
let currentPoolSearchState = {
  searchTerm: '',
  typeFilter: '',
  currentPage: 1,
  poolsPerPage: 10,
  totalPools: 0,
  isLoading: false
};

function openPoolDiscoveryModal() {
  allUI.poolDiscoveryModal.classList.remove('hidden');
  allUI.poolDiscoveryModal.classList.add('flex');
  
  // Reset search state
  currentPoolSearchState = {
    searchTerm: '',
    typeFilter: '',
    currentPage: 1,
    poolsPerPage: 10,
    totalPools: 0,
    isLoading: false
  };
  
  // Clear and reset form
  allUI.poolSearch.value = '';
  allUI.poolTypeFilter.value = '';
  allUI.activeFilters.classList.add('hidden');
  
  // Load initial pools
  searchPublicPools();
  
  // Set up event listeners if not already done
  setupPoolDiscoveryListeners();
}

function setupPoolDiscoveryListeners() {
  // Prevent multiple listeners
  if (allUI.poolSearch.hasDiscoveryListener) return;
  allUI.poolSearch.hasDiscoveryListener = true;
  
  // Close modal
  allUI.closePoolDiscoveryBtn.addEventListener('click', closePoolDiscoveryModal);
  
  // Search input with debounce
  let searchTimeout;
  allUI.poolSearch.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentPoolSearchState.searchTerm = e.target.value.trim();
      currentPoolSearchState.currentPage = 1;
      searchPublicPools();
    }, 500);
  });
  
  // Type filter
  allUI.poolTypeFilter.addEventListener('change', (e) => {
    currentPoolSearchState.typeFilter = e.target.value;
    currentPoolSearchState.currentPage = 1;
    searchPublicPools();
  });
  
  // Pagination
  allUI.prevPage.addEventListener('click', () => {
    if (currentPoolSearchState.currentPage > 1) {
      currentPoolSearchState.currentPage--;
      searchPublicPools();
    }
  });
  
  allUI.nextPage.addEventListener('click', () => {
    const maxPages = Math.ceil(currentPoolSearchState.totalPools / currentPoolSearchState.poolsPerPage);
    if (currentPoolSearchState.currentPage < maxPages) {
      currentPoolSearchState.currentPage++;
      searchPublicPools();
    }
  });
  
  // Close on backdrop click
  allUI.poolDiscoveryModal.addEventListener('click', (e) => {
    if (e.target === allUI.poolDiscoveryModal) {
      closePoolDiscoveryModal();
    }
  });
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !allUI.poolDiscoveryModal.classList.contains('hidden')) {
      closePoolDiscoveryModal();
    }
  });
}

function closePoolDiscoveryModal() {
  allUI.poolDiscoveryModal.classList.add('hidden');
  allUI.poolDiscoveryModal.classList.remove('flex');
}

async function searchPublicPools() {
  if (currentPoolSearchState.isLoading) return;
  
  currentPoolSearchState.isLoading = true;
  showPoolsLoading();
  
  try {
    // Query Firestore for public pools
    const poolsCollection = collection(db, 'pools');
    let pools = [];
    
    // Get all pools first (in a real app, this would be optimized with proper queries)
    const querySnapshot = await getDocs(poolsCollection);
    
    querySnapshot.forEach((doc) => {
      const poolData = doc.data();
      
      // Only include public pools
      if (poolData.settings?.joinType === 'open') {
        pools.push({
          id: doc.id,
          ...poolData
        });
      }
    });
    
    // Apply client-side filtering (in production, this would be server-side)
    let filteredPools = pools;
    
    // Search term filter
    if (currentPoolSearchState.searchTerm) {
      const searchLower = currentPoolSearchState.searchTerm.toLowerCase();
      filteredPools = filteredPools.filter(pool => 
        pool.name?.toLowerCase().includes(searchLower) ||
        pool.description?.toLowerCase().includes(searchLower) ||
        pool.creator?.toLowerCase().includes(searchLower)
      );
    }
    
    // Type filter
    if (currentPoolSearchState.typeFilter) {
      filteredPools = filteredPools.filter(pool => 
        pool.type === currentPoolSearchState.typeFilter
      );
    }
    
    // Update total count
    currentPoolSearchState.totalPools = filteredPools.length;
    
    // Apply pagination
    const startIndex = (currentPoolSearchState.currentPage - 1) * currentPoolSearchState.poolsPerPage;
    const paginatedPools = filteredPools.slice(startIndex, startIndex + currentPoolSearchState.poolsPerPage);
    
    // Display results
    displayPoolResults(paginatedPools);
    updatePoolsPagination();
    updateActiveFilters();
    
  } catch (error) {
    console.error('Error searching pools:', error);
    showPoolsError('Failed to search pools. Please try again.');
  } finally {
    currentPoolSearchState.isLoading = false;
  }
}

function showPoolsLoading() {
  allUI.poolsLoading.classList.remove('hidden');
  allUI.poolsEmpty.classList.add('hidden');
  allUI.poolsResults.classList.add('hidden');
  allUI.poolsPagination.classList.add('hidden');
  allUI.poolsError.classList.add('hidden');
}

function showPoolsError(message) {
  allUI.poolsError.classList.remove('hidden');
  allUI.poolsErrorMessage.textContent = message;
  allUI.poolsLoading.classList.add('hidden');
  allUI.poolsEmpty.classList.add('hidden');
  allUI.poolsResults.classList.add('hidden');
  allUI.poolsPagination.classList.add('hidden');
}

function displayPoolResults(pools) {
  allUI.poolsLoading.classList.add('hidden');
  allUI.poolsError.classList.add('hidden');
  
  if (pools.length === 0) {
    allUI.poolsEmpty.classList.remove('hidden');
    allUI.poolsResults.classList.add('hidden');
    allUI.poolsPagination.classList.add('hidden');
    return;
  }
  
  allUI.poolsEmpty.classList.add('hidden');
  allUI.poolsResults.classList.remove('hidden');
  
  // Generate pool cards HTML
  const poolCardsHTML = pools.map(pool => createPoolCard(pool)).join('');
  allUI.poolsResults.innerHTML = poolCardsHTML;
  
  // Add join button event listeners
  allUI.poolsResults.querySelectorAll('.join-pool-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const poolId = btn.dataset.poolId;
      const poolName = btn.dataset.poolName;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Joining...';
        
        await joinPool(poolId);
        closePoolDiscoveryModal();
        showPoolSwitchFeedback(`Successfully joined ${poolName}!`, 'success');
        
      } catch (error) {
        console.error('Error joining pool:', error);
        btn.disabled = false;
        btn.textContent = 'Join Pool';
        showPoolSwitchFeedback(`Failed to join ${poolName}: ${error.message}`, 'error');
      }
    });
  });
}

function createPoolCard(pool) {
  const memberCount = pool.memberCount || 0;
  const maxMembers = pool.settings?.maxMembers || 'Unlimited';
  const gameTypes = pool.type === 'both' ? 'Confidence + Survivor' : 
                   pool.type === 'confidence' ? 'Confidence Only' : 'Survivor Only';
  
  const createdDate = pool.created ? new Date(pool.created).toLocaleDateString() : 'Unknown';
  
  return `
    <div class="bg-white border border-slate-200 rounded-lg p-6 hover:shadow-md transition-shadow">
      <div class="flex justify-between items-start mb-4">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-slate-900">${escapeHtml(pool.name || 'Unnamed Pool')}</h3>
          <p class="text-sm text-slate-600 mt-1">${escapeHtml(pool.description || 'No description available')}</p>
        </div>
        <div class="ml-4 flex-shrink-0">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
            pool.type === 'both' ? 'bg-purple-100 text-purple-800' :
            pool.type === 'confidence' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
          }">
            ${gameTypes}
          </span>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4 text-sm text-slate-600 mb-4">
        <div>
          <span class="font-medium">Members:</span>
          ${memberCount}${maxMembers !== 'Unlimited' ? ` / ${maxMembers}` : ''}
        </div>
        <div>
          <span class="font-medium">Created:</span>
          ${createdDate}
        </div>
        <div>
          <span class="font-medium">Status:</span>
          <span class="capitalize ${pool.status === 'active' ? 'text-green-600' : 'text-slate-600'}">
            ${pool.status || 'Active'}
          </span>
        </div>
        <div>
          <span class="font-medium">Season:</span>
          ${pool.season || '2025'}
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <div class="text-xs text-slate-500">
          Created by ${escapeHtml(pool.creatorName || 'Unknown')}
        </div>
        <button 
          class="join-pool-btn px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
          data-pool-id="${pool.id}"
          data-pool-name="${escapeHtml(pool.name || 'Pool')}"
          ${memberCount >= maxMembers && maxMembers !== 'Unlimited' ? 'disabled' : ''}
        >
          ${memberCount >= maxMembers && maxMembers !== 'Unlimited' ? 'Pool Full' : 'Join Pool'}
        </button>
      </div>
    </div>
  `;
}

function updatePoolsPagination() {
  const totalPages = Math.ceil(currentPoolSearchState.totalPools / currentPoolSearchState.poolsPerPage);
  
  if (totalPages <= 1) {
    allUI.poolsPagination.classList.add('hidden');
    return;
  }
  
  allUI.poolsPagination.classList.remove('hidden');
  
  // Update pagination controls
  allUI.prevPage.disabled = currentPoolSearchState.currentPage <= 1;
  allUI.nextPage.disabled = currentPoolSearchState.currentPage >= totalPages;
  allUI.pageInfo.textContent = `Page ${currentPoolSearchState.currentPage} of ${totalPages}`;
}

function updateActiveFilters() {
  const hasFilters = currentPoolSearchState.searchTerm || currentPoolSearchState.typeFilter;
  
  if (!hasFilters) {
    allUI.activeFilters.classList.add('hidden');
    return;
  }
  
  allUI.activeFilters.classList.remove('hidden');
  const filterTags = [];
  
  if (currentPoolSearchState.searchTerm) {
    filterTags.push(`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
      Search: ${escapeHtml(currentPoolSearchState.searchTerm)}
      <button type="button" class="ml-1 h-3 w-3 rounded-full inline-flex items-center justify-center hover:bg-blue-200" onclick="clearSearchFilter()">
        <svg class="h-2 w-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </span>`);
  }
  
  if (currentPoolSearchState.typeFilter) {
    const typeLabels = {
      'confidence': 'Confidence Only',
      'survivor': 'Survivor Only', 
      'both': 'Both Games'
    };
    
    filterTags.push(`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
      Type: ${typeLabels[currentPoolSearchState.typeFilter]}
      <button type="button" class="ml-1 h-3 w-3 rounded-full inline-flex items-center justify-center hover:bg-purple-200" onclick="clearTypeFilter()">
        <svg class="h-2 w-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </span>`);
  }
  
  allUI.filterTags.innerHTML = filterTags.join('');
}

// Global functions for filter removal (called from HTML)
window.clearSearchFilter = function() {
  currentPoolSearchState.searchTerm = '';
  currentPoolSearchState.currentPage = 1;
  allUI.poolSearch.value = '';
  searchPublicPools();
};

window.clearTypeFilter = function() {
  currentPoolSearchState.typeFilter = '';
  currentPoolSearchState.currentPage = 1;
  allUI.poolTypeFilter.value = '';
  searchPublicPools();
};

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

 
 // --- SAVE STATUS ---
 function updateSaveStatus(status, message) {
 if(saveTimeout) clearTimeout(saveTimeout);
 allUI.saveStatusIcon.style.animation = 'none';
 
 switch(status) {
 case 'saving':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusIcon.style.animation = 'spin 1s linear infinite';
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-gray-500';
 break;
 case 'saved':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-green-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 2500);
 break;
 case 'error':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-red-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 3000);
 break;
 case 'idle':
 default:
 allUI.saveStatusIcon.innerHTML = '';
 allUI.saveStatusText.textContent = '';
 break;
 }
 }

 // Get game state using proper validation logic
function getGameState(game) {
    const now = new Date();
    const kickoff = new Date(game.kickoff);
    
    if (now < kickoff) {
        return 'PRE_GAME';
    } else if (game.winner && game.winner !== 'TBD') {
        return 'COMPLETED';
    } else {
        return 'IN_PROGRESS';
    }
}

function getTeamHelmetClass(teamName) {
    const teamMap = {
        "Arizona Cardinals": "helmet-ari", "Atlanta Falcons": "helmet-atl", "Baltimore Ravens": "helmet-bal", 
        "Buffalo Bills": "helmet-buf", "Carolina Panthers": "helmet-car", "Chicago Bears": "helmet-chi", 
        "Cincinnati Bengals": "helmet-cin", "Cleveland Browns": "helmet-cle", "Dallas Cowboys": "helmet-dal", 
        "Denver Broncos": "helmet-den", "Detroit Lions": "helmet-det", "Green Bay Packers": "helmet-gb", 
        "Houston Texans": "helmet-hou", "Indianapolis Colts": "helmet-ind", "Jacksonville Jaguars": "helmet-jax", 
        "Kansas City Chiefs": "helmet-kc", "Las Vegas Raiders": "helmet-lv", "Los Angeles Chargers": "helmet-lac", 
        "Los Angeles Rams": "helmet-lar", "Miami Dolphins": "helmet-mia", "Minnesota Vikings": "helmet-min", 
        "New England Patriots": "helmet-ne", "New Orleans Saints": "helmet-no", "New York Giants": "helmet-nyg", 
        "New York Jets": "helmet-nyj", "Philadelphia Eagles": "helmet-phi", "Pittsburgh Steelers": "helmet-pit", 
        "San Francisco 49ers": "helmet-sf", "Seattle Seahawks": "helmet-sea", "Tampa Bay Buccaneers": "helmet-tb", 
        "Tennessee Titans": "helmet-ten", "Washington Commanders": "helmet-was"
    };
    return teamMap[teamName] || '';
}

// Check if individual game is locked (started)
 function isGameLocked(game) {
  // SECURITY FIX: Use proper game state validation to prevent picks during IN_PROGRESS games
  const gameState = getGameState(game);
  // Only allow picks when games are PRE_GAME
  return gameState === 'IN_PROGRESS' || gameState === 'COMPLETED';
 }

 // Get locked games for a week
 async function getLockedGames(weekNumber) {
  const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) }; 
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) return new Set(); 
  const lockedGameIds = new Set();
  weekData.games.forEach(game => {
   if (isGameLocked(game)) {
    lockedGameIds.add(game.id);
   }
  });
  return lockedGameIds;
 }

 // Legacy function for backwards compatibility
 async function getWeekLockStatus(weekNumber) { 
  const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) }; 
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) return false; 
  const firstKickoff = new Date(weekData.games[0].kickoff); 
  return new Date() > firstKickoff; 
 }

 // Helper function to identify Monday Night Football games
 function getMondayNightGame(games) {
   if (!games || !Array.isArray(games)) return null;
   
   // Find all games that occur on Monday (day of week = 1)
   const mondayGames = games.filter(game => {
     const gameTime = new Date(game.kickoff);
     return gameTime.getDay() === 1; // Monday
   });
   
   // If multiple Monday games, return the latest one (last game of the week)
   if (mondayGames.length > 1) {
     return mondayGames.reduce((latest, current) => {
       const latestTime = new Date(latest.kickoff);
       const currentTime = new Date(current.kickoff);
       return currentTime > latestTime ? current : latest;
     });
   }
   
   return mondayGames.length > 0 ? mondayGames[0] : null;
 }

 // Helper function to extract winner from game result (handles both old and new formats)
 function getGameWinner(gameResult) {
   if (!gameResult) return null;
   
   // Handle legacy format (just winner string)
   if (typeof gameResult === 'string') {
     return gameResult;
   }
   
   // Handle new format (object with winner and scores)
   if (typeof gameResult === 'object' && gameResult.winner) {
     return gameResult.winner;
   }
   
   return null;
 }

 // Expanded Game View functionality
 let currentExpandedGame = null;

 window.expandGameView = async function(gameId, element) {
   const expandedView = document.getElementById('expanded-game-view');
   const expandedContent = document.getElementById('expanded-game-content');
   
   // If clicking the same game, collapse it
   if (currentExpandedGame === gameId) {
     collapseGameView();
     return;
   }
   
   // If another game is expanded, fade it out first
   if (currentExpandedGame) {
     expandedView.classList.add('opacity-0');
     await new Promise(resolve => setTimeout(resolve, 300));
   }
   
   currentExpandedGame = gameId;
   expandedView.dataset.gameId = gameId; // Store the game ID for ESPN updates
   
   // Get game data
   const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
   const game = weekData.games.find(g => g.id == gameId);
  if (!game) return;
  
  // Handle both property names (away/home and a/h)
  const awayTeam = game.away || game.a;
  const homeTeam = game.home || game.h;
   
   // Get user pick for this game
   const docRef = doc(db, picksPath(currentWeek, currentUser.uid));
   const docSnap = await getDoc(docRef);
   const userPicks = docSnap.exists() ? docSnap.data() : {};
   const userPick = userPicks[gameId];
   
   // Get live data if available
   let liveData = null;
   try {
     if (window.espnApi) {
       const espnGames = await window.espnApi.getWeekGames(currentWeek);
       const espnGame = espnGames.find(g => 
         (g.a === game.away || g.awayTeam === game.away) && 
         (g.h === game.home || g.homeTeam === game.home)
       );
       if (espnGame) {
         liveData = espnGame;
       }
     }
   } catch (error) {
     console.warn('Could not fetch live data for expanded view');
   }
   
   // Render expanded content
   const awayAbbr = teamNameToAbbr[game.away] || game.away;
   const homeAbbr = teamNameToAbbr[game.home] || game.home;
   const awayLogo = nflTeamLogos[awayAbbr] || '';
   const homeLogo = nflTeamLogos[homeAbbr] || '';
   
   const gameTime = new Date(game.kickoff);
   const formattedTime = gameTime.toLocaleString('en-US', {
     weekday: 'short',
     month: 'short',
     day: 'numeric',
     hour: 'numeric',
     minute: '2-digit'
   });
   
   expandedContent.innerHTML = `
     <div class="flex justify-between items-start mb-4">
       <h4 class="text-lg font-bold text-slate-800">Game Details</h4>
       <button onclick="collapseGameView()" class="text-slate-500 hover:text-slate-700">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
         </svg>
       </button>
     </div>
     
     <div class="grid grid-cols-2 gap-4 mb-4">
       <!-- Away Team -->
       <div class="text-center p-3 bg-white rounded-lg border ${userPick?.winner === game.away ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200'}">
         <img src="${awayLogo}" alt="${game.away}" class="w-12 h-12 mx-auto mb-2">
         <div class="font-semibold text-slate-800">${game.away}</div>
          ${liveData?.awayScore !== undefined ? `<div class="text-2xl font-bold mt-2">${liveData.awayScore}</div>` : ''}
       </div>
       
       <!-- Home Team -->
       <div class="text-center p-3 bg-white rounded-lg border ${userPick?.winner === game.home ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200'}">
         <img src="${homeLogo}" alt="${game.home}" class="w-12 h-12 mx-auto mb-2">
         <div class="font-semibold text-slate-800">${game.home}</div>
          ${liveData?.homeScore !== undefined ? `<div class="text-2xl font-bold mt-2">${liveData.homeScore}</div>` : ''}
       </div>
     </div>
     
     
     <!-- Game Info -->
     <div class="bg-white rounded-lg p-3 space-y-2 text-sm">
       <div class="flex justify-between">
         <span class="text-slate-600">Kickoff:</span>
         <span class="font-medium">${formattedTime}</span>
       </div>
       
       ${userPick ? `
       <div class="flex justify-between">
         <span class="text-slate-600">Your Pick:</span>
         <span class="font-medium text-blue-600">${userPick.winner} (${userPick.confidence} pts)</span>
       </div>
       ` : ''}
       
       ${liveData?.venue ? `
       <div class="flex justify-between">
         <span class="text-slate-600">Venue:</span>
         <span class="font-medium">${liveData.venue.name}</span>
       </div>
       ` : ''}
       
       ${liveData?.weather ? `
       <div class="flex justify-between">
         <span class="text-slate-600">Weather:</span>
         <span class="font-medium">${liveData.weather.temperature}F, ${liveData.weather.condition || liveData.weather.description || 'Clear'}</span>
       </div>
       ` : ''}
       
       ${liveData?.broadcasts && liveData.broadcasts.length > 0 ? `
       <div class="flex justify-between">
         <span class="text-slate-600">TV:</span>
         <span class="font-medium">${liveData.broadcasts.map(b => typeof b === 'string' ? b : b.name || b.market || 'TV').join(', ')}</span>
       </div>
       ` : ''}
       
       ${liveData?.status ? `
       <div class="flex justify-between">
         <span class="text-slate-600">Status:</span>
         <span class="font-medium ${liveData.status === 'FINAL' ? 'text-slate-700' : 'text-emerald-600'}">${liveData.status}${liveData.clock && liveData.quarter ? ` (${liveData.clock} Q${liveData.quarter})` : ''}</span>
       </div>
       ` : ''}
       
       ${liveData?.probability ? `
       <div class="mt-3 pt-3 border-t">
         <div class="text-xs text-slate-600 mb-2">Win Probability</div>
         <div class="flex justify-between text-sm">
           <span>${game.away}: ${liveData.probability.awayWinPercentage}%</span>
           <span>${game.home}: ${liveData.probability.homeWinPercentage}%</span>
         </div>
         <div class="w-full bg-slate-200 rounded-full h-2 mt-1">
           <div class="bg-blue-600 h-2 rounded-full" style="width: ${liveData.probability.awayWinPercentage}%"></div>
         </div>
       </div>
       ` : ''}
     </div>
     
     <!-- News Links Section -->
     <div class="mt-4 bg-white rounded-lg p-3">
       <h5 class="text-sm font-semibold text-slate-700 mb-3">Latest News & Analysis</h5>
       <div class="space-y-2">
         <a href="https://www.espn.com/nfl/teams/roster/_/name/${awayAbbr.toLowerCase()}" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-blue-50 rounded transition-colors">
           <span class="text-sm text-blue-600 hover:text-blue-800">${game.away} Roster & Injuries</span>
           <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         
         <a href="https://www.espn.com/nfl/teams/roster/_/name/${homeAbbr.toLowerCase()}" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-blue-50 rounded transition-colors">
           <span class="text-sm text-blue-600 hover:text-blue-800">${game.home} Roster & Injuries</span>
           <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         
         <a href="https://www.pro-football-reference.com/years/2025/week_${currentWeek}.htm" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-blue-50 rounded transition-colors">
           <span class="text-sm text-blue-600 hover:text-blue-800">Week ${currentWeek} Game Stats</span>
           <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         
         <a href="https://www.theringer.com/nfl" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-blue-50 rounded transition-colors">
           <span class="text-sm text-blue-600 hover:text-blue-800">The Ringer NFL Analysis</span>
           <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         
         <a href="https://www.fantasypros.com/nfl/matchups/${awayAbbr.toLowerCase()}-${homeAbbr.toLowerCase()}.php" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-blue-50 rounded transition-colors">
           <span class="text-sm text-blue-600 hover:text-blue-800">Fantasy Matchup Analysis</span>
           <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         
         ${liveData?.id ? `
         <a href="https://www.espn.com/nfl/game/_/gameId/${liveData.id}" 
            target="_blank" 
            class="flex items-center justify-between p-2 hover:bg-emerald-50 rounded transition-colors border border-emerald-200">
           <span class="text-sm text-emerald-600 font-semibold">Live ESPN Gamecast</span>
           <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
           </svg>
         </a>
         ` : ''}
       </div>
     </div>
     
     <div class="mt-4 text-xs text-slate-500 text-center">
       Click any link above for detailed analysis and real-time updates
     </div>
   `;
   
   // Show the expanded view with fade-in
   expandedView.classList.remove('hidden');
   setTimeout(() => {
     expandedView.classList.remove('opacity-0');
   }, 10);
 }

 window.collapseGameView = function() {
   const expandedView = document.getElementById('expanded-game-view');
   expandedView.classList.add('opacity-0');
   setTimeout(() => {
     expandedView.classList.add('hidden');
     expandedView.dataset.gameId = ''; // Clear the stored game ID
     currentExpandedGame = null;
   }, 300);
 }

 // Listen for ESPN score updates and refresh expanded view if needed
 window.addEventListener('espnScoresUpdated', async (event) => {
   const expandedView = document.getElementById('expanded-game-view');
   
   // Check if expanded view is visible and has a game ID
   if (expandedView && !expandedView.classList.contains('hidden') && expandedView.dataset.gameId) {
     const expandedGameId = expandedView.dataset.gameId;
     const weekNumber = event.detail.weekNumber;
     
     // Check if the update is for the current week
     if (weekNumber == currentWeek) {
       // Simply re-expand the game to get the latest data
       const gameCard = document.querySelector(`[data-game-id="${expandedGameId}"]`);
       if (gameCard) {
         console.log(` Refreshing expanded view for game ${expandedGameId} with ESPN updates`);
         window.expandGameView(expandedGameId, gameCard);
       }
     }
   }
 });

 // === AUTO-CYCLING FUNCTIONALITY FOR EXPANDED GAME VIEW ===
 let gameCycleTimer = null;
 let currentCycleIndex = 0;
 let availableGameIds = [];
 let cyclingPaused = false;

 // Get available game IDs from Active Picks in order
 function getAvailableGameIds() {
   const gameCards = document.querySelectorAll('.game-pick-card[data-game-id]');
   return Array.from(gameCards).map(card => card.dataset.gameId);
 }

 // Start auto-cycling through games
 function startGameCycling() {
   availableGameIds = getAvailableGameIds();
   if (availableGameIds.length <= 1) return; // No point cycling with 1 or 0 games
   
   // Clear any existing timer
   if (gameCycleTimer) {
     clearInterval(gameCycleTimer);
   }
   
   // Add glow effect to expanded view
   const expandedView = document.getElementById('expanded-game-view');
   if (expandedView) {
     expandedView.style.boxShadow = '0 0 8px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(59, 130, 246, 0.1)';
     expandedView.style.transition = 'box-shadow 0.3s ease-in-out';
   }
   
   // Start 60-second interval
   gameCycleTimer = setInterval(() => {
     if (!cyclingPaused && availableGameIds.length > 1) {
       cycleToNextGame();
     }
   }, 60000); // 60 seconds
 }

 // Stop auto-cycling
 function stopGameCycling() {
   if (gameCycleTimer) {
     clearInterval(gameCycleTimer);
     gameCycleTimer = null;
   }
   
   // Remove glow effect
   const expandedView = document.getElementById('expanded-game-view');
   if (expandedView) {
     expandedView.style.boxShadow = '';
   }
 }

 // Cycle to next game with fade transitions
 async function cycleToNextGame() {
   if (availableGameIds.length <= 1) return;
   
   // Move to next game (loop back to start if at end)
   currentCycleIndex = (currentCycleIndex + 1) % availableGameIds.length;
   const nextGameId = availableGameIds[currentCycleIndex];
   const nextGameCard = document.querySelector(`[data-game-id="${nextGameId}"]`);
   
   if (nextGameCard && nextGameId !== currentExpandedGame) {
     // Expand the next game (this handles fade transitions internally)
     await originalExpandGameView.call(window, nextGameId, nextGameCard);
   }
 }

 // Add hover event listeners to pause/resume cycling
 function setupCyclingEventListeners() {
   const expandedView = document.getElementById('expanded-game-view');
   if (expandedView) {
     expandedView.addEventListener('mouseenter', () => {
       cyclingPaused = true;
     });
     
     expandedView.addEventListener('mouseleave', () => {
       cyclingPaused = false;
     });
   }
 }

 // Modified expandGameView to handle cycling
 const originalExpandGameView = window.expandGameView;
 window.expandGameView = async function(gameId, element, isManualClick = true) {
   // If manually clicked, reset cycling timer and update index
   if (isManualClick) {
     availableGameIds = getAvailableGameIds();
     currentCycleIndex = availableGameIds.indexOf(gameId);
     if (currentCycleIndex === -1) currentCycleIndex = 0;
     
     // Restart cycling timer
     if (gameCycleTimer) {
       stopGameCycling();
       startGameCycling();
     }
   }
   
   // Call original function
   await originalExpandGameView.call(this, gameId, element);
   
   // If this is the first expansion, start cycling
   if (!gameCycleTimer && availableGameIds.length > 1) {
     startGameCycling();
     setupCyclingEventListeners();
   }
 };

 // Modified collapseGameView to stop cycling
 const originalCollapseGameView = window.collapseGameView;
 window.collapseGameView = function() {
   stopGameCycling();
   originalCollapseGameView.call(this);
 };

 // Helper function to calculate total points scored in a game
 function calculateGameTotalPoints(gameResult) {
   if (!gameResult) return null;
   
   // Handle legacy format (just winner string)
   if (typeof gameResult === 'string') {
     return null; // Can't calculate total from just winner
   }
   
   // Handle new format (object with scores)
   if (typeof gameResult === 'object') {
     const homeScore = parseInt(gameResult.homeScore) || 0;
     const awayScore = parseInt(gameResult.awayScore) || 0;
     
     // Only return total if both scores are available and valid
     if (gameResult.homeScore !== null && gameResult.awayScore !== null) {
       return homeScore + awayScore;
     }
   }
   
   return null;
 }

 // Sort leaderboard with Monday Night Football tiebreaker logic
 async function sortLeaderboardWithTiebreaker(scores, weekNumber, scoreField = 'score') {
   if (!weekNumber) {
     // For season totals, just sort by score descending
     return scores.sort((a, b) => b[scoreField] - a[scoreField]);
   }
   
   // Get week data and identify Monday Night game
   const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
   const mondayNightGame = getMondayNightGame(weekData.games);
   
   if (!mondayNightGame) {
     // No Monday Night game, use regular sorting
     return scores.sort((a, b) => b[scoreField] - a[scoreField]);
   }
   
   // Get game results and MNF actual total
   const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
   const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
   const mnfResult = gameResults[mondayNightGame.id];
   const mnfActualTotal = mnfResult ? calculateGameTotalPoints(mnfResult) : null;
   
   // Get all users' picks to access MNF guesses
   const picksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
   const userMnfGuesses = {};
   picksSnap.forEach(pickDoc => {
     const userPicks = pickDoc.data();
     if (userPicks.mnfTotalPoints !== undefined) {
       userMnfGuesses[pickDoc.id] = parseInt(userPicks.mnfTotalPoints, 10) || 0;
     }
   });
   
   // Add MNF points to each score object for display
   scores.forEach(score => {
     const userId = score.uid || score.userId;
     if (userMnfGuesses[userId] !== undefined) {
       score.mnfTotalPoints = userMnfGuesses[userId];
     }
   });
   
   // Sort with tiebreaker logic
   return scores.sort((a, b) => {
     // First, sort by confidence points score (descending)
     const scoreDiff = b[scoreField] - a[scoreField];
     if (scoreDiff !== 0) return scoreDiff;
     
     // If scores are tied and MNF game has results, apply tiebreaker
     if (mnfActualTotal !== null) {
       const aGuess = userMnfGuesses[a.uid || a.userId] || 0;
       const bGuess = userMnfGuesses[b.uid || b.userId] || 0;
       
       // Filter out guesses that go over
       const aValid = aGuess <= mnfActualTotal;
       const bValid = bGuess <= mnfActualTotal;
       
       // If one guess is valid and other is over, valid guess wins
       if (aValid && !bValid) return -1;
       if (bValid && !aValid) return 1;
       
       // If both valid or both invalid, closest to actual wins
       const aDiff = Math.abs(mnfActualTotal - aGuess);
       const bDiff = Math.abs(mnfActualTotal - bGuess);
       
       if (aValid && bValid) {
         // Both under or equal - closest wins
         return aDiff - bDiff;
       } else {
         // Both over - still closest wins, but they're both losers
         return aDiff - bDiff;
       }
     }
     
     // No tiebreaker available, maintain original order
     return 0;
   });
 }

 // Render leaderboard rows with tiebreaker information
 async function renderLeaderboardRows(sortedScores, weekNumber, scoreField = 'score') {
   if (!sortedScores || sortedScores.length === 0) return '';
   
   let mnfActualTotal = null;
   let userMnfGuesses = {};
   let mondayNightGame = null;
   
   // Get MNF info if this is a weekly leaderboard
   if (weekNumber) {
     const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
     mondayNightGame = getMondayNightGame(weekData.games);
     
     if (mondayNightGame) {
       // Get game results and MNF actual total
       const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
       const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
       const mnfResult = gameResults[mondayNightGame.id];
       mnfActualTotal = mnfResult ? calculateGameTotalPoints(mnfResult) : null;
       
       // Get all users' MNF guesses
       const picksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
       picksSnap.forEach(pickDoc => {
         const userPicks = pickDoc.data();
         if (userPicks.mnfTotalPoints) {
           userMnfGuesses[pickDoc.id] = parseInt(userPicks.mnfTotalPoints, 10);
         }
       });
     }
   }
   
   return sortedScores.map((s, index) => {
     const score = s[scoreField];
     
     // Check if this user is tied with next user (for tiebreaker display)
     const nextUser = sortedScores[index + 1];
     const isTied = nextUser && nextUser[scoreField] === score;
     const prevUser = sortedScores[index - 1];
     const wasTied = prevUser && prevUser[scoreField] === score;
     
     let tiebreakerInfo = '';
     if ((isTied || wasTied) && mondayNightGame && mnfActualTotal !== null) {
       const userGuess = userMnfGuesses[s.uid || s.userId] || 'N/A';
       const validGuess = userGuess !== 'N/A' && userGuess <= mnfActualTotal;
       const difference = userGuess !== 'N/A' ? Math.abs(mnfActualTotal - userGuess) : 'N/A';
       
       tiebreakerInfo = `
         <div class="text-xs text-blue-600 mt-1">
           MNF Guess: ${userGuess} (Actual: ${mnfActualTotal}, Diff: ${difference})
           ${validGuess ? '' : userGuess !== 'N/A' ? ' Over' : ' Missing'}
         </div>
       `;
     }
     
     return `
       <tr class="${(isTied || wasTied) ? 'bg-yellow-50' : ''}">
         <td class="px-6 py-4 whitespace-nowrap font-medium">${index + 1}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           ${s.displayName}
           ${tiebreakerInfo}
         </td>
         <td class="px-6 py-4 whitespace-nowrap font-bold">${score}</td>
       </tr>
     `;
   }).join('');
 }
 
 function updateWeekButtonStates() {
  if (allUI.prevWeekBtn && allUI.nextWeekBtn) {
    allUI.prevWeekBtn.disabled = currentWeek <= 1;
    allUI.nextWeekBtn.disabled = currentWeek >= 18;
  }
 }

 async function loadAndRenderWeek(weekNumber) { 
 currentWeek = parseInt(weekNumber, 10);
 document.getElementById('picks-container-title').textContent = `My picks for Week ${currentWeek}`;
 if (!currentUser) return; 
 if (unsubscribeFromPicks) unsubscribeFromPicks(); 
 updateSaveStatus('idle');

 allUI.gameList.innerHTML = `<div class="loader"></div>`;
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 allUI.resetPicksBtn.disabled = weekIsLocked;
 
 const docRef = doc(db, picksPath(currentWeek, currentUser.uid)); 
 
 const games = await getGamesForWeek(currentWeek);
 if (!Array.isArray(games) || games.length === 0) {
     allUI.gameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week. Please try again later.</p>';
     return;
 }

 unsubscribeFromPicks = onSnapshot(docRef, (docSnap) => { 
 let userPicks = {}; 
 const weekData = { week: currentWeek, games: games };

 if (docSnap.exists()) { 
 userPicks = docSnap.data(); 
 } else { 
 weekData.games.forEach((game, index) => { 
 userPicks[game.id] = { winner: null, confidence: index + 1 }; 
 }); 
 } 
 renderWeekUI(weekData, userPicks, weekIsLocked, allUI.gameList);
 updatePicksButtonStates(weekData);
 updateTimestamps(); 
 // Update picks summary if picks view is active
 if (!allUI.picksSummaryContainer.classList.contains('hidden')) {
  renderActivePicksSummary();
 }
 }); 
 }

 async function savePicksToFirestore(weekNum, picks) { 
  if (!currentUser) return; 
  updateSaveStatus('saving', 'Validating picks...');

  // Get current week games and check which ones are locked
  const weekData = { week: weekNum, games: await getGamesForWeek(weekNum) };
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) {
   updateSaveStatus('error', 'No games found');
   return;
  }

  // Get current picks from database
  const docRef = doc(db, picksPath(weekNum, currentUser.uid));
  const currentDoc = await getDoc(docRef);
  const currentPicks = currentDoc.exists() ? currentDoc.data() : {};

  // Validate each pick - only allow changes to games that haven't started
  const validatedPicks = { ...currentPicks };
  const lockedGames = [];
  const validChanges = [];
  const submissionTime = new Date().toISOString();

  // Preserve Monday Night Football tiebreaker points
  if (picks.mnfTotalPoints !== undefined) {
    validatedPicks.mnfTotalPoints = picks.mnfTotalPoints;
  }

  weekData.games.forEach(game => {
   const gameId = game.id.toString();
   const isLocked = isGameLocked(game);
   
   if (picks[gameId]) {
    if (isLocked) {
     // Game has started - keep existing pick, reject new one
     lockedGames.push(`${game.away} @ ${game.home}`);
    } else {
     // Game hasn't started - allow change
     validatedPicks[gameId] = picks[gameId];
     if (picks[gameId].winner) {
      validChanges.push({
       game: `${game.away} @ ${game.home}`,
       pick: picks[gameId].winner,
       confidence: picks[gameId].confidence,
       gameTime: game.kickoff
      });
     }
    }
   }
  });

  try { 
   await setDoc(docRef, validatedPicks); 
   
   //  CRITICAL: Invalidate all cache affected by picks changes
   window.gameStateCache.invalidateAfterDataUpdate('user_picks_saved', weekNum, currentUser.uid);
   
   let statusMessage = 'Picks Saved!';
   if (lockedGames.length > 0) {
    statusMessage = `Saved! ${lockedGames.length} locked games skipped`;
    console.warn('Locked games skipped:', lockedGames);
   }
   
   updateSaveStatus('saved', statusMessage);
   
   // Send email confirmation if there were valid changes
   if (validChanges.length > 0) {
    await sendPickConfirmationEmail(currentUser.email, validChanges, submissionTime, weekNum);
   }
   
   // Invalidate leaderboard cache since picks changed
   invalidateCache('leaderboard');
   
   // Update picks summary if picks view is active
   if (!allUI.picksSummaryContainer.classList.contains('hidden')) {
    await renderActivePicksSummary();
   }
  } catch (error) { 
   console.error("Error saving picks:", error); 
   updateSaveStatus('error', 'Save Failed');
  } 
 }

 // Email confirmation function
 async function sendPickConfirmationEmail(userEmail, validChanges, submissionTime, weekNumber) {
  try {
   // Call Cloud Function to send pick confirmation email
   const sendPickConfirmationFn = httpsCallable(functions, 'sendPickConfirmation');
   
   // Ensure user token is fresh before calling Cloud Function
   if (auth.currentUser) {
    try {
     await auth.currentUser.getIdToken(true); // Force token refresh
    } catch (tokenError) {
     console.error('Failed to refresh auth token for pick confirmation:', tokenError);
     // Continue anyway for pick confirmation as it's less critical
    }
   }
   
   const userName = currentUser?.displayName || currentUser?.email || 'Nerd';
   
   const result = await sendPickConfirmationFn({
    userEmail: userEmail,
    userName: userName,
    picks: validChanges,
    weekNumber: weekNumber
   });
   
   if (result.data.success) {
    console.log('Pick confirmation email sent successfully');
   } else {
    console.error('Failed to send pick confirmation email:', result.data.error);
   }
   
  } catch (error) {
   console.error('Error sending confirmation email:', error);
  }
 }

 function generatePickConfirmationEmail(validChanges, submissionTime, weekNumber) {
  const formattedTime = new Date(submissionTime).toLocaleString();
  
  let emailContent = `NerdFootball Pick Confirmation - Week ${weekNumber}\n`;
  emailContent += `Submission Time: ${formattedTime}\n\n`;
  emailContent += `Your Picks:\n`;
  emailContent += `============\n`;
  
  validChanges
   .sort((a, b) => b.confidence - a.confidence) // Sort by confidence descending
   .forEach(change => {
    const gameTime = new Date(change.gameTime).toLocaleString();
    emailContent += `${change.game}\n`;
    emailContent += `Pick: ${change.pick}\n`;
    emailContent += `Confidence: ${change.confidence}\n`;
    emailContent += `Game Time: ${gameTime}\n\n`;
   });
  
  emailContent += `Total Picks: ${validChanges.length}\n`;
  emailContent += `\nGood luck!\n`;
  emailContent += `- NerdFootball AI`;
  
  return emailContent;
 }

 async function calculateAndDisplayLeaderboard(weekNumber, targetBody = allUI.leaderboardBody, loader = allUI.leaderboardLoader) {
    if (!targetBody || !loader) {
        console.warn('calculateAndDisplayLeaderboard: target elements not found, skipping');
        return;
    }
    loader.classList.remove('hidden');
    targetBody.innerHTML = '';
    
    try {
        console.log(` Loading leaderboard for ${weekNumber ? `week ${weekNumber}` : 'season'}...`);
        const startTime = performance.now();
        
        //  CONFIDENCE-ON-CRACK: Use optimized system when activated
        if (window.confidenceOnCrack && window.unifiedConfidenceManager) {
            console.log(' Using CONFIDENCE-ON-CRACK optimized leaderboard system');
            const optimizedData = await window.unifiedConfidenceManager.getDisplayLeaderboard(weekNumber);
            
            if (optimizedData && optimizedData.success) {
                const loadTime = performance.now() - startTime;
                console.log(` CONFIDENCE-ON-CRACK: Leaderboard loaded in ${loadTime.toFixed(0)}ms with ${optimizedData.readCount} reads`);
                
                targetBody.innerHTML = optimizedData.html;
                loader.classList.add('hidden');
                return;
            } else {
                console.warn(' CONFIDENCE-ON-CRACK failed, falling back to legacy system');
            }
        }
        
        // Use the optimized function that checks for summary first
        const standings = await calculateLeaderboardOptimized(weekNumber);
        
        const timeTaken = (performance.now() - startTime).toFixed(0);
        console.log(` Leaderboard loaded in ${timeTaken}ms`);
        
        if (!standings || standings.length === 0) {
            targetBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500">No leaderboard data available</td></tr>';
            loader.classList.add('hidden');
            return;
        }
        
        // Display the standings
        standings.forEach((user, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-50';
            
            // Determine rank display with ties
            let rankDisplay = `${index + 1}`;
            if (index > 0 && user.totalScore === standings[index - 1].totalScore) {
                // Same score as previous user - it's a tie
                const prevRow = targetBody.lastElementChild;
                const prevRankText = prevRow.querySelector('td').textContent;
                rankDisplay = prevRankText.includes('T') ? prevRankText : `T${prevRankText}`;
                prevRow.querySelector('td').textContent = rankDisplay;
            }
            
            // Get MNF points for this user (will be populated in weekly view)
            const mnfPoints = user.mnfTotalPoints || '-';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${rankDisplay}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${user.displayName || 'Unknown'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-semibold">${user.totalScore || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${mnfPoints}</td>
            `;
            targetBody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        targetBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-500">Error loading leaderboard. Please try again.</td></tr>';
    } finally {
        loader.classList.add('hidden');
    }
}

// Function to calculate leaderboard data without displaying it
async function calculateLeaderboard(weekNumber = null) {
    const users = await getCleanUsers();
    
    let scores = {};
    for (const id in users) {
        scores[id] = { uid: id, displayName: users[id].displayName, totalScore: 0 };
    }

    if (weekNumber) { // Weekly calculation
        const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
        const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
        const picksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
        
        picksSnap.forEach(pickDoc => {
            const userId = pickDoc.id;
            // CRITICAL: Only process picks for users who are in the confidence pool
            if (scores[userId]) {
                const userPicks = pickDoc.data();
                let userScore = 0;
                Object.keys(userPicks).forEach(gameId => {
                    if (gameId === 'mnfTotalPoints') {
                        // Store MNF points separately
                        scores[userId].mnfTotalPoints = userPicks.mnfTotalPoints;
                    } else {
                        const pick = userPicks[gameId];
                        if (pick && pick.winner) {
                            const gameWinner = getGameWinner(gameResults[gameId]);
                            if (gameWinner && pick.winner === gameWinner) {
                                userScore += pick.confidence;
                            }
                        }
                    }
                });
                scores[userId].totalScore = userScore;
            }
        });
    } else { // Season calculation -  DIAMOND LEVEL OPTIMIZED
        console.log(` Season calculation optimization - batching ${currentWeek * 2} queries in parallel`);
        const batchQueries = [];
        for (let i = 1; i <= currentWeek; i++) {
            batchQueries.push(getDoc(doc(db, resultsPath(i))));
            batchQueries.push(getDocs(collection(db, picksCollectionPath(i))));
        }
        
        const allSnapshots = await Promise.all(batchQueries);
        
        for (let i = 1; i <= currentWeek; i++) {
            const resultsIndex = (i - 1) * 2;
            const picksIndex = resultsIndex + 1;
            
            const resultsSnap = allSnapshots[resultsIndex];
            const picksSnap = allSnapshots[picksIndex];
            const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};

            picksSnap.forEach(pickDoc => {
                const userId = pickDoc.id;
                if (scores[userId]) {
                    const userPicks = pickDoc.data();
                    let userScore = 0;
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        const gameWinner = getGameWinner(gameResults[gameId]);
                        if (gameWinner && pick.winner === gameWinner) {
                            userScore += pick.confidence;
                        }
                    });
                    scores[userId].totalScore += userScore;
                }
            });
        }
    }
    
    return await sortLeaderboardWithTiebreaker(Object.values(scores), weekNumber, 'totalScore');
}

// --- LEADERBOARD OPTIMIZATION: Summary Document Functions ---
// Path for leaderboard summary document (must have even number of segments)
const leaderboardSummaryPath = () => `artifacts/${appId()}/leaderboard_summaries/season_2025`;

// Update the leaderboard summary document (called after results are saved)
async function updateLeaderboardSummary(weekNumber = null) {
    console.log(' Updating leaderboard summary document...');
    const startTime = performance.now();
    
    try {
        const users = await getCleanUsers();
        const summaryData = {
            lastUpdated: new Date().toISOString(),
            currentWeek: currentWeek,
            seasonStandings: {},
            weeklyLeaderboards: {}
        };

        // Calculate season totals
        let seasonScores = {};
        for (const id in users) {
            seasonScores[id] = {
                uid: id,
                displayName: users[id].displayName,
                totalScore: 0,
                weeklyScores: {},
                mnfGuesses: {} // For tiebreakers
            };
        }

        //  DIAMOND LEVEL: Batch all database queries in parallel instead of sequential
        console.log(` Season leaderboard optimization - batching ${currentWeek * 2} queries in parallel`);
        const batchQueries = [];
        for (let week = 1; week <= currentWeek; week++) {
            batchQueries.push(getDoc(doc(db, resultsPath(week))));
            batchQueries.push(getDocs(collection(db, picksCollectionPath(week))));
        }
        
        const allSnapshots = await Promise.all(batchQueries);
        
        // Process all weeks with batched data
        for (let week = 1; week <= currentWeek; week++) {
            const resultsIndex = (week - 1) * 2;
            const picksIndex = resultsIndex + 1;
            
            const resultsSnap = allSnapshots[resultsIndex];
            const picksSnap = allSnapshots[picksIndex];
            const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
            
            let weeklyScores = [];
            
            picksSnap.forEach(pickDoc => {
                const userId = pickDoc.id;
                if (seasonScores[userId]) {
                    const userPicks = pickDoc.data();
                    let userWeekScore = 0;
                    
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        const gameWinner = getGameWinner(gameResults[gameId]);
                        if (gameWinner && pick.winner === gameWinner) {
                            userWeekScore += pick.confidence;
                        }
                        // Store MNF guess for tiebreaker
                        if (pick.mnfTotal !== undefined) {
                            seasonScores[userId].mnfGuesses[week] = pick.mnfTotal;
                        }
                    });
                    
                    seasonScores[userId].weeklyScores[week] = userWeekScore;
                    seasonScores[userId].totalScore += userWeekScore;
                    
                    weeklyScores.push({
                        uid: userId,
                        displayName: seasonScores[userId].displayName,
                        totalScore: userWeekScore
                    });
                }
            });
            
            // Sort and store weekly leaderboard
            summaryData.weeklyLeaderboards[week] = await sortLeaderboardWithTiebreaker(weeklyScores, week, 'totalScore');
        }
        
        // Store season standings
        summaryData.seasonStandings = seasonScores;
        
        // Save to Firestore
        await setDoc(doc(db, leaderboardSummaryPath()), summaryData);
        
        const timeTaken = (performance.now() - startTime).toFixed(0);
        console.log(` Leaderboard summary updated in ${timeTaken}ms`);
        console.log(` Processed ${currentWeek} weeks of data for ${Object.keys(users).length} users`);
        
        return summaryData;
    } catch (error) {
        console.error('Error updating leaderboard summary:', error);
        throw error;
    }
}

// Modified calculateLeaderboard to use summary when available
async function calculateLeaderboardOptimized(weekNumber = null) {
    console.log(` Calculating leaderboard for ${weekNumber ? `week ${weekNumber}` : 'season'}`);
    
    try {
        // Try to get summary document first
        const summaryDoc = await getDoc(doc(db, leaderboardSummaryPath()));
        
        if (summaryDoc.exists()) {
            const summary = summaryDoc.data();
            console.log(' Using cached leaderboard summary (1 read instead of 36+)');
            
            if (weekNumber && summary.weeklyLeaderboards[weekNumber]) {
                // Get cached leaderboard but need to add MNF points
                const cachedLeaderboard = summary.weeklyLeaderboards[weekNumber];
                
                // Filter out users not in confidence pool
                const activeUsers = await getCleanUsers();
                const filteredLeaderboard = cachedLeaderboard.filter(user => {
                    const userId = user.uid || user.userId;
                    return activeUsers[userId] !== undefined;
                });
                
                // Fetch MNF points for this week
                const picksSnap = await getDocs(collection(db, picksCollectionPath(weekNumber)));
                const userMnfPoints = {};
                picksSnap.forEach(pickDoc => {
                    const userPicks = pickDoc.data();
                    if (userPicks.mnfTotalPoints !== undefined) {
                        userMnfPoints[pickDoc.id] = parseInt(userPicks.mnfTotalPoints, 10) || 0;
                    }
                });
                
                // Add MNF points to filtered leaderboard
                filteredLeaderboard.forEach(user => {
                    const userId = user.uid || user.userId;
                    if (userMnfPoints[userId] !== undefined) {
                        user.mnfTotalPoints = userMnfPoints[userId];
                    }
                });
                
                return filteredLeaderboard;
            } else if (!weekNumber) {
                // Convert season standings to array format and filter
                const standings = Object.values(summary.seasonStandings);
                const activeUsers = await getCleanUsers();
                const filteredStandings = standings.filter(user => {
                    const userId = user.uid || user.userId;
                    return activeUsers[userId] !== undefined;
                });
                return await sortLeaderboardWithTiebreaker(filteredStandings, null, 'totalScore');
            }
        }
        
        console.log(' Summary not found, falling back to original calculation method');
    } catch (error) {
        console.error('Error reading summary, falling back:', error);
    }
    
    // Fall back to original method if summary not available
    return calculateLeaderboard(weekNumber);
}

 function populateWeekSelectors() {
 const options = Array.from({ length: 18 }, (_, i) => `<option value="${i + 1}">Week ${i + 1}</option>`).join('');
 allUI.adminWeekSelector.innerHTML = options;
 allUI.lbWeekSelector.innerHTML = options;
 }

 // --- PICKS SUMMARY FUNCTIONS ---
 async function renderActivePicksSummary() {
  if (!currentUser || !currentWeek) return;
  
  try {
   // Get current week games and user picks
   const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
   if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
    allUI.activePicksList.innerHTML = '<p class="text-center text-slate-500 text-sm">No games available for this week</p>';
    return;
   }

   // Helper function to check if data is valid for display
   const isValidData = (value) => {
     return value && 
            value !== 'undefined' && 
            value !== 'null' && 
            value !== 'Invalid Date' && 
            String(value).trim() !== '' &&
            !String(value).includes('undefined') &&
            !String(value).includes('null');
   };

   const docRef = doc(db, picksPath(currentWeek, currentUser.uid));
   const docSnap = await getDoc(docRef);
   const userPicks = docSnap.exists() ? docSnap.data() : {};

   // Get game results for this week
   const resultsDocRef = doc(db, resultsPath(currentWeek));
   const resultsSnap = await getDoc(resultsDocRef);
   const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};

   // Get live scores from ESPN API if available
   let liveScores = {};
   try {
    if (window.espnApi) {
     const espnGames = await window.espnApi.getWeekGames(currentWeek);
     espnGames.forEach(espnGame => {
      // Map ESPN game to our game ID (simple mapping for now)
      const matchedGame = weekData.games.find(game => {
       return (game.away === espnGame.a || game.away === espnGame.awayTeam) && 
              (game.home === espnGame.h || game.home === espnGame.homeTeam);
      });
      if (matchedGame) {
       liveScores[matchedGame.id] = {
        awayTeam: espnGame.a || espnGame.awayTeam || matchedGame.away,
        homeTeam: espnGame.h || espnGame.homeTeam || matchedGame.home,
        awayScore: espnGame.awayScore || 0,
        homeScore: espnGame.homeScore || 0,
        winner: espnGame.winner,
        status: espnGame.status || (espnGame.winner && espnGame.winner !== 'TBD' ? 'FINAL' : 'LIVE'),
        clock: espnGame.clock || espnGame.timeRemaining,
        quarter: espnGame.quarter || espnGame.period,
        hasScores: (espnGame.awayScore !== undefined && espnGame.homeScore !== undefined),
        weather: espnGame.weather || null,
        venue: espnGame.venue || null,
        probability: espnGame.probability || null,
        broadcasts: espnGame.broadcasts || null,
        quarterScores: espnGame.quarterScores || null,
        teamRecords: espnGame.teamRecords || null
       };
      }
     });
    }
   } catch (error) {
    console.warn('Could not fetch live scores from ESPN:', error);
   }

   // Filter picks that have winners selected
   const activePicks = [];
   weekData.games.forEach(game => {
    const pick = userPicks[game.id];
    if (pick && pick.winner) {
     // Check if game has started
     const gameTime = new Date(game.kickoff);
     const now = new Date();
     const gameHasStarted = now > gameTime;
     
     // Check if user won this pick
     const gameResult = gameResults[game.id];
     const gameWinner = getGameWinner(gameResult);
     const userWon = gameHasStarted && gameWinner && pick.winner === gameWinner;
     const userLost = gameHasStarted && gameWinner && pick.winner !== gameWinner;
     
     // ALWAYS show user their own picks - this is "Your Active Picks" section
     activePicks.push({
      gameId: game.id,
      team: pick.winner,
      confidence: pick.confidence,
      game: game,
      gameHasStarted: gameHasStarted,
      userWon: userWon,
      userLost: userLost,
      gameResult: gameResult,
      liveScore: liveScores[game.id] || null
     });
    }
   });

   // Sort by confidence (highest first)
   activePicks.sort((a, b) => b.confidence - a.confidence);

   // Render active picks
   if (activePicks.length === 0) {
    allUI.activePicksList.innerHTML = '<p class="text-center text-slate-500 text-sm">No picks made yet</p>';
   } else {
    // Find any in-progress games or the highest confidence pick for auto-expansion
    let autoExpandGameId = null;
    
    // First check for in-progress games
    const inProgressGames = activePicks.filter(pick => {
     const currentTime = new Date();
     const gameKickoff = new Date(pick.game.kickoff);
     const gameWinner = getGameWinner(pick.gameResult);
     const hasActuallyStarted = currentTime > gameKickoff;
     return hasActuallyStarted && !gameWinner;
    });
    
    if (inProgressGames.length === 1) {
     // Only one in-progress game, auto-expand it
     autoExpandGameId = inProgressGames[0].gameId;
    } else if (inProgressGames.length === 0 && activePicks.length > 0) {
     // No in-progress games, expand the highest confidence pick
     autoExpandGameId = activePicks[0].gameId; // Already sorted by confidence
    }
    
    allUI.activePicksList.innerHTML = activePicks.map(pick => {
     const teamAbbr = teamNameToAbbr[pick.team] || pick.team;
     const logoUrl = nflTeamLogos[teamAbbr] || '';
     
     // Determine opponent and home/away status
     const isHome = pick.team === pick.game.home;
     const opponent = isHome ? pick.game.away : pick.game.home;
     const opponentAbbr = teamNameToAbbr[opponent] || opponent;
     const opponentLogoUrl = nflTeamLogos[opponentAbbr] || '';
     const homeAwayIndicator = isHome ? 'vs' : '@';
     
     
     // Format game time
     const gameTime = new Date(pick.game.kickoff);
     const now = new Date();
     const isToday = gameTime.toDateString() === now.toDateString();
     const isTomorrow = gameTime.toDateString() === new Date(now.getTime() + 24*60*60*1000).toDateString();
     
     // CRITICAL DEBUG: Let's see exactly what's happening
     const currentTime = new Date();
     const gameKickoff = new Date(pick.game.kickoff);
     const gameWinner = getGameWinner(pick.gameResult);
     const hasActuallyStarted = currentTime > gameKickoff;
     
     
     // FIXED: Use actual time check, not the potentially incorrect pick.gameHasStarted
     const isInProgress = hasActuallyStarted && !gameWinner;
     
     
     let timeDisplay = '';
     if (gameWinner && hasActuallyStarted) {
      // Game is completed (has a winner and has started)
      timeDisplay = 'Final';
     } else if (isInProgress) {
      timeDisplay = 'In Progress';
     } else if (isToday) {
      timeDisplay = gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     } else if (isTomorrow) {
      timeDisplay = 'Tom ' + gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     } else {
      timeDisplay = gameTime.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                   gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     }
     
     // Team color mapping for gradients
     const teamColors = {
       'ARI': '#97233F', 'ATL': '#A71930', 'BAL': '#241773', 'BUF': '#00338D',
       'CAR': '#0085CA', 'CHI': '#0B162A', 'CIN': '#FB4F14', 'CLE': '#311D00',
       'DAL': '#041E42', 'DEN': '#FB4F14', 'DET': '#0076B6', 'GB': '#203731',
       'HOU': '#03202F', 'IND': '#002C5F', 'JAX': '#101820', 'KC': '#E31837',
       'LV': '#000000', 'LAC': '#0080C6', 'LAR': '#003594', 'MIA': '#008E97',
       'MIN': '#4F2683', 'NE': '#002244', 'NO': '#101820', 'NYG': '#0B2265',
       'NYJ': '#125740', 'PHI': '#004C54', 'PIT': '#101820', 'SF': '#AA0000',
       'SEA': '#002244', 'TB': '#D50A0A', 'TEN': '#0C2340', 'WAS': '#5A1414'
     };
     
     // Determine background color and text style based on game status
     let bgClass = 'bg-gradient-to-r from-[var(--theme-gradient-start)] to-[var(--theme-gradient-end)] hover:from-[var(--theme-gradient-hover-start)] hover:to-[var(--theme-gradient-hover-end)]'; // Theme-responsive gradient
     let textClass = '';
     let glowClass = '';
     let gradientOverlay = ''; // Only show for truly in-progress games
     
     if (pick.userWon) {
      bgClass = 'bg-green-100 hover:bg-green-200'; // Light pale green for wins
      textClass = 'font-bold';
     } else if (pick.userLost) {
      bgClass = 'bg-rose-100 hover:bg-rose-200'; // Light pale rose for losses
      textClass = '';
     } else if (isInProgress) {
      // GRADIENT COMPLETELY DISABLED FOR SECURITY
      bgClass = 'bg-blue-50 hover:bg-blue-100';
      glowClass = 'shadow-lg shadow-emerald-200 ring-2 ring-emerald-400 ring-opacity-50';
      
      // NO GRADIENT - SECURITY LEAK PREVENTION
      gradientOverlay = '';
     }
     // All other games (not started, or started but finished) get ocean breeze theme
     
     return `
      <div class="game-pick-card relative flex items-center ${bgClass} rounded-lg p-2 shadow-sm border cursor-pointer transition-all duration-200 ${glowClass}" 
           data-game-id="${pick.gameId}"
           data-team="${pick.team}"
           data-confidence="${pick.confidence}"
           onclick="expandGameView('${pick.gameId}', this)">
       ${gradientOverlay}
       <!-- Content layer -->
       <div class="relative z-10 flex items-center w-full">
        <img src="${logoUrl}" alt="${pick.team}" class="w-8 h-8 rounded-sm mr-3 flex-shrink-0" onerror="this.style.visibility='hidden'; this.style.width='8px';">
        <div class="flex-1 min-w-0">
         <div class="text-sm text-slate-800 ${textClass} truncate">${pick.team} (${pick.confidence})</div>
         <div class="text-xs text-slate-600 mt-1">
          ${isValidData(opponent) ? `${homeAwayIndicator} ${opponent}` : '<span class="text-slate-400 italic">loading...</span>'}
         </div>
         ${pick.liveScore && pick.liveScore.hasScores && isValidData(pick.liveScore.awayScore) && isValidData(pick.liveScore.homeScore) ? `<div class="text-xs font-medium mt-1 ${pick.liveScore.status === 'FINAL' ? 'text-slate-700' : 'text-emerald-600'}">
          ${pick.liveScore.awayScore} - ${pick.liveScore.homeScore}${pick.liveScore.status === 'FINAL' ? ' (F)' : (pick.liveScore.clock && pick.liveScore.quarter ? ` (${pick.liveScore.clock} Q${pick.liveScore.quarter})` : '')}
         </div>` : ''}
         ${pick.liveScore && pick.liveScore.weather && isValidData(pick.liveScore.weather.temperature) ? `<div class="text-xs text-slate-500 mt-0.5 flex items-center">
          <span class="mr-1"></span>
          ${pick.liveScore.weather.temperature}F ${pick.liveScore.weather.condition || pick.liveScore.weather.description || ''}
         </div>` : ''}
         ${pick.liveScore && pick.liveScore.venue && isValidData(pick.liveScore.venue.name) ? `<div class="text-xs text-slate-500 mt-0.5 flex items-center">
          <span class="mr-1">${pick.liveScore.venue.indoor ? '' : ''}</span>
          ${pick.liveScore.venue.name}
         </div>` : ''}
         ${pick.liveScore && pick.liveScore.probability && isValidData(isHome ? pick.liveScore.probability.homeWinPercentage : pick.liveScore.probability.awayWinPercentage) ? `<div class="text-xs text-emerald-600 font-medium mt-0.5">
          Win Prob: ${isHome ? pick.liveScore.probability.homeWinPercentage : pick.liveScore.probability.awayWinPercentage}%
         </div>` : ''}
         <div class="text-xs text-slate-500 mt-0.5 ${isInProgress ? 'text-emerald-600 font-medium' : ''}">
          ${isValidData(timeDisplay) ? timeDisplay : '<span class="text-slate-400 italic">loading...</span>'}
         </div>
        </div>
       </div>
      </div>
     `;
    }).join('');
    
    // Auto-expand the selected game after a short delay to ensure DOM is ready
    if (autoExpandGameId) {
     setTimeout(() => {
      const gameCard = document.querySelector(`[data-game-id="${autoExpandGameId}"]`);
      if (gameCard) {
       console.log(` Auto-expanding game ${autoExpandGameId}`);
       window.expandGameView(autoExpandGameId, gameCard);
      }
     }, 100);
    }
   }
  } catch (error) {
   console.error('Error loading active picks:', error);
   allUI.activePicksList.innerHTML = '<p class="text-center text-red-500 text-sm">Error loading picks</p>';
  }
 }

 async function renderYearlyLeaderboard() {
  if (!currentUser) return;
  
  try {
   allUI.yearlyLeaderboardLoader.classList.remove('hidden');
   allUI.yearlyLeaderboardContent.innerHTML = '';

   // Calculate season standings using optimized function
   const standings = await calculateLeaderboardOptimized();
   
   if (!standings || standings.length === 0) {
    allUI.yearlyLeaderboardContent.innerHTML = '<p class="text-center text-slate-500 text-sm">No leaderboard data available</p>';
    return;
   }

   // Find user's position
   const userPosition = standings.findIndex(entry => entry.uid === currentUser.uid) + 1;
   
   // Get top 10
   const topTen = standings.slice(0, 10);
   let leaderboardEntries = [...topTen];
   
   // Add current user if not in top 10
   if (userPosition > 10) {
    const userEntry = standings[userPosition - 1];
    leaderboardEntries.push({ ...userEntry, isCurrentUser: true });
   }

   // Calculate real positions accounting for ties
   let currentRank = 1;
   let previousScore = null;
   const realPositions = [];
   
   standings.slice(0, 10).forEach((entry, index) => {
     if (previousScore !== null && entry.totalScore < previousScore) {
       currentRank = index + 1;
     }
     realPositions[index] = currentRank;
     previousScore = entry.totalScore;
   });

   // Render leaderboard
   allUI.yearlyLeaderboardContent.innerHTML = leaderboardEntries.map((entry, index) => {
    let position;
    let isCurrentUser = entry.isCurrentUser || entry.uid === currentUser.uid;
    
    if (entry.isCurrentUser) {
     position = userPosition;
    } else {
     position = realPositions[index] || (index + 1);
    }
    
    // Add medal glyphs for top 3
    let medalGlyph = '';
    if (position === 1) {
      medalGlyph = ' ';
    } else if (position === 2) {
      medalGlyph = ' ';
    } else if (position === 3) {
      medalGlyph = ' ';
    }
    
    const positionDisplay = position <= 10 ? position : `${position}`;
    let bgClass = '';
    if (position === 1) {
      bgClass = 'bg-gradient-to-r from-yellow-100 to-yellow-200';
    } else if (position === 2) {
      bgClass = 'bg-gradient-to-r from-gray-100 to-gray-200';
    } else if (position === 3) {
      bgClass = 'bg-gradient-to-r from-orange-100 to-orange-200';
    }
    
    // Highlight current user with blue background and bold text
    if (isCurrentUser) {
      bgClass += ' ring-2 ring-blue-400 bg-blue-50';
    }
    
    const textClass = isCurrentUser ? 'font-bold text-blue-900' : '';
    
    return `
     <div class="flex items-center justify-between py-1 px-2 rounded text-sm ${bgClass} ${textClass}">
      <div class="flex items-center space-x-2">
       <span class="text-slate-600 font-mono text-xs w-6">${positionDisplay}.</span>
       <span class="text-slate-800">${medalGlyph}${entry.displayName || 'Unknown'}</span>
       ${isCurrentUser ? '<span class="text-blue-600 text-xs">(You)</span>' : ''}
      </div>
      <span class="text-slate-600 font-mono text-xs">${entry.totalScore}</span>
     </div>
    `;
   }).join('');
   
  } catch (error) {
   console.error('Error loading yearly leaderboard:', error);
   allUI.yearlyLeaderboardContent.innerHTML = '<p class="text-center text-red-500 text-sm">Error loading leaderboard</p>';
  } finally {
   allUI.yearlyLeaderboardLoader.classList.add('hidden');
  }
 }

 async function updatePicksSummary() {
  await renderActivePicksSummary();
  await renderYearlyLeaderboard();
 }

 function formatTimestamp(isoString) {
  if (!isoString) return '';
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  
  // Less than 24 hours - show relative time
  if (diffHours < 24) {
    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
  }
  
  // More than 24 hours - show formatted date
  const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                  'July', 'August', 'September', 'October', 'November', 'December'];
  
  const weekday = weekdays[date.getDay()];
  const month = months[date.getMonth()];
  const day = date.getDate();
  const year = date.getFullYear();
  
  return `${weekday}, ${month} ${day}, ${year}`;
}

function updateTimestamps() {
  const lastAccessEl = document.getElementById('last-access-time');
  const lastUpdateEl = document.getElementById('last-update-time');
  
  if (lastAccessEl && lastUpdateEl) {
    // Show previous access, not current
    const previousAccess = localStorage.getItem('previousAccess');
    const lastUpdate = localStorage.getItem('lastPicksUpdate');
    
    if (previousAccess) {
      lastAccessEl.textContent = `Last visit: ${formatTimestamp(previousAccess)}`;
    }
    
    if (lastUpdate) {
      lastUpdateEl.textContent = `Last picks update: ${formatTimestamp(lastUpdate)}`;
    }
  }
}

function updatePicksButtonStates(weekData) {
  if (!weekData || !Array.isArray(weekData.games)) return;
  
  // Count unlocked games
  let unlockedGameCount = 0;
  let anyGameStarted = false;
  
  weekData.games.forEach(game => {
    if (isGameLocked(game)) {
      anyGameStarted = true;
    } else {
      unlockedGameCount++;
    }
  });
  
  // Disable Reset Picks button if ANY game has started
  if (allUI.resetPicksBtn) {
    allUI.resetPicksBtn.disabled = anyGameStarted;
    if (anyGameStarted) {
      allUI.resetPicksBtn.classList.add('opacity-50', 'cursor-not-allowed');
      allUI.resetPicksBtn.classList.remove('hover:bg-emerald-800');
    } else {
      allUI.resetPicksBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      allUI.resetPicksBtn.classList.add('hover:bg-emerald-800');
    }
  }
  
  // Disable Save Picks button if less than 2 games are unlocked
  if (allUI.topSavePicksBtn) {
    allUI.topSavePicksBtn.disabled = unlockedGameCount < 2;
    if (unlockedGameCount < 2) {
      allUI.topSavePicksBtn.classList.add('opacity-50', 'cursor-not-allowed');
      allUI.topSavePicksBtn.classList.remove('hover:bg-blue-700');
    } else {
      allUI.topSavePicksBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      allUI.topSavePicksBtn.classList.add('hover:bg-blue-700');
    }
  }
  
  // Also disable MNF save button if less than 2 games are unlocked
  const mnfSaveBtn = document.getElementById('mnf-save-btn');
  if (mnfSaveBtn) {
    mnfSaveBtn.disabled = unlockedGameCount < 2;
    if (unlockedGameCount < 2) {
      mnfSaveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      mnfSaveBtn.classList.remove('hover:bg-blue-700');
    } else {
      mnfSaveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      mnfSaveBtn.classList.add('hover:bg-blue-700');
    }
  }
}

 function renderWeekUI(weekData, userPicks, weekIsLocked, targetContainer = allUI.gameList) {
 targetContainer.innerHTML = '';
 if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) {
 targetContainer.innerHTML = '<p class="text-center text-gray-500">No games are scheduled for this week.</p>';
 return;
 }
 const totalGames = weekData.games.length;
 
 // CRITICAL BUG FIX: Only allow confidence values from unlocked games to be selected
 const lockedConfidenceValues = new Set();
 const availableConfidenceValues = new Set();
 
 // Collect confidence values from locked games (these cannot be used)
 weekData.games.forEach(game => {
   if (isGameLocked(game) && userPicks[game.id] && userPicks[game.id].confidence > 0) {
     lockedConfidenceValues.add(userPicks[game.id].confidence);
   }
 });
 
 // Build available confidence values (excluding locked ones)
 for (let i = 1; i <= totalGames; i++) {
   if (!lockedConfidenceValues.has(i)) {
     availableConfidenceValues.add(i);
   }
 }
 
 const confidenceOptions = Array.from(availableConfidenceValues).sort((a, b) => a - b);
 
 weekData.games.forEach(game => {
 const pick = userPicks[game.id] || { winner: null, confidence: 0 };
 const gameState = getGameState(game);
 const isLocked = isGameLocked(game);
 const gameRow = document.createElement('div');
 
 
 // Determine background colors based on game state
 let gameRowBg = 'bg-white border-slate-200';
 
 const userWonGame = gameState === 'COMPLETED' && game.winner && pick.winner === game.winner;
 const userLostGame = gameState === 'COMPLETED' && game.winner && pick.winner && pick.winner !== game.winner;
 const gameInProgress = gameState === 'IN_PROGRESS';
 
 if (userWonGame) {
     // User picked the winning team - GREEN row
     gameRowBg = 'bg-green-50 border-green-200';
 } else if (userLostGame) {
     // User picked the losing team - ROSE row
     gameRowBg = 'bg-rose-50 border-rose-200';
 } else if (gameInProgress) {
     // Game in progress - OCEAN BREEZE row
     gameRowBg = 'bg-gradient-to-r from-[var(--theme-gradient-start)] to-[var(--theme-gradient-end)] border-[var(--theme-border)]';
 } else if (gameState === 'COMPLETED') {
     // Completed game - DARKER background with lighter text
     gameRowBg = 'bg-slate-700 border-slate-600';
 } else if (isLocked) {
     // Default locked styling
     gameRowBg = 'bg-slate-50 border-slate-300';
 }
 
 gameRow.className = `p-3 border rounded-lg shadow-sm ${gameRowBg} mb-3`;
 const gameTime = new Date(game.kickoff);
 const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });

 // Get helmet classes
 const awayHelmetClass = getTeamHelmetClass(game.away);
 const homeHelmetClass = getTeamHelmetClass(game.home);

 // Determine button styles based on state
 function getTeamButtonClasses(team, isHome = false) {
     const isSelected = pick.winner === team;
     const isWinner = gameState === 'COMPLETED' && game.winner === team;
     const baseClasses = 'winner-btn flex items-center justify-center gap-2 px-4 py-3 rounded-lg border-2 font-semibold transition-all duration-200 text-sm';
     
     if (isLocked) {
         if (gameState === 'IN_PROGRESS') {
             // Special styling for in-progress games
             if (isSelected) {
                 return `${baseClasses} bg-blue-800 border-emerald-400 text-slate-900 border-2`;
             } else {
                 return `${baseClasses} bg-blue-700 border-emerald-400 text-slate-900 opacity-75`;
             }
         } else if (isWinner) {
             return `${baseClasses} bg-emerald-100 border-emerald-400 text-emerald-800 opacity-90`;
         } else if (isSelected) {
             // Outline selected locked games with dark pale ocean blue
             return `${baseClasses} bg-slate-50 border-slate-600 text-slate-800 border-4 shadow-md opacity-95`;
         } else {
             return `${baseClasses} bg-slate-100 border-slate-300 text-slate-600 opacity-60`;
         }
     } else {
         if (isSelected) {
             return `${baseClasses} bg-sky-50 border-slate-600 text-slate-800 border-4 shadow-md hover:bg-sky-100`;
         } else {
             return `${baseClasses} bg-sky-100 border-sky-200 text-slate-800 hover:bg-sky-200 hover:border-sky-300 hover:shadow-md`;
         }
     }
 }

 gameRow.innerHTML = `
 <div class="flex items-center justify-between gap-3">
     <div class="flex-1 flex items-center justify-between gap-2 min-w-0">
         <button data-game-id="${game.id}" data-team="${game.away}" ${isLocked ? 'disabled' : ''} 
                 class="${getTeamButtonClasses(game.away)} flex-1 min-w-0">
             <div class="helmet-mini ${awayHelmetClass} w-6 h-6 bg-contain bg-center bg-no-repeat flex-shrink-0"></div>
             <span class="truncate">${game.away}</span>
         </button>
         
         <div class="flex items-center gap-1 text-slate-400 font-bold text-lg flex-shrink-0">
             <span class="text-xs text-slate-500">${formattedTime.split(',')[0]}</span>
             <span>@</span>
         </div>
         
         <button data-game-id="${game.id}" data-team="${game.home}" ${isLocked ? 'disabled' : ''} 
                 class="${getTeamButtonClasses(game.home, true)} flex-1 min-w-0">
             <div class="helmet-mini ${homeHelmetClass} w-6 h-6 bg-contain bg-center bg-no-repeat flex-shrink-0"></div>
             <span class="truncate">${game.home}</span>
         </button>
     </div>
     
     <div class="w-20 flex-shrink-0">
         <select id="confidence-${game.id}" name="confidence-${game.id}" data-game-id="${game.id}" 
                 ${isLocked ? 'disabled' : ''} 
                 class="confidence-select w-full py-2 px-2 text-center rounded-md border-2 ${
                     isLocked 
                         ? 'border-slate-300 bg-slate-100 text-slate-600' 
                         : pick.confidence > 0
                             ? 'border-teal-400 bg-teal-50 text-teal-800 font-bold'
                             : 'border-sky-300 bg-sky-50 text-slate-700'
                 } text-sm">
             ${isLocked ? 
                 `<option value="${pick.confidence}" selected>${pick.confidence}</option>` : 
                 [...confidenceOptions, pick.confidence]
                     .filter((v, i, a) => a.indexOf(v) === i)
                     .sort((a, b) => a - b)
                     .map(opt => `<option value="${opt}" ${pick.confidence === opt ? 'selected' : ''}>${opt}</option>`)
                     .join('')
             }
         </select>
     </div>
 </div>
 
 <!-- Enhanced ESPN Data Section for Picks -->
 <div id="picks-espn-data-${game.id}" class="mt-2 pt-2 border-t border-slate-200">
     <!-- ESPN data will be populated here -->
 </div>
 
 ${gameState === 'IN_PROGRESS' ? `
 <div class="mt-2 pt-2 border-t border-slate-200">
     <div class="flex items-center gap-2 text-xs text-emerald-600">
         <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
         <span class="font-medium">Game in Progress</span>
     </div>
 </div>
 ` : gameState === 'COMPLETED' && game.winner ? `
 <div class="mt-2 pt-2 border-t border-slate-200">
     <div class="flex items-center justify-between text-xs">
         <div class="flex items-center gap-2 text-green-600">
             <div class="w-2 h-2 bg-green-500 rounded-full"></div>
             <span class="font-bold">FINAL</span>
         </div>
         <div class="font-bold text-slate-200">
             ${game.away} ${game.awayScore} - ${game.homeScore} ${game.home}
         </div>
     </div>
 </div>
 ` : ''}`;
 
 targetContainer.appendChild(gameRow);

// Add enhanced ESPN data for ALL games in picks area
if (window.espnApi) {
    setTimeout(() => addEnhancedGameDataToPicks(game.id, game, gameState), 100);
}
 });

 // Add Monday Night Football total points input
 const mondayNightGame = getMondayNightGame(weekData.games);
 if (mondayNightGame) {
   const mnfTotalInput = document.createElement('div');
   mnfTotalInput.className = 'mt-6 p-4 border border-blue-300 rounded-lg bg-blue-50';
   const isLocked = isGameLocked(mondayNightGame);
   const currentGuess = userPicks.mnfTotalPoints || '0';
   
   mnfTotalInput.innerHTML = `
     <div class="flex flex-col gap-2">
       <div class="flex items-center gap-2">
         <h3 class="text-lg font-bold text-blue-800">Monday Night Football Tiebreaker</h3>
         <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-medium">Required</span>
       </div>
       <p class="text-sm text-blue-700">
         Guess the total points scored by both teams in: <strong>${mondayNightGame.away} @ ${mondayNightGame.home}</strong>
       </p>
       <p class="text-xs text-blue-600">
         This will be used as a tiebreaker if multiple players have the same weekly confidence points total.
         Closest guess without going over wins the tie.
       </p>
       <div class="flex items-center gap-2 mt-2">
         <label for="mnf-total-points" class="font-medium text-blue-800">Total Points:</label>
         <input 
           type="number" 
           id="mnf-total-points" 
           min="0" 
           max="150" 
           step="1"
           pattern="[0-9]*"
           inputmode="numeric"
           placeholder="Enter total points" 
           value="${currentGuess}"
           ${isLocked ? 'disabled' : ''} 
           class="w-24 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${isLocked ? 'bg-gray-100' : 'bg-white'}"
         />
         ${isLocked ? '<span class="text-xs text-gray-500">(Game has started)</span>' : ''}
         <button 
           id="mnf-save-btn" 
           class="ml-2 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 focus:ring-2 focus:ring-blue-500"
           ${isLocked ? 'disabled' : ''}>
           Save Picks
         </button>
         <div id="mnf-save-status" class="hidden flex items-center gap-2 ml-2">
           <div class="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
           <span class="text-xs text-green-600">Saving...</span>
         </div>
       </div>
     </div>
   `;
   targetContainer.appendChild(mnfTotalInput);
 }

 activePicks = JSON.parse(JSON.stringify(userPicks));

// Initialize MNF tiebreaker points if not set  
if (!activePicks.mnfTotalPoints) {
  activePicks.mnfTotalPoints = 0;
}
 
 const saveFunction = targetContainer === allUI.gameList ? savePicksToFirestore : (wk, pks) => { currentAdminPicks = pks; };

 targetContainer.querySelectorAll('.winner-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const gameId = e.target.dataset.gameId;
 const team = e.target.dataset.team;
 activePicks[gameId].winner = team;
 
 // Update visual state by re-rendering the UI instead of just toggling classes
 // This ensures the new color scheme is applied correctly
 const gameData = weekData.games.find(game => game.id === gameId);
 if (gameData) {
   // Find the game row and update button classes
   const gameButtons = targetContainer.querySelectorAll(`.winner-btn[data-game-id="${gameId}"]`);
   gameButtons.forEach(button => {
     const buttonTeam = button.dataset.team;
     const isSelected = buttonTeam === team;
     const isLocked = isGameLocked(gameData);
     
     // Remove all state classes
     button.className = button.className.replace(/bg-\S+|border-\S+|text-\S+|shadow\S*|hover:\S+|opacity-\S+/g, '');
     
     // Apply new classes based on state
     if (!isLocked) {
       if (isSelected) {
         button.className += ' bg-blue-600 border-blue-600 text-slate-900 shadow-md hover:bg-blue-700';
       } else {
         button.className += ' bg-slate-50 border-slate-300 text-slate-700 hover:bg-slate-100 hover:border-slate-400 hover:shadow-md';
       }
     }
   });
 }
 
 saveFunction(currentWeek, activePicks);
 });
 });

 targetContainer.querySelectorAll('.confidence-select').forEach(select => {
 select.addEventListener('change', (e) => {
 const gameId = e.target.dataset.gameId;
 const newConfidence = parseInt(e.target.value, 10);
 const oldConfidence = activePicks[gameId].confidence;
 if (newConfidence === oldConfidence) return;
 const otherGameId = Object.keys(activePicks).find(id => id !== gameId && activePicks[id].confidence === newConfidence);
 if (otherGameId) {
 // CRITICAL BUG FIX: Check if the other game is locked before swapping
 const otherGame = weekData.games.find(game => game.id === otherGameId);
 if (otherGame && isGameLocked(otherGame)) {
 // Cannot swap with locked game - revert the change
 e.target.value = oldConfidence;
 alert('Cannot swap confidence with a game that has already started.');
 return;
 }
 activePicks[otherGameId].confidence = oldConfidence;
 const otherSelect = targetContainer.querySelector(`.confidence-select[data-game-id="${otherGameId}"]`);
 if (otherSelect) otherSelect.value = oldConfidence;
 }
 activePicks[gameId].confidence = newConfidence;
 saveFunction(currentWeek, activePicks);
 });
 });

 // Add event listener for MNF total points input
 const mnfInput = targetContainer.querySelector('#mnf-total-points');
 const mnfSaveStatus = targetContainer.querySelector('#mnf-save-status');
 const mnfSaveBtn = targetContainer.querySelector('#mnf-save-btn');

 // Functions to show/hide MNF save spinner
 function showMnfSaveSpinner() {
   if (mnfSaveStatus) {
     mnfSaveStatus.classList.remove('hidden');
   }
 }

 function hideMnfSaveSpinner() {
   if (mnfSaveStatus) {
     mnfSaveStatus.classList.add('hidden');
   }
 }

 let mnfSaveTimeout;
 
 if (mnfInput) {
   // Prevent non-numeric input
   mnfInput.addEventListener('keydown', (e) => {
     // Allow backspace, delete, tab, escape, enter, and arrow keys
     if ([8, 9, 27, 13, 46, 37, 38, 39, 40].includes(e.keyCode) ||
         // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
         (e.keyCode === 65 && e.ctrlKey === true) ||
         (e.keyCode === 67 && e.ctrlKey === true) ||
         (e.keyCode === 86 && e.ctrlKey === true) ||
         (e.keyCode === 88 && e.ctrlKey === true)) {
       return;
     }
     // Ensure that it's a number and stop the keypress if not
     if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
       e.preventDefault();
     }
   });

   mnfInput.addEventListener('input', (e) => {
     // Clear any existing timeout
     if (mnfSaveTimeout) {
       clearTimeout(mnfSaveTimeout);
     }
     
     const totalPoints = parseInt(e.target.value, 10);
     if (!isNaN(totalPoints) && totalPoints >= 0) {
       activePicks.mnfTotalPoints = totalPoints;
     } else if (e.target.value === '') {
       delete activePicks.mnfTotalPoints;
     }
     
     // Set a 5-second delay before auto-saving
     mnfSaveTimeout = setTimeout(async () => {
       showMnfSaveSpinner();
       await saveFunction(currentWeek, activePicks);
       setTimeout(hideMnfSaveSpinner, 500);
     }, 5000);
   });
 }

 // Add event listener for MNF Save button
 if (mnfSaveBtn) {
   mnfSaveBtn.addEventListener('click', async () => {
     // Clear any pending auto-save timeout
     if (mnfSaveTimeout) {
       clearTimeout(mnfSaveTimeout);
     }
     
     showMnfSaveSpinner();
     await saveFunction(currentWeek, activePicks);
     setTimeout(hideMnfSaveSpinner, 500);
   });
 }
 }

 function toggleViews(showAdmin) {
    allUI.adminContainer.classList.toggle('hidden', showAdmin);
    allUI.picksContainer.classList.toggle('hidden', !showAdmin);
    allUI.leaderboardContainer.classList.add('hidden'); // Always hide leaderboard when toggling admin/picks
    allUI.survivorContainer.classList.add('hidden'); // Always hide survivor when toggling admin/picks
    allUI.survivorPicksContainer.classList.add('hidden'); // Always hide survivor picks when toggling admin/picks

    allUI.adminViewBtn.classList.toggle('active', showAdmin);
    allUI.picksViewBtn.classList.toggle('active', !showAdmin);
    allUI.leaderboardViewBtn.classList.remove('active');
 }

 // --- EVENT LISTENERS ---
 allUI.picksViewBtn.addEventListener('click', async () => {
    allUI.picksContainer.classList.remove('hidden');
    allUI.picksSummaryContainer.classList.remove('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    allUI.gridContainer.classList.add('hidden');
    allUI.survivorContainer.classList.add('hidden');
    allUI.survivorPicksContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.picksViewBtn.classList.add('active');
    allUI.menuPanel.classList.add('hidden');
    await updatePicksSummary();
    updateTimestamps();
    saveAppState();
 });

 allUI.adminViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.picksSummaryContainer.classList.add('hidden');
    allUI.adminContainer.classList.remove('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    allUI.gridContainer.classList.add('hidden');
    allUI.survivorContainer.classList.add('hidden');
    allUI.survivorPicksContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.adminViewBtn.classList.add('active');
    
    // Restore admin tab state from URL hash or default to first tab
    const hash = window.location.hash.substring(1);
    if (hash.startsWith('admin-')) {
        const tabId = `tab-${hash.substring(6)}`;
        switchToAdminTab(tabId);
    } else {
        // Default to first admin tab if no hash present
        const firstTab = allUI.adminTabs[0];
        if (firstTab) {
            switchToAdminTab(firstTab.id);
        } else {
            renderAdminView(allUI.adminWeekSelector.value);
        }
    }
    
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });
 
 if (allUI.survivorAdminBtn) {
    allUI.survivorAdminBtn.addEventListener('click', () => {
       allUI.menuPanel.classList.add('hidden');
       // Set flag to show admin panel when landing on survivor page
       sessionStorage.setItem('survivorAdminView', 'true');
       // Force immediate navigation
       setTimeout(() => {
           window.location.href = './index.html?view=survivor';
       }, 50);
    });
 }

 if (allUI.userDiagnosticBtn) {
    allUI.userDiagnosticBtn.addEventListener('click', () => {
       allUI.menuPanel.classList.add('hidden');
       // Show user diagnostic info in a modal or console
       showUserDiagnostics();
    });
 }
 
 allUI.leaderboardViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.picksSummaryContainer.classList.add('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.gridContainer.classList.add('hidden');
    allUI.survivorContainer.classList.add('hidden');
    allUI.survivorPicksContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.remove('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.leaderboardViewBtn.classList.add('active');
    renderPublicLeaderboard();
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });

 if (allUI.gridViewBtn) {
    allUI.gridViewBtn.addEventListener('click', () => {
       allUI.picksContainer.classList.add('hidden');
       allUI.picksSummaryContainer.classList.add('hidden');
       allUI.adminContainer.classList.add('hidden');
       allUI.leaderboardContainer.classList.add('hidden');
       allUI.survivorContainer.classList.add('hidden');
       allUI.survivorPicksContainer.classList.add('hidden');
       allUI.gridContainer.classList.remove('hidden');
       document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
       allUI.gridViewBtn.classList.add('active');
       populateGridWeekSelectors();
       renderGrid();
       allUI.menuPanel.classList.add('hidden');
       saveAppState();
    });
 }


 
 async function renderPublicLeaderboard() {
    allUI.publicLeaderboardLoader.classList.remove('hidden');
    allUI.publicLeaderboardBody.innerHTML = '';
    
    let isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
    
    if (isSeasonView) {
        await calculateAndDisplayLeaderboard(null, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    } else {
        const week = allUI.lbWeekSelector.value;
        await calculateAndDisplayLeaderboard(week, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    }
}

 allUI.lbWeeklyBtn.addEventListener('click', () => {
    allUI.lbWeeklyBtn.classList.add('active');
    allUI.lbSeasonBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.remove('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbSeasonBtn.addEventListener('click', () => {
    allUI.lbSeasonBtn.classList.add('active');
    allUI.lbWeeklyBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.add('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbWeekSelector.addEventListener('change', (e) => {
  currentWeek = parseInt(e.target.value, 10);
  renderPublicLeaderboard();
  updateUrl(true); // Breadcrumb navigation - add to browser history
  saveAppState();
 });


 allUI.prevWeekBtn.addEventListener('click', () => {
  if (currentWeek > 1) {
   currentWeek--;
   allUI.weekDisplay.textContent = `Week ${currentWeek}`;
   document.getElementById('picks-container-title').textContent = `My picks for Week ${currentWeek}`;
   updateWeekButtonStates();
   loadAndRenderWeek(currentWeek);
   updateUrl(true); // Breadcrumb navigation - add to browser history
   saveAppState();
  }
 });
 allUI.nextWeekBtn.addEventListener('click', () => {
  if (currentWeek < 18) {
   currentWeek++;
   allUI.weekDisplay.textContent = `Week ${currentWeek}`;
   document.getElementById('picks-container-title').textContent = `My picks for Week ${currentWeek}`;
   updateWeekButtonStates();
   loadAndRenderWeek(currentWeek);
   updateUrl(true); // Breadcrumb navigation - add to browser history
   saveAppState();
  }
 });
 allUI.adminWeekSelector.addEventListener('change', (e) => {
  currentWeek = parseInt(e.target.value, 10);
  renderAdminView(e.target.value);
  updateUrl(true); // Breadcrumb navigation - add to browser history
  saveAppState();
 });
 
 // Grid view event listeners
 if (allUI.gridWeekSelector) {
   allUI.gridWeekSelector.addEventListener('change', (e) => {
    currentWeek = parseInt(e.target.value, 10);
    renderGrid();
    updateUrl(true); // Breadcrumb navigation - add to browser history
    saveAppState();
   });
 }
 if (allUI.gridYearlyLeaderboardLink) {
   allUI.gridYearlyLeaderboardLink.addEventListener('click', (e) => {
     e.preventDefault();
     allUI.leaderboardViewBtn.click();
     setTimeout(() => allUI.lbSeasonBtn.click(), 100);
   });
 }
 
 allUI.saveResultsBtn.addEventListener('click', async () => {
 const weekNumber = allUI.adminWeekSelector.value;
 const newResults = {};
 
 // Get all unique game IDs
 const gameIds = new Set();
 allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => {
   gameIds.add(btn.dataset.gameId);
 });
 
 // For each game, collect winner and scores
 gameIds.forEach(gameId => {
   const selectedBtn = allUI.resultsGameList.querySelector(`.result-btn[data-game-id="${gameId}"].selected`);
   const awayScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="away"]`);
   const homeScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="home"]`);
   
   const awayScore = parseInt(awayScoreInput?.value) || null;
   const homeScore = parseInt(homeScoreInput?.value) || null;
   const winner = selectedBtn?.dataset.team || null;
   
   // Store enhanced result object if we have scores or winner
   if (winner || awayScore !== null || homeScore !== null) {
     newResults[gameId] = {
       winner: winner,
       awayScore: awayScore,
       homeScore: homeScore
     };
   }
 });
 
 await setDoc(doc(db, resultsPath(weekNumber)), newResults);

 //  CRITICAL: Invalidate all cache affected by game results changes
 window.gameStateCache.invalidateAfterDataUpdate('game_results_updated', weekNumber);
 
 // Show football indicator for game update
 showGameUpdateIndicator();
 
 // Update the leaderboard summary for optimization
 try {
     await updateLeaderboardSummary();
     console.log(' Leaderboard summary updated after results save');
 } catch (error) {
     console.error('Failed to update leaderboard summary:', error);
     // Continue anyway - summary is optimization, not critical
 }
 
 alert('Results saved successfully!');
 // Live leaderboard removed from Games tab per user request
 });

//  DIAMOND LEVEL: Comprehensive cache refresh with data integrity protection
allUI.refreshSummaryBtn.addEventListener('click', async () => {
    try {
        allUI.refreshSummaryBtn.disabled = true;
        allUI.refreshSummaryBtn.textContent = ' Refreshing All Cache...';
        
        console.log(' Manual comprehensive cache refresh triggered by admin');
        
        //  CRITICAL: Complete cache invalidation for data integrity
        const clearedEntries = window.gameStateCache.invalidateAfterDataUpdate('complete_refresh');
        
        // Force update leaderboard summary after cache clear
        await updateLeaderboardSummary();
        
        // Visual feedback only - no alert
        updateCacheStatusIndicator('current');
        console.log(` Complete cache refresh successful! Cleared ${clearedEntries} cache entries`);
        allUI.refreshSummaryBtn.textContent = ' Refresh Cache';
        
        // Cache refreshed - no leaderboard to refresh on Games tab
    } catch (error) {
        console.error('Failed to refresh cache:', error);
        updateCacheStatusIndicator('outdated');
        console.error(' Failed to refresh cache:', error.message);
        allUI.refreshSummaryBtn.textContent = ' Refresh Cache';
    } finally {
        allUI.refreshSummaryBtn.disabled = false;
    }
});

 allUI.resetPicksBtn.addEventListener('click', async () => {
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 if (weekIsLocked) return;

 // Show confirmation dialog
 const confirmReset = confirm('Are you sure?');
 
 // If user clicks Cancel, abort the operation
 if (!confirmReset) return;

 const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
 if (!Array.isArray(weekData.games) || weekData.games.length === 0) return;

 const resetPicks = {};
 weekData.games.forEach((game, index) => {
 resetPicks[game.id] = { winner: null, confidence: index + 1 };
 });
 await savePicksToFirestore(currentWeek, resetPicks);
 });

 // Top Save Picks button event listener
 allUI.topSavePicksBtn.addEventListener('click', async () => {
   const savePicksText = document.getElementById('save-picks-text');
   const savePicksSpinner = document.getElementById('save-picks-spinner');
   
   // Show spinner and update text
   savePicksText.textContent = 'Saving...';
   savePicksSpinner.classList.remove('hidden');
   allUI.topSavePicksBtn.disabled = true;
   
   try {
     // Save picks
     await savePicksToFirestore(currentWeek, activePicks);
     
     // Store last update time
     localStorage.setItem('lastPicksUpdate', new Date().toISOString());
     
     // Keep spinner visible for 2 seconds total
     setTimeout(async () => {
       savePicksText.textContent = 'Save Picks';
       savePicksSpinner.classList.add('hidden');
       // Re-check button states to properly enable/disable
       const games = await getGamesForWeek(currentWeek);
       const weekData = { week: currentWeek, games: games };
       updatePicksButtonStates(weekData);
       updateTimestamps();
     }, 2000);
   } catch (error) {
     console.error('Error saving picks:', error);
     savePicksText.textContent = 'Save Picks';
     savePicksSpinner.classList.add('hidden');
     allUI.topSavePicksBtn.disabled = false;
   }
 });

// OLD userPicksSelector event listener removed - replaced with new player icons interface
 allUI.saveUserPicksBtn.addEventListener('click', async () => {
    if (!selectedUserForPicks) return;
    
    const weekNumber = allUI.adminWeekSelector.value;
    const user = allUsers.find(u => u.id === selectedUserForPicks);
    
    if (!user) return;
    
    try {
        // Validate and fix confidence values before saving
        const validatedPicks = validateAndFixConfidenceValues(originalUserPicks, editableGamesForUser);
        
        // Save the validated picks
        const docRef = doc(db, picksPath(weekNumber, selectedUserForPicks));
        await setDoc(docRef, validatedPicks);
        
        //  CRITICAL: Invalidate all cache affected by admin picks changes
        window.gameStateCache.invalidateAfterDataUpdate('admin_picks_saved', weekNumber, selectedUserForPicks);
        
        // Trigger leaderboard recalculation
        await recalculateLeaderboardAfterPickUpdate(weekNumber);
        
        alert(`${user.displayName || user.email}'s picks have been saved.`);
        
        // Refresh the picks management view
        await renderPicksManagement(weekNumber);
        
    } catch (error) {
        console.error('Error saving user picks:', error);
        alert('Error saving picks. Please try again.');
    }
});

// Add cancel button handler
allUI.cancelUserPicksBtn.addEventListener('click', () => {
    // Reset state and hide editor
    selectedUserForPicks = null;
    originalUserPicks = {};
    editableGamesForUser = [];
    allUI.userPicksEditor.classList.add('hidden');
});

// === PICK VALIDATION EVENT LISTENERS ===
allUI.validateAllPicksBtn.addEventListener('click', async () => {
    const weekNumber = allUI.adminWeekSelector.value;
    if (!weekNumber) {
        alert('Please select a week first');
        return;
    }
    
    allUI.validateAllPicksBtn.disabled = true;
    allUI.validateAllPicksBtn.textContent = 'Validating...';
    
    try {
        await validateAllUserPicks(weekNumber);
    } catch (error) {
        console.error('Error during validation:', error);
        alert('Error during validation. Please try again.');
    } finally {
        allUI.validateAllPicksBtn.disabled = false;
        allUI.validateAllPicksBtn.textContent = 'Validate All Picks';
    }
});

allUI.clearValidationAlertsBtn.addEventListener('click', () => {
    allUI.validationResults.innerHTML = '<div class="text-sm text-gray-600">Click "Validate All Picks" to check for issues</div>';
});

// === SURVIVOR PICK MANAGEMENT EVENT LISTENERS ===
let selectedSurvivorUser = null;
let selectedSurvivorTeam = null;

allUI.saveSurvivorPickBtn.addEventListener('click', async () => {
    if (!selectedSurvivorUser || !selectedSurvivorTeam) return;
    
    const weekNumber = allUI.adminWeekSelector.value;
    const user = allUsers.find(u => u.id === selectedSurvivorUser);
    
    if (!user) return;
    
    try {
        allUI.saveSurvivorPickBtn.disabled = true;
        allUI.saveSurvivorPickBtn.textContent = 'Saving...';
        
        //  UNIFIED: Save to BOTH unified document AND individual for backwards compatibility
        if (window.unifiedSurvivorManager) {
            // Save to unified document (1 transaction)
            await window.unifiedSurvivorManager.updateUserPick(weekNumber, selectedSurvivorUser, user.displayName, selectedSurvivorTeam);
        }
        
        // Also save to individual document for backwards compatibility
        const survivorPicksDocRef = doc(db, survivorPicksPath(selectedSurvivorUser));
        const survivorData = { picks: { [weekNumber]: { team: selectedSurvivorTeam } } };
        
        await setDoc(survivorPicksDocRef, survivorData, { merge: true });
        
        //  CRITICAL: Invalidate all cache affected by survivor picks changes
        window.gameStateCache.invalidateAfterDataUpdate('survivor_picks_saved', weekNumber);
        
        alert(`Survivor pick saved: ${user.displayName || user.email} -> ${selectedSurvivorTeam}`);
        
        // Refresh survivor status view
        await renderSurvivorStatus(weekNumber);
        
        // Hide editor
        hideSurvivorPickEditor();
        
    } catch (error) {
        console.error('Error saving survivor pick:', error);
        alert('Error saving survivor pick. Please try again.');
    } finally {
        allUI.saveSurvivorPickBtn.disabled = false;
        allUI.saveSurvivorPickBtn.textContent = 'Save Survivor Pick';
    }
});

allUI.cancelSurvivorPickBtn.addEventListener('click', () => {
    hideSurvivorPickEditor();
});

allUI.clearSurvivorPickBtn.addEventListener('click', async () => {
    if (!selectedSurvivorUser) return;
    
    if (!confirm('Are you sure you want to clear this survivor pick?')) return;
    
    const weekNumber = allUI.adminWeekSelector.value;
    const user = allUsers.find(u => u.id === selectedSurvivorUser);
    
    if (!user) return;
    
    try {
        allUI.clearSurvivorPickBtn.disabled = true;
        allUI.clearSurvivorPickBtn.textContent = 'Clearing...';
        
        // Clear survivor pick
        const survivorPicksDocRef = doc(db, survivorPicksPath(selectedSurvivorUser));
        const survivorData = { picks: { [weekNumber]: { team: '' } } };
        
        await setDoc(survivorPicksDocRef, survivorData, { merge: true });
        
        //  CRITICAL: Invalidate all cache affected by survivor picks changes
        window.gameStateCache.invalidateAfterDataUpdate('survivor_picks_saved', weekNumber);
        
        alert(`Survivor pick cleared for ${user.displayName || user.email}`);
        
        // Refresh survivor status view
        await renderSurvivorStatus(weekNumber);
        
        // Hide editor
        hideSurvivorPickEditor();
        
    } catch (error) {
        console.error('Error clearing survivor pick:', error);
        alert('Error clearing survivor pick. Please try again.');
    } finally {
        allUI.clearSurvivorPickBtn.disabled = false;
        allUI.clearSurvivorPickBtn.textContent = 'Clear Pick';
    }
});

// Function to recalculate leaderboards after pick updates
async function recalculateLeaderboardAfterPickUpdate(weekNumber) {
    console.log(' Recalculating leaderboards after pick update for week', weekNumber);
    
    try {
        // Recalculate weekly leaderboard for the specific week
        await calculateWeeklyLeaderboard(weekNumber);
        
        // Recalculate season leaderboard which includes all weeks
        await calculateLeaderboardOptimized();
        
        console.log(' Leaderboards recalculated successfully');
    } catch (error) {
        console.error(' Error recalculating leaderboards:', error);
        // Don't throw error to prevent blocking the save operation
    }
}
 // Admin tab switching with URL hash routing
 function switchToAdminTab(tabId) {
  allUI.adminTabs.forEach(t => t.classList.remove('active'));
  allUI.adminContentSections.forEach(s => s.classList.add('hidden'));
  
  const targetTab = document.getElementById(tabId);
  const contentId = `admin-content-${tabId.substring(4)}`;
  const targetContent = document.getElementById(contentId);
  
  if (targetTab && targetContent) {
   targetTab.classList.add('active');
   targetContent.classList.remove('hidden');
   
   // Load data based on the active tab
   if (tabId === 'tab-pool-settings') {
     renderAdminPoolSettings();
   } else if (tabId === 'tab-cache-mgmt') {
     initializeCacheManagement();
   } else {
     renderAdminView(allUI.adminWeekSelector.value);
   }
   
   // Update URL hash for state persistence
   window.location.hash = `admin-${tabId.substring(4)}`;
  }
 }

 // Handle hash change events for browser back/forward
 window.addEventListener('hashchange', () => {
  const hash = window.location.hash.substring(1); // Remove the #
  if (hash.startsWith('admin-') && getCurrentView() === 'admin') {
   const tabId = `tab-${hash.substring(6)}`; // Remove 'admin-' prefix
   switchToAdminTab(tabId);
  }
 });
 
 // Restore admin tab state on page load if admin view is active
 window.addEventListener('load', () => {
  setTimeout(() => {
   const hash = window.location.hash.substring(1);
   if (hash.startsWith('admin-') && getCurrentView() === 'admin') {
    const tabId = `tab-${hash.substring(6)}`;
    switchToAdminTab(tabId);
   }
  }, 100); // Small delay to ensure DOM is ready
 });

 allUI.adminTabs.forEach(tab => {
  tab.addEventListener('click', (e) => {
   e.preventDefault();
   switchToAdminTab(e.target.id);
  });
 });
 
 allUI.menuBtn.addEventListener('click', () => {
    allUI.menuPanel.classList.toggle('hidden');
 });

 window.addEventListener('click', (e) => {
    if (!allUI.menuBtn.contains(e.target) && !allUI.menuPanel.contains(e.target)) {
        allUI.menuPanel.classList.add('hidden');
    }
 });

 allUI.settingsBtn.addEventListener('click', async () => {
    if (!currentUser) return;
    allUI.settingsDisplayName.value = currentUser.displayName || '';
    allUI.settingsEmail.value = currentUser.email || '';
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    allUI.settingsModal.classList.remove('hidden');
    allUI.settingsModal.classList.add('flex');
    allUI.menuPanel.classList.add('hidden');
    
    // Check for pending email verification
    const pendingEmail = localStorage.getItem('pendingEmailChange');
    if (pendingEmail && pendingEmail !== currentUser.email) {
        allUI.pendingEmail.textContent = pendingEmail;
        allUI.emailVerificationStatus.classList.remove('hidden');
    } else {
        allUI.emailVerificationStatus.classList.add('hidden');
        localStorage.removeItem('pendingEmailChange'); // Clean up if email was verified
    }
    
    // Check and update Google linking status
    await checkGoogleLinkingStatus();
    
    // Populate FCM notification settings
    if (typeof populateNotificationSettings === 'function') {
        populateNotificationSettings();
    }
 });

 allUI.closeSettingsBtn.addEventListener('click', () => {
    allUI.settingsModal.classList.add('hidden');
    allUI.settingsModal.classList.remove('flex');
 });

 allUI.settingsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newDisplayName = allUI.settingsDisplayName.value;
    const newEmail = allUI.settingsEmail.value;
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    allUI.emailVerificationStatus.classList.add('hidden');
    
    try {
        // Update display name immediately if changed
        if (newDisplayName !== currentUser.displayName) {
            await updateProfile(currentUser, { displayName: newDisplayName });
            allUI.userDisplay.textContent = `Welcome, ${newDisplayName ? newDisplayName.split(' ')[0] : 'User'}`;
        }
        
        // Handle email change with verification
        if (newEmail !== currentUser.email) {
            // Store the new email and show progress
            localStorage.setItem('pendingEmailChange', newEmail);
            allUI.pendingEmail.textContent = newEmail;
            allUI.emailVerificationStatus.classList.remove('hidden');
            
            // Try multiple approaches
            await attemptEmailChange(newEmail);
        } else {
            allUI.settingsSuccess.textContent = 'Settings updated successfully!';
            allUI.settingsSuccess.classList.remove('hidden');
            setTimeout(() => {
                allUI.settingsModal.classList.add('hidden');
                allUI.settingsModal.classList.remove('flex');
            }, 2000);
        }
        
        // Update Firestore with display name (email will be updated after verification)
        const userDocRef = doc(db, `${usersPath()}/${currentUser.uid}`);
        await updateDoc(userDocRef, {
            displayName: newDisplayName
            // Note: email will be updated in Firestore after verification is complete
        });
        
    } catch (error) {
        console.error("Error updating settings:", error);
        let errorMessage = 'An error occurred while updating your settings.';
        
        if (error.code === 'auth/invalid-email') {
            errorMessage = 'Please enter a valid email address.';
        } else if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email address is already in use by another account.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage = 'For security reasons, please log out and log back in before changing your email address.';
        } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Email changes are temporarily disabled. Please try again later.';
        } else {
            errorMessage = `Error: ${error.message}`;
        }
        
        allUI.settingsError.textContent = errorMessage;
        allUI.settingsError.classList.remove('hidden');
    }
 });

 allUI.resetWinnersBtn.addEventListener('click', async () => {
    const weekNumber = allUI.adminWeekSelector.value;
    if (confirm(`Are you sure you want to reset all winners for Week ${weekNumber}? This cannot be undone.`)) {
        const resultsDocRef = doc(db, resultsPath(weekNumber));
        try {
            await deleteDoc(resultsDocRef);
            alert(`Winners for Week ${weekNumber} have been reset.`);
            await renderGameResultsAdmin(weekNumber);
        } catch (error) {
            console.error("Error resetting winners:", error);
            alert("An error occurred while resetting the winners.");
        }
    }
 });

 allUI.cleanupDuplicatesBtn.addEventListener('click', async () => {
    if (confirm(' WARNING: This will remove duplicate user accounts.\n\nThis will keep the preferred UID for each email address and remove all duplicates.\n\nAre you sure you want to continue?')) {
        await cleanupDuplicateUsers();
    }
 });

// --- NERDUNIVERSE MIGRATION ---
let migrationInProgress = false;

function logMigration(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const typeColors = {
        'info': 'text-blue-700',
        'success': 'text-green-700', 
        'error': 'text-red-700',
        'warning': 'text-yellow-700'
    };
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-1 ${typeColors[type]}`;
    logEntry.innerHTML = `<span class="text-slate-500">[${timestamp}]</span> ${message}`;
    
    allUI.migrationLogDisplay.appendChild(logEntry);
    allUI.migrationLogDisplay.scrollTop = allUI.migrationLogDisplay.scrollHeight;
}

function updateMigrationProgress(percent, text) {
    allUI.migrationProgressBar.style.width = `${percent}%`;
    allUI.migrationProgressText.textContent = text;
}

async function runNerdUniverseMigration(isDryRun = false) {
    if (migrationInProgress) return;
    
    migrationInProgress = true;
    allUI.migrationProgressSection.classList.remove('hidden');
    allUI.migrationControlsSection.classList.add('hidden');
    allUI.migrationResultsSection.classList.add('hidden');
    allUI.migrationLogDisplay.innerHTML = '';
    
    const NEW_POOL_ID = 'nerduniverse-2025';
    const NEW_POOL_NAME = 'NerdUniverse 2025';
    const OLD_POOL_ID = 'nerdfootball-2025';
    
    try {
        logMigration(`Starting ${isDryRun ? 'DRY RUN' : 'MIGRATION'} to ${NEW_POOL_NAME}`, 'info');
        updateMigrationProgress(0, 'Initializing...');
        
        // Step 1: Update application to use NerdUniverse 2025
        updateMigrationProgress(10, 'Setting up NerdUniverse 2025...');
        logMigration('Step 1: Configuring NerdUniverse 2025 as primary pool', 'info');
        
        // Update the active pool ID in the application
        if (!isDryRun) {
            activePoolId = NEW_POOL_ID;
            
            // Update localStorage for all users
            if (currentUser) {
                localStorage.setItem(`activePool_${currentUser.uid}`, NEW_POOL_ID);
            }
            
            logMigration(' Application now uses NerdUniverse 2025 as default', 'success');
        } else {
            logMigration(' Would set NerdUniverse 2025 as default pool', 'success');
        }
        
        // Step 2: Get existing users
        updateMigrationProgress(25, 'Fetching existing users...');
        logMigration('Step 2: Fetching all existing users', 'info');
        
        const usersSnapshot = await getDocs(collection(db, 'artifacts/nerdfootball/public/data/nerdfootball_users'));
        const users = [];
        usersSnapshot.forEach(doc => {
            users.push({ uid: doc.id, ...doc.data() });
        });
        
        logMigration(` Found ${users.length} users to migrate`, 'success');
        
        // Step 3: Analyze user roles
        updateMigrationProgress(40, 'Analyzing user roles...');
        logMigration('Step 3: Analyzing existing user roles', 'info');
        
        let adminCount = 0, memberCount = 0;
        
        for (const user of users) {
            const isAdmin = ADMIN_UIDS.includes(user.uid);
            
            if (isAdmin) {
                adminCount++;
                logMigration(` Admin: ${user.displayName || user.email}`, 'info');
            } else {
                memberCount++;
            }
        }
        
        logMigration(` Found ${adminCount} admins and ${memberCount} members`, 'success');
        
        // Step 4: Verify all users have access
        updateMigrationProgress(60, 'Verifying user access...');
        logMigration('Step 4: Verifying all users have access to their data', 'info');
        
        // All existing users automatically have access since we're using the same data structure
        let verifiedCount = 0;
        for (const user of users) {
            verifiedCount++;
            updateMigrationProgress(60 + (15 * verifiedCount / users.length), 
                `Verified ${verifiedCount}/${users.length} users...`);
        }
        
        logMigration(` All ${users.length} users have access to NerdUniverse 2025`, 'success');
        
        // Step 5: Verify data integrity
        updateMigrationProgress(85, 'Verifying data integrity...');
        logMigration('Step 5: Verifying existing picks integrity', 'info');
        
        // Check confidence picks
        let totalConfidencePicks = 0;
        for (let week = 1; week <= 18; week++) {
            const picksSnapshot = await getDocs(collection(db, 
                picksCollectionPath(week, 'nerduniverse-2025')));
            totalConfidencePicks += picksSnapshot.size;
        }
        logMigration(` Confidence picks verified: ${totalConfidencePicks} picks preserved`, 'success');
        
        // Check survivor picks
        const survivorSnapshot = await getDocs(collection(db, 
            'artifacts/nerdfootball/public/data/nerdSurvivor_picks'));
        logMigration(` Survivor picks verified: ${survivorSnapshot.size} users preserved`, 'success');
        
        // Step 6: Finalize
        if (!isDryRun) {
            updateMigrationProgress(95, 'Finalizing migration...');
            
            logMigration(' NerdUniverse 2025 migration completed', 'success');
        }
        
        // Complete
        updateMigrationProgress(100, `${isDryRun ? 'Dry run' : 'Migration'} completed!`);
        logMigration(` ${isDryRun ? 'DRY RUN' : 'MIGRATION'} COMPLETED SUCCESSFULLY!`, 'success');
        
        // Show results
        allUI.migrationResultsSection.classList.remove('hidden');
        allUI.migrationResultsContent.innerHTML = `
            <div class="space-y-2 text-green-700">
                <p><strong>Pool Name:</strong> ${NEW_POOL_NAME}</p>
                <p><strong>Pool ID:</strong> ${NEW_POOL_ID}</p>
                <p><strong>Total Users:</strong> ${users.length}</p>
                <p><strong>Admins:</strong> ${adminCount}</p>
                <p><strong>Members:</strong> ${memberCount}</p>
                <p><strong>Confidence Picks Preserved:</strong> ${totalConfidencePicks}</p>
                <p><strong>Survivor Picks Preserved:</strong> ${survivorSnapshot.size}</p>
            </div>
            ${!isDryRun ? `
            <div class="mt-4 pt-4 border-t border-green-200">
                <h4 class="font-semibold text-green-900">Next Steps:</h4>
                <ol class="list-decimal list-inside text-green-700 mt-2 space-y-1">
                    <li>Update default pool to NerdUniverse 2025</li>
                    <li>Test user access and admin privileges</li>
                    <li>Announce migration to users</li>
                </ol>
            </div>
            ` : '<p class="mt-4 text-sm text-green-600">This was a dry run - no actual changes were made.</p>'}
        `;
        
    } catch (error) {
        updateMigrationProgress(0, 'Migration failed');
        logMigration(` Migration failed: ${error.message}`, 'error');
        console.error('Migration error:', error);
        
        allUI.migrationResultsSection.classList.remove('hidden');
        allUI.migrationResultsSection.className = 'mt-6 p-4 bg-red-50 border border-red-200 rounded-lg';
        allUI.migrationResultsContent.innerHTML = `
            <h3 class="text-lg font-semibold text-red-900 mb-2"> Migration Failed</h3>
            <p class="text-red-700">${error.message}</p>
        `;
    } finally {
        migrationInProgress = false;
        allUI.migrationControlsSection.classList.remove('hidden');
    }
}

// Migration event listeners
if (allUI.migrationToolBtn) {
    allUI.migrationToolBtn.addEventListener('click', () => {
        allUI.menuPanel.classList.add('hidden');
        allUI.migrationModal.classList.remove('hidden');
        allUI.migrationModal.classList.add('flex');
        logMigration('Migration tool opened', 'info');
    });
}

allUI.closeMigrationBtn.addEventListener('click', () => {
    if (!migrationInProgress) {
        allUI.migrationModal.classList.add('hidden');
        allUI.migrationModal.classList.remove('flex');
    }
});

allUI.closeMigrationBtn2.addEventListener('click', () => {
    if (!migrationInProgress) {
        allUI.migrationModal.classList.add('hidden');
        allUI.migrationModal.classList.remove('flex');
    }
});

allUI.startMigrationBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to start the migration to NerdUniverse 2025?\n\nThis will:\n Create the new pool\n Migrate all users\n Preserve all picks and data\n\nThis action cannot be undone.')) {
        runNerdUniverseMigration(false);
    }
});

allUI.dryRunMigrationBtn.addEventListener('click', () => {
    runNerdUniverseMigration(true);
});

// Alternative: Simple pool rename approach
async function simplePoolRename() {
    if (!confirm('Alternative approach: Simply rename the current pool to "NerdUniverse 2025"?\n\nThis will:\n Keep all existing data exactly as is\n Change the pool name in the UI\n Require no new permissions\n\nContinue?')) {
        return;
    }
    
    try {
        // Update the active pool ID
        activePoolId = 'nerduniverse-2025';
        
        // Update localStorage for persistence
        if (currentUser) {
            localStorage.setItem(`activePool_${currentUser.uid}`, activePoolId);
        }
        
        // Pool switcher will update on next page refresh
        
        logMigration(' Pool renamed to NerdUniverse 2025 (Simple approach)', 'success');
        alert('Pool successfully renamed to "NerdUniverse 2025"!\n\nAll your existing data remains intact.');
        
    } catch (error) {
        logMigration(` Simple rename failed: ${error.message}`, 'error');
    }
}

// Add simple rename button (for testing)
if (window.location.search.includes('debug=true')) {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'Simple Rename (Debug)';
    debugBtn.className = 'px-4 py-2 bg-yellow-500 text-white rounded ml-4';
    debugBtn.onclick = simplePoolRename;
    allUI.migrationControlsSection.appendChild(debugBtn);
}

// Show migration button for admins only
function showAdminMigrationTool() {
    if (currentUser && ADMIN_UIDS.includes(currentUser.uid) && allUI.adminMigrationBtn) {
        allUI.adminMigrationBtn.classList.remove('hidden');
    }
}

// Stub function to prevent errors from cached code
function updatePoolSwitcherDisplay() {
    // This function was removed but adding stub to prevent cached errors
    console.log('updatePoolSwitcherDisplay called (stub function)');
}

// ===== PICK VALIDATION SYSTEM =====
function validateUserPicks(userPicks, games) {
    const issues = [];
    const confidenceValues = [];
    
    // Check for picks and extract confidence values
    for (const game of games) {
        const pick = userPicks[game.id];
        if (pick && pick.confidence !== undefined) {
            const confidence = parseInt(pick.confidence) || 0;
            confidenceValues.push(confidence);
        }
    }
    
    // Rule 1: All confidence values are 0 (invalid submission)
    if (confidenceValues.length > 0 && confidenceValues.every(conf => conf === 0)) {
        issues.push({
            type: 'all-zero-confidence',
            severity: 'critical',
            message: 'All confidence values are 0 - invalid submission'
        });
    }
    
    // Rule 2: Duplicate confidence numbers (invalid confidence ranking)
    const confidenceSet = new Set(confidenceValues.filter(conf => conf > 0));
    if (confidenceSet.size !== confidenceValues.filter(conf => conf > 0).length) {
        issues.push({
            type: 'duplicate-confidence',
            severity: 'critical', 
            message: 'Duplicate confidence numbers detected - invalid ranking'
        });
    }
    
    return issues;
}

async function validateAllUserPicks(weekNumber) {
    console.log(' DIAMOND VALIDATION: Starting pick validation for week', weekNumber);
    allUI.validationResults.innerHTML = '<div class="text-sm text-gray-600">Validating picks...</div>';
    
    const flaggedUsers = [];
    const picksCollectionPath = `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`;
    
    try {
        // Load games for this week
        const games = await getGamesForWeek(weekNumber);
        
        // Load all user picks for validation
        const picksCollection = collection(db, picksCollectionPath);
        const picksSnapshot = await getDocs(picksCollection);
        
        for (const doc of picksSnapshot.docs) {
            const userId = doc.id;
            const userPicks = doc.data() || {};
            const user = allUsers.find(u => u.id === userId);
            
            if (!user) continue; // Skip if user not found
            
            const issues = validateUserPicks(userPicks, games);
            
            if (issues.length > 0) {
                flaggedUsers.push({
                    userId,
                    user,
                    issues,
                    picks: userPicks
                });
            }
        }
        
        // Display results
        displayValidationResults(flaggedUsers, weekNumber);
        
        console.log(' DIAMOND VALIDATION: Complete', {
            totalUsers: picksSnapshot.docs.length,
            flaggedUsers: flaggedUsers.length
        });
        
    } catch (error) {
        console.error('Error validating picks:', error);
        allUI.validationResults.innerHTML = '<div class="text-sm text-red-600">Error during validation</div>';
    }
}

function displayValidationResults(flaggedUsers, weekNumber) {
    if (flaggedUsers.length === 0) {
        allUI.validationResults.innerHTML = `
            <div class="bg-green-50 border border-green-200 p-3 rounded">
                <div class="text-sm text-green-800 font-medium"> All picks validated successfully</div>
                <div class="text-xs text-green-600 mt-1">No validation issues found for week ${weekNumber}</div>
            </div>
        `;
        return;
    }
    
    const resultsHTML = flaggedUsers.map(flagged => {
        const issuesHTML = flagged.issues.map(issue => {
            const severityColor = issue.severity === 'critical' ? 'text-red-600' : 'text-yellow-600';
            return `<div class="text-xs ${severityColor}"> ${issue.message}</div>`;
        }).join('');
        
        return `
            <div class="bg-red-50 border border-red-200 p-3 rounded">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-sm font-medium text-red-800">${flagged.user.displayName || flagged.user.email}</div>
                        <div class="mt-1">${issuesHTML}</div>
                    </div>
                    <button onclick="selectUserForPicksEditing('${flagged.userId}', ${weekNumber}, {})" 
                            class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">
                        Fix Picks
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    allUI.validationResults.innerHTML = `
        <div class="space-y-2">
            <div class="text-sm font-medium text-red-800"> ${flaggedUsers.length} users with invalid picks:</div>
            ${resultsHTML}
        </div>
    `;
}

// ===== SURVIVOR PICK MANAGEMENT FUNCTIONS =====
window.showSurvivorPickEditor = async function(userId, weekNumber, currentPick = '') {
    selectedSurvivorUser = userId;
    selectedSurvivorTeam = currentPick;
    
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    // Update UI
    allUI.survivorEditorWeek.textContent = weekNumber;
    allUI.survivorEditorUserName.textContent = user.displayName || user.email;
    
    // Load available NFL teams and create team selector
    await renderSurvivorTeamSelector(currentPick);
    
    // Show editor
    allUI.survivorPickEditor.classList.remove('hidden');
}

function hideSurvivorPickEditor() {
    selectedSurvivorUser = null;
    selectedSurvivorTeam = null;
    allUI.survivorPickEditor.classList.add('hidden');
}

async function renderSurvivorTeamSelector(currentPick) {
    // Get all NFL teams (using existing team list from regular picks)
    const weekNumber = allUI.adminWeekSelector.value;
    
    try {
        const games = await getGamesForWeek(weekNumber);
        const allTeams = new Set();
        
        games.forEach(game => {
            allTeams.add(game.home);
            allTeams.add(game.away);
        });
        
        const sortedTeams = Array.from(allTeams).sort();
        
        const teamButtons = sortedTeams.map(team => {
            const isSelected = team === currentPick;
            const helmetClass = getHelmetClass(team);
            
            return `
                <button class="survivor-team-btn flex flex-col items-center p-2 border rounded hover:bg-blue-50 ${isSelected ? 'bg-blue-200 border-blue-500' : 'border-gray-300'}" 
                        data-team="${team}">
                    <div class="helmet-icon ${helmetClass} mb-1"></div>
                    <span class="text-xs font-medium">${team}</span>
                </button>
            `;
        }).join('');
        
        allUI.survivorTeamSelector.innerHTML = teamButtons;
        
        // Add click handlers for team selection
        allUI.survivorTeamSelector.querySelectorAll('.survivor-team-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove selection from all buttons
                allUI.survivorTeamSelector.querySelectorAll('.survivor-team-btn').forEach(b => {
                    b.classList.remove('bg-blue-200', 'border-blue-500');
                    b.classList.add('border-gray-300');
                });
                
                // Select clicked button
                const teamBtn = e.currentTarget;
                teamBtn.classList.add('bg-blue-200', 'border-blue-500');
                teamBtn.classList.remove('border-gray-300');
                
                selectedSurvivorTeam = teamBtn.dataset.team;
            });
        });
        
    } catch (error) {
        console.error('Error loading teams for survivor picker:', error);
        allUI.survivorTeamSelector.innerHTML = '<div class="text-red-600 text-sm">Error loading teams</div>';
    }
}

// --- SURVIVOR VIEW OBJECT ---
const SurvivorView = {
    // Cache for optimized week results loading
    cachedWeekResults: null,
    
    show: function() {
        console.log(' Showing Survivor Results view');
        console.log(' Debug - allUI.survivorContainer exists:', !!allUI.survivorContainer);
        console.log(' Debug - hideAllViews function exists:', typeof hideAllViews);
        console.log(' Debug - updateUrl function exists:', typeof updateUrl);
        
        try {
            hideAllViews();
            allUI.survivorContainer.classList.remove('hidden');
            console.log(' Survivor container shown successfully');
            this.loadSurvivorResults();
            updateUrl();
        } catch (error) {
            console.error(' Error in SurvivorView.show():', error);
            // Fallback to show error
            if (allUI.survivorContainer) {
                allUI.survivorContainer.classList.remove('hidden');
                this.showError('Failed to load survivor view: ' + error.message);
            }
        }
    },
    
    hide: function() {
        allUI.survivorContainer.classList.add('hidden');
    },
    
    showLoading: function() {
        allUI.survivorLoadingContainer.classList.remove('hidden');
        allUI.survivorErrorContainer.classList.add('hidden');
        allUI.survivorResultsContainer.classList.add('hidden');
        allUI.survivorNoResults.classList.add('hidden');
    },
    
    showError: function(message) {
        allUI.survivorErrorMessage.textContent = message;
        allUI.survivorLoadingContainer.classList.add('hidden');
        allUI.survivorErrorContainer.classList.remove('hidden');
        allUI.survivorResultsContainer.classList.add('hidden');
        allUI.survivorNoResults.classList.add('hidden');
    },
    
    showResults: function() {
        allUI.survivorLoadingContainer.classList.add('hidden');
        allUI.survivorErrorContainer.classList.add('hidden');
        allUI.survivorResultsContainer.classList.remove('hidden');
        allUI.survivorNoResults.classList.add('hidden');
    },
    
    showNoResults: function() {
        allUI.survivorLoadingContainer.classList.add('hidden');
        allUI.survivorErrorContainer.classList.add('hidden');
        allUI.survivorResultsContainer.classList.add('hidden');
        allUI.survivorNoResults.classList.remove('hidden');
    },
    
    getCurrentWeek: function() {
        // Use global week management system
        return window.currentWeek || 1;
    },
    
    // ESPN API: Ultra-fast parallel week results loading from ESPN data
    loadAllWeekResults: async function(currentWeek) {
        // ESPN OPTIMIZATION: Use gameStateCache if available (fastest path)
        if (typeof window.gameStateCache === 'object' && window.gameStateCache) {
            const cachedResults = {};
            let cacheHits = 0;
            for (let week = 1; week <= currentWeek; week++) {
                if (window.gameStateCache[week]) {
                    cachedResults[week] = window.gameStateCache[week];
                    cacheHits++;
                }
            }
            if (cacheHits > 0) {
                console.log(` ESPN CACHE: Using gameStateCache (${cacheHits}/${currentWeek} weeks)`);
                return cachedResults;
            }
        }
        
        // ESPN OPTIMIZATION: Instance-level caching for repeated calls
        if (this.cachedWeekResults && this.cacheTimestamp && (Date.now() - this.cacheTimestamp) < 30000) {
            console.log(' ESPN CACHE HIT: Using fresh cached week results');
            return this.cachedWeekResults;
        }
        
        console.log(` ESPN BATCH LOAD: Loading results for weeks 1-${currentWeek} from ESPN API`);
        const startTime = performance.now();
        
        try {
            // ESPN OPTIMIZATION: Use ESPN API for all week data
            if (typeof window.espnApi !== 'undefined') {
                const resultPromises = Array.from({ length: currentWeek }, (_, i) => {
                    const week = i + 1;
                    return window.espnApi.getWeekGames(week)
                        .then(games => {
                            if (!games || games.length === 0) return { week, data: null };
                            
                            // Convert ESPN games to our results format
                            const weekData = {};
                            games.forEach(game => {
                                weekData[game.id] = {
                                    id: game.id,
                                    homeTeam: game.home_team,
                                    awayTeam: game.away_team,
                                    homeScore: game.home_score,
                                    awayScore: game.away_score,
                                    status: game.status,
                                    winner: this.determineESPNWinner(game)
                                };
                            });
                            
                            return { week, data: weekData };
                        })
                        .catch(error => {
                            console.error(`Error loading ESPN week ${week} results:`, error);
                            return { week, data: null };
                        });
                });
                
                const allResults = await Promise.all(resultPromises);
                this.cachedWeekResults = {};
                allResults.forEach(({ week, data }) => {
                    if (data) this.cachedWeekResults[week] = data;
                });
                
                this.cacheTimestamp = Date.now();
                
                const loadTime = (performance.now() - startTime).toFixed(0);
                console.log(` ESPN WEEK RESULTS: ${Object.keys(this.cachedWeekResults).length}/${currentWeek} weeks loaded in ${loadTime}ms`);
                return this.cachedWeekResults;
            }
            
            // Fallback to Firestore if ESPN API unavailable
            console.warn(' ESPN API unavailable, falling back to Firestore');
            const resultPromises = Array.from({ length: currentWeek }, (_, i) => {
                const week = i + 1;
                return getDoc(doc(db, `artifacts/nerdfootball/public/data/nerdfootball_results/${week}`))
                    .then(doc => ({ week, data: doc.exists() ? doc.data() : null }))
                    .catch(error => {
                        console.error(`Error loading week ${week} results:`, error);
                        return { week, data: null };
                    });
            });
            
            const allResults = await Promise.all(resultPromises);
            this.cachedWeekResults = {};
            allResults.forEach(({ week, data }) => {
                if (data) this.cachedWeekResults[week] = data;
            });
            
            this.cacheTimestamp = Date.now();
            
            const loadTime = (performance.now() - startTime).toFixed(0);
            console.log(` FIRESTORE FALLBACK RESULTS: ${Object.keys(this.cachedWeekResults).length}/${currentWeek} weeks loaded in ${loadTime}ms`);
            return this.cachedWeekResults;
        } catch (error) {
            console.error('ESPN/FIRESTORE ERROR: Week results loading failed:', error);
            return {};
        }
    },
    
    // ESPN winner determination logic
    determineESPNWinner: function(game) {
        if (!game.status || game.status === 'Not Started' || game.status.includes('Q') || game.status.includes('Half')) {
            return 'TBD';
        }
        
        if (game.status === 'Final' || game.status === 'FINAL') {
            const homeScore = parseInt(game.home_score) || 0;
            const awayScore = parseInt(game.away_score) || 0;
            
            if (homeScore > awayScore) {
                return game.home_team;
            } else if (awayScore > homeScore) {
                return game.away_team;
            } else {
                return 'TIE';
            }
        }
        
        return 'TBD';
    },
    
    calculateWeeksSurvived: function(userPicks, currentWeek, allWeekResults) {
        try {
            let weeksSurvived = 0;
            
            // Check each week from 1 to current week
            for (let week = 1; week <= currentWeek; week++) {
                const weekPick = userPicks[week];
                if (!weekPick || !weekPick.team) {
                    // No pick for this week - stop counting
                    break;
                }
                
                const weekResults = allWeekResults[week];
                if (weekResults) {
                    // Check ONLY the specific game the user picked
                    let teamWon = false;
                    
                    if (weekPick.gameId && weekResults[weekPick.gameId]) {
                        // Use specific game lookup (matches survivorAutoElimination.js pattern)
                        const specificGame = weekResults[weekPick.gameId];
                        if (specificGame && specificGame.winner === weekPick.team) {
                            teamWon = true;
                        }
                    } else {
                        // Backward compatibility: fallback to checking all games
                        Object.values(weekResults).forEach(gameResult => {
                            if (gameResult && gameResult.winner === weekPick.team) {
                                teamWon = true;
                            }
                        });
                    }
                    
                    if (teamWon) {
                        weeksSurvived = week; // User survived this week
                    } else {
                        // Team lost or no result yet
                        if (week < currentWeek) {
                            // Past week with no win = eliminated
                            break;
                        } else {
                            // Current week - no result yet, don't count it
                            break;
                        }
                    }
                } else if (week < currentWeek) {
                    // Past week with no results = assume eliminated
                    break;
                }
                // Current week with no results yet = don't count it
            }
            
            return weeksSurvived;
        } catch (error) {
            console.error('Error calculating weeks survived for user:', error);
            // Fallback to old logic
            return Math.max(0, currentWeek - 1);
        }
    },
    
    // Determine row background color based on user's current pick status
    getPlayerRowStatus: function(user, currentWeek, allWeekResults) {
        console.log(' SURVIVOR DEBUG - getPlayerRowStatus for:', user.displayName, '(', user.uid, ')');
        console.log(' User eliminated?', user.isEliminated);
        console.log(' User current week pick:', user.currentWeekPick);
        console.log(' Current week:', currentWeek);
        console.log(' All week results:', allWeekResults);
        
        if (user.isEliminated) {
            console.log(' RESULT: loser (eliminated)');
            return 'loser'; // Blood red for eliminated players
        }
        
        if (!user.currentWeekPick) {
            console.log(' RESULT: pending (no pick)');
            return 'pending'; // Muted yellow for no pick yet
        }
        
        // Check if current week games have started/completed
        const currentWeekResults = allWeekResults[currentWeek];
        console.log(' Current week results:', currentWeekResults);
        
        if (!currentWeekResults) {
            console.log(' RESULT: pending (no results yet)');
            return 'pending'; // No results yet, games haven't started
        }
        
        // Find if user's current week pick won - using SPECIFIC GAME LOOKUP
        let teamWon = false;
        let gameStarted = false;
        
        // Get user's pick with gameId for current week
        const currentWeekPick = user.allPicks?.[currentWeek];
        console.log(' Current week pick object:', currentWeekPick);
        
        if (currentWeekPick?.gameId && currentWeekResults[currentWeekPick.gameId]) {
            // Use specific game lookup (matches survivorAutoElimination.js pattern)
            const specificGame = currentWeekResults[currentWeekPick.gameId];
            console.log(' Checking SPECIFIC game result:', specificGame);
            console.log(' Winner:', specificGame?.winner);
            console.log(' User pick:', user.currentWeekPick);
            console.log(' Winner matches user pick?', specificGame?.winner === user.currentWeekPick);
            
            if (specificGame && specificGame.winner) {
                gameStarted = true;
                if (specificGame.winner === user.currentWeekPick) {
                    teamWon = true;
                    console.log(' USER WON! User picked:', user.currentWeekPick, 'Winner:', specificGame.winner);
                } else {
                    console.log(' User lost. User picked:', user.currentWeekPick, 'Winner was:', specificGame.winner);
                }
            }
        } else {
            // Backward compatibility: fallback to checking all games
            console.log(' No gameId found, using backward compatibility mode');
            Object.values(currentWeekResults).forEach(gameResult => {
                console.log(' Checking game result:', gameResult);
                console.log(' Winner:', gameResult?.winner);
                console.log(' User pick:', user.currentWeekPick);
                console.log(' Winner matches user pick?', gameResult?.winner === user.currentWeekPick);
                
                if (gameResult && gameResult.winner) {
                    gameStarted = true;
                    if (gameResult.winner === user.currentWeekPick) {
                        teamWon = true;
                        console.log(' USER WON! User picked:', user.currentWeekPick, 'Winner:', gameResult.winner);
                    } else {
                        console.log(' User lost. User picked:', user.currentWeekPick, 'Winner was:', gameResult.winner);
                    }
                }
            });
        }
        
        if (!gameStarted) {
            console.log(' RESULT: pending (game not started)');
            return 'pending'; // Game hasn't started yet
        }
        
        const result = teamWon ? 'winner' : 'loser';
        console.log(' FINAL RESULT:', result);
        return result;
    },
    
    // DIAMOND OPTIMIZATION: Helper method for clean pool selection
    getCurrentPool: function() {
        if (typeof getCurrentPool === 'function') {
            return getCurrentPool();
        }
        
        // Fallback: Check URL params, localStorage, or use default
        if (typeof window !== 'undefined' && window.location) {
            const urlParams = new URLSearchParams(window.location.search);
            const poolParam = urlParams.get('pool');
            
            if (poolParam) {
                return poolParam;
            } else if (typeof localStorage !== 'undefined') {
                return localStorage.getItem('selectedPoolId') || 'nerduniverse-2025';
            } else {
                return 'nerduniverse-2025'; // Browser fallback
            }
        } else {
            // Node.js environment or no window object
            return 'nerduniverse-2025'; // Ultimate fallback
        }
    },
    
    // DIAMOND OPTIMIZATION: Non-blocking elimination processing
    processEliminationsAsync: function(currentWeek, userResults) {
        // Process eliminations in background without blocking UI
        setTimeout(async () => {
            console.log(' Background elimination processing...');
            if (typeof window.SurvivorAutoElimination !== 'undefined' && typeof db !== 'undefined') {
                try {
                    const survivorElimination = new window.SurvivorAutoElimination(db, window.gameStateCache);
                    const eliminationResult = await survivorElimination.checkEliminationsForWeek(currentWeek);
                    
                    if (eliminationResult.eliminatedCount > 0) {
                        console.log(` Background: ${eliminationResult.eliminatedCount} users eliminated! UI will update next reload.`);
                    }
                } catch (elimError) {
                    console.warn('Background elimination processing failed:', elimError);
                }
            }
        }, 100); // Small delay to ensure UI renders first
    },
    
    loadSurvivorResults: async function() {
        this.showLoading();
        const loadStartTime = performance.now();
        
        try {
            // DIAMOND PERFORMANCE: Use ESPN-integrated survivor data
            let loadResult = null;
            
            
            if (window.simpleSurvivorSystem) {
                console.log(' Using simple survivor system (PROVEN WORKING)');
                const currentPool = (typeof getCurrentPool === 'function') ? getCurrentPool() : 'nerduniverse-2025';
                const results = await window.simpleSurvivorSystem.getSurvivorTable(currentPool);
                
                // Simple stats calculation
                const total = results.length;
                const eliminated = results.filter(r => r.status === 'lost' || r.status === 'eliminated').length;
                const alive = total - eliminated;
                
                loadResult = {
                    results,
                    stats: {
                        totalPlayers: total,
                        activePlayers: alive,
                        eliminatedPlayers: eliminated,
                        pendingPlayers: 0
                    },
                    loadTime: performance.now() - loadStartTime,
                    source: 'simple-survivor'
                };
            } else if (window.espnSurvivorIntegration) {
                console.log(' Fallback to ESPN-integrated survivor data');
                const enhancedData = await window.espnSurvivorIntegration.getDisplayData();
                
                loadResult = {
                    results: enhancedData.data,
                    stats: enhancedData.stats,
                    loadTime: enhancedData.loadTimeMs,
                    source: 'espn-integrated'
                };
            } else if (window.unifiedSurvivorManager) {
                console.log(' Fallback to unified survivor manager');
                const displayData = await window.unifiedSurvivorManager.getDisplayData();
                const stats = {
                    totalPlayers: displayData.length,
                    activePlayers: displayData.filter(u => !u.eliminated).length,
                    eliminatedPlayers: displayData.filter(u => u.eliminated).length,
                    pendingPlayers: 0
                };
                loadResult = {
                    results: displayData,
                    stats,
                    loadTime: performance.now() - loadStartTime,
                    source: 'unified'
                };
            } else {
                throw new Error('No survivor loading system available');
            }

            if (!loadResult || !loadResult.results) {
                throw new Error('No survivor data loaded');
            }

            const { results, stats } = loadResult;
            const totalLoadTime = performance.now() - loadStartTime;
            
            console.log(` SURVIVOR LOADED: ${totalLoadTime.toFixed(1)}ms (${loadResult.source})`);
            console.log(` ${stats.totalPlayers} players, ${stats.activePlayers} active, ${stats.eliminatedPlayers} eliminated`);

            // Update summary stats
            allUI.survivorTotalPlayers.textContent = stats.totalPlayers;
            allUI.survivorActivePlayers.textContent = stats.activePlayers;
            allUI.survivorEliminatedPlayers.textContent = stats.eliminatedPlayers;
            allUI.survivorCurrentWeek.textContent = 1; // Current week
            
            // Generate and display table
            let tableHtml;
            if (loadResult.source === 'simple-survivor' && window.simpleSurvivorSystem) {
                tableHtml = window.simpleSurvivorSystem.generateTable(results);
            } else if (loadResult.source === 'unified') {
                tableHtml = this.generateUnifiedTable(results);
            } else {
                tableHtml = this.generateFallbackTable(results);
            }
            
            // Put table into the survivor results container
            if (allUI.survivorResultsContainer) {
                const tableContainer = allUI.survivorResultsContainer.querySelector('.overflow-x-auto') || 
                                     allUI.survivorResultsContainer.querySelector('table')?.parentElement;
                if (tableContainer) {
                    tableContainer.outerHTML = tableHtml;
                } else {
                    allUI.survivorResultsContainer.appendChild(document.createElement('div')).innerHTML = tableHtml;
                }
            }
            
            // Show performance metrics in console
            if (totalLoadTime < 500) {
                console.log(` PERFORMANCE TARGET MET: ${totalLoadTime.toFixed(1)}ms < 500ms`);
            } else {
                console.warn(` Performance target missed: ${totalLoadTime.toFixed(1)}ms > 500ms`);
            }
            
            // Show the results
            this.showResults();

        } catch (error) {
            console.error(' Survivor loading error:', error);
            this.showError(`Failed to load survivor results: ${error.message}`);
        }
    },
    
    // Calculate simple stats for fallback
    calculateSimpleStats: function(results) {
        const stats = {
            totalPlayers: results.length,
            activePlayers: 0,
            eliminatedPlayers: 0,
            pendingPlayers: 0
        };

        results.forEach(result => {
            if (result.status === 'eliminated' || result.status === 'lost' || result.isEliminated) {
                stats.eliminatedPlayers++;
            } else if (result.status === 'survived' || result.status === 'won' || result.status === 'active') {
                stats.activePlayers++;
            } else {
                stats.pendingPlayers++;
            }
        });

        return stats;
    },
    
    // Generate table for unified manager data
    generateUnifiedTable: function(results) {
        if (!results || results.length === 0) {
            return '<p class="text-gray-500 text-center py-8">No users found.</p>';
        }

        const tableRows = results.map(user => {
            const statusClass = user.eliminated ? 
                'bg-red-50 text-red-900' : 'bg-green-50 text-green-900';
            const statusText = user.eliminated ? 'Eliminated' : 'Active';
            const pickText = user.teamPicked || 'No pick';
            
            return `
                <tr class="${statusClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${user.displayName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${pickText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusText}</td>
                </tr>
            `;
        }).join('');

        return `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team Picked</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `;
    },

    // Fallback table generator
    generateFallbackTable: function(results) {
        const tableRows = results.map(user => {
            const statusClass = user.isEliminated || user.status === 'eliminated' || user.status === 'lost' ? 
                'bg-red-50 text-red-900' : 'bg-green-50 text-green-900';
            const statusText = user.isEliminated || user.status === 'eliminated' || user.status === 'lost' ? 
                'Eliminated' : 'Active';
            const pickText = user.currentPick || user.teamPicked || 'No pick';
            
            return `
                <tr class="${statusClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${user.displayName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${pickText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${user.reason || ''}</td>
                </tr>
            `;
        }).join('');

        return `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team Picked</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        `;
    },

    renderCleanResults: function(results) {
        if (results.length === 0) {
            this.showNoResults();
            return;
        }

        // Sort: alive users first, then eliminated
        results.sort((a, b) => {
            if (a.isEliminated !== b.isEliminated) {
                return a.isEliminated ? 1 : -1;
            }
            return a.displayName.localeCompare(b.displayName);
        });

        let html = '';
        
        results.forEach(user => {
            const formatted = window.survivorSystem.formatUserForDisplay(user);
            
            html += `
                <tr class="${formatted.rowClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.displayName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatted.statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatted.currentPick}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatted.reason}
                    </td>
                </tr>
            `;
        });

        allUI.survivorResultsTbody.innerHTML = html;
        allUI.survivorResultsContainer.classList.remove('hidden');
        allUI.survivorNoResults.classList.add('hidden');
    },
    
    renderResults: function(userResults) {
        if (userResults.length === 0) {
            this.showNoResults();
            return;
        }

        const currentWeek = window.currentWeek || 1;
        const activeCount = userResults.filter(u => !u.isEliminated).length;
        const eliminatedCount = userResults.filter(u => u.isEliminated).length;
        
        console.log(` Survivor Stats: Total=${userResults.length}, Active=${activeCount}, Eliminated=${eliminatedCount}`);

        // Update summary stats
        allUI.survivorTotalPlayers.textContent = userResults.length;
        allUI.survivorActivePlayers.textContent = activeCount;
        allUI.survivorEliminatedPlayers.textContent = eliminatedCount;
        allUI.survivorCurrentWeek.textContent = currentWeek;

        // Render table rows
        allUI.survivorResultsTbody.innerHTML = userResults.map((user, index) => {
            // Get row status for background color
            const playerStatus = this.getPlayerRowStatus(user, currentWeek, this.currentWeekResults || {});
            
            // Define background colors based on status
            let rowBgClass = '';
            if (playerStatus === 'pending') {
                rowBgClass = 'bg-yellow-50'; // Muted yellow for pending
            } else if (playerStatus === 'winner') {
                rowBgClass = 'bg-green-200'; // Visible green for winners
            } else if (playerStatus === 'loser') {
                rowBgClass = 'bg-red-50'; // Blood red for losers/eliminated
            }
            
            const rowClass = user.isEliminated ? 'survivor-eliminated' : 'survivor-active';
            const statusBadge = user.isEliminated 
                ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                     <i class="fas fa-skull mr-1"></i> Eliminated
                   </span>`
                : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                     <i class="fas fa-heart mr-1"></i> Active
                   </span>`;

            // Prioritize showing current week pick
            const currentWeekNum = window.currentWeek || 1;
            const hasCurrentWeekPick = user.currentWeekPick;
            
            const pickDisplay = hasCurrentWeekPick 
                ? `${user.currentWeekPick} (Current)` 
                : user.latestPick 
                    ? `${user.latestPick} (Week ${user.latestPickWeek})` 
                    : 'No picks yet';
                    
            const pickWeekDisplay = hasCurrentWeekPick 
                ? `Week ${currentWeekNum}` 
                : user.latestPickWeek 
                    ? `Week ${user.latestPickWeek}` 
                    : '-';
            const eliminatedWeek = user.eliminatedWeek ? `Week ${user.eliminatedWeek}` : '-';
            const weeksSurvived = user.weeksSurvived >= 0 ? user.weeksSurvived : 0;

            return `
                <tr class="${rowClass} ${rowBgClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-left">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8">
                                <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-600">${user.displayName.charAt(0).toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.displayName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                        ${pickDisplay}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ${pickWeekDisplay}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                        ${eliminatedWeek}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="text-sm font-medium text-gray-900">${weeksSurvived}</span>
                    </td>
                </tr>
            `;
        }).join('');

        this.showResults();
    }
};

// Survivor Picks View object
const SurvivorPicksView = {
    show: async function() {
        console.log(' Showing Survivor Picks view');
        hideAllViews();
        allUI.survivorPicksContainer.classList.remove('hidden');
        await this.renderSurvivorPicks();
        updateUrl();
    },
    
    renderSurvivorPicks: async function() {
        const container = allUI.survivorPicksContainer.firstElementChild;
        if (!container) return;
        
        // Show loading
        container.innerHTML = '<div class="text-center py-12"><div class="loader"></div><p class="mt-4 text-slate-600">Loading Survivor Picks...</p></div>';
        
        try {
            // Get current user
            if (!auth.currentUser) {
                container.innerHTML = '<div class="text-center py-12"><p class="text-slate-600">Please log in to access Survivor Pool.</p></div>';
                return;
            }
            
            // Initialize survivor picks functionality
            await this.initializeSurvivorPicksApp(container);
            
        } catch (error) {
            console.error('Error rendering survivor picks:', error);
            container.innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error loading Survivor Picks. Please try again.</p></div>';
        }
    },
    
    initializeSurvivorPicksApp: async function(container) {
        // Initialize survivor-specific variables
        this.currentUser = auth.currentUser;
        
        // Get week from URL params or use current week
        const urlParams = getUrlParams();
        this.selectedWeek = urlParams.week || this.getCurrentNflWeek();
        this.currentWeek = this.getCurrentNflWeek(); // Keep track of actual current week
        this.ADMIN_UID = "WxSPmEildJdqs6T5hIpBUZrscwt2";
        
        // Check if user is eliminated first
        const statusDocRef = doc(db, this.survivorStatusPath());
        const statusSnap = await getDoc(statusDocRef);
        const allStatuses = statusSnap.exists() ? statusSnap.data() : {};
        const myStatus = allStatuses[this.currentUser.uid];
        
        if (myStatus && myStatus.eliminated) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-2xl font-bold text-center text-red-600">You have been eliminated.</h2>
                    <p class="text-center mt-2">You were eliminated in Week ${myStatus.eliminatedWeek}. Better luck next year!</p>
                    <div class="mt-6">
                        <a href="./index.html?view=survivor" class="inline-flex items-center px-6 py-3 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 transition-colors shadow-sm">
                             View Survivor Results
                        </a>
                    </div>
                </div>
            `;
            return;
        }
        
        // Get user's picks
        const picksDocRef = doc(db, this.survivorPicksPath(this.currentUser.uid));
        const picksSnap = await getDoc(picksDocRef);
        const userPicks = picksSnap.exists() ? picksSnap.data() : { picks: {} };
        
        // Get weekly games for selected week
        const weeklyGames = await this.getGamesForWeek(this.selectedWeek);
        if (!weeklyGames || weeklyGames.length === 0) {
            container.innerHTML = `<p class="text-center text-red-600 py-12">Could not load games for Week ${this.selectedWeek}. Please check back later.</p>`;
            return;
        }
        
        // Reuse status data from earlier elimination check
        const currentUserStatus = allStatuses[this.currentUser.uid] || { eliminated: false };
        
        // Check if selected week is locked (eliminated users always locked, others based on game timing)
        const isLocked = currentUserStatus.eliminated || await this.checkSurvivorPickLocked(this.selectedWeek);
        
        // Render the survivor picks interface with week selector
        this.renderSurvivorPicksHTML(container, userPicks, weeklyGames, isLocked);
    },
    
    getCurrentNflWeek: function() {
        const seasonStartDate = new Date('2025-09-04T00:00:00Z');
        const now = new Date();
        if (now < seasonStartDate) return 1;
        const diffTime = Math.abs(now - seasonStartDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const week = Math.ceil(diffDays / 7);
        return week > 18 ? 18 : week;
    },
    
    survivorPicksPath: function(uid) {
        return `artifacts/nerdfootball/public/data/nerdSurvivor_picks/${uid}`;
    },
    
    survivorStatusPath: function(poolId) {
        return `artifacts/nerdfootball/public/data/nerdSurvivor_status/status`;
    },
    
    getGamesForWeek: async function(weekNumber) {
        // Use existing cache system if available
        if (window.gameStateCache) {
            return await window.gameStateCache.cacheSchedule(weekNumber, async () => {
                return await this.fetchWeeklyGames(weekNumber);
            });
        } else {
            return await this.fetchWeeklyGames(weekNumber);
        }
    },
    
    fetchWeeklyGames: async function(weekNumber) {
        try {
            console.log(` Survivor: Fetching schedule for week ${weekNumber}`);
            const response = await fetch(`nfl_2025_week_${weekNumber}.json`);
            if (!response.ok) {
                throw new Error(`Failed to fetch schedule for week ${weekNumber}: ${response.status}`);
            }
            const weekData = await response.json();
            return Array.isArray(weekData.games) ? weekData.games.map(game => ({
                id: game.id,
                away: game.a,
                home: game.h,
                kickoff: game.dt,
                stadium: game.stadium,
                weather: 'TBD',
                startingQBs: {away: 'TBD', home: 'TBD'}
            })) : [];
        } catch (error) {
            console.error(`Error fetching games for week ${weekNumber}:`, error);
            return [];
        }
    },
    
    checkSurvivorPickLocked: async function(weekToCheck = null) {
        try {
            const week = weekToCheck || this.selectedWeek;
            
            // Future weeks are never locked
            if (week > this.currentWeek) {
                return false;
            }
            
            // Past weeks are always locked
            if (week < this.currentWeek) {
                return true;
            }
            
            // For current week, check if any games have started
            const response = await fetch(`nfl_2025_week_${week}.json`);
            if (!response.ok) return false;
            const weekData = await response.json();
            
            if (!weekData.games || !Array.isArray(weekData.games)) return false;
            
            // SECURITY FIX: Use proper game state validation to prevent picks during IN_PROGRESS games
            return weekData.games.some(game => {
                const gameState = this.getGameState(game);
                // Only allow picks when games are PRE_GAME
                return gameState === 'IN_PROGRESS' || gameState === 'COMPLETED';
            });
        } catch (error) {
            console.error('Error checking game lock status:', error);
            return false;
        }
    },
    
    getGameState: function(game) {
        const now = new Date();
        // Handle both raw JSON format (dt) and processed format (kickoff)
        const gameTime = game.kickoff || game.dt;
        const kickoff = new Date(gameTime);
        
        if (now < kickoff) {
            return 'PRE_GAME';
        } else if (game.winner && game.winner !== 'TBD') {
            return 'COMPLETED';
        } else {
            return 'IN_PROGRESS';
        }
    },
    
    getHelmetClass: function(teamName) {
        const teamMap = {
            "Arizona Cardinals": "helmet-ari",
            "Atlanta Falcons": "helmet-atl",
            "Baltimore Ravens": "helmet-bal",
            "Buffalo Bills": "helmet-buf",
            "Carolina Panthers": "helmet-car",
            "Chicago Bears": "helmet-chi",
            "Cincinnati Bengals": "helmet-cin",
            "Cleveland Browns": "helmet-cle",
            "Dallas Cowboys": "helmet-dal",
            "Denver Broncos": "helmet-den",
            "Detroit Lions": "helmet-det",
            "Green Bay Packers": "helmet-gb",
            "Houston Texans": "helmet-hou",
            "Indianapolis Colts": "helmet-ind",
            "Jacksonville Jaguars": "helmet-jax",
            "Kansas City Chiefs": "helmet-kc",
            "Las Vegas Raiders": "helmet-lv",
            "Los Angeles Chargers": "helmet-lac",
            "Los Angeles Rams": "helmet-lar",
            "Miami Dolphins": "helmet-mia",
            "Minnesota Vikings": "helmet-min",
            "New England Patriots": "helmet-ne",
            "New Orleans Saints": "helmet-no",
            "New York Giants": "helmet-nyg",
            "New York Jets": "helmet-nyj",
            "Philadelphia Eagles": "helmet-phi",
            "Pittsburgh Steelers": "helmet-pit",
            "San Francisco 49ers": "helmet-sf",
            "Seattle Seahawks": "helmet-sea",
            "Tampa Bay Buccaneers": "helmet-tb",
            "Tennessee Titans": "helmet-ten",
            "Washington Commanders": "helmet-was"
        };
        return teamMap[teamName] || "";
    },
    
    renderSurvivorPicksHTML: function(container, userPicks, weeklyGames, isLocked) {
        const myPickThisWeek = userPicks.picks[this.selectedWeek];
        
        let html = `<div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Survivor Pool</h2>
                <div class="flex items-center gap-2">
                    <button id="survivor-prev-week" class="px-3 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors ${this.selectedWeek <= 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${this.selectedWeek <= 1 ? 'disabled' : ''}>
                         Prev
                    </button>
                    <div class="px-4 py-2 bg-white border-2 ${this.selectedWeek === this.currentWeek ? 'border-blue-500 bg-blue-50' : 'border-slate-300'} rounded-lg min-w-[100px] text-center">
                        <div class="font-semibold text-lg">Week ${this.selectedWeek}</div>
                        ${this.selectedWeek === this.currentWeek ? '<div class="text-xs text-blue-600">Current Week</div>' : ''}
                    </div>
                    <button id="survivor-next-week" class="px-3 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors ${this.selectedWeek >= 18 ? 'opacity-50 cursor-not-allowed' : ''}" ${this.selectedWeek >= 18 ? 'disabled' : ''}>
                        Next 
                    </button>
                </div>
            </div>`;
            
        if(isLocked) {
             html += `<div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md mb-6" role="alert"><p class="font-bold">Picks are locked for Week ${this.selectedWeek}.</p></div>`;
        }

        // Show current pick if user has made one
        if (myPickThisWeek) {
            const pickedGame = weeklyGames.find(game => 
                game.away === myPickThisWeek.team || game.home === myPickThisWeek.team
            );
            
            if (pickedGame) {
                const opponent = pickedGame.away === myPickThisWeek.team ? pickedGame.home : pickedGame.away;
                const isHome = pickedGame.home === myPickThisWeek.team;
                const gameTime = new Date(pickedGame.kickoff);
                const formattedTime = gameTime.toLocaleString('en-US', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                const helmetClass = this.getHelmetClass(myPickThisWeek.team);
                
                html += `
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-green-800">Your Week ${this.selectedWeek} Pick</h3>
                        </div>
                        <p class="text-xs text-slate-600 italic mb-3">Pick one winner each week. Lose once and you're out.</p>
                        <div class="flex items-center space-x-3">
                            <span class="helmet-icon-lg ${helmetClass}" title="${myPickThisWeek.team}"></span>
                            <div class="flex-1">
                                <p class="text-lg font-bold text-green-700">${myPickThisWeek.team}</p>
                                <p class="text-sm text-slate-600">${formattedTime}  ${isHome ? 'vs' : '@'} ${opponent}</p>
                                <p class="text-xs text-slate-500">${pickedGame.stadium}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        html += `<div class="space-y-6">`;
        weeklyGames.forEach(game => {
            const previouslyPickedTeams = Object.values(userPicks.picks).map(p => p.team);
            const awayTeamPicked = previouslyPickedTeams.includes(game.away);
            const homeTeamPicked = previouslyPickedTeams.includes(game.home);

            const awaySelected = myPickThisWeek && myPickThisWeek.team === game.away;
            const homeSelected = myPickThisWeek && myPickThisWeek.team === game.home;
            
            const gameTime = new Date(game.kickoff);
            const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

            const awayHelmetClass = this.getHelmetClass(game.away);
            const homeHelmetClass = this.getHelmetClass(game.home);
            
            html += `
                <div class="p-4 border border-slate-300 rounded-lg ${ (awayTeamPicked && !awaySelected) || (homeTeamPicked && !homeSelected) ? 'bg-slate-200' : 'bg-white'}">
                     <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                        <div class="md:col-span-8">
                            <div class="flex flex-col sm:flex-row justify-around items-center gap-2">
                                <button data-team="${game.away}" data-game-id="${game.id}" class="team-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 ${awaySelected ? 'selected' : ''} ${awayTeamPicked && !awaySelected ? 'used-team' : ''} flex flex-col items-center space-y-2" ${isLocked || (awayTeamPicked && !awaySelected) ? 'disabled' : ''}>
                                    <span class="helmet-icon-lg ${awayHelmetClass}" title="${game.away}"></span>
                                    <span class="text-sm font-medium">${game.away}</span>
                                    ${awayTeamPicked && !awaySelected ? '<span class="text-xs text-red-600 mt-1">Already Used</span>' : ''}
                                </button>
                                <span class="font-bold text-slate-500">@</span>
                                <button data-team="${game.home}" data-game-id="${game.id}" class="team-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 ${homeSelected ? 'selected' : ''} ${homeTeamPicked && !homeSelected ? 'used-team' : ''} flex flex-col items-center space-y-2" ${isLocked || (homeTeamPicked && !homeSelected) ? 'disabled' : ''}>
                                    <span class="helmet-icon-lg ${homeHelmetClass}" title="${game.home}"></span>
                                    <span class="text-sm font-medium">${game.home}</span>
                                    ${homeTeamPicked && !homeSelected ? '<span class="text-xs text-red-600 mt-1">Already Used</span>' : ''}
                                </button>
                            </div>
                        </div>
                        <div class="md:col-span-4 text-xs text-slate-600 text-center md:text-left">
                             <div><p class="font-bold">Date & Time</p><p>${formattedTime}</p></div>
                             <div><p class="font-bold">Stadium</p><p>${game.stadium}</p></div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        // Show survivor results button  
        html += `
            <div class="mt-6 text-center">
                <a href="./index.html?view=survivor" class="inline-flex items-center px-6 py-3 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 transition-colors shadow-sm">
                     View Survivor Results
                </a>
                <p class="text-sm text-gray-600 mt-2">See who's still alive in the survivor pool</p>
            </div>
        `;
        
        html += `</div>`;
        
        container.innerHTML = html;
        
        // Add event listeners to team buttons
        this.attachSurvivorEventListeners(container, userPicks, isLocked);
    },
    
    attachSurvivorEventListeners: function(container, userPicks, isLocked) {
        // Add previous week button event listener
        const prevButton = document.getElementById('survivor-prev-week');
        if (prevButton) {
            prevButton.addEventListener('click', () => {
                if (this.selectedWeek > 1) {
                    this.selectedWeek--;
                    this.updateWeekAndRerender();
                }
            });
        }
        
        // Add next week button event listener
        const nextButton = document.getElementById('survivor-next-week');
        if (nextButton) {
            nextButton.addEventListener('click', () => {
                if (this.selectedWeek < 18) {
                    this.selectedWeek++;
                    this.updateWeekAndRerender();
                }
            });
        }
        
        container.querySelectorAll('.team-btn').forEach(btn => {
            if (!btn.disabled && !isLocked) {
                btn.addEventListener('click', async (e) => {
                    // Re-check lock status at time of click
                    const currentlyLocked = await this.checkSurvivorPickLocked();
                    if (currentlyLocked) {
                        alert('Sorry, games have started! Survivor picks are now locked for this week.');
                        this.show(); // Re-render to show lock state
                        return;
                    }
                    
                    const team = e.target.dataset.team;
                    const gameId = e.target.dataset.gameId;
                    
                    if (!team) {
                        console.error('Team is undefined - button missing data-team attribute');
                        return;
                    }
                    
                    // CRITICAL SURVIVOR RULE: Check if team was already used in any previous week
                    const previouslyPickedTeams = Object.values(userPicks.picks).map(p => p.team);
                    if (previouslyPickedTeams.includes(team)) {
                        alert(` SURVIVOR RULE VIOLATION: You already used ${team} in a previous week. You can only use each team once per season.`);
                        return;
                    }
                    
                    const newPick = {
                        team: team,
                        gameId: gameId,
                    };
                    userPicks.picks[this.selectedWeek] = newPick;
                    
                    // Store last survivor pick timestamp
                    localStorage.setItem('lastSurvivorPick', new Date().toISOString());
                    
                    // Update both documents in parallel
                    const picksDocRef = doc(db, this.survivorPicksPath(this.currentUser.uid));
                    const statusDocRef = doc(db, this.survivorStatusPath());
                    
                    const statusUpdate = {};
                    statusUpdate[`${this.currentUser.uid}.currentWeekPick`] = team;
                    statusUpdate[`${this.currentUser.uid}.currentWeekPickDetails`] = newPick;
                    statusUpdate[`${this.currentUser.uid}.lastUpdated`] = new Date().toISOString();
                    
                    await Promise.all([
                        setDoc(picksDocRef, userPicks, { merge: true }),
                        setDoc(statusDocRef, statusUpdate, { merge: true })
                    ]);
                    
                    //  CRITICAL: Invalidate all cache affected by survivor picks changes
                    window.gameStateCache.invalidateAfterDataUpdate('survivor_picks_saved', this.selectedWeek);
                    
                    this.show(); // Re-render to show selection
                });
            }
        });
    },
    
    updateWeekAndRerender: function() {
        // Update global currentWeek to keep in sync
        currentWeek = this.selectedWeek;
        
        // Use the enhanced updateUrl function for breadcrumb navigation
        updateUrl(true); // Breadcrumb navigation - add to browser history
        
        // Re-render with new week
        this.show();
    }
};

// Initialize Survivor View event listeners
allUI.survivorRetryBtn.addEventListener('click', () => SurvivorView.loadSurvivorResults());

// Add Survivor Picks View button event listener
if (allUI.survivorPicksViewBtn) {
    allUI.survivorPicksViewBtn.addEventListener('click', () => {
        allUI.picksContainer.classList.add('hidden');
        allUI.picksSummaryContainer.classList.add('hidden');
        allUI.adminContainer.classList.add('hidden');
        allUI.leaderboardContainer.classList.add('hidden');
        allUI.gridContainer.classList.add('hidden');
        allUI.survivorContainer.classList.add('hidden');
        allUI.survivorPicksContainer.classList.remove('hidden');
        document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
        allUI.survivorPicksViewBtn.classList.add('active');
        SurvivorPicksView.show();
        allUI.menuPanel.classList.add('hidden');
        saveAppState();
    });
}

// ESPN API Admin Integration
function initializeEspnApiAdmin() {
    // ESPN API Status and functionality
    const espnElements = {
        refreshStatusBtn: document.getElementById('espn-refresh-status-btn'),
        apiStatusIndicator: document.getElementById('espn-api-status-indicator'),
        apiStatusText: document.getElementById('espn-api-status-text'),
        currentWeek: document.getElementById('espn-current-week'),
        rateLimit: document.getElementById('espn-rate-limit'),
        cacheCount: document.getElementById('espn-cache-count'),
        testCurrentWeekBtn: document.getElementById('espn-test-current-week'),
        testTeamsBtn: document.getElementById('espn-test-teams'),
        clearCacheBtn: document.getElementById('espn-clear-cache'),
        fetchSeasonBtn: document.getElementById('espn-fetch-season'),
        testsStatus: document.getElementById('espn-tests-status'),
        testResults: document.getElementById('espn-test-results'),
        clearLogsBtn: document.getElementById('espn-clear-logs'),
        activityLogs: document.getElementById('espn-activity-logs')
    };

    let espnLogs = [];

    // ESPN API logging function
    function logEspnActivity(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = { timestamp, message, type };
        espnLogs.push(logEntry);
        
        if (espnLogs.length > 100) {
            espnLogs = espnLogs.slice(-100);
        }
        
        updateEspnLogsDisplay();
    }

    function updateEspnLogsDisplay() {
        if (!espnElements.activityLogs) return;
        
        const logsHtml = espnLogs.map(log => {
            const colorClass = log.type === 'error' ? 'text-red-600' : 
                             log.type === 'success' ? 'text-green-600' : 
                             'text-slate-800';
            return `<div class="${colorClass}">[${log.timestamp}] ${log.message}</div>`;
        }).join('');
        
        espnElements.activityLogs.innerHTML = logsHtml || '<div class="text-slate-500">No logs yet...</div>';
        espnElements.activityLogs.scrollTop = espnElements.activityLogs.scrollHeight;
    }

    // Update ESPN API status
    async function updateEspnApiStatus() {
        try {
            logEspnActivity('Checking ESPN API status...');
            
            const status = await window.espnApi.getApiStatus();
            
            if (status.success && status.status === 'online') {
                espnElements.apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                espnElements.apiStatusText.textContent = 'Online';
                logEspnActivity('ESPN API is online', 'success');
            } else {
                espnElements.apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                espnElements.apiStatusText.textContent = 'Offline';
                logEspnActivity('ESPN API is offline', 'error');
            }
            
            espnElements.currentWeek.textContent = status.currentWeek || window.currentWeek || 1;
            espnElements.rateLimit.textContent = status.rateLimitRemaining ? `${status.rateLimitRemaining} remaining` : 'Unknown';
            
            const cacheStats = window.espnApi.getCacheStats();
            espnElements.cacheCount.textContent = cacheStats.totalEntries;
            
        } catch (error) {
            logEspnActivity('Failed to update ESPN API status: ' + error.message, 'error');
            espnElements.apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
            espnElements.apiStatusText.textContent = 'Error';
        }
    }

    // Display ESPN test results
    function displayEspnTestResults(tests) {
        if (!espnElements.testResults) return;
        
        const resultsHtml = tests.map(test => {
            const statusClass = test.success ? 'text-green-600' : 'text-red-600';
            const statusIcon = test.success ? '' : '';
            
            return `
                <div class="flex items-center justify-between p-2 border border-slate-200 rounded">
                    <div>
                        <span class="${statusClass} font-medium">${statusIcon} ${test.name}</span>
                        ${test.error ? `<div class="text-xs text-red-600 mt-1">${test.error}</div>` : ''}
                        ${test.data && test.name === 'Current Week Games' ? 
                            `<div class="text-xs text-slate-500 mt-1">Week ${test.data.week}: ${test.data.gameCount} games</div>` : ''}
                        ${test.data && test.name === 'NFL Teams' ? 
                            `<div class="text-xs text-slate-500 mt-1">${test.data.teamCount} teams loaded</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        espnElements.testResults.innerHTML = resultsHtml;
    }

    // Event listeners
    if (espnElements.refreshStatusBtn) {
        espnElements.refreshStatusBtn.addEventListener('click', updateEspnApiStatus);
    }

    if (espnElements.testCurrentWeekBtn) {
        espnElements.testCurrentWeekBtn.addEventListener('click', async () => {
            espnElements.testsStatus.textContent = 'Running...';
            espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
            
            try {
                logEspnActivity('Testing current week games...');
                const games = await window.espnApi.getCurrentWeekGames(true);
                logEspnActivity(`Current week test successful: ${games.length} games loaded`, 'success');
                
                displayEspnTestResults([{
                    name: 'Current Week Games',
                    success: true,
                    data: { week: window.currentWeek || 1, gameCount: games.length }
                }]);
                
                espnElements.testsStatus.textContent = 'Passed';
                espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
                
            } catch (error) {
                logEspnActivity('Current week test failed: ' + error.message, 'error');
                displayEspnTestResults([{
                    name: 'Current Week Games',
                    success: false,
                    error: error.message
                }]);
                
                espnElements.testsStatus.textContent = 'Failed';
                espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
            }
        });
    }

    if (espnElements.testTeamsBtn) {
        espnElements.testTeamsBtn.addEventListener('click', async () => {
            espnElements.testsStatus.textContent = 'Running...';
            espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
            
            try {
                logEspnActivity('Testing NFL teams...');
                const teams = await window.espnApi.getNflTeams(true);
                logEspnActivity(`Teams test successful: ${teams.length} teams loaded`, 'success');
                
                displayEspnTestResults([{
                    name: 'NFL Teams',
                    success: true,
                    data: { teamCount: teams.length }
                }]);
                
                espnElements.testsStatus.textContent = 'Passed';
                espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
                
            } catch (error) {
                logEspnActivity('Teams test failed: ' + error.message, 'error');
                displayEspnTestResults([{
                    name: 'NFL Teams',
                    success: false,
                    error: error.message
                }]);
                
                espnElements.testsStatus.textContent = 'Failed';
                espnElements.testsStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
            }
        });
    }

    if (espnElements.clearCacheBtn) {
        espnElements.clearCacheBtn.addEventListener('click', () => {
            const entriesCleared = window.espnApi.getCacheStats().totalEntries;
            window.espnApi.invalidateCache();
            logEspnActivity(`Cleared ${entriesCleared} ESPN API cache entries`, 'success');
            updateEspnApiStatus();
        });
    }

    if (espnElements.fetchSeasonBtn) {
        espnElements.fetchSeasonBtn.addEventListener('click', async () => {
            if (!confirm('This will fetch the complete NFL season schedule from ESPN. This is a heavy operation and should only be done by administrators. Continue?')) {
                return;
            }
            
            espnElements.fetchSeasonBtn.disabled = true;
            espnElements.fetchSeasonBtn.textContent = 'Fetching...';
            
            try {
                logEspnActivity('Starting full season schedule fetch (Admin operation)...');
                const result = await window.espnApi.fetchSeasonSchedule();
                logEspnActivity(`Season schedule fetch complete: ${result.gamesCount} games fetched`, 'success');
                
                espnElements.fetchSeasonBtn.textContent = 'Fetch Complete!';
                setTimeout(() => {
                    espnElements.fetchSeasonBtn.textContent = 'Fetch Full Season';
                    espnElements.fetchSeasonBtn.disabled = false;
                }, 3000);
                
            } catch (error) {
                logEspnActivity('Season schedule fetch failed: ' + error.message, 'error');
                espnElements.fetchSeasonBtn.textContent = 'Fetch Failed';
                setTimeout(() => {
                    espnElements.fetchSeasonBtn.textContent = 'Fetch Full Season';
                    espnElements.fetchSeasonBtn.disabled = false;
                }, 3000);
            }
        });
    }

    if (espnElements.clearLogsBtn) {
        espnElements.clearLogsBtn.addEventListener('click', () => {
            espnLogs = [];
            updateEspnLogsDisplay();
        });
    }

    // Initialize ESPN API status when admin tab is accessed
    const espnApiTab = document.getElementById('tab-espn-api');
    if (espnApiTab) {
        espnApiTab.addEventListener('click', () => {
            setTimeout(updateEspnApiStatus, 100); // Small delay to ensure UI is ready
        });
    }

    logEspnActivity('ESPN API Admin interface initialized');
}

// DIAMOND LEVEL: Cache Management Functions
function initializeCacheManagement() {
    console.log(' Initializing cache management interface');
    bindCacheEventListeners();
    updateCacheStatus();
    setInterval(updateCacheStatus, 30000);
}

function bindCacheEventListeners() {
    // Performance test buttons
    const coldTestBtn = document.getElementById('cache-test-cold-btn');
    if (coldTestBtn) {
        coldTestBtn.addEventListener('click', async () => {
            const resultEl = document.getElementById('cache-cold-result');
            resultEl.textContent = 'Testing...';
            
            const currentPool = (typeof getCurrentPool === 'function') ? getCurrentPool() : 'nerduniverse-2025';
            const loadTime = await window.optimizedSurvivorLoader.testColdLoad(currentPool);
            
            const passed = loadTime < 500;
            resultEl.textContent = `${loadTime.toFixed(0)}ms ${passed ? ' PASS' : ' FAIL'}`;
            resultEl.className = passed ? 'text-sm text-green-600' : 'text-sm text-red-600';
        });
    }
    
    const warmTestBtn = document.getElementById('cache-test-warm-btn');
    if (warmTestBtn) {
        warmTestBtn.addEventListener('click', async () => {
            const resultEl = document.getElementById('cache-warm-result');
            resultEl.textContent = 'Testing...';
            
            const currentPool = (typeof getCurrentPool === 'function') ? getCurrentPool() : 'nerduniverse-2025';
            const loadTime = await window.optimizedSurvivorLoader.testWarmLoad(currentPool);
            
            const passed = loadTime < 500;
            resultEl.textContent = `${loadTime.toFixed(0)}ms ${passed ? ' PASS' : ' FAIL'}`;
            resultEl.className = passed ? 'text-sm text-green-600' : 'text-sm text-red-600';
        });
    }
    
    const warmBtn = document.getElementById('cache-warm-btn');
    if (warmBtn) {
        warmBtn.addEventListener('click', async () => {
            await warmCache();
        });
    }
    
    const invalidateBtn = document.getElementById('cache-invalidate-btn');
    if (invalidateBtn) {
        invalidateBtn.addEventListener('click', async () => {
            await invalidateCache();
        });
    }
    
    const refreshBtn = document.getElementById('cache-refresh-all-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            await refreshAllCaches();
        });
    }
    
    const refreshStatsBtn = document.getElementById('cache-refresh-stats-btn');
    if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener('click', () => {
            updateCacheStatus();
        });
    }
    
    const clearBtn = document.getElementById('cache-clear-all-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear all survivor caches? This will temporarily slow down survivor page loads.')) {
                await clearAllCaches();
            }
        });
    }
}

async function performanceTestCache() {
    console.log(' Starting performance test');
    const testOutput = document.getElementById('cache-test-output');
    const testResults = document.getElementById('cache-test-results');
    
    if (!testOutput || !testResults) return;
    
    testResults.classList.remove('hidden');
    testOutput.innerHTML = 'Starting performance test...\n';
    
    try {
        const tests = [];
        
        if (window.optimizedSurvivorLoader) {
            await window.optimizedSurvivorLoader.refreshResults();
            const coldStart = performance.now();
            const coldResult = await window.optimizedSurvivorLoader.loadSurvivorResults('nerduniverse-2025', true);
            const coldTime = performance.now() - coldStart;
            
            tests.push({
                name: 'Cold Load',
                time: coldTime,
                result: coldResult.source
            });
            
            testOutput.innerHTML += `Cold load: ${coldTime.toFixed(1)}ms (${coldResult.source})\n`;
            
            const warmStart = performance.now();
            const warmResult = await window.optimizedSurvivorLoader.loadSurvivorResults();
            const warmTime = performance.now() - warmStart;
            
            tests.push({
                name: 'Warm Load',
                time: warmTime,
                result: warmResult.source
            });
            
            testOutput.innerHTML += `Warm load: ${warmTime.toFixed(1)}ms (${warmResult.source})\n`;
        }
        
        testOutput.innerHTML += '\n=== PERFORMANCE SUMMARY ===\n';
        tests.forEach(test => {
            const status = test.time < 500 ? ' PASS' : ' FAIL';
            testOutput.innerHTML += `${test.name}: ${test.time.toFixed(1)}ms (${test.result}) ${status}\n`;
        });
        
        updateCacheMetrics({
            lastLoadTime: Math.min(...tests.map(t => t.time)),
            cacheHitRate: tests.filter(t => t.result === 'cache').length / tests.length * 100,
            targetMet: Math.max(...tests.map(t => t.time)) < 500
        });
        
    } catch (error) {
        console.error(' Performance test error:', error);
        testOutput.innerHTML += `\nERROR: ${error.message}\n`;
    }
}

async function warmCache() {
    console.log(' Warming cache');
    try {
        const currentPool = (typeof getCurrentPool === 'function') ? getCurrentPool() : 'nerduniverse-2025';
        const currentWeek = 1; // Or get from week manager
        
        if (window.survivorCacheManager) {
            await window.survivorCacheManager.warmCache(currentPool, currentWeek);
        }
        updateCacheStatusIndicator('current');
        console.log(' Cache warmed successfully!');
        updateCacheStatus();
    } catch (error) {
        console.error(' Cache warming error:', error);
        updateCacheStatusIndicator('outdated');
        console.error(`Cache warming failed: ${error.message}`);
    }
}

async function invalidateCache() {
    console.log(' Invalidating cache');
    try {
        const currentPool = (typeof getCurrentPool === 'function') ? getCurrentPool() : 'nerduniverse-2025';
        const currentWeek = 1; // Or get from week manager
        
        if (window.survivorCacheManager) {
            await window.survivorCacheManager.invalidateCache(currentPool, currentWeek);
        }
        // No more alert - just update the visual indicator
        updateCacheStatusIndicator('refreshing');
        setTimeout(() => updateCacheStatusIndicator('current'), 2000);
        updateCacheStatus();
    } catch (error) {
        console.error(' Cache invalidation error:', error);
        updateCacheStatusIndicator('outdated');
        console.error(`Cache invalidation failed: ${error.message}`);
    }
}

async function refreshAllCaches() {
    console.log(' Refreshing all caches');
    try {
        if (window.optimizedSurvivorLoader) {
            await window.optimizedSurvivorLoader.refreshResults();
        }
        updateCacheStatusIndicator('current');
        console.log(' All caches refreshed successfully!');
        updateCacheStatus();
    } catch (error) {
        console.error(' Cache refresh error:', error);
        updateCacheStatusIndicator('outdated');
        console.error(`Cache refresh failed: ${error.message}`);
    }
}

async function clearAllCaches() {
    console.log(' Clearing all caches');
    try {
        if (window.db) {
            const cacheQuery = await window.db.collectionGroup('results').get();
            const batch = window.db.batch();
            
            cacheQuery.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            updateCacheStatusIndicator('current');
            console.log(` Cleared ${cacheQuery.size} cache entries!`);
        }
        updateCacheStatus();
    } catch (error) {
        console.error(' Cache clearing error:', error);
        updateCacheStatusIndicator('outdated');
        console.error(`Cache clearing failed: ${error.message}`);
    }
}

function updateCacheStatus() {
    if (window.optimizedSurvivorLoader) {
        const metrics = window.optimizedSurvivorLoader.getPerformanceReport();
        updateCacheMetrics(metrics);
    }
    // loadCacheStatusTable(); // Comment out for now as not implemented
}

function updateCacheMetrics(metrics) {
    const elements = {
        lastLoadTime: document.getElementById('cache-last-load-time'),
        hitRate: document.getElementById('cache-hit-rate'),
        targetMet: document.getElementById('cache-target-met'),
        activeCount: document.getElementById('cache-active-count')
    };
    
    if (elements.lastLoadTime && metrics.averageLoadTime) {
        elements.lastLoadTime.textContent = metrics.averageLoadTime;
        const loadTimeMs = parseFloat(metrics.averageLoadTime);
        elements.lastLoadTime.className = loadTimeMs < 500 ? 
            'text-lg font-semibold text-green-600' : 'text-lg font-semibold text-red-600';
    }
    
    if (elements.hitRate && metrics.cacheHitRate) {
        elements.hitRate.textContent = metrics.cacheHitRate;
    }
    
    if (elements.targetMet && metrics.targetMetRate) {
        elements.targetMet.textContent = metrics.targetMetRate;
        const metRate = parseFloat(metrics.targetMetRate);
        elements.targetMet.className = metRate >= 80 ? 
            'text-lg font-semibold text-green-600' : 'text-lg font-semibold text-yellow-600';
    }
    
    if (elements.activeCount && metrics.totalLoads !== undefined) {
        elements.activeCount.textContent = metrics.totalLoads.toString();
    }
}

async function loadCacheStatusTable() {
    const tbody = document.getElementById('cache-status-tbody');
    if (!tbody || !window.db) return;
    
    try {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">Loading cache status...</td></tr>';
        
        const cacheQuery = await window.db.collectionGroup('results').get();
        
        if (cacheQuery.empty) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No active caches found</td></tr>';
            return;
        }
        
        const cacheRows = cacheQuery.docs.map(doc => {
            const data = doc.data();
            const path = doc.ref.path;
            const pathParts = path.split('/');
            const poolId = pathParts[1];
            const week = pathParts[3];
            
            const generatedTime = data.generatedAt ? 
                new Date(data.generatedAt.toMillis ? data.generatedAt.toMillis() : data.generatedAt).toLocaleString() : 'Unknown';
            
            const loadTime = data.metadata?.computationTimeMs ? `${data.metadata.computationTimeMs.toFixed(1)}ms` : 'Unknown';
            const size = data.results ? `${Object.keys(data.results).length} users` : 'Unknown';
            
            const isStale = data.generatedAt && 
                (new Date().getTime() - (data.generatedAt.toMillis ? data.generatedAt.toMillis() : data.generatedAt)) > 10 * 60 * 1000;
            
            const statusClass = isStale ? 'text-orange-600' : 'text-green-600';
            const statusText = isStale ? 'Stale' : 'Fresh';
            
            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${poolId}/${week}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${generatedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${size}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${loadTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                        <button onclick="deleteSingleCache('${path}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = cacheRows;
        
        const countEl = document.getElementById('cache-count');
        if (countEl) {
            countEl.textContent = cacheQuery.size.toString();
        }
        
    } catch (error) {
        console.error(' Cache status loading error:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading cache status</td></tr>';
    }
}

async function deleteSingleCache(cachePath) {
    if (!confirm('Delete this cache entry?')) return;
    
    try {
        if (window.db) {
            await window.db.doc(cachePath).delete();
            console.log(` Deleted cache: ${cachePath}`);
            await loadCacheStatusTable();
        }
    } catch (error) {
        console.error(' Cache deletion error:', error);
        updateCacheStatusIndicator('outdated');
        console.error(`Failed to delete cache: ${error.message}`);
    }
}

 console.log(' About to call initializeAppAndAuth');
initializeAppAndAuth().then(() => {
    // Wait a moment to ensure all Firebase globals are set
    setTimeout(() => {
        // Initialize ESPN API client
        if (typeof EspnNerdApiClient !== 'undefined') {
            window.espnApi = new EspnNerdApiClient();
            console.log(' ESPN API client initialized');
            
            // Initialize ESPN API admin functionality (moved inside setTimeout)
            setTimeout(() => {
                if (typeof window.espnApi !== 'undefined') {
                    initializeEspnApiAdmin();
                } else {
                    console.warn('ESPN API client not loaded');
                }
            }, 200);
            
            // Initialize ESPN Score Sync system (moved inside setTimeout with more delay)
            setTimeout(() => {
                if (typeof EspnScoreSync !== 'undefined' && window.espnApi && window.gameStateCache) {
                    window.espnScoreSync = new EspnScoreSync(
                        db, // Pass the Firestore database directly
                        window.espnApi,
                        window.gameStateCache
                    );
                    window.espnScoreSync.initialize();
                    console.log(' ESPN Score Sync system initialized');
                }
            }, 300);
        }
    }, 100);
});

// User Diagnostics Function
function showUserDiagnostics() {
    const user = firebase.auth().currentUser;
    const diagnostics = {
        'User Info': {
            'UID': user?.uid || 'Not authenticated',
            'Email': user?.email || 'No email',
            'Display Name': user?.displayName || 'No display name',
            'Email Verified': user?.emailVerified || false
        },
        'Browser Info': {
            'User Agent': navigator.userAgent.substring(0, 100) + '...',
            'Platform': navigator.platform,
            'Language': navigator.language,
            'Online': navigator.onLine,
            'Cookies Enabled': navigator.cookieEnabled
        },
        'Firebase Status': {
            'Firestore': typeof window.db !== 'undefined' ? ' Available' : ' Not available',
            'Functions': typeof window.functions !== 'undefined' ? ' Available' : ' Not available',
            'RTDB': typeof window.rtdb !== 'undefined' ? ' Available' : ' Not available',
            'Auth': firebase.auth().currentUser ? ' Authenticated' : ' Not authenticated'
        },
        'App State': {
            'Current Week': window.currentWeek || 'Not set',
            'Active View': document.querySelector('.view-toggle-btn.active')?.textContent || 'Unknown',
            'Local Storage Keys': Object.keys(localStorage).length,
            'Session Storage Keys': Object.keys(sessionStorage).length
        }
    };
    
    let output = ' USER DIAGNOSTICS\n\n';
    for (const [category, data] of Object.entries(diagnostics)) {
        output += ` ${category}:\n`;
        for (const [key, value] of Object.entries(data)) {
            output += `   ${key}: ${value}\n`;
        }
        output += '\n';
    }
    
    console.log(output);
    alert('User diagnostics logged to console (F12  Console tab)');
}

 });
 </script>
</body>
</html>
