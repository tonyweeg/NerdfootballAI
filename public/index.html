<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>NerdfootballAI v2.0</title>
 
 <!-- iOS Web App Meta Tags -->
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <meta name="apple-mobile-web-app-title" content="NerdFootball">
 
 <!-- App Icons for iOS Home Screen -->
 <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 <link rel="apple-touch-icon" sizes="152x152" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 <link rel="apple-touch-icon" sizes="180x180" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 
 <!-- Standard Favicon -->
 <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e">
 
 <!-- Web App Manifest -->
 <link rel="manifest" href="/manifest.json">
 <meta name="theme-color" content="#334155">
 <meta name="description" content="NerdFootball AI - NFL Pick'em Game with Confidence Points">
 
 <!-- Cache Control -->
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
 <meta http-equiv="Pragma" content="no-cache">
 <meta http-equiv="Expires" content="0">
 <meta name="version" content="2.1.0">
 
 <script src="https://cdn.tailwindcss.com"></script>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 <style>
 body {
 font-family: 'Inter', sans-serif;
 }
 .winner-btn.selected, .result-btn.selected {
 background-color: #334155; /* slate-700 */
 color: white;
 border-color: #1e293b; /* slate-800 */
 }
 .winner-btn:disabled, .result-btn:disabled, #reset-picks-btn:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #D1D5DB;
 }
 select:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #f3f4f6;
 }
 .view-toggle-btn.active {
 background-color: #475569; /* slate-600 */
 color: white;
 }
 .admin-tab {
 background-color: #f8fafc; /* slate-50 */
 border: 2px solid #e2e8f0; /* slate-200 */
 border-radius: 0.5rem; /* rounded-lg */
 padding: 0.75rem 1.5rem; /* py-3 px-6 */
 font-weight: 600; /* font-semibold */
 color: #475569; /* slate-600 */
 transition: all 0.2s ease-in-out;
 box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
 cursor: pointer;
 }
 .admin-tab:hover {
 background-color: #f1f5f9; /* slate-100 */
 border-color: #cbd5e1; /* slate-300 */
 color: #334155; /* slate-700 */
 box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* shadow-md */
 transform: translateY(-1px);
 }
 .admin-tab.active {
 background-color: #475569; /* slate-600 */
 border-color: #475569; /* slate-600 */
 color: white;
 box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* shadow-md */
 }
 .admin-tab.active:hover {
 background-color: #334155; /* slate-700 */
 border-color: #334155; /* slate-700 */
 }
 .form-input {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 border: 1px solid #9ca3af; /* gray-400 */
 background-color: #f8fafc; /* slate-50 */
 }
 .form-btn {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 font-weight: 600;
 color: white;
 background-image: linear-gradient(to bottom, #64748b, #334155);
 border: 1px solid #1e293b;
 box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
 }
 .form-btn:hover {
 background-image: linear-gradient(to bottom, #475569, #1e293b);
 }
 .loader {
 border: 4px solid #f3f3f3;
 border-top: 4px solid #64748b; /* slate-500 */
 border-radius: 50%;
 width: 40px;
 height: 40px;
 animation: spin 1s linear infinite;
 margin: 20px auto;
 }
 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
 #save-status-icon svg {
 animation: spin 1s linear infinite;
 }
  #settings-modal {
    background-color: rgba(0, 0, 0, 0.5);
  }
  .public-leaderboard-table tr:nth-child(even) {
    background-color: #f8fafc; /* slate-50 */
  }
  .public-leaderboard-table tr:hover {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
  .public-leaderboard-table tr:hover td {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
 </style>
</head>
<body class="bg-slate-200 text-slate-800">

 <!-- Loading View -->
 <div id="loading-view" class="min-h-screen flex items-center justify-center p-4">
  <div class="text-center">
   <div class="loader mb-4"></div>
   <p class="text-slate-600">Loading NerdfootballAI...</p>
  </div>
 </div>

 <!-- Login & Register View -->
 <div id="login-view" class="min-h-screen flex items-center justify-center p-4 hidden">
 <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-sm w-full mx-auto border border-slate-300">
 
 <!-- Login Form -->
 <form id="login-form">
 <h1 class="text-3xl font-bold text-center mb-1 text-slate-800">NerdfootballAI</h1>
 <p class="text-center text-slate-500 text-sm mb-2 italic">The Coolest online football pool in the Universe</p>
 <p class="text-center text-slate-600 mb-4">Welcome back, Nerds</p>
 <div class="text-center mb-6">
  <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdFootball Nerd" class="w-64 h-64 mx-auto">
 </div>
 <div id="login-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="login-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="login-password" type="password" placeholder="Password" required class="form-input">
 </div>
 <button id="login-btn" type="submit" class="form-btn mt-6">Sign In</button>
 
 <div class="relative mt-6">
 <div class="absolute inset-0 flex items-center">
 <div class="w-full border-t border-gray-300"></div>
 </div>
 <div class="relative flex justify-center text-sm">
 <span class="px-2 bg-slate-100 text-gray-500">Or continue with</span>
 </div>
 </div>

 <button id="google-signin-btn" type="button" class="w-full mt-4 px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors flex items-center justify-center gap-3">
 <svg class="w-5 h-5" viewBox="0 0 24 24">
 <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
 <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
 <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
 <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
 </svg>
 Continue with Google
 </button>

 <p class="text-center mt-4 text-sm">
 Don't have an account? <a href="#" id="show-register-link" class="font-medium text-slate-600 hover:text-slate-800">Register</a>
 </p>
 </form>

 <!-- Registration Form -->
 <form id="register-form" class="hidden">
 <h1 class="text-3xl font-bold text-center mb-1">Create Account</h1>
 <p class="text-center text-slate-500 text-sm mb-2 italic">The Coolest online football pool in the Universe</p>
 <p class="text-center text-slate-600 mb-4">Get started with NerdfootballAI.</p>
 <div class="text-center mb-6">
  <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdFootball Nerd" class="w-64 h-64 mx-auto">
 </div>
 <div id="register-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="register-firstname" type="text" placeholder="First Name" required class="form-input">
 <input id="register-lastname" type="text" placeholder="Last Name" required class="form-input">
 <input id="register-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="register-password" type="password" placeholder="Password" required class="form-input">
 <input id="register-confirm-password" type="password" placeholder="Confirm Password" required class="form-input">
 </div>
 <button id="register-btn" type="submit" class="form-btn mt-6">Create Account</button>
 
 <div class="relative mt-6">
 <div class="absolute inset-0 flex items-center">
 <div class="w-full border-t border-gray-300"></div>
 </div>
 <div class="relative flex justify-center text-sm">
 <span class="px-2 bg-slate-100 text-gray-500">Or continue with</span>
 </div>
 </div>

 <button id="google-signup-btn" type="button" class="w-full mt-4 px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors flex items-center justify-center gap-3">
 <svg class="w-5 h-5" viewBox="0 0 24 24">
 <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
 <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
 <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
 <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
 </svg>
 Continue with Google
 </button>

 <p class="text-center mt-4 text-sm">
 Already have an account? <a href="#" id="show-login-link" class="font-medium text-slate-600 hover:text-slate-800">Sign In</a>
 </p>
 </form>
 </div>
 </div>

<!-- Account Linking Confirmation Dialog -->
<div id="account-linking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
 <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
 <div class="mt-3 text-center">
 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
 <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
 </svg>
 </div>
 <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Link Your Accounts</h3>
 <div class="mt-2 px-7 py-3">
 <p class="text-sm text-gray-500">
 We found an existing account with this email address (<span id="linking-email" class="font-medium"></span>).
 Would you like to link your Google account to your existing account?
 </p>
 <p class="text-xs text-gray-400 mt-2">
 After linking, you can use either method to sign in, but Google will be your preferred method.
 </p>
 </div>
 <div class="flex gap-3 px-4 py-3">
 <button id="cancel-linking-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
 Cancel
 </button>
 <button id="confirm-linking-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
 Link Accounts
 </button>
 </div>
 </div>
 </div>
</div>

<!-- Password Prompt for Account Linking -->
<div id="password-linking-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
 <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
 <div class="mt-3">
 <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
 <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
 </svg>
 </div>
 <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4 text-center">Confirm Your Password</h3>
 <div class="mt-2 px-7 py-3">
 <p class="text-sm text-gray-500 text-center mb-4">
 Please enter your password for <span id="password-prompt-email" class="font-medium"></span> to link your Google account.
 </p>
 <div id="password-prompt-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <input id="password-prompt-input" type="password" placeholder="Password" required class="form-input mb-4">
 </div>
 <div class="flex gap-3 px-4 py-3">
 <button id="cancel-password-prompt-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
 Cancel
 </button>
 <button id="confirm-password-prompt-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
 Confirm & Link
 </button>
 </div>
 </div>
 </div>
</div>

 <!-- Main App Container -->
 <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
 <header class="mb-6">
 <div class="flex justify-between items-center flex-wrap gap-4">
 <!-- Logo and title - left aligned -->
 <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity cursor-pointer">
 <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdfootballAI Logo" class="h-8 md:h-10 w-auto">
 <h1 class="text-3xl md:text-4xl font-bold text-slate-800">NerdfootballAI</h1>
 </a>
 <!-- Right side elements -->
 <div class="flex items-center space-x-4">
 <span class="text-sm font-medium text-slate-600">v2.0</span>
 <div class="flex items-center space-x-2 relative">
    <span id="user-display" class="text-sm font-medium text-slate-700"></span>
    <button id="menu-btn" class="p-2 rounded-md hover:bg-slate-200">
        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    <div id="menu-panel" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5">
        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
            <div id="menu-admin-controls" class="hidden">
                 <button id="menu-picks-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn active" role="menuitem">My Picks</button>
                 <button id="menu-admin-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem">Admin</button>
                 <button id="survivor-admin-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Survivor Admin</button>
                 <div class="border-t border-gray-200 my-1"></div>
            </div>
            <button id="leaderboard-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem">Leaderboard</button>
            <a href="./nerdSurvivor.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Nerd Survivor</a>
            <a href="./nerdfootballTheGrid.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">The Grid</a>
            <button id="settings-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Settings</button>
            <button id="logout-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Logout</button>
        </div>
    </div>
 </div>
 </div>
 </div>
 </header>

 <!-- Active Picks Summary Section -->
 <div id="picks-summary-container" class="hidden mb-4">
  <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
   <!-- Current Active Picks -->
   <div id="active-picks-section" class="mb-4">
    <h3 class="text-lg font-semibold text-slate-700 mb-3">Your Active Picks</h3>
    <div id="active-picks-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2">
     <!-- Active picks will be rendered here -->
    </div>
   </div>
   
   <!-- Yearly Leaderboard -->
   <div id="yearly-leaderboard-section">
    <h3 class="text-lg font-semibold text-slate-700 mb-3">Season Leaderboard</h3>
    <div id="yearly-leaderboard-container" class="bg-slate-50 rounded-lg p-3">
     <div id="yearly-leaderboard-loader" class="hidden text-center py-2">
      <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-slate-600"></div>
      <span class="ml-2 text-sm text-slate-600">Loading leaderboard...</span>
     </div>
     <div id="yearly-leaderboard-content" class="space-y-1">
      <!-- Leaderboard will be rendered here -->
     </div>
    </div>
   </div>
  </div>
 </div>
 
 <!-- Picks View -->
 <div id="picks-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
 <div>
 <label for="week-selector" class="block text-lg font-medium text-slate-700 mb-2">Select a Week:</label>
 <select id="week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
 </div>
 <div class="flex items-center space-x-4">
 <div id="save-status" class="flex items-center space-x-2 h-10">
 <div id="save-status-icon" class="w-6 h-6"></div>
 <span id="save-status-text" class="text-sm font-medium"></span>
 </div>
 <button id="reset-picks-btn" class="bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-800">Reset Picks</button>
 </div>
 </div>
 <main id="picks-form">
 <div id="lock-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md mb-6" role="alert">
 <p class="font-bold">Picks Locked</p>
 <p>The games for this week have started. Your picks can no longer be changed.</p>
 </div>
 <div id="game-list" class="space-y-6"></div>
 </main>
 </div>
 </div>

 <!-- Leaderboard View -->
  <div id="leaderboard-container" class="hidden">
    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-center">Confidence Pool Leaderboard</h2>
        <div class="flex justify-center items-center mb-4 space-x-2">
            <button id="lb-weekly-btn" class="view-toggle-btn active py-2 px-4 rounded-lg font-semibold border border-gray-300">Weekly</button>
            <button id="lb-season-btn" class="view-toggle-btn py-2 px-4 rounded-lg font-semibold border border-gray-300">Season</button>
        </div>
        <div id="lb-week-selector-container" class="mb-4 text-center">
            <label for="lb-week-selector" class="text-lg font-medium text-gray-700 mr-2">Week:</label>
            <select id="lb-week-selector" class="p-2 rounded-lg border-2 border-gray-300 bg-white"></select>
        </div>
        <div id="public-leaderboard-loader" class="loader hidden"></div>
        <table class="min-w-full divide-y divide-gray-200 public-leaderboard-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                </tr>
            </thead>
            <tbody id="public-leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>


 <!-- Admin View -->
 <div id="admin-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <div class="flex justify-between items-center mb-6">
 <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
 <select id="admin-week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
 </div>
 <div class="mb-6">
 <nav class="flex space-x-4" aria-label="Tabs">
 <button id="tab-game-results" class="admin-tab active">Games</button>
 <button id="tab-user-mgmt" class="admin-tab">Users</button>
 <button id="tab-picks-mgmt" class="admin-tab">Picks</button>
 <button id="tab-survivor-status" class="admin-tab">Survivors</button>
 <button id="tab-system-messenger" class="admin-tab">Messaging</button>
 </nav>
 </div>
 <div id="admin-content-game-results" class="admin-content-section">
 <h3 id="admin-week-title" class="text-xl font-bold mb-4"></h3>
 <div id="results-game-list" class="space-y-4"></div>
 <div class="flex space-x-4 mt-6">
    <button id="save-results-btn" class="w-full bg-green-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-800">Save Game Results</button>
    <button id="reset-winners-btn" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600">Reset All Winners</button>
</div>
 <div id="leaderboard-section" class="mt-8">
 <h3 class="text-xl font-bold mb-4">Live Leaderboard</h3>
 <div id="leaderboard-loader" class="loader hidden"></div>
 <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th></tr></thead><tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody></table>
 </div>
 </div>
 <div id="admin-content-user-mgmt" class="admin-content-section hidden">
 <div class="flex justify-between items-center mb-4">
 <h3 class="text-xl font-bold">User Management</h3>
 <button id="cleanup-duplicates-btn" class="bg-orange-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-orange-700">Clean Up Duplicates</button>
 </div>
 <table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-100">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="displayName">
Name 
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="email">
Email
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 user-sort-header" data-sort="role">
Status
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="user-mgmt-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
 </div>
 <div id="admin-content-picks-mgmt" class="admin-content-section hidden">
 <h3 class="text-xl font-bold mb-4">Edit User Picks</h3>
 <div class="mb-4">
 <label for="user-picks-selector" class="block text-sm font-medium text-gray-700">Select User:</label>
 <select id="user-picks-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md"></select>
 </div>
 <div id="user-picks-game-list" class="space-y-6"></div>
 <button id="save-user-picks-btn" class="mt-6 w-full bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 hidden">Save User's Picks</button>
 </div>
 <div id="admin-content-survivor-status" class="admin-content-section hidden">
    <h3 class="text-xl font-bold mb-4">Survivor Pool Status</h3>
    <table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-100">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="displayName">
User 
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="thisWeekPick">
This Week's Pick
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="status">
Status
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-200 survivor-sort-header" data-sort="role">
Role
<span class="sort-indicator ml-1">↕</span>
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="survivor-status-body" class="bg-white divide-y divide-gray-200"></tbody>
</table>
</div>
<div id="admin-content-system-messenger" class="admin-content-section hidden">
   <h3 class="text-xl font-bold mb-4">System Messenger</h3>
   
   <div class="space-y-6">
       <!-- Recipient Selection -->
       <div>
           <label for="message-recipients" class="block text-sm font-medium text-gray-700 mb-2">Recipients</label>
           <select id="message-recipients" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md">
               <option value="all">All Users</option>
               <option value="no-picks">Users without picks this week</option>
               <option value="top-3">Top 3 winners this week</option>
               <option value="custom">Select specific users</option>
           </select>
       </div>

       <!-- Custom User Selection (hidden by default) -->
       <div id="custom-users-section" class="hidden">
           <label class="block text-sm font-medium text-gray-700 mb-2">Select Users</label>
           <div id="custom-users-list" class="max-h-60 overflow-y-auto border border-gray-300 rounded-md p-3 space-y-2">
               <!-- User checkboxes will be populated here -->
           </div>
       </div>

       <!-- Subject -->
       <div>
           <label for="message-subject" class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
           <input type="text" id="message-subject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" placeholder="Enter email subject">
       </div>

       <!-- Message Body -->
       <div>
           <label for="message-body" class="block text-sm font-medium text-gray-700 mb-2">Message</label>
           <textarea id="message-body" rows="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm" placeholder="Enter your message here..."></textarea>
       </div>

       <!-- Preview -->
       <div id="message-preview-section" class="hidden">
           <label class="block text-sm font-medium text-gray-700 mb-2">Email Preview</label>
           <div id="message-preview" class="bg-gray-50 border border-gray-300 rounded-md p-4 text-sm whitespace-pre-wrap"></div>
       </div>

       <!-- Recipient Count -->
       <div id="recipient-count" class="text-sm text-gray-600">
           Recipients: <span id="recipient-count-number">0</span> users
       </div>

       <!-- Action Buttons -->
       <div class="flex space-x-4">
           <button id="preview-message-btn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">Preview Message</button>
           <button id="send-message-btn" class="bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Send Message</button>
       </div>

       <!-- Status Messages -->
       <div id="message-status" class="hidden">
           <div id="message-status-content" class="p-4 rounded-md"></div>
       </div>
   </div>
</div>
 </div>
 </div>
 </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex">
        <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-md w-full mx-auto border border-slate-300 relative">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">User Settings</h2>
            <div id="settings-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
            <div id="settings-success" class="text-green-600 text-center text-sm mb-4 hidden p-3 bg-green-100 rounded-md border border-green-200"></div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="settings-display-name" class="block text-sm font-medium text-slate-700">Display Name</label>
                    <input type="text" id="settings-display-name" required class="mt-1 form-input">
                </div>
                <div>
                    <label for="settings-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                    <input type="email" id="settings-email" required class="mt-1 form-input">
                    <div id="email-verification-status" class="mt-2 hidden">
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                            <div class="flex">
                                <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div>
                                    <h4 class="text-sm font-medium text-yellow-800">Email Change in Progress</h4>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        <span id="email-change-status">Attempting to send verification email to <span id="pending-email" class="font-medium"></span>...</span>
                                    </p>
                                    <div class="mt-2 space-y-2">
                                        <button id="resend-verification-btn" type="button" class="text-sm text-yellow-600 hover:text-yellow-800 underline hidden">Resend verification email</button>
                                        <button id="try-different-method-btn" type="button" class="text-sm text-blue-600 hover:text-blue-800 underline">Try a different approach</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="password-reauth-section" class="mt-2 hidden">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">Confirm Your Password</h4>
                            <p class="text-sm text-blue-700 mb-3">For security, please enter your current password to change your email address.</p>
                            <input type="password" id="reauth-password" placeholder="Current Password" class="form-input text-sm mb-2">
                            <div class="flex gap-2">
                                <button id="confirm-email-change-btn" type="button" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Confirm Change</button>
                                <button id="cancel-email-change-btn" type="button" class="px-3 py-1 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Linking Section -->
                <div class="border-t border-gray-300 pt-4 mt-6">
                    <h3 class="text-lg font-medium text-slate-800 mb-3">Account Linking</h3>
                    <div id="google-link-status" class="mb-4">
                        <div id="google-not-linked" class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Google Account</p>
                                    <p class="text-xs text-slate-500">Not linked</p>
                                </div>
                            </div>
                            <button id="link-google-btn" type="button" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Link Account
                            </button>
                        </div>
                        <div id="google-linked" class="hidden flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-slate-800">Google Account</p>
                                    <p class="text-xs text-green-600">✓ Linked - You can sign in with Google</p>
                                </div>
                            </div>
                            <button id="unlink-google-btn" type="button" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                Unlink
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">Link your Google account to sign in faster and more securely.</p>
                </div>

                <div class="pt-4">
                    <button type="submit" class="form-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, updateEmail, signOut, GoogleAuthProvider, signInWithPopup, linkWithCredential, fetchSignInMethodsForEmail, verifyBeforeUpdateEmail, sendEmailVerification, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

 const ADMIN_UIDS = ["WxSPmEildJdqs6T5hIpBUZrscwt2", "BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2"];
let saveTimeout;
let functions; // Declare functions globally

 document.addEventListener('DOMContentLoaded', () => {
 
 // --- DATA & TIME LOGIC ---
 async function getGamesForWeek(weekNumber) {
 try {
 const response = await fetch(`nfl_2025_week_${weekNumber}.json`);
 if (!response.ok) {
 throw new Error(`Failed to fetch schedule for week ${weekNumber}: ${response.status}`);
 }
 const weekData = await response.json();
 return Array.isArray(weekData.games) ? weekData.games.map(game => ({
 id: game.id,
 away: game.a,
 home: game.h,
 kickoff: game.dt.slice(0, -1),
 stadium: game.stadium
 })) : [];
 } catch (error) {
 console.error(`Error fetching games for week ${weekNumber}:`, error);
 return [];
 }
 }

 function getCurrentNflWeek() {
 const seasonStartDate = new Date('2025-09-04T00:00:00Z');
 const now = new Date();
 
 if (now < seasonStartDate) {
 return 1;
 }

 const diffTime = Math.abs(now - seasonStartDate);
 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
 const week = Math.ceil(diffDays / 7);

 return week > 18 ? 18 : week;
 }

 // --- UI ELEMENTS ---
 const allUI = {
 loadingView: document.getElementById('loading-view'), loginView: document.getElementById('login-view'), appView: document.getElementById('app-view'),
 loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
 showRegisterLink: document.getElementById('show-register-link'), showLoginLink: document.getElementById('show-login-link'),
 loginError: document.getElementById('login-error'), registerError: document.getElementById('register-error'),
 googleSigninBtn: document.getElementById('google-signin-btn'), googleSignupBtn: document.getElementById('google-signup-btn'),
 accountLinkingModal: document.getElementById('account-linking-modal'),
 linkingEmail: document.getElementById('linking-email'),
 cancelLinkingBtn: document.getElementById('cancel-linking-btn'), confirmLinkingBtn: document.getElementById('confirm-linking-btn'),
 passwordLinkingModal: document.getElementById('password-linking-modal'),
 passwordPromptEmail: document.getElementById('password-prompt-email'),
 passwordPromptInput: document.getElementById('password-prompt-input'),
 passwordPromptError: document.getElementById('password-prompt-error'),
 cancelPasswordPromptBtn: document.getElementById('cancel-password-prompt-btn'),
 confirmPasswordPromptBtn: document.getElementById('confirm-password-prompt-btn'),
 logoutBtn: document.getElementById('logout-btn'), userDisplay: document.getElementById('user-display'),
 menuAdminControls: document.getElementById('menu-admin-controls'),
 picksContainer: document.getElementById('picks-container'), adminContainer: document.getElementById('admin-container'),
 picksViewBtn: document.getElementById('menu-picks-view-btn'),
 adminViewBtn: document.getElementById('menu-admin-view-btn'),
 survivorAdminBtn: document.getElementById('survivor-admin-btn'),
 leaderboardViewBtn: document.getElementById('leaderboard-view-btn'),
 weekSelector: document.getElementById('week-selector'), adminWeekSelector: document.getElementById('admin-week-selector'),
 gameList: document.getElementById('game-list'), resultsGameList: document.getElementById('results-game-list'),
 saveResultsBtn: document.getElementById('save-results-btn'),
 leaderboardLoader: document.getElementById('leaderboard-loader'), leaderboardBody: document.getElementById('leaderboard-body'),
 saveStatusIcon: document.getElementById('save-status-icon'), saveStatusText: document.getElementById('save-status-text'),
 resetPicksBtn: document.getElementById('reset-picks-btn'),
 adminTabs: document.querySelectorAll('.admin-tab'), adminContentSections: document.querySelectorAll('.admin-content-section'),
 userMgmtBody: document.getElementById('user-mgmt-body'),
 cleanupDuplicatesBtn: document.getElementById('cleanup-duplicates-btn'),
 userPicksSelector: document.getElementById('user-picks-selector'),
 userPicksGameList: document.getElementById('user-picks-game-list'),
 saveUserPicksBtn: document.getElementById('save-user-picks-btn'),
 settingsBtn: document.getElementById('settings-btn'),
 settingsModal: document.getElementById('settings-modal'),
 closeSettingsBtn: document.getElementById('close-settings-btn'),
 settingsForm: document.getElementById('settings-form'),
 settingsDisplayName: document.getElementById('settings-display-name'),
 settingsEmail: document.getElementById('settings-email'),
 settingsError: document.getElementById('settings-error'),
 settingsSuccess: document.getElementById('settings-success'),
 googleNotLinked: document.getElementById('google-not-linked'),
 googleLinked: document.getElementById('google-linked'),
 linkGoogleBtn: document.getElementById('link-google-btn'),
 unlinkGoogleBtn: document.getElementById('unlink-google-btn'),
 emailVerificationStatus: document.getElementById('email-verification-status'),
 pendingEmail: document.getElementById('pending-email'),
 emailChangeStatus: document.getElementById('email-change-status'),
 resendVerificationBtn: document.getElementById('resend-verification-btn'),
 tryDifferentMethodBtn: document.getElementById('try-different-method-btn'),
 passwordReauthSection: document.getElementById('password-reauth-section'),
 reauthPassword: document.getElementById('reauth-password'),
 confirmEmailChangeBtn: document.getElementById('confirm-email-change-btn'),
 cancelEmailChangeBtn: document.getElementById('cancel-email-change-btn'),
 adminWeekTitle: document.getElementById('admin-week-title'),
 resetWinnersBtn: document.getElementById('reset-winners-btn'),
 survivorStatusBody: document.getElementById('survivor-status-body'),
messageRecipients: document.getElementById('message-recipients'),
customUsersSection: document.getElementById('custom-users-section'),
customUsersList: document.getElementById('custom-users-list'),
messageSubject: document.getElementById('message-subject'),
messageBody: document.getElementById('message-body'),
messagePreviewSection: document.getElementById('message-preview-section'),
messagePreview: document.getElementById('message-preview'),
recipientCountNumber: document.getElementById('recipient-count-number'),
previewMessageBtn: document.getElementById('preview-message-btn'),
sendMessageBtn: document.getElementById('send-message-btn'),
messageStatus: document.getElementById('message-status'),
messageStatusContent: document.getElementById('message-status-content'),
 menuBtn: document.getElementById('menu-btn'),
 menuPanel: document.getElementById('menu-panel'),
 leaderboardContainer: document.getElementById('leaderboard-container'),
 lbWeeklyBtn: document.getElementById('lb-weekly-btn'),
 lbSeasonBtn: document.getElementById('lb-season-btn'),
 lbWeekSelectorContainer: document.getElementById('lb-week-selector-container'),
 lbWeekSelector: document.getElementById('lb-week-selector'),
 publicLeaderboardLoader: document.getElementById('public-leaderboard-loader'),
 publicLeaderboardBody: document.getElementById('public-leaderboard-body'),
 picksSummaryContainer: document.getElementById('picks-summary-container'),
 activePicksSection: document.getElementById('active-picks-section'),
 activePicksList: document.getElementById('active-picks-list'),
 yearlyLeaderboardSection: document.getElementById('yearly-leaderboard-section'),
 yearlyLeaderboardLoader: document.getElementById('yearly-leaderboard-loader'),
 yearlyLeaderboardContent: document.getElementById('yearly-leaderboard-content'),
 };

 // --- APP STATE ---
 let currentWeek = 1, currentUser = null, db, auth, unsubscribeFromPicks = null, saveTimeout = null;
 let currentAdminPicks = {}, allUsers = [];

 // --- NFL TEAM DATA ---
 const nflTeamLogos = {
  'ARI': 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png',
  'ATL': 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png',
  'BAL': 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png',
  'BUF': 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png',
  'CAR': 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png',
  'CHI': 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png',
  'CIN': 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png',
  'CLE': 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png',
  'DAL': 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png',
  'DEN': 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png',
  'DET': 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png',
  'GB': 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png',
  'HOU': 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png',
  'IND': 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png',
  'JAX': 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png',
  'KC': 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png',
  'LV': 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png',
  'LAC': 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png',
  'LAR': 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png',
  'MIA': 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png',
  'MIN': 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png',
  'NE': 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png',
  'NO': 'https://a.espncdn.com/i/teamlogos/nfl/500/no.png',
  'NYG': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png',
  'NYJ': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png',
  'PHI': 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png',
  'PIT': 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png',
  'SF': 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png',
  'SEA': 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png',
  'TB': 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png',
  'TEN': 'https://a.espncdn.com/i/teamlogos/nfl/500/ten.png',
  'WAS': 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png'
 };

 // Map full team names to abbreviations for logo lookup
 const teamNameToAbbr = {
  'Arizona Cardinals': 'ARI',
  'Atlanta Falcons': 'ATL',
  'Baltimore Ravens': 'BAL',
  'Buffalo Bills': 'BUF',
  'Carolina Panthers': 'CAR',
  'Chicago Bears': 'CHI',
  'Cincinnati Bengals': 'CIN',
  'Cleveland Browns': 'CLE',
  'Dallas Cowboys': 'DAL',
  'Denver Broncos': 'DEN',
  'Detroit Lions': 'DET',
  'Green Bay Packers': 'GB',
  'Houston Texans': 'HOU',
  'Indianapolis Colts': 'IND',
  'Jacksonville Jaguars': 'JAX',
  'Kansas City Chiefs': 'KC',
  'Las Vegas Raiders': 'LV',
  'Los Angeles Chargers': 'LAC',
  'Los Angeles Rams': 'LAR',
  'Miami Dolphins': 'MIA',
  'Minnesota Vikings': 'MIN',
  'New England Patriots': 'NE',
  'New Orleans Saints': 'NO',
  'New York Giants': 'NYG',
  'New York Jets': 'NYJ',
  'Philadelphia Eagles': 'PHI',
  'Pittsburgh Steelers': 'PIT',
  'San Francisco 49ers': 'SF',
  'Seattle Seahawks': 'SEA',
  'Tampa Bay Buccaneers': 'TB',
  'Tennessee Titans': 'TEN',
  'Washington Commanders': 'WAS'
 };

 // --- FIREBASE OPTIMIZATION ---
 const firebaseCache = {
  users: { data: null, timestamp: 0, ttl: 300000 }, // 5 minutes
  leaderboard: { data: null, timestamp: 0, ttl: 60000 }, // 1 minute
  gameResults: new Map(), // Cache by week
  userPicks: new Map() // Cache by week-userId
 };

 // Cache helper functions
 function isCacheValid(cache) {
  return cache.data !== null && (Date.now() - cache.timestamp) < cache.ttl;
 }

 function setCacheData(cache, data) {
  cache.data = data;
  cache.timestamp = Date.now();
 }

 // Optimized user fetching with cache
 async function getCachedUsers() {
  if (isCacheValid(firebaseCache.users)) {
   return firebaseCache.users.data;
  }
  
  const usersSnap = await getDocs(collection(db, usersPath()));
  const users = {};
  usersSnap.forEach(doc => users[doc.id] = doc.data());
  
  setCacheData(firebaseCache.users, users);
  return users;
 }

 // Get cleaned user data (deduplicated) for leaderboards
 async function getCleanUsers() {
  // Use the same deduplication logic as fetchAllUsers but return as object
  const users = await getCachedUsers();
  const rawUsers = [];
  Object.keys(users).forEach(id => {
   rawUsers.push({ id: id, ...users[id] });
  });
  
  // Handle duplicate email addresses - keep only the preferred UID
  const emailMap = new Map();
  const preferredUIDs = new Set(['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2']);
  
  rawUsers.forEach(user => {
   if (!user.email) return;
   
   const existing = emailMap.get(user.email);
   if (!existing) {
    emailMap.set(user.email, user);
   } else {
    // If current user has preferred UID, replace existing
    if (preferredUIDs.has(user.id)) {
     emailMap.set(user.email, user);
    } else if (!preferredUIDs.has(existing.id)) {
     // Neither has preferred UID, keep the most recently updated
     if (user.lastUpdated && (!existing.lastUpdated || user.lastUpdated > existing.lastUpdated)) {
      emailMap.set(user.email, user);
     }
    }
   }
  });
  
  // Convert back to object format for leaderboard compatibility
  const cleanUsers = {};
  emailMap.forEach(user => {
   cleanUsers[user.id] = user;
  });
  
  return cleanUsers;
 }

 // Batch Firebase operations to reduce round-trips
 async function batchGetDocs(queries) {
  return Promise.all(queries.map(query => getDocs(query)));
 }

 // Cache invalidation
 function invalidateCache(cacheKey) {
  if (firebaseCache[cacheKey]) {
   firebaseCache[cacheKey].data = null;
   firebaseCache[cacheKey].timestamp = 0;
  }
 }

 // Invalidate all caches
 function invalidateAllCaches() {
  Object.keys(firebaseCache).forEach(key => {
   if (firebaseCache[key] && typeof firebaseCache[key] === 'object' && firebaseCache[key].data !== undefined) {
    firebaseCache[key].data = null;
    firebaseCache[key].timestamp = 0;
   }
  });
 }

 // --- STATE MANAGEMENT ---
 function saveAppState() {
  const state = {
   currentView: getCurrentView(),
   currentWeek: currentWeek,
   leaderboardView: allUI.lbSeasonBtn.classList.contains('active') ? 'season' : 'weekly'
  };
  localStorage.setItem('nerdfootballState', JSON.stringify(state));
  updateUrl();
 }

 function loadAppState() {
  // Prioritize URL params over localStorage
  const urlParams = getUrlParams();
  const saved = localStorage.getItem('nerdfootballState');
  const savedState = saved ? JSON.parse(saved) : {};
  
  return {
   currentView: urlParams.view,
   currentWeek: urlParams.week,
   leaderboardView: urlParams.lb
  };
 }

 function getCurrentView() {
  if (!allUI.adminContainer.classList.contains('hidden')) return 'admin';
  if (!allUI.leaderboardContainer.classList.contains('hidden')) return 'leaderboard';
  return 'picks';
 }

 // --- URL ROUTING ---
 function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
   view: params.get('view') || 'picks',
   week: parseInt(params.get('week')) || getCurrentNflWeek(),
   lb: params.get('lb') || 'weekly'
  };
 }

 function updateUrl() {
  const currentView = getCurrentView();
  const isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
  const params = new URLSearchParams();
  
  if (currentView !== 'picks') params.set('view', currentView);
  if (currentWeek !== getCurrentNflWeek()) params.set('week', currentWeek);
  if (currentView === 'leaderboard' && isSeasonView) params.set('lb', 'season');
  
  // Preserve existing hash fragment
  const currentHash = window.location.hash;
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '') + currentHash;
  window.history.replaceState({}, '', newUrl);
 }

 // --- ADMIN LOGIC ---
 async function fetchAllUsers() {
 const users = await getCachedUsers();
 const rawUsers = [];
 Object.keys(users).forEach(id => {
  rawUsers.push({ id: id, ...users[id] });
 });
 
 // Handle duplicate email addresses - keep only the preferred UID
 const emailMap = new Map();
 const preferredUIDs = new Set(['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2']);
 
 rawUsers.forEach(user => {
  if (!user.email) return;
  
  const existing = emailMap.get(user.email);
  if (!existing) {
   emailMap.set(user.email, user);
  } else {
   // If current user has preferred UID, replace existing
   if (preferredUIDs.has(user.id)) {
    emailMap.set(user.email, user);
   } else if (!preferredUIDs.has(existing.id)) {
    // Neither has preferred UID, keep the most recently updated
    if (user.lastUpdated && (!existing.lastUpdated || user.lastUpdated > existing.lastUpdated)) {
     emailMap.set(user.email, user);
    }
   }
  }
 });
 
 allUsers = Array.from(emailMap.values());
 allUsers.sort((a,b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));
 }

 async function cleanupDuplicateUsers() {
  try {
   console.log('Starting cleanup of duplicate users...');
   
   // Get all users from Firestore
   const usersCollectionRef = collection(db, usersPath());
   const usersSnap = await getDocs(usersCollectionRef);
   const allUsersRaw = [];
   usersSnap.forEach(doc => {
    allUsersRaw.push({ id: doc.id, ...doc.data() });
   });
   
   // Find duplicates for tonyweeg@gmail.com specifically
   const tonyweegUsers = allUsersRaw.filter(u => u.email === 'tonyweeg@gmail.com');
   console.log(`Found ${tonyweegUsers.length} users with tonyweeg@gmail.com:`, tonyweegUsers);
   
   if (tonyweegUsers.length > 1) {
    const keepUID = 'WxSPmEildJdqs6T5hIpBUZrscwt2';
    const usersToRemove = tonyweegUsers.filter(u => u.id !== keepUID);
    
    for (const userToRemove of usersToRemove) {
     console.log(`Removing duplicate user: ${userToRemove.id}`);
     await removeUserCompletely(userToRemove.id, `${userToRemove.displayName} (duplicate)`);
    }
    
    console.log(`Cleanup complete. Kept user with UID: ${keepUID}`);
   } else {
    console.log('No duplicate tonyweeg@gmail.com users found.');
   }
   
  } catch (error) {
   console.error('Error during duplicate cleanup:', error);
   alert(`Error cleaning up duplicates: ${error.message}`);
  }
 }

 async function removeUserCompletely(userId, userName) {
  try {
   console.log(`Starting complete removal of user: ${userId} (${userName})`);
   
   // Step 1: Delete user profile
   console.log('Deleting user profile...');
   const userDocRef = doc(db, usersPath(), userId);
   await deleteDoc(userDocRef);
   
   // Step 2: Delete all weekly picks (check all weeks 1-18)
   console.log('Deleting all weekly picks...');
   for (let week = 1; week <= 18; week++) {
    try {
     const picksDocRef = doc(db, picksPath(week, userId));
     await deleteDoc(picksDocRef);
     console.log(`Deleted picks for week ${week}`);
    } catch (error) {
     console.log(`No picks found for week ${week} (this is normal)`);
    }
   }
   
   // Step 3: Delete survivor picks
   console.log('Deleting survivor picks...');
   try {
    const survivorDocRef = doc(db, survivorPicksPath(userId));
    await deleteDoc(survivorDocRef);
    console.log('Deleted survivor picks');
   } catch (error) {
    console.log('No survivor picks found (this is normal)');
   }
   
   // Step 4: Clean up any other user references (if any exist in other collections)
   console.log('Checking for other user references...');
   
   // Step 5: Refresh the user list
   await fetchAllUsers();
   renderUserManagement();
   
   alert(`✅ User "${userName}" has been completely removed from the system.\n\nAll data deleted:\n- User profile\n- All weekly picks (weeks 1-18)\n- Survivor picks\n- All associated data`);
   
   console.log(`Successfully completed removal of user: ${userId} (${userName})`);
   
  } catch (error) {
   console.error('Error during user removal:', error);
   alert(`❌ Error removing user "${userName}": ${error.message}\n\nPlease try again or contact support.`);
  }
 }

 async function renderGameResultsAdmin(weekNumber) {
    allUI.adminWeekTitle.textContent = `Editing Results for Week ${weekNumber}`;
    const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
    if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
        allUI.resultsGameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week.</p>';
        allUI.leaderboardBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">No data for this week.</td></tr>`;
        return;
    }
    
    const picksCollectionRef = collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`);
    const picksSnap = await getDocs(picksCollectionRef);
    const pickCounts = {};
    picksSnap.forEach(pickDoc => {
        const userPicks = pickDoc.data();
        Object.keys(userPicks).forEach(gameId => {
            if (!pickCounts[gameId]) {
                pickCounts[gameId] = { away: 0, home: 0 };
            }
            if (userPicks[gameId].winner) {
                const weekGame = weekData.games.find(g => g.id == gameId);
                if (weekGame && userPicks[gameId].winner === weekGame.away) {
                    pickCounts[gameId].away++;
                } else if (weekGame && userPicks[gameId].winner === weekGame.home) {
                    pickCounts[gameId].home++;
                }
            }
        });
    });

    const resultsDocRef = doc(db, resultsPath(weekNumber));
    const resultsSnap = await getDoc(resultsDocRef);
    const currentResults = resultsSnap.exists() ? resultsSnap.data() : {};
    allUI.resultsGameList.innerHTML = '';

    weekData.games.forEach(game => {
        const gameTime = new Date(game.kickoff);
        const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

        // Get existing scores if available
        const gameResult = currentResults[game.id];
        let awayScore = '';
        let homeScore = '';
        let winner = null;
        
        if (gameResult) {
            if (typeof gameResult === 'string') {
                // Legacy format - just winner
                winner = gameResult;
            } else if (typeof gameResult === 'object') {
                // New format - winner and scores
                winner = gameResult.winner;
                awayScore = gameResult.awayScore || '';
                homeScore = gameResult.homeScore || '';
            }
        }

        const gameEl = document.createElement('div');
        gameEl.className = 'p-4 border border-slate-300 rounded-lg bg-slate-100';
        gameEl.innerHTML = `
            <div class="space-y-4">
                <div class="text-center">
                    <p class="text-sm font-medium text-slate-600">${formattedTime}</p>
                    <p class="text-xs text-slate-500">${game.stadium}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 items-center">
                    <div class="text-center">
                        <button data-game-id="${game.id}" data-team="${game.away}" class="result-btn w-full p-3 rounded-lg border-2 font-semibold mb-2 ${winner === game.away ? 'selected' : 'border-slate-300 bg-white hover:bg-slate-50'}">${game.away}</button>
                        <input 
                            type="number" 
                            min="0" 
                            max="99" 
                            placeholder="Score" 
                            value="${awayScore}"
                            data-game-id="${game.id}" 
                            data-team="away"
                            class="score-input w-full p-2 text-center border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div class="text-center">
                        <button data-game-id="${game.id}" data-team="${game.home}" class="result-btn w-full p-3 rounded-lg border-2 font-semibold mb-2 ${winner === game.home ? 'selected' : 'border-slate-300 bg-white hover:bg-slate-50'}">${game.home}</button>
                        <input 
                            type="number" 
                            min="0" 
                            max="99" 
                            placeholder="Score" 
                            value="${homeScore}"
                            data-game-id="${game.id}" 
                            data-team="home"
                            class="score-input w-full p-2 text-center border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>
                <div class="text-center">
                    <button 
                        data-game-id="${game.id}" 
                        class="auto-winner-btn text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-200"
                    >
                        Auto-select winner from scores
                    </button>
                </div>
            </div>`;
        allUI.resultsGameList.appendChild(gameEl);
    });
    
    allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const { gameId } = e.target.dataset;
        const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
        gameButtons.forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
    }));

    // Add event listeners for auto-winner buttons
    allUI.resultsGameList.querySelectorAll('.auto-winner-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const gameId = e.target.dataset.gameId;
        const awayScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="away"]`);
        const homeScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="home"]`);
        
        const awayScore = parseInt(awayScoreInput.value) || 0;
        const homeScore = parseInt(homeScoreInput.value) || 0;
        
        if (awayScore === 0 && homeScore === 0) {
            alert('Please enter scores for both teams first');
            return;
        }
        
        // Clear current selection
        const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
        gameButtons.forEach(b => b.classList.remove('selected'));
        
        // Select winner based on higher score
        if (awayScore > homeScore) {
            // Away team wins - select first button (away team)
            gameButtons[0].classList.add('selected');
        } else if (homeScore > awayScore) {
            // Home team wins - select second button (home team) 
            gameButtons[1].classList.add('selected');
        } else {
            alert('Tie game! Please manually select the winner.');
        }
    }));

    calculateAndDisplayLeaderboard(weekNumber);
 }


 // User management sorting state
 let userSortField = 'role'; // Start by sorting by role (admins first)
 let userSortDirection = 'desc'; // desc = admins first, asc = regular users first

 function renderUserManagement() {
   // Create enhanced user objects with role information
   const enhancedUsers = allUsers.map(user => ({
     ...user,
     role: ADMIN_UIDS.includes(user.id) ? 'admin' : 'user',
     displayName: user.displayName || 'N/A'
   }));

   // Sort users based on current sort settings
   const sortedUsers = sortUsers(enhancedUsers, userSortField, userSortDirection);

   // Render the sorted users with row numbers
   allUI.userMgmtBody.innerHTML = sortedUsers.map((user, index) => {
     const isAdmin = user.role === 'admin';
     const rowClass = isAdmin ? 'bg-blue-50' : '';
     const statusClass = isAdmin ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
     const statusText = isAdmin ? 'Admin' : 'Active';

     return `
       <tr class="${rowClass}">
         <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${index + 1}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           ${user.displayName}
           ${isAdmin ? '<span class="ml-2 text-xs text-blue-600 font-semibold">👑</span>' : ''}
         </td>
         <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
             ${statusText}
           </span>
         </td>
         <td class="px-6 py-4 whitespace-nowrap">
           <button data-user-id="${user.id}" class="user-remove-btn text-sm font-medium ${isAdmin ? 'text-blue-600 opacity-50 cursor-not-allowed' : 'text-red-600 hover:text-red-900'}">
             ${isAdmin ? 'Protected' : 'Remove User'}
           </button>
         </td>
       </tr>
     `;
   }).join('');

   // Update sort indicators
   updateSortIndicators();

   // Add event listeners for column sorting
   document.querySelectorAll('.user-sort-header').forEach(header => {
     header.replaceWith(header.cloneNode(true)); // Remove existing listeners
   });
   
   document.querySelectorAll('.user-sort-header').forEach(header => {
     header.addEventListener('click', (e) => {
       const field = e.currentTarget.dataset.sort;
       
       if (userSortField === field) {
         // Toggle direction if same field
         userSortDirection = userSortDirection === 'desc' ? 'asc' : 'desc';
       } else {
         // New field, start with descending
         userSortField = field;
         userSortDirection = 'desc';
       }
       
       renderUserManagement(); // Re-render with new sort
     });
   });

   // Add event listeners for remove buttons
   allUI.userMgmtBody.querySelectorAll('.user-remove-btn').forEach(btn => {
     btn.addEventListener('click', async (e) => {
       const userId = e.target.dataset.userId;
       const userName = allUsers.find(u => u.id === userId)?.displayName || allUsers.find(u => u.id === userId)?.email;

       if (ADMIN_UIDS.includes(userId)) {
         alert("You cannot remove admin accounts.");
         return;
       }

       if (confirm(`⚠️ WARNING: This will PERMANENTLY DELETE all data for "${userName}".\n\nThis includes:\n- User profile\n- All picks from all weeks\n- Pick history\n- Survivor picks\n- All associated data\n\nThis action CANNOT be undone.\n\nType "DELETE" to confirm:`)) {
         const confirmation = prompt('Type "DELETE" to confirm user removal:');
         if (confirmation === 'DELETE') {
           await removeUserCompletely(userId, userName);
         } else {
           alert('User removal cancelled.');
         }
       }
     });
   });
 }

 // Sort users based on field and direction
 function sortUsers(users, field, direction) {
   return users.sort((a, b) => {
     let aValue = a[field];
     let bValue = b[field];

     // Special handling for role to ensure admins come first when desc
     if (field === 'role') {
       aValue = aValue === 'admin' ? 1 : 0;
       bValue = bValue === 'admin' ? 1 : 0;
     }

     // Handle string comparisons
     if (typeof aValue === 'string' && typeof bValue === 'string') {
       aValue = aValue.toLowerCase();
       bValue = bValue.toLowerCase();
     }

     let result;
     if (aValue < bValue) result = -1;
     else if (aValue > bValue) result = 1;
     else result = 0;

     return direction === 'desc' ? -result : result;
   });
 }

 // Update sort indicators in table headers
 function updateSortIndicators() {
   document.querySelectorAll('.user-sort-header').forEach(header => {
     const indicator = header.querySelector('.sort-indicator');
     const field = header.dataset.sort;
     
     if (field === userSortField) {
       indicator.textContent = userSortDirection === 'desc' ? '↓' : '↑';
       header.classList.add('text-blue-600');
     } else {
       indicator.textContent = '↕';
       header.classList.remove('text-blue-600');
     }
   });
 }

 async function renderPicksManagement(weekNumber) {
 allUI.userPicksSelector.innerHTML = '<option value="">Select a user...</option>' + allUsers.map(u => `<option value="${u.id}">${u.displayName || u.email}</option>`).join('');
 allUI.userPicksGameList.innerHTML = '';
 allUI.saveUserPicksBtn.classList.add('hidden');
 }
 
 // Survivor status sorting state
let survivorSortField = 'role'; // Start by sorting by role (admins first)
let survivorSortDirection = 'desc'; // desc = admins first, asc = regular users first

async function renderSurvivorStatus(weekNumber) {
    allUI.survivorStatusBody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="loader"></div></td></tr>`;
    
    const statusDocRef = doc(db, survivorStatusPath());
    const statusSnap = await getDoc(statusDocRef);
    const allStatuses = statusSnap.exists() ? statusSnap.data() : {};
    
    const picksCollectionRef = collection(db, survivorPicksPath('').slice(0,-1));
    const picksSnap = await getDocs(picksCollectionRef);
    const allPicks = {};
    picksSnap.forEach(doc => {
        allPicks[doc.id] = doc.data();
    });

    // Create enhanced user objects with role and additional data for sorting
    const enhancedUsers = allUsers.map(user => {
        const userStatus = allStatuses[user.id] || { eliminated: false };
        const userPicks = allPicks[user.id];
        const thisWeekPick = userPicks && userPicks.picks && userPicks.picks[weekNumber] ? userPicks.picks[weekNumber].team : 'No Pick';
        
        return {
            ...user,
            role: user.isAdmin ? 'admin' : 'user',
            eliminated: userStatus.eliminated,
            eliminatedWeek: userStatus.eliminatedWeek,
            thisWeekPick: thisWeekPick,
            status: userStatus.eliminated ? `Eliminated (Week ${userStatus.eliminatedWeek})` : 'Active'
        };
    });

    // Sort users based on current sort field and direction
    enhancedUsers.sort((a, b) => {
        let valueA = a[survivorSortField];
        let valueB = b[survivorSortField];
        
        // Handle special cases for different field types
        if (survivorSortField === 'role') {
            // Admin comes before user
            valueA = a.role === 'admin' ? 0 : 1;
            valueB = b.role === 'admin' ? 0 : 1;
        } else if (survivorSortField === 'eliminated') {
            // Convert boolean to number for sorting
            valueA = a.eliminated ? 1 : 0;
            valueB = b.eliminated ? 1 : 0;
        } else if (survivorSortField === 'displayName') {
            // Use displayName or email as fallback
            valueA = (a.displayName || a.email || '').toLowerCase();
            valueB = (b.displayName || b.email || '').toLowerCase();
        } else if (survivorSortField === 'thisWeekPick') {
            valueA = (a.thisWeekPick || '').toLowerCase();
            valueB = (b.thisWeekPick || '').toLowerCase();
        }
        
        // Compare values
        if (valueA < valueB) return survivorSortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return survivorSortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    const tableRows = enhancedUsers.map((user, index) => {
        return `
            <tr class="${user.role === 'admin' ? 'bg-blue-50' : ''}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${user.displayName || user.email}
                    ${user.role === 'admin' ? '<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Admin</span>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">${user.thisWeekPick}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.eliminated ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${user.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button data-user-id="${user.id}" data-eliminated="${!!user.eliminated}" class="survivor-status-btn text-sm font-medium ${user.eliminated ? 'text-green-600 hover:text-green-900' : 'text-red-600 hover:text-red-900'}">
                        ${user.eliminated ? 'Reinstate' : 'Eliminate'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    allUI.survivorStatusBody.innerHTML = tableRows || `<tr><td colspan="5" class="text-center py-4">No users in survivor pool.</td></tr>`;

    // Update sort indicators
    document.querySelectorAll('.survivor-sort-header').forEach(header => {
        const sortField = header.dataset.sort;
        const indicator = header.querySelector('.sort-indicator');
        if (sortField === survivorSortField) {
            indicator.textContent = survivorSortDirection === 'asc' ? '↑' : '↓';
        } else {
            indicator.textContent = '↕';
        }
    });

    // Add event listeners for sorting
    document.querySelectorAll('.survivor-sort-header').forEach(header => {
        header.addEventListener('click', () => {
            const sortField = header.dataset.sort;
            if (survivorSortField === sortField) {
                survivorSortDirection = survivorSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                survivorSortField = sortField;
                survivorSortDirection = 'asc';
            }
            renderSurvivorStatus(weekNumber);
        });
    });

    allUI.survivorStatusBody.querySelectorAll('.survivor-status-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
            const userId = e.target.dataset.userId;
            const isEliminated = e.target.dataset.eliminated === 'true';
            
            const statusUpdate = {};
            if (!isEliminated) {
                if(confirm('Are you sure you want to eliminate this player?')){
                    statusUpdate[`${userId}.eliminated`] = true;
                    statusUpdate[`${userId}.eliminatedWeek`] = weekNumber;
                }
            } else {
                if(confirm('Are you sure you want to reinstate this player?')){
                    statusUpdate[`${userId}`] = deleteField();
                }
            }

            if(Object.keys(statusUpdate).length > 0) {
                await updateDoc(statusDocRef, statusUpdate);
                await renderSurvivorStatus(weekNumber);
            }
        });
    });
}

// --- SYSTEM MESSENGER FUNCTIONS ---
async function renderSystemMessenger(weekNumber) {
    // Initialize recipient selection
    updateRecipientSelection();
    
    // Set up event listeners
    setupSystemMessengerListeners();
}

function setupSystemMessengerListeners() {
    // Prevent duplicate listeners
    if (allUI.messageRecipients.hasSystemMessengerListeners) return;
    
    // Recipient selection change
    allUI.messageRecipients.addEventListener('change', (e) => {
        const recipientType = e.target.value;
        
        if (recipientType === 'custom') {
            allUI.customUsersSection.classList.remove('hidden');
            loadCustomUsersList();
        } else {
            allUI.customUsersSection.classList.add('hidden');
        }
        
        updateRecipientCount();
    });
    
    // Preview button
    allUI.previewMessageBtn.addEventListener('click', previewMessage);
    
    // Send button
    allUI.sendMessageBtn.addEventListener('click', sendSystemMessage);
    
    // Subject and body change to enable/disable send button
    [allUI.messageSubject, allUI.messageBody].forEach(element => {
        element.addEventListener('input', () => {
            const hasSubject = allUI.messageSubject.value.trim().length > 0;
            const hasBody = allUI.messageBody.value.trim().length > 0;
            allUI.sendMessageBtn.disabled = !(hasSubject && hasBody);
        });
    });
    
    // Mark as having listeners
    allUI.messageRecipients.hasSystemMessengerListeners = true;
}

async function loadCustomUsersList() {
    if (!allUsers || allUsers.length === 0) {
        await loadUsers();
    }
    
    const customUsersHtml = allUsers.map(user => `
        <div class="flex items-center">
            <input type="checkbox" id="user-${user.id}" value="${user.id}" class="custom-user-checkbox mr-2">
            <label for="user-${user.id}" class="text-sm">${user.displayName || user.email}</label>
        </div>
    `).join('');
    
    allUI.customUsersList.innerHTML = customUsersHtml;
    
    // Add event listeners to checkboxes
    allUI.customUsersList.querySelectorAll('.custom-user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateRecipientCount);
    });
}

async function getFilteredRecipients(recipientType, weekNumber) {
    if (!allUsers || allUsers.length === 0) {
        await loadUsers();
    }
    
    switch (recipientType) {
        case 'all':
            return allUsers;
            
        case 'no-picks':
            const usersWithoutPicks = [];
            for (const user of allUsers) {
                const userDocRef = doc(db, picksPath(weekNumber, user.id));
                const userSnap = await getDoc(userDocRef);
                const userData = userSnap.exists() ? userSnap.data() : {};
                
                // Check if user has no picks or incomplete picks
                const picks = userData.picks || {};
                const games = await getGamesForWeek(weekNumber);
                const hasAllPicks = games.every(game => picks[game.id]);
                
                if (!hasAllPicks) {
                    usersWithoutPicks.push(user);
                }
            }
            return usersWithoutPicks;
            
        case 'top-3':
            // Calculate weekly leaderboard and get top 3
            const weeklyScores = await calculateWeeklyLeaderboard(weekNumber);
            const topThreeUserIds = weeklyScores.slice(0, 3).map(score => score.userId);
            return allUsers.filter(user => topThreeUserIds.includes(user.id));
            
        case 'custom':
            const selectedUserIds = Array.from(
                allUI.customUsersList.querySelectorAll('.custom-user-checkbox:checked')
            ).map(cb => cb.value);
            return allUsers.filter(user => selectedUserIds.includes(user.id));
            
        default:
            return [];
    }
}

async function updateRecipientCount() {
    const weekNumber = allUI.adminWeekSelector ? allUI.adminWeekSelector.value : getCurrentWeek();
    const recipientType = allUI.messageRecipients.value;
    const recipients = await getFilteredRecipients(recipientType, weekNumber);
    allUI.recipientCountNumber.textContent = recipients.length;
}

function updateRecipientSelection() {
    // Update recipient count initially
    updateRecipientCount();
}

async function previewMessage() {
    const subject = allUI.messageSubject.value.trim();
    const body = allUI.messageBody.value.trim();
    
    if (!subject || !body) {
        showMessageStatus('Please enter both subject and message body.', 'error');
        return;
    }
    
    // Sample user for preview
    const sampleUser = allUsers && allUsers.length > 0 ? allUsers[0] : { displayName: 'Sample User' };
    const formattedEmail = formatSystemEmail(sampleUser, subject, body);
    
    allUI.messagePreview.textContent = formattedEmail;
    allUI.messagePreviewSection.classList.remove('hidden');
}

async function sendSystemMessage() {
    // Check if user is authenticated
    if (!currentUser || !auth.currentUser) {
        showMessageStatus('You must be logged in to send messages.', 'error');
        return;
    }
    
    // Additional authentication validation
    console.log('Current user UID:', currentUser.uid);
    console.log('Auth current user UID:', auth.currentUser?.uid);
    console.log('Auth current user token available:', !!auth.currentUser);
    
    // Check if user is admin
    const ADMIN_UIDS = ['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2'];
    if (!ADMIN_UIDS.includes(currentUser.uid)) {
        showMessageStatus('Access denied: Admin privileges required.', 'error');
        return;
    }
    
    const subject = allUI.messageSubject.value.trim();
    const body = allUI.messageBody.value.trim();
    
    if (!subject || !body) {
        showMessageStatus('Please enter both subject and message body.', 'error');
        return;
    }
    
    const weekNumber = allUI.adminWeekSelector ? allUI.adminWeekSelector.value : getCurrentWeek();
    const recipientType = allUI.messageRecipients.value;
    
    showMessageStatus('Preparing to send messages...', 'info');
    allUI.sendMessageBtn.disabled = true;
    
    try {
        const recipients = await getFilteredRecipients(recipientType, weekNumber);
        
        if (recipients.length === 0) {
            showMessageStatus('No recipients found for the selected criteria.', 'error');
            allUI.sendMessageBtn.disabled = false;
            return;
        }
        
        // Call Cloud Function to send emails
        showMessageStatus(`Sending emails to ${recipients.length} recipients...`, 'info');
        
        // Create the callable function with explicit app context
        const sendSystemMessageFn = httpsCallable(functions, 'sendSystemMessage');
        
        // Ensure user token is fresh before calling Cloud Function
        let idToken;
        try {
            console.log('Refreshing auth token...');
            idToken = await auth.currentUser.getIdToken(true); // Force token refresh
            console.log('Token refreshed successfully, token length:', idToken.length);
        } catch (tokenError) {
            console.error('Failed to refresh auth token:', tokenError);
            showMessageStatus('Authentication error. Please try logging out and back in.', 'error');
            allUI.sendMessageBtn.disabled = false;
            return;
        }
        
        // Additional validation - check if the user is still properly authenticated
        if (!auth.currentUser || !idToken) {
            console.error('User not authenticated after token refresh');
            showMessageStatus('Authentication failed. Please try logging out and back in.', 'error');
            allUI.sendMessageBtn.disabled = false;
            return;
        }
        
        // Small delay to ensure token propagation
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            console.log('Calling Cloud Function sendSystemMessage...');
            console.log('Recipients count:', recipients.length);
            console.log('Subject:', subject);
            
            const result = await sendSystemMessageFn({
                recipients: recipients.map(user => ({
                    email: user.email,
                    displayName: user.displayName || user.email,
                    id: user.id
                })),
                subject: subject,
                body: body
            });
            
            console.log('Cloud Function call successful:', result);
            
            const { successCount, failCount, failed } = result.data;
            
            let message = `Successfully sent ${successCount} email${successCount !== 1 ? 's' : ''}.`;
            
            if (failCount > 0) {
                const failedEmails = failed.map(f => `${f.email}: ${f.error}`).join('\n');
                message += `\n\n${failCount} email${failCount !== 1 ? 's' : ''} failed:\n${failedEmails}`;
                showMessageStatus(message, 'warning');
            } else {
                showMessageStatus(message, 'success');
            }
            
        } catch (error) {
            console.error('Error calling sendSystemMessage function:', error);
            showMessageStatus(`Error sending emails: ${error.message}`, 'error');
        }
        
        // Clear form
        allUI.messageSubject.value = '';
        allUI.messageBody.value = '';
        allUI.messagePreviewSection.classList.add('hidden');
        
    } catch (error) {
        console.error('Error sending system messages:', error);
        showMessageStatus(`Error: ${error.message}`, 'error');
    } finally {
        allUI.sendMessageBtn.disabled = false;
    }
}

function formatSystemEmail(user, subject, body) {
    const displayName = user.displayName || 'Nerd';
    
    return `Dear Nerd ${displayName},

${body}

Ållfåther Nerd

---
This message was sent from NerdFootball AI System
Reply to: hello@nerdfootball.com`;
}

function showMessageStatus(message, type) {
    const statusColors = {
        'success': 'bg-green-100 text-green-800 border border-green-200',
        'error': 'bg-red-100 text-red-800 border border-red-200',
        'warning': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        'info': 'bg-blue-100 text-blue-800 border border-blue-200'
    };
    
    allUI.messageStatusContent.className = `p-4 rounded-md ${statusColors[type] || statusColors.info}`;
    allUI.messageStatusContent.textContent = message;
    allUI.messageStatus.classList.remove('hidden');
    
    // Auto-hide after 10 seconds for success/info
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            allUI.messageStatus.classList.add('hidden');
        }, 10000);
    }
}

async function calculateWeeklyLeaderboard(weekNumber) {
    const results = await getResultsForWeek(weekNumber);
    if (!results || Object.keys(results).length === 0) {
        return [];
    }
    
    const scores = [];
    
    for (const user of allUsers) {
        const userDocRef = doc(db, picksPath(weekNumber, user.id));
        const userSnap = await getDoc(userDocRef);
        const userData = userSnap.exists() ? userSnap.data() : {};
        const userPicks = userData.picks || {};
        
        let score = 0;
        
        Object.keys(results).forEach(gameId => {
            const result = results[gameId];
            const pick = userPicks[gameId];
            
            if (pick && pick.team === result.winner) {
                score += pick.confidence || 1;
            }
        });
        
        scores.push({
            userId: user.id,
            displayName: user.displayName || user.email,
            score: score
        });
    }
    
    return scores.sort((a, b) => b.score - a.score);
}


 async function renderAdminView(weekNumber) {
 const activeTab = document.querySelector('.admin-tab.active').id;
 switch (activeTab) {
 case 'tab-game-results': await renderGameResultsAdmin(weekNumber); break;
 case 'tab-user-mgmt': renderUserManagement(); break;
 case 'tab-picks-mgmt': await renderPicksManagement(weekNumber); break;
 case 'tab-survivor-status': await renderSurvivorStatus(weekNumber); break;
case 'tab-system-messenger': await renderSystemMessenger(weekNumber); break;
 }
 }

 // --- INITIALIZATION & AUTH ---
 async function initializeAppAndAuth() {
 const firebaseConfig = {
 apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
 authDomain: "nerdfootball.firebaseapp.com",
 projectId: "nerdfootball",
 storageBucket: "nerdfootball.appspot.com",
 messagingSenderId: "969304790725",
 appId: "1:969304790725:web:892df38db0b0e62bde02ac",
 measurementId: "G-8RVRHE3HRC"
 };
 const app = initializeApp(firebaseConfig);
 db = getFirestore(app);
 auth = getAuth(app);
 functions = getFunctions(app, 'us-central1'); // Initialize global functions variable with region
 onAuthStateChanged(auth, handleAuthStateChange);
 
 // Register service worker for caching
 if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
   .then(registration => {
    console.log('ServiceWorker registration successful');
    
    // Check for updates every 30 seconds
    setInterval(() => {
     registration.update();
    }, 30000);
    
    // Listen for new service worker
    registration.addEventListener('updatefound', () => {
     const newWorker = registration.installing;
     newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
       // New version available, prompt user to refresh
       if (confirm('New version available! Click OK to update.')) {
        newWorker.postMessage({ type: 'SKIP_WAITING' });
        window.location.reload();
       }
      }
     });
    });
   })
   .catch(error => console.log('ServiceWorker registration failed: ', error));
 }
 }

 async function handleAuthStateChange(user) {
 const savedState = loadAppState();
 
 if (user) {
 const userDocRef = doc(db, usersPath(), user.uid);
 const userDoc = await getDoc(userDocRef);

 if (userDoc.exists() && userDoc.data().disabled) {
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.remove('hidden');
 allUI.loginError.textContent = 'Your account has been disabled.';
 allUI.loginError.classList.remove('hidden');
 await signOut(auth);
 return;
 }
 
 // Check if email was recently verified and update Firestore
 const pendingEmail = localStorage.getItem('pendingEmailChange');
 if (pendingEmail && user.email === pendingEmail) {
  try {
   await updateDoc(userDocRef, {
    email: user.email,
    emailVerified: true,
    lastUpdated: new Date().toISOString()
   });
   localStorage.removeItem('pendingEmailChange');
   console.log('Email verification completed and Firestore updated');
  } catch (error) {
   console.error('Error updating email in Firestore after verification:', error);
  }
 }
 
 currentUser = user;
 currentWeek = savedState.currentWeek;
 
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.add('hidden');
 allUI.appView.classList.remove('hidden');
 allUI.userDisplay.textContent = `Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;

 await setDoc(userDocRef, { displayName: user.displayName, email: user.email }, { merge: true });

 if (ADMIN_UIDS.includes(user.uid)) {
 allUI.menuAdminControls.classList.remove('hidden');
 await fetchAllUsers();
 }
 
 populateWeekSelectors();
 allUI.weekSelector.value = currentWeek;
 allUI.adminWeekSelector.value = currentWeek;
 allUI.lbWeekSelector.value = currentWeek;

 await loadAndRenderWeek(currentWeek);
 if (ADMIN_UIDS.includes(user.uid)) {
 await renderAdminView(currentWeek);
 }

 // Restore saved view state
 if (savedState.leaderboardView === 'season') {
  allUI.lbSeasonBtn.click();
 }
 
 switch (savedState.currentView) {
  case 'admin':
   if (ADMIN_UIDS.includes(user.uid)) {
    allUI.adminViewBtn.click();
   } else {
    allUI.picksViewBtn.click();
   }
   break;
  case 'leaderboard':
   allUI.leaderboardViewBtn.click();
   break;
  case 'picks':
  default:
   allUI.picksViewBtn.click();
 }

 } else {
 currentUser = null;
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.remove('hidden');
 allUI.appView.classList.add('hidden');
 }
 }
 
 // --- FORM TOGGLING ---
 allUI.showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); allUI.loginForm.classList.add('hidden'); allUI.registerForm.classList.remove('hidden'); });
 allUI.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); allUI.registerForm.classList.add('hidden'); allUI.loginForm.classList.remove('hidden'); });

 // --- AUTH EVENT LISTENERS ---
 allUI.loginForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const email = document.getElementById('login-email').value;
 const password = document.getElementById('login-password').value;
 try {
 await signInWithEmailAndPassword(auth, email, password);
 allUI.loginError.classList.add('hidden');
 } catch (error) {
 allUI.loginError.innerHTML = getAuthErrorMessage(error.code);
 allUI.loginError.classList.remove('hidden');
 }
 });

 allUI.registerForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const firstName = document.getElementById('register-firstname').value;
 const lastName = document.getElementById('register-lastname').value;
 const email = document.getElementById('register-email').value;
 const password = document.getElementById('register-password').value;
 const confirmPassword = document.getElementById('register-confirm-password').value;

 if (password !== confirmPassword) {
 allUI.registerError.textContent = "Passwords do not match.";
 allUI.registerError.classList.remove('hidden');
 return;
 }
 
 try {
 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
 await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
 allUI.registerError.classList.add('hidden');
 } catch (error) {
 allUI.registerError.innerHTML = getAuthErrorMessage(error.code);
 allUI.registerError.classList.remove('hidden');
 }
 });

 allUI.logoutBtn.addEventListener('click', () => {
    signOut(auth);
    allUI.menuPanel.classList.add('hidden');
 });

 // OAuth event listeners
 allUI.googleSigninBtn.addEventListener('click', handleGoogleSignIn);
 allUI.googleSignupBtn.addEventListener('click', handleGoogleSignIn);
 
 // Account linking modal event listeners
 allUI.cancelLinkingBtn.addEventListener('click', hideAccountLinkingDialog);
 allUI.confirmLinkingBtn.addEventListener('click', linkAccountWithGoogle);
 
 // Password prompt modal event listeners
 allUI.cancelPasswordPromptBtn.addEventListener('click', () => {
  hidePasswordPrompt();
  pendingCredential = null;
  pendingEmail = null;
 });
 allUI.confirmPasswordPromptBtn.addEventListener('click', async () => {
  const password = allUI.passwordPromptInput.value;
  if (password && pendingEmail) {
   await completeAccountLinking(pendingEmail, password);
  }
 });
 
 // Allow Enter key to submit password
 allUI.passwordPromptInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
   allUI.confirmPasswordPromptBtn.click();
  }
 });
 
 // In-app account linking event listeners
 allUI.linkGoogleBtn.addEventListener('click', linkGoogleAccountInApp);
 allUI.unlinkGoogleBtn.addEventListener('click', unlinkGoogleAccount);
 
 // Email verification event listener
 allUI.resendVerificationBtn.addEventListener('click', async () => {
  const pendingEmail = localStorage.getItem('pendingEmailChange');
  if (pendingEmail && auth.currentUser) {
   await attemptEmailChange(pendingEmail);
  } else {
   showSettingsError('No pending email change found.');
   allUI.emailVerificationStatus.classList.add('hidden');
  }
 });

 // Additional email verification event listeners
 allUI.tryDifferentMethodBtn.addEventListener('click', () => {
  allUI.passwordReauthSection.classList.remove('hidden');
  allUI.reauthPassword.focus();
 });

 allUI.confirmEmailChangeBtn.addEventListener('click', async () => {
  const pendingEmail = localStorage.getItem('pendingEmailChange');
  const password = allUI.reauthPassword.value;
  
  if (!password) {
   showSettingsError('Please enter your current password.');
   return;
  }
  
  if (pendingEmail) {
   await attemptDirectEmailChange(pendingEmail, password);
  } else {
   showSettingsError('No pending email change found.');
  }
 });

 allUI.cancelEmailChangeBtn.addEventListener('click', () => {
  localStorage.removeItem('pendingEmailChange');
  allUI.emailVerificationStatus.classList.add('hidden');
  allUI.passwordReauthSection.classList.add('hidden');
  allUI.reauthPassword.value = '';
  allUI.settingsError.classList.add('hidden');
 });
 
 function getAuthErrorMessage(errorCode) {
 switch (errorCode) {
 case 'auth/operation-not-allowed':
 return '<strong>Action Required:</strong><br>Email/Password sign-in is not enabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.';
 case 'auth/invalid-email': 
 return 'Please enter a valid email address.';
 case 'auth/user-not-found':
 case 'auth/wrong-password': 
 return 'Invalid email or password.';
 case 'auth/email-already-in-use': 
 return 'An account with this email already exists.';
 case 'auth/weak-password': 
 return 'Password should be at least 6 characters.';
 default: 
 return 'An unexpected error occurred. Please try again.';
 }
 }

 // --- GOOGLE OAUTH IMPLEMENTATION ---
 let pendingCredential = null;
 let pendingEmail = null;

 async function handleGoogleSignIn() {
  const provider = new GoogleAuthProvider();
  provider.addScope('email');
  provider.addScope('profile');
  
  try {
   const result = await signInWithPopup(auth, provider);
   // New user or existing Google account - proceed normally
   console.log('Google sign-in successful:', result.user);
  } catch (error) {
   if (error.code === 'auth/account-exists-with-different-credential') {
    // Account exists with different credential (email/password)
    pendingCredential = GoogleAuthProvider.credentialFromError(error);
    pendingEmail = error.customData.email;
    
    // Check if there are existing sign-in methods for this email
    try {
     const methods = await fetchSignInMethodsForEmail(auth, pendingEmail);
     if (methods.length > 0 && methods.includes('password')) {
      // Show account linking dialog
      showAccountLinkingDialog(pendingEmail);
      return;
     }
    } catch (fetchError) {
     console.error('Error fetching sign-in methods:', fetchError);
    }
   } else if (error.code === 'auth/popup-cancelled-by-user') {
    // User cancelled the popup - no action needed
    return;
   } else if (error.code === 'auth/popup-blocked') {
    showAuthError('Popup was blocked by your browser. Please allow popups and try again.');
   } else {
    console.error('Google sign-in error:', error);
    showAuthError('Failed to sign in with Google. Please try again.');
   }
  }
 }

 async function linkAccountWithGoogle() {
  if (!pendingCredential || !pendingEmail) {
   console.error('No pending credential found');
   return;
  }

  try {
   // First, sign in the user with email/password to get existing account
   const methods = await fetchSignInMethodsForEmail(auth, pendingEmail);
   
   if (methods.includes('password')) {
    // Hide the linking modal temporarily and show password prompt
    hideAccountLinkingDialog();
    showPasswordPromptForLinking(pendingEmail);
   } else {
    throw new Error('Cannot link: no password method available');
   }
   
  } catch (error) {
   console.error('Account linking error:', error);
   hideAccountLinkingDialog();
   showAuthError('Failed to link accounts. Please try again.');
  }
 }

 async function completeAccountLinking(email, password) {
  try {
   // Sign in with email/password first
   const userCredential = await signInWithEmailAndPassword(auth, email, password);
   const user = userCredential.user;
   
   // Now link the Google credential
   await linkWithCredential(user, pendingCredential);
   
   // Update user profile to mark Google as primary auth method
   await updateUserAuthMethod(user.uid, 'google');
   
   console.log('Account successfully linked with Google');
   
   // Clear pending data
   pendingCredential = null;
   pendingEmail = null;
   
   // Hide any password prompts
   hidePasswordPrompt();
   
  } catch (error) {
   console.error('Account linking completion error:', error);
   
   if (error.code === 'auth/wrong-password') {
    showPasswordError('Incorrect password. Please try again.');
   } else if (error.code === 'auth/credential-already-in-use') {
    showPasswordError('This Google account is already linked to another user.');
   } else {
    showPasswordError('Failed to link accounts. Please try again.');
   }
  }
 }

 async function updateUserAuthMethod(uid, primaryMethod) {
  try {
   const userDocRef = doc(db, usersPath(), uid);
   await updateDoc(userDocRef, {
    primaryAuthMethod: primaryMethod,
    authMethods: {
     google: primaryMethod === 'google',
     emailPassword: true
    },
    lastUpdated: new Date().toISOString()
   });
  } catch (error) {
   console.error('Error updating user auth method:', error);
  }
 }

 function showAccountLinkingDialog(email) {
  allUI.linkingEmail.textContent = email;
  allUI.accountLinkingModal.classList.remove('hidden');
 }

 function hideAccountLinkingDialog() {
  allUI.accountLinkingModal.classList.add('hidden');
  pendingCredential = null;
  pendingEmail = null;
 }

 function showAuthError(message) {
  const isLoginForm = !allUI.loginForm.classList.contains('hidden');
  const errorElement = isLoginForm ? allUI.loginError : allUI.registerError;
  
  errorElement.innerHTML = message;
  errorElement.classList.remove('hidden');
 }

 function showPasswordPromptForLinking(email) {
  allUI.passwordPromptEmail.textContent = email;
  allUI.passwordPromptInput.value = '';
  allUI.passwordPromptError.classList.add('hidden');
  allUI.passwordLinkingModal.classList.remove('hidden');
 }

 function hidePasswordPrompt() {
  allUI.passwordLinkingModal.classList.add('hidden');
  allUI.passwordPromptInput.value = '';
  allUI.passwordPromptError.classList.add('hidden');
 }

 function showPasswordError(message) {
  allUI.passwordPromptError.innerHTML = message;
  allUI.passwordPromptError.classList.remove('hidden');
 }

 // --- IN-APP ACCOUNT LINKING ---
 async function linkGoogleAccountInApp() {
  if (!currentUser || !auth.currentUser) {
   showSettingsError('Please refresh the page and try again.');
   return;
  }

  const provider = new GoogleAuthProvider();
  provider.addScope('email');
  provider.addScope('profile');
  
  try {
   // Directly link the Google provider to the current user
   await linkWithCredential(auth.currentUser, GoogleAuthProvider.credential());
   
  } catch (error) {
   // If direct link fails, try popup approach
   try {
    const result = await signInWithPopup(auth, provider);
    
    // If popup succeeded but didn't link (user signed in with Google instead)
    if (result.user.email === currentUser.email) {
     // Same email - accounts are now linked
     await updateUserAuthMethod(result.user.uid, 'google');
     await updateGoogleLinkingUI(true);
     showSettingsSuccess('Google account linked successfully! You can now sign in with Google.');
    } else {
     // Different email - sign out and show error
     await signOut(auth);
     showSettingsError('The Google account email does not match your current account.');
     // The user will be signed back in via onAuthStateChanged
    }
    
   } catch (popupError) {
    if (popupError.code === 'auth/popup-cancelled-by-user') {
     return; // User cancelled
    } else if (popupError.code === 'auth/popup-blocked') {
     showSettingsError('Popup was blocked. Please allow popups and try again.');
    } else if (popupError.code === 'auth/account-exists-with-different-credential') {
     showSettingsError('This Google account is already associated with a different user.');
    } else if (popupError.code === 'auth/credential-already-in-use') {
     showSettingsError('This Google account is already linked to another user.');
    } else {
     console.error('Google linking popup error:', popupError);
     showSettingsError('Failed to link Google account. Please try again.');
    }
   }
  }
 }

 async function unlinkGoogleAccount() {
  if (!currentUser) {
   console.error('No current user for unlinking');
   return;
  }

  try {
   const user = auth.currentUser;
   await user.unlink(GoogleAuthProvider.PROVIDER_ID);
   
   // Update user profile to remove Google as primary auth method
   await updateUserAuthMethod(user.uid, 'email');
   await updateGoogleLinkingUI(false);
   showSettingsSuccess('Google account unlinked successfully.');
   
  } catch (error) {
   console.error('Unlinking error:', error);
   if (error.code === 'auth/no-such-provider') {
    showSettingsError('Google account is not linked to this account.');
   } else {
    showSettingsError('Failed to unlink Google account. Please try again.');
   }
  }
 }

 async function updateGoogleLinkingUI(isLinked) {
  if (isLinked) {
   allUI.googleNotLinked.classList.add('hidden');
   allUI.googleLinked.classList.remove('hidden');
  } else {
   allUI.googleLinked.classList.add('hidden');
   allUI.googleNotLinked.classList.remove('hidden');
  }
 }

 async function checkGoogleLinkingStatus() {
  if (!currentUser) return;
  
  try {
   const user = auth.currentUser;
   const isGoogleLinked = user.providerData.some(provider => provider.providerId === 'google.com');
   await updateGoogleLinkingUI(isGoogleLinked);
  } catch (error) {
   console.error('Error checking Google linking status:', error);
  }
 }

 function showSettingsSuccess(message) {
  allUI.settingsSuccess.textContent = message;
  allUI.settingsSuccess.classList.remove('hidden');
  allUI.settingsError.classList.add('hidden');
 }

 function showSettingsError(message) {
  allUI.settingsError.textContent = message;
  allUI.settingsError.classList.remove('hidden');
  allUI.settingsSuccess.classList.add('hidden');
 }

 // --- EMAIL CHANGE METHODS ---
 async function attemptEmailChange(newEmail) {
  allUI.emailChangeStatus.innerHTML = `Attempting to send verification email to <span class="font-medium">${newEmail}</span>...`;
  
  // Method 1: Try verifyBeforeUpdateEmail
  try {
   console.log('Method 1: Attempting verifyBeforeUpdateEmail');
   await verifyBeforeUpdateEmail(auth.currentUser, newEmail);
   
   allUI.emailChangeStatus.innerHTML = `Verification email sent to <span class="font-medium">${newEmail}</span>! Please check your inbox and spam folder.`;
   allUI.resendVerificationBtn.classList.remove('hidden');
   allUI.settingsSuccess.textContent = 'Display name updated. Please check your email to verify your new email address.';
   allUI.settingsSuccess.classList.remove('hidden');
   return; // Success!
   
  } catch (error1) {
   console.log('Method 1 failed:', error1);
   
   // Method 2: Try direct updateEmail after user reauthentication
   allUI.emailChangeStatus.innerHTML = `Standard email verification not available. <span class="font-medium">Please use the alternative method below.</span>`;
   allUI.tryDifferentMethodBtn.classList.remove('hidden');
   allUI.settingsError.textContent = 'Standard email verification is not configured. Please use the alternative method below.';
   allUI.settingsError.classList.remove('hidden');
  }
 }

 async function attemptDirectEmailChange(newEmail, password) {
  try {
   // Step 1: Reauthenticate user
   console.log('Reauthenticating user for email change');
   const credential = EmailAuthProvider.credential(currentUser.email, password);
   await reauthenticateWithCredential(auth.currentUser, credential);
   
   // Step 2: Update email directly
   console.log('Updating email directly to:', newEmail);
   await updateEmail(auth.currentUser, newEmail);
   
   // Step 3: Update Firestore
   const userDocRef = doc(db, usersPath(), currentUser.uid);
   await updateDoc(userDocRef, {
    email: newEmail,
    lastUpdated: new Date().toISOString()
   });
   
   // Success!
   localStorage.removeItem('pendingEmailChange');
   allUI.emailVerificationStatus.classList.add('hidden');
   allUI.passwordReauthSection.classList.add('hidden');
   allUI.settingsSuccess.textContent = 'Email address updated successfully!';
   allUI.settingsSuccess.classList.remove('hidden');
   allUI.settingsError.classList.add('hidden');
   
   // Update the email field to reflect the change
   allUI.settingsEmail.value = newEmail;
   
   setTimeout(() => {
    allUI.settingsModal.classList.add('hidden');
    allUI.settingsModal.classList.remove('flex');
   }, 2000);
   
  } catch (error) {
   console.error('Direct email change failed:', error);
   let errorMsg = 'Failed to change email address.';
   
   if (error.code === 'auth/wrong-password') {
    errorMsg = 'Incorrect password. Please try again.';
   } else if (error.code === 'auth/email-already-in-use') {
    errorMsg = 'This email address is already in use by another account.';
   } else if (error.code === 'auth/invalid-email') {
    errorMsg = 'Please enter a valid email address.';
   } else if (error.code === 'auth/requires-recent-login') {
    errorMsg = 'Please log out and log back in, then try again.';
   } else {
    errorMsg = `Error: ${error.message}`;
   }
   
   showSettingsError(errorMsg);
  }
 }
 
 // --- DATA PATH HELPERS ---
 const appId = () => 'nerdfootball'; 
 const picksPath = (week, uid) => `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions/${uid}`;
 const resultsPath = (week) => `artifacts/${appId()}/public/data/nerdfootball_results/${week}`;
 const usersPath = () => `artifacts/${appId()}/public/data/nerdfootball_users`;
 const survivorPicksPath = (uid) => `artifacts/${appId()}/public/data/nerdSurvivor_picks/${uid}`;
 const survivorStatusPath = () => `artifacts/${appId()}/public/data/nerdSurvivor_status/status`;


 
 // --- SAVE STATUS ---
 function updateSaveStatus(status, message) {
 if(saveTimeout) clearTimeout(saveTimeout);
 allUI.saveStatusIcon.style.animation = 'none';
 
 switch(status) {
 case 'saving':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusIcon.style.animation = 'spin 1s linear infinite';
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-gray-500';
 break;
 case 'saved':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-green-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 2500);
 break;
 case 'error':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-red-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 3000);
 break;
 case 'idle':
 default:
 allUI.saveStatusIcon.innerHTML = '';
 allUI.saveStatusText.textContent = '';
 break;
 }
 }

 // Check if individual game is locked (started)
 function isGameLocked(game) {
  const gameTime = new Date(game.kickoff);
  return new Date() > gameTime;
 }

 // Get locked games for a week
 async function getLockedGames(weekNumber) {
  const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) }; 
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) return new Set(); 
  const lockedGameIds = new Set();
  weekData.games.forEach(game => {
   if (isGameLocked(game)) {
    lockedGameIds.add(game.id);
   }
  });
  return lockedGameIds;
 }

 // Legacy function for backwards compatibility
 async function getWeekLockStatus(weekNumber) { 
  const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) }; 
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) return false; 
  const firstKickoff = new Date(weekData.games[0].kickoff); 
  return new Date() > firstKickoff; 
 }

 // Helper function to identify Monday Night Football games
 function getMondayNightGame(games) {
   if (!games || !Array.isArray(games)) return null;
   
   // Find all games that occur on Monday (day of week = 1)
   const mondayGames = games.filter(game => {
     const gameTime = new Date(game.kickoff);
     return gameTime.getDay() === 1; // Monday
   });
   
   // If multiple Monday games, return the latest one (last game of the week)
   if (mondayGames.length > 1) {
     return mondayGames.reduce((latest, current) => {
       const latestTime = new Date(latest.kickoff);
       const currentTime = new Date(current.kickoff);
       return currentTime > latestTime ? current : latest;
     });
   }
   
   return mondayGames.length > 0 ? mondayGames[0] : null;
 }

 // Helper function to extract winner from game result (handles both old and new formats)
 function getGameWinner(gameResult) {
   if (!gameResult) return null;
   
   // Handle legacy format (just winner string)
   if (typeof gameResult === 'string') {
     return gameResult;
   }
   
   // Handle new format (object with winner and scores)
   if (typeof gameResult === 'object' && gameResult.winner) {
     return gameResult.winner;
   }
   
   return null;
 }

 // Helper function to calculate total points scored in a game
 function calculateGameTotalPoints(gameResult) {
   if (!gameResult) return null;
   
   // Handle legacy format (just winner string)
   if (typeof gameResult === 'string') {
     return null; // Can't calculate total from just winner
   }
   
   // Handle new format (object with scores)
   if (typeof gameResult === 'object') {
     const homeScore = parseInt(gameResult.homeScore) || 0;
     const awayScore = parseInt(gameResult.awayScore) || 0;
     
     // Only return total if both scores are available and valid
     if (gameResult.homeScore !== null && gameResult.awayScore !== null) {
       return homeScore + awayScore;
     }
   }
   
   return null;
 }

 // Sort leaderboard with Monday Night Football tiebreaker logic
 async function sortLeaderboardWithTiebreaker(scores, weekNumber, scoreField = 'score') {
   if (!weekNumber) {
     // For season totals, just sort by score descending
     return scores.sort((a, b) => b[scoreField] - a[scoreField]);
   }
   
   // Get week data and identify Monday Night game
   const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
   const mondayNightGame = getMondayNightGame(weekData.games);
   
   if (!mondayNightGame) {
     // No Monday Night game, use regular sorting
     return scores.sort((a, b) => b[scoreField] - a[scoreField]);
   }
   
   // Get game results and MNF actual total
   const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
   const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
   const mnfResult = gameResults[mondayNightGame.id];
   const mnfActualTotal = mnfResult ? calculateGameTotalPoints(mnfResult) : null;
   
   // Get all users' picks to access MNF guesses
   const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
   const userMnfGuesses = {};
   picksSnap.forEach(pickDoc => {
     const userPicks = pickDoc.data();
     if (userPicks.mnfTotalPoints) {
       userMnfGuesses[pickDoc.id] = parseInt(userPicks.mnfTotalPoints, 10);
     }
   });
   
   // Sort with tiebreaker logic
   return scores.sort((a, b) => {
     // First, sort by confidence points score (descending)
     const scoreDiff = b[scoreField] - a[scoreField];
     if (scoreDiff !== 0) return scoreDiff;
     
     // If scores are tied and MNF game has results, apply tiebreaker
     if (mnfActualTotal !== null) {
       const aGuess = userMnfGuesses[a.uid || a.userId] || 0;
       const bGuess = userMnfGuesses[b.uid || b.userId] || 0;
       
       // Filter out guesses that go over
       const aValid = aGuess <= mnfActualTotal;
       const bValid = bGuess <= mnfActualTotal;
       
       // If one guess is valid and other is over, valid guess wins
       if (aValid && !bValid) return -1;
       if (bValid && !aValid) return 1;
       
       // If both valid or both invalid, closest to actual wins
       const aDiff = Math.abs(mnfActualTotal - aGuess);
       const bDiff = Math.abs(mnfActualTotal - bGuess);
       
       if (aValid && bValid) {
         // Both under or equal - closest wins
         return aDiff - bDiff;
       } else {
         // Both over - still closest wins, but they're both losers
         return aDiff - bDiff;
       }
     }
     
     // No tiebreaker available, maintain original order
     return 0;
   });
 }

 // Render leaderboard rows with tiebreaker information
 async function renderLeaderboardRows(sortedScores, weekNumber, scoreField = 'score') {
   if (!sortedScores || sortedScores.length === 0) return '';
   
   let mnfActualTotal = null;
   let userMnfGuesses = {};
   let mondayNightGame = null;
   
   // Get MNF info if this is a weekly leaderboard
   if (weekNumber) {
     const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
     mondayNightGame = getMondayNightGame(weekData.games);
     
     if (mondayNightGame) {
       // Get game results and MNF actual total
       const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
       const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
       const mnfResult = gameResults[mondayNightGame.id];
       mnfActualTotal = mnfResult ? calculateGameTotalPoints(mnfResult) : null;
       
       // Get all users' MNF guesses
       const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
       picksSnap.forEach(pickDoc => {
         const userPicks = pickDoc.data();
         if (userPicks.mnfTotalPoints) {
           userMnfGuesses[pickDoc.id] = parseInt(userPicks.mnfTotalPoints, 10);
         }
       });
     }
   }
   
   return sortedScores.map((s, index) => {
     const score = s[scoreField];
     
     // Check if this user is tied with next user (for tiebreaker display)
     const nextUser = sortedScores[index + 1];
     const isTied = nextUser && nextUser[scoreField] === score;
     const prevUser = sortedScores[index - 1];
     const wasTied = prevUser && prevUser[scoreField] === score;
     
     let tiebreakerInfo = '';
     if ((isTied || wasTied) && mondayNightGame && mnfActualTotal !== null) {
       const userGuess = userMnfGuesses[s.uid || s.userId] || 'N/A';
       const validGuess = userGuess !== 'N/A' && userGuess <= mnfActualTotal;
       const difference = userGuess !== 'N/A' ? Math.abs(mnfActualTotal - userGuess) : 'N/A';
       
       tiebreakerInfo = `
         <div class="text-xs text-blue-600 mt-1">
           MNF Guess: ${userGuess} (Actual: ${mnfActualTotal}, Diff: ${difference})
           ${validGuess ? '✓' : userGuess !== 'N/A' ? '✗ Over' : '✗ Missing'}
         </div>
       `;
     }
     
     return `
       <tr class="${(isTied || wasTied) ? 'bg-yellow-50' : ''}">
         <td class="px-6 py-4 whitespace-nowrap font-medium">${index + 1}</td>
         <td class="px-6 py-4 whitespace-nowrap">
           ${s.displayName}
           ${tiebreakerInfo}
         </td>
         <td class="px-6 py-4 whitespace-nowrap font-bold">${score}</td>
       </tr>
     `;
   }).join('');
 }
 
 async function loadAndRenderWeek(weekNumber) { 
 currentWeek = parseInt(weekNumber, 10);
 if (!currentUser) return; 
 if (unsubscribeFromPicks) unsubscribeFromPicks(); 
 updateSaveStatus('idle');

 allUI.gameList.innerHTML = `<div class="loader"></div>`;
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 allUI.resetPicksBtn.disabled = weekIsLocked;
 
 const docRef = doc(db, picksPath(currentWeek, currentUser.uid)); 
 
 const games = await getGamesForWeek(currentWeek);
 if (!Array.isArray(games) || games.length === 0) {
     allUI.gameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week. Please try again later.</p>';
     return;
 }

 unsubscribeFromPicks = onSnapshot(docRef, (docSnap) => { 
 let userPicks = {}; 
 const weekData = { week: currentWeek, games: games };

 if (docSnap.exists()) { 
 userPicks = docSnap.data(); 
 } else { 
 weekData.games.forEach((game, index) => { 
 userPicks[game.id] = { winner: null, confidence: index + 1 }; 
 }); 
 } 
 renderWeekUI(weekData, userPicks, weekIsLocked, allUI.gameList); 
 // Update picks summary if picks view is active
 if (!allUI.picksSummaryContainer.classList.contains('hidden')) {
  renderActivePicksSummary();
 }
 }); 
 }

 async function savePicksToFirestore(weekNum, picks) { 
  if (!currentUser) return; 
  updateSaveStatus('saving', 'Validating picks...');

  // Get current week games and check which ones are locked
  const weekData = { week: weekNum, games: await getGamesForWeek(weekNum) };
  if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) {
   updateSaveStatus('error', 'No games found');
   return;
  }

  // Get current picks from database
  const docRef = doc(db, picksPath(weekNum, currentUser.uid));
  const currentDoc = await getDoc(docRef);
  const currentPicks = currentDoc.exists() ? currentDoc.data() : {};

  // Validate each pick - only allow changes to games that haven't started
  const validatedPicks = { ...currentPicks };
  const lockedGames = [];
  const validChanges = [];
  const submissionTime = new Date().toISOString();

  weekData.games.forEach(game => {
   const gameId = game.id.toString();
   const isLocked = isGameLocked(game);
   
   if (picks[gameId]) {
    if (isLocked) {
     // Game has started - keep existing pick, reject new one
     lockedGames.push(`${game.away} @ ${game.home}`);
    } else {
     // Game hasn't started - allow change
     validatedPicks[gameId] = picks[gameId];
     if (picks[gameId].winner) {
      validChanges.push({
       game: `${game.away} @ ${game.home}`,
       pick: picks[gameId].winner,
       confidence: picks[gameId].confidence,
       gameTime: game.kickoff
      });
     }
    }
   }
  });

  try { 
   await setDoc(docRef, validatedPicks); 
   
   let statusMessage = 'Picks Saved!';
   if (lockedGames.length > 0) {
    statusMessage = `Saved! ${lockedGames.length} locked games skipped`;
    console.warn('Locked games skipped:', lockedGames);
   }
   
   updateSaveStatus('saved', statusMessage);
   
   // Send email confirmation if there were valid changes
   if (validChanges.length > 0) {
    await sendPickConfirmationEmail(currentUser.email, validChanges, submissionTime, weekNum);
   }
   
   // Invalidate leaderboard cache since picks changed
   invalidateCache('leaderboard');
   
   // Update picks summary if picks view is active
   if (!allUI.picksSummaryContainer.classList.contains('hidden')) {
    await renderActivePicksSummary();
   }
  } catch (error) { 
   console.error("Error saving picks:", error); 
   updateSaveStatus('error', 'Save Failed');
  } 
 }

 // Email confirmation function
 async function sendPickConfirmationEmail(userEmail, validChanges, submissionTime, weekNumber) {
  try {
   // Call Cloud Function to send pick confirmation email
   const sendPickConfirmationFn = httpsCallable(functions, 'sendPickConfirmation');
   
   // Ensure user token is fresh before calling Cloud Function
   if (auth.currentUser) {
    try {
     await auth.currentUser.getIdToken(true); // Force token refresh
    } catch (tokenError) {
     console.error('Failed to refresh auth token for pick confirmation:', tokenError);
     // Continue anyway for pick confirmation as it's less critical
    }
   }
   
   const userName = currentUser?.displayName || currentUser?.email || 'Nerd';
   
   const result = await sendPickConfirmationFn({
    userEmail: userEmail,
    userName: userName,
    picks: validChanges,
    weekNumber: weekNumber
   });
   
   if (result.data.success) {
    console.log('Pick confirmation email sent successfully');
   } else {
    console.error('Failed to send pick confirmation email:', result.data.error);
   }
   
  } catch (error) {
   console.error('Error sending confirmation email:', error);
  }
 }

 function generatePickConfirmationEmail(validChanges, submissionTime, weekNumber) {
  const formattedTime = new Date(submissionTime).toLocaleString();
  
  let emailContent = `NerdFootball Pick Confirmation - Week ${weekNumber}\n`;
  emailContent += `Submission Time: ${formattedTime}\n\n`;
  emailContent += `Your Picks:\n`;
  emailContent += `============\n`;
  
  validChanges
   .sort((a, b) => b.confidence - a.confidence) // Sort by confidence descending
   .forEach(change => {
    const gameTime = new Date(change.gameTime).toLocaleString();
    emailContent += `${change.game}\n`;
    emailContent += `Pick: ${change.pick}\n`;
    emailContent += `Confidence: ${change.confidence}\n`;
    emailContent += `Game Time: ${gameTime}\n\n`;
   });
  
  emailContent += `Total Picks: ${validChanges.length}\n`;
  emailContent += `\nGood luck!\n`;
  emailContent += `- NerdFootball AI`;
  
  return emailContent;
 }

 async function calculateAndDisplayLeaderboard(weekNumber, targetBody = allUI.leaderboardBody, loader = allUI.leaderboardLoader) {
    loader.classList.remove('hidden');
    targetBody.innerHTML = '';

    const users = await getCleanUsers();
    
    let scores = {};
    for (const id in users) {
        scores[id] = { userId: id, displayName: users[id].displayName, score: 0 };
    }

    if (weekNumber) { // Weekly calculation
        const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
        const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
        const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
        
        picksSnap.forEach(pickDoc => {
            const userId = pickDoc.id;
            if (scores[userId]) {
                const userPicks = pickDoc.data();
                let userScore = 0;
                Object.keys(userPicks).forEach(gameId => {
                    const pick = userPicks[gameId];
                    const gameWinner = getGameWinner(gameResults[gameId]);
                    if (gameWinner && pick.winner === gameWinner) {
                        userScore += pick.confidence;
                    }
                });
                scores[userId].score = userScore;
            }
        });
    } else { // Season calculation
        for (let i = 1; i <= currentWeek; i++) {
            const resultsSnap = await getDoc(doc(db, resultsPath(i)));
            const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
            const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${i}/submissions`));

            picksSnap.forEach(pickDoc => {
                const userId = pickDoc.id;
                if (scores[userId]) {
                    const userPicks = pickDoc.data();
                    let userScore = 0;
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        const gameWinner = getGameWinner(gameResults[gameId]);
                        if (gameWinner && pick.winner === gameWinner) {
                            userScore += pick.confidence;
                        }
                    });
                    scores[userId].score += userScore;
                }
            });
        }
    }
    
    const sortedScores = await sortLeaderboardWithTiebreaker(Object.values(scores), weekNumber);
    targetBody.innerHTML = await renderLeaderboardRows(sortedScores, weekNumber, 'score') || `<tr><td colspan="3" class="text-center py-4">No picks submitted yet.</td></tr>`;
    loader.classList.add('hidden');
}

// Function to calculate leaderboard data without displaying it
async function calculateLeaderboard(weekNumber = null) {
    const users = await getCleanUsers();
    
    let scores = {};
    for (const id in users) {
        scores[id] = { uid: id, displayName: users[id].displayName, totalScore: 0 };
    }

    if (weekNumber) { // Weekly calculation
        const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
        const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
        const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
        
        picksSnap.forEach(pickDoc => {
            const userId = pickDoc.id;
            if (scores[userId]) {
                const userPicks = pickDoc.data();
                let userScore = 0;
                Object.keys(userPicks).forEach(gameId => {
                    const pick = userPicks[gameId];
                    const gameWinner = getGameWinner(gameResults[gameId]);
                    if (gameWinner && pick.winner === gameWinner) {
                        userScore += pick.confidence;
                    }
                });
                scores[userId].totalScore = userScore;
            }
        });
    } else { // Season calculation
        for (let i = 1; i <= currentWeek; i++) {
            const resultsSnap = await getDoc(doc(db, resultsPath(i)));
            const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
            const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${i}/submissions`));

            picksSnap.forEach(pickDoc => {
                const userId = pickDoc.id;
                if (scores[userId]) {
                    const userPicks = pickDoc.data();
                    let userScore = 0;
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        const gameWinner = getGameWinner(gameResults[gameId]);
                        if (gameWinner && pick.winner === gameWinner) {
                            userScore += pick.confidence;
                        }
                    });
                    scores[userId].totalScore += userScore;
                }
            });
        }
    }
    
    return await sortLeaderboardWithTiebreaker(Object.values(scores), weekNumber, 'totalScore');
}

 function populateWeekSelectors() {
 const options = Array.from({ length: 18 }, (_, i) => `<option value="${i + 1}">Week ${i + 1}</option>`).join('');
 allUI.weekSelector.innerHTML = options;
 allUI.adminWeekSelector.innerHTML = options;
 allUI.lbWeekSelector.innerHTML = options;
 }

 // --- PICKS SUMMARY FUNCTIONS ---
 async function renderActivePicksSummary() {
  if (!currentUser || !currentWeek) return;
  
  try {
   // Get current week games and user picks
   const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
   if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
    allUI.activePicksList.innerHTML = '<p class="text-center text-slate-500 text-sm">No games available for this week</p>';
    return;
   }

   const docRef = doc(db, picksPath(currentWeek, currentUser.uid));
   const docSnap = await getDoc(docRef);
   const userPicks = docSnap.exists() ? docSnap.data() : {};

   // Get game results for this week
   const resultsDocRef = doc(db, resultsPath(currentWeek));
   const resultsSnap = await getDoc(resultsDocRef);
   const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};

   // Filter picks that have winners selected
   const activePicks = [];
   weekData.games.forEach(game => {
    const pick = userPicks[game.id];
    if (pick && pick.winner) {
     // Check if game has started
     const gameTime = new Date(game.kickoff);
     const now = new Date();
     const gameHasStarted = now > gameTime;
     
     // Check if user won this pick
     const gameResult = gameResults[game.id];
     const gameWinner = getGameWinner(gameResult);
     const userWon = gameHasStarted && gameWinner && pick.winner === gameWinner;
     const userLost = gameHasStarted && gameWinner && pick.winner !== gameWinner;
     
     activePicks.push({
      gameId: game.id,
      team: pick.winner,
      confidence: pick.confidence,
      game: game,
      gameHasStarted: gameHasStarted,
      userWon: userWon,
      userLost: userLost,
      gameResult: gameResult
     });
    }
   });

   // Sort by confidence (highest first)
   activePicks.sort((a, b) => b.confidence - a.confidence);

   // Render active picks
   if (activePicks.length === 0) {
    allUI.activePicksList.innerHTML = '<p class="text-center text-slate-500 text-sm">No picks made yet</p>';
   } else {
    allUI.activePicksList.innerHTML = activePicks.map(pick => {
     const teamAbbr = teamNameToAbbr[pick.team] || pick.team;
     const logoUrl = nflTeamLogos[teamAbbr] || '';
     
     // Determine opponent and home/away status
     const isHome = pick.team === pick.game.home;
     const opponent = isHome ? pick.game.away : pick.game.home;
     const opponentAbbr = teamNameToAbbr[opponent] || opponent;
     const opponentLogoUrl = nflTeamLogos[opponentAbbr] || '';
     const homeAwayIndicator = isHome ? 'vs' : '@';
     
     // Format game time
     const gameTime = new Date(pick.game.kickoff);
     const now = new Date();
     const isToday = gameTime.toDateString() === now.toDateString();
     const isTomorrow = gameTime.toDateString() === new Date(now.getTime() + 24*60*60*1000).toDateString();
     
     let timeDisplay = '';
     if (isToday) {
      timeDisplay = gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     } else if (isTomorrow) {
      timeDisplay = 'Tom ' + gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     } else {
      timeDisplay = gameTime.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                   gameTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
     }
     
     // Determine background color and text style based on game status
     let bgClass = 'bg-slate-50 hover:bg-slate-100'; // Default for games not started
     let textClass = '';
     
     if (pick.gameHasStarted) {
      if (pick.userWon) {
       bgClass = 'bg-green-100 hover:bg-green-200'; // Light pale green for wins
       textClass = 'font-bold';
      } else if (pick.userLost) {
       bgClass = 'bg-rose-100 hover:bg-rose-200'; // Light pale rose for losses
       textClass = '';
      }
     }
     
     return `
      <div class="flex items-center ${bgClass} rounded-lg p-2 shadow-sm border cursor-pointer transition-colors duration-150">
       <img src="${logoUrl}" alt="${pick.team}" class="w-8 h-8 rounded-sm mr-3 flex-shrink-0" onerror="this.style.visibility='hidden'; this.style.width='8px';">
       <div class="flex-1 min-w-0">
        <div class="text-sm text-slate-800 ${textClass} truncate">${pick.team} (${pick.confidence})</div>
        <div class="text-xs text-slate-600 mt-1">
         ${homeAwayIndicator} ${opponent}
        </div>
        <div class="text-xs text-slate-500 mt-0.5">
         ${timeDisplay}
        </div>
       </div>
      </div>
     `;
    }).join('');
   }
  } catch (error) {
   console.error('Error loading active picks:', error);
   allUI.activePicksList.innerHTML = '<p class="text-center text-red-500 text-sm">Error loading picks</p>';
  }
 }

 async function renderYearlyLeaderboard() {
  if (!currentUser) return;
  
  try {
   allUI.yearlyLeaderboardLoader.classList.remove('hidden');
   allUI.yearlyLeaderboardContent.innerHTML = '';

   // Calculate season standings
   const standings = await calculateLeaderboard();
   
   if (!standings || standings.length === 0) {
    allUI.yearlyLeaderboardContent.innerHTML = '<p class="text-center text-slate-500 text-sm">No leaderboard data available</p>';
    return;
   }

   // Find user's position
   const userPosition = standings.findIndex(entry => entry.uid === currentUser.uid) + 1;
   
   // Get top 10
   const topTen = standings.slice(0, 10);
   let leaderboardEntries = [...topTen];
   
   // Add current user if not in top 10
   if (userPosition > 10) {
    const userEntry = standings[userPosition - 1];
    leaderboardEntries.push({ ...userEntry, isCurrentUser: true });
   }

   // Render leaderboard
   allUI.yearlyLeaderboardContent.innerHTML = leaderboardEntries.map((entry, index) => {
    let position;
    let isCurrentUser = entry.isCurrentUser || entry.uid === currentUser.uid;
    
    if (entry.isCurrentUser) {
     position = userPosition;
    } else {
     position = index + 1;
    }
    
    const positionDisplay = position <= 10 ? position : `${position}`;
    const bgClass = isCurrentUser ? 'bg-blue-100' : '';
    const textClass = isCurrentUser ? 'font-semibold' : '';
    
    return `
     <div class="flex items-center justify-between py-1 px-2 rounded text-sm ${bgClass} ${textClass}">
      <div class="flex items-center space-x-2">
       <span class="text-slate-600 font-mono text-xs w-6">${positionDisplay}.</span>
       <span class="text-slate-800">${entry.displayName || 'Unknown'}</span>
       ${isCurrentUser ? '<span class="text-blue-600 text-xs">(You)</span>' : ''}
      </div>
      <span class="text-slate-600 font-mono text-xs">${entry.totalScore}</span>
     </div>
    `;
   }).join('');
   
  } catch (error) {
   console.error('Error loading yearly leaderboard:', error);
   allUI.yearlyLeaderboardContent.innerHTML = '<p class="text-center text-red-500 text-sm">Error loading leaderboard</p>';
  } finally {
   allUI.yearlyLeaderboardLoader.classList.add('hidden');
  }
 }

 async function updatePicksSummary() {
  await renderActivePicksSummary();
  await renderYearlyLeaderboard();
 }

 function renderWeekUI(weekData, userPicks, weekIsLocked, targetContainer = allUI.gameList) {
 targetContainer.innerHTML = '';
 if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) {
 targetContainer.innerHTML = '<p class="text-center text-gray-500">No games are scheduled for this week.</p>';
 return;
 }
 const totalGames = weekData.games.length;
 const confidenceOptions = Array.from({ length: totalGames }, (_, i) => i + 1);
 
 weekData.games.forEach(game => {
 const pick = userPicks[game.id] || { winner: null, confidence: 0 };
 const gameRow = document.createElement('div');
 gameRow.className = 'p-4 border border-slate-300 rounded-lg bg-slate-100';
 const gameTime = new Date(game.kickoff);
 const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });

 gameRow.innerHTML = `
 <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
 <div class="md:col-span-8">
 <div class="flex flex-col sm:flex-row justify-around items-center gap-2">
 <button data-game-id="${game.id}" data-team="${game.away}" ${isGameLocked(game) ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.away ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.away}</button>
 <span class="text-slate-500 font-bold">@</span>
 <button data-game-id="${game.id}" data-team="${game.home}" ${isGameLocked(game) ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.home ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.home}</button>
 </div>
 </div>
 <div class="md:col-span-4">
 <select id="confidence-${game.id}" name="confidence-${game.id}" data-game-id="${game.id}" ${isGameLocked(game) ? 'disabled' : ''} class="confidence-select w-full p-3 rounded-lg border-2 border-slate-300 bg-white">${confidenceOptions.map(opt => `<option value="${opt}" ${pick.confidence === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>
 </div>
 </div>
 <div class="mt-3 pt-3 border-t border-slate-300 text-xs text-slate-600 grid grid-cols-2 md:grid-cols-4 gap-2">
 <div><p class="font-bold">Date & Time</p><p>${formattedTime}</p></div>
 <div><p class="font-bold">Stadium</p><p>${game.stadium}</p></div>
 <div><p class="font-bold">Weather</p><p>${game.weather || 'TBD'}</p></div>
 <div><p class="font-bold">Starting QBs</p><p>${(game.startingQBs && game.startingQBs.away) ? `${game.startingQBs.away} vs ${game.startingQBs.home}` : 'TBD'}</p></div>
 </div>`;
 targetContainer.appendChild(gameRow);
 });

 // Add Monday Night Football total points input
 const mondayNightGame = getMondayNightGame(weekData.games);
 if (mondayNightGame) {
   const mnfTotalInput = document.createElement('div');
   mnfTotalInput.className = 'mt-6 p-4 border border-blue-300 rounded-lg bg-blue-50';
   const isLocked = isGameLocked(mondayNightGame);
   const currentGuess = userPicks.mnfTotalPoints || '';
   
   mnfTotalInput.innerHTML = `
     <div class="flex flex-col gap-2">
       <div class="flex items-center gap-2">
         <h3 class="text-lg font-bold text-blue-800">Monday Night Football Tiebreaker</h3>
         <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-medium">Required</span>
       </div>
       <p class="text-sm text-blue-700">
         Guess the total points scored by both teams in: <strong>${mondayNightGame.away} @ ${mondayNightGame.home}</strong>
       </p>
       <p class="text-xs text-blue-600">
         This will be used as a tiebreaker if multiple players have the same weekly confidence points total.
         Closest guess without going over wins the tie.
       </p>
       <div class="flex items-center gap-2 mt-2">
         <label for="mnf-total-points" class="font-medium text-blue-800">Total Points:</label>
         <input 
           type="number" 
           id="mnf-total-points" 
           min="0" 
           max="150" 
           placeholder="Enter total points" 
           value="${currentGuess}"
           ${isLocked ? 'disabled' : ''} 
           class="w-24 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${isLocked ? 'bg-gray-100' : 'bg-white'}"
         />
         ${isLocked ? '<span class="text-xs text-gray-500">(Game has started)</span>' : ''}
       </div>
     </div>
   `;
   targetContainer.appendChild(mnfTotalInput);
 }

 let activePicks = JSON.parse(JSON.stringify(userPicks));
 
 const saveFunction = targetContainer === allUI.gameList ? savePicksToFirestore : (wk, pks) => { currentAdminPicks = pks; };

 targetContainer.querySelectorAll('.winner-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const gameId = e.target.dataset.gameId;
 const team = e.target.dataset.team;
 activePicks[gameId].winner = team;
 targetContainer.querySelectorAll(`.winner-btn[data-game-id="${gameId}"]`).forEach(b => b.classList.remove('selected'));
 e.target.classList.add('selected');
 saveFunction(currentWeek, activePicks);
 });
 });

 targetContainer.querySelectorAll('.confidence-select').forEach(select => {
 select.addEventListener('change', (e) => {
 const gameId = e.target.dataset.gameId;
 const newConfidence = parseInt(e.target.value, 10);
 const oldConfidence = activePicks[gameId].confidence;
 if (newConfidence === oldConfidence) return;
 const otherGameId = Object.keys(activePicks).find(id => id !== gameId && activePicks[id].confidence === newConfidence);
 if (otherGameId) {
 activePicks[otherGameId].confidence = oldConfidence;
 const otherSelect = targetContainer.querySelector(`.confidence-select[data-game-id="${otherGameId}"]`);
 if (otherSelect) otherSelect.value = oldConfidence;
 }
 activePicks[gameId].confidence = newConfidence;
 saveFunction(currentWeek, activePicks);
 });
 });

 // Add event listener for MNF total points input
 const mnfInput = targetContainer.querySelector('#mnf-total-points');
 if (mnfInput) {
   mnfInput.addEventListener('input', (e) => {
     const totalPoints = parseInt(e.target.value, 10);
     if (!isNaN(totalPoints) && totalPoints >= 0) {
       activePicks.mnfTotalPoints = totalPoints;
       saveFunction(currentWeek, activePicks);
     } else if (e.target.value === '') {
       delete activePicks.mnfTotalPoints;
       saveFunction(currentWeek, activePicks);
     }
   });
 }
 }

 function toggleViews(showAdmin) {
    allUI.adminContainer.classList.toggle('hidden', showAdmin);
    allUI.picksContainer.classList.toggle('hidden', !showAdmin);
    allUI.leaderboardContainer.classList.add('hidden'); // Always hide leaderboard when toggling admin/picks

    allUI.adminViewBtn.classList.toggle('active', showAdmin);
    allUI.picksViewBtn.classList.toggle('active', !showAdmin);
    allUI.leaderboardViewBtn.classList.remove('active');
 }

 // --- EVENT LISTENERS ---
 allUI.picksViewBtn.addEventListener('click', async () => {
    allUI.picksContainer.classList.remove('hidden');
    allUI.picksSummaryContainer.classList.remove('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.picksViewBtn.classList.add('active');
    allUI.menuPanel.classList.add('hidden');
    await updatePicksSummary();
    saveAppState();
 });

 allUI.adminViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.picksSummaryContainer.classList.add('hidden');
    allUI.adminContainer.classList.remove('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.adminViewBtn.classList.add('active');
    
    // Restore admin tab state from URL hash or default to first tab
    const hash = window.location.hash.substring(1);
    if (hash.startsWith('admin-')) {
        const tabId = `tab-${hash.substring(6)}`;
        switchToAdminTab(tabId);
    } else {
        // Default to first admin tab if no hash present
        const firstTab = allUI.adminTabs[0];
        if (firstTab) {
            switchToAdminTab(firstTab.id);
        } else {
            renderAdminView(allUI.adminWeekSelector.value);
        }
    }
    
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });
 
 allUI.survivorAdminBtn.addEventListener('click', () => {
    allUI.menuPanel.classList.add('hidden');
    // Set flag to show admin panel when landing on survivor page
    sessionStorage.setItem('survivorAdminView', 'true');
    // Force immediate navigation
    setTimeout(() => {
        window.location.href = './nerdSurvivor.html';
    }, 50);
 });
 
 allUI.leaderboardViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.picksSummaryContainer.classList.add('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.remove('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.leaderboardViewBtn.classList.add('active');
    renderPublicLeaderboard();
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });

 async function renderPublicLeaderboard() {
    allUI.publicLeaderboardLoader.classList.remove('hidden');
    allUI.publicLeaderboardBody.innerHTML = '';
    
    let isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
    
    if (isSeasonView) {
        await calculateAndDisplayLeaderboard(null, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    } else {
        const week = allUI.lbWeekSelector.value;
        await calculateAndDisplayLeaderboard(week, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    }
}

 allUI.lbWeeklyBtn.addEventListener('click', () => {
    allUI.lbWeeklyBtn.classList.add('active');
    allUI.lbSeasonBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.remove('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbSeasonBtn.addEventListener('click', () => {
    allUI.lbSeasonBtn.classList.add('active');
    allUI.lbWeeklyBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.add('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbWeekSelector.addEventListener('change', renderPublicLeaderboard);


 allUI.weekSelector.addEventListener('change', (e) => {
  loadAndRenderWeek(e.target.value);
  saveAppState();
 });
 allUI.adminWeekSelector.addEventListener('change', (e) => renderAdminView(e.target.value));
 allUI.saveResultsBtn.addEventListener('click', async () => {
 const weekNumber = allUI.adminWeekSelector.value;
 const newResults = {};
 
 // Get all unique game IDs
 const gameIds = new Set();
 allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => {
   gameIds.add(btn.dataset.gameId);
 });
 
 // For each game, collect winner and scores
 gameIds.forEach(gameId => {
   const selectedBtn = allUI.resultsGameList.querySelector(`.result-btn[data-game-id="${gameId}"].selected`);
   const awayScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="away"]`);
   const homeScoreInput = allUI.resultsGameList.querySelector(`.score-input[data-game-id="${gameId}"][data-team="home"]`);
   
   const awayScore = parseInt(awayScoreInput?.value) || null;
   const homeScore = parseInt(homeScoreInput?.value) || null;
   const winner = selectedBtn?.dataset.team || null;
   
   // Store enhanced result object if we have scores or winner
   if (winner || awayScore !== null || homeScore !== null) {
     newResults[gameId] = {
       winner: winner,
       awayScore: awayScore,
       homeScore: homeScore
     };
   }
 });
 
 await setDoc(doc(db, resultsPath(weekNumber)), newResults);
 alert('Results saved successfully!');
 calculateAndDisplayLeaderboard(weekNumber);
 });
 allUI.resetPicksBtn.addEventListener('click', async () => {
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 if (weekIsLocked) return;

 const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
 if (!Array.isArray(weekData.games) || weekData.games.length === 0) return;

 const resetPicks = {};
 weekData.games.forEach((game, index) => {
 resetPicks[game.id] = { winner: null, confidence: index + 1 };
 });
 await savePicksToFirestore(currentWeek, resetPicks);
 });
 allUI.userPicksSelector.addEventListener('change', async (e) => {
 const selectedUserId = e.target.value;
 if (!selectedUserId) {
 allUI.userPicksGameList.innerHTML = '';
 allUI.saveUserPicksBtn.classList.add('hidden');
 return;
 }
 const weekNumber = parseInt(allUI.adminWeekSelector.value, 10);
 const docRef = doc(db, picksPath(weekNumber, selectedUserId));
 const docSnap = await getDoc(docRef);

 const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
 if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
 allUI.userPicksGameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week.</p>';
 allUI.saveUserPicksBtn.classList.add('hidden');
 return;
 }
 let userPicks = {};
 if (docSnap.exists()) {
 userPicks = docSnap.data();
 } else {
 weekData.games.forEach((game, index) => {
 userPicks[game.id] = { winner: null, confidence: index + 1 };
 });
 }
 currentAdminPicks = userPicks;
 renderWeekUI(weekData, userPicks, false, allUI.userPicksGameList);
 allUI.saveUserPicksBtn.classList.remove('hidden');
 });
 allUI.saveUserPicksBtn.addEventListener('click', async () => {
 const selectedUserId = allUI.userPicksSelector.value;
 const weekNumber = allUI.adminWeekSelector.value;
 if (!selectedUserId) return;

 const docRef = doc(db, picksPath(weekNumber, selectedUserId));
 await setDoc(docRef, currentAdminPicks);
 alert(`${allUI.userPicksSelector.options[allUI.userPicksSelector.selectedIndex].text}'s picks have been saved.`);
 });
 // Admin tab switching with URL hash routing
 function switchToAdminTab(tabId) {
  allUI.adminTabs.forEach(t => t.classList.remove('active'));
  allUI.adminContentSections.forEach(s => s.classList.add('hidden'));
  
  const targetTab = document.getElementById(tabId);
  const contentId = `admin-content-${tabId.substring(4)}`;
  const targetContent = document.getElementById(contentId);
  
  if (targetTab && targetContent) {
   targetTab.classList.add('active');
   targetContent.classList.remove('hidden');
   renderAdminView(allUI.adminWeekSelector.value);
   
   // Update URL hash for state persistence
   window.location.hash = `admin-${tabId.substring(4)}`;
  }
 }

 // Handle hash change events for browser back/forward
 window.addEventListener('hashchange', () => {
  const hash = window.location.hash.substring(1); // Remove the #
  if (hash.startsWith('admin-') && getCurrentView() === 'admin') {
   const tabId = `tab-${hash.substring(6)}`; // Remove 'admin-' prefix
   switchToAdminTab(tabId);
  }
 });
 
 // Restore admin tab state on page load if admin view is active
 window.addEventListener('load', () => {
  setTimeout(() => {
   const hash = window.location.hash.substring(1);
   if (hash.startsWith('admin-') && getCurrentView() === 'admin') {
    const tabId = `tab-${hash.substring(6)}`;
    switchToAdminTab(tabId);
   }
  }, 100); // Small delay to ensure DOM is ready
 });

 allUI.adminTabs.forEach(tab => {
  tab.addEventListener('click', (e) => {
   e.preventDefault();
   switchToAdminTab(e.target.id);
  });
 });
 
 allUI.menuBtn.addEventListener('click', () => {
    allUI.menuPanel.classList.toggle('hidden');
 });

 window.addEventListener('click', (e) => {
    if (!allUI.menuBtn.contains(e.target) && !allUI.menuPanel.contains(e.target)) {
        allUI.menuPanel.classList.add('hidden');
    }
 });

 allUI.settingsBtn.addEventListener('click', async () => {
    if (!currentUser) return;
    allUI.settingsDisplayName.value = currentUser.displayName || '';
    allUI.settingsEmail.value = currentUser.email || '';
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    allUI.settingsModal.classList.remove('hidden');
    allUI.settingsModal.classList.add('flex');
    allUI.menuPanel.classList.add('hidden');
    
    // Check for pending email verification
    const pendingEmail = localStorage.getItem('pendingEmailChange');
    if (pendingEmail && pendingEmail !== currentUser.email) {
        allUI.pendingEmail.textContent = pendingEmail;
        allUI.emailVerificationStatus.classList.remove('hidden');
    } else {
        allUI.emailVerificationStatus.classList.add('hidden');
        localStorage.removeItem('pendingEmailChange'); // Clean up if email was verified
    }
    
    // Check and update Google linking status
    await checkGoogleLinkingStatus();
 });

 allUI.closeSettingsBtn.addEventListener('click', () => {
    allUI.settingsModal.classList.add('hidden');
    allUI.settingsModal.classList.remove('flex');
 });

 allUI.settingsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newDisplayName = allUI.settingsDisplayName.value;
    const newEmail = allUI.settingsEmail.value;
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    allUI.emailVerificationStatus.classList.add('hidden');
    
    try {
        // Update display name immediately if changed
        if (newDisplayName !== currentUser.displayName) {
            await updateProfile(currentUser, { displayName: newDisplayName });
            allUI.userDisplay.textContent = `Welcome, ${newDisplayName ? newDisplayName.split(' ')[0] : 'User'}`;
        }
        
        // Handle email change with verification
        if (newEmail !== currentUser.email) {
            // Store the new email and show progress
            localStorage.setItem('pendingEmailChange', newEmail);
            allUI.pendingEmail.textContent = newEmail;
            allUI.emailVerificationStatus.classList.remove('hidden');
            
            // Try multiple approaches
            await attemptEmailChange(newEmail);
        } else {
            allUI.settingsSuccess.textContent = 'Settings updated successfully!';
            allUI.settingsSuccess.classList.remove('hidden');
            setTimeout(() => {
                allUI.settingsModal.classList.add('hidden');
                allUI.settingsModal.classList.remove('flex');
            }, 2000);
        }
        
        // Update Firestore with display name (email will be updated after verification)
        const userDocRef = doc(db, usersPath(), currentUser.uid);
        await updateDoc(userDocRef, {
            displayName: newDisplayName
            // Note: email will be updated in Firestore after verification is complete
        });
        
    } catch (error) {
        console.error("Error updating settings:", error);
        let errorMessage = 'An error occurred while updating your settings.';
        
        if (error.code === 'auth/invalid-email') {
            errorMessage = 'Please enter a valid email address.';
        } else if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email address is already in use by another account.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage = 'For security reasons, please log out and log back in before changing your email address.';
        } else if (error.code === 'auth/operation-not-allowed') {
            errorMessage = 'Email changes are temporarily disabled. Please try again later.';
        } else {
            errorMessage = `Error: ${error.message}`;
        }
        
        allUI.settingsError.textContent = errorMessage;
        allUI.settingsError.classList.remove('hidden');
    }
 });

 allUI.resetWinnersBtn.addEventListener('click', async () => {
    const weekNumber = allUI.adminWeekSelector.value;
    if (confirm(`Are you sure you want to reset all winners for Week ${weekNumber}? This cannot be undone.`)) {
        const resultsDocRef = doc(db, resultsPath(weekNumber));
        try {
            await deleteDoc(resultsDocRef);
            alert(`Winners for Week ${weekNumber} have been reset.`);
            await renderGameResultsAdmin(weekNumber);
        } catch (error) {
            console.error("Error resetting winners:", error);
            alert("An error occurred while resetting the winners.");
        }
    }
 });

 allUI.cleanupDuplicatesBtn.addEventListener('click', async () => {
    if (confirm('⚠️ WARNING: This will remove duplicate user accounts.\n\nThis will keep the preferred UID for each email address and remove all duplicates.\n\nAre you sure you want to continue?')) {
        await cleanupDuplicateUsers();
    }
 });

 initializeAppAndAuth();
 });
 </script>
</body>
</html>