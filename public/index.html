<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NerdfootballAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .winner-btn.selected, .result-btn.selected {
            background-color: #10B981; /* Emerald 500 */
            color: white;
            border-color: #059669; /* Emerald 600 */
        }
        .winner-btn:disabled, .result-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
        .view-toggle-btn.active {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB; /* gray-300 */
            background-color: white;
        }
        .form-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            background-color: #4F46E5; /* indigo-600 */
        }
        .form-btn:hover {
            background-color: #4338CA; /* indigo-700 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Login & Register View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="p-8 bg-white rounded-2xl shadow-lg max-w-sm w-full mx-auto">
            
            <!-- Login Form (Visible by default) -->
            <form id="login-form">
                <h1 class="text-3xl font-bold text-center mb-1">Welcome Back</h1>
                <p class="text-center text-gray-600 mb-6">Sign in to continue.</p>
                <div id="login-error" class="text-red-500 text-center text-sm mb-4 hidden p-3 bg-red-50 rounded-md"></div>
                <div class="space-y-4">
                    <input id="login-email" type="email" placeholder="Email Address" required class="form-input">
                    <input id="login-password" type="password" placeholder="Password" required class="form-input">
                </div>
                <button id="login-btn" type="submit" class="form-btn mt-6">Sign In</button>
                <p class="text-center mt-4 text-sm">
                    Don't have an account? <a href="#" id="show-register-link" class="font-medium text-indigo-600 hover:text-indigo-500">Register</a>
                </p>
            </form>

            <!-- Registration Form (Hidden by default) -->
            <form id="register-form" class="hidden">
                 <h1 class="text-3xl font-bold text-center mb-1">Create Account</h1>
                <p class="text-center text-gray-600 mb-6">Get started with NerdfootballAI.</p>
                <div id="register-error" class="text-red-500 text-center text-sm mb-4 hidden p-3 bg-red-50 rounded-md"></div>
                <div class="space-y-4">
                     <input id="register-firstname" type="text" placeholder="First Name" required class="form-input">
                     <input id="register-lastname" type="text" placeholder="Last Name" required class="form-input">
                     <input id="register-email" type="email" placeholder="Email Address" required class="form-input">
                     <input id="register-password" type="password" placeholder="Password" required class="form-input">
                     <input id="register-confirm-password" type="password" placeholder="Confirm Password" required class="form-input">
                </div>
                <button id="register-btn" type="submit" class="form-btn mt-6">Create Account</button>
                <p class="text-center mt-4 text-sm">
                    Already have an account? <a href="#" id="show-login-link" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                </p>
            </form>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
        <header class="mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div id="admin-controls" class="hidden">
                    <button id="picks-view-btn" class="view-toggle-btn active py-2 px-4 rounded-lg font-semibold border border-gray-300">My Picks</button>
                    <button id="admin-view-btn" class="view-toggle-btn py-2 px-4 rounded-lg font-semibold border border-gray-300">Admin</button>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 order-first md:order-none w-full md:w-auto text-center">NerdfootballAI</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-display" class="text-sm font-medium text-gray-700"></span>
                    <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
                </div>
            </div>
        </header>
        
        <!-- Picks View -->
        <div id="picks-container">
            <!-- This content is identical to the previous version -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <label for="week-selector" class="block text-lg font-medium text-gray-700 mb-2">Select a Week:</label>
                        <select id="week-selector" class="p-3 rounded-lg border-2 border-gray-300 bg-white"></select>
                    </div>
                </div>
                <main id="picks-form">
                    <div id="lock-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert">
                        <p class="font-bold">Picks Locked</p>
                        <p>The games for this week have started. Your picks can no longer be changed.</p>
                    </div>
                    <div id="game-list" class="space-y-6"></div>
                </main>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-container" class="hidden">
             <!-- This content is identical to the previous version -->
             <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Admin Dashboard</h2>
                    <div>
                        <label for="admin-week-selector" class="block text-lg font-medium text-gray-700 mb-2">Manage Week:</label>
                        <select id="admin-week-selector" class="p-3 rounded-lg border-2 border-gray-300 bg-white"></select>
                    </div>
                </div>
                <div id="results-input-section" class="mb-8">
                    <h3 class="text-xl font-bold mb-4">Enter Game Winners</h3>
                    <div id="results-game-list" class="space-y-4"></div>
                    <button id="save-results-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 flex items-center justify-center">Save Game Results</button>
                </div>
                <div id="leaderboard-section">
                    <h3 class="text-xl font-bold mb-4">Live Leaderboard</h3>
                    <div id="leaderboard-loader" class="loader hidden"></div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><th class="px-6 py-3">Rank</th><th class="px-6 py-3">User</th><th class="px-6 py-3">Score</th></tr></thead>
                        <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const ADMIN_UID = "YOUR_GOOGLE_UID_HERE"; // IMPORTANT: Replace with your actual Google User ID

        document.addEventListener('DOMContentLoaded', () => {
            const seasonData = [ /* Fictional 2025 schedule */ 
                { week: 1, games: [ { id: 101, away: 'Ravens', home: 'Chiefs', kickoff: '2025-09-04T20:20:00' }, { id: 102, away: 'Packers', home: 'Eagles', kickoff: '2025-09-05T20:15:00' }, { id: 103, away: 'Steelers', home: 'Falcons', kickoff: '2025-09-07T13:00:00' }]},
                { week: 2, games: [ { id: 201, away: 'Bills', home: 'Dolphins', kickoff: '2025-09-11T20:15:00' }, { id: 202, away: 'Raiders', home: 'Ravens', kickoff: '2025-09-14T13:00:00' }, { id: 203, away: 'Chargers', home: 'Panthers', kickoff: '2025-09-14T13:00:00' }]},
            ];

            // --- UI ELEMENTS ---
            const loginView = document.getElementById('login-view'), appView = document.getElementById('app-view');
            const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register-link'), showLoginLink = document.getElementById('show-login-link');
            const loginError = document.getElementById('login-error'), registerError = document.getElementById('register-error');
            const logoutBtn = document.getElementById('logout-btn'), userDisplay = document.getElementById('user-display'), adminControls = document.getElementById('admin-controls');
            const picksContainer = document.getElementById('picks-container'), adminContainer = document.getElementById('admin-container');
            const picksViewBtn = document.getElementById('picks-view-btn'), adminViewBtn = document.getElementById('admin-view-btn');
            const weekSelector = document.getElementById('week-selector'), adminWeekSelector = document.getElementById('admin-week-selector');
            const gameList = document.getElementById('game-list'), resultsGameList = document.getElementById('results-game-list');
            const saveResultsBtn = document.getElementById('save-results-btn');
            const leaderboardLoader = document.getElementById('leaderboard-loader'), leaderboardBody = document.getElementById('leaderboard-body');

            // --- APP STATE ---
            let currentWeek = 1, currentUser = null, db, auth, unsubscribeFromPicks = null;
            
            // --- INITIALIZATION & AUTH ---
            async function initializeAppAndAuth() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "...", authDomain: "...", projectId: "..." };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, handleAuthStateChange);
            }

            async function handleAuthStateChange(user) {
                if (user) {
                    currentUser = user;
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    userDisplay.textContent = `Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;

                    const userDocRef = doc(db, usersPath(), user.uid);
                    await setDoc(userDocRef, { displayName: user.displayName, email: user.email }, { merge: true });

                    if (user.uid === ADMIN_UID) adminControls.classList.remove('hidden');
                    
                    populateWeekSelectors();
                    loadAndRenderWeek(currentWeek);
                    if (user.uid === ADMIN_UID) renderAdminView(currentWeek);
                } else {
                    currentUser = null;
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            }
            
            // --- FORM TOGGLING ---
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

            // --- AUTH EVENT LISTENERS ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    loginError.classList.add('hidden');
                } catch (error) {
                    loginError.innerHTML = getAuthErrorMessage(error.code);
                    loginError.classList.remove('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const firstName = document.getElementById('register-firstname').value;
                const lastName = document.getElementById('register-lastname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                if (password !== confirmPassword) {
                    registerError.textContent = "Passwords do not match.";
                    registerError.classList.remove('hidden');
                    return;
                }
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
                    registerError.classList.add('hidden');
                } catch (error) {
                    registerError.innerHTML = getAuthErrorMessage(error.code);
                    registerError.classList.remove('hidden');
                }
            });

            logoutBtn.addEventListener('click', () => signOut(auth));

            function getAuthErrorMessage(errorCode) {
                switch (errorCode) {
                    case 'auth/operation-not-allowed':
                        return '<strong>Action Required:</strong><br>Email/Password sign-in is not enabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.';
                    case 'auth/invalid-email': 
                        return 'Please enter a valid email address.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password': 
                        return 'Invalid email or password.';
                    case 'auth/email-already-in-use': 
                        return 'An account with this email already exists.';
                    case 'auth/weak-password': 
                        return 'Password should be at least 6 characters.';
                    default: 
                        return 'An unexpected error occurred. Please try again.';
                }
            }

            // --- DATA PATH HELPERS ---
            const appId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const picksPath = (week, uid) => `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions/${uid}`;
            const resultsPath = (week) => `artifacts/${appId()}/public/data/nerdfootball_results/${week}`;
            const usersPath = () => `artifacts/${appId()}/public/data/nerdfootball_users`;

            // --- All other functions (Picks view, Admin view, Leaderboard, etc.) remain the same as the previous version ---
            // They are included here for completeness.
            function getWeekLockStatus(weekNumber) { const weekData = seasonData.find(w=>w.week == weekNumber); if (!weekData || !weekData.games.length) return false; const firstKickoff=new Date(weekData.games[0].kickoff+'Z'); return new Date()>firstKickoff; }
            async function loadAndRenderWeek(weekNumber) { currentWeek=parseInt(weekNumber, 10); if (!currentUser) return; if (unsubscribeFromPicks) unsubscribeFromPicks(); const docRef=doc(db, picksPath(currentWeek, currentUser.uid)); unsubscribeFromPicks=onSnapshot(docRef, (docSnap)=>{ const weekIsLocked=getWeekLockStatus(currentWeek); let userPicks={}; const weekData=seasonData.find(w=>w.week == currentWeek); if (docSnap.exists()) { userPicks=docSnap.data(); } else { weekData.games.forEach((game, index)=>{ userPicks[game.id]={ winner: null, confidence: index + 1 }; }); } renderWeekUI(weekData, userPicks, weekIsLocked); }); }
            function renderWeekUI(weekData, userPicks, weekIsLocked) { document.getElementById('lock-banner').classList.toggle('hidden', !weekIsLocked); gameList.innerHTML=''; const totalGames=weekData.games.length; const confidenceOptions=Array.from({ length: totalGames }, (_, i)=>i + 1); weekData.games.forEach(game=>{ const pick=userPicks[game.id] || { winner: null, confidence: 0 }; const gameRow=document.createElement('div'); gameRow.className='p-4 border border-gray-200 rounded-lg'; gameRow.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center"><div class="md:col-span-8"><div class="flex flex-col sm:flex-row justify-around items-center gap-2"><button data-game-id="${game.id}" data-team="${game.away}" ${weekIsLocked?'disabled':''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-gray-300 font-semibold ${pick.winner===game.away?'selected':'bg-gray-50 hover:bg-gray-200'}">${game.away}</button><span class="text-gray-500 font-bold">@</span><button data-game-id="${game.id}" data-team="${game.home}" ${weekIsLocked?'disabled':''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-gray-300 font-semibold ${pick.winner===game.home?'selected':'bg-gray-50 hover:bg-gray-200'}">${game.home}</button></div></div><div class="md:col-span-4"><select data-game-id="${game.id}" ${weekIsLocked?'disabled':''} class="confidence-select w-full p-3 rounded-lg border-2 border-gray-300 bg-white">${confidenceOptions.map(opt=>`<option value="${opt}" ${pick.confidence===opt?'selected':''}>${opt}</option>`).join('')}</select></div></div>`; gameList.appendChild(gameRow); }); gameList.querySelectorAll('.winner-btn').forEach(btn=>{ btn.addEventListener('click', (e)=>{ const gameId=e.target.dataset.gameId; const team=e.target.dataset.team; userPicks[gameId].winner=team; gameList.querySelectorAll(`.winner-btn[data-game-id="${gameId}"]`).forEach(b=>b.classList.remove('selected')); e.target.classList.add('selected'); savePicksToFirestore(currentWeek, userPicks); }); }); gameList.querySelectorAll('.confidence-select').forEach(select=>{ select.addEventListener('change', (e)=>{ const gameId=e.target.dataset.gameId; const newConfidence=parseInt(e.target.value, 10); const oldConfidence=userPicks[gameId].confidence; if (newConfidence===oldConfidence) return; const otherGameId=Object.keys(userPicks).find(id=>id !==gameId && userPicks[id].confidence===newConfidence); if (otherGameId) { userPicks[otherGameId].confidence=oldConfidence; const otherSelect=gameList.querySelector(`.confidence-select[data-game-id="${otherGameId}"]`); if (otherSelect) otherSelect.value=oldConfidence; } userPicks[gameId].confidence=newConfidence; savePicksToFirestore(currentWeek, userPicks); }); }); }
            async function savePicksToFirestore(weekNum, picks) { if (!currentUser || getWeekLockStatus(weekNum)) return; const docRef=doc(db, picksPath(weekNum, currentUser.uid)); try { await setDoc(docRef, picks); } catch (error) { console.error("Error saving picks:", error); } }
            function toggleViews(showAdmin) { adminContainer.classList.toggle('hidden', !showAdmin); picksContainer.classList.toggle('hidden', showAdmin); adminViewBtn.classList.toggle('active', showAdmin); picksViewBtn.classList.toggle('active', !showAdmin); }
            async function renderAdminView(weekNumber) { const weekData=seasonData.find(w=>w.week == weekNumber); if (!weekData) return; const resultsDocRef=doc(db, resultsPath(weekNumber)); const resultsSnap=await getDoc(resultsDocRef); const currentResults=resultsSnap.exists()?resultsSnap.data():{}; resultsGameList.innerHTML=''; weekData.games.forEach(game=>{ const winner=currentResults[game.id] || null; const gameEl=document.createElement('div'); gameEl.className='grid grid-cols-12 gap-2 items-center'; gameEl.innerHTML=`<div class="col-span-10 flex justify-around items-center"><button data-game-id="${game.id}" data-team="${game.away}" class="result-btn w-2/s text-center p-2 rounded-lg border-2 ${winner===game.away?'selected':''}">${game.away}</button><span class="font-bold">@</span><button data-game-id="${game.id}" data-team="${game.home}" class="result-btn w-2/5 text-center p-2 rounded-lg border-2 ${winner===game.home?'selected':''}">${game.home}</button></div>`; resultsGameList.appendChild(gameEl); }); resultsGameList.querySelectorAll('.result-btn').forEach(btn=>btn.addEventListener('click', (e)=>{ const { gameId }=e.target.dataset; const gameButtons=resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`); gameButtons.forEach(b=>b.classList.remove('selected')); e.target.classList.add('selected'); })); calculateAndDisplayLeaderboard(weekNumber); }
            saveResultsBtn.addEventListener('click', async ()=>{ const weekNumber=adminWeekSelector.value; const newResults={}; resultsGameList.querySelectorAll('.result-btn.selected').forEach(btn=>{ newResults[btn.dataset.gameId]=btn.dataset.team; }); await setDoc(doc(db, resultsPath(weekNumber)), newResults); alert('Results saved successfully!'); calculateAndDisplayLeaderboard(weekNumber); });
            async function calculateAndDisplayLeaderboard(weekNumber) { leaderboardLoader.classList.remove('hidden'); leaderboardBody.innerHTML=''; const resultsSnap=await getDoc(doc(db, resultsPath(weekNumber))); const gameResults=resultsSnap.exists()?resultsSnap.data():{}; const usersSnap=await getDocs(collection(db, usersPath())); const users={}; usersSnap.forEach(doc=>users[doc.id]=doc.data()); const picksSnap=await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`)); const scores=[]; picksSnap.forEach(pickDoc=>{ const userId=pickDoc.id; if (!users[userId]) return; const userPicks=pickDoc.data(); let userScore=0; Object.keys(userPicks).forEach(gameId=>{ const pick=userPicks[gameId]; if (gameResults[gameId] && pick.winner===gameResults[gameId]) { userScore +=pick.confidence; } }); scores.push({ userId, displayName: users[userId].displayName, score: userScore }); }); scores.sort((a, b)=>b.score - a.score); leaderboardBody.innerHTML=scores.map((s, index)=>`<tr><td class="px-6 py-4 whitespace-nowrap font-medium">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap">${s.displayName}</td><td class="px-6 py-4 whitespace-nowrap font-bold">${s.score}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center py-4">No picks submitted for this week yet.</td></tr>`; leaderboardLoader.classList.add('hidden'); }
            function populateWeekSelectors() { const options=seasonData.map(w=>`<option value="${w.week}">Week ${w.week}</option>`).join(''); weekSelector.innerHTML=options; adminWeekSelector.innerHTML=options; }
            adminViewBtn.addEventListener('click', () => toggleViews(true));
            picksViewBtn.addEventListener('click', () => toggleViews(false));
            weekSelector.addEventListener('change', (e) => loadAndRenderWeek(e.target.value));
            adminWeekSelector.addEventListener('change', (e) => renderAdminView(e.target.value));
            
            initializeAppAndAuth();
        });
    </script>
</body>
</html>