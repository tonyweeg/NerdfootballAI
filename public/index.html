<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NerdfootballAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .winner-btn.selected, .result-btn.selected {
            background-color: #334155; /* slate-700 */
            color: white;
            border-color: #1e293b; /* slate-800 */
        }
        .winner-btn:disabled, .result-btn:disabled, #reset-picks-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #D1D5DB;
        }
        select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }
        .view-toggle-btn.active {
            background-color: #475569; /* slate-600 */
            color: white;
        }
        .admin-tab {
            border-color: transparent;
            border-bottom-width: 2px;
            padding: 1rem;
            font-weight: 500;
            color: #6B7280;
        }
        .admin-tab.active {
            border-color: #475569; /* slate-600 */
            color: #334155; /* slate-700 */
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #9ca3af; /* gray-400 */
            background-color: #f8fafc; /* slate-50 */
        }
        .form-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            background-image: linear-gradient(to bottom, #64748b, #334155);
            border: 1px solid #1e293b;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .form-btn:hover {
            background-image: linear-gradient(to bottom, #475569, #1e293b);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #64748b; /* slate-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #save-status-icon svg {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-200 text-slate-800">

    <!-- Login & Register View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-sm w-full mx-auto border border-slate-300">
            
            <!-- Login Form -->
            <form id="login-form">
                <h1 class="text-3xl font-bold text-center mb-1 text-slate-800">NerdfootballAI</h1>
                <p class="text-center text-slate-600 mb-6">Welcome back, Nerds</p>
                <div id="login-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
                <div class="space-y-4">
                    <input id="login-email" type="email" placeholder="Email Address" required class="form-input">
                    <input id="login-password" type="password" placeholder="Password" required class="form-input">
                </div>
                <button id="login-btn" type="submit" class="form-btn mt-6">Sign In</button>
                <p class="text-center mt-4 text-sm">
                    Don't have an account? <a href="#" id="show-register-link" class="font-medium text-slate-600 hover:text-slate-800">Register</a>
                </p>
            </form>

            <!-- Registration Form -->
            <form id="register-form" class="hidden">
                 <h1 class="text-3xl font-bold text-center mb-1">Create Account</h1>
                <p class="text-center text-slate-600 mb-6">Get started with NerdfootballAI.</p>
                <div id="register-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
                <div class="space-y-4">
                     <input id="register-firstname" type="text" placeholder="First Name" required class="form-input">
                     <input id="register-lastname" type="text" placeholder="Last Name" required class="form-input">
                     <input id="register-email" type="email" placeholder="Email Address" required class="form-input">
                     <input id="register-password" type="password" placeholder="Password" required class="form-input">
                     <input id="register-confirm-password" type="password" placeholder="Confirm Password" required class="form-input">
                </div>
                <button id="register-btn" type="submit" class="form-btn mt-6">Create Account</button>
                <p class="text-center mt-4 text-sm">
                    Already have an account? <a href="#" id="show-login-link" class="font-medium text-slate-600 hover:text-slate-800">Sign In</a>
                </p>
            </form>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
        <header class="mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div id="admin-controls" class="hidden">
                    <button id="picks-view-btn" class="view-toggle-btn active py-2 px-4 rounded-lg font-semibold border border-slate-400">My Picks</button>
                    <button id="admin-view-btn" class="view-toggle-btn py-2 px-4 rounded-lg font-semibold border border-slate-400">Admin</button>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800 order-first md:order-none w-full md:w-auto text-center">NerdfootballAI</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-display" class="text-sm font-medium text-slate-700"></span>
                    <button id="logout-btn" class="bg-red-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-800">Logout</button>
                </div>
            </div>
        </header>
        
        <!-- Picks View -->
        <div id="picks-container">
            <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
                <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
                    <div>
                        <label for="week-selector" class="block text-lg font-medium text-slate-700 mb-2">Select a Week:</label>
                        <select id="week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="save-status" class="flex items-center space-x-2 h-10">
                            <div id="save-status-icon" class="w-6 h-6"></div>
                            <span id="save-status-text" class="text-sm font-medium"></span>
                        </div>
                        <button id="reset-picks-btn" class="bg-red-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-800">Reset Picks</button>
                    </div>
                </div>
                <main id="picks-form">
                    <div id="lock-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md mb-6" role="alert">
                        <p class="font-bold">Picks Locked</p>
                        <p>The games for this week have started. Your picks can no longer be changed.</p>
                    </div>
                    <div id="game-list" class="space-y-6"></div>
                </main>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-container" class="hidden">
             <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
                    <select id="admin-week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
                </div>

                <!-- Admin Nav Tabs -->
                <div class="border-b border-gray-300 mb-6">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-game-results" class="admin-tab active">Game Results</button>
                        <button id="tab-user-mgmt" class="admin-tab">User Management</button>
                        <button id="tab-picks-mgmt" class="admin-tab">Picks Management</button>
                    </nav>
                </div>

                <!-- Game Results Content -->
                <div id="admin-content-game-results" class="admin-content-section">
                    <h3 class="text-xl font-bold mb-4">Enter Game Winners</h3>
                    <div id="results-game-list" class="space-y-4"></div>
                    <button id="save-results-btn" class="mt-6 w-full bg-green-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-800">Save Game Results</button>
                     <div id="leaderboard-section" class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Live Leaderboard</h3>
                        <div id="leaderboard-loader" class="loader hidden"></div>
                        <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th></tr></thead><tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                    </div>
                </div>
                
                <!-- User Management Content -->
                <div id="admin-content-user-mgmt" class="admin-content-section hidden">
                    <h3 class="text-xl font-bold mb-4">User Management</h3>
                    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="user-mgmt-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                </div>

                <!-- Picks Management Content -->
                <div id="admin-content-picks-mgmt" class="admin-content-section hidden">
                     <h3 class="text-xl font-bold mb-4">Edit User Picks</h3>
                     <div class="mb-4">
                        <label for="user-picks-selector" class="block text-sm font-medium text-gray-700">Select User:</label>
                        <select id="user-picks-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md"></select>
                     </div>
                     <div id="user-picks-game-list" class="space-y-6"></div>
                     <button id="save-user-picks-btn" class="mt-6 w-full bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 hidden">Save User's Picks</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const ADMIN_UID = "WxSPmEildJdqs6T5hIpBUZrscwt2";

        document.addEventListener('DOMContentLoaded', () => {
            const seasonData = [
                { week: 1, games: [ { id: 101, away: 'Ravens', home: 'Chiefs', kickoff: '2025-09-04T20:20:00' }, { id: 102, away: 'Packers', home: 'Eagles', kickoff: '2025-09-05T20:15:00' }, { id: 103, away: 'Steelers', home: 'Falcons', kickoff: '2025-09-07T13:00:00' }, { id: 104, away: 'Cardinals', home: 'Bills', kickoff: '2025-09-07T13:00:00' }, { id: 105, away: 'Titans', home: 'Bears', kickoff: '2025-09-07T13:00:00' }, { id: 106, away: 'Patriots', home: 'Bengals', kickoff: '2025-09-07T13:00:00' }, { id: 107, away: 'Jaguars', home: 'Dolphins', kickoff: '2025-09-07T13:00:00' }, { id: 108, away: 'Vikings', home: 'Giants', kickoff: '2025-09-07T13:00:00' }, { id: 109, away: 'Texans', home: 'Colts', kickoff: '2025-09-07T13:00:00' }, { id: 110, away: 'Saints', home: 'Panthers', kickoff: '2025-09-07T13:00:00' }, { id: 111, away: 'Raiders', home: 'Chargers', kickoff: '2025-09-07T16:25:00' }, { id: 112, away: 'Broncos', home: 'Seahawks', kickoff: '2025-09-07T16:25:00' }, { id: 113, away: 'Cowboys', home: 'Browns', kickoff: '2025-09-07T16:25:00' }, { id: 114, away: 'Commanders', home: 'Buccaneers', kickoff: '2025-09-07T16:25:00' }, { id: 115, away: 'Rams', home: 'Lions', kickoff: '2025-09-07T20:20:00' }, { id: 116, away: 'Jets', home: '49ers', kickoff: '2025-09-08T20:15:00' } ]},
                { week: 2, games: [ { id: 201, away: 'Bills', home: 'Dolphins', kickoff: '2025-09-11T20:15:00' }, { id: 202, away: 'Raiders', home: 'Ravens', kickoff: '2025-09-14T13:00:00' }, { id: 203, away: 'Chargers', home: 'Panthers', kickoff: '2025-09-14T13:00:00' }, { id: 204, away: 'Saints', home: 'Cowboys', kickoff: '2025-09-14T13:00:00' }, { id: 205, away: 'Buccaneers', home: 'Falcons', kickoff: '2025-09-14T13:00:00' }, { id: 206, away: '49ers', home: 'Vikings', kickoff: '2025-09-14T13:00:00' }, { id: 207, away: 'Browns', home: 'Jaguars', kickoff: '2025-09-14T13:00:00' }, { id: 208, away: 'Jets', home: 'Titans', kickoff: '2025-09-14T13:00:00' }, { id: 209, away: 'Giants', home: 'Commanders', kickoff: '2025-09-14T13:00:00' }, { id: 210, away: 'Colts', home: 'Packers', kickoff: '2025-09-14T13:00:00' }, { id: 211, away: 'Steelers', home: 'Broncos', kickoff: '2025-09-14T16:25:00' }, { id: 212, away: 'Lions', home: 'Rams', kickoff: '2025-09-14T16:25:00' }, { id: 213, away: 'Cardinals', home: 'Seahawks', kickoff: '2025-09-14T16:25:00' }, { id: 214, away: 'Eagles', home: 'Patriots', kickoff: '2025-09-14T16:25:00' }, { id: 215, away: 'Bears', home: 'Texans', kickoff: '2025-09-14T20:20:00' }, { id: 216, away: 'Bengals', home: 'Chiefs', kickoff: '2025-09-15T20:15:00' } ]},
                { week: 3, games: [ { id: 301, away: 'Giants', home: 'Browns', kickoff: '2025-09-18T20:15:00' }, { id: 302, away: 'Colts', home: 'Lions', kickoff: '2025-09-21T13:00:00' }, { id: 303, away: 'Chargers', home: 'Steelers', kickoff: '2025-09-21T13:00:00' }, { id: 304, away: 'Bears', home: 'Colts', kickoff: '2025-09-21T13:00:00' }, { id: 305, away: 'Panthers', home: 'Raiders', kickoff: '2025-09-21T16:05:00' }, { id: 306, away: 'Chiefs', home: 'Falcons', kickoff: '2025-09-21T20:20:00' }, { id: 307, away: 'Bills', home: 'Ravens', kickoff: '2025-09-22T20:15:00' } ]},
                { week: 4, games: [ { id: 401, away: 'Cowboys', home: 'Giants', kickoff: '2025-09-25T20:15:00' }, { id: 402, away: 'Saints', home: 'Falcons', kickoff: '2025-09-28T13:00:00' }, { id: 403, away: 'Bengals', home: 'Commanders', kickoff: '2025-09-28T13:00:00' }, { id: 404, away: 'Eagles', home: 'Buccaneers', kickoff: '2025-09-28T13:00:00' }, { id: 405, away: 'Rams', home: '49ers', kickoff: '2025-09-28T16:25:00' }, { id: 406, away: 'Bills', home: 'Texans', kickoff: '2025-09-28T20:20:00' }, { id: 407, away: 'Seahawks', home: 'Lions', kickoff: '2025-09-29T20:15:00' } ]},
                { week: 5, games: [ { id: 501, away: 'Buccaneers', home: 'Falcons', kickoff: '2025-10-02T20:15:00' }, { id: 502, away: 'Ravens', home: 'Bengals', kickoff: '2025-10-05T13:00:00' }, { id: 503, away: 'Dolphins', home: 'Patriots', kickoff: '2025-10-05T13:00:00' }, { id: 504, away: 'Saints', home: 'Chiefs', kickoff: '2025-10-05T13:00:00' }, { id: 505, away: 'Jets', home: 'Vikings', kickoff: '2025-10-05T09:30:00' }, { id: 506, away: 'Cowboys', home: 'Steelers', kickoff: '2025-10-05T20:20:00' }, { id: 507, away: 'Packers', home: 'Rams', kickoff: '2025-10-06T20:15:00' } ]},
                { week: 6, games: [ { id: 601, away: 'Commanders', home: 'Bears', kickoff: '2025-10-09T20:15:00' }, { id: 602, away: '49ers', home: 'Seahawks', kickoff: '2025-10-12T16:25:00' }, { id: 603, away: 'Bengals', home: 'Saints', kickoff: '2025-10-12T13:00:00' }, { id: 604, away: 'Jaguars', home: 'Colts', kickoff: '2025-10-12T13:00:00' }, { id: 605, away: 'Patriots', home: 'Browns', kickoff: '2025-10-12T13:00:00' }, { id: 606, away: 'Bills', home: 'Chiefs', kickoff: '2025-10-12T20:20:00' }, { id: 607, away: 'Broncos', home: 'Chargers', kickoff: '2025-10-13T20:15:00' } ]},
                { week: 7, games: [ { id: 701, away: 'Saints', home: 'Cardinals', kickoff: '2025-10-16T20:15:00' }, { id: 702, away: 'Falcons', home: 'Bengals', kickoff: '2025-10-19T13:00:00' }, { id: 703, away: 'Lions', home: 'Cowboys', kickoff: '2025-10-19T13:00:00' }, { id: 704, away: 'Colts', home: 'Titans', kickoff: '2025-10-19T13:00:00' }, { id: 705, away: 'Packers', home: 'Commanders', kickoff: '2025-10-19T13:00:00' }, { id: 706, away: 'Steelers', home: 'Dolphins', kickoff: '2025-10-19T20:20:00' }, { id: 707, away: 'Bears', home: 'Patriots', kickoff: '2025-10-20T20:15:00' } ]},
                { week: 8, games: [ { id: 801, away: 'Ravens', home: 'Buccaneers', kickoff: '2025-10-23T20:15:00' }, { id: 802, away: 'Broncos', home: 'Jaguars', kickoff: '2025-10-26T09:30:00' }, { id: 803, away: 'Panthers', home: 'Falcons', kickoff: '2025-10-26T13:00:00' }, { id: 804, away: 'Bears', home: 'Cowboys', kickoff: '2025-10-26T13:00:00' }, { id: 805, away: 'Dolphins', home: 'Lions', kickoff: '2025-10-26T13:00:00' }, { id: 806, away: 'Packers', home: 'Bills', kickoff: '2025-10-26T20:20:00' }, { id: 807, away: 'Bengals', home: 'Browns', kickoff: '2025-10-27T20:15:00' } ]},
                { week: 9, games: [ { id: 901, away: 'Eagles', home: 'Texans', kickoff: '2025-10-30T20:15:00' }, { id: 902, away: 'Chargers', home: 'Falcons', kickoff: '2025-11-02T13:00:00' }, { id: 903, away: 'Dolphins', home: 'Bears', kickoff: '2025-11-02T13:00:00' }, { id: 904, away: 'Packers', home: 'Lions', kickoff: '2025-11-02T13:00:00' }, { id: 905, away: 'Colts', home: 'Patriots', kickoff: '2025-11-02T13:00:00' }, { id: 906, away: 'Titans', home: 'Chiefs', kickoff: '2025-11-02T20:20:00' }, { id: 907, away: 'Ravens', home: 'Saints', kickoff: '2025-11-03T20:15:00' } ]},
                { week: 10, games: [ { id: 1001, away: 'Falcons', home: 'Panthers', kickoff: '2025-11-06T20:15:00' }, { id: 1002, away: 'Seahawks', home: 'Buccaneers', kickoff: '2025-11-09T09:30:00' }, { id: 1003, away: 'Vikings', home: 'Bills', kickoff: '2025-11-09T13:00:00' }, { id: 1004, away: 'Lions', home: 'Bears', kickoff: '2025-11-09T13:00:00' }, { id: 1005, away: 'Jaguars', home: 'Chiefs', kickoff: '2025-11-09T13:00:00' }, { id: 1006, away: 'Chargers', home: '49ers', kickoff: '2025-11-09T20:20:00' }, { id: 1007, away: 'Commanders', home: 'Eagles', kickoff: '2025-11-10T20:15:00' } ]},
                { week: 11, games: [ { id: 1101, away: 'Titans', home: 'Packers', kickoff: '2025-11-13T20:15:00' }, { id: 1102, away: 'Bears', home: 'Falcons', kickoff: '2025-11-16T13:00:00' }, { id: 1103, away: 'Browns', home: 'Bills', kickoff: '2025-11-16T13:00:00' }, { id: 1104, away: 'Eagles', home: 'Colts', kickoff: '2025-11-16T13:00:00' }, { id: 1105, away: 'Jets', home: 'Patriots', kickoff: '2025-11-16T13:00:00' }, { id: 1106, away: 'Chiefs', home: 'Chargers', kickoff: '2025-11-16T20:20:00' }, { id: 1107, away: '49ers', home: 'Cardinals', kickoff: '2025-11-17T20:15:00' } ]},
                { week: 12, games: [ { id: 1201, away: 'Bills', home: 'Lions', kickoff: '2025-11-20T12:30:00' }, { id: 1202, away: 'Giants', home: 'Cowboys', kickoff: '2025-11-20T16:30:00' }, { id: 1203, away: 'Patriots', home: 'Vikings', kickoff: '2025-11-20T20:20:00' }, { id: 1204, away: 'Broncos', home: 'Panthers', kickoff: '2025-11-23T13:00:00' }, { id: 1205, away: 'Buccaneers', home: 'Browns', kickoff: '2025-11-23T13:00:00' }, { id: 1206, away: 'Packers', home: 'Eagles', kickoff: '2025-11-23T20:20:00' }, { id: 1207, away: 'Steelers', home: 'Colts', kickoff: '2025-11-24T20:15:00' } ]},
                { week: 13, games: [ { id: 1301, away: 'Bills', home: 'Patriots', kickoff: '2025-11-27T20:15:00' }, { id: 1302, away: 'Steelers', home: 'Falcons', kickoff: '2025-11-30T13:00:00' }, { id: 1303, away: 'Broncos', home: 'Ravens', kickoff: '2025-11-30T13:00:00' }, { id: 1304, away: 'Browns', home: 'Texans', kickoff: '2025-11-30T13:00:00' }, { id: 1305, away: 'Commanders', home: 'Giants', kickoff: '2025-11-30T13:00:00' }, { id: 1306, away: 'Colts', home: 'Cowboys', kickoff: '2025-11-30T20:20:00' }, { id: 1307, away: 'Saints', home: 'Buccaneers', kickoff: '2025-12-01T20:15:00' } ]},
                { week: 14, games: [ { id: 1401, away: 'Raiders', home: 'Rams', kickoff: '2025-12-04T20:15:00' }, { id: 1402, away: 'Jets', home: 'Bills', kickoff: '2025-12-07T13:00:00' }, { id: 1403, away: 'Browns', home: 'Bengals', kickoff: '2025-12-07T13:00:00' }, { id: 1404, away: 'Texans', home: 'Cowboys', kickoff: '2025-12-07T13:00:00' }, { id: 1405, away: 'Vikings', home: 'Lions', kickoff: '2025-12-07T13:00:00' }, { id: 1406, away: 'Chiefs', home: 'Broncos', kickoff: '2025-12-07T20:20:00' }, { id: 1407, away: 'Patriots', home: 'Cardinals', kickoff: '2025-12-08T20:15:00' } ]},
                { week: 15, games: [ { id: 1501, away: '49ers', home: 'Seahawks', kickoff: '2025-12-11T20:15:00' }, { id: 1502, away: 'Colts', home: 'Vikings', kickoff: '2025-12-14T13:00:00' }, { id: 1503, away: 'Ravens', home: 'Browns', kickoff: '2025-12-14T13:00:00' }, { id: 1504, away: 'Dolphins', home: 'Bills', kickoff: '2025-12-14T13:00:00' }, { id: 1505, away: 'Eagles', home: 'Bears', kickoff: '2025-12-14T13:00:00' }, { id: 1506, away: 'Giants', home: 'Commanders', kickoff: '2025-12-14T20:20:00' }, { id: 1507, away: 'Rams', home: 'Packers', kickoff: '2025-12-15T20:15:00' } ]},
                { week: 16, games: [ { id: 1601, away: 'Jaguars', home: 'Jets', kickoff: '2025-12-18T20:15:00' }, { id: 1602, away: 'Falcons', home: 'Ravens', kickoff: '2025-12-21T13:00:00' }, { id: 1603, away: 'Lions', home: 'Panthers', kickoff: '2025-12-21T13:00:00' }, { id: 1604, away: 'Saints', home: 'Browns', kickoff: '2025-12-21T13:00:00' }, { id: 1605, away: 'Seahawks', home: 'Chiefs', kickoff: '2025-12-21T13:00:00' }, { id: 1606, away: 'Raiders', home: 'Steelers', kickoff: '2025-12-21T20:20:00' }, { id: 1607, away: 'Chargers', home: 'Colts', kickoff: '2025-12-22T20:15:00' } ]},
                { week: 17, games: [ { id: 1701, away: 'Cowboys', home: 'Titans', kickoff: '2025-12-25T20:15:00' }, { id: 1702, away: 'Cardinals', home: 'Falcons', kickoff: '2025-12-28T13:00:00' }, { id: 1703, away: 'Bears', home: 'Lions', kickoff: '2025-12-28T13:00:00' }, { id: 1704, away: 'Saints', home: 'Eagles', kickoff: '2025-12-28T13:00:00' }, { id: 1705, away: 'Dolphins', home: 'Patriots', kickoff: '2025-12-28T13:00:00' }, { id: 1706, away: 'Steelers', home: 'Ravens', kickoff: '2025-12-28T20:20:00' }, { id: 1707, away: 'Bills', home: 'Bengals', kickoff: '2025-12-29T20:15:00' } ]},
                { week: 18, games: [ { id: 1801, away: 'Buccaneers', home: 'Falcons', kickoff: '2026-01-04T13:00:00' }, { id: 1802, away: 'Patriots', home: 'Bills', kickoff: '2026-01-04T13:00:00' }, { id: 1803, away: 'Vikings', home: 'Bears', kickoff: '2026-01-04T13:00:00' }, { id: 1804, away: 'Ravens', home: 'Bengals', kickoff: '2026-01-04T13:00:00' }, { id: 1805, away: 'Lions', home: 'Packers', kickoff: '2026-01-04T16:25:00' }, { id: 1806, away: 'Texans', home: 'Colts', kickoff: '2026-01-04T16:25:00' }, { id: 1807, away: 'Jets', home: 'Dolphins', kickoff: '2026-01-04T16:25:00' } ]}
            ];

            // --- UI ELEMENTS ---
            const allUI = {
                loginView: document.getElementById('login-view'), appView: document.getElementById('app-view'),
                loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
                showRegisterLink: document.getElementById('show-register-link'), showLoginLink: document.getElementById('show-login-link'),
                loginError: document.getElementById('login-error'), registerError: document.getElementById('register-error'),
                logoutBtn: document.getElementById('logout-btn'), userDisplay: document.getElementById('user-display'), adminControls: document.getElementById('admin-controls'),
                picksContainer: document.getElementById('picks-container'), adminContainer: document.getElementById('admin-container'),
                picksViewBtn: document.getElementById('picks-view-btn'), adminViewBtn: document.getElementById('admin-view-btn'),
                weekSelector: document.getElementById('week-selector'), adminWeekSelector: document.getElementById('admin-week-selector'),
                gameList: document.getElementById('game-list'), resultsGameList: document.getElementById('results-game-list'),
                saveResultsBtn: document.getElementById('save-results-btn'),
                leaderboardLoader: document.getElementById('leaderboard-loader'), leaderboardBody: document.getElementById('leaderboard-body'),
                saveStatusIcon: document.getElementById('save-status-icon'), saveStatusText: document.getElementById('save-status-text'),
                resetPicksBtn: document.getElementById('reset-picks-btn'),
                adminTabs: document.querySelectorAll('.admin-tab'), adminContentSections: document.querySelectorAll('.admin-content-section'),
                userMgmtBody: document.getElementById('user-mgmt-body'),
                userPicksSelector: document.getElementById('user-picks-selector'),
                userPicksGameList: document.getElementById('user-picks-game-list'),
                saveUserPicksBtn: document.getElementById('save-user-picks-btn'),
            };

            // --- APP STATE ---
            let currentWeek = 1, currentUser = null, db, auth, unsubscribeFromPicks = null, saveTimeout = null;
            let currentAdminPicks = {}, allUsers = [];

            // --- INITIALIZATION & AUTH ---
            async function initializeAppAndAuth() {
                const firebaseConfig = {
                  apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
                  authDomain: "nerdfootball.firebaseapp.com",
                  projectId: "nerdfootball",
                  storageBucket: "nerdfootball.appspot.com",
                  messagingSenderId: "969304790725",
                  appId: "1:969304790725:web:892df38db0b0e62bde02ac",
                  measurementId: "G-8RVRHE3HRC"
                };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, handleAuthStateChange);
            }

            async function handleAuthStateChange(user) {
                if (user) {
                    const userDocRef = doc(db, usersPath(), user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists() && userDoc.data().disabled) {
                        allUI.loginError.textContent = 'Your account has been disabled.';
                        allUI.loginError.classList.remove('hidden');
                        signOut(auth);
                        return;
                    }
                    
                    currentUser = user;
                    allUI.loginView.classList.add('hidden');
                    allUI.appView.classList.remove('hidden');
                    allUI.userDisplay.textContent = `Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;

                    await setDoc(userDocRef, { displayName: user.displayName, email: user.email }, { merge: true });

                    if (user.uid === ADMIN_UID) {
                        allUI.adminControls.classList.remove('hidden');
                        fetchAllUsers();
                    }
                    
                    populateWeekSelectors();
                    loadAndRenderWeek(currentWeek);
                    if (user.uid === ADMIN_UID) {
                       renderAdminView(currentWeek);
                    }
                } else {
                    currentUser = null;
                    allUI.loginView.classList.remove('hidden');
                    allUI.appView.classList.add('hidden');
                }
            }
            
            // --- FORM TOGGLING ---
            allUI.showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); allUI.loginForm.classList.add('hidden'); allUI.registerForm.classList.remove('hidden'); });
            allUI.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); allUI.registerForm.classList.add('hidden'); allUI.loginForm.classList.remove('hidden'); });

            // --- AUTH EVENT LISTENERS ---
            allUI.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    allUI.loginError.classList.add('hidden');
                } catch (error) {
                    allUI.loginError.innerHTML = getAuthErrorMessage(error.code);
                    allUI.loginError.classList.remove('hidden');
                }
            });

            allUI.registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const firstName = document.getElementById('register-firstname').value;
                const lastName = document.getElementById('register-lastname').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                if (password !== confirmPassword) {
                    allUI.registerError.textContent = "Passwords do not match.";
                    allUI.registerError.classList.remove('hidden');
                    return;
                }
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
                    allUI.registerError.classList.add('hidden');
                } catch (error) {
                    allUI.registerError.innerHTML = getAuthErrorMessage(error.code);
                    allUI.registerError.classList.remove('hidden');
                }
            });

            allUI.logoutBtn.addEventListener('click', () => signOut(auth));
            
            function getAuthErrorMessage(errorCode) {
                switch (errorCode) {
                    case 'auth/operation-not-allowed':
                        return '<strong>Action Required:</strong><br>Email/Password sign-in is not enabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.';
                    case 'auth/invalid-email': 
                        return 'Please enter a valid email address.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password': 
                        return 'Invalid email or password.';
                    case 'auth/email-already-in-use': 
                        return 'An account with this email already exists.';
                    case 'auth/weak-password': 
                        return 'Password should be at least 6 characters.';
                    default: 
                        return 'An unexpected error occurred. Please try again.';
                }
            }

            // --- DATA PATH HELPERS ---
            const appId = () => 'nerdfootball'; 
            const picksPath = (week, uid) => `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions/${uid}`;
            const resultsPath = (week) => `artifacts/${appId()}/public/data/nerdfootball_results/${week}`;
            const usersPath = () => `artifacts/${appId()}/public/data/nerdfootball_users`;
            
            // --- SAVE STATUS ---
            function updateSaveStatus(status, message) {
                if(saveTimeout) clearTimeout(saveTimeout);
                allUI.saveStatusIcon.style.animation = 'none'; // Stop spin animation by default
                
                switch(status) {
                    case 'saving':
                        allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                        allUI.saveStatusIcon.style.animation = 'spin 1s linear infinite';
                        allUI.saveStatusText.textContent = message;
                        allUI.saveStatusText.className = 'text-sm font-medium text-gray-500';
                        break;
                    case 'saved':
                        allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                        allUI.saveStatusText.textContent = message;
                        allUI.saveStatusText.className = 'text-sm font-medium text-green-600';
                        saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 2500);
                        break;
                    case 'error':
                        allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                        allUI.saveStatusText.textContent = message;
                        allUI.saveStatusText.className = 'text-sm font-medium text-red-600';
                        break;
                    case 'idle':
                    default:
                        allUI.saveStatusIcon.innerHTML = '';
                        allUI.saveStatusText.textContent = '';
                        break;
                }
            }


            function getWeekLockStatus(weekNumber) { 
                const weekData = seasonData.find(w=>w.week == weekNumber); 
                if (!weekData || !weekData.games.length) return false; 
                const firstKickoff=new Date(weekData.games[0].kickoff+'Z'); 
                return new Date()>firstKickoff; 
            }
            
            async function loadAndRenderWeek(weekNumber) { 
                currentWeek=parseInt(weekNumber, 10); 
                if (!currentUser) return; 
                if (unsubscribeFromPicks) unsubscribeFromPicks(); 
                updateSaveStatus('idle');

                const weekIsLocked = getWeekLockStatus(currentWeek);
                allUI.resetPicksBtn.disabled = weekIsLocked;
                
                const docRef=doc(db, picksPath(currentWeek, currentUser.uid)); 
                unsubscribeFromPicks=onSnapshot(docRef, (docSnap)=>{ 
                    let userPicks={}; 
                    const weekData=seasonData.find(w=>w.week == currentWeek); 
                    
                    if (!weekData) {
                        allUI.gameList.innerHTML = '<p class="text-center text-gray-500">No games are scheduled for this week.</p>';
                        return;
                    }

                    if (docSnap.exists()) { 
                        userPicks=docSnap.data(); 
                    } else { 
                        weekData.games.forEach((game, index)=>{ 
                            userPicks[game.id]={ winner: null, confidence: index + 1 }; 
                        }); 
                    } 
                    renderWeekUI(weekData, userPicks, weekIsLocked, allUI.gameList); 
                }); 
            }

            async function savePicksToFirestore(weekNum, picks) { 
                if (!currentUser || getWeekLockStatus(weekNum)) return; 
                updateSaveStatus('saving', 'Saving...');
                const docRef=doc(db, picksPath(weekNum, currentUser.uid)); 
                try { 
                    await setDoc(docRef, picks); 
                    updateSaveStatus('saved', 'Picks Saved!');
                } catch (error) { 
                    console.error("Error saving picks:", error); 
                    updateSaveStatus('error', 'Save Failed');
                } 
            }

            async function calculateAndDisplayLeaderboard(weekNumber) {
                allUI.leaderboardLoader.classList.remove('hidden');
                allUI.leaderboardBody.innerHTML = '';
                const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
                const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
                const usersSnap = await getDocs(collection(db, usersPath()));
                const users = {};
                usersSnap.forEach(doc => users[doc.id] = doc.data());
                const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
                const scores = [];
                picksSnap.forEach(pickDoc => {
                    const userId = pickDoc.id;
                    if (!users[userId]) return;
                    const userPicks = pickDoc.data();
                    let userScore = 0;
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        if (gameResults[gameId] && pick.winner === gameResults[gameId]) {
                            userScore += pick.confidence;
                        }
                    });
                    scores.push({ userId, displayName: users[userId].displayName, score: userScore });
                });
                scores.sort((a, b) => b.score - a.score);
                allUI.leaderboardBody.innerHTML = scores.map((s, index) => `<tr><td class="px-6 py-4 whitespace-nowrap font-medium">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap">${s.displayName}</td><td class="px-6 py-4 whitespace-nowrap font-bold">${s.score}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center py-4">No picks submitted for this week yet.</td></tr>`;
                allUI.leaderboardLoader.classList.add('hidden');
            }

            function populateWeekSelectors() {
                const options = seasonData.map(w => `<option value="${w.week}">Week ${w.week}</option>`).join('');
                allUI.weekSelector.innerHTML = options;
                allUI.adminWeekSelector.innerHTML = options;
            }


            // --- ADMIN LOGIC ---
            async function fetchAllUsers() {
                const usersCollectionRef = collection(db, usersPath());
                const usersSnap = await getDocs(usersCollectionRef);
                allUsers = [];
                usersSnap.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                allUsers.sort((a,b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));
            }

            function renderAdminView(weekNumber) {
                const activeTab = document.querySelector('.admin-tab.active').id;
                switch (activeTab) {
                    case 'tab-game-results': renderGameResultsAdmin(weekNumber); break;
                    case 'tab-user-mgmt': renderUserManagement(); break;
                    case 'tab-picks-mgmt': renderPicksManagement(weekNumber); break;
                }
            }

            async function renderGameResultsAdmin(weekNumber) {
                const weekData = seasonData.find(w => w.week == weekNumber);
                if (!weekData) {
                    allUI.resultsGameList.innerHTML = '<p>No games to administer for this week.</p>';
                    allUI.leaderboardBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">No data for this week.</td></tr>`;
                    return;
                }
                const resultsDocRef = doc(db, resultsPath(weekNumber));
                const resultsSnap = await getDoc(resultsDocRef);
                const currentResults = resultsSnap.exists() ? resultsSnap.data() : {};
                allUI.resultsGameList.innerHTML = '';
                weekData.games.forEach(game => {
                    const winner = currentResults[game.id] || null;
                    const gameEl = document.createElement('div');
                    gameEl.className = 'grid grid-cols-12 gap-2 items-center';
                    gameEl.innerHTML = `<div class="col-span-10 flex justify-around items-center"><button data-game-id="${game.id}" data-team="${game.away}" class="result-btn w-2/5 text-center p-2 rounded-lg border-2 ${winner === game.away ? 'selected' : ''}">${game.away}</button><span class="font-bold">@</span><button data-game-id="${game.id}" data-team="${game.home}" class="result-btn w-2/5 text-center p-2 rounded-lg border-2 ${winner === game.home ? 'selected' : ''}">${game.home}</button></div>`;
                    allUI.resultsGameList.appendChild(gameEl);
                });
                allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const { gameId } = e.target.dataset;
                    const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
                    gameButtons.forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                }));
                calculateAndDisplayLeaderboard(weekNumber);
            }

            function renderUserManagement() {
                allUI.userMgmtBody.innerHTML = allUsers.map(user => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${user.displayName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.disabled ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${user.disabled ? 'Disabled' : 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button data-user-id="${user.id}" data-disabled="${!!user.disabled}" class="user-status-btn text-sm font-medium ${user.disabled ? 'text-green-600 hover:text-green-900' : 'text-red-600 hover:text-red-900'}">
                                ${user.disabled ? 'Enable' : 'Disable'}
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                allUI.userMgmtBody.querySelectorAll('.user-status-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userId;
                        if (userId === ADMIN_UID) {
                            alert("You cannot disable the main admin account.");
                            return;
                        }
                        const isDisabled = e.target.dataset.disabled === 'true';
                        const userDocRef = doc(db, usersPath(), userId);
                        await updateDoc(userDocRef, { disabled: !isDisabled });
                        await fetchAllUsers();
                        renderUserManagement();
                    });
                });
            }

            function renderPicksManagement(weekNumber) {
                allUI.userPicksSelector.innerHTML = '<option value="">Select a user...</option>' + allUsers.map(u => `<option value="${u.id}">${u.displayName || u.email}</option>`).join('');
                allUI.userPicksGameList.innerHTML = '';
                allUI.saveUserPicksBtn.classList.add('hidden');
            }
            
            function renderWeekUI(weekData, userPicks, weekIsLocked, targetContainer = allUI.gameList) {
                targetContainer.innerHTML = '';
                if (!weekData) {
                    targetContainer.innerHTML = '<p>No games scheduled for this week.</p>';
                    return;
                }
                const totalGames = weekData.games.length;
                const confidenceOptions = Array.from({ length: totalGames }, (_, i) => i + 1);
                
                weekData.games.forEach(game => {
                    const pick = userPicks[game.id] || { winner: null, confidence: 0 };
                    const gameRow = document.createElement('div');
                    gameRow.className = 'p-4 border border-slate-300 rounded-lg bg-slate-100';
                    gameRow.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                            <div class="md:col-span-8">
                                <div class="flex flex-col sm:flex-row justify-around items-center gap-2">
                                    <button data-game-id="${game.id}" data-team="${game.away}" ${weekIsLocked ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.away ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.away}</button>
                                    <span class="text-slate-500 font-bold">@</span>
                                    <button data-game-id="${game.id}" data-team="${game.home}" ${weekIsLocked ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.home ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.home}</button>
                                </div>
                            </div>
                            <div class="md:col-span-4">
                                <select id="confidence-${game.id}" name="confidence-${game.id}" data-game-id="${game.id}" ${weekIsLocked ? 'disabled' : ''} class="confidence-select w-full p-3 rounded-lg border-2 border-slate-300 bg-white">${confidenceOptions.map(opt => `<option value="${opt}" ${pick.confidence === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>
                            </div>
                        </div>`;
                    targetContainer.appendChild(gameRow);
                });

                let activePicks = JSON.parse(JSON.stringify(userPicks));
                
                const saveFunction = targetContainer === allUI.gameList ? savePicksToFirestore : (wk, pks) => { currentAdminPicks = pks; };

                targetContainer.querySelectorAll('.winner-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const gameId = e.target.dataset.gameId;
                        const team = e.target.dataset.team;
                        activePicks[gameId].winner = team;
                        targetContainer.querySelectorAll(`.winner-btn[data-game-id="${gameId}"]`).forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        saveFunction(currentWeek, activePicks);
                    });
                });

                targetContainer.querySelectorAll('.confidence-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const gameId = e.target.dataset.gameId;
                        const newConfidence = parseInt(e.target.value, 10);
                        const oldConfidence = activePicks[gameId].confidence;
                        if (newConfidence === oldConfidence) return;
                        const otherGameId = Object.keys(activePicks).find(id => id !== gameId && activePicks[id].confidence === newConfidence);
                        if (otherGameId) {
                            activePicks[otherGameId].confidence = oldConfidence;
                            const otherSelect = targetContainer.querySelector(`.confidence-select[data-game-id="${otherGameId}"]`);
                            if (otherSelect) otherSelect.value = oldConfidence;
                        }
                        activePicks[gameId].confidence = newConfidence;
                        saveFunction(currentWeek, activePicks);
                    });
                });
            }

            function toggleViews(showAdmin) {
                allUI.adminContainer.classList.toggle('hidden', !showAdmin);
                allUI.picksContainer.classList.toggle('hidden', showAdmin);
                allUI.adminViewBtn.classList.toggle('active', showAdmin);
                allUI.picksViewBtn.classList.toggle('active', !showAdmin);
            }

            // --- EVENT LISTENERS ---
            allUI.picksViewBtn.addEventListener('click', () => toggleViews(false));
            allUI.adminViewBtn.addEventListener('click', () => toggleViews(true));
            allUI.weekSelector.addEventListener('change', (e) => loadAndRenderWeek(e.target.value));
            allUI.adminWeekSelector.addEventListener('change', (e) => renderAdminView(e.target.value));
            allUI.saveResultsBtn.addEventListener('click', async () => {
                const weekNumber = allUI.adminWeekSelector.value;
                const newResults = {};
                allUI.resultsGameList.querySelectorAll('.result-btn.selected').forEach(btn => {
                    newResults[btn.dataset.gameId] = btn.dataset.team;
                });
                await setDoc(doc(db, resultsPath(weekNumber)), newResults);
                alert('Results saved successfully!');
                calculateAndDisplayLeaderboard(weekNumber);
            });
            allUI.resetPicksBtn.addEventListener('click', () => {
                const weekIsLocked = getWeekLockStatus(currentWeek);
                if (weekIsLocked) return;

                const weekData = seasonData.find(w => w.week == currentWeek);
                if (!weekData) return;

                const resetPicks = {};
                weekData.games.forEach((game, index) => {
                    resetPicks[game.id] = { winner: null, confidence: index + 1 };
                });
                savePicksToFirestore(currentWeek, resetPicks);
            });
            allUI.userPicksSelector.addEventListener('change', async (e) => {
                const selectedUserId = e.target.value;
                if (!selectedUserId) {
                    allUI.userPicksGameList.innerHTML = '';
                    allUI.saveUserPicksBtn.classList.add('hidden');
                    return;
                }
                const weekNumber = allUI.adminWeekSelector.value;
                const docRef = doc(db, picksPath(weekNumber, selectedUserId));
                const docSnap = await getDoc(docRef);

                const weekData = seasonData.find(w => w.week == weekNumber);
                let userPicks = {};
                if (docSnap.exists()) {
                    userPicks = docSnap.data();
                } else {
                    weekData.games.forEach((game, index) => {
                        userPicks[game.id] = { winner: null, confidence: index + 1 };
                    });
                }
                currentAdminPicks = userPicks;
                renderWeekUI(weekData, userPicks, false, allUI.userPicksGameList);
                allUI.saveUserPicksBtn.classList.remove('hidden');
            });
            allUI.saveUserPicksBtn.addEventListener('click', async () => {
                const selectedUserId = allUI.userPicksSelector.value;
                const weekNumber = allUI.adminWeekSelector.value;
                if (!selectedUserId) return;

                const docRef = doc(db, picksPath(weekNumber, selectedUserId));
                await setDoc(docRef, currentAdminPicks);
                alert(`${allUI.userPicksSelector.options[allUI.userPicksSelector.selectedIndex].text}'s picks have been saved.`);
            });
            allUI.adminTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    allUI.adminTabs.forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    allUI.adminContentSections.forEach(s => s.classList.add('hidden'));
                    const contentId = `admin-content-${e.target.id.substring(4)}`;
                    document.getElementById(contentId).classList.remove('hidden');
                    renderAdminView(allUI.adminWeekSelector.value);
                });
            });
            
            initializeAppAndAuth();
        });
    </script>
</body>
</html>