<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>NerdfootballAI v2.0</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 <style>
 body {
 font-family: 'Inter', sans-serif;
 }
 .winner-btn.selected, .result-btn.selected {
 background-color: #334155; /* slate-700 */
 color: white;
 border-color: #1e293b; /* slate-800 */
 }
 .winner-btn:disabled, .result-btn:disabled, #reset-picks-btn:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #D1D5DB;
 }
 select:disabled {
 opacity: 0.7;
 cursor: not-allowed;
 background-color: #f3f4f6;
 }
 .view-toggle-btn.active {
 background-color: #475569; /* slate-600 */
 color: white;
 }
 .admin-tab {
 border-color: transparent;
 border-bottom-width: 2px;
 padding: 1rem;
 font-weight: 500;
 color: #6B7280;
 }
 .admin-tab.active {
 border-color: #475569; /* slate-600 */
 color: #334155; /* slate-700 */
 }
 .form-input {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 border: 1px solid #9ca3af; /* gray-400 */
 background-color: #f8fafc; /* slate-50 */
 }
 .form-btn {
 width: 100%;
 padding: 0.75rem;
 border-radius: 0.5rem;
 font-weight: 600;
 color: white;
 background-image: linear-gradient(to bottom, #64748b, #334155);
 border: 1px solid #1e293b;
 box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
 }
 .form-btn:hover {
 background-image: linear-gradient(to bottom, #475569, #1e293b);
 }
 .loader {
 border: 4px solid #f3f3f3;
 border-top: 4px solid #64748b; /* slate-500 */
 border-radius: 50%;
 width: 40px;
 height: 40px;
 animation: spin 1s linear infinite;
 margin: 20px auto;
 }
 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
 #save-status-icon svg {
 animation: spin 1s linear infinite;
 }
  #settings-modal {
    background-color: rgba(0, 0, 0, 0.5);
  }
  .public-leaderboard-table tr:nth-child(even) {
    background-color: #f8fafc; /* slate-50 */
  }
  .public-leaderboard-table tr:hover {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
  .public-leaderboard-table tr:hover td {
    background-color: #e2e8f0 !important; /* slate-200 */
  }
 </style>
</head>
<body class="bg-slate-200 text-slate-800">

 <!-- Loading View -->
 <div id="loading-view" class="min-h-screen flex items-center justify-center p-4">
  <div class="text-center">
   <div class="loader mb-4"></div>
   <p class="text-slate-600">Loading NerdfootballAI...</p>
  </div>
 </div>

 <!-- Login & Register View -->
 <div id="login-view" class="min-h-screen flex items-center justify-center p-4 hidden">
 <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-sm w-full mx-auto border border-slate-300">
 
 <!-- Login Form -->
 <form id="login-form">
 <h1 class="text-3xl font-bold text-center mb-1 text-slate-800">NerdfootballAI</h1>
 <p class="text-center text-slate-600 mb-6">Welcome back, Nerds</p>
 <div id="login-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="login-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="login-password" type="password" placeholder="Password" required class="form-input">
 </div>
 <button id="login-btn" type="submit" class="form-btn mt-6">Sign In</button>
 <p class="text-center mt-4 text-sm">
 Don't have an account? <a href="#" id="show-register-link" class="font-medium text-slate-600 hover:text-slate-800">Register</a>
 </p>
 </form>

 <!-- Registration Form -->
 <form id="register-form" class="hidden">
 <h1 class="text-3xl font-bold text-center mb-1">Create Account</h1>
 <p class="text-center text-slate-600 mb-6">Get started with NerdfootballAI.</p>
 <div id="register-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
 <div class="space-y-4">
 <input id="register-firstname" type="text" placeholder="First Name" required class="form-input">
 <input id="register-lastname" type="text" placeholder="Last Name" required class="form-input">
 <input id="register-email" type="email" placeholder="Email Address" required class="form-input">
 <input id="register-password" type="password" placeholder="Password" required class="form-input">
 <input id="register-confirm-password" type="password" placeholder="Confirm Password" required class="form-input">
 </div>
 <button id="register-btn" type="submit" class="form-btn mt-6">Create Account</button>
 <p class="text-center mt-4 text-sm">
 Already have an account? <a href="#" id="show-login-link" class="font-medium text-slate-600 hover:text-slate-800">Sign In</a>
 </p>
 </form>
 </div>
 </div>

 <!-- Main App Container -->
 <div id="app-view" class="container mx-auto p-4 md:p-8 max-w-5xl hidden">
 <header class="mb-6">
 <div class="flex justify-between items-center flex-wrap gap-4">
 <!-- Logo and title - left aligned -->
 <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity cursor-pointer">
 <img src="https://firebasestorage.googleapis.com/v0/b/nerdfootball.firebasestorage.app/o/nerdfootball-nerd-2025.png?alt=media&token=de5cef91-c70e-49bc-ba71-6f993439b11e" alt="NerdfootballAI Logo" class="h-8 md:h-10 w-auto">
 <h1 class="text-3xl md:text-4xl font-bold text-slate-800">NerdfootballAI</h1>
 </a>
 <!-- Right side elements -->
 <div class="flex items-center space-x-4">
 <span class="text-sm font-medium text-slate-600">v2.0</span>
 <div class="flex items-center space-x-2 relative">
    <span id="user-display" class="text-sm font-medium text-slate-700"></span>
    <button id="menu-btn" class="p-2 rounded-md hover:bg-slate-200">
        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    <div id="menu-panel" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5">
        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
            <div id="menu-admin-controls" class="hidden">
                 <button id="menu-picks-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn active" role="menuitem">My Picks</button>
                 <button id="menu-admin-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem">Admin</button>
                 <button id="survivor-admin-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Survivor Admin</button>
                 <div class="border-t border-gray-200 my-1"></div>
            </div>
            <button id="leaderboard-view-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 view-toggle-btn" role="menuitem">Leaderboard</button>
            <a href="./nerdSurvivor.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Nerd Survivor</a>
            <a href="./nerdfootballTheGrid.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">The Grid</a>
            <button id="settings-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Settings</button>
            <button id="logout-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Logout</button>
        </div>
    </div>
 </div>
 </div>
 </div>
 </header>
 
 <!-- Picks View -->
 <div id="picks-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <div class="mb-6 flex flex-wrap gap-4 justify-between items-center">
 <div>
 <label for="week-selector" class="block text-lg font-medium text-slate-700 mb-2">Select a Week:</label>
 <select id="week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
 </div>
 <div class="flex items-center space-x-4">
 <div id="save-status" class="flex items-center space-x-2 h-10">
 <div id="save-status-icon" class="w-6 h-6"></div>
 <span id="save-status-text" class="text-sm font-medium"></span>
 </div>
 <button id="reset-picks-btn" class="bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-800">Reset Picks</button>
 </div>
 </div>
 <main id="picks-form">
 <div id="lock-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md mb-6" role="alert">
 <p class="font-bold">Picks Locked</p>
 <p>The games for this week have started. Your picks can no longer be changed.</p>
 </div>
 <div id="game-list" class="space-y-6"></div>
 </main>
 </div>
 </div>

 <!-- Leaderboard View -->
  <div id="leaderboard-container" class="hidden">
    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4 text-center">Confidence Pool Leaderboard</h2>
        <div class="flex justify-center items-center mb-4 space-x-2">
            <button id="lb-weekly-btn" class="view-toggle-btn active py-2 px-4 rounded-lg font-semibold border border-gray-300">Weekly</button>
            <button id="lb-season-btn" class="view-toggle-btn py-2 px-4 rounded-lg font-semibold border border-gray-300">Season</button>
        </div>
        <div id="lb-week-selector-container" class="mb-4 text-center">
            <label for="lb-week-selector" class="text-lg font-medium text-gray-700 mr-2">Week:</label>
            <select id="lb-week-selector" class="p-2 rounded-lg border-2 border-gray-300 bg-white"></select>
        </div>
        <div id="public-leaderboard-loader" class="loader hidden"></div>
        <table class="min-w-full divide-y divide-gray-200 public-leaderboard-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                </tr>
            </thead>
            <tbody id="public-leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
</div>


 <!-- Admin View -->
 <div id="admin-container" class="hidden">
 <div class="bg-slate-50 p-6 rounded-lg shadow-xl border border-slate-200">
 <div class="flex justify-between items-center mb-6">
 <h2 class="text-2xl font-bold text-slate-800">Admin Dashboard</h2>
 <select id="admin-week-selector" class="p-3 rounded-lg border-2 border-slate-300 bg-white"></select>
 </div>
 <div class="border-b border-gray-300 mb-6">
 <nav class="-mb-px flex space-x-8" aria-label="Tabs">
 <button id="tab-game-results" class="admin-tab active">Game Results</button>
 <button id="tab-user-mgmt" class="admin-tab">User Management</button>
 <button id="tab-picks-mgmt" class="admin-tab">Picks Management</button>
 <button id="tab-survivor-status" class="admin-tab">Survivor Status</button>
 </nav>
 </div>
 <div id="admin-content-game-results" class="admin-content-section">
 <h3 id="admin-week-title" class="text-xl font-bold mb-4"></h3>
 <div id="results-game-list" class="space-y-4"></div>
 <div class="flex space-x-4 mt-6">
    <button id="save-results-btn" class="w-full bg-green-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-800">Save Game Results</button>
    <button id="reset-winners-btn" class="w-full bg-amber-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-amber-600">Reset All Winners</button>
</div>
 <div id="leaderboard-section" class="mt-8">
 <h3 class="text-xl font-bold mb-4">Live Leaderboard</h3>
 <div id="leaderboard-loader" class="loader hidden"></div>
 <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th></tr></thead><tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200"></tbody></table>
 </div>
 </div>
 <div id="admin-content-user-mgmt" class="admin-content-section hidden">
 <h3 class="text-xl font-bold mb-4">User Management</h3>
 <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="user-mgmt-body" class="bg-white divide-y divide-gray-200"></tbody></table>
 </div>
 <div id="admin-content-picks-mgmt" class="admin-content-section hidden">
 <h3 class="text-xl font-bold mb-4">Edit User Picks</h3>
 <div class="mb-4">
 <label for="user-picks-selector" class="block text-sm font-medium text-gray-700">Select User:</label>
 <select id="user-picks-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm rounded-md"></select>
 </div>
 <div id="user-picks-game-list" class="space-y-6"></div>
 <button id="save-user-picks-btn" class="mt-6 w-full bg-blue-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-800 hidden">Save User's Picks</button>
 </div>
 <div id="admin-content-survivor-status" class="admin-content-section hidden">
    <h3 class="text-xl font-bold mb-4">Survivor Pool Status</h3>
    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">This Week's Pick</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th></tr></thead><tbody id="survivor-status-body" class="bg-white divide-y divide-gray-200"></tbody></table>
</div>
 </div>
 </div>
 </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden flex">
        <div class="p-8 bg-slate-100 rounded-lg shadow-xl max-w-md w-full mx-auto border border-slate-300 relative">
            <button id="close-settings-btn" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">User Settings</h2>
            <div id="settings-error" class="text-red-600 text-center text-sm mb-4 hidden p-3 bg-red-100 rounded-md border border-red-200"></div>
            <div id="settings-success" class="text-green-600 text-center text-sm mb-4 hidden p-3 bg-green-100 rounded-md border border-green-200"></div>
            <form id="settings-form" class="space-y-4">
                <div>
                    <label for="settings-display-name" class="block text-sm font-medium text-slate-700">Display Name</label>
                    <input type="text" id="settings-display-name" required class="mt-1 form-input">
                </div>
                <div>
                    <label for="settings-email" class="block text-sm font-medium text-slate-700">Email Address</label>
                    <input type="email" id="settings-email" required class="mt-1 form-input">
                </div>
                <div class="pt-4">
                    <button type="submit" class="form-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

 <script type="module">
 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
 import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, updateEmail, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
 import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

 const ADMIN_UIDS = ["WxSPmEildJdqs6T5hIpBUZrscwt2", "BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2"];
let saveTimeout;

 document.addEventListener('DOMContentLoaded', () => {
 
 // --- DATA & TIME LOGIC ---
 async function getGamesForWeek(weekNumber) {
 try {
 const response = await fetch(`nfl_2025_week_${weekNumber}.json`);
 if (!response.ok) {
 throw new Error(`Failed to fetch schedule for week ${weekNumber}: ${response.status}`);
 }
 const weekData = await response.json();
 return Array.isArray(weekData.games) ? weekData.games.map(game => ({
 id: game.id,
 away: game.a,
 home: game.h,
 kickoff: game.dt.slice(0, -1),
 stadium: game.stadium
 })) : [];
 } catch (error) {
 console.error(`Error fetching games for week ${weekNumber}:`, error);
 return [];
 }
 }

 function getCurrentNflWeek() {
 const seasonStartDate = new Date('2025-09-04T00:00:00Z');
 const now = new Date();
 
 if (now < seasonStartDate) {
 return 1;
 }

 const diffTime = Math.abs(now - seasonStartDate);
 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
 const week = Math.ceil(diffDays / 7);

 return week > 18 ? 18 : week;
 }

 // --- UI ELEMENTS ---
 const allUI = {
 loadingView: document.getElementById('loading-view'), loginView: document.getElementById('login-view'), appView: document.getElementById('app-view'),
 loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'),
 showRegisterLink: document.getElementById('show-register-link'), showLoginLink: document.getElementById('show-login-link'),
 loginError: document.getElementById('login-error'), registerError: document.getElementById('register-error'),
 logoutBtn: document.getElementById('logout-btn'), userDisplay: document.getElementById('user-display'),
 menuAdminControls: document.getElementById('menu-admin-controls'),
 picksContainer: document.getElementById('picks-container'), adminContainer: document.getElementById('admin-container'),
 picksViewBtn: document.getElementById('menu-picks-view-btn'),
 adminViewBtn: document.getElementById('menu-admin-view-btn'),
 survivorAdminBtn: document.getElementById('survivor-admin-btn'),
 leaderboardViewBtn: document.getElementById('leaderboard-view-btn'),
 weekSelector: document.getElementById('week-selector'), adminWeekSelector: document.getElementById('admin-week-selector'),
 gameList: document.getElementById('game-list'), resultsGameList: document.getElementById('results-game-list'),
 saveResultsBtn: document.getElementById('save-results-btn'),
 leaderboardLoader: document.getElementById('leaderboard-loader'), leaderboardBody: document.getElementById('leaderboard-body'),
 saveStatusIcon: document.getElementById('save-status-icon'), saveStatusText: document.getElementById('save-status-text'),
 resetPicksBtn: document.getElementById('reset-picks-btn'),
 adminTabs: document.querySelectorAll('.admin-tab'), adminContentSections: document.querySelectorAll('.admin-content-section'),
 userMgmtBody: document.getElementById('user-mgmt-body'),
 userPicksSelector: document.getElementById('user-picks-selector'),
 userPicksGameList: document.getElementById('user-picks-game-list'),
 saveUserPicksBtn: document.getElementById('save-user-picks-btn'),
 settingsBtn: document.getElementById('settings-btn'),
 settingsModal: document.getElementById('settings-modal'),
 closeSettingsBtn: document.getElementById('close-settings-btn'),
 settingsForm: document.getElementById('settings-form'),
 settingsDisplayName: document.getElementById('settings-display-name'),
 settingsEmail: document.getElementById('settings-email'),
 settingsError: document.getElementById('settings-error'),
 settingsSuccess: document.getElementById('settings-success'),
 adminWeekTitle: document.getElementById('admin-week-title'),
 resetWinnersBtn: document.getElementById('reset-winners-btn'),
 survivorStatusBody: document.getElementById('survivor-status-body'),
 menuBtn: document.getElementById('menu-btn'),
 menuPanel: document.getElementById('menu-panel'),
 leaderboardContainer: document.getElementById('leaderboard-container'),
 lbWeeklyBtn: document.getElementById('lb-weekly-btn'),
 lbSeasonBtn: document.getElementById('lb-season-btn'),
 lbWeekSelectorContainer: document.getElementById('lb-week-selector-container'),
 lbWeekSelector: document.getElementById('lb-week-selector'),
 publicLeaderboardLoader: document.getElementById('public-leaderboard-loader'),
 publicLeaderboardBody: document.getElementById('public-leaderboard-body'),
 };

 // --- APP STATE ---
 let currentWeek = 1, currentUser = null, db, auth, unsubscribeFromPicks = null, saveTimeout = null;
 let currentAdminPicks = {}, allUsers = [];

 // --- STATE MANAGEMENT ---
 function saveAppState() {
  const state = {
   currentView: getCurrentView(),
   currentWeek: currentWeek,
   leaderboardView: allUI.lbSeasonBtn.classList.contains('active') ? 'season' : 'weekly'
  };
  localStorage.setItem('nerdfootballState', JSON.stringify(state));
  updateUrl();
 }

 function loadAppState() {
  // Prioritize URL params over localStorage
  const urlParams = getUrlParams();
  const saved = localStorage.getItem('nerdfootballState');
  const savedState = saved ? JSON.parse(saved) : {};
  
  return {
   currentView: urlParams.view,
   currentWeek: urlParams.week,
   leaderboardView: urlParams.lb
  };
 }

 function getCurrentView() {
  if (!allUI.adminContainer.classList.contains('hidden')) return 'admin';
  if (!allUI.leaderboardContainer.classList.contains('hidden')) return 'leaderboard';
  return 'picks';
 }

 // --- URL ROUTING ---
 function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
   view: params.get('view') || 'picks',
   week: parseInt(params.get('week')) || getCurrentNflWeek(),
   lb: params.get('lb') || 'weekly'
  };
 }

 function updateUrl() {
  const currentView = getCurrentView();
  const isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
  const params = new URLSearchParams();
  
  if (currentView !== 'picks') params.set('view', currentView);
  if (currentWeek !== getCurrentNflWeek()) params.set('week', currentWeek);
  if (currentView === 'leaderboard' && isSeasonView) params.set('lb', 'season');
  
  const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
  window.history.replaceState({}, '', newUrl);
 }

 // --- ADMIN LOGIC ---
 async function fetchAllUsers() {
 const usersCollectionRef = collection(db, usersPath());
 const usersSnap = await getDocs(usersCollectionRef);
 allUsers = [];
 usersSnap.forEach(doc => {
 allUsers.push({ id: doc.id, ...doc.data() });
 });
 allUsers.sort((a,b) => (a.displayName || a.email).localeCompare(b.displayName || b.email));
 }

 async function renderGameResultsAdmin(weekNumber) {
    allUI.adminWeekTitle.textContent = `Editing Results for Week ${weekNumber}`;
    const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
    if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
        allUI.resultsGameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week.</p>';
        allUI.leaderboardBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">No data for this week.</td></tr>`;
        return;
    }
    
    const picksCollectionRef = collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`);
    const picksSnap = await getDocs(picksCollectionRef);
    const pickCounts = {};
    picksSnap.forEach(pickDoc => {
        const userPicks = pickDoc.data();
        Object.keys(userPicks).forEach(gameId => {
            if (!pickCounts[gameId]) {
                pickCounts[gameId] = { away: 0, home: 0 };
            }
            if (userPicks[gameId].winner) {
                const weekGame = weekData.games.find(g => g.id == gameId);
                if (weekGame && userPicks[gameId].winner === weekGame.away) {
                    pickCounts[gameId].away++;
                } else if (weekGame && userPicks[gameId].winner === weekGame.home) {
                    pickCounts[gameId].home++;
                }
            }
        });
    });

    const resultsDocRef = doc(db, resultsPath(weekNumber));
    const resultsSnap = await getDoc(resultsDocRef);
    const currentResults = resultsSnap.exists() ? resultsSnap.data() : {};
    allUI.resultsGameList.innerHTML = '';

    weekData.games.forEach(game => {
        const winner = currentResults[game.id] || null;
        const gameTime = new Date(game.kickoff);
        const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

        const gameEl = document.createElement('div');
        gameEl.className = 'p-4 border border-slate-300 rounded-lg bg-slate-100';
        gameEl.innerHTML = `
            <div class="grid grid-cols-12 gap-4 items-center">
                <div class="col-span-12 md:col-span-10">
                    <div class="flex justify-around items-center">
                        <div class="w-2/5 text-center">
                            <button data-game-id="${game.id}" data-team="${game.away}" class="result-btn w-full p-2 rounded-lg border-2 ${winner === game.away ? 'selected' : ''}">${game.away}</button>
                        </div>
                        <div class="text-center">
                            <span class="font-bold">@</span>
                            <p class="text-xs text-slate-500 mt-1">${formattedTime}</p>
                        </div>
                        <div class="w-2/5 text-center">
                            <button data-game-id="${game.id}" data-team="${game.home}" class="result-btn w-full p-2 rounded-lg border-2 ${winner === game.home ? 'selected' : ''}">${game.home}</button>
                        </div>
                    </div>
                </div>
            </div>`;
        allUI.resultsGameList.appendChild(gameEl);
    });
    
    allUI.resultsGameList.querySelectorAll('.result-btn').forEach(btn => btn.addEventListener('click', (e) => {
        const { gameId } = e.target.dataset;
        const gameButtons = allUI.resultsGameList.querySelectorAll(`.result-btn[data-game-id="${gameId}"]`);
        gameButtons.forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
    }));
    calculateAndDisplayLeaderboard(weekNumber);
 }


 function renderUserManagement() {
 allUI.userMgmtBody.innerHTML = allUsers.map(user => `
 <tr>
 <td class="px-6 py-4 whitespace-nowrap">${user.displayName || 'N/A'}</td>
 <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
 <td class="px-6 py-4 whitespace-nowrap">
 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.disabled ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
 ${user.disabled ? 'Disabled' : 'Active'}
 </span>
 </td>
 <td class="px-6 py-4 whitespace-nowrap">
 <button data-user-id="${user.id}" data-disabled="${!!user.disabled}" class="user-status-btn text-sm font-medium ${user.disabled ? 'text-green-600 hover:text-green-900' : 'text-red-600 hover:text-red-900'}">
 ${user.disabled ? 'Enable' : 'Disable'}
 </button>
 </td>
 </tr>
 `).join('');
 
 allUI.userMgmtBody.querySelectorAll('.user-status-btn').forEach(btn => {
 btn.addEventListener('click', async (e) => {
 const userId = e.target.dataset.userId;
 if (ADMIN_UIDS.includes(userId)) {
 alert("You cannot disable admin accounts.");
 return;
 }
 const isDisabled = e.target.dataset.disabled === 'true';
 const userDocRef = doc(db, usersPath(), userId);
 await updateDoc(userDocRef, { disabled: !isDisabled });
 await fetchAllUsers();
 renderUserManagement();
 });
 });
 }

 async function renderPicksManagement(weekNumber) {
 allUI.userPicksSelector.innerHTML = '<option value="">Select a user...</option>' + allUsers.map(u => `<option value="${u.id}">${u.displayName || u.email}</option>`).join('');
 allUI.userPicksGameList.innerHTML = '';
 allUI.saveUserPicksBtn.classList.add('hidden');
 }
 
 async function renderSurvivorStatus(weekNumber) {
    allUI.survivorStatusBody.innerHTML = `<tr><td colspan="4" class="text-center py-4"><div class="loader"></div></td></tr>`;
    
    const statusDocRef = doc(db, survivorStatusPath());
    const statusSnap = await getDoc(statusDocRef);
    const allStatuses = statusSnap.exists() ? statusSnap.data() : {};
    
    const picksCollectionRef = collection(db, survivorPicksPath('').slice(0,-1));
    const picksSnap = await getDocs(picksCollectionRef);
    const allPicks = {};
    picksSnap.forEach(doc => {
        allPicks[doc.id] = doc.data();
    });

    const tableRows = allUsers.map(user => {
        const userStatus = allStatuses[user.id] || { eliminated: false };
        const userPicks = allPicks[user.id];
        const thisWeekPick = userPicks && userPicks.picks && userPicks.picks[weekNumber] ? userPicks.picks[weekNumber].team : 'No Pick';
        
        return `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">${user.displayName || user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap">${thisWeekPick}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${userStatus.eliminated ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                        ${userStatus.eliminated ? `Eliminated (Week ${userStatus.eliminatedWeek})` : 'Active'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button data-user-id="${user.id}" data-eliminated="${!!userStatus.eliminated}" class="survivor-status-btn text-sm font-medium ${userStatus.eliminated ? 'text-green-600 hover:text-green-900' : 'text-red-600 hover:text-red-900'}">
                        ${userStatus.eliminated ? 'Reinstate' : 'Eliminate'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    allUI.survivorStatusBody.innerHTML = tableRows || `<tr><td colspan="4" class="text-center py-4">No users in survivor pool.</td></tr>`;

    allUI.survivorStatusBody.querySelectorAll('.survivor-status-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
            const userId = e.target.dataset.userId;
            const isEliminated = e.target.dataset.eliminated === 'true';
            
            const statusUpdate = {};
            if (!isEliminated) {
                if(confirm('Are you sure you want to eliminate this player?')){
                    statusUpdate[`${userId}.eliminated`] = true;
                    statusUpdate[`${userId}.eliminatedWeek`] = weekNumber;
                }
            } else {
                if(confirm('Are you sure you want to reinstate this player?')){
                    statusUpdate[`${userId}`] = deleteField();
                }
            }

            if(Object.keys(statusUpdate).length > 0) {
                await updateDoc(statusDocRef, statusUpdate);
                await renderSurvivorStatus(weekNumber);
            }
        });
    });
}


 async function renderAdminView(weekNumber) {
 const activeTab = document.querySelector('.admin-tab.active').id;
 switch (activeTab) {
 case 'tab-game-results': await renderGameResultsAdmin(weekNumber); break;
 case 'tab-user-mgmt': renderUserManagement(); break;
 case 'tab-picks-mgmt': await renderPicksManagement(weekNumber); break;
 case 'tab-survivor-status': await renderSurvivorStatus(weekNumber); break;
 }
 }

 // --- INITIALIZATION & AUTH ---
 async function initializeAppAndAuth() {
 const firebaseConfig = {
 apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
 authDomain: "nerdfootball.firebaseapp.com",
 projectId: "nerdfootball",
 storageBucket: "nerdfootball.appspot.com",
 messagingSenderId: "969304790725",
 appId: "1:969304790725:web:892df38db0b0e62bde02ac",
 measurementId: "G-8RVRHE3HRC"
 };
 const app = initializeApp(firebaseConfig);
 db = getFirestore(app);
 auth = getAuth(app);
 onAuthStateChanged(auth, handleAuthStateChange);
 }

 async function handleAuthStateChange(user) {
 const savedState = loadAppState();
 
 if (user) {
 const userDocRef = doc(db, usersPath(), user.uid);
 const userDoc = await getDoc(userDocRef);

 if (userDoc.exists() && userDoc.data().disabled) {
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.remove('hidden');
 allUI.loginError.textContent = 'Your account has been disabled.';
 allUI.loginError.classList.remove('hidden');
 await signOut(auth);
 return;
 }
 
 currentUser = user;
 currentWeek = savedState.currentWeek;
 
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.add('hidden');
 allUI.appView.classList.remove('hidden');
 allUI.userDisplay.textContent = `Welcome, ${user.displayName ? user.displayName.split(' ')[0] : 'User'}`;

 await setDoc(userDocRef, { displayName: user.displayName, email: user.email }, { merge: true });

 if (ADMIN_UIDS.includes(user.uid)) {
 allUI.menuAdminControls.classList.remove('hidden');
 await fetchAllUsers();
 }
 
 populateWeekSelectors();
 allUI.weekSelector.value = currentWeek;
 allUI.adminWeekSelector.value = currentWeek;
 allUI.lbWeekSelector.value = currentWeek;

 await loadAndRenderWeek(currentWeek);
 if (ADMIN_UIDS.includes(user.uid)) {
 await renderAdminView(currentWeek);
 }

 // Restore saved view state
 if (savedState.leaderboardView === 'season') {
  allUI.lbSeasonBtn.click();
 }
 
 switch (savedState.currentView) {
  case 'admin':
   if (ADMIN_UIDS.includes(user.uid)) {
    allUI.adminViewBtn.click();
   } else {
    allUI.picksViewBtn.click();
   }
   break;
  case 'leaderboard':
   allUI.leaderboardViewBtn.click();
   break;
  case 'picks':
  default:
   allUI.picksViewBtn.click();
 }

 } else {
 currentUser = null;
 allUI.loadingView.classList.add('hidden');
 allUI.loginView.classList.remove('hidden');
 allUI.appView.classList.add('hidden');
 }
 }
 
 // --- FORM TOGGLING ---
 allUI.showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); allUI.loginForm.classList.add('hidden'); allUI.registerForm.classList.remove('hidden'); });
 allUI.showLoginLink.addEventListener('click', (e) => { e.preventDefault(); allUI.registerForm.classList.add('hidden'); allUI.loginForm.classList.remove('hidden'); });

 // --- AUTH EVENT LISTENERS ---
 allUI.loginForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const email = document.getElementById('login-email').value;
 const password = document.getElementById('login-password').value;
 try {
 await signInWithEmailAndPassword(auth, email, password);
 allUI.loginError.classList.add('hidden');
 } catch (error) {
 allUI.loginError.innerHTML = getAuthErrorMessage(error.code);
 allUI.loginError.classList.remove('hidden');
 }
 });

 allUI.registerForm.addEventListener('submit', async (e) => {
 e.preventDefault();
 const firstName = document.getElementById('register-firstname').value;
 const lastName = document.getElementById('register-lastname').value;
 const email = document.getElementById('register-email').value;
 const password = document.getElementById('register-password').value;
 const confirmPassword = document.getElementById('register-confirm-password').value;

 if (password !== confirmPassword) {
 allUI.registerError.textContent = "Passwords do not match.";
 allUI.registerError.classList.remove('hidden');
 return;
 }
 
 try {
 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
 await updateProfile(userCredential.user, { displayName: `${firstName} ${lastName}` });
 allUI.registerError.classList.add('hidden');
 } catch (error) {
 allUI.registerError.innerHTML = getAuthErrorMessage(error.code);
 allUI.registerError.classList.remove('hidden');
 }
 });

 allUI.logoutBtn.addEventListener('click', () => {
    signOut(auth);
    allUI.menuPanel.classList.add('hidden');
 });
 
 function getAuthErrorMessage(errorCode) {
 switch (errorCode) {
 case 'auth/operation-not-allowed':
 return '<strong>Action Required:</strong><br>Email/Password sign-in is not enabled. Please enable it in your Firebase Console under Authentication -> Sign-in method.';
 case 'auth/invalid-email': 
 return 'Please enter a valid email address.';
 case 'auth/user-not-found':
 case 'auth/wrong-password': 
 return 'Invalid email or password.';
 case 'auth/email-already-in-use': 
 return 'An account with this email already exists.';
 case 'auth/weak-password': 
 return 'Password should be at least 6 characters.';
 default: 
 return 'An unexpected error occurred. Please try again.';
 }
 }
 
 // --- DATA PATH HELPERS ---
 const appId = () => 'nerdfootball'; 
 const picksPath = (week, uid) => `artifacts/${appId()}/public/data/nerdfootball_picks/${week}/submissions/${uid}`;
 const resultsPath = (week) => `artifacts/${appId()}/public/data/nerdfootball_results/${week}`;
 const usersPath = () => `artifacts/${appId()}/public/data/nerdfootball_users`;
 const survivorPicksPath = (uid) => `artifacts/${appId()}/public/data/nerdSurvivor_picks/${uid}`;
 const survivorStatusPath = () => `artifacts/${appId()}/public/data/nerdSurvivor_status/status`;


 
 // --- SAVE STATUS ---
 function updateSaveStatus(status, message) {
 if(saveTimeout) clearTimeout(saveTimeout);
 allUI.saveStatusIcon.style.animation = 'none';
 
 switch(status) {
 case 'saving':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusIcon.style.animation = 'spin 1s linear infinite';
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-gray-500';
 break;
 case 'saved':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-green-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 2500);
 break;
 case 'error':
 allUI.saveStatusIcon.innerHTML = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 19.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`;
 allUI.saveStatusText.textContent = message;
 allUI.saveStatusText.className = 'text-sm font-medium text-red-600';
 saveTimeout = setTimeout(() => updateSaveStatus('idle', ''), 3000);
 break;
 case 'idle':
 default:
 allUI.saveStatusIcon.innerHTML = '';
 allUI.saveStatusText.textContent = '';
 break;
 }
 }

 async function getWeekLockStatus(weekNumber) { 
 const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) }; 
 if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) return false; 
 const firstKickoff = new Date(weekData.games[0].kickoff); 
 return new Date() > firstKickoff; 
 }
 
 async function loadAndRenderWeek(weekNumber) { 
 currentWeek = parseInt(weekNumber, 10);
 if (!currentUser) return; 
 if (unsubscribeFromPicks) unsubscribeFromPicks(); 
 updateSaveStatus('idle');

 allUI.gameList.innerHTML = `<div class="loader"></div>`;
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 allUI.resetPicksBtn.disabled = weekIsLocked;
 
 const docRef = doc(db, picksPath(currentWeek, currentUser.uid)); 
 
 const games = await getGamesForWeek(currentWeek);
 if (!Array.isArray(games) || games.length === 0) {
     allUI.gameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week. Please try again later.</p>';
     return;
 }

 unsubscribeFromPicks = onSnapshot(docRef, (docSnap) => { 
 let userPicks = {}; 
 const weekData = { week: currentWeek, games: games };

 if (docSnap.exists()) { 
 userPicks = docSnap.data(); 
 } else { 
 weekData.games.forEach((game, index) => { 
 userPicks[game.id] = { winner: null, confidence: index + 1 }; 
 }); 
 } 
 renderWeekUI(weekData, userPicks, weekIsLocked, allUI.gameList); 
 }); 
 }

 async function savePicksToFirestore(weekNum, picks) { 
 if (!currentUser || await getWeekLockStatus(weekNum)) return; 
 updateSaveStatus('saving', 'Saving...');
 const docRef = doc(db, picksPath(weekNum, currentUser.uid)); 
 try { 
 await setDoc(docRef, picks); 
 updateSaveStatus('saved', 'Picks Saved!');
 } catch (error) { 
 console.error("Error saving picks:", error); 
 updateSaveStatus('error', 'Save Failed');
 } 
 }

 async function calculateAndDisplayLeaderboard(weekNumber, targetBody = allUI.leaderboardBody, loader = allUI.leaderboardLoader) {
    loader.classList.remove('hidden');
    targetBody.innerHTML = '';

    const usersSnap = await getDocs(collection(db, usersPath()));
    const users = {};
    usersSnap.forEach(doc => users[doc.id] = doc.data());
    
    let scores = {};
    for (const id in users) {
        scores[id] = { userId: id, displayName: users[id].displayName, score: 0 };
    }

    if (weekNumber) { // Weekly calculation
        const resultsSnap = await getDoc(doc(db, resultsPath(weekNumber)));
        const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
        const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${weekNumber}/submissions`));
        
        picksSnap.forEach(pickDoc => {
            const userId = pickDoc.id;
            if (scores[userId]) {
                const userPicks = pickDoc.data();
                let userScore = 0;
                Object.keys(userPicks).forEach(gameId => {
                    const pick = userPicks[gameId];
                    if (gameResults[gameId] && pick.winner === gameResults[gameId]) {
                        userScore += pick.confidence;
                    }
                });
                scores[userId].score = userScore;
            }
        });
    } else { // Season calculation
        for (let i = 1; i <= currentWeek; i++) {
            const resultsSnap = await getDoc(doc(db, resultsPath(i)));
            const gameResults = resultsSnap.exists() ? resultsSnap.data() : {};
            const picksSnap = await getDocs(collection(db, `artifacts/${appId()}/public/data/nerdfootball_picks/${i}/submissions`));

            picksSnap.forEach(pickDoc => {
                const userId = pickDoc.id;
                if (scores[userId]) {
                    const userPicks = pickDoc.data();
                    let userScore = 0;
                    Object.keys(userPicks).forEach(gameId => {
                        const pick = userPicks[gameId];
                        if (gameResults[gameId] && pick.winner === gameResults[gameId]) {
                            userScore += pick.confidence;
                        }
                    });
                    scores[userId].score += userScore;
                }
            });
        }
    }
    
    const sortedScores = Object.values(scores).sort((a, b) => b.score - a.score);
    targetBody.innerHTML = sortedScores.map((s, index) => `<tr><td class="px-6 py-4 whitespace-nowrap font-medium">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap">${s.displayName}</td><td class="px-6 py-4 whitespace-nowrap font-bold">${s.score}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center py-4">No picks submitted yet.</td></tr>`;
    loader.classList.add('hidden');
}


 function populateWeekSelectors() {
 const options = Array.from({ length: 18 }, (_, i) => `<option value="${i + 1}">Week ${i + 1}</option>`).join('');
 allUI.weekSelector.innerHTML = options;
 allUI.adminWeekSelector.innerHTML = options;
 allUI.lbWeekSelector.innerHTML = options;
 }

 function renderWeekUI(weekData, userPicks, weekIsLocked, targetContainer = allUI.gameList) {
 targetContainer.innerHTML = '';
 if (!weekData || !Array.isArray(weekData.games) || weekData.games.length === 0) {
 targetContainer.innerHTML = '<p class="text-center text-gray-500">No games are scheduled for this week.</p>';
 return;
 }
 const totalGames = weekData.games.length;
 const confidenceOptions = Array.from({ length: totalGames }, (_, i) => i + 1);
 
 weekData.games.forEach(game => {
 const pick = userPicks[game.id] || { winner: null, confidence: 0 };
 const gameRow = document.createElement('div');
 gameRow.className = 'p-4 border border-slate-300 rounded-lg bg-slate-100';
 const gameTime = new Date(game.kickoff);
 const formattedTime = gameTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });

 gameRow.innerHTML = `
 <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
 <div class="md:col-span-8">
 <div class="flex flex-col sm:flex-row justify-around items-center gap-2">
 <button data-game-id="${game.id}" data-team="${game.away}" ${weekIsLocked ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.away ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.away}</button>
 <span class="text-slate-500 font-bold">@</span>
 <button data-game-id="${game.id}" data-team="${game.home}" ${weekIsLocked ? 'disabled' : ''} class="winner-btn w-full sm:w-2/5 text-center p-3 rounded-lg border-2 border-slate-400 font-semibold ${pick.winner === game.home ? 'selected' : 'bg-slate-50 hover:bg-slate-200'}">${game.home}</button>
 </div>
 </div>
 <div class="md:col-span-4">
 <select id="confidence-${game.id}" name="confidence-${game.id}" data-game-id="${game.id}" ${weekIsLocked ? 'disabled' : ''} class="confidence-select w-full p-3 rounded-lg border-2 border-slate-300 bg-white">${confidenceOptions.map(opt => `<option value="${opt}" ${pick.confidence === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>
 </div>
 </div>
 <div class="mt-3 pt-3 border-t border-slate-300 text-xs text-slate-600 grid grid-cols-2 md:grid-cols-4 gap-2">
 <div><p class="font-bold">Date & Time</p><p>${formattedTime}</p></div>
 <div><p class="font-bold">Stadium</p><p>${game.stadium}</p></div>
 <div><p class="font-bold">Weather</p><p>${game.weather || 'TBD'}</p></div>
 <div><p class="font-bold">Starting QBs</p><p>${(game.startingQBs && game.startingQBs.away) ? `${game.startingQBs.away} vs ${game.startingQBs.home}` : 'TBD'}</p></div>
 </div>`;
 targetContainer.appendChild(gameRow);
 });

 let activePicks = JSON.parse(JSON.stringify(userPicks));
 
 const saveFunction = targetContainer === allUI.gameList ? savePicksToFirestore : (wk, pks) => { currentAdminPicks = pks; };

 targetContainer.querySelectorAll('.winner-btn').forEach(btn => {
 btn.addEventListener('click', (e) => {
 const gameId = e.target.dataset.gameId;
 const team = e.target.dataset.team;
 activePicks[gameId].winner = team;
 targetContainer.querySelectorAll(`.winner-btn[data-game-id="${gameId}"]`).forEach(b => b.classList.remove('selected'));
 e.target.classList.add('selected');
 saveFunction(currentWeek, activePicks);
 });
 });

 targetContainer.querySelectorAll('.confidence-select').forEach(select => {
 select.addEventListener('change', (e) => {
 const gameId = e.target.dataset.gameId;
 const newConfidence = parseInt(e.target.value, 10);
 const oldConfidence = activePicks[gameId].confidence;
 if (newConfidence === oldConfidence) return;
 const otherGameId = Object.keys(activePicks).find(id => id !== gameId && activePicks[id].confidence === newConfidence);
 if (otherGameId) {
 activePicks[otherGameId].confidence = oldConfidence;
 const otherSelect = targetContainer.querySelector(`.confidence-select[data-game-id="${otherGameId}"]`);
 if (otherSelect) otherSelect.value = oldConfidence;
 }
 activePicks[gameId].confidence = newConfidence;
 saveFunction(currentWeek, activePicks);
 });
 });
 }

 function toggleViews(showAdmin) {
    allUI.adminContainer.classList.toggle('hidden', showAdmin);
    allUI.picksContainer.classList.toggle('hidden', !showAdmin);
    allUI.leaderboardContainer.classList.add('hidden'); // Always hide leaderboard when toggling admin/picks

    allUI.adminViewBtn.classList.toggle('active', showAdmin);
    allUI.picksViewBtn.classList.toggle('active', !showAdmin);
    allUI.leaderboardViewBtn.classList.remove('active');
 }

 // --- EVENT LISTENERS ---
 allUI.picksViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.remove('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.picksViewBtn.classList.add('active');
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });

 allUI.adminViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.adminContainer.classList.remove('hidden');
    allUI.leaderboardContainer.classList.add('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.adminViewBtn.classList.add('active');
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });
 
 allUI.survivorAdminBtn.addEventListener('click', () => {
    allUI.menuPanel.classList.add('hidden');
    // Set flag to show admin panel when landing on survivor page
    sessionStorage.setItem('survivorAdminView', 'true');
    // Force immediate navigation
    setTimeout(() => {
        window.location.href = './nerdSurvivor.html';
    }, 50);
 });
 
 allUI.leaderboardViewBtn.addEventListener('click', () => {
    allUI.picksContainer.classList.add('hidden');
    allUI.adminContainer.classList.add('hidden');
    allUI.leaderboardContainer.classList.remove('hidden');
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    allUI.leaderboardViewBtn.classList.add('active');
    renderPublicLeaderboard();
    allUI.menuPanel.classList.add('hidden');
    saveAppState();
 });

 async function renderPublicLeaderboard() {
    allUI.publicLeaderboardLoader.classList.remove('hidden');
    allUI.publicLeaderboardBody.innerHTML = '';
    
    let isSeasonView = allUI.lbSeasonBtn.classList.contains('active');
    
    if (isSeasonView) {
        await calculateAndDisplayLeaderboard(null, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    } else {
        const week = allUI.lbWeekSelector.value;
        await calculateAndDisplayLeaderboard(week, allUI.publicLeaderboardBody, allUI.publicLeaderboardLoader);
    }
}

 allUI.lbWeeklyBtn.addEventListener('click', () => {
    allUI.lbWeeklyBtn.classList.add('active');
    allUI.lbSeasonBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.remove('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbSeasonBtn.addEventListener('click', () => {
    allUI.lbSeasonBtn.classList.add('active');
    allUI.lbWeeklyBtn.classList.remove('active');
    allUI.lbWeekSelectorContainer.classList.add('hidden');
    renderPublicLeaderboard();
    saveAppState();
 });
 allUI.lbWeekSelector.addEventListener('change', renderPublicLeaderboard);


 allUI.weekSelector.addEventListener('change', (e) => {
  loadAndRenderWeek(e.target.value);
  saveAppState();
 });
 allUI.adminWeekSelector.addEventListener('change', (e) => renderAdminView(e.target.value));
 allUI.saveResultsBtn.addEventListener('click', async () => {
 const weekNumber = allUI.adminWeekSelector.value;
 const newResults = {};
 allUI.resultsGameList.querySelectorAll('.result-btn.selected').forEach(btn => {
 newResults[btn.dataset.gameId] = btn.dataset.team;
 });
 await setDoc(doc(db, resultsPath(weekNumber)), newResults);
 alert('Results saved successfully!');
 calculateAndDisplayLeaderboard(weekNumber);
 });
 allUI.resetPicksBtn.addEventListener('click', async () => {
 const weekIsLocked = await getWeekLockStatus(currentWeek);
 if (weekIsLocked) return;

 const weekData = { week: currentWeek, games: await getGamesForWeek(currentWeek) };
 if (!Array.isArray(weekData.games) || weekData.games.length === 0) return;

 const resetPicks = {};
 weekData.games.forEach((game, index) => {
 resetPicks[game.id] = { winner: null, confidence: index + 1 };
 });
 await savePicksToFirestore(currentWeek, resetPicks);
 });
 allUI.userPicksSelector.addEventListener('change', async (e) => {
 const selectedUserId = e.target.value;
 if (!selectedUserId) {
 allUI.userPicksGameList.innerHTML = '';
 allUI.saveUserPicksBtn.classList.add('hidden');
 return;
 }
 const weekNumber = parseInt(allUI.adminWeekSelector.value, 10);
 const docRef = doc(db, picksPath(weekNumber, selectedUserId));
 const docSnap = await getDoc(docRef);

 const weekData = { week: weekNumber, games: await getGamesForWeek(weekNumber) };
 if (!Array.isArray(weekData.games) || weekData.games.length === 0) {
 allUI.userPicksGameList.innerHTML = '<p class="text-center text-red-600">Error loading games for this week.</p>';
 allUI.saveUserPicksBtn.classList.add('hidden');
 return;
 }
 let userPicks = {};
 if (docSnap.exists()) {
 userPicks = docSnap.data();
 } else {
 weekData.games.forEach((game, index) => {
 userPicks[game.id] = { winner: null, confidence: index + 1 };
 });
 }
 currentAdminPicks = userPicks;
 renderWeekUI(weekData, userPicks, false, allUI.userPicksGameList);
 allUI.saveUserPicksBtn.classList.remove('hidden');
 });
 allUI.saveUserPicksBtn.addEventListener('click', async () => {
 const selectedUserId = allUI.userPicksSelector.value;
 const weekNumber = allUI.adminWeekSelector.value;
 if (!selectedUserId) return;

 const docRef = doc(db, picksPath(weekNumber, selectedUserId));
 await setDoc(docRef, currentAdminPicks);
 alert(`${allUI.userPicksSelector.options[allUI.userPicksSelector.selectedIndex].text}'s picks have been saved.`);
 });
 allUI.adminTabs.forEach(tab => {
 tab.addEventListener('click', (e) => {
 allUI.adminTabs.forEach(t => t.classList.remove('active'));
 e.target.classList.add('active');
 allUI.adminContentSections.forEach(s => s.classList.add('hidden'));
 const contentId = `admin-content-${e.target.id.substring(4)}`;
 document.getElementById(contentId).classList.remove('hidden');
 renderAdminView(allUI.adminWeekSelector.value);
 });
 });
 
 allUI.menuBtn.addEventListener('click', () => {
    allUI.menuPanel.classList.toggle('hidden');
 });

 window.addEventListener('click', (e) => {
    if (!allUI.menuBtn.contains(e.target) && !allUI.menuPanel.contains(e.target)) {
        allUI.menuPanel.classList.add('hidden');
    }
 });

 allUI.settingsBtn.addEventListener('click', () => {
    if (!currentUser) return;
    allUI.settingsDisplayName.value = currentUser.displayName || '';
    allUI.settingsEmail.value = currentUser.email || '';
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    allUI.settingsModal.classList.remove('hidden');
    allUI.settingsModal.classList.add('flex');
    allUI.menuPanel.classList.add('hidden');
 });

 allUI.closeSettingsBtn.addEventListener('click', () => {
    allUI.settingsModal.classList.add('hidden');
    allUI.settingsModal.classList.remove('flex');
 });

 allUI.settingsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newDisplayName = allUI.settingsDisplayName.value;
    const newEmail = allUI.settingsEmail.value;
    allUI.settingsError.classList.add('hidden');
    allUI.settingsSuccess.classList.add('hidden');
    try {
        if (newDisplayName !== currentUser.displayName) {
            await updateProfile(currentUser, { displayName: newDisplayName });
        }
        if (newEmail !== currentUser.email) {
            await updateEmail(auth.currentUser, newEmail);
        }
        const userDocRef = doc(db, usersPath(), currentUser.uid);
        await updateDoc(userDocRef, {
            displayName: newDisplayName,
            email: newEmail
        });
        allUI.settingsSuccess.textContent = 'Settings updated successfully!';
        allUI.settingsSuccess.classList.remove('hidden');
        allUI.userDisplay.textContent = `Welcome, ${newDisplayName ? newDisplayName.split(' ')[0] : 'User'}`;
        setTimeout(() => {
            allUI.settingsModal.classList.add('hidden');
            allUI.settingsModal.classList.remove('flex');
        }, 2000);
    } catch (error) {
        console.error("Error updating settings:", error);
        allUI.settingsError.textContent = `Error: ${error.message}. You may need to log out and log back in to change your email.`;
        allUI.settingsError.classList.remove('hidden');
    }
 });

 allUI.resetWinnersBtn.addEventListener('click', async () => {
    const weekNumber = allUI.adminWeekSelector.value;
    if (confirm(`Are you sure you want to reset all winners for Week ${weekNumber}? This cannot be undone.`)) {
        const resultsDocRef = doc(db, resultsPath(weekNumber));
        try {
            await deleteDoc(resultsDocRef);
            alert(`Winners for Week ${weekNumber} have been reset.`);
            await renderGameResultsAdmin(weekNumber);
        } catch (error) {
            console.error("Error resetting winners:", error);
            alert("An error occurred while resetting the winners.");
        }
    }
 });

 initializeAppAndAuth();
 });
 </script>
</body>
</html>