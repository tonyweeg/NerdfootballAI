<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Weekly Leaderboard - NerdFootball</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- NFL 2025 Season Week Calendar (Bible-based) -->
    <script>
        window.NFL_2025_WEEKS = {
            1: { start: '2025-09-04', games: '2025-09-04' },
            2: { start: '2025-09-08', games: '2025-09-11' },
            3: { start: '2025-09-15', games: '2025-09-21' },
            4: { start: '2025-09-22', games: '2025-09-26' },
            5: { start: '2025-09-29', games: '2025-10-03' },
            6: { start: '2025-10-06', games: '2025-10-10' },
            7: { start: '2025-10-13', games: '2025-10-17' },
            8: { start: '2025-10-20', games: '2025-10-24' },
            9: { start: '2025-10-27', games: '2025-10-31' },
            10: { start: '2025-11-03', games: '2025-11-07' },
            11: { start: '2025-11-10', games: '2025-11-14' },
            12: { start: '2025-11-17', games: '2025-11-21' },
            13: { start: '2025-11-24', games: '2025-11-28' },
            14: { start: '2025-12-01', games: '2025-12-05' },
            15: { start: '2025-12-08', games: '2025-12-12' },
            16: { start: '2025-12-15', games: '2025-12-19' },
            17: { start: '2025-12-22', games: '2025-12-26' },
            18: { start: '2025-12-29', games: '2026-01-02' }
        };

        // Bible-based current week detection
        window.getCurrentNFLWeek = function() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format

            // Find current week based on today's date
            for (let week = 1; week <= 18; week++) {
                const weekData = window.NFL_2025_WEEKS[week];
                const weekStart = new Date(weekData.start);
                const nextWeek = window.NFL_2025_WEEKS[week + 1];
                const weekEnd = nextWeek ? new Date(nextWeek.start) : new Date('2026-01-10');

                if (today >= weekStart && today < weekEnd) {
                    return week;
                }
            }

            // Fallback - if we're before week 1, return 1; if after week 18, return 18
            if (todayStr < '2025-09-04') return 1;
            return 18;
        };
    </script>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Nintendo-inspired game console styling */
        .game-console {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            border: 3px solid #00ff41;
            box-shadow:
                0 0 20px rgba(0, 255, 65, 0.3),
                inset 0 0 30px rgba(0, 255, 65, 0.1);
        }

        .game-button {
            background: linear-gradient(145deg, #2a2d47 0%, #1a1d37 100%);
            border: 2px solid #00ff41;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(0, 255, 65, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            transform: translateY(0);
            transition: all 0.1s ease;
        }

        .game-button:hover {
            box-shadow:
                0 6px 12px rgba(0, 0, 0, 0.4),
                0 0 25px rgba(0, 255, 65, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .game-button:active {
            transform: translateY(2px);
            box-shadow:
                0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 10px rgba(0, 255, 65, 0.3);
        }

        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
        }

        /* Week display HUD style */
        .week-hud {
            background: radial-gradient(circle, #00ff41 0%, #00cc33 100%);
            color: #000;
            border: 3px solid #fff;
            box-shadow:
                0 0 20px rgba(0, 255, 65, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Power-up indicators for live games */
        .power-up {
            animation: powerUpPulse 1.5s ease-in-out infinite;
        }

        @keyframes powerUpPulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 0, 255, 1);
                transform: scale(1.05);
            }
        }

        /* Game-style transitions */
        .slide-transition {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Nintendo controller D-pad styling */
        .dpad-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .dpad-button {
            position: absolute;
            background: linear-gradient(145deg, #333 0%, #111 100%);
            border: 2px solid #00ff41;
            color: #00ff41;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
        }

        .dpad-up, .dpad-down {
            width: 40px;
            height: 35px;
            left: 40px;
        }

        .dpad-up {
            top: 0;
            border-radius: 8px 8px 4px 4px;
        }

        .dpad-down {
            bottom: 0;
            border-radius: 4px 4px 8px 8px;
        }

        .dpad-left, .dpad-right {
            width: 35px;
            height: 40px;
            top: 40px;
        }

        .dpad-left {
            left: 0;
            border-radius: 8px 4px 4px 8px;
        }

        .dpad-right {
            right: 0;
            border-radius: 4px 8px 8px 4px;
        }

        .dpad-center {
            top: 35px;
            left: 35px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle, #00ff41 0%, #00cc33 100%);
            color: #000;
            border: 3px solid #fff;
            font-size: 18px;
            font-weight: bold;
        }

        /* Live game indicator */
        .live-indicator {
            animation: liveGlow 2s ease-in-out infinite;
            background: linear-gradient(45deg, #ff0066, #ff3366, #ff0066);
        }

        @keyframes liveGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 102, 0.8);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 102, 1);
            }
        }

        /* Terminal theme consistency */
        .terminal-bg {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        }
        .terminal-text { color: #00ff41; }
        .terminal-accent { color: #ff6b6b; }
        .terminal-secondary { color: #4ecdc4; }
        .terminal-muted { color: #95a5a6; }
        .terminal-surface { background: rgba(0, 255, 65, 0.1); }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Loading animation */
        .loading-dots::after {
            content: '';
            animation: dots 2s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Matrix background effect */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }

        /* Basic CSS to replace disabled Tailwind */
        .container { max-width: 1200px; margin: 0 auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .border-b-2 { border-bottom-width: 2px; }
        .min-h-screen { min-height: 100vh; }
        .hidden { display: none; }
        .text-center { text-align: center; }
        .rounded-lg { border-radius: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .p-6 { padding: 1.5rem; }

        /* HEADER NON-STICKY OVERRIDE */
        header {
            position: static !important;
            display: block !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            z-index: 1 !important;
        }
    </style>
</head>

<body class="terminal-bg min-h-screen">
    <!-- Matrix background canvas -->
    <canvas id="matrixCanvas" class="matrix-bg"></canvas>

    <!-- Header -->
    <header class="border-b-2 border-terminal-accent">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="./nerd-universe.html" class="game-button px-3 py-2 rounded-md text-sm mr-4 hover:bg-terminal-accent/20 transition-all duration-200">
                        ‚Üê BACK TO UNIVERSE
                    </a>
                    <h1 class="text-2xl font-bold terminal-text">üéÆ WEEKLY LEADERBOARD</h1>
                    <div class="text-sm terminal-muted">Real-time Nintendo-style rankings</div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="live-status" class="hidden px-3 py-1 rounded-full text-xs font-bold live-indicator text-white">
                        üî¥ LIVE GAMES
                    </div>
                    <span id="user-display" class="text-sm terminal-secondary">Loading...</span>
                    <div id="auth-status" class="text-sm terminal-muted">Authenticating...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading Screen -->
        <div id="loading-screen" class="game-console rounded-2xl p-8 text-center mb-8">
            <div class="text-4xl terminal-accent mb-4">üéÆ</div>
            <h2 class="text-xl font-bold mb-4 terminal-text">Loading Game Data<span class="loading-dots"></span></h2>
            <div class="terminal-muted">Initializing Nintendo-style controls...</div>
            <div class="mt-4">
                <div class="inline-block w-8 h-8 border-t-2 border-terminal-accent rounded-full animate-spin"></div>
            </div>
        </div>

        <!-- Nintendo-style Week Navigation -->
        <div id="week-controls" class="hidden game-console rounded-2xl p-6 mb-8">
            <div class="text-center mb-6">
                <h2 class="text-lg font-bold terminal-text mb-4">üïπÔ∏è SELECT WEEK</h2>

                <!-- Week HUD Display -->
                <div class="week-hud rounded-full px-6 py-3 inline-block text-2xl mb-6">
                    WEEK <span id="current-week-display">4</span>
                </div>

                <!-- Nintendo D-Pad Style Controls -->
                <div class="dpad-container mb-6">
                    <button class="dpad-button dpad-up" id="week-up" title="Next Week">‚ñ≤</button>
                    <button class="dpad-button dpad-down" id="week-down" title="Previous Week">‚ñº</button>
                    <button class="dpad-button dpad-left" id="week-fast-back" title="Jump Back 5 Weeks">‚óÑ</button>
                    <button class="dpad-button dpad-right" id="week-fast-forward" title="Jump Forward 5 Weeks">‚ñ∫</button>
                </div>

                <!-- Game Controller Style Buttons -->
                <div class="flex justify-center space-x-4 mb-4">
                    <button class="game-button px-4 py-2 rounded-lg terminal-text font-bold" id="week-first">
                        üèÅ WEEK 1
                    </button>
                    <button class="game-button px-4 py-2 rounded-lg terminal-text font-bold" id="week-current">
                        ‚ö° CURRENT
                    </button>
                    <button class="game-button px-4 py-2 rounded-lg terminal-text font-bold" id="week-latest">
                        üèÜ LATEST
                    </button>
                </div>

                <!-- Quick Week Selector -->
                <div class="grid grid-cols-6 gap-2 max-w-md mx-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Game Stats HUD -->
            <div id="game-stats" class="grid grid-cols-3 gap-4 text-center">
                <div class="terminal-surface rounded-lg p-3">
                    <div class="terminal-accent text-2xl font-bold" id="live-games-count">0</div>
                    <div class="text-sm terminal-muted">Live Games</div>
                </div>
                <div class="terminal-surface rounded-lg p-3">
                    <div class="terminal-secondary text-2xl font-bold" id="completed-games-count">0</div>
                    <div class="text-sm terminal-muted">Completed</div>
                </div>
                <div class="terminal-surface rounded-lg p-3">
                    <div class="terminal-text text-2xl font-bold" id="upcoming-games-count">0</div>
                    <div class="text-sm terminal-muted">Upcoming</div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Display -->
        <div id="leaderboard-container" class="hidden">
            <!-- Podium Display (Top 3) -->
            <div id="podium-container" class="game-console rounded-2xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-center terminal-text mb-6">üèÜ WEEKLY CHAMPIONS</h2>
                <div class="grid grid-cols-3 gap-4" id="podium">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Full Leaderboard Table -->
            <div id="full-leaderboard" class="game-console rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold terminal-text">üìä FULL RANKINGS</h2>
                    <div id="last-updated" class="text-sm terminal-muted">Last updated: --</div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-terminal-accent">
                                <th class="text-left py-3 px-2 terminal-accent font-bold">#</th>
                                <th class="text-left py-3 px-2 terminal-accent font-bold">Player</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Points</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Correct</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Accuracy</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Behind</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-container" class="hidden game-console rounded-2xl p-6 text-center">
            <div class="text-4xl terminal-accent mb-4">‚ö†Ô∏è</div>
            <h2 class="text-xl font-bold mb-4 terminal-text">Game Error</h2>
            <div id="error-message" class="terminal-muted mb-4">Something went wrong...</div>
            <button class="game-button px-6 py-2 rounded-lg terminal-text font-bold" onclick="window.location.reload()">
                üîÑ RESTART GAME
            </button>
        </div>
    </main>

    <!-- Firebase SDK and Authentication -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;

        // Global variables
        let currentWeek = window.getCurrentNFLWeek();
        let leaderboardData = null;
        let updateInterval = null;

        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const weekControls = document.getElementById('week-controls');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const errorContainer = document.getElementById('error-container');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const userDisplay = document.getElementById('user-display');
        const authStatus = document.getElementById('auth-status');
        const liveStatus = document.getElementById('live-status');

        // Authentication handling
        async function initializeAuth() {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userDisplay.textContent = `Welcome, ${user.displayName || user.email}`;
                        authStatus.textContent = '‚úÖ Authenticated';
                        resolve(true);
                    } else {
                        userDisplay.textContent = 'Not signed in';
                        authStatus.textContent = '‚ùå Sign in required';
                        resolve(false);
                    }
                });
            });
        }

        // Nintendo-style week navigation
        function initializeWeekControls() {
            // D-Pad controls
            document.getElementById('week-up').onclick = () => changeWeek(currentWeek + 1);
            document.getElementById('week-down').onclick = () => changeWeek(currentWeek - 1);
            document.getElementById('week-fast-forward').onclick = () => changeWeek(currentWeek + 5);
            document.getElementById('week-fast-back').onclick = () => changeWeek(currentWeek - 5);

            // Game buttons
            document.getElementById('week-first').onclick = () => changeWeek(1);
            document.getElementById('week-current').onclick = () => changeWeek(getCurrentWeekNumber());
            document.getElementById('week-latest').onclick = () => changeWeek(18);

            // Generate quick week selector grid
            const quickSelector = weekControls.querySelector('.grid.grid-cols-6');
            for (let week = 1; week <= 18; week++) {
                const btn = document.createElement('button');
                btn.className = 'game-button text-xs py-2 px-1 rounded terminal-text font-bold';
                btn.textContent = week;
                btn.onclick = () => changeWeek(week);
                quickSelector.appendChild(btn);
            }
        }

        // Change week with Nintendo-style transition
        async function changeWeek(newWeek) {
            if (newWeek < 1 || newWeek > 18 || newWeek === currentWeek) return;

            currentWeek = newWeek;
            updateWeekDisplay();

            // Add slide transition effect
            leaderboardContainer.style.transform = 'translateX(100%)';
            setTimeout(() => {
                loadWeeklyLeaderboard();
                leaderboardContainer.style.transform = 'translateX(0)';
            }, 150);
        }

        function updateWeekDisplay() {
            currentWeekDisplay.textContent = currentWeek;

            // Update button states
            document.getElementById('week-up').disabled = currentWeek >= 18;
            document.getElementById('week-down').disabled = currentWeek <= 1;
            document.getElementById('week-fast-forward').disabled = currentWeek > 13;
            document.getElementById('week-fast-back').disabled = currentWeek <= 5;
        }

        // Load weekly leaderboard data
        async function loadWeeklyLeaderboard() {
            try {
                showLoading();
                console.log(`üéÆ Loading Week ${currentWeek} leaderboard...`);

                const response = await fetch(`https://getweeklyleaderboard-np7uealtnq-uc.a.run.app?week=${currentWeek}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üéÆ Response from backend:', result);

                if (result.success) {
                    leaderboardData = result.data;

                    // Check if week has meaningful data (games started or completed)
                    const hasGamesStarted = result.data.gameStates &&
                        (result.data.gameStates.live > 0 || result.data.gameStates.completed > 0);
                    const hasScores = result.data.metadata && result.data.metadata.highScore > 0;

                    if (!hasGamesStarted && !hasScores && result.data.gameStates.upcoming > 0) {
                        // Week hasn't started yet - show helpful message
                        showNoDataMessage(currentWeek, result.data);
                    } else {
                        renderWeeklyLeaderboard(leaderboardData);
                        updateGameStats(leaderboardData.gameStates, leaderboardData.metadata);

                        // Start real-time updates if there are live games
                        if (leaderboardData.gameStates.live > 0) {
                            startLiveUpdates();
                        } else {
                            stopLiveUpdates();
                        }
                    }
                } else if (result.regenerating) {
                    // Cache not found - backend is generating fresh data
                    console.log('üîÑ Backend is regenerating cache for Week', currentWeek);
                    showNoDataMessage(currentWeek, {
                        gameStates: { upcoming: 1 },
                        metadata: { highScore: 0 }
                    });
                } else {
                    throw new Error(result.error || 'Failed to load leaderboard');
                }

            } catch (error) {
                console.error('‚ùå Error loading weekly leaderboard:', error);
                showError(`Failed to load Week ${currentWeek} leaderboard: ${error.message}`);
            }
        }

        // Render Nintendo-style leaderboard
        function renderWeeklyLeaderboard(data) {
            renderPodium(data.standings.slice(0, 3));
            renderFullLeaderboard(data.standings);

            document.getElementById('last-updated').textContent =
                `Last updated: ${new Date(data.generatedAt).toLocaleTimeString()}`;

            showLeaderboard();
        }

        function renderPodium(topThree) {
            const podium = document.getElementById('podium');
            podium.innerHTML = '';

            const positions = [
                { place: 2, class: 'order-1', medal: 'ü•à', height: 'h-24' },
                { place: 1, class: 'order-2', medal: 'ü•á', height: 'h-32' },
                { place: 3, class: 'order-3', medal: 'ü•â', height: 'h-20' }
            ];

            positions.forEach(pos => {
                const user = topThree[pos.place - 1];
                const podiumDiv = document.createElement('div');
                podiumDiv.className = `${pos.class} text-center`;

                if (user) {
                    podiumDiv.innerHTML = `
                        <div class="terminal-surface rounded-lg p-4 ${pos.height} flex flex-col justify-end">
                            <div class="text-3xl mb-2">${pos.medal}</div>
                            <div class="font-bold terminal-text text-sm mb-1">${user.name.split('@')[0]}</div>
                            <div class="terminal-accent text-xl font-bold">${user.totalPoints}</div>
                            <div class="text-xs terminal-muted">${user.correctPicks}/${user.totalPicks}</div>
                        </div>
                    `;
                } else {
                    podiumDiv.innerHTML = `
                        <div class="terminal-surface rounded-lg p-4 ${pos.height} flex flex-col justify-end opacity-50">
                            <div class="text-3xl mb-2">${pos.medal}</div>
                            <div class="text-sm terminal-muted">No Player</div>
                        </div>
                    `;
                }

                podium.appendChild(podiumDiv);
            });
        }

        function renderFullLeaderboard(standings) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            standings.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'terminal-surface' : '';

                let rankDisplay = user.rank;
                if (user.rank === 1) rankDisplay = 'ü•á';
                else if (user.rank === 2) rankDisplay = 'ü•à';
                else if (user.rank === 3) rankDisplay = 'ü•â';

                const accuracyColor = user.pickAccuracy >= 60 ? 'text-green-400' :
                                    user.pickAccuracy >= 40 ? 'text-yellow-400' : 'text-red-400';

                row.innerHTML = `
                    <td class="py-3 px-2 terminal-text font-bold">${rankDisplay}</td>
                    <td class="py-3 px-2">
                        <div class="terminal-text font-semibold">${user.name.split('@')[0]}</div>
                        ${!user.hasPicks ? '<span class="text-xs terminal-muted">No picks</span>' : ''}
                    </td>
                    <td class="text-center py-3 px-2 terminal-accent text-lg font-bold">${user.totalPoints}</td>
                    <td class="text-center py-3 px-2 terminal-secondary">${user.correctPicks}/${user.totalPicks}</td>
                    <td class="text-center py-3 px-2 ${accuracyColor} font-semibold">${user.pickAccuracy.toFixed(1)}%</td>
                    <td class="text-center py-3 px-2 terminal-muted">${user.pointsFromLeader > 0 ? '-' + user.pointsFromLeader : '‚Äî'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateGameStats(gameStates, metadata) {
            document.getElementById('live-games-count').textContent = gameStates.live;
            document.getElementById('completed-games-count').textContent = gameStates.completed;
            document.getElementById('upcoming-games-count').textContent = gameStates.upcoming;

            // Show/hide live indicator
            if (gameStates.live > 0) {
                liveStatus.classList.remove('hidden');
                liveStatus.textContent = `üî¥ ${gameStates.live} LIVE GAMES`;
            } else {
                liveStatus.classList.add('hidden');
            }
        }

        // Real-time updates for live games
        function startLiveUpdates() {
            if (updateInterval) return;

            console.log('üî¥ Starting live updates...');
            updateInterval = setInterval(() => {
                loadWeeklyLeaderboard();
            }, 30000); // Update every 30 seconds during live games
        }

        function stopLiveUpdates() {
            if (updateInterval) {
                console.log('‚èπÔ∏è Stopping live updates');
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Utility functions - Dynamic NFL week calculation
        function getCurrentWeekNumber() {
            const now = new Date();

            // 2025 NFL Season start date (September 4, 2025 - Thursday of Week 1)
            const seasonStart = new Date('2025-09-04T00:00:00Z');

            // Calculate days since season started
            const daysSinceStart = Math.floor((now - seasonStart) / (1000 * 60 * 60 * 24));

            // Each week starts on Thursday (7 days per week)
            const weeksSinceStart = Math.floor(daysSinceStart / 7);

            // Week 1 starts at week 0 calculation, so add 1
            const currentWeek = weeksSinceStart + 1;

            // Clamp to valid NFL season range (1-18)
            const week = Math.max(1, Math.min(18, currentWeek));

            console.log(`üìÖ Current Date: ${now.toISOString()}`);
            console.log(`üìÖ Season Start: ${seasonStart.toISOString()}`);
            console.log(`üìÖ Days Since Start: ${daysSinceStart}`);
            console.log(`üìÖ Calculated NFL Week: ${week}`);

            return week;
        }

        function showLoading() {
            loadingScreen.classList.remove('hidden');
            weekControls.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        function showLeaderboard() {
            loadingScreen.classList.add('hidden');
            weekControls.classList.remove('hidden');
            leaderboardContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
        }

        // Show no data message for weeks that haven't started
        function showNoDataMessage(weekNumber, data) {
            const previousWeek = weekNumber - 1;
            const gameDate = window.NFL_2025_WEEKS[weekNumber]?.games || 'TBD';
            const gameDateTime = new Date(gameDate).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const message = `
                <div class="game-console rounded-2xl p-8 text-center">
                    <div class="text-6xl mb-6">üéÆ</div>
                    <h2 class="text-2xl font-bold mb-4 terminal-accent">Week ${weekNumber} Preview</h2>
                    <p class="terminal-text mb-4">Week ${weekNumber} games haven't started yet!</p>
                    <p class="terminal-muted mb-6">Games begin on ${gameDateTime}</p>

                    <div class="mb-6">
                        <div class="terminal-window p-4 rounded-lg mb-4">
                            <div class="text-sm terminal-accent mb-2">üë• Pool Status</div>
                            <div class="text-terminal-text">
                                ${data.metadata.usersWithPicks} of ${data.metadata.totalUsers} members have made picks
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        ${previousWeek >= 1 ?
                            `<button onclick="changeWeek(${previousWeek})" class="game-button px-6 py-3 rounded-lg font-bold">
                                ‚Üê VIEW WEEK ${previousWeek} RESULTS
                            </button>` : ''}
                        <button onclick="location.href='./index.html'" class="game-button px-6 py-3 rounded-lg font-bold">
                            üéØ MAKE PICKS
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('error-message').innerHTML = message;
            loadingScreen.classList.add('hidden');
            weekControls.classList.remove('hidden'); // Keep week controls visible
            leaderboardContainer.classList.add('hidden');
            errorContainer.classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            loadingScreen.classList.add('hidden');
            weekControls.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            errorContainer.classList.remove('hidden');
        }

        // Matrix background effect
        function initializeMatrixBackground() {
            const canvas = document.getElementById('matrixCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const matrix = "01";
            const font_size = 10;
            const columns = canvas.width / font_size;
            const drops = [];

            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }

            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#00ff41';
                ctx.font = font_size + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = matrix[Math.floor(Math.random() * matrix.length)];
                    ctx.fillText(text, i * font_size, drops[i] * font_size);

                    if (drops[i] * font_size > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            setInterval(draw, 35);
        }

        // Initialize everything
        async function initialize() {
            console.log('üéÆ Initializing Nintendo-style Weekly Leaderboard...');

            initializeMatrixBackground();

            const isAuthenticated = await initializeAuth();
            if (!isAuthenticated) {
                showError('Please sign in to view the leaderboard');
                return;
            }

            initializeWeekControls();
            updateWeekDisplay();

            // Load initial week data
            await loadWeeklyLeaderboard();
        }

        // Start the game!
        initialize();

        // Handle window resize for matrix background
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('matrixCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopLiveUpdates();
        });
    </script>
</body>
</html>