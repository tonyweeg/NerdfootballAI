<!DOCTYPE html>
<html>
<head>
    <title>Fix GameID Mapping - JSON Version</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="./js/config/firebase-config-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>GameID Mapping Analysis - Weeks 1-18</h1>
    <div>
        Week to analyze:
        <select id="weekSelect">
            <option value="1">Week 1</option>
            <option value="2">Week 2</option>
            <option value="3">Week 3</option>
            <option value="4">Week 4</option>
            <option value="5">Week 5</option>
            <option value="6">Week 6</option>
            <option value="7">Week 7</option>
            <option value="8">Week 8</option>
            <option value="9">Week 9</option>
            <option value="10">Week 10</option>
            <option value="11">Week 11</option>
            <option value="12">Week 12</option>
            <option value="13">Week 13</option>
            <option value="14">Week 14</option>
            <option value="15">Week 15</option>
            <option value="16">Week 16</option>
            <option value="17">Week 17</option>
            <option value="18">Week 18</option>
            <option value="all">All Weeks (1-18)</option>
        </select>
        <button onclick="analyzePicks()" style="background: blue; color: white; padding: 8px;">Analyze Picks</button>
    </div>
    <div id="output"></div>

    <script>
        firebase.initializeApp(window.getFirebaseConfig());
        window.db = firebase.firestore();
        window.auth = firebase.auth();

        // Auto-login with Google
        async function autoLogin() {
            return new Promise((resolve) => {
                const unsubscribe = window.auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üîì AUTHENTICATED:', user.email);
                        unsubscribe();
                        resolve(user);
                    } else {
                        console.log('üîê NOT AUTHENTICATED - Signing in...');
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await window.auth.signInWithPopup(provider);
                            console.log('‚úÖ SIGNED IN SUCCESSFULLY');
                        } catch (error) {
                            console.error('‚ùå SIGN IN FAILED:', error);
                        }
                    }
                });
            });
        }

        // Get bible data from JSON files hosted on the site
        async function getBibleData(weekNumber) {
            try {
                const jsonUrl = `/game-data/nfl_2025_week_${weekNumber}.json`;
                console.log(`üìñ FETCHING BIBLE DATA FROM: ${jsonUrl}`);

                const response = await fetch(jsonUrl);

                if (response.ok) {
                    const bibleData = await response.json();
                    console.log(`üìñ BIBLE DATA WEEK ${weekNumber}:`, bibleData);
                    return bibleData;
                } else {
                    console.error(`‚ùå HTTP ${response.status}: No bible data found for week ${weekNumber} at ${jsonUrl}`);
                    return null;
                }
            } catch (error) {
                console.error(`‚ùå Error getting bible data for week ${weekNumber}:`, error);
                return null;
            }
        }

        // Create mapping from team name to correct gameId based on bible data
        function createTeamToGameIdMap(bibleData) {
            const teamMap = {};
            Object.keys(bibleData).forEach(gameId => {
                if (gameId !== '_metadata' && bibleData[gameId] && bibleData[gameId].a && bibleData[gameId].h) {
                    const awayTeam = bibleData[gameId].a;
                    const homeTeam = bibleData[gameId].h;

                    // Add both teams with all variations
                    [awayTeam, homeTeam].forEach(team => {
                        teamMap[team] = gameId;
                        teamMap[team.toLowerCase()] = gameId;

                        // Add common short forms and variations
                        const variations = getTeamVariations(team);
                        variations.forEach(variation => {
                            teamMap[variation] = gameId;
                            teamMap[variation.toLowerCase()] = gameId;
                        });
                    });
                }
            });
            return teamMap;
        }

        // Get all possible team name variations
        function getTeamVariations(teamName) {
            const variations = [];

            switch (teamName) {
                case "Jacksonville Jaguars":
                    variations.push("Jacksonville", "JAX", "Jaguars");
                    break;
                case "Washington Commanders":
                    variations.push("Washington", "WAS", "Commanders");
                    break;
                case "Las Vegas Raiders":
                    variations.push("Las Vegas", "LV", "Raiders");
                    break;
                case "New England Patriots":
                    variations.push("New England", "NE", "Patriots");
                    break;
                case "Kansas City Chiefs":
                    variations.push("Kansas City", "KC", "Chiefs");
                    break;
                case "Los Angeles Chargers":
                    variations.push("Los Angeles", "LA", "Chargers", "L.A. Chargers");
                    break;
                case "Los Angeles Rams":
                    variations.push("Los Angeles", "LAR", "Rams", "L.A. Rams");
                    break;
                case "Tampa Bay Buccaneers":
                    variations.push("Tampa Bay", "TB", "Buccaneers", "Bucs");
                    break;
                case "Green Bay Packers":
                    variations.push("Green Bay", "GB", "Packers");
                    break;
                case "New York Giants":
                    variations.push("New York", "NYG", "Giants");
                    break;
                case "New York Jets":
                    variations.push("New York", "NYJ", "Jets");
                    break;
                case "San Francisco 49ers":
                    variations.push("San Francisco", "SF", "49ers");
                    break;
                // Add more as needed based on what we find in the data
            }

            return variations;
        }

        async function analyzePicks() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>üîê Authenticating and loading analysis...</p>';

            try {
                // Ensure user is authenticated first
                await autoLogin();

                const selectedWeek = document.getElementById('weekSelect').value;
                let results = '<h2>GameID Mapping Analysis</h2>';
                console.log('üî¨ ANALYSIS-STARTING');

                const weeksToAnalyze = selectedWeek === 'all' ? ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18'] : [selectedWeek];

                for (const weekNumber of weeksToAnalyze) {
                    results += `<h3>Week ${weekNumber}</h3>`;

                    // Get bible data for this week
                    const bibleData = await getBibleData(weekNumber);
                    if (!bibleData) {
                        results += `<p style="color: red;">‚ùå No bible data found for Week ${weekNumber}</p>`;
                        continue;
                    }

                    const teamMap = createTeamToGameIdMap(bibleData);
                    console.log(`üó∫Ô∏è Week ${weekNumber} team mapping:`, teamMap);

                    // Get all pick submissions for this week
                    const picksCollectionPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${weekNumber}/submissions`;
                    const picksSnapshot = await firebase.firestore().collection(picksCollectionPath).get();

                    if (picksSnapshot.empty) {
                        results += `<p style="color: orange;">‚ö†Ô∏è No picks found for Week ${weekNumber}</p>`;
                        continue;
                    }

                    results += `<h4>Found ${picksSnapshot.size} users with picks</h4>`;

                    let weekMismatches = 0;
                    let totalPicks = 0;

                    picksSnapshot.forEach(doc => {
                        const userId = doc.id;
                        const picks = doc.data();

                        results += `<h5>User: ${userId}</h5><table border="1"><tr><th>GameID</th><th>Picked Team</th><th>Bible Teams</th><th>Correct?</th></tr>`;

                        Object.keys(picks).forEach(gameId => {
                            if (gameId !== 'mnfTotalPoints' && picks[gameId] && picks[gameId].winner) {
                                const pickedTeam = picks[gameId].winner;
                                const bibleGame = bibleData[gameId];
                                const bibleTeams = bibleGame ? `${bibleGame.a} @ ${bibleGame.h}` : 'UNKNOWN';
                                const correctGameId = teamMap[pickedTeam] || teamMap[pickedTeam.toLowerCase()];
                                const isCorrect = correctGameId === gameId;

                                if (!isCorrect) weekMismatches++;
                                totalPicks++;

                                results += `<tr>
                                    <td>${gameId}</td>
                                    <td>${pickedTeam}</td>
                                    <td>${bibleTeams}</td>
                                    <td style="color: ${isCorrect ? 'green' : 'red'}">${isCorrect ? 'YES' : 'NO - Should be ' + correctGameId}</td>
                                </tr>`;
                            }
                        });

                        results += '</table><br>';
                    });

                    results += `<h4>Week ${weekNumber} Summary: ${weekMismatches} mismatches out of ${totalPicks} picks (${((weekMismatches/totalPicks)*100).toFixed(1)}% error rate)</h4><hr>`;
                }

                output.innerHTML = results;
                console.log('üî¨ ANALYSIS-COMPLETE');

            } catch (error) {
                console.error('‚ùå ANALYSIS-ERROR:', error);
                output.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        // Don't auto-run - let user select week and click analyze
    </script>
</body>
</html>