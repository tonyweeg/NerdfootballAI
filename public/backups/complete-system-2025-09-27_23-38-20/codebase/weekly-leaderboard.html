<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Weekly Leaderboard - NerdFootball</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- NFL 2025 Season Week Calendar (Bible-based) -->
    <script>
        window.NFL_2025_WEEKS = {
            1: { start: '2025-09-04', games: '2025-09-04' },
            2: { start: '2025-09-08', games: '2025-09-11' },
            3: { start: '2025-09-15', games: '2025-09-21' },
            4: { start: '2025-09-22', games: '2025-09-26' },
            5: { start: '2025-09-29', games: '2025-10-03' },
            6: { start: '2025-10-06', games: '2025-10-10' },
            7: { start: '2025-10-13', games: '2025-10-17' },
            8: { start: '2025-10-20', games: '2025-10-24' },
            9: { start: '2025-10-27', games: '2025-10-31' },
            10: { start: '2025-11-03', games: '2025-11-07' },
            11: { start: '2025-11-10', games: '2025-11-14' },
            12: { start: '2025-11-17', games: '2025-11-21' },
            13: { start: '2025-11-24', games: '2025-11-28' },
            14: { start: '2025-12-01', games: '2025-12-05' },
            15: { start: '2025-12-08', games: '2025-12-12' },
            16: { start: '2025-12-15', games: '2025-12-19' },
            17: { start: '2025-12-22', games: '2025-12-26' },
            18: { start: '2025-12-29', games: '2026-01-02' }
        };

        // Bible-based current week detection
        window.getCurrentNFLWeek = function() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format

            // Find current week based on today's date
            for (let week = 1; week <= 18; week++) {
                const weekData = window.NFL_2025_WEEKS[week];
                const weekStart = new Date(weekData.start);
                const nextWeek = window.NFL_2025_WEEKS[week + 1];
                const weekEnd = nextWeek ? new Date(nextWeek.start) : new Date('2026-01-10');

                if (today >= weekStart && today < weekEnd) {
                    return week;
                }
            }

            // Fallback - if we're before week 1, return 1; if after week 18, return 18
            if (todayStr < '2025-09-04') return 1;
            return 18;
        };
    </script>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <script src="./js/utils/suppress-tailwind-warning.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Nintendo-inspired game console styling */
        .game-console {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            border: 3px solid #00ff41;
            box-shadow:
                0 0 20px rgba(0, 255, 65, 0.3),
                inset 0 0 30px rgba(0, 255, 65, 0.1);
        }

        .game-button {
            background: linear-gradient(145deg, #1a1a1a 0%, #000 100%);
            border: 2px solid #ffd700;
            color: #ffd700;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
        }

        .game-button:hover {
            background: linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 100%);
            border-color: #fff;
            color: #fff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.8);
            transform: translateY(-2px);
        }

        .game-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .game-button:disabled {
            background: #333;
            border-color: #666;
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }

        /* üî• WU-TANG HARDCORE STYLING üî• */
        .wu-tang-panel {
            background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 50%, #000 100%);
            border: 3px solid #ffd700;
            border-radius: 0;
            box-shadow:
                0 0 20px rgba(255, 215, 0, 0.5),
                inset 0 0 30px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        .wu-tang-panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #fff, #ffd700, #fff);
            border-radius: 0;
            z-index: -1;
        }

        .wu-tang-stat {
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            border: 2px solid #ffd700;
            padding: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .wu-tang-stat::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .wu-tang-stat:hover::after {
            left: 100%;
        }

        .wu-tang-label {
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        .wu-tang-value {
            color: #fff;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            margin: 4px 0;
        }

        .wu-tang-sublabel {
            color: #ccc;
            font-family: 'Courier New', monospace;
            font-size: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .wu-tang-mini-stat {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            padding: 4px 8px;
            border-radius: 0;
        }

        .wu-tang-mini-label {
            color: #999;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .wu-tang-mini-value {
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.6);
        }

        /* Week display HUD style */
        .week-hud {
            background: radial-gradient(circle, #00ff41 0%, #00cc33 100%);
            color: #000;
            border: 3px solid #fff;
            box-shadow:
                0 0 20px rgba(0, 255, 65, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Power-up indicators for live games */
        .power-up {
            animation: powerUpPulse 1.5s ease-in-out infinite;
        }

        @keyframes powerUpPulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 0, 255, 1);
                transform: scale(1.05);
            }
        }

        /* Game-style transitions */
        .slide-transition {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Nintendo controller D-pad styling */

        /* Live game indicator */
        .live-indicator {
            animation: liveGlow 2s ease-in-out infinite;
            background: linear-gradient(45deg, #ff0066, #ff3366, #ff0066);
        }

        @keyframes liveGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 102, 0.8);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 102, 1);
            }
        }

        /* Terminal theme consistency */
        .terminal-bg {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        }
        .terminal-text { color: #00ff41; }
        .terminal-accent { color: #ff6b6b; }
        .terminal-secondary { color: #4ecdc4; }
        .terminal-muted { color: #95a5a6; }
        .terminal-surface { background: rgba(0, 255, 65, 0.1); }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Loading animation */
        .loading-dots::after {
            content: '';
            animation: dots 2s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Matrix background effect */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }

        /* Basic CSS to replace disabled Tailwind */
        .container { max-width: 1200px; margin: 0 auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .space-x-4 > * + * { margin-left: 1rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .border-b-2 { border-bottom-width: 2px; }
        .min-h-screen { min-height: 100vh; }
        .hidden { display: none; }
        .text-center { text-align: center; }
        .rounded-lg { border-radius: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .p-6 { padding: 1.5rem; }

        /* HEADER NON-STICKY OVERRIDE */
        header {
            position: static !important;
            display: block !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            z-index: 1 !important;
        }

        /* FULL-WIDTH LEADERBOARD WITH IMPROVED READABILITY */
        #full-leaderboard {
            max-width: 100% !important;
            margin: 0 !important;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            padding: 2rem !important;
        }

        #full-leaderboard table {
            font-size: 1.1em; /* 10% bigger font */
            width: 100%;
        }

        #full-leaderboard th {
            font-size: 1.15em; /* Headers slightly larger */
            color: #bfbfbf !important; /* Lighter than 25% grey */
            padding: 1rem 0.75rem !important;
        }

        #full-leaderboard td {
            color: #bfbfbf !important; /* Ensure no text darker than 25% grey */
            padding: 1rem 0.75rem !important;
            font-size: 1.1em;
        }

        /* Override specific text colors to meet 25% grey minimum */
        .terminal-text {
            color: #bfbfbf !important;
        }

        .terminal-secondary {
            color: #4ecdc4 !important;
        }

        .terminal-accent {
            color: #ff6b6b !important;
        }

        .terminal-muted {
            color: #bfbfbf !important;
        }

        /* Ensure rank numbers are bright */
        #full-leaderboard .terminal-text.font-bold {
            color: #ffffff !important;
        }

        /* Ensure points are highly visible */
        #full-leaderboard .terminal-accent {
            color: #ff6b6b !important;
            font-weight: 800 !important;
        }

        /* KILLER BEES WU-TANG BUTTON STYLING */
        .wu-tang-killer-bee-button {
            background: linear-gradient(145deg, #000000 0%, #1a1a1a 50%, #000000 100%);
            border: 3px solid #ffd700;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow:
                0 0 15px rgba(255, 215, 0, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
            border-radius: 0;
        }

        .wu-tang-killer-bee-button::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #fff, #ffd700, #fff);
            border-radius: 0;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .wu-tang-killer-bee-button:hover {
            background: linear-gradient(145deg, #1a1a1a 0%, #333333 50%, #1a1a1a 100%);
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            box-shadow:
                0 0 25px rgba(255, 215, 0, 0.8),
                0 12px 24px rgba(0, 0, 0, 1);
            transform: translateY(-3px);
        }

        .wu-tang-killer-bee-button:hover::before {
            opacity: 0.3;
        }

        .wu-tang-killer-bee-button:active {
            transform: translateY(-1px);
            box-shadow:
                0 0 20px rgba(255, 215, 0, 0.6),
                0 6px 12px rgba(0, 0, 0, 0.8);
        }

        /* SINGLE ROW WU-TANG STATS INLINE STYLING */
        .wu-tang-stat-inline {
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            border: 2px solid #ffd700;
            padding: 8px 12px;
            position: relative;
            overflow: hidden;
            min-width: 90px;
            flex: 0 0 auto;
        }

        .wu-tang-stat-inline::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .wu-tang-stat-inline:hover::after {
            left: 100%;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .wu-tang-stat-inline {
                min-width: 80px;
                padding: 6px 8px;
            }

            .wu-tang-label {
                font-size: 8px !important;
            }

            .wu-tang-value {
                font-size: 14px !important;
            }

            .wu-tang-sublabel {
                font-size: 6px !important;
            }

            .wu-tang-mini-label {
                font-size: 7px !important;
            }

            .wu-tang-mini-value {
                font-size: 12px !important;
            }
        }
    </style>
</head>

<body class="terminal-bg min-h-screen">
    <!-- Matrix background canvas -->
    <canvas id="matrixCanvas" class="matrix-bg"></canvas>

    <!-- Header -->
    <header class="border-b-2 border-terminal-accent">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="./nerd-universe.html" class="game-button px-3 py-2 rounded-md text-sm mr-4 hover:bg-terminal-accent/20 transition-all duration-200">
                        ‚Üê BACK TO UNIVERSE
                    </a>
                    <h1 class="text-2xl font-bold terminal-text">üéÆ WEEKLY LEADERBOARD</h1>
                    <div class="text-sm terminal-muted">Real-time Nintendo-style rankings</div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="live-status" class="hidden px-3 py-1 rounded-full text-xs font-bold live-indicator text-white">
                        üî¥ LIVE GAMES
                    </div>
                    <span id="user-display" class="text-sm terminal-secondary">Loading...</span>
                    <div id="auth-status" class="text-sm terminal-muted">Authenticating...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading Screen -->
        <div id="loading-screen" class="game-console rounded-2xl p-8 text-center mb-8">
            <div class="text-4xl terminal-accent mb-4">üéÆ</div>
            <h2 class="text-xl font-bold mb-4 terminal-text">Loading Game Data<span class="loading-dots"></span></h2>
            <div class="terminal-muted">Initializing Nintendo-style controls...</div>
            <div class="mt-4">
                <div class="inline-block w-8 h-8 border-t-2 border-terminal-accent rounded-full animate-spin"></div>
            </div>
        </div>

        <!-- Nintendo-style Week Navigation -->
        <div id="week-controls" class="hidden bg-gray-900 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-center space-x-6">
                <button id="week-down" class="game-button text-sm">‚óÑ PREV</button>

                <div class="text-center">
                    <div class="text-xl font-bold text-yellow-400">WEEK <span id="current-week-display">4</span></div>
                    <div class="text-xs text-gray-400" id="week-status">Loading...</div>
                </div>

                <button id="week-up" class="game-button text-sm">NEXT ‚ñ∫</button>
            </div>
        </div>

        <!-- Leaderboard Display -->
        <div id="leaderboard-container" class="hidden">
            <!-- Single Row Wu-Tang Stats -->
            <div id="stats-container" class="wu-tang-panel p-4 mb-6">
                <div class="flex flex-wrap justify-center gap-3 text-center">
                    <!-- Week & User Status -->
                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-label">CHAMBER</div>
                        <div class="wu-tang-value" id="week-chamber">WEEK ?</div>
                        <div class="wu-tang-sublabel" id="user-rank">YOUR RANK: ?</div>
                    </div>

                    <!-- Efficiency Stats -->
                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-label">PRECISION</div>
                        <div class="wu-tang-value" id="pick-efficiency">?%</div>
                        <div class="wu-tang-sublabel">HIT RATE</div>
                    </div>

                    <!-- Confidence Analysis -->
                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-label">CONFIDENCE</div>
                        <div class="wu-tang-value" id="avg-confidence">?</div>
                        <div class="wu-tang-sublabel">AVG POINTS</div>
                    </div>

                    <!-- Weekly Intel -->
                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-label">INTEL</div>
                        <div class="wu-tang-value" id="weekly-intel">?</div>
                        <div class="wu-tang-sublabel">LEADER MARGIN</div>
                    </div>

                    <!-- Extended Stats as inline items -->
                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-mini-label">UPSET PICKS:</div>
                        <div class="wu-tang-mini-value" id="upset-picks">?</div>
                    </div>

                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-mini-label">HIGH CONF HITS:</div>
                        <div class="wu-tang-mini-value" id="high-conf-hits">?</div>
                    </div>

                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-mini-label">PERFECT GAMES:</div>
                        <div class="wu-tang-mini-value" id="perfect-games">?</div>
                    </div>

                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-mini-label">TOTAL POOL:</div>
                        <div class="wu-tang-mini-value" id="total-pool">?</div>
                    </div>

                    <div class="wu-tang-stat-inline">
                        <div class="wu-tang-mini-label">TOP 10%:</div>
                        <div class="wu-tang-mini-value" id="top-ten-percent">?</div>
                    </div>
                </div>
            </div>

            <!-- Full Leaderboard Table -->
            <div id="full-leaderboard" class="game-console rounded-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold terminal-text">üìä FULL RANKINGS</h2>
                    <div id="last-updated" class="text-sm terminal-muted">Last updated: --</div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-terminal-accent">
                                <th class="text-left py-3 px-2 terminal-accent font-bold">#</th>
                                <th class="text-left py-3 px-2 terminal-accent font-bold">Player</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Points</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Correct</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Accuracy</th>
                                <th class="text-center py-3 px-2 terminal-accent font-bold">Behind</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-container" class="hidden game-console rounded-2xl p-6 text-center">
            <div class="text-4xl terminal-accent mb-4">‚ö†Ô∏è</div>
            <h2 class="text-xl font-bold mb-4 terminal-text">Game Error</h2>
            <div id="error-message" class="terminal-muted mb-4">Something went wrong...</div>
            <button class="game-button" onclick="window.location.reload()">
                üîÑ RESTART GAME
            </button>
        </div>
    </main>

    <!-- Firebase SDK and Authentication -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;

        // Global variables
        let currentWeek = window.getCurrentNFLWeek();
        let leaderboardData = null;
        let updateInterval = null;

        // DOM elements
        const loadingScreen = document.getElementById('loading-screen');
        const weekControls = document.getElementById('week-controls');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const errorContainer = document.getElementById('error-container');
        const currentWeekDisplay = document.getElementById('current-week-display');
        const userDisplay = document.getElementById('user-display');
        const authStatus = document.getElementById('auth-status');
        const liveStatus = document.getElementById('live-status');

        // Authentication handling
        async function initializeAuth() {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userDisplay.textContent = `Welcome, ${user.displayName || user.email}`;
                        authStatus.textContent = '‚úÖ Authenticated';
                        resolve(true);
                    } else {
                        userDisplay.textContent = 'Not signed in';
                        authStatus.textContent = '‚ùå Sign in required';
                        resolve(false);
                    }
                });
            });
        }

        // Nintendo-style week navigation
        function initializeWeekControls() {
            // D-Pad controls
            document.getElementById('week-up').onclick = () => changeWeek(currentWeek + 1);
            document.getElementById('week-down').onclick = () => changeWeek(currentWeek - 1);
        }

        // Change week with Nintendo-style transition (GLOBAL SCOPE)
        window.changeWeek = async function(newWeek) {
            if (newWeek < 1 || newWeek > 18 || newWeek === currentWeek) return;

            currentWeek = newWeek;
            updateWeekDisplay();

            // Add slide transition effect
            leaderboardContainer.style.transform = 'translateX(100%)';
            setTimeout(() => {
                loadWeeklyLeaderboard();
                leaderboardContainer.style.transform = 'translateX(0)';
            }, 150);
        };

        function updateWeekDisplay() {
            currentWeekDisplay.textContent = currentWeek;

            // Update button states
            document.getElementById('week-up').disabled = currentWeek >= 18;
            document.getElementById('week-down').disabled = currentWeek <= 1;
        }

        // Load weekly leaderboard data
        async function loadWeeklyLeaderboard() {
            try {
                showLoading();
                console.log(`üéÆ Loading Week ${currentWeek} leaderboard...`);

                const response = await fetch(`https://getweeklyleaderboard-np7uealtnq-uc.a.run.app?week=${currentWeek}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üéÆ Response from backend:', result);

                if (result.success) {
                    leaderboardData = result.data;

                    // Check if week has meaningful data (games started or completed)
                    const hasGamesStarted = result.data.gameStates &&
                        (result.data.gameStates.live > 0 || result.data.gameStates.completed > 0);
                    const hasScores = result.data.metadata && result.data.metadata.highScore > 0;

                    if (!hasGamesStarted && !hasScores && result.data.gameStates.upcoming > 0) {
                        // Week hasn't started yet - show helpful message
                        showNoDataMessage(currentWeek, result.data);
                    } else {
                        renderWeeklyLeaderboard(leaderboardData);
                        updateGameStats(leaderboardData.gameStates, leaderboardData.metadata);

                        // Start real-time updates if there are live games
                        if (leaderboardData.gameStates.live > 0) {
                            startLiveUpdates();
                        } else {
                            stopLiveUpdates();
                        }
                    }
                } else if (result.regenerating) {
                    // Cache not found - backend is generating fresh data
                    console.log('üîÑ Backend is regenerating cache for Week', currentWeek);
                    showNoDataMessage(currentWeek, {
                        gameStates: { upcoming: 1 },
                        metadata: { highScore: 0 }
                    });
                } else {
                    throw new Error(result.error || 'Failed to load leaderboard');
                }

            } catch (error) {
                console.error('‚ùå Error loading weekly leaderboard:', error);
                showError(`Failed to load Week ${currentWeek} leaderboard: ${error.message}`);
            }
        }

        // Render Nintendo-style leaderboard
        function renderWeeklyLeaderboard(data) {
            // Ensure leaderboard structure is restored if it was replaced by showNoDataMessage
            ensureLeaderboardStructure();

            renderWuTangStats(data, currentWeek, auth.currentUser);
            renderFullLeaderboard(data.standings);

            const lastUpdatedEl = document.getElementById('last-updated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = `Last updated: ${new Date(data.generatedAt).toLocaleTimeString()}`;
            }

            showLeaderboard();
        }

        // Ensure the original leaderboard HTML structure exists
        function ensureLeaderboardStructure() {
            const statsContainer = document.getElementById('stats-container');
            const fullLeaderboard = document.getElementById('full-leaderboard');

            if (!statsContainer || !fullLeaderboard) {
                console.log('üîß Restoring leaderboard HTML structure...');
                leaderboardContainer.innerHTML = `
                    <!-- Single Row Wu-Tang Stats -->
                    <div id="stats-container" class="wu-tang-panel p-4 mb-6">
                        <div class="flex flex-wrap justify-center gap-3 text-center">
                            <!-- Week & User Status -->
                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-label">CHAMBER</div>
                                <div class="wu-tang-value" id="week-chamber">WEEK ?</div>
                                <div class="wu-tang-sublabel" id="user-rank">YOUR RANK: ?</div>
                            </div>

                            <!-- Efficiency Stats -->
                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-label">PRECISION</div>
                                <div class="wu-tang-value" id="pick-efficiency">?%</div>
                                <div class="wu-tang-sublabel">HIT RATE</div>
                            </div>

                            <!-- Confidence Analysis -->
                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-label">CONFIDENCE</div>
                                <div class="wu-tang-value" id="avg-confidence">?</div>
                                <div class="wu-tang-sublabel">AVG POINTS</div>
                            </div>

                            <!-- Weekly Intel -->
                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-label">INTEL</div>
                                <div class="wu-tang-value" id="weekly-intel">?</div>
                                <div class="wu-tang-sublabel">LEADER MARGIN</div>
                            </div>

                            <!-- Extended Stats as inline items -->
                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-mini-label">UPSET PICKS:</div>
                                <div class="wu-tang-mini-value" id="upset-picks">?</div>
                            </div>

                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-mini-label">HIGH CONF HITS:</div>
                                <div class="wu-tang-mini-value" id="high-conf-hits">?</div>
                            </div>

                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-mini-label">PERFECT GAMES:</div>
                                <div class="wu-tang-mini-value" id="perfect-games">?</div>
                            </div>

                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-mini-label">TOTAL POOL:</div>
                                <div class="wu-tang-mini-value" id="total-pool">?</div>
                            </div>

                            <div class="wu-tang-stat-inline">
                                <div class="wu-tang-mini-label">TOP 10%:</div>
                                <div class="wu-tang-mini-value" id="top-ten-percent">?</div>
                            </div>
                        </div>
                    </div>

                    <!-- Full Leaderboard Table -->
                    <div id="full-leaderboard" class="game-console rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold terminal-text">üìä FULL RANKINGS</h2>
                            <div id="last-updated" class="text-sm terminal-muted">Last updated: --</div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-terminal-accent">
                                        <th class="text-left py-3 px-2 terminal-accent font-bold">#</th>
                                        <th class="text-left py-3 px-2 terminal-accent font-bold">Player</th>
                                        <th class="text-center py-3 px-2 terminal-accent font-bold">Points</th>
                                        <th class="text-center py-3 px-2 terminal-accent font-bold">Correct</th>
                                        <th class="text-center py-3 px-2 terminal-accent font-bold">Accuracy</th>
                                        <th class="text-center py-3 px-2 terminal-accent font-bold">Behind</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        }

        function renderWuTangStats(data, weekNumber, currentUser) {
            // Update main stats with null checks
            const weekChamberEl = document.getElementById('week-chamber');
            if (weekChamberEl) weekChamberEl.textContent = `WEEK ${weekNumber}`;

            // Find current user's rank
            const userRank = data.standings?.findIndex(u => u.userId === currentUser?.uid) + 1 || '?';
            const totalUsers = data.standings?.length || 0;
            const userRankEl = document.getElementById('user-rank');
            if (userRankEl) userRankEl.textContent = userRank !== '?' ? `YOUR RANK: ${userRank}/${totalUsers}` : 'RANK: N/A';

            // Calculate nerdy stats
            const allUsers = data.standings || [];
            const currentUserData = allUsers.find(u => u.userId === currentUser?.uid);

            // Precision (hit rate) with null checks
            const precision = currentUserData ?
                Math.round((currentUserData.correctPicks / currentUserData.totalPicks) * 100) : 0;
            const pickEfficiencyEl = document.getElementById('pick-efficiency');
            if (pickEfficiencyEl) pickEfficiencyEl.textContent = `${precision}%`;

            // Average confidence of correct picks with null checks
            let avgConfidence = 0;
            if (currentUserData?.picks) {
                const correctPicks = Object.values(currentUserData.picks)
                    .filter(pick => pick.isCorrect);
                avgConfidence = correctPicks.length > 0 ?
                    Math.round(correctPicks.reduce((sum, pick) => sum + pick.confidence, 0) / correctPicks.length) : 0;
            }
            const avgConfidenceEl = document.getElementById('avg-confidence');
            if (avgConfidenceEl) avgConfidenceEl.textContent = avgConfidence;

            // Leader margin with null checks
            const leader = allUsers[0];
            const leaderPoints = leader?.totalPoints || 0;
            const userPoints = currentUserData?.totalPoints || 0;
            const margin = leaderPoints - userPoints;
            const weeklyIntelEl = document.getElementById('weekly-intel');
            if (weeklyIntelEl) weeklyIntelEl.textContent = margin === 0 ? 'LEADER' : `-${margin}`;

            // Extended nerdy stats
            // Upset picks (games where winner was picked by <40% of users)
            let upsetPicks = 0;
            if (currentUserData?.picks) {
                const totalPicks = allUsers.length;
                Object.entries(currentUserData.picks).forEach(([gameId, userPick]) => {
                    if (userPick.isCorrect) {
                        const samePickers = allUsers.filter(user =>
                            user.picks?.[gameId]?.userPick === userPick.userPick).length;
                        if ((samePickers / totalPicks) < 0.4) upsetPicks++;
                    }
                });
            }
            const upsetPicksEl = document.getElementById('upset-picks');
            if (upsetPicksEl) upsetPicksEl.textContent = upsetPicks;

            // High confidence hits (>12 confidence and correct) with null checks
            const highConfHits = currentUserData?.picks ?
                Object.values(currentUserData.picks).filter(p => p.isCorrect && p.confidence >= 13).length : 0;
            const highConfHitsEl = document.getElementById('high-conf-hits');
            if (highConfHitsEl) highConfHitsEl.textContent = highConfHits;

            // Perfect games (16/16 correct - rare AF) with null checks
            const perfectPlayers = allUsers.filter(u => u.correctPicks === 16).length;
            const perfectGamesEl = document.getElementById('perfect-games');
            if (perfectGamesEl) perfectGamesEl.textContent = perfectPlayers;

            // Total pool size with null checks
            const totalPoolEl = document.getElementById('total-pool');
            if (totalPoolEl) totalPoolEl.textContent = totalUsers;

            // Top 10% threshold with null checks
            const top10Percent = Math.ceil(totalUsers * 0.1);
            const isTop10 = userRank !== '?' && userRank <= top10Percent;
            const topTenPercentEl = document.getElementById('top-ten-percent');
            if (topTenPercentEl) topTenPercentEl.textContent = isTop10 ? 'YES' : 'NO';
        }

        function renderFullLeaderboard(standings) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            standings.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'terminal-surface' : '';

                let rankDisplay = user.rank;
                if (user.rank === 1) rankDisplay = 'ü•á';
                else if (user.rank === 2) rankDisplay = 'ü•à';
                else if (user.rank === 3) rankDisplay = 'ü•â';

                const accuracyColor = user.pickAccuracy >= 60 ? 'text-green-400' :
                                    user.pickAccuracy >= 40 ? 'text-yellow-400' : 'text-red-400';

                row.innerHTML = `
                    <td class="py-3 px-2 terminal-text font-bold">${rankDisplay}</td>
                    <td class="py-3 px-2">
                        <div class="terminal-text font-semibold">${user.name.split('@')[0]}</div>
                        ${!user.hasPicks ? '<span class="text-xs terminal-muted">No picks</span>' : ''}
                    </td>
                    <td class="text-center py-3 px-2 terminal-accent text-lg font-bold">${user.totalPoints}</td>
                    <td class="text-center py-3 px-2 terminal-secondary">${user.correctPicks}/${user.totalPicks}</td>
                    <td class="text-center py-3 px-2 ${accuracyColor} font-semibold">${user.pickAccuracy.toFixed(1)}%</td>
                    <td class="text-center py-3 px-2 terminal-muted">${user.pointsFromLeader > 0 ? '-' + user.pointsFromLeader : '‚Äî'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateGameStats(gameStates, metadata) {
            const weekStatus = document.getElementById('week-status');
            if (gameStates.completed === 16) {
                weekStatus.textContent = 'All games completed';
                weekStatus.className = 'text-xs text-green-400';
            } else if (gameStates.live > 0) {
                weekStatus.textContent = `${gameStates.live} games live`;
                weekStatus.className = 'text-xs text-yellow-400';
            } else {
                weekStatus.textContent = `${gameStates.completed}/16 completed`;
                weekStatus.className = 'text-xs text-gray-400';
            }

            // Show/hide live indicator
            if (gameStates.live > 0) {
                liveStatus.classList.remove('hidden');
                liveStatus.textContent = `üî¥ ${gameStates.live} LIVE GAMES`;
            } else {
                liveStatus.classList.add('hidden');
            }
        }

        // Real-time updates for live games
        function startLiveUpdates() {
            if (updateInterval) return;

            console.log('üî¥ Starting live updates...');
            updateInterval = setInterval(() => {
                loadWeeklyLeaderboard();
            }, 30000); // Update every 30 seconds during live games
        }

        function stopLiveUpdates() {
            if (updateInterval) {
                console.log('‚èπÔ∏è Stopping live updates');
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Utility functions - Dynamic NFL week calculation
        function getCurrentWeekNumber() {
            const now = new Date();

            // 2025 NFL Season start date (September 4, 2025 - Thursday of Week 1)
            const seasonStart = new Date('2025-09-04T00:00:00Z');

            // Calculate days since season started
            const daysSinceStart = Math.floor((now - seasonStart) / (1000 * 60 * 60 * 24));

            // Each week starts on Thursday (7 days per week)
            const weeksSinceStart = Math.floor(daysSinceStart / 7);

            // Week 1 starts at week 0 calculation, so add 1
            const currentWeek = weeksSinceStart + 1;

            // Clamp to valid NFL season range (1-18)
            const week = Math.max(1, Math.min(18, currentWeek));

            console.log(`üìÖ Current Date: ${now.toISOString()}`);
            console.log(`üìÖ Season Start: ${seasonStart.toISOString()}`);
            console.log(`üìÖ Days Since Start: ${daysSinceStart}`);
            console.log(`üìÖ Calculated NFL Week: ${week}`);

            return week;
        }

        function showLoading() {
            loadingScreen.classList.remove('hidden');
            weekControls.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
        }

        function showLeaderboard() {
            loadingScreen.classList.add('hidden');
            weekControls.classList.remove('hidden');
            leaderboardContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
        }

        // Show Wu-Tang styled message for weeks that haven't started
        function showNoDataMessage(weekNumber, data) {
            const previousWeek = weekNumber - 1;
            const gameDate = window.NFL_2025_WEEKS[weekNumber]?.games || 'TBD';
            const gameDateTime = new Date(gameDate).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const message = `
                <div class="wu-tang-panel p-8 text-center">
                    <div class="text-6xl mb-6">üêù</div>
                    <h2 class="text-3xl font-bold mb-4 wu-tang-label" style="color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 1);">
                        KILLER BEES ARE ON A SWARM
                    </h2>
                    <p class="wu-tang-value mb-4" style="font-size: 1.2em;">WEEK ${weekNumber} CHAMBER SEALED</p>
                    <p class="wu-tang-sublabel mb-6" style="color: #bfbfbf;">Games unlock on ${gameDateTime}</p>

                    <div class="mb-8">
                        <div class="wu-tang-stat inline-block mx-auto p-6">
                            <div class="wu-tang-label">SWARM STATUS</div>
                            <div class="wu-tang-value">${data.metadata?.usersWithPicks || 0}/${data.metadata?.totalUsers || 0}</div>
                            <div class="wu-tang-sublabel">BEES READY</div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-6 justify-center">
                        <button onclick="location.href='./index.html'"
                                class="wu-tang-killer-bee-button">
                            üèà VIEW SEASON LEADERBOARD
                        </button>
                        ${previousWeek >= 1 ?
                            `<button onclick="changeWeek(${previousWeek})"
                                     class="wu-tang-killer-bee-button">
                                üîô WEEK ${previousWeek} RESULTS
                            </button>` : ''}
                        <button onclick="location.href='./index.html'"
                                class="wu-tang-killer-bee-button">
                            ‚ö° MAKE PICKS
                        </button>
                    </div>
                </div>
            `;

            // Show message in a temporary container to preserve original structure
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = message;

            // Clear and replace leaderboard container content but preserve structure
            leaderboardContainer.innerHTML = '';
            leaderboardContainer.appendChild(tempContainer.firstElementChild);

            loadingScreen.classList.add('hidden');
            weekControls.classList.remove('hidden');
            leaderboardContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            loadingScreen.classList.add('hidden');
            weekControls.classList.add('hidden');
            leaderboardContainer.classList.add('hidden');
            errorContainer.classList.remove('hidden');
        }

        // Matrix background effect
        function initializeMatrixBackground() {
            const canvas = document.getElementById('matrixCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const matrix = "01";
            const font_size = 10;
            const columns = canvas.width / font_size;
            const drops = [];

            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }

            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#00ff41';
                ctx.font = font_size + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = matrix[Math.floor(Math.random() * matrix.length)];
                    ctx.fillText(text, i * font_size, drops[i] * font_size);

                    if (drops[i] * font_size > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            setInterval(draw, 35);
        }

        // Initialize everything
        async function initialize() {
            console.log('üéÆ Initializing Nintendo-style Weekly Leaderboard...');

            initializeMatrixBackground();

            const isAuthenticated = await initializeAuth();
            if (!isAuthenticated) {
                showError('Please sign in to view the leaderboard');
                return;
            }

            initializeWeekControls();
            updateWeekDisplay();

            // Load initial week data
            await loadWeeklyLeaderboard();
        }

        // Start the game!
        initialize();

        // Handle window resize for matrix background
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('matrixCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopLiveUpdates();
        });
    </script>
</body>
</html>