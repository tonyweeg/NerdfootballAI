<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèà Games CRUD - Wu Tang Style</title>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(45deg, #1a1a00, #2a2a00);
            color: #ffff00;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffff00;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #ffff00;
            padding-bottom: 1rem;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .wu-button {
            background: linear-gradient(45deg, #1a1a00, #ffff00);
            color: #000;
            border: 2px solid #ffff00;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            transition: all 0.3s ease;
        }
        .wu-button:hover {
            background: linear-gradient(45deg, #ffff00, #1a1a00);
            color: #ffff00;
            transform: scale(1.05);
        }
        .wu-button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        .week-selector {
            background: #1a1a1a;
            border: 2px solid #ffff00;
            border-radius: 6px;
            padding: 8px 16px;
            color: #ffff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 2rem 0;
        }
        .game-card {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffff00;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .game-card:hover {
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);
            transform: translateY(-2px);
        }
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .game-id {
            background: #ffff00;
            color: #000;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        .game-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #ffff00;
        }
        .team-input {
            background: #1a1a1a;
            border: 1px solid #ffff00;
            border-radius: 4px;
            padding: 8px;
            color: #ffff00;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
            margin: 4px 0;
        }
        .team-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        .score-input {
            background: #1a1a1a;
            border: 1px solid #ffff00;
            border-radius: 4px;
            padding: 8px;
            color: #ffff00;
            font-family: 'JetBrains Mono', monospace;
            width: 60px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .status-log {
            background: #1a1a1a;
            border: 2px solid #ffff00;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 4px 0;
            padding: 4px 0;
        }
        .log-success { color: #44ff44; }
        .log-error { color: #ff4444; }
        .log-info { color: #ffff00; }
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffff00;
            color: #000;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="auto-save-indicator" id="autoSaveIndicator">üíæ Auto-Saved!</div>

    <div class="container">
        <div class="header">
            <h1>üèà NFL Games CRUD - Wu Tang Style</h1>
            <p>‚öîÔ∏è 36 Chambers of Game Management ‚öîÔ∏è</p>
        </div>

        <div class="controls">
            <button id="signInBtn" class="wu-button">üîê Admin Sign In</button>
            <button id="signOutBtn" class="wu-button" style="display: none;">üö™ Sign Out</button>

            <label class="text-sm" style="color: #ffff00;">Week:</label>
            <select id="weekSelect" class="week-selector" disabled>
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
                <option value="5">Week 5</option>
                <option value="6">Week 6</option>
                <option value="7">Week 7</option>
                <option value="8">Week 8</option>
                <option value="9">Week 9</option>
                <option value="10">Week 10</option>
                <option value="11">Week 11</option>
                <option value="12">Week 12</option>
                <option value="13">Week 13</option>
                <option value="14">Week 14</option>
                <option value="15">Week 15</option>
                <option value="16">Week 16</option>
                <option value="17">Week 17</option>
                <option value="18">Week 18</option>
            </select>

            <button id="loadGamesBtn" class="wu-button" disabled>üì• Load Games</button>
            <button id="espnUpdateBtn" class="wu-button" disabled>üî• ESPN Update</button>
            <button id="saveAllBtn" class="wu-button" disabled>üíæ Save All</button>
        </div>

        <div id="statusLog" class="status-log">
            <div class="log-info">[Wu Tang] Games CRUD system ready...</div>
            <div class="log-info">[System] Sign in as admin to manage games</div>
        </div>

        <div id="gamesContainer" class="games-grid">
            <!-- Games will be loaded here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { getFirebaseConfig } from './js/config/firebase-config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        const app = initializeApp(getFirebaseConfig());
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // UI Elements
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const weekSelect = document.getElementById('weekSelect');
        const loadGamesBtn = document.getElementById('loadGamesBtn');
        const espnUpdateBtn = document.getElementById('espnUpdateBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const statusLog = document.getElementById('statusLog');
        const gamesContainer = document.getElementById('gamesContainer');
        const autoSaveIndicator = document.getElementById('autoSaveIndicator');

        // State
        let currentUser = null;
        let currentGames = {};
        let selectedWeek = 4; // Default to current week
        let autoSaveTimeout = null;
        const ADMIN_UIDS = ['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2', 'bEVzcZtSExT8cIjamWnGbWZ3J5s1'];

        // Set default week to current
        weekSelect.value = selectedWeek;

        // Authentication
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const isAdmin = user && ADMIN_UIDS.includes(user.uid);

            if (isAdmin) {
                log(`‚úÖ Wu Tang Admin authenticated: ${user.email}`, 'success');
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
                weekSelect.disabled = false;
                loadGamesBtn.disabled = false;
                espnUpdateBtn.disabled = false;
                saveAllBtn.disabled = false;
                loadGames();
            } else if (user) {
                log(`‚ùå Access denied: ${user.email} - Wu Tang Clan only`, 'error');
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
            } else {
                log(`üîê Wu Tang authentication required`, 'info');
                signInBtn.style.display = 'inline-block';
                signOutBtn.style.display = 'none';
                weekSelect.disabled = true;
                loadGamesBtn.disabled = true;
                espnUpdateBtn.disabled = true;
                saveAllBtn.disabled = true;
            }
        });

        async function signIn() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                log(`‚ùå Wu Tang sign in failed: ${error.message}`, 'error');
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                log('üö™ Wu Tang session ended', 'success');
            } catch (error) {
                log(`‚ùå Sign out failed: ${error.message}`, 'error');
            }
        }

        async function loadGames() {
            try {
                selectedWeek = parseInt(weekSelect.value);
                log(`üì• Loading Week ${selectedWeek} games...`, 'info');

                const gamesPath = `artifacts/nerdfootball/public/data/nerdfootball_games/${selectedWeek}`;
                const gamesRef = doc(db, gamesPath);
                const gamesSnap = await getDoc(gamesRef);

                if (!gamesSnap.exists()) {
                    log('‚ùå No games found - creating empty structure', 'error');
                    currentGames = createEmptyWeekStructure();
                    await setDoc(gamesRef, currentGames);
                } else {
                    currentGames = gamesSnap.data();
                }

                renderGames();
                log(`‚úÖ Week ${selectedWeek} loaded - ${Object.keys(currentGames).filter(k => !k.startsWith('_')).length} games`, 'success');

            } catch (error) {
                log(`‚ùå Error loading games: ${error.message}`, 'error');
            }
        }

        function createEmptyWeekStructure() {
            const games = {};
            // Dynamic game ID generation based on selected week
            const baseId = selectedWeek * 100;
            const gameCount = 16; // All weeks have 16 games

            for (let i = 1; i <= gameCount; i++) {
                const gameId = (baseId + i).toString();
                games[gameId] = {
                    a: '', // away team
                    h: '', // home team
                    awayScore: null,
                    homeScore: null,
                    status: 'scheduled',
                    winner: null,
                    dt: new Date().toISOString(),
                    stadium: '',
                    lastUpdated: new Date().toISOString()
                };
            }

            // Add metadata
            games._metadata = {
                week: selectedWeek,
                totalGames: gameCount,
                lastUpdated: new Date().toISOString(),
                dataSource: 'nerd-game-updater-empty'
            };

            return games;
        }

        function renderGames() {
            const gameEntries = Object.entries(currentGames)
                .filter(([key]) => !key.startsWith('_') && /^\d{3}$/.test(key)) // Match any 3-digit game ID
                .sort(([a], [b]) => parseInt(a) - parseInt(b));

            gamesContainer.innerHTML = gameEntries.map(([gameId, game]) => {
                return `
                    <div class="game-card" data-game-id="${gameId}">
                        <div class="game-header">
                            <div class="game-id">Game ${gameId}</div>
                            <select class="game-status" data-field="status" onchange="autoSave('${gameId}', 'status', this.value)">
                                <option value="scheduled" ${game.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="IN_PROGRESS" ${game.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                                <option value="FINAL" ${game.status === 'FINAL' ? 'selected' : ''}>Final</option>
                                <option value="FINAL/OT" ${game.status === 'FINAL/OT' ? 'selected' : ''}>Final (OT)</option>
                            </select>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin: 1rem 0;">
                            <input type="text" class="team-input" placeholder="Away Team" value="${game.a || ''}"
                                   onchange="autoSave('${gameId}', 'a', this.value)">
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" value="${game.awayScore || ''}"
                                   onchange="autoSave('${gameId}', 'awayScore', parseInt(this.value) || null)">
                            <div style="text-align: center; color: #666;">@</div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin: 1rem 0;">
                            <input type="text" class="team-input" placeholder="Home Team" value="${game.h || ''}"
                                   onchange="autoSave('${gameId}', 'h', this.value)">
                            <input type="number" class="score-input" placeholder="0" min="0" max="99" value="${game.homeScore || ''}"
                                   onchange="autoSave('${gameId}', 'homeScore', parseInt(this.value) || null)">
                            <div style="text-align: center; color: #666;">HOME</div>
                        </div>

                        <div style="margin-top: 1rem;">
                            <input type="text" class="team-input" placeholder="Stadium" value="${game.stadium || ''}"
                                   onchange="autoSave('${gameId}', 'stadium', this.value)">
                        </div>

                        <div style="margin-top: 1rem; font-size: 12px; color: #888;">
                            Last Updated: ${new Date(game.lastUpdated || game.dt).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.autoSave = function(gameId, field, value) {
            // Update local state
            if (!currentGames[gameId]) currentGames[gameId] = {};
            currentGames[gameId][field] = value;
            currentGames[gameId].lastUpdated = new Date().toISOString();

            // Auto-calculate winner for final games
            if (field === 'status' && value.includes('FINAL')) {
                const game = currentGames[gameId];
                const awayScore = game.awayScore || 0;
                const homeScore = game.homeScore || 0;
                if (awayScore > homeScore) {
                    game.winner = game.a;
                } else if (homeScore > awayScore) {
                    game.winner = game.h;
                } else {
                    game.winner = null; // tie
                }
            }

            // Clear existing timeout and set new one
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);

            autoSaveTimeout = setTimeout(async () => {
                await saveToFirebase(gameId);

                // Trigger user score updates if game is final
                if (field === 'status' && value.includes('FINAL')) {
                    await triggerUserScoreUpdates(gameId);
                }

                showAutoSaveIndicator();
            }, 1000); // Save 1 second after last change
        };

        async function saveToFirebase(gameId = null) {
            try {
                const gamesPath = `artifacts/nerdfootball/public/data/nerdfootball_games/${selectedWeek}`;
                const gamesRef = doc(db, gamesPath);

                if (gameId) {
                    // Save specific game
                    const updateData = {};
                    Object.keys(currentGames[gameId]).forEach(key => {
                        updateData[`${gameId}.${key}`] = currentGames[gameId][key];
                    });
                    await updateDoc(gamesRef, updateData);
                    log(`üíæ Game ${gameId} auto-saved`, 'success');
                } else {
                    // Save all games
                    await setDoc(gamesRef, currentGames, { merge: true });
                    log(`üíæ All Week ${selectedWeek} games saved`, 'success');
                }

            } catch (error) {
                log(`‚ùå Save failed: ${error.message}`, 'error');
            }
        }

        function showAutoSaveIndicator() {
            autoSaveIndicator.classList.add('show');
            setTimeout(() => {
                autoSaveIndicator.classList.remove('show');
            }, 2000);
        }

        async function triggerUserScoreUpdates(gameId) {
            try {
                log(`üéØ Triggering user score updates for Game ${gameId}...`, 'info');

                // Get pool members
                const poolPath = 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members';
                const poolRef = doc(db, poolPath);
                const poolSnap = await getDoc(poolRef);

                if (!poolSnap.exists()) {
                    log('‚ùå No pool members found', 'error');
                    return;
                }

                const members = poolSnap.data();
                const game = currentGames[gameId];
                let updatedUsers = 0;

                // Update each user's scoring data
                for (const [userId, member] of Object.entries(members)) {
                    if (!member || !member.email) continue;

                    try {
                        // Get user's picks for this week
                        const userPicksPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${selectedWeek}/submissions`;
                        const userPicksRef = doc(db, userPicksPath, userId);
                        const userPicksSnap = await getDoc(userPicksRef);

                        if (!userPicksSnap.exists()) continue;

                        const picks = userPicksSnap.data();
                        const userPick = picks[gameId];

                        if (!userPick) continue; // User didn't pick this game

                        // Calculate if user won or lost
                        let result = 'pending';
                        let points = 0;

                        if (game.status && game.status.includes('FINAL')) {
                            // Handle NerdFootball pick data structure
                            const userPickedTeam = userPick.winner;
                            const winningTeam = game.winner;

                            // Skip if we can't find a valid pick or winner (or empty string picks)
                            if (!userPickedTeam || userPickedTeam === "" || !winningTeam) {
                                log(`‚ö†Ô∏è Skipping user ${member.email}: missing/empty pick (${userPickedTeam}) or winner (${winningTeam})`, 'info');
                                continue;
                            }

                            if (userPickedTeam === winningTeam) {
                                result = 'win';
                                points = userPick.confidence || 1;
                            } else {
                                result = 'loss';
                                points = 0;
                            }

                            // Update user's scoring document
                            const scoringPath = `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`;
                            const scoringRef = doc(db, scoringPath);

                            // Get current scoring data or create new
                            const scoringSnap = await getDoc(scoringRef);
                            const scoringData = scoringSnap.exists() ? scoringSnap.data() : { weeklyPoints: {} };

                            // Initialize week if needed
                            if (!scoringData.weeklyPoints) scoringData.weeklyPoints = {};
                            if (!scoringData.weeklyPoints[selectedWeek]) {
                                scoringData.weeklyPoints[selectedWeek] = {
                                    games: {},
                                    totalPoints: 0,
                                    correctPicks: 0,
                                    totalPicks: 0
                                };
                            }

                            const weekData = scoringData.weeklyPoints[selectedWeek];

                            // Update game result - only save valid data
                            weekData.games[gameId] = {
                                pick: userPickedTeam,
                                winner: winningTeam,
                                confidence: userPick.confidence || 1,
                                result: result,
                                points: points,
                                updated: new Date().toISOString()
                            };

                            // Recalculate week totals
                            let totalPoints = 0;
                            let correctPicks = 0;
                            let totalPicks = 0;

                            Object.values(weekData.games).forEach(gameResult => {
                                totalPicks++;
                                totalPoints += gameResult.points || 0;
                                if (gameResult.result === 'win') correctPicks++;
                            });

                            weekData.totalPoints = totalPoints;
                            weekData.correctPicks = correctPicks;
                            weekData.totalPicks = totalPicks;
                            weekData.lastUpdated = new Date().toISOString();

                            // Save updated scoring data
                            await setDoc(scoringRef, scoringData, { merge: true });
                            updatedUsers++;
                        }

                    } catch (error) {
                        log(`‚ùå Error updating user ${member.email}: ${error.message}`, 'error');
                    }
                }

                log(`‚úÖ Updated scoring for ${updatedUsers} users`, 'success');

            } catch (error) {
                log(`‚ùå User score update failed: ${error.message}`, 'error');
            }
        }

        async function updateESPNScores() {
            try {
                log('üî• Triggering ESPN update...', 'info');
                espnUpdateBtn.disabled = true;
                espnUpdateBtn.textContent = 'üîÑ Updating...';

                const updateScores = httpsCallable(functions, 'updateScoresCallable');
                const result = await updateScores();

                if (result.data.success) {
                    log(`‚úÖ ESPN update successful!`, 'success');
                    await loadGames(); // Reload to show updated data
                } else {
                    log(`‚ùå ESPN update failed: ${result.data.error}`, 'error');
                }

            } catch (error) {
                log(`‚ùå ESPN update error: ${error.message}`, 'error');
            } finally {
                espnUpdateBtn.disabled = false;
                espnUpdateBtn.textContent = 'üî• ESPN Update';
            }
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';
            statusLog.innerHTML += `<div class="log-entry ${className}">[${timestamp}] ${message}</div>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // Event listeners
        signInBtn.addEventListener('click', signIn);
        signOutBtn.addEventListener('click', signOutUser);
        weekSelect.addEventListener('change', loadGames);
        loadGamesBtn.addEventListener('click', loadGames);
        espnUpdateBtn.addEventListener('click', updateESPNScores);
        saveAllBtn.addEventListener('click', () => saveToFirebase());

        // Initial load message
        log('‚öîÔ∏è Wu Tang Games CRUD ready - 36 Chambers of Power', 'success');
    </script>
</body>
</html>