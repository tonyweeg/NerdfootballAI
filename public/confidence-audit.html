<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Points Math Audit - NerdFootball</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .audit-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .results-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-breakdown {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .discrepancy {
            background-color: #ffebee;
            border-color: #f44336;
        }
        .match {
            background-color: #e8f5e8;
            border-color: #4caf50;
        }
        .game-detail {
            margin: 5px 0;
            padding: 8px;
            font-size: 0.9em;
            border-left: 3px solid #ddd;
            margin-left: 20px;
        }
        .correct { border-left-color: #4caf50; }
        .incorrect { border-left-color: #f44336; }
        .no-result { border-left-color: #ff9800; }
        .btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background-color: #0056b3; }
        .loading { color: #666; font-style: italic; }
        .error { color: #f44336; font-weight: bold; }
        .success { color: #4caf50; font-weight: bold; }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Confidence Points Math Audit</h1>
        <p>Line-by-line verification of confidence points calculations vs displayed results</p>
    </div>

    <div class="audit-controls">
        <h3>Audit Controls</h3>
        <label>Week Number:
            <select id="weekSelect">
                <option value="1">Week 1</option>
                <option value="2" selected>Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
                <option value="5">Week 5</option>
            </select>
        </label>
        <button class="btn" onclick="runFullAudit()">üöÄ Run Full Audit</button>
        <button class="btn" onclick="clearResults()">üßπ Clear Results</button>
        <div id="status" class="loading" style="margin-top: 10px;"></div>
    </div>

    <div class="results-section">
        <h3>Audit Results</h3>
        <div id="auditResults">Click "Run Full Audit" to start the verification process.</div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase accessible globally
        window.db = db;
        window.auth = auth;
        window.doc = doc;
        window.getDoc = getDoc;

        // Authentication check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('status').innerHTML = `‚úÖ Authenticated as: ${user.email}`;
            } else {
                document.getElementById('status').innerHTML = `‚ùå Not authenticated - <a href="/">Login</a>`;
            }
        });
    </script>

    <script>
        class ConfidenceAuditor {
            constructor() {
                this.poolId = 'nerduniverse-2025';
                this.season = '2025';
            }

            async getRawPicksData(weekNumber) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `üîç Step 1: Getting raw picks data for Week ${weekNumber}...`;

                const picksPath = `artifacts/nerdfootball/pools/${this.poolId}/confidence/${this.season}/weeks/${weekNumber}`;
                const picksDoc = await getDoc(doc(window.db, picksPath));

                if (!picksDoc.exists()) {
                    throw new Error(`No picks data found at: ${picksPath}`);
                }

                const picksData = picksDoc.data();
                this.logToResults(`‚úÖ Retrieved picks data for ${Object.keys(picksData).length} users`);

                return picksData;
            }

            async getRawGameResults() {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `üîç Step 2: Getting ESPN game results...`;

                const cachePath = 'cache/espn_current_data';
                const cacheDoc = await getDoc(doc(window.db, cachePath));

                if (!cacheDoc.exists()) {
                    throw new Error(`No ESPN cache data found at: ${cachePath}`);
                }

                const cacheData = cacheDoc.data();
                this.logToResults(`‚úÖ Retrieved ESPN cache data, last updated: ${new Date(cacheData.lastUpdated)}`);

                return cacheData;
            }

            async recalculateScores(weekNumber, picksData, gameResults) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `üîç Step 3: Recalculating scores from scratch...`;

                const calculatedScores = {};
                const detailedBreakdown = {};

                Object.entries(picksData).forEach(([userId, userData]) => {
                    if (!userData.picks) return;

                    const userDisplayName = userData.meta?.displayName || `User-${userId}`;
                    let userWeeklyScore = 0;
                    const userGameBreakdown = [];

                    Object.entries(userData.picks).forEach(([gameId, pick]) => {
                        const pickWinner = pick.winner;
                        const pickConfidence = pick.confidence;

                        // Find the corresponding game result
                        let gameResult = null;
                        let gameKey = null;

                        if (pickWinner && gameResults.teamResults) {
                            for (const [key, result] of Object.entries(gameResults.teamResults)) {
                                if (key.includes(pickWinner) && key.includes(`_${weekNumber}`)) {
                                    gameResult = result;
                                    gameKey = key;
                                    break;
                                }
                            }
                        }

                        let pointsEarned = 0;
                        let status = 'NO_RESULT';

                        if (gameResult) {
                            if (gameResult.winner === pickWinner) {
                                pointsEarned = pickConfidence || 0;
                                status = 'CORRECT';
                                userWeeklyScore += pointsEarned;
                            } else {
                                status = 'INCORRECT';
                            }
                        } else {
                            status = 'GAME_NOT_FOUND';
                        }

                        userGameBreakdown.push({
                            gameId,
                            pickedTeam: pickWinner,
                            confidence: pickConfidence,
                            actualWinner: gameResult?.winner || 'UNKNOWN',
                            gameKey,
                            pointsEarned,
                            status
                        });
                    });

                    calculatedScores[userId] = userWeeklyScore;
                    detailedBreakdown[userId] = {
                        displayName: userDisplayName,
                        weeklyScore: userWeeklyScore,
                        games: userGameBreakdown
                    };
                });

                return { calculatedScores, detailedBreakdown };
            }

            async getDisplayedScores(weekNumber) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `üîç Step 4: Getting displayed scores...`;

                const summaryPath = `artifacts/nerdfootball/pools/${this.poolId}/confidence/${this.season}/summary`;
                const summaryDoc = await getDoc(doc(window.db, summaryPath));

                let displayedScores = {};

                if (summaryDoc.exists()) {
                    const summaryData = summaryDoc.data();
                    displayedScores = summaryData.weeklyTotals?.[weekNumber] || {};
                    this.logToResults(`‚úÖ Retrieved displayed scores for Week ${weekNumber}`);
                } else {
                    this.logToResults(`‚ùå No summary data found`);
                }

                return displayedScores;
            }

            findDiscrepancies(calculatedScores, displayedScores, detailedBreakdown) {
                const discrepancies = [];
                const allUserIds = new Set([...Object.keys(calculatedScores), ...Object.keys(displayedScores)]);

                allUserIds.forEach(userId => {
                    const calculated = calculatedScores[userId] || 0;
                    const displayed = displayedScores[userId] || 0;
                    const breakdown = detailedBreakdown[userId];

                    if (calculated !== displayed) {
                        discrepancies.push({
                            userId,
                            displayName: breakdown?.displayName || 'Unknown',
                            calculatedScore: calculated,
                            displayedScore: displayed,
                            difference: calculated - displayed,
                            gameBreakdown: breakdown?.games || []
                        });
                    }
                });

                return discrepancies;
            }

            displayResults(weekNumber, discrepancies, detailedBreakdown, calculatedScores, displayedScores) {
                const resultsDiv = document.getElementById('auditResults');

                let html = `<h3>üìä Audit Results for Week ${weekNumber}</h3>`;

                if (discrepancies.length === 0) {
                    html += `<div class="success">‚úÖ NO DISCREPANCIES FOUND - All calculations match perfectly!</div>`;
                } else {
                    html += `<div class="error">‚ùå FOUND ${discrepancies.length} DISCREPANCIES</div>`;
                }

                // Show all users with their breakdowns
                const allUserIds = Object.keys(detailedBreakdown);
                allUserIds.sort((a, b) => {
                    const aName = detailedBreakdown[a].displayName;
                    const bName = detailedBreakdown[b].displayName;
                    return aName.localeCompare(bName);
                });

                allUserIds.forEach(userId => {
                    const calculated = calculatedScores[userId] || 0;
                    const displayed = displayedScores[userId] || 0;
                    const breakdown = detailedBreakdown[userId];
                    const hasDiscrepancy = calculated !== displayed;

                    html += `<div class="user-breakdown ${hasDiscrepancy ? 'discrepancy' : 'match'}">`;
                    html += `<h4>${breakdown.displayName} (${userId})</h4>`;
                    html += `<p><strong>Calculated Score:</strong> ${calculated} | <strong>Displayed Score:</strong> ${displayed}`;

                    if (hasDiscrepancy) {
                        html += ` | <span style="color: red;"><strong>Difference:</strong> ${calculated - displayed}</span>`;
                    }

                    html += `</p>`;

                    // Show game-by-game breakdown
                    html += `<div style="margin-top: 10px;"><strong>Game-by-Game Breakdown:</strong></div>`;
                    breakdown.games.forEach(game => {
                        const statusClass = game.status === 'CORRECT' ? 'correct' :
                                          game.status === 'INCORRECT' ? 'incorrect' : 'no-result';
                        const statusIcon = game.status === 'CORRECT' ? '‚úÖ' :
                                         game.status === 'INCORRECT' ? '‚ùå' : '‚ö†Ô∏è';

                        html += `<div class="game-detail ${statusClass}">`;
                        html += `${statusIcon} Game ${game.gameId}: Picked ${game.pickedTeam} (Confidence: ${game.confidence}) ‚Üí ${game.pointsEarned} points<br>`;
                        if (game.actualWinner !== 'UNKNOWN') {
                            html += `Actual winner: ${game.actualWinner}`;
                        } else {
                            html += `<span style="color: orange;">Game result not found</span>`;
                        }
                        html += `</div>`;
                    });

                    html += `</div>`;
                });

                resultsDiv.innerHTML = html;
            }

            logToResults(message) {
                console.log(message);
            }

            async runAudit(weekNumber) {
                try {
                    document.getElementById('status').innerHTML = 'üöÄ Starting comprehensive audit...';
                    document.getElementById('auditResults').innerHTML = '<div class="loading">Running audit...</div>';

                    // Step 1: Get raw picks data
                    const picksData = await this.getRawPicksData(weekNumber);

                    // Step 2: Get raw game results
                    const gameResults = await this.getRawGameResults();

                    // Step 3: Recalculate scores
                    const { calculatedScores, detailedBreakdown } = await this.recalculateScores(weekNumber, picksData, gameResults);

                    // Step 4: Get displayed scores
                    const displayedScores = await this.getDisplayedScores(weekNumber);

                    // Step 5: Find discrepancies
                    const discrepancies = this.findDiscrepancies(calculatedScores, displayedScores, detailedBreakdown);

                    // Step 6: Display results
                    this.displayResults(weekNumber, discrepancies, detailedBreakdown, calculatedScores, displayedScores);

                    document.getElementById('status').innerHTML = '‚úÖ Audit completed successfully!';

                } catch (error) {
                    console.error('Audit failed:', error);
                    document.getElementById('status').innerHTML = `‚ùå Audit failed: ${error.message}`;
                    document.getElementById('auditResults').innerHTML = `<div class="error">Audit failed: ${error.message}</div>`;
                }
            }
        }

        // Global functions
        window.auditor = new ConfidenceAuditor();

        function runFullAudit() {
            const weekNumber = document.getElementById('weekSelect').value;
            window.auditor.runAudit(parseInt(weekNumber));
        }

        function clearResults() {
            document.getElementById('auditResults').innerHTML = 'Click "Run Full Audit" to start the verification process.';
            document.getElementById('status').innerHTML = 'üîß Ready to run audit.';
        }
    </script>
</body>
</html>