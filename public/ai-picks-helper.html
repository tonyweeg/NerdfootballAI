<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Picks Helper - NerdFootball</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nerd-green': '#10B981',
                        'nerd-blue': '#3B82F6',
                        'nerd-purple': '#8B5CF6'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">üß† Rich AI Confidence Tool</h1>
            <p class="text-gray-600 mb-6">Comprehensive AI analysis with real game data, betting lines, and injury reports</p>

            <div class="mb-6">
                <button onclick="getRichAIAnalysis()" class="bg-nerd-blue text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                    üéØ Get Rich AI Analysis for Week 4
                </button>
                <button onclick="testRichAI()" class="bg-nerd-green text-white px-6 py-2 rounded-lg hover:bg-green-600 transition ml-2">
                    üß™ Test Rich AI
                </button>
                <button onclick="getBettingLines()" class="bg-nerd-purple text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition ml-2">
                    üí∞ Get Betting Lines
                </button>
                <button onclick="showAccuracyReport()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition ml-2">
                    üìä Accuracy Report
                </button>
                <button onclick="updatePredictionsWithResults()" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition ml-2">
                    üîÑ Update Results
                </button>
                <button onclick="showLearningInsights()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition ml-2">
                    üß† Learning Insights
                </button>
            </div>

            <div id="aiResults" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">AI Confidence Suggestions</h2>
                <div id="aiContent" class="space-y-4"></div>
            </div>

            <div id="loading" class="hidden text-center py-8">
                <div class="text-lg text-gray-600">ü§ñ AI analyzing games...</div>
            </div>

            <div id="testResults" class="hidden mt-6">
                <h3 class="text-xl font-semibold mb-2">Test Results</h3>
                <pre id="testOutput" class="bg-gray-100 p-4 rounded-lg text-sm overflow-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Rich AI Tool -->
    <script src="rich-nerdai-tool.js"></script>
    <!-- Prediction Tracker -->
    <script src="prediction-tracker.js"></script>
    <!-- Results Tracker -->
    <script src="results-tracker.js"></script>

    <script>
        // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();

        // Initialize Firebase auth on page load
        window.addEventListener('load', async () => {
            try {
                await window.auth.signInAnonymously();
                console.log('üéØ NERDAI_DEBUG: Firebase authenticated for data access');
            } catch (error) {
                console.log('üéØ NERDAI_DEBUG: Firebase auth failed, continuing with limited functionality:', error.message);
            }
        });

        async function getRichAIAnalysis() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('aiResults');
            const content = document.getElementById('aiContent');

            loading.classList.remove('hidden');
            results.classList.add('hidden');

            try {
                const richAI = window.RichNerdAITool;
                richAI.setDebugMode(true);

                const comprehensiveAnalysis = await richAI.getComprehensiveAnalysis(4);

                if (comprehensiveAnalysis.error) {
                    content.innerHTML = `<div class="text-red-600">Error: ${comprehensiveAnalysis.error}</div>`;
                } else {
                    displayRichAIResults(comprehensiveAnalysis);
                }

                loading.classList.add('hidden');
                results.classList.remove('hidden');

            } catch (error) {
                console.error('Rich AI Error:', error);
                content.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                loading.classList.add('hidden');
                results.classList.remove('hidden');
            }
        }

        function displayAIResults(analysis) {
            const content = document.getElementById('aiContent');
            const suggestions = analysis.suggestions;

            let html = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="font-semibold text-blue-800">Week ${analysis.week} Summary</h3>
                    <p class="text-blue-600">Analyzed ${analysis.games.length} games</p>
                </div>
            `;

            // Easy Picks
            if (suggestions.easyPicks.length > 0) {
                html += `
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-green-800 mb-2">üéØ Easy Picks (High Confidence)</h3>
                `;
                suggestions.easyPicks.forEach(game => {
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-green-200 last:border-b-0">
                            <span class="font-medium">${game.matchup}</span>
                            <span class="text-green-600">Pick: ${game.suggestion} (${game.confidence}%)</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Hard Picks
            if (suggestions.hardPicks.length > 0) {
                html += `
                    <div class="bg-red-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Tough Calls (Low Confidence)</h3>
                `;
                suggestions.hardPicks.forEach(game => {
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                            <span class="font-medium">${game.matchup}</span>
                            <span class="text-red-600">Pick: ${game.suggestion} (${game.confidence}%)</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Confidence Rankings
            const rankings = window.SimpleNerdAI.generateConfidenceOrder(analysis.games);
            html += `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-2">üìä Confidence Rankings</h3>
                    <div class="space-y-2">
            `;
            rankings.slice(0, 8).forEach(rank => {
                const bgColor = rank.difficulty === 'easy' ? 'bg-green-100' :
                               rank.difficulty === 'very hard' ? 'bg-red-100' : 'bg-yellow-100';
                html += `
                    <div class="flex justify-between items-center p-2 ${bgColor} rounded">
                        <span class="font-medium">${rank.rank}. ${rank.pick}</span>
                        <span class="text-sm">${rank.confidence}% confident</span>
                    </div>
                `;
            });
            html += `</div></div>`;

            content.innerHTML = html;
        }

        function displayRichAIResults(analysis) {
            const content = document.getElementById('aiContent');

            let html = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="font-semibold text-blue-800">üéØ Week ${analysis.week} Rich Analysis</h3>
                    <p class="text-blue-600">
                        ${analysis.summary.totalGames} games analyzed |
                        ESPN Live: ${analysis.summary.dataQuality.realESPNData ? '‚úÖ REAL' : '‚ùå FAILED'} |
                        Live News: ${analysis.summary.dataQuality.liveNews ? '‚úÖ REAL' : '‚ùå FAILED'} |
                        Live Teams: ${analysis.summary.dataQuality.liveTeams ? '‚úÖ REAL' : '‚ùå FAILED'} |
                        Source: ${analysis.summary.dataQuality.dataSource.toUpperCase()}
                    </p>
                </div>
            `;

            // Best Bets
            if (analysis.recommendations.bestBets.length > 0) {
                html += `
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-green-800 mb-2">üéØ Best Bets (High Confidence)</h3>
                `;
                analysis.recommendations.bestBets.forEach(game => {
                    html += `
                        <div class="border-b border-green-200 pb-3 mb-3 last:border-b-0 last:mb-0">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium">${game.matchup}</span>
                                <span class="text-green-600 font-bold">Pick: ${game.aiPick} (${game.confidence}%)</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-1">
                                <strong>Betting Line:</strong> ${game.analysis.bettingLines.spread || 'N/A'} |
                                <strong>Total:</strong> ${game.analysis.bettingLines.total || 'N/A'}
                            </div>
                            <div class="text-sm text-gray-700">
                                <strong>Key Factors:</strong> ${game.reasoning.join(', ')}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Upset Alerts
            if (analysis.recommendations.upsetAlerts.length > 0) {
                html += `
                    <div class="bg-red-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Upset Alerts</h3>
                `;
                analysis.recommendations.upsetAlerts.forEach(game => {
                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-red-200 last:border-b-0">
                            <span class="font-medium">${game.matchup}</span>
                            <span class="text-red-600">Pick: ${game.aiPick} (${game.confidence}%)</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Injury Watch
            if (analysis.recommendations.injuryWatch.length > 0) {
                html += `
                    <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-yellow-800 mb-2">üè• Injury Impact Games</h3>
                `;
                analysis.recommendations.injuryWatch.forEach(game => {
                    html += `
                        <div class="py-2 border-b border-yellow-200 last:border-b-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-medium">${game.matchup}</span>
                                <span class="text-yellow-600">Pick: ${game.aiPick}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                Home Injuries: ${game.analysis.injuries.home.length} |
                                Away Injuries: ${game.analysis.injuries.away.length}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Detailed Game Analysis with WHY
            html += `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-4">üìä AI Confidence Rankings with Analysis</h3>
                    <div class="space-y-4">
            `;
            analysis.confidenceRankings.forEach(rank => {
                const bgColor = rank.difficulty === 'easy' ? 'bg-green-100' :
                               rank.difficulty === 'very hard' ? 'bg-red-100' : 'bg-yellow-100';

                html += `
                    <div class="p-4 ${bgColor} rounded-lg border">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="text-xl font-bold">${rank.rank}. ${rank.aiPick}</span>
                                <span class="text-lg text-gray-700 ml-2">(${rank.matchup})</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600">${rank.confidence}%</div>
                                <div class="text-sm text-gray-600">${rank.difficulty.toUpperCase()}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                            <div class="bg-white p-3 rounded">
                                <h4 class="font-semibold text-sm text-gray-700 mb-1">üèà Game Info</h4>
                                <div class="text-sm">
                                    <div><strong>Status:</strong> ${rank.gameStatus || 'Scheduled'}</div>
                                    <div><strong>Venue:</strong> ${rank.analysis?.espnData?.venue || 'TBD'}</div>
                                    <div><strong>Records:</strong> ${rank.analysis?.records?.home || 'N/A'} vs ${rank.analysis?.records?.away || 'N/A'}</div>
                                </div>
                            </div>

                            <div class="bg-white p-3 rounded">
                                <h4 class="font-semibold text-sm text-gray-700 mb-1">üí∞ Betting Info</h4>
                                <div class="text-sm">
                                    <div><strong>Spread:</strong> ${rank.analysis?.bettingLines?.spread || 'Pick'}</div>
                                    <div><strong>O/U:</strong> ${rank.analysis?.bettingLines?.overUnder || 'N/A'}</div>
                                    <div><strong>Strength:</strong> ${rank.analysis?.teamStrength?.home || 'N/A'} vs ${rank.analysis?.teamStrength?.away || 'N/A'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-3 rounded mb-3">
                            <h4 class="font-semibold text-sm text-gray-700 mb-2">üß† AI Reasoning - WHY ${rank.aiPick}?</h4>
                            <div class="text-sm space-y-1">
                                ${rank.reasoning?.map(reason => `<div class="flex items-start"><span class="text-blue-500 mr-2">‚Ä¢</span>${reason}</div>`).join('') || '<div>Analysis in progress...</div>'}
                            </div>
                        </div>

                        ${rank.analysis?.injuries && (rank.analysis.injuries.home?.length > 0 || rank.analysis.injuries.away?.length > 0) ? `
                        <div class="bg-yellow-50 p-3 rounded">
                            <h4 class="font-semibold text-sm text-orange-700 mb-2">üè• Injury Impact</h4>
                            <div class="text-sm">
                                ${rank.analysis.injuries.home?.length > 0 ? `<div><strong>${rank.homeTeam}:</strong> ${rank.analysis.injuries.home.length} injury concerns</div>` : ''}
                                ${rank.analysis.injuries.away?.length > 0 ? `<div><strong>${rank.awayTeam}:</strong> ${rank.analysis.injuries.away.length} injury concerns</div>` : ''}
                                <div class="text-xs text-gray-600 mt-1">Impact Level: ${rank.analysis.injuries.impact?.toUpperCase() || 'LOW'}</div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="flex flex-wrap gap-2 mt-3">
                            ${rank.tags?.map(tag => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${tag}</span>`).join('') || ''}
                            ${rank.learningExperience ? '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded font-semibold">üß† Learning Experience</span>' : ''}
                        </div>
                    </div>
                `;
            });
            html += `</div></div>`;

            content.innerHTML = html;
        }

        async function getBettingLines() {
            console.log('üéØ NERDAI_DEBUG: Fetching betting lines from scoresandodds.com...');
            // This would integrate with scoresandodds.com API
            alert('Betting lines integration ready - would fetch from scoresandodds.com');
        }

        async function showAccuracyReport() {
            const content = document.getElementById('aiContent');
            const results = document.getElementById('aiResults');

            try {
                console.log('üéØ NERDAI_DEBUG: Generating accuracy report...');

                // Ensure user is authenticated
                if (!window.auth.currentUser) {
                    await window.auth.signInAnonymously();
                    console.log('üéØ NERDAI_DEBUG: Authenticated for accuracy report');
                }

                const dashboardHTML = await window.PredictionTracker.displayAccuracyDashboard();

                content.innerHTML = dashboardHTML;
                results.classList.remove('hidden');

            } catch (error) {
                content.innerHTML = `<div class="text-red-600">Error loading accuracy report: ${error.message}</div>`;
                results.classList.remove('hidden');
            }
        }

        async function testRichAI() {
            const testResults = document.getElementById('testResults');
            const testOutput = document.getElementById('testOutput');

            try {
                console.log('üéØ NERDAI_DEBUG: Testing Rich AI Tool...');
                const result = await window.testRichAI();

                testOutput.textContent = JSON.stringify(result, null, 2);
                testResults.classList.remove('hidden');

            } catch (error) {
                testOutput.textContent = `Error: ${error.message}`;
                testResults.classList.remove('hidden');
            }
        }

        async function updatePredictionsWithResults() {
            const content = document.getElementById('aiContent');
            const results = document.getElementById('aiResults');

            try {
                console.log('üîÑ RESULTS_TRACKER: Updating predictions with actual results...');

                // Ensure user is authenticated
                if (!window.auth.currentUser) {
                    await window.auth.signInAnonymously();
                    console.log('üîÑ RESULTS_TRACKER: Authenticated for results update');
                }

                const currentWeek = 4; // Dynamic: getCurrentNFLWeek()
                const updateResult = await window.ResultsTracker.updatePredictionsWithResults(currentWeek);

                if (updateResult.success) {
                    content.innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold text-green-800 mb-3">‚úÖ Results Updated Successfully!</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-blue-600">${updateResult.week}</div>
                                    <div class="text-sm text-gray-600">Week Updated</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-green-600">${updateResult.updatedCount}</div>
                                    <div class="text-sm text-gray-600">Games Updated</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-purple-600">${updateResult.correctPredictions}</div>
                                    <div class="text-sm text-gray-600">Correct Picks</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-orange-600">${updateResult.accuracy}%</div>
                                    <div class="text-sm text-gray-600">Accuracy</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">üéØ Tagged as Learning Experience</h4>
                            <p class="text-blue-700">AI predictions updated with actual results. Future predictions will include learning from these outcomes.</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = `<div class="text-red-600">Error updating results: ${updateResult.error}</div>`;
                }

                results.classList.remove('hidden');

            } catch (error) {
                content.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                results.classList.remove('hidden');
            }
        }

        async function showLearningInsights() {
            const content = document.getElementById('aiContent');
            const results = document.getElementById('aiResults');

            try {
                console.log('üß† RESULTS_TRACKER: Analyzing learning insights...');

                // Ensure user is authenticated
                if (!window.auth.currentUser) {
                    await window.auth.signInAnonymously();
                    console.log('üß† RESULTS_TRACKER: Authenticated for learning insights');
                }

                const analysisResult = await window.ResultsTracker.analyzeAccuracyTrends();

                if (analysisResult.success) {
                    const analysis = analysisResult.analysis;
                    const insights = window.ResultsTracker.generateLearningInsights(analysis);

                    let html = `
                        <div class="bg-purple-50 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold text-purple-800 mb-3">üß† AI Learning Insights</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-green-600">${analysis.overallAccuracy}%</div>
                                    <div class="text-sm text-gray-600">Overall Accuracy</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-blue-600">${analysis.totalGames}</div>
                                    <div class="text-sm text-gray-600">Games Analyzed</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-purple-600">${analysis.confidenceBreakdown.high.accuracy}%</div>
                                    <div class="text-sm text-gray-600">High Confidence</div>
                                </div>
                                <div class="bg-white p-3 rounded text-center">
                                    <div class="text-2xl font-bold text-red-600">${analysis.surprises.length}</div>
                                    <div class="text-sm text-gray-600">Surprises</div>
                                </div>
                            </div>
                        </div>
                    `;

                    if (insights.length > 0) {
                        html += `
                            <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                                <h4 class="font-semibold text-yellow-800 mb-3">üí° Learning Insights</h4>
                                <div class="space-y-3">
                        `;
                        insights.forEach(insight => {
                            const bgColor = insight.type === 'improvement' ? 'bg-green-100' :
                                           insight.type === 'decline' ? 'bg-red-100' : 'bg-blue-100';
                            html += `
                                <div class="${bgColor} p-3 rounded border-l-4 border-current">
                                    <div class="font-medium">${insight.message}</div>
                                    <div class="text-sm text-gray-600 mt-1"><strong>Action:</strong> ${insight.action}</div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }

                    if (analysis.surprises.length > 0) {
                        html += `
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-3">üò± Biggest Surprises (Learning Experiences)</h4>
                                <div class="space-y-2">
                        `;
                        analysis.surprises.slice(0, 5).forEach(surprise => {
                            html += `
                                <div class="bg-white p-3 rounded border border-red-200">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">${surprise.matchup}</span>
                                        <span class="text-red-600">Week ${surprise.week}</span>
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        <span class="text-red-600">Predicted: ${surprise.aiPick} (${surprise.confidence}%)</span>
                                        <span class="mx-2">‚Üí</span>
                                        <span class="text-green-600">Actual: ${surprise.actualWinner}</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1 italic">üè∑Ô∏è Tagged as Learning Experience</div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }

                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<div class="text-red-600">Error analyzing insights: ${analysisResult.error}</div>`;
                }

                results.classList.remove('hidden');

            } catch (error) {
                content.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                results.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>