<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ USER & POOL MANAGER - NerdFootball Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #000000;
            color: #00d4ff;
            overflow: hidden;
            position: relative;
        }

        @keyframes stars {
            0% { transform: translateY(0); }
            100% { transform: translateY(-2000px); }
        }

        .star-field {
            position: fixed;
            width: 100%;
            height: 200%;
            top: 0;
            left: 0;
            z-index: 0;
            background:
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent);
            background-size: 200px 200px, 300px 300px, 150px 150px, 250px 250px, 180px 180px;
            animation: stars 60s linear infinite;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        .neon-text {
            text-shadow:
                0 0 5px #00d4ff,
                0 0 10px #00d4ff,
                0 0 20px #00d4ff,
                0 0 40px #0095ff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .cache-card {
            background: linear-gradient(135deg, rgba(15, 15, 45, 0.9) 0%, rgba(25, 15, 50, 0.9) 100%);
            border: 2px solid;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .cache-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(138, 43, 226, 0.2), transparent);
            transition: left 0.5s;
        }

        .cache-card:hover::before {
            left: 100%;
        }

        .cache-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.5);
        }

        .btn-asteroid {
            background: linear-gradient(135deg, #6a0dad 0%, #4b0082 100%);
            border: 2px solid #8a2be2;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-asteroid::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-asteroid:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-asteroid:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #8a2be2;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            border-color: #ff1744;
        }

        .btn-danger:hover {
            box-shadow: 0 0 20px #ff1744;
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            border-color: #00ff41;
            color: #000;
        }

        .btn-success:hover {
            box-shadow: 0 0 20px #00ff41;
        }

        .status-online {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff41;
            box-shadow: 0 0 10px #00ff41;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-stale {
            background: #ffa500;
            box-shadow: 0 0 10px #ffa500;
        }

        .status-error {
            background: #ff1744;
            box-shadow: 0 0 10px #ff1744;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00d4ff 0%, #8a2be2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .grid-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background-image:
                linear-gradient(rgba(138, 43, 226, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(138, 43, 226, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .endpoint-test {
            background: rgba(10, 10, 30, 0.95);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .log-output {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #00ff41;
            max-height: 200px;
            overflow-y: auto;
        }

        .auth-banner {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .cache-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        @keyframes engineBoostAnimation {
            0% {
                transform: translateX(-50%) scale(0);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translateX(-50%) scale(3);
                opacity: 0;
            }
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6a0dad 0%, #4b0082 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8a2be2 0%, #6a0dad 100%);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        input[type="text"],
        input[type="email"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #8a2be2;
            border-radius: 5px;
            padding: 10px 15px;
            color: white;
            font-family: 'Orbitron', monospace;
        }

        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        label {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="star-field"></div>
    <div class="grid-bg"></div>

    <div class="container">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-black neon-text mb-2">üéÆ USER & POOL MANAGER</h1>
            <p class="text-xl text-purple-400">NerdFootball Admin Command Center</p>
            <p class="text-sm text-gray-400 mt-2">ASTEROIDS THEME ‚Ä¢ ADMIN ONLY</p>
        </div>

        <div id="authBanner" class="auth-banner hidden">
            <span id="adminEmail"></span> - AUTHENTICATED ‚úì
            <button onclick="handleSignOut()" class="ml-4 bg-black text-white px-4 py-1 rounded text-sm">SIGN OUT</button>
        </div>

        <div id="accessDenied" class="hidden text-center p-10">
            <h2 class="text-3xl text-red-500 mb-4">‚õî ACCESS DENIED</h2>
            <p class="text-gray-400 mb-6">Admin authentication required</p>
            <button onclick="handleSignIn()" class="btn-asteroid">AUTHENTICATE</button>
        </div>

        <div id="managerContent" class="hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="cache-card" style="border-color: #00d4ff;">
                    <p class="text-xs text-gray-400">TOTAL USERS</p>
                    <p class="metric-value" id="statTotalUsers">0</p>
                </div>
                <div class="cache-card" style="border-color: #00ff41;">
                    <p class="text-xs text-gray-400">CONFIDENCE POOL</p>
                    <p class="metric-value" id="statConfidence">0</p>
                </div>
                <div class="cache-card" style="border-color: #ffa500;">
                    <p class="text-xs text-gray-400">SURVIVOR POOL</p>
                    <p class="metric-value" id="statSurvivor">0</p>
                </div>
                <div class="cache-card" style="border-color: #8a2be2;">
                    <p class="text-xs text-gray-400">BOTH POOLS</p>
                    <p class="metric-value" id="statBoth">0</p>
                </div>
            </div>

            <div class="text-center mb-6">
                <button onclick="showAddUserModal()" class="btn-asteroid btn-success text-lg px-8 py-4">
                    ‚ûï ADD NEW USER
                </button>
            </div>

            <div class="cache-grid" id="userGrid">
            </div>

            <div class="endpoint-test mt-8">
                <h3 class="text-xl font-bold text-blue-400 mb-4">üìã ACTION LOG</h3>
                <div class="log-output" id="actionLog">
                    <div class="text-gray-500">üîç NERD_CRUD: Awaiting actions...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="addUserModal" class="hidden modal-overlay">
        <div class="cache-card modal-content" style="border-color: #00ff41;">
            <h2 class="text-2xl font-bold text-green-400 mb-6">‚ûï ADD NEW USER</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Select User *</label>
                    <select id="addUserSelect" class="w-full bg-gray-900 text-green-400 border border-green-400 rounded p-2" onchange="handleUserSelection()">
                        <option value="">Loading users...</option>
                    </select>
                </div>

                <input type="hidden" id="addUserId">

                <div>
                    <label class="block text-sm text-gray-400 mb-2">Display Name *</label>
                    <input type="text" id="addUserName" placeholder="Auto-populated" readonly style="background-color: #1a1a2e;">
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email *</label>
                    <input type="email" id="addUserEmail" placeholder="Auto-populated" readonly style="background-color: #1a1a2e;">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="addUserConfidence" checked>
                        <span class="text-gray-300">‚ö° Enable Confidence Pool</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="addUserSurvivor" checked>
                        <span class="text-gray-300">üõ°Ô∏è Enable Survivor Pool</span>
                    </label>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="executeAddUser()" class="btn-asteroid btn-success flex-1">
                    ‚úÖ ADD USER
                </button>
                <button onclick="closeAddUserModal()" class="btn-asteroid flex-1">
                    ‚ùå CANCEL
                </button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="hidden modal-overlay">
        <div class="cache-card modal-content" style="border-color: #ffa500;">
            <h2 class="text-2xl font-bold text-orange-400 mb-6">‚úèÔ∏è EDIT USER</h2>

            <input type="hidden" id="editUserId">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Display Name *</label>
                    <input type="text" id="editUserName">
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email *</label>
                    <input type="email" id="editUserEmail">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="editUserConfidence">
                        <span class="text-gray-300">‚ö° Enable Confidence Pool</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="editUserSurvivor">
                        <span class="text-gray-300">üõ°Ô∏è Enable Survivor Pool</span>
                    </label>
                </div>

                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="editUserActive">
                    <span class="text-gray-300">üü¢ User is Active</span>
                </label>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="executeEditUser()" class="btn-asteroid btn-success flex-1">
                    üíæ SAVE CHANGES
                </button>
                <button onclick="closeEditUserModal()" class="btn-asteroid flex-1">
                    ‚ùå CANCEL
                </button>
            </div>
        </div>
    </div>

    <div id="deepStar6Modal" class="hidden modal-overlay">
        <div class="cache-card modal-content" style="border-color: #ff0000;">
            <h2 class="text-3xl font-black text-red-500 mb-6">‚ò†Ô∏è DEEP STAR 6 THAT SUCKA</h2>

            <input type="hidden" id="deepStar6UserId">

            <div class="space-y-6">
                <div class="bg-red-900/30 border-2 border-red-500 rounded-lg p-4">
                    <p class="text-xl font-bold text-white mb-2" id="deepStar6UserName"></p>
                    <p class="text-sm text-gray-400 font-mono" id="deepStar6UserUID"></p>
                </div>

                <div class="bg-black/50 rounded-lg p-4">
                    <p class="text-lg font-bold text-red-400 mb-3">üóëÔ∏è WHAT WILL BE DELETED:</p>
                    <ul class="text-sm text-gray-300 space-y-2">
                        <li>‚Ä¢ Pool membership</li>
                        <li>‚Ä¢ All confidence picks (18 weeks)</li>
                        <li>‚Ä¢ All survivor picks (18 weeks)</li>
                        <li>‚Ä¢ All scoring data (18 weeks)</li>
                        <li>‚Ä¢ All elimination records</li>
                        <li>‚Ä¢ All rollup stats (season & weekly)</li>
                    </ul>
                </div>

                <div class="bg-yellow-900/30 border-2 border-yellow-500 rounded-lg p-4">
                    <p class="text-lg font-bold text-yellow-400 mb-2">‚ö†Ô∏è SAFETY</p>
                    <p class="text-sm text-gray-300">USER DATA WILL BE ARCHIVED FIRST (backup)</p>
                </div>

                <div class="bg-black/80 rounded-lg p-4 text-center">
                    <p class="text-2xl font-black text-red-500 mb-3">‚ö†Ô∏è TYPE TO CONFIRM ‚ö†Ô∏è</p>
                    <p class="text-lg text-white mb-4">Type <span class="text-red-400 font-black">FEEEEE</span> to confirm</p>
                    <input type="text"
                           id="deepStar6ConfirmInput"
                           placeholder="Type FEEEEE here"
                           class="text-center text-2xl font-bold"
                           style="border: 2px solid #ff0000;"
                           oninput="validateDeepStar6Confirmation()">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button id="deepStar6ExecuteBtn"
                        onclick="executeDeepStar6()"
                        class="btn-asteroid btn-danger flex-1 text-lg py-3"
                        style="background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);"
                        disabled>
                    ‚ò†Ô∏è EXECUTE DEEP STAR 6
                </button>
                <button onclick="closeDeepStar6Modal()" class="btn-asteroid flex-1 text-lg py-3">
                    ‚ùå CANCEL
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getFirebaseConfig } from './js/config/firebase-config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js';

        const app = initializeApp(getFirebaseConfig());
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        const ADMIN_UIDS = [
            'WxSPmEildJdqs6T5hIpBUZrscwt2',
            'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2'
        ];

        const POOL_ID = 'nerduniverse-2025';
        const POOL_MEMBERS_PATH = 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members';
        const GHOST_USER_ID = 'okl4sw2aDhW3yKpOfOwe5lH7OQj1';

        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;

        let currentUser = null;
        let isAdmin = false;

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            console.log('üîê NERD_CRUD_AUTH: Auth state changed', user?.email || 'Not signed in');

            if (user && ADMIN_UIDS.includes(user.uid)) {
                isAdmin = true;
                document.getElementById('authBanner').classList.remove('hidden');
                document.getElementById('adminEmail').textContent = user.email;
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('managerContent').classList.remove('hidden');

                console.log('‚úÖ NERD_CRUD_AUTH: Admin authenticated');
                await loadAllUsers();
            } else {
                isAdmin = false;
                document.getElementById('authBanner').classList.add('hidden');
                document.getElementById('accessDenied').classList.remove('hidden');
                document.getElementById('managerContent').classList.add('hidden');

                console.log('‚õî NERD_CRUD_AUTH: Access denied');
            }
        });

        window.handleSignIn = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('‚ùå NERD_CRUD_AUTH: Sign in error:', error);
                logAction(`‚ùå Sign in failed: ${error.message}`, 'error');
            }
        };

        window.handleSignOut = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('‚ùå NERD_CRUD_AUTH: Sign out error:', error);
            }
        };

        async function loadAllUsers() {
            try {
                logAction('üîÑ Loading all pool members...', 'info');

                const membersRef = doc(db, POOL_MEMBERS_PATH);
                const membersSnap = await getDoc(membersRef);

                if (!membersSnap.exists()) {
                    logAction('‚ö†Ô∏è No pool members document found', 'warning');
                    return;
                }

                const members = membersSnap.data();
                const userGrid = document.getElementById('userGrid');
                userGrid.innerHTML = '';

                let totalUsers = 0;
                let confidenceCount = 0;
                let survivorCount = 0;
                let bothCount = 0;

                // Sort users alphabetically by name
                const sortedMembers = Object.entries(members).sort((a, b) => {
                    const nameA = (a[1].name || a[1].email || 'zzz').toLowerCase();
                    const nameB = (b[1].name || b[1].email || 'zzz').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                for (const [uid, userData] of sortedMembers) {
                    if (uid === GHOST_USER_ID) {
                        console.log('üö´ NERD_CRUD: Skipping ghost user:', uid);
                        continue;
                    }

                    if (!userData.participation) {
                        userData.participation = {
                            confidence: { enabled: true, status: 'active' },
                            survivor: { enabled: true, status: 'active' }
                        };
                    }

                    const confEnabled = userData.participation.confidence.enabled;
                    const survEnabled = userData.participation.survivor.enabled;

                    totalUsers++;
                    if (confEnabled) confidenceCount++;
                    if (survEnabled) survivorCount++;
                    if (confEnabled && survEnabled) bothCount++;

                    const userCard = createUserCard(uid, userData);
                    userGrid.appendChild(userCard);
                }

                document.getElementById('statTotalUsers').textContent = totalUsers;
                document.getElementById('statConfidence').textContent = confidenceCount;
                document.getElementById('statSurvivor').textContent = survivorCount;
                document.getElementById('statBoth').textContent = bothCount;

                logAction(`‚úÖ Loaded ${totalUsers} users successfully`, 'success');
                console.log(`üéÆ NERD_CRUD: ${totalUsers} users loaded, ${confidenceCount} confidence, ${survivorCount} survivor`);

            } catch (error) {
                console.error('‚ùå NERD_CRUD: Load users error:', error);
                logAction(`‚ùå Failed to load users: ${error.message}`, 'error');
            }
        }

        function createUserCard(uid, userData) {
            const card = document.createElement('div');
            card.className = 'cache-card';
            card.style.borderColor = '#00d4ff';
            card.setAttribute('data-user-id', uid);

            const confEnabled = userData.participation?.confidence?.enabled ?? true;
            const survEnabled = userData.participation?.survivor?.enabled ?? true;
            const isActive = userData.isActive ?? true;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-blue-400">${userData.name || 'No Name Set'}</h3>
                        <p class="text-sm text-gray-400">${userData.email || 'No email'}</p>
                        <p class="text-xs text-gray-500 font-mono mt-1">${uid}</p>
                    </div>
                    <span class="${isActive ? 'status-online' : 'status-error'}"></span>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="text-center p-2 rounded ${confEnabled ? 'bg-green-900/30' : 'bg-red-900/30'}">
                        <div class="text-2xl mb-1">${confEnabled ? '‚ö°' : 'üö´'}</div>
                        <div class="text-xs text-gray-400">CONFIDENCE</div>
                        <div class="text-xs ${confEnabled ? 'text-green-400' : 'text-red-400'}">
                            ${confEnabled ? 'ACTIVE' : 'DISABLED'}
                        </div>
                    </div>
                    <div class="text-center p-2 rounded ${survEnabled ? 'bg-green-900/30' : 'bg-red-900/30'}">
                        <div class="text-2xl mb-1">${survEnabled ? 'üõ°Ô∏è' : 'üö´'}</div>
                        <div class="text-xs text-gray-400">SURVIVOR</div>
                        <div class="text-xs ${survEnabled ? 'text-green-400' : 'text-red-400'}">
                            ${survEnabled ? 'ACTIVE' : 'DISABLED'}
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="editUser('${uid}')"
                            class="btn-asteroid flex-1 text-sm py-2">
                        ‚úèÔ∏è EDIT
                    </button>
                    <button onclick="confirmRemoveUser('${uid}', '${userData.name?.replace(/'/g, "\\'")}')"
                            class="btn-asteroid btn-danger flex-1 text-sm py-2">
                        üóëÔ∏è REMOVE
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="confirmDeepStar6('${uid}', '${userData.name?.replace(/'/g, "\\'")}')"
                            class="btn-asteroid btn-danger w-full text-sm py-2"
                            style="background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%);">
                        ‚ò†Ô∏è DEEP STAR 6
                    </button>
                </div>
            `;

            return card;
        }

        window.showAddUserModal = async () => {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('addUserId').value = '';
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserConfidence').checked = true;
            document.getElementById('addUserSurvivor').checked = true;
            console.log('üéÆ NERD_CRUD: Add user modal opened');

            await loadAvailableUsers();
        };

        async function loadAvailableUsers() {
            const selectElement = document.getElementById('addUserSelect');
            selectElement.innerHTML = '<option value="">Loading users...</option>';

            try {
                console.log('üîç NERD_CRUD: Fetching available users not in pool...');

                const getAuthUsers = httpsCallable(functions, 'getAuthUsersNotInPool');
                const result = await getAuthUsers({ poolId: POOL_ID });

                const { users, totalAuthUsers, totalPoolMembers } = result.data;

                console.log('üîç NERD_CRUD: Found users', {
                    usersNotInPool: users.length,
                    totalAuthUsers,
                    totalPoolMembers
                });

                if (users.length === 0) {
                    selectElement.innerHTML = '<option value="">No users available - all Firebase Auth users are already in pool</option>';
                    return;
                }

                selectElement.innerHTML = '<option value="">-- Select a user to add --</option>';

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({ uid: user.uid, displayName: user.displayName, email: user.email });

                    // Build status indicator
                    let statusIndicator = '';
                    if (user.poolStatus === 'N') {
                        statusIndicator = '[NOT IN POOL]';
                    } else if (user.poolStatus === 'C+S') {
                        statusIndicator = '[C+S]';
                    } else if (user.poolStatus === 'C') {
                        statusIndicator = '[C ONLY]';
                    } else if (user.poolStatus === 'S') {
                        statusIndicator = '[S ONLY]';
                    }

                    option.textContent = `${user.displayName} (${user.email}) ${statusIndicator}`;

                    if (user.disabled) {
                        option.textContent += ' [DISABLED]';
                        option.style.color = '#ff6b6b';
                    }
                    selectElement.appendChild(option);
                });

                logAction(`‚úÖ Loaded ${users.length} available users`, 'success');

            } catch (error) {
                console.error('üîç NERD_CRUD: Error loading available users', error);
                selectElement.innerHTML = '<option value="">Error loading users - check console</option>';
                logAction(`‚ùå Failed to load users: ${error.message}`, 'error');
            }
        }

        window.handleUserSelection = () => {
            const selectElement = document.getElementById('addUserSelect');
            const selectedValue = selectElement.value;

            if (!selectedValue) {
                document.getElementById('addUserId').value = '';
                document.getElementById('addUserName').value = '';
                document.getElementById('addUserEmail').value = '';
                return;
            }

            try {
                const userData = JSON.parse(selectedValue);
                console.log('üéÆ NERD_CRUD: User selected', userData);

                document.getElementById('addUserId').value = userData.uid;
                document.getElementById('addUserName').value = userData.displayName;
                document.getElementById('addUserEmail').value = userData.email;

                logAction(`üë§ Selected: ${userData.displayName}`, 'info');

            } catch (error) {
                console.error('üéÆ NERD_CRUD: Error parsing user selection', error);
                logAction('‚ùå Error selecting user', 'error');
            }
        };

        window.closeAddUserModal = () => {
            document.getElementById('addUserModal').classList.add('hidden');
            console.log('üéÆ NERD_CRUD: Add user modal closed');
        };

        window.executeAddUser = async () => {
            if (!isAdmin) {
                logAction('‚ùå Admin access required', 'error');
                return;
            }

            const uid = document.getElementById('addUserId').value.trim();
            const name = document.getElementById('addUserName').value.trim();
            const email = document.getElementById('addUserEmail').value.trim();
            const confEnabled = document.getElementById('addUserConfidence').checked;
            const survEnabled = document.getElementById('addUserSurvivor').checked;

            if (!uid || !name || !email) {
                logAction('‚ùå All fields are required', 'error');
                alert('Please fill in all required fields');
                return;
            }

            if (uid === GHOST_USER_ID) {
                logAction('‚ùå Cannot add ghost user ID', 'error');
                alert('This user ID is blocked');
                return;
            }

            try {
                logAction(`‚ûï Adding user: ${name} (${email})...`, 'info');
                console.log('üéÆ NERD_CRUD: Adding user', { uid, name, email, confEnabled, survEnabled });

                const membersRef = doc(db, POOL_MEMBERS_PATH);
                const membersSnap = await getDoc(membersRef);

                let currentMembers = {};
                if (membersSnap.exists()) {
                    currentMembers = membersSnap.data();
                }

                if (currentMembers[uid]) {
                    logAction(`‚ö†Ô∏è User ${name} already exists`, 'warning');
                    alert('This user ID already exists in the pool');
                    return;
                }

                currentMembers[uid] = {
                    name: name,
                    email: email,
                    addedAt: new Date().toISOString(),
                    addedBy: currentUser.uid,
                    isActive: true,
                    participation: {
                        confidence: {
                            enabled: confEnabled,
                            status: confEnabled ? 'active' : 'disabled'
                        },
                        survivor: {
                            enabled: survEnabled,
                            status: survEnabled ? 'active' : 'disabled'
                        }
                    }
                };

                await setDoc(membersRef, currentMembers);

                logAction(`‚úÖ User added successfully: ${name}`, 'success');
                console.log('‚úÖ NERD_CRUD: User added successfully', uid);
                closeAddUserModal();
                await loadAllUsers();

            } catch (error) {
                console.error('‚ùå NERD_CRUD: Add user error:', error);
                logAction(`‚ùå Failed to add user: ${error.message}`, 'error');
            }
        };

        window.editUser = async (uid) => {
            if (!isAdmin) return;

            try {
                logAction(`‚úèÔ∏è Loading user data for edit: ${uid}`, 'info');
                console.log('üéÆ NERD_CRUD: Loading user for edit', uid);

                const membersRef = doc(db, POOL_MEMBERS_PATH);
                const membersSnap = await getDoc(membersRef);

                if (!membersSnap.exists()) {
                    logAction('‚ùå Pool members not found', 'error');
                    return;
                }

                const members = membersSnap.data();
                const userData = members[uid];

                if (!userData) {
                    logAction(`‚ùå User ${uid} not found`, 'error');
                    return;
                }

                document.getElementById('editUserId').value = uid;
                document.getElementById('editUserName').value = userData.name || '';
                document.getElementById('editUserEmail').value = userData.email || '';
                document.getElementById('editUserConfidence').checked =
                    userData.participation?.confidence?.enabled ?? true;
                document.getElementById('editUserSurvivor').checked =
                    userData.participation?.survivor?.enabled ?? true;
                document.getElementById('editUserActive').checked =
                    userData.isActive ?? true;

                document.getElementById('editUserModal').classList.remove('hidden');
                console.log('‚úÖ NERD_CRUD: Edit user modal opened', uid);

            } catch (error) {
                console.error('‚ùå NERD_CRUD: Edit user load error:', error);
                logAction(`‚ùå Failed to load user: ${error.message}`, 'error');
            }
        };

        window.closeEditUserModal = () => {
            document.getElementById('editUserModal').classList.add('hidden');
            console.log('üéÆ NERD_CRUD: Edit user modal closed');
        };

        window.executeEditUser = async () => {
            if (!isAdmin) {
                logAction('‚ùå Admin access required', 'error');
                return;
            }

            const uid = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const confEnabled = document.getElementById('editUserConfidence').checked;
            const survEnabled = document.getElementById('editUserSurvivor').checked;
            const isActive = document.getElementById('editUserActive').checked;

            if (!name || !email) {
                logAction('‚ùå Name and email are required', 'error');
                alert('Please fill in all required fields');
                return;
            }

            try {
                logAction(`üíæ Saving changes for user: ${name}...`, 'info');
                console.log('üéÆ NERD_CRUD: Updating user', { uid, name, email, confEnabled, survEnabled, isActive });

                const membersRef = doc(db, POOL_MEMBERS_PATH);
                const membersSnap = await getDoc(membersRef);

                if (!membersSnap.exists()) {
                    logAction('‚ùå Pool members not found', 'error');
                    return;
                }

                const members = membersSnap.data();

                if (!members[uid]) {
                    logAction(`‚ùå User ${uid} not found`, 'error');
                    return;
                }

                members[uid] = {
                    ...members[uid],
                    name: name,
                    email: email,
                    isActive: isActive,
                    lastModifiedAt: new Date().toISOString(),
                    lastModifiedBy: currentUser.uid,
                    participation: {
                        confidence: {
                            enabled: confEnabled,
                            status: confEnabled ? 'active' : 'disabled'
                        },
                        survivor: {
                            enabled: survEnabled,
                            status: survEnabled ? 'active' : 'disabled'
                        }
                    }
                };

                await setDoc(membersRef, members);

                logAction(`‚úÖ User updated successfully: ${name}`, 'success');
                console.log('‚úÖ NERD_CRUD: User updated successfully', uid);
                closeEditUserModal();
                await loadAllUsers();

            } catch (error) {
                console.error('‚ùå NERD_CRUD: Edit user save error:', error);
                logAction(`‚ùå Failed to update user: ${error.message}`, 'error');
            }
        };

        window.confirmRemoveUser = (uid, userName) => {
            if (!isAdmin) return;

            const confirmation = confirm(
                `‚ö†Ô∏è REMOVE USER FROM POOL?\n\n` +
                `User: ${userName}\n` +
                `UID: ${uid}\n\n` +
                `This will:\n` +
                `- Remove user from pool members\n` +
                `- Archive user data to removed_members\n` +
                `- Disable all pool participation\n\n` +
                `Historical picks and scores will remain intact.\n\n` +
                `This action CANNOT be easily undone.\n\n` +
                `Are you ABSOLUTELY SURE?`
            );

            if (confirmation) {
                executeRemoveUser(uid, userName);
            }
        };

        async function executeRemoveUser(uid, userName) {
            if (!isAdmin) {
                logAction('‚ùå Admin access required', 'error');
                return;
            }

            if (uid === GHOST_USER_ID) {
                logAction('‚ùå Cannot remove ghost user (already blocked)', 'error');
                return;
            }

            try {
                logAction(`üóëÔ∏è Removing user: ${userName} (${uid})...`, 'info');
                console.log('üéÆ NERD_CRUD: Removing user', { uid, userName });

                const membersRef = doc(db, POOL_MEMBERS_PATH);
                const membersSnap = await getDoc(membersRef);

                if (!membersSnap.exists()) {
                    logAction('‚ùå Pool members not found', 'error');
                    return;
                }

                const members = membersSnap.data();

                if (!members[uid]) {
                    logAction(`‚ö†Ô∏è User ${userName} not found in pool`, 'warning');
                    return;
                }

                const archiveData = {
                    ...members[uid],
                    removedAt: new Date().toISOString(),
                    removedBy: currentUser.uid
                };

                const archiveRef = doc(db,
                    `artifacts/nerdfootball/pools/nerduniverse-2025/metadata/removed_members/${uid}`);
                await setDoc(archiveRef, archiveData);

                logAction(`üì¶ User data archived to removed_members/${uid}`, 'info');
                console.log('üì¶ NERD_CRUD: User archived', uid);

                delete members[uid];

                await setDoc(membersRef, members);

                logAction(`‚úÖ User removed successfully: ${userName}`, 'success');
                logAction(`‚ÑπÔ∏è Note: Picks and scores remain intact (not deleted)`, 'info');
                console.log('‚úÖ NERD_CRUD: User removed successfully', uid);

                await loadAllUsers();

            } catch (error) {
                console.error('‚ùå NERD_CRUD: Remove user error:', error);
                logAction(`‚ùå Failed to remove user: ${error.message}`, 'error');
            }
        }

        function logAction(message, type = 'info') {
            const logEl = document.getElementById('actionLog');
            if (!logEl) return;

            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');

            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                warning: 'text-orange-400',
                error: 'text-red-400'
            };

            line.className = colors[type] || colors.info;
            line.textContent = `[${timestamp}] ${message}`;

            logEl.insertBefore(line, logEl.firstChild);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }

            console.log(`üéÆ NERD_CRUD: ${message}`);
        }

        window.confirmDeepStar6 = async (uid, userName) => {
            if (!isAdmin) return;

            try {
                console.log('üí• DEEP_STAR_6: Opening modal for', { uid, userName });

                document.getElementById('deepStar6UserId').value = uid;
                document.getElementById('deepStar6UserName').textContent = userName;
                document.getElementById('deepStar6UserUID').textContent = `UID: ${uid}`;
                document.getElementById('deepStar6ConfirmInput').value = '';
                document.getElementById('deepStar6ExecuteBtn').disabled = true;
                document.getElementById('deepStar6Modal').classList.remove('hidden');

                logAction(`‚ö†Ô∏è DEEP STAR 6 modal opened for ${userName}`, 'warning');
            } catch (error) {
                console.error('‚ùå DEEP_STAR_6: Modal open error:', error);
                logAction(`‚ùå Failed to open DEEP STAR 6 modal: ${error.message}`, 'error');
            }
        };

        window.closeDeepStar6Modal = () => {
            document.getElementById('deepStar6Modal').classList.add('hidden');
            document.getElementById('deepStar6ConfirmInput').value = '';
            document.getElementById('deepStar6ExecuteBtn').disabled = true;
            console.log('üí• DEEP_STAR_6: Modal closed');
        };

        window.validateDeepStar6Confirmation = () => {
            const input = document.getElementById('deepStar6ConfirmInput').value;
            const btn = document.getElementById('deepStar6ExecuteBtn');
            btn.disabled = input !== 'FEEEEE';
            console.log('üí• DEEP_STAR_6: Confirmation validation', { input, valid: input === 'FEEEEE' });
        };

        window.animateDeepStar6 = async (userId) => {
            console.log('üöÄ DEEP_STAR_6_ANIMATION: Starting jettison sequence for', userId);

            // Find the user card
            const userCard = document.querySelector(`[data-user-id="${userId}"]`);
            if (!userCard) {
                console.log('‚ö†Ô∏è DEEP_STAR_6_ANIMATION: User card not found');
                return;
            }

            // Random angle for jettison (between -45 and 45 degrees from vertical)
            const angle = Math.random() * 90 - 45;
            const distance = 2000; // pixels off screen

            // Calculate final position
            const radians = (angle * Math.PI) / 180;
            const translateX = Math.sin(radians) * distance;
            const translateY = -Math.cos(radians) * distance;

            // Apply jettison animation
            userCard.style.transition = 'all 1.5s cubic-bezier(0.17, 0.67, 0.83, 0.67)';
            userCard.style.transform = `translate(${translateX}px, ${translateY}px) rotate(${angle * 4}deg) scale(0.2)`;
            userCard.style.opacity = '0';

            console.log('üí• DEEP_STAR_6_ANIMATION: Card jettisoned at angle', angle);

            // Wait for jettison to complete
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Speed up starfield (3x faster)
            const starfield = document.querySelector('.star-field');
            if (starfield) {
                starfield.style.animationDuration = '20s'; // Normal: 60s, Boost: 20s (3x faster)
                console.log('‚ö° DEEP_STAR_6_ANIMATION: Starfield accelerated to 3x speed');

                // Engine boost effect
                const engineBoost = document.createElement('div');
                engineBoost.className = 'engine-boost';
                engineBoost.style.cssText = `
                    position: fixed;
                    bottom: -100px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 200px;
                    height: 200px;
                    background: radial-gradient(circle, rgba(100, 200, 255, 0.8) 0%, rgba(100, 200, 255, 0) 70%);
                    border-radius: 50%;
                    animation: engineBoostAnimation 2s ease-out forwards;
                    pointer-events: none;
                    z-index: 9999;
                `;

                document.body.appendChild(engineBoost);
                console.log('üî• DEEP_STAR_6_ANIMATION: Engine boost activated');

                // Remove boost after animation
                setTimeout(() => {
                    engineBoost.remove();
                    // Return starfield to normal speed
                    starfield.style.animationDuration = '60s';
                    console.log('üåü DEEP_STAR_6_ANIMATION: Starfield returned to normal speed');
                }, 2000);
            }
        };

        window.executeDeepStar6 = async () => {
            if (!isAdmin) {
                logAction('‚ùå Admin access required', 'error');
                return;
            }

            const uid = document.getElementById('deepStar6UserId').value;
            const userName = document.getElementById('deepStar6UserName').textContent;
            const confirmInput = document.getElementById('deepStar6ConfirmInput').value;

            if (confirmInput !== 'FEEEEE') {
                logAction('‚ùå Invalid confirmation text', 'error');
                return;
            }

            try {
                logAction('üí• Initiating DEEP STAR 6 via Cloud Function...', 'warning');
                console.log('üí• DEEP_STAR_6: Calling Cloud Function for', { uid, userName });

                // Call Firebase Cloud Function (server-side deletion with admin privileges)
                const deepStar6Function = httpsCallable(functions, 'deepStar6User');
                const result = await deepStar6Function({ userId: uid, userName: userName });

                console.log('üí• DEEP_STAR_6: Cloud Function result', result.data);

                logAction(`üì¶ User archived to: ${result.data.archiveId}`, 'success');
                logAction(`üóëÔ∏è Deleted ${result.data.deletionCount} documents`, 'success');
                logAction(`‚úÖ ${result.data.message}`, 'success');

                // DEEP STAR 6 ANIMATION SEQUENCE
                await animateDeepStar6(uid);

                closeDeepStar6Modal();
                await loadAllUsers();

            } catch (error) {
                console.error('‚ùå DEEP_STAR_6: Execution error:', error);
                logAction(`‚ùå DEEP STAR 6 failed: ${error.message}`, 'error');
            }
        };

        console.log('üöÄ NERD_CRUD: User & Pool Manager initialized');
    </script>
</body>
</html>
