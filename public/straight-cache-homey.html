<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ STRAIGHT CACHE HOMEY - NerdFootball Cache Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #000000;
            color: #00d4ff;
            overflow: hidden;
            position: relative;
        }

        @keyframes stars {
            0% { transform: translateY(0); }
            100% { transform: translateY(-2000px); }
        }

        .star-field {
            position: fixed;
            width: 100%;
            height: 200%;
            top: 0;
            left: 0;
            z-index: 0;
            background:
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent),
                radial-gradient(1px 1px at 80% 10%, white, transparent),
                radial-gradient(2px 2px at 90% 60%, white, transparent);
            background-size: 200px 200px, 300px 300px, 150px 150px, 250px 250px, 180px 180px;
            animation: stars 60s linear infinite;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        .neon-text {
            text-shadow:
                0 0 5px #00d4ff,
                0 0 10px #00d4ff,
                0 0 20px #00d4ff,
                0 0 40px #0095ff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .cache-card {
            background: linear-gradient(135deg, rgba(15, 15, 45, 0.9) 0%, rgba(25, 15, 50, 0.9) 100%);
            border: 2px solid;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .cache-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(138, 43, 226, 0.2), transparent);
            transition: left 0.5s;
        }

        .cache-card:hover::before {
            left: 100%;
        }

        .cache-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.5);
        }

        .btn-asteroid {
            background: linear-gradient(135deg, #6a0dad 0%, #4b0082 100%);
            border: 2px solid #8a2be2;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-asteroid::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-asteroid:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-asteroid:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #8a2be2;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
            border-color: #ff1744;
        }

        .btn-danger:hover {
            box-shadow: 0 0 20px #ff1744;
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            border-color: #00ff41;
            color: #000;
        }

        .btn-success:hover {
            box-shadow: 0 0 20px #00ff41;
        }

        .status-online {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff41;
            box-shadow: 0 0 10px #00ff41;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-stale {
            background: #ffa500;
            box-shadow: 0 0 10px #ffa500;
        }

        .status-error {
            background: #ff1744;
            box-shadow: 0 0 10px #ff1744;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00d4ff 0%, #8a2be2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .grid-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background-image:
                linear-gradient(rgba(138, 43, 226, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(138, 43, 226, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .endpoint-test {
            background: rgba(10, 10, 30, 0.95);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .log-output {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #00ff41;
            max-height: 200px;
            overflow-y: auto;
        }

        .auth-banner {
            background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }

        .cache-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #6a0dad 0%, #4b0082 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8a2be2 0%, #6a0dad 100%);
        }
    </style>
</head>
<body>
    <div class="star-field"></div>
    <div class="grid-bg"></div>

    <div class="container">
        <div class="mb-6">
            <a href="/nerd-universe.html" style="color: #00ff41; text-decoration: none; font-size: 20px; display: inline-flex; align-items: center; gap: 8px; transition: color 0.2s; font-weight: 700;" onmouseover="this.style.color='#ffd700'" onmouseout="this.style.color='#00ff41'">
                ‚Üê NERD UNIVERSE
            </a>
        </div>

        <div class="text-center mb-8">
            <h1 class="text-5xl font-black neon-text mb-2">üöÄ STRAIGHT CACHE HOMEY</h1>
            <p class="text-xl text-purple-400">NerdFootball Cache Command Center</p>
            <p class="text-sm text-gray-400 mt-2">ASTEROIDS THEME ‚Ä¢ ADMIN ONLY</p>
        </div>

        <div id="authBanner" class="auth-banner hidden">
            <span id="adminEmail"></span> - AUTHENTICATED ‚úì
            <button onclick="handleSignOut()" class="ml-4 bg-black text-white px-4 py-1 rounded text-sm">SIGN OUT</button>
        </div>

        <div id="accessDenied" class="hidden text-center p-10">
            <h2 class="text-3xl text-red-500 mb-4">‚õî ACCESS DENIED</h2>
            <p class="text-gray-400 mb-6">Admin authentication required</p>
            <button onclick="handleSignIn()" class="btn-asteroid">AUTHENTICATE</button>
        </div>

        <div id="cacheContent" class="hidden">
            <div class="cache-grid">
                <div class="cache-card" style="border-color: #00d4ff;" id="aiCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-blue-400">ü§ñ AI PREDICTIONS</h2>
                        <span class="status-online" id="aiStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">artifacts/nerdfootball/pools/nerduniverse-2025/cache/latest-ai-intel-sheet</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">15 MIN</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AGE</p>
                            <p class="metric-value text-lg" id="aiAge">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">CREATED</p>
                        <p class="text-sm" id="aiCreated">--</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshAICache()" class="btn-asteroid btn-success flex-1">REFRESH</button>
                        <button onclick="deleteCache('ai')" class="btn-asteroid btn-danger flex-1">DELETE</button>
                    </div>
                </div>

                <div class="cache-card" style="border-color: #8a2be2;" id="espnCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-purple-400">üì° ESPN DATA</h2>
                        <span class="status-online" id="espnStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">cache/espn_current_data</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">6 HOURS</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AGE</p>
                            <p class="metric-value text-lg" id="espnAge">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">CREATED</p>
                        <p class="text-sm" id="espnCreated">--</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshESPNCache()" class="btn-asteroid btn-success flex-1">REFRESH</button>
                        <button onclick="deleteCache('espn')" class="btn-asteroid btn-danger flex-1">DELETE</button>
                    </div>
                </div>

                <div class="cache-card" style="border-color: #00ff41;" id="seasonCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-green-400">üèÜ SEASON LEADERBOARD</h2>
                        <span class="status-online" id="seasonStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">cache/season_leaderboard_2025</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">5 MIN</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AGE</p>
                            <p class="metric-value text-lg" id="seasonAge">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">CREATED</p>
                        <p class="text-sm" id="seasonCreated">--</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshSeasonCache()" class="btn-asteroid btn-success flex-1">REFRESH</button>
                        <button onclick="deleteCache('season')" class="btn-asteroid btn-danger flex-1">DELETE</button>
                    </div>
                </div>

                <div class="cache-card" style="border-color: #ffa500;" id="weeklyCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-orange-400">üìÖ WEEKLY LEADERBOARD</h2>
                        <span class="status-online" id="weeklyStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">cache/weekly_leaderboard_2025_week_*</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">2 MIN</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AGE</p>
                            <p class="metric-value text-lg" id="weeklyAge">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">CREATED</p>
                        <p class="text-sm" id="weeklyCreated">--</p>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="refreshWeeklyCache()" class="btn-asteroid btn-success flex-1">REFRESH</button>
                        <button onclick="deleteCache('weekly')" class="btn-asteroid btn-danger flex-1">DELETE</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshAllWeeklyCaches()" class="btn-asteroid btn-warning" style="width: 100%; background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%); border-color: #ff9500;">üî• REFRESH WEEKLY LEADERBOARD</button>
                    </div>
                </div>

                <div class="cache-card" style="border-color: #ff1744;" id="survivorCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-red-400">üíÄ SURVIVOR POOL</h2>
                        <span class="status-online" id="survivorStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">cache/survivor_pool_2025</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">10 SEC</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">AGE</p>
                            <p class="metric-value text-lg" id="survivorAge">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">CREATED</p>
                        <p class="text-sm" id="survivorCreated">--</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="refreshSurvivorCache()" class="btn-asteroid btn-success flex-1">REFRESH</button>
                        <button onclick="deleteCache('survivor')" class="btn-asteroid btn-danger flex-1">DELETE</button>
                    </div>
                </div>

                <div class="cache-card" style="border-color: #ffd700;" id="gridCacheCard">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-yellow-400">‚öîÔ∏è THE GRID</h2>
                        <span class="status-online" id="gridStatus"></span>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-400">Cache Path</p>
                        <p class="text-xs text-purple-300 break-all">artifacts/nerdfootball/pools/nerduniverse-2025/cache/grid-week-*</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-xs text-gray-400">EXPIRY</p>
                            <p class="metric-value text-lg">15 MIN</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">CURRENT WEEK</p>
                            <p class="metric-value text-lg" id="gridWeek">--</p>
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="text-xs text-gray-400">STATUS</p>
                        <p class="text-sm" id="gridCacheStatus">Checking current week cache...</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteGridCache()" class="btn-asteroid btn-danger flex-1">DELETE CURRENT WEEK</button>
                        <button onclick="deleteAllGridCaches()" class="btn-asteroid btn-danger flex-1">DELETE ALL WEEKS</button>
                    </div>
                </div>
            </div>

            <div class="endpoint-test">
                <h3 class="text-xl font-bold text-blue-400 mb-4">üéØ ENDPOINT TESTING</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <button onclick="testEndpoint('ai')" class="btn-asteroid text-sm py-2">TEST AI</button>
                    <button onclick="testEndpoint('season')" class="btn-asteroid text-sm py-2">TEST SEASON</button>
                    <button onclick="testEndpoint('weekly')" class="btn-asteroid text-sm py-2">TEST WEEKLY</button>
                    <button onclick="testEndpoint('survivor')" class="btn-asteroid text-sm py-2">TEST SURVIVOR</button>
                </div>
                <div class="log-output" id="testLog">
                    <div class="text-gray-500">üîç CACHE_TEST: Awaiting endpoint tests...</div>
                </div>
            </div>

            <div class="text-center mt-8">
                <button onclick="refreshAllCaches()" class="btn-asteroid text-lg px-8 py-4">
                    üîÑ REFRESH ALL CACHES
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getFirebaseConfig } from './js/config/firebase-config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const app = initializeApp(getFirebaseConfig());
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_UIDS = ['WxSPmEildJdqs6T5hIpBUZrscwt2', 'BPQvRhpVl1ZzsBXaS7C2iFe2Xpc2'];

        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc;

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            console.log('üîê CACHE_AUTH: Auth state changed', user?.email || 'Not signed in');

            if (user && ADMIN_UIDS.includes(user.uid)) {
                document.getElementById('authBanner').classList.remove('hidden');
                document.getElementById('adminEmail').textContent = user.email;
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('cacheContent').classList.remove('hidden');

                console.log('‚úÖ CACHE_AUTH: Admin authenticated');
                await loadAllCaches();
            } else {
                document.getElementById('authBanner').classList.add('hidden');
                document.getElementById('accessDenied').classList.remove('hidden');
                document.getElementById('cacheContent').classList.add('hidden');

                console.log('‚õî CACHE_AUTH: Access denied');
            }
        });

        window.handleSignIn = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('‚ùå CACHE_AUTH: Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        };

        window.handleSignOut = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('‚ùå CACHE_AUTH: Sign out error:', error);
            }
        };

        async function loadAllCaches() {
            console.log('üîÑ CACHE_LOAD: Loading all cache data...');
            await Promise.all([
                loadAICache(),
                loadESPNCache(),
                loadSeasonCache(),
                loadWeeklyCache(),
                loadSurvivorCache(),
                loadGridCache()
            ]);
        }

        async function loadAICache() {
            try {
                const cacheRef = doc(db, 'artifacts/nerdfootball/pools/nerduniverse-2025/cache', 'latest-ai-intel-sheet');
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.generatedAt ? new Date(data.generatedAt) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 15 * 60;

                    updateCacheUI('ai', created, age, expiry);
                    console.log('‚úÖ CACHE_LOAD: AI cache loaded', { age, expiry });
                } else {
                    updateCacheUI('ai', null, null, 15 * 60);
                    console.log('‚ö†Ô∏è CACHE_LOAD: AI cache not found');
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: AI cache error:', error);
                updateCacheUI('ai', null, null, 15 * 60, true);
            }
        }

        async function loadESPNCache() {
            try {
                const cacheRef = doc(db, 'cache', 'espn_current_data');
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.generatedAt ? new Date(data.generatedAt) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 6 * 60 * 60;

                    updateCacheUI('espn', created, age, expiry);
                    console.log('‚úÖ CACHE_LOAD: ESPN cache loaded', { age, expiry });
                } else {
                    updateCacheUI('espn', null, null, 6 * 60 * 60);
                    console.log('‚ö†Ô∏è CACHE_LOAD: ESPN cache not found');
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: ESPN cache error:', error);
                updateCacheUI('espn', null, null, 6 * 60 * 60, true);
            }
        }

        async function loadSeasonCache() {
            try {
                const cacheRef = doc(db, 'cache', 'season_leaderboard_2025');
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.generatedAt ? new Date(data.generatedAt) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 5 * 60;

                    updateCacheUI('season', created, age, expiry);
                    console.log('‚úÖ CACHE_LOAD: Season cache loaded', { age, expiry });
                } else {
                    updateCacheUI('season', null, null, 5 * 60);
                    console.log('‚ö†Ô∏è CACHE_LOAD: Season cache not found');
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: Season cache error:', error);
                updateCacheUI('season', null, null, 5 * 60, true);
            }
        }

        async function loadWeeklyCache() {
            try {
                const currentWeek = getCurrentNFLWeek();
                const cacheRef = doc(db, 'cache', `weekly_leaderboard_2025_week_${currentWeek}`);
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.generatedAt ? new Date(data.generatedAt) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 2 * 60;

                    updateCacheUI('weekly', created, age, expiry);
                    console.log('‚úÖ CACHE_LOAD: Weekly cache loaded', { week: currentWeek, age, expiry });
                } else {
                    updateCacheUI('weekly', null, null, 2 * 60);
                    console.log('‚ö†Ô∏è CACHE_LOAD: Weekly cache not found for week', currentWeek);
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: Weekly cache error:', error);
                updateCacheUI('weekly', null, null, 2 * 60, true);
            }
        }

        async function loadSurvivorCache() {
            try {
                const cacheRef = doc(db, 'cache', 'survivor_pool_2025');
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.generatedAt ? new Date(data.generatedAt) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 10;

                    updateCacheUI('survivor', created, age, expiry);
                    console.log('‚úÖ CACHE_LOAD: Survivor cache loaded', { age, expiry });
                } else {
                    updateCacheUI('survivor', null, null, 10);
                    console.log('‚ö†Ô∏è CACHE_LOAD: Survivor cache not found');
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: Survivor cache error:', error);
                updateCacheUI('survivor', null, null, 10, true);
            }
        }

        async function loadGridCache() {
            try {
                const currentWeek = getCurrentNFLWeek();
                document.getElementById('gridWeek').textContent = currentWeek;

                const cachePath = `artifacts/nerdfootball/pools/nerduniverse-2025/cache/grid-week-${currentWeek}`;
                const cacheRef = doc(db, cachePath);
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    const data = cacheSnap.data();
                    const created = data.createdDate ? new Date(data.createdDate) : null;
                    const age = created ? Math.floor((Date.now() - created.getTime()) / 1000) : null;
                    const expiry = 15 * 60;

                    const statusEl = document.getElementById('gridStatus');
                    const statusText = document.getElementById('gridCacheStatus');

                    const isStale = age > expiry;
                    statusEl.className = isStale ? 'status-stale' : 'status-online';
                    statusText.textContent = `Week ${currentWeek} cache: ${created.toLocaleString()} (${formatAge(age)} old)`;

                    console.log('‚úÖ CACHE_LOAD: Grid cache loaded for week', currentWeek, { age, expiry });
                } else {
                    document.getElementById('gridStatus').className = 'status-error';
                    document.getElementById('gridCacheStatus').textContent = `No cache found for week ${currentWeek}`;
                    console.log('‚ö†Ô∏è CACHE_LOAD: Grid cache not found for week', currentWeek);
                }
            } catch (error) {
                console.error('‚ùå CACHE_LOAD: Grid cache error:', error);
                document.getElementById('gridStatus').className = 'status-error';
                document.getElementById('gridCacheStatus').textContent = 'Error loading cache';
            }
        }

        function updateCacheUI(cacheType, created, age, expiry, error = false) {
            const statusEl = document.getElementById(`${cacheType}Status`);
            const ageEl = document.getElementById(`${cacheType}Age`);
            const createdEl = document.getElementById(`${cacheType}Created`);

            if (error) {
                statusEl.className = 'status-error';
                ageEl.textContent = 'ERROR';
                createdEl.textContent = 'Error loading cache';
                return;
            }

            if (!created || age === null) {
                statusEl.className = 'status-error';
                ageEl.textContent = 'NO DATA';
                createdEl.textContent = 'Cache not found';
                return;
            }

            const isStale = age > expiry;
            statusEl.className = isStale ? 'status-stale' : 'status-online';

            ageEl.textContent = formatAge(age);
            createdEl.textContent = created.toLocaleString();
        }

        function formatAge(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
        }

        function getCurrentNFLWeek() {
            const seasonStart = new Date('2025-09-04');
            const now = new Date();
            const diff = now - seasonStart;
            const week = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;
            return Math.max(1, Math.min(18, week));
        }

        window.refreshAICache = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing AI cache...');
            try {
                const response = await fetch('https://nerdfootball.web.app/ai-picks-helper.html');
                if (response.ok) {
                    logTest('‚úÖ CACHE_REFRESH: AI cache refreshed successfully');
                    await loadAICache();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`‚ùå CACHE_REFRESH: AI cache refresh failed - ${error.message}`);
            }
        };

        window.refreshESPNCache = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing ESPN cache...');
            try {
                const response = await fetch('https://us-central1-nerdfootball.cloudfunctions.net/refreshESPNCache');
                const data = await response.json();
                logTest(`‚úÖ CACHE_REFRESH: ESPN cache refreshed - ${JSON.stringify(data)}`);
                await loadESPNCache();
            } catch (error) {
                logTest(`‚ùå CACHE_REFRESH: ESPN cache refresh failed - ${error.message}`);
            }
        };

        window.refreshSeasonCache = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing Season cache...');
            try {
                const cacheBuster = Date.now();
                const response = await fetch(`https://generateseasonleaderboardcache-np7uealtnq-uc.a.run.app?t=${cacheBuster}`);
                const data = await response.json();
                logTest(`‚úÖ CACHE_REFRESH: Season cache refreshed - ${JSON.stringify(data)}`);
                await loadSeasonCache();
            } catch (error) {
                logTest(`‚ùå CACHE_REFRESH: Season cache refresh failed - ${error.message}`);
            }
        };

        window.refreshWeeklyCache = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing Weekly cache...');
            try {
                const week = getCurrentNFLWeek();
                const cacheBuster = Date.now();
                const response = await fetch(`https://generateweeklyleaderboardcache-np7uealtnq-uc.a.run.app?week=${week}&force=true&t=${cacheBuster}`);
                const data = await response.json();
                logTest(`‚úÖ CACHE_REFRESH: Weekly cache refreshed - ${JSON.stringify(data)}`);
                await loadWeeklyCache();
            } catch (error) {
                logTest(`‚ùå CACHE_REFRESH: Weekly cache refresh failed - ${error.message}`);
            }
        };

        window.refreshAllWeeklyCaches = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing ALL weekly caches (Weeks 5-17)...');
            const startWeek = 5;
            const endWeek = 17;
            let successCount = 0;
            let failCount = 0;

            for (let week = startWeek; week <= endWeek; week++) {
                try {
                    logTest(`üîÑ CACHE_REFRESH: Refreshing Week ${week}...`);
                    const cacheBuster = Date.now();
                    const response = await fetch(`https://generateweeklyleaderboardcache-np7uealtnq-uc.a.run.app?week=${week}&force=true&t=${cacheBuster}`);
                    const data = await response.json();
                    logTest(`‚úÖ CACHE_REFRESH: Week ${week} refreshed - ${JSON.stringify(data)}`);
                    successCount++;
                    // Small delay between requests to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    logTest(`‚ùå CACHE_REFRESH: Week ${week} failed - ${error.message}`);
                    failCount++;
                }
            }

            logTest(`üéØ CACHE_REFRESH: Complete! ${successCount} succeeded, ${failCount} failed`);
        };

        window.refreshSurvivorCache = async () => {
            logTest('üîÑ CACHE_REFRESH: Refreshing Survivor cache...');
            try {
                const cacheBuster = Date.now();
                const response = await fetch(`https://getsurvivorpooldata-np7uealtnq-uc.a.run.app?t=${cacheBuster}`);
                const data = await response.json();
                logTest(`‚úÖ CACHE_REFRESH: Survivor cache refreshed - ${JSON.stringify(data)}`);
                await loadSurvivorCache();
            } catch (error) {
                logTest(`‚ùå CACHE_REFRESH: Survivor cache refresh failed - ${error.message}`);
            }
        };

        window.deleteCache = async (cacheType) => {
            if (!confirm(`‚ö†Ô∏è DELETE ${cacheType.toUpperCase()} CACHE?\n\nThis action cannot be undone.`)) {
                return;
            }

            logTest(`üóëÔ∏è CACHE_DELETE: Deleting ${cacheType} cache...`);

            try {
                let cacheRef;
                switch(cacheType) {
                    case 'ai':
                        cacheRef = doc(db, 'artifacts/nerdfootball/pools/nerduniverse-2025/cache', 'latest-ai-intel-sheet');
                        break;
                    case 'espn':
                        cacheRef = doc(db, 'cache', 'espn_current_data');
                        break;
                    case 'season':
                        cacheRef = doc(db, 'cache', 'season_leaderboard_2025');
                        break;
                    case 'weekly':
                        const week = getCurrentNFLWeek();
                        cacheRef = doc(db, 'cache', `weekly_leaderboard_2025_week_${week}`);
                        break;
                    case 'survivor':
                        cacheRef = doc(db, 'cache', 'survivor_pool_2025');
                        break;
                }

                await deleteDoc(cacheRef);
                logTest(`‚úÖ CACHE_DELETE: ${cacheType} cache deleted successfully`);
                await loadAllCaches();
            } catch (error) {
                logTest(`‚ùå CACHE_DELETE: ${cacheType} cache deletion failed - ${error.message}`);
            }
        };

        window.deleteGridCache = async () => {
            const currentWeek = getCurrentNFLWeek();
            if (!confirm(`‚ö†Ô∏è DELETE GRID CACHE FOR WEEK ${currentWeek}?\n\nThis action cannot be undone.`)) {
                return;
            }

            logTest(`üóëÔ∏è GRID_CACHE_DELETE: Deleting grid cache for week ${currentWeek}...`);

            try {
                const cachePath = `artifacts/nerdfootball/pools/nerduniverse-2025/cache/grid-week-${currentWeek}`;
                await deleteDoc(doc(db, cachePath));
                logTest(`‚úÖ GRID_CACHE_DELETE: Week ${currentWeek} cache deleted successfully`);
                await loadGridCache();
            } catch (error) {
                logTest(`‚ùå GRID_CACHE_DELETE: Failed - ${error.message}`);
            }
        };

        window.deleteAllGridCaches = async () => {
            if (!confirm(`‚ö†Ô∏è DELETE ALL GRID CACHES FOR ALL WEEKS?\n\nThis will delete grid caches for weeks 1-18.\nThis action cannot be undone.`)) {
                return;
            }

            logTest(`üóëÔ∏è GRID_CACHE_DELETE_ALL: Deleting all grid caches...`);

            try {
                const deletePromises = [];
                for (let week = 1; week <= 18; week++) {
                    const cachePath = `artifacts/nerdfootball/pools/nerduniverse-2025/cache/grid-week-${week}`;
                    deletePromises.push(deleteDoc(doc(db, cachePath)).catch(() => null));
                }
                await Promise.all(deletePromises);
                logTest(`‚úÖ GRID_CACHE_DELETE_ALL: All grid caches deleted successfully`);
                await loadGridCache();
            } catch (error) {
                logTest(`‚ùå GRID_CACHE_DELETE_ALL: Failed - ${error.message}`);
            }
        };

        window.testEndpoint = async (endpointType) => {
            const endpoints = {
                ai: 'https://nerdfootball.web.app/ai-picks-helper.html',
                season: 'https://generateseasonleaderboardcache-np7uealtnq-uc.a.run.app',
                weekly: `https://generateweeklyleaderboardcache-np7uealtnq-uc.a.run.app?week=${getCurrentNFLWeek()}`,
                survivor: 'https://getsurvivorpooldata-np7uealtnq-uc.a.run.app'
            };

            const url = endpoints[endpointType];
            logTest(`üéØ ENDPOINT_TEST: Testing ${endpointType} - ${url}`);

            const startTime = Date.now();
            try {
                const response = await fetch(url);
                const elapsed = Date.now() - startTime;

                if (response.ok) {
                    logTest(`‚úÖ ENDPOINT_TEST: ${endpointType} - SUCCESS (${elapsed}ms)`);
                } else {
                    logTest(`‚ö†Ô∏è ENDPOINT_TEST: ${endpointType} - HTTP ${response.status} (${elapsed}ms)`);
                }
            } catch (error) {
                const elapsed = Date.now() - startTime;
                logTest(`‚ùå ENDPOINT_TEST: ${endpointType} - FAILED (${elapsed}ms) - ${error.message}`);
            }
        };

        window.refreshAllCaches = async () => {
            logTest('üîÑ CACHE_REFRESH_ALL: Refreshing all caches...');
            await Promise.all([
                refreshAICache(),
                refreshESPNCache(),
                refreshSeasonCache(),
                refreshWeeklyCache(),
                refreshSurvivorCache()
            ]);
            logTest('‚úÖ CACHE_REFRESH_ALL: All caches refreshed');
        };

        function logTest(message) {
            const logEl = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.textContent = `[${timestamp}] ${message}`;
            logEl.insertBefore(line, logEl.firstChild);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        setInterval(() => {
            if (currentUser && ADMIN_UIDS.includes(currentUser.uid)) {
                loadAllCaches();
            }
        }, 30000);

        console.log('üöÄ CACHE_INIT: Straight Cache Homey initialized');
    </script>
</body>
</html>