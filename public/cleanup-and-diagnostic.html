<!DOCTYPE html>
<html>
<head>
    <title>üßπ CLEANUP & DIAGNOSTIC TOOL</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="./js/config/firebase-config-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>üßπ CLEANUP & DIAGNOSTIC TOOL</h1>
    <div style="background: #ffeeee; padding: 20px; border: 2px solid red; margin: 20px 0;">
        <h3>üö® ISSUES TO FIX</h3>
        <p><strong>1. Missing Game Results:</strong> Only 1 game per week has results, should be 16 games</p>
        <p><strong>2. Useless gameDetails:</strong> Remove massive text strings from all scoring documents</p>
        <p><strong>3. Incomplete Scoring:</strong> Users only getting credit for 1 game per week instead of all games</p>
    </div>

    <button onclick="checkResultsData()" style="background: blue; color: white; padding: 15px; margin: 5px;">üîç CHECK RESULTS DATA</button>
    <button onclick="removeGameDetails()" style="background: orange; color: white; padding: 15px; margin: 5px;">üßπ REMOVE gameDetails FROM ALL DOCS</button>
    <button onclick="diagnosticAllWeeks()" style="background: purple; color: white; padding: 15px; margin: 5px;">üìä DIAGNOSTIC ALL WEEKS</button>

    <div id="output"></div>

    <script>
        firebase.initializeApp(window.getFirebaseConfig());
        window.db = firebase.firestore();
        window.auth = firebase.auth();

        async function autoLogin() {
            return new Promise((resolve) => {
                const unsubscribe = window.auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üîì AUTHENTICATED:', user.email);
                        unsubscribe();
                        resolve(user);
                    } else {
                        console.log('üîê NOT AUTHENTICATED - Signing in...');
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await window.auth.signInWithPopup(provider);
                            console.log('‚úÖ SIGNED IN SUCCESSFULLY');
                        } catch (error) {
                            console.error('‚ùå SIGN IN FAILED:', error);
                        }
                    }
                });
            });
        }

        async function checkResultsData() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üîç CHECKING RESULTS DATA...</h2>';

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                output.innerHTML += '<h3>üìä RESULTS DATA ANALYSIS</h3>';
                output.innerHTML += '<table border="1" style="border-collapse: collapse;"><tr><th>Week</th><th>Document Exists</th><th>Games Found</th><th>Game IDs</th><th>Winners Found</th></tr>';

                for (let week = 1; week <= 3; week++) {
                    const resultsPath = `artifacts/nerdfootball/public/data/nerdfootball_results/${week}`;
                    const resultsDoc = await firebase.firestore().doc(resultsPath).get();

                    if (!resultsDoc.exists) {
                        output.innerHTML += `<tr><td>Week ${week}</td><td style="color: red;">‚ùå NO</td><td>0</td><td>-</td><td>0</td></tr>`;
                        continue;
                    }

                    const resultsData = resultsDoc.data();
                    const gameIds = Object.keys(resultsData).filter(key =>
                        key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                    );

                    const gamesWithWinners = gameIds.filter(gameId =>
                        resultsData[gameId] && resultsData[gameId].winner
                    );

                    const gameIdsList = gameIds.slice(0, 5).join(', ') + (gameIds.length > 5 ? '...' : '');

                    output.innerHTML += `
                        <tr>
                            <td>Week ${week}</td>
                            <td style="color: green;">‚úÖ YES</td>
                            <td>${gameIds.length}</td>
                            <td>${gameIdsList}</td>
                            <td>${gamesWithWinners.length}</td>
                        </tr>
                    `;

                    // Show detailed game data for first week
                    if (week === 1) {
                        output.innerHTML += `
                            <tr><td colspan="5">
                                <h4>Week 1 Detailed Data:</h4>
                                <pre style="font-size: 10px; max-height: 200px; overflow: auto;">${JSON.stringify(resultsData, null, 2)}</pre>
                            </td></tr>
                        `;
                    }
                }

                output.innerHTML += '</table>';

                output.innerHTML += `
                    <div style="background: #ffffee; padding: 15px; margin: 20px 0; border: 2px solid orange;">
                        <h3>üìã DIAGNOSIS</h3>
                        <p><strong>Expected:</strong> Each week should have 16 games with winners</p>
                        <p><strong>If games missing:</strong> Need to populate results documents with all game outcomes</p>
                        <p><strong>If winners missing:</strong> Need to update results with actual game winners</p>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå ERROR</h2><p>Error: ${error.message}</p>`;
            }
        }

        async function removeGameDetails() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üßπ REMOVING gameDetails FROM ALL SCORING DOCUMENTS...</h2>';

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                // Get all scoring documents
                const scoringCollectionPath = 'artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users';
                const scoringSnapshot = await firebase.firestore().collection(scoringCollectionPath).get();

                if (scoringSnapshot.empty) {
                    output.innerHTML += '<p>‚ùå NO SCORING DOCUMENTS FOUND!</p>';
                    return;
                }

                output.innerHTML += `<p>üßπ Found ${scoringSnapshot.size} scoring documents to clean</p>`;

                let cleanedCount = 0;
                let errorCount = 0;

                for (const userDoc of scoringSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const displayName = userData.displayName || `User ${userId.slice(-6)}`;

                    try {
                        let needsUpdate = false;
                        const cleanedData = { ...userData };

                        // Remove gameDetails from all weekly data
                        if (cleanedData.weeklyPoints) {
                            for (const [week, weekData] of Object.entries(cleanedData.weeklyPoints)) {
                                if (weekData.gameDetails) {
                                    delete weekData.gameDetails;
                                    needsUpdate = true;
                                }
                            }
                        }

                        // Update document if needed
                        if (needsUpdate) {
                            cleanedData.cleanupApplied = true;
                            cleanedData.cleanupTimestamp = new Date().toISOString();
                            cleanedData.gameDetailsRemoved = true;

                            await firebase.firestore().doc(`${scoringCollectionPath}/${userId}`).set(cleanedData);
                            cleanedCount++;

                            output.innerHTML += `<p style="color: green;">‚úÖ Cleaned ${displayName}</p>`;
                        } else {
                            output.innerHTML += `<p style="color: blue;">‚ÑπÔ∏è ${displayName} already clean</p>`;
                        }

                    } catch (error) {
                        console.error(`‚ùå ERROR cleaning ${displayName}:`, error);
                        output.innerHTML += `<p style="color: red;">‚ùå Error cleaning ${displayName}: ${error.message}</p>`;
                        errorCount++;
                    }
                }

                output.innerHTML += `
                    <hr>
                    <h3>üßπ CLEANUP COMPLETE</h3>
                    <p><strong>Documents Cleaned:</strong> ${cleanedCount}</p>
                    <p><strong>Errors:</strong> ${errorCount}</p>
                    <p><strong>All gameDetails fields have been removed from scoring documents!</strong></p>
                `;

            } catch (error) {
                console.error('‚ùå CLEANUP ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå CLEANUP FAILED</h2><p>Error: ${error.message}</p>`;
            }
        }

        async function diagnosticAllWeeks() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üìä DIAGNOSTIC ALL WEEKS...</h2>';

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                output.innerHTML += '<h3>üìä COMPREHENSIVE DIAGNOSTIC</h3>';

                // Check Tony's specific data
                const TONY_UID = 'WxSPmEildJdqs6T5hIpBUZrscwt2';
                const scoringPath = `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${TONY_UID}`;
                const scoringDoc = await firebase.firestore().doc(scoringPath).get();

                if (scoringDoc.exists) {
                    const scoringData = scoringDoc.data();

                    output.innerHTML += `
                        <div style="background: #eeffee; padding: 15px; margin: 20px 0; border: 2px solid green;">
                            <h4>üéØ TONY'S CURRENT SCORING SUMMARY</h4>
                            <p><strong>Total Points:</strong> ${scoringData.totalPoints}</p>
                            <p><strong>Games Won:</strong> ${scoringData.seasonStats?.gamesWon}</p>
                            <p><strong>Games Played:</strong> ${scoringData.seasonStats?.totalGames}</p>
                            <p><strong>Weeks Played:</strong> ${scoringData.seasonStats?.weeksPlayed}</p>
                        </div>
                    `;

                    output.innerHTML += '<h4>üìÖ WEEKLY BREAKDOWN</h4>';
                    output.innerHTML += '<table border="1" style="border-collapse: collapse;"><tr><th>Week</th><th>Points</th><th>Games Won</th><th>Games Played</th><th>Issues</th></tr>';

                    for (let week = 1; week <= 3; week++) {
                        const weekData = scoringData.weeklyPoints?.[week];
                        const issues = [];

                        if (!weekData) {
                            issues.push('No data');
                        } else {
                            if (weekData.gamesPlayed < 16) {
                                issues.push(`Only ${weekData.gamesPlayed}/16 games played`);
                            }
                            if (weekData.totalPoints && weekData.gamesWon === 1) {
                                issues.push('Only 1 game won - likely missing results');
                            }
                        }

                        const issueText = issues.length > 0 ? issues.join('; ') : '‚úÖ OK';
                        const issueColor = issues.length > 0 ? 'red' : 'green';

                        output.innerHTML += `
                            <tr>
                                <td>Week ${week}</td>
                                <td>${weekData?.totalPoints || 0}</td>
                                <td>${weekData?.gamesWon || 0}</td>
                                <td>${weekData?.gamesPlayed || 0}</td>
                                <td style="color: ${issueColor};">${issueText}</td>
                            </tr>
                        `;
                    }

                    output.innerHTML += '</table>';
                }

                // Check a few picks documents to see what's available
                output.innerHTML += '<h4>üìã SAMPLE PICKS DATA</h4>';
                for (let week = 1; week <= 3; week++) {
                    const picksPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${week}/submissions/${TONY_UID}`;
                    const picksDoc = await firebase.firestore().doc(picksPath).get();

                    if (picksDoc.exists) {
                        const picksData = picksDoc.data();
                        const pickCount = Object.keys(picksData).filter(key =>
                            key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                        ).length;

                        output.innerHTML += `<p>Week ${week}: ${pickCount} picks found ‚úÖ</p>`;
                    } else {
                        output.innerHTML += `<p>Week ${week}: No picks found ‚ùå</p>`;
                    }
                }

                output.innerHTML += `
                    <div style="background: #ffeeee; padding: 15px; margin: 20px 0; border: 2px solid red;">
                        <h3>üö® NEXT STEPS NEEDED</h3>
                        <ol>
                            <li><strong>Fix Results Data:</strong> Populate all 16 games per week with winners</li>
                            <li><strong>Re-run Scoring:</strong> Recalculate all users with complete results</li>
                            <li><strong>Remove gameDetails:</strong> Clean up unnecessary data from documents</li>
                            <li><strong>Verify Accuracy:</strong> Ensure all picks get proper credit</li>
                        </ol>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå DIAGNOSTIC ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå DIAGNOSTIC FAILED</h2><p>Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>