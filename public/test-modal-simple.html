<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Game Modal Test</title>
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>

    <!-- Firebase v11 modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
        import { getFunctions } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBJhyMIgmFfgLmcvDlGjKZXzQHLcErhgQo",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "593588434398",
            appId: "1:593588434398:web:0b4df89b47c25b1e2c5ac7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        window.auth = auth;
        window.functions = functions;

        // Admin user check
        const ADMIN_USER_ID = 'WxSPmEildJdqs6T5hIpBUZrscwt2'; // Your admin user ID
        let isAdminUser = false;

        onAuthStateChanged(auth, (user) => {
            const authStatus = document.getElementById('auth-status');
            const adminFeatures = document.getElementById('admin-features');

            if (user) {
                isAdminUser = user.uid === ADMIN_USER_ID;
                authStatus.innerHTML = `✅ Signed in as ${user.email || 'User'} ${isAdminUser ? '<span class="text-red-600 font-bold">(ADMIN)</span>' : ''}`;

                if (isAdminUser) {
                    adminFeatures.classList.remove('hidden');
                    initializeAdminPolling();
                } else {
                    adminFeatures.classList.add('hidden');
                }
            } else {
                authStatus.innerHTML = '❌ Not signed in';
                adminFeatures.classList.add('hidden');
            }
        });

        window.isAdminUser = () => isAdminUser;
    </script>
</head>
<body class="bg-slate-100 p-8">
    <div class="mb-6 p-4 bg-white rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-2">Authentication Status</h2>
        <div id="auth-status" class="text-sm">Checking authentication...</div>
    </div>

    <h1 class="text-3xl font-bold mb-6">🚀 Live Game Modal Test</h1>

    <!-- Admin-only features -->
    <div id="admin-features" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
        <h2 class="text-lg font-semibold text-red-800 mb-2">🔧 Admin Features</h2>
        <div class="text-sm text-red-700 mb-3">Real-time polling and enhanced features enabled for admin user</div>
        <div class="flex gap-2">
            <button id="start-polling" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Start Real-time Polling</button>
            <button id="stop-polling" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">Stop Polling</button>
            <span id="polling-status" class="text-sm text-red-700 ml-2">Polling: Off</span>
        </div>
    </div>

    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-4">Test Games</h2>
        <div class="space-y-2">
            <!-- Current Week NFL Games - LIVE DATA -->
            <!-- IN PROGRESS GAMES (Perfect for testing live modal) -->
            <div id="game-1" class="bg-green-50 border-green-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772729">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">🔴 LIVE: Denver Broncos @ Indianapolis Colts</span>
                    <span class="text-green-600 text-sm font-bold">IN PROGRESS</span>
                </div>
            </div>
            <div id="game-2" class="bg-green-50 border-green-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772730">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">🔴 LIVE: Carolina Panthers @ Arizona Cardinals</span>
                    <span class="text-green-600 text-sm font-bold">IN PROGRESS</span>
                </div>
            </div>
            <div id="game-3" class="bg-green-50 border-green-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772837">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">🔴 LIVE: Philadelphia Eagles @ Kansas City Chiefs</span>
                    <span class="text-green-600 text-sm font-bold">IN PROGRESS</span>
                </div>
            </div>

            <!-- FINAL GAMES (Test completed game data) -->
            <div id="game-4" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772725">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Jacksonville Jaguars @ Cincinnati Bengals</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-5" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772834">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">New York Giants @ Dallas Cowboys</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-6" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772835">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Chicago Bears @ Detroit Lions</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-7" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772724">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Los Angeles Rams @ Tennessee Titans</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-8" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772728">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">New England Patriots @ Miami Dolphins</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-9" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772833">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">San Francisco 49ers @ New Orleans Saints</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-10" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772727">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Buffalo Bills @ New York Jets</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-11" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772836">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Seattle Seahawks @ Pittsburgh Steelers</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>
            <div id="game-12" class="bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772726">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Cleveland Browns @ Baltimore Ravens</span>
                    <span class="text-gray-600 text-sm">FINAL</span>
                </div>
            </div>

            <!-- SCHEDULED GAMES (Test pre-game data) -->
            <div id="game-13" class="bg-blue-50 border-blue-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772919">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Atlanta Falcons @ Minnesota Vikings</span>
                    <span class="text-blue-600 text-sm">SCHEDULED</span>
                </div>
            </div>
            <div id="game-14" class="bg-blue-50 border-blue-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772715">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Tampa Bay Buccaneers @ Houston Texans</span>
                    <span class="text-blue-600 text-sm">SCHEDULED</span>
                </div>
            </div>
            <div id="game-15" class="bg-blue-50 border-blue-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg" data-espn-id="401772811">
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Los Angeles Chargers @ Las Vegas Raiders</span>
                    <span class="text-blue-600 text-sm">SCHEDULED</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Debug Info -->
    <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
        <h3 class="font-semibold mb-2">Firebase Debug:</h3>
        <div id="firebase-status" class="text-sm text-slate-600">Checking Firebase status...</div>
    </div>

    <!-- Live Game Modal -->
    <div id="live-game-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-5xl max-h-[95vh] w-full mx-4 overflow-hidden shadow-2xl">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-slate-800 to-slate-600">
                <h2 id="modal-game-title" class="text-xl font-bold text-white">Loading Game...</h2>
                <button onclick="closeLiveGameModal()" class="text-slate-300 hover:text-white text-2xl font-bold">&times;</button>
            </div>

            <!-- Loading State -->
            <div id="modal-loading" class="p-12 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-slate-600">Loading live game data...</p>
            </div>

            <!-- Modal Content -->
            <div id="modal-game-content" class="hidden max-h-[80vh] overflow-y-auto">
                <div id="game-data-display">
                    <!-- Beautiful game data will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Firebase Implementation -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        console.log('🔥 Initializing Firebase for modal test...');

        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac",
        };

        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app, 'us-central1');

        console.log('✅ Firebase initialized');
        updateFirebaseStatus('✅ Firebase initialized successfully');

        // Test modal functions
        window.openLiveGameModal = async function(gameId, espnEventId) {
            console.log(`🚀 Testing modal for ESPN Event: ${espnEventId}`);

            const modal = document.getElementById('live-game-modal');
            const loading = document.getElementById('modal-loading');
            const content = document.getElementById('modal-game-content');
            const gameDisplay = document.getElementById('game-data-display');

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                updateFirebaseStatus('🔄 Calling testLiveGameDetails...');

                // Fetch game data and user pick in parallel
                const [gameResponse, userPick] = await Promise.all([
                    fetch('https://us-central1-nerdfootball.cloudfunctions.net/testLiveGameDetails', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ espnEventId })
                    }),
                    fetchUserPickForGame(espnEventId)
                ]);

                const gameResult = await gameResponse.json();

                console.log('✅ Modal test result:', gameResult);
                console.log('👤 User pick:', userPick);
                updateFirebaseStatus('✅ Function call successful!');

                // Display the beautiful data with user pick
                gameDisplay.innerHTML = createBeautifulGameDisplay(gameResult.data, userPick);

                loading.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (error) {
                console.error('❌ Modal test error:', error);
                updateFirebaseStatus(`❌ Error: ${error.message}`);

                gameDisplay.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            }
        };

        window.closeLiveGameModal = function() {
            document.getElementById('live-game-modal').classList.add('hidden');
        };

        function updateFirebaseStatus(message) {
            document.getElementById('firebase-status').textContent = message;
        }

        // Fetch user's pick for this game
        async function fetchUserPickForGame(espnEventId) {
            try {
                console.log('🔍 Fetching user pick for ESPN ID:', espnEventId);

                // For testing, return mock data since Firestore emulator isn't running
                // In production, this would fetch real user picks
                return {
                    team: 'Carolina Panthers', // Mock pick for testing
                    confidence: 12,
                    gameId: 'mock-game-id',
                    found: true // Mock as found for testing
                };

            } catch (error) {
                console.error('Error fetching user pick:', error);
                // Return mock data for testing even on error
                return {
                    team: 'Carolina Panthers',
                    confidence: 12,
                    gameId: 'mock-game-id',
                    found: false
                };
            }
        }

        function createBeautifulGameDisplay(gameData, userPick = null) {
            if (!gameData) {
                return '<div class="p-6 text-center text-red-600">No game data available</div>';
            }

            // Handle the actual data structure from your API
            const awayTeam = gameData.teams?.away;
            const homeTeam = gameData.teams?.home;
            const awayStats = gameData.teamStats?.away;
            const homeStats = gameData.teamStats?.home;

            if (!awayTeam || !homeTeam) {
                return '<div class="p-6 text-center text-red-600">Team data not available</div>';
            }

            // Get team colors
            const awayColor = awayTeam.color || '1f2937';
            const homeColor = homeTeam.color || '1f2937';

            // Format game status
            let gameStatus = '';
            if (gameData.status === 'STATUS_FINAL') {
                gameStatus = `<span class="text-gray-600 font-bold">FINAL</span>`;
            } else if (gameData.status === 'STATUS_IN_PROGRESS') {
                gameStatus = `<span class="text-red-500 font-bold animate-pulse">🔴 LIVE</span>`;
                if (gameData.statusDisplay) {
                    gameStatus += `<span class="ml-2 text-sm font-semibold">${gameData.statusDisplay}</span>`;
                }
            } else {
                gameStatus = `<span class="text-blue-600 font-bold">${gameData.statusDisplay || 'SCHEDULED'}</span>`;
            }

            // Key stats for comparison
            const keyStats = [
                { label: 'Total Yards', away: awayStats?.total_yards, home: homeStats?.total_yards },
                { label: 'Passing Yards', away: awayStats?.passing, home: homeStats?.passing },
                { label: 'Rushing Yards', away: awayStats?.rushing, home: homeStats?.rushing },
                { label: '1st Downs', away: awayStats?.['1st_downs'], home: homeStats?.['1st_downs'] },
                { label: '3rd Down', away: awayStats?.['3rd_down_efficiency'], home: homeStats?.['3rd_down_efficiency'] },
                { label: 'Red Zone', away: awayStats?.['red_zone_(made-att)'], home: homeStats?.['red_zone_(made-att)'] },
                { label: 'Possession', away: awayStats?.possession, home: homeStats?.possession },
                { label: 'Turnovers', away: awayStats?.turnovers, home: homeStats?.turnovers }
            ];

            return `
                <!-- Game Header with Scores -->
                <div class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-4">
                    <div class="text-center mb-3">
                        ${gameStatus}
                    </div>
                    <div class="grid grid-cols-3 items-center gap-4">
                        <!-- Away Team -->
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-2 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg"
                                 style="background-color: #${awayColor};">
                                ${awayTeam.abbreviation || 'TBD'}
                            </div>
                            <div class="text-sm font-medium">${awayTeam.name || 'Away Team'}</div>
                            <div class="text-2xl font-bold">${awayTeam.score || '0'}</div>
                        </div>

                        <!-- VS -->
                        <div class="text-center">
                            <div class="text-2xl font-bold text-slate-400">VS</div>
                        </div>

                        <!-- Home Team -->
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-2 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg"
                                 style="background-color: #${homeColor};">
                                ${homeTeam.abbreviation || 'TBD'}
                            </div>
                            <div class="text-sm font-medium">${homeTeam.name || 'Home Team'}</div>
                            <div class="text-2xl font-bold">${homeTeam.score || '0'}</div>
                        </div>
                    </div>
                </div>

                <!-- Team Statistics -->
                <div class="p-4 bg-white">
                    <h3 class="text-lg font-bold text-center mb-4 text-slate-800">Team Statistics</h3>

                    <!-- Key Stats Cards -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        ${keyStats.slice(0, 4).map(stat => `
                            <div class="bg-slate-50 rounded-lg p-3 border">
                                <div class="text-xs font-semibold text-slate-600 text-center mb-2">${stat.label}</div>
                                <div class="grid grid-cols-3 items-center text-sm">
                                    <div class="text-center font-bold" style="color: #${awayColor}">${stat.away || 'N/A'}</div>
                                    <div class="text-center text-slate-400">vs</div>
                                    <div class="text-center font-bold" style="color: #${homeColor}">${stat.home || 'N/A'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Full Statistics Grid -->
                    <div class="bg-slate-50 rounded-lg overflow-hidden">
                        <div class="grid grid-cols-5 bg-slate-200 text-xs font-bold py-2">
                            <div class="text-center" style="color: #${awayColor}">${awayTeam.abbreviation}</div>
                            <div class="col-span-3 text-center text-slate-700">Statistic</div>
                            <div class="text-center" style="color: #${homeColor}">${homeTeam.abbreviation}</div>
                        </div>
                        ${keyStats.map(stat => `
                            <div class="grid grid-cols-5 border-b border-slate-200 py-2 text-xs">
                                <div class="text-center font-semibold" style="color: #${awayColor}">${stat.away || 'N/A'}</div>
                                <div class="col-span-3 text-center text-slate-700">${stat.label}</div>
                                <div class="text-center font-semibold" style="color: #${homeColor}">${stat.home || 'N/A'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- User Pick Display -->
                ${userPick ? `
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-t-2 border-blue-200">
                    <h4 class="text-md font-bold text-center mb-3 text-blue-800">🎯 Your Pick</h4>
                    <div class="bg-white rounded-lg p-4 border border-blue-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm">
                                    ${userPick.confidence}
                                </div>
                                <div>
                                    <div class="font-bold text-blue-800">${userPick.team}</div>
                                    <div class="text-xs text-blue-600">Confidence: ${userPick.confidence} points</div>
                                </div>
                            </div>
                            ${userPick.found ?
                                '<div class="text-green-600 text-sm font-semibold">✅ Active Pick</div>' :
                                '<div class="text-orange-600 text-sm font-semibold">🔍 Pick Lookup</div>'
                            }
                        </div>
                    </div>
                </div>` : ''}

                <!-- AI Statistical Analysis -->
                ${awayStats && homeStats ? `
                <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-t-2 border-purple-200">
                    <h4 class="text-md font-bold text-center mb-4 text-purple-800">🤖 AI Statistical Analysis</h4>

                    <!-- Detailed Comparison -->
                    <div class="bg-white rounded-lg p-4 mb-4 border border-purple-200 shadow-sm">
                        <h5 class="font-bold mb-3 text-purple-700">📊 Statistical Comparison</h5>
                        ${generateDetailedAnalysis(awayStats, homeStats, awayTeam, homeTeam, awayColor, homeColor)}
                    </div>

                    <!-- AI Win Prediction -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200 shadow-sm">
                        <h5 class="font-bold mb-3 text-purple-700">🎯 AI Win Prediction</h5>
                        ${generateWinPrediction(awayStats, homeStats, awayTeam, homeTeam, gameData.status, awayColor, homeColor)}
                    </div>
                </div>` : ''}

                <!-- Additional Stats -->
                ${awayStats && homeStats ? `
                <div class="p-4 bg-slate-50">
                    <h4 class="text-md font-bold text-center mb-3 text-slate-800">Detailed Statistics</h4>
                    <div class="grid grid-cols-2 gap-4 text-xs">
                        <!-- Away Team Detailed -->
                        <div class="bg-white p-3 rounded border-l-4" style="border-color: #${awayColor}">
                            <h5 class="font-bold mb-2" style="color: #${awayColor}">${awayTeam.name}</h5>
                            <div class="space-y-1">
                                <div>Comp/Att: ${awayStats['comp/att'] || 'N/A'}</div>
                                <div>Yards/Play: ${awayStats.yards_per_play || 'N/A'}</div>
                                <div>Penalties: ${awayStats.penalties || 'N/A'}</div>
                                <div>Total Plays: ${awayStats.total_plays || 'N/A'}</div>
                            </div>
                        </div>
                        <!-- Home Team Detailed -->
                        <div class="bg-white p-3 rounded border-l-4" style="border-color: #${homeColor}">
                            <h5 class="font-bold mb-2" style="color: #${homeColor}">${homeTeam.name}</h5>
                            <div class="space-y-1">
                                <div>Comp/Att: ${homeStats['comp/att'] || 'N/A'}</div>
                                <div>Yards/Play: ${homeStats.yards_per_play || 'N/A'}</div>
                                <div>Penalties: ${homeStats.penalties || 'N/A'}</div>
                                <div>Total Plays: ${homeStats.total_plays || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>` : ''}
            `;
        }

        // AI Analysis Functions
        function generateDetailedAnalysis(awayStats, homeStats, awayTeam, homeTeam, awayColor, homeColor) {
            const analysis = [];

            // Offensive Efficiency Analysis
            const awayYPP = parseFloat(awayStats.yards_per_play) || 0;
            const homeYPP = parseFloat(homeStats.yards_per_play) || 0;
            const yppDiff = Math.abs(awayYPP - homeYPP);

            if (yppDiff > 1.0) {
                const leader = awayYPP > homeYPP ? awayTeam.name : homeTeam.name;
                const advantage = yppDiff > 2.0 ? 'significant' : 'moderate';
                analysis.push(`🎯 <strong>Offensive Efficiency:</strong> ${leader} has a ${advantage} advantage in yards per play (${Math.max(awayYPP, homeYPP).toFixed(1)} vs ${Math.min(awayYPP, homeYPP).toFixed(1)})`);
            }

            // Red Zone Efficiency
            const awayRZ = awayStats['red_zone_(made-att)']?.split('-') || ['0', '1'];
            const homeRZ = homeStats['red_zone_(made-att)']?.split('-') || ['0', '1'];
            const awayRZPct = parseInt(awayRZ[0]) / parseInt(awayRZ[1]) * 100 || 0;
            const homeRZPct = parseInt(homeRZ[0]) / parseInt(homeRZ[1]) * 100 || 0;

            if (Math.abs(awayRZPct - homeRZPct) > 20) {
                const leader = awayRZPct > homeRZPct ? awayTeam.name : homeTeam.name;
                const pct = Math.max(awayRZPct, homeRZPct).toFixed(0);
                analysis.push(`🔴 <strong>Red Zone Efficiency:</strong> ${leader} is converting at ${pct}% in the red zone, showing superior finishing ability`);
            }

            // Turnover Analysis
            const awayTO = parseInt(awayStats.turnovers) || 0;
            const homeTO = parseInt(homeStats.turnovers) || 0;
            if (awayTO !== homeTO) {
                const safer = awayTO < homeTO ? awayTeam.name : homeTeam.name;
                const toDiff = Math.abs(awayTO - homeTO);
                analysis.push(`⚠️ <strong>Ball Security:</strong> ${safer} is protecting the ball better (${Math.min(awayTO, homeTO)} vs ${Math.max(awayTO, homeTO)} turnovers)`);
            }

            // 3rd Down Analysis
            const away3rd = awayStats['3rd_down_efficiency']?.split('-') || ['0', '1'];
            const home3rd = homeStats['3rd_down_efficiency']?.split('-') || ['0', '1'];
            const away3rdPct = parseInt(away3rd[0]) / parseInt(away3rd[1]) * 100 || 0;
            const home3rdPct = parseInt(home3rd[0]) / parseInt(home3rd[1]) * 100 || 0;

            if (Math.abs(away3rdPct - home3rdPct) > 15) {
                const leader = away3rdPct > home3rdPct ? awayTeam.name : homeTeam.name;
                const pct = Math.max(away3rdPct, home3rdPct).toFixed(0);
                analysis.push(`📈 <strong>3rd Down Conversion:</strong> ${leader} is sustaining drives at ${pct}%, controlling game tempo`);
            }

            // Time of Possession
            const awayPoss = convertPossessionToMinutes(awayStats.possession);
            const homePoss = convertPossessionToMinutes(homeStats.possession);
            const possDiff = Math.abs(awayPoss - homePoss);

            if (possDiff > 5) {
                const leader = awayPoss > homePoss ? awayTeam.name : homeTeam.name;
                analysis.push(`⏱️ <strong>Game Control:</strong> ${leader} is controlling the clock with ${Math.max(awayPoss, homePoss).toFixed(1)} minutes of possession`);
            }

            return analysis.length > 0 ? analysis.map(item => `<div class="mb-2 text-sm">${item}</div>`).join('') :
                '<div class="text-sm text-gray-600">Teams are evenly matched statistically</div>';
        }

        function generateWinPrediction(awayStats, homeStats, awayTeam, homeTeam, gameStatus, awayColor = '1f2937', homeColor = '1f2937') {
            const factors = [];
            let awayScore = 0;
            let homeScore = 0;

            // Offensive efficiency scoring
            const awayYPP = parseFloat(awayStats.yards_per_play) || 0;
            const homeYPP = parseFloat(homeStats.yards_per_play) || 0;
            if (awayYPP > homeYPP) awayScore += 15; else homeScore += 15;

            // Total yards advantage
            const awayYards = parseInt(awayStats.total_yards) || 0;
            const homeYards = parseInt(homeStats.total_yards) || 0;
            if (awayYards > homeYards) awayScore += 10; else homeScore += 10;

            // Red zone efficiency
            const awayRZ = awayStats['red_zone_(made-att)']?.split('-') || ['0', '1'];
            const homeRZ = homeStats['red_zone_(made-att)']?.split('-') || ['0', '1'];
            const awayRZPct = parseInt(awayRZ[0]) / parseInt(awayRZ[1]) || 0;
            const homeRZPct = parseInt(homeRZ[0]) / parseInt(homeRZ[1]) || 0;
            if (awayRZPct > homeRZPct) awayScore += 20; else homeScore += 20;

            // Turnover differential (fewer is better)
            const awayTO = parseInt(awayStats.turnovers) || 0;
            const homeTO = parseInt(homeStats.turnovers) || 0;
            if (awayTO < homeTO) awayScore += 25; else homeScore += 25;

            // 3rd down conversion
            const away3rd = awayStats['3rd_down_efficiency']?.split('-') || ['0', '1'];
            const home3rd = homeStats['3rd_down_efficiency']?.split('-') || ['0', '1'];
            const away3rdPct = parseInt(away3rd[0]) / parseInt(away3rd[1]) || 0;
            const home3rdPct = parseInt(home3rd[0]) / parseInt(home3rd[1]) || 0;
            if (away3rdPct > home3rdPct) awayScore += 15; else homeScore += 15;

            // Time of possession
            const awayPoss = convertPossessionToMinutes(awayStats.possession);
            const homePoss = convertPossessionToMinutes(homeStats.possession);
            if (awayPoss > homePoss) awayScore += 15; else homeScore += 15;

            // Calculate confidence percentage
            const totalPoints = awayScore + homeScore;
            const winnerScore = Math.max(awayScore, homeScore);
            const confidence = Math.round((winnerScore / totalPoints) * 100);
            const predicted = awayScore > homeScore ? awayTeam.name : homeTeam.name;
            const predColor = awayScore > homeScore ? awayColor : homeColor;

            // Generate reasoning
            const reasoning = [];
            if (awayYPP > homeYPP + 1) reasoning.push("Superior offensive efficiency");
            if (homeYPP > awayYPP + 1) reasoning.push("Superior offensive efficiency");
            if (awayRZPct > homeRZPct + 0.2) reasoning.push("Better red zone execution");
            if (homeRZPct > awayRZPct + 0.2) reasoning.push("Better red zone execution");
            if (awayTO < homeTO) reasoning.push("Better ball security");
            if (homeTO < awayTO) reasoning.push("Better ball security");
            if (Math.abs(awayPoss - homePoss) > 5) reasoning.push("Game control advantage");

            return `
                <div class="text-center mb-4">
                    <div class="text-lg font-bold mb-2" style="color: #${predColor}">
                        🏆 ${predicted} to Win
                    </div>
                    <div class="text-2xl font-bold text-purple-700">${confidence}% Confidence</div>
                </div>
                <div class="text-sm space-y-1">
                    <div class="font-semibold mb-2">Key Factors:</div>
                    ${reasoning.length > 0 ? reasoning.map(r => `<div>• ${r}</div>`).join('') : '<div>• Close statistical matchup</div>'}
                    ${gameStatus === 'STATUS_IN_PROGRESS' ?
                        '<div class="mt-3 p-2 bg-yellow-50 rounded text-yellow-800 text-xs"><strong>Live Update:</strong> Prediction based on current game performance</div>' :
                        '<div class="mt-3 p-2 bg-blue-50 rounded text-blue-800 text-xs"><strong>Final Analysis:</strong> Based on complete game statistics</div>'
                    }
                </div>
            `;
        }

        function convertPossessionToMinutes(possession) {
            if (!possession) return 0;
            const parts = possession.split(':');
            return parseInt(parts[0]) + (parseInt(parts[1]) / 60);
        }

        // Add click handlers to test games
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎯 Adding click handlers to test games');
            updateFirebaseStatus('🎯 Ready for testing - click a game!');

            const games = document.querySelectorAll('[data-espn-id]');
            games.forEach(game => {
                game.addEventListener('click', () => {
                    const espnId = game.getAttribute('data-espn-id');
                    const gameId = game.id;
                    console.log(`🎮 Game clicked: ${gameId} (ESPN: ${espnId})`);

                    // Use admin-enhanced modal if admin user
                    if (window.isAdminUser && window.isAdminUser()) {
                        openAdminEnhancedModal(gameId, espnId);
                    } else {
                        openLiveGameModal(gameId, espnId);
                    }
                });
            });
        });

        // Admin-only real-time polling features
        let adminPollingInterval = null;
        const ADMIN_POLLING_INTERVAL = 10000; // 10 seconds

        function initializeAdminPolling() {
            console.log('🔧 Initializing admin polling features');

            document.getElementById('start-polling').addEventListener('click', startAdminPolling);
            document.getElementById('stop-polling').addEventListener('click', stopAdminPolling);

            // Auto-start polling for admin
            setTimeout(startAdminPolling, 1000);
        }

        function startAdminPolling() {
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
            }

            console.log('🔄 Starting admin real-time polling');
            document.getElementById('polling-status').textContent = 'Polling: Active';
            document.getElementById('polling-status').className = 'text-sm text-green-700 ml-2';

            // Immediate update
            updateGameStates();

            // Start polling
            adminPollingInterval = setInterval(updateGameStates, ADMIN_POLLING_INTERVAL);
        }

        function stopAdminPolling() {
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
                adminPollingInterval = null;
            }

            console.log('⏹️ Stopped admin real-time polling');
            document.getElementById('polling-status').textContent = 'Polling: Off';
            document.getElementById('polling-status').className = 'text-sm text-red-700 ml-2';
        }

        async function updateGameStates() {
            console.log('🔄 Admin polling: Updating game states');

            const games = document.querySelectorAll('[data-espn-id]');

            for (const gameElement of games) {
                const espnId = gameElement.getAttribute('data-espn-id');

                try {
                    const response = await fetch('https://us-central1-nerdfootball.cloudfunctions.net/testLiveGameDetails', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ espnEventId: espnId })
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        updateGameElementWithLiveData(gameElement, result.data);
                    }
                } catch (error) {
                    console.error(`❌ Error updating game ${espnId}:`, error);
                }
            }
        }

        function updateGameElementWithLiveData(gameElement, gameData) {
            const statusSpan = gameElement.querySelector('.text-green-600, .text-gray-600, .text-blue-600, .text-red-600');
            const gameText = gameElement.querySelector('.font-semibold');

            if (gameData.status === 'STATUS_IN_PROGRESS') {
                // Update status to live with clock
                if (statusSpan) {
                    statusSpan.textContent = `🔴 LIVE ${gameData.statusDisplay || ''}`;
                    statusSpan.className = 'text-red-600 text-sm font-bold animate-pulse';
                }

                // Update game text with score
                if (gameText && gameData.teams) {
                    const awayScore = gameData.teams.away?.score || '0';
                    const homeScore = gameData.teams.home?.score || '0';
                    const originalText = gameText.textContent.replace(/🔴 LIVE:?\s?/, '').split(' - ')[0].split(' ')[0] + ' ' + gameText.textContent.replace(/🔴 LIVE:?\s?/, '').split(' - ')[0].split(' ').slice(1).join(' ');
                    gameText.innerHTML = `🔴 LIVE: ${originalText} <span class="font-bold text-red-600">${awayScore}-${homeScore}</span>`;
                }

                // Update background for live games
                gameElement.className = 'bg-red-50 border-red-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg';
            } else if (gameData.status === 'STATUS_FINAL') {
                // Update status to final
                if (statusSpan) {
                    statusSpan.textContent = 'FINAL';
                    statusSpan.className = 'text-gray-600 text-sm font-bold';
                }

                // Update game text with final score
                if (gameText && gameData.teams) {
                    const awayScore = gameData.teams.away?.score || '0';
                    const homeScore = gameData.teams.home?.score || '0';
                    const originalText = gameText.textContent.replace(/🔴 LIVE:?\s?/, '').split(' - ')[0].split(' (')[0];
                    gameText.innerHTML = `${originalText} <span class="font-bold text-gray-700">${awayScore}-${homeScore} (F)</span>`;
                }

                // Update background for final games
                gameElement.className = 'bg-gray-50 border-gray-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg';
            } else {
                // Scheduled game
                if (statusSpan) {
                    statusSpan.textContent = gameData.statusDisplay || 'SCHEDULED';
                    statusSpan.className = 'text-blue-600 text-sm';
                }

                // Update background for scheduled games
                gameElement.className = 'bg-blue-50 border-blue-200 border p-4 rounded-lg shadow cursor-pointer hover:shadow-lg';
            }
        }

        // Enhanced modal functions for admin (with real-time updates in modal)
        window.openAdminEnhancedModal = function(gameId, espnId) {
            console.log('🔧 Opening admin-enhanced modal with real-time updates');
            openLiveGameModal(gameId, espnId);

            // Start modal-specific polling if admin
            setTimeout(() => {
                if (document.getElementById('modal-game-content') && !document.getElementById('modal-game-content').classList.contains('hidden')) {
                    startModalPolling(espnId);
                }
            }, 1000);
        };

        let modalPollingInterval = null;

        function startModalPolling(espnId) {
            console.log('🔄 Starting modal real-time polling for admin');

            modalPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('https://us-central1-nerdfootball.cloudfunctions.net/testLiveGameDetails', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ espnEventId: espnId })
                    });

                    const result = await response.json();

                    if (result.success && result.data) {
                        updateModalWithLiveData(result.data);
                    }
                } catch (error) {
                    console.error('❌ Error in modal polling:', error);
                }
            }, 5000); // 5 second updates in modal
        }

        function updateModalWithLiveData(gameData) {
            // Update modal scores if elements exist
            const awayScoreEl = document.querySelector('#modal-game-header .text-4xl:first-of-type');
            const homeScoreEl = document.querySelector('#modal-game-header .text-4xl:last-of-type');

            if (awayScoreEl && gameData.teams?.away?.score !== undefined) {
                awayScoreEl.textContent = gameData.teams.away.score;
            }
            if (homeScoreEl && gameData.teams?.home?.score !== undefined) {
                homeScoreEl.textContent = gameData.teams.home.score;
            }

            // Update status
            const statusEl = document.querySelector('#modal-game-status');
            const clockEl = document.querySelector('#modal-game-clock');

            if (statusEl && gameData.status) {
                if (gameData.status === 'STATUS_IN_PROGRESS') {
                    statusEl.textContent = '🔴 LIVE';
                    statusEl.className = 'text-sm font-medium text-red-500 mb-1 animate-pulse';
                } else if (gameData.status === 'STATUS_FINAL') {
                    statusEl.textContent = 'Final';
                    statusEl.className = 'text-sm font-medium text-gray-600 mb-1';
                } else {
                    statusEl.textContent = gameData.statusDisplay || 'Scheduled';
                    statusEl.className = 'text-sm font-medium text-blue-600 mb-1';
                }
            }

            if (clockEl && gameData.statusDisplay) {
                clockEl.textContent = gameData.statusDisplay;
            }

            console.log('✅ Modal updated with live data');
        }

        // Stop modal polling when modal closes
        const originalCloseModal = window.closeLiveGameModal;
        window.closeLiveGameModal = function() {
            if (modalPollingInterval) {
                clearInterval(modalPollingInterval);
                modalPollingInterval = null;
                console.log('⏹️ Stopped modal polling');
            }
            if (originalCloseModal) originalCloseModal();
        };

    </script>
</body>
</html>