<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Week 4 Data Corruption</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff41;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border: 2px solid #00ff41;
            border-radius: 10px;
        }
        h1 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 30px;
        }
        .button {
            background: linear-gradient(145deg, #000 0%, #1a1a1a 100%);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 15px 30px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .button:hover {
            background: linear-gradient(145deg, #1a1a1a 0%, #333 100%);
            color: #fff;
        }
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .log {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Week 4 Data Corruption</h1>

        <div>
            <button class="button" onclick="analyzeWeek4()">üìä Analyze Week 4 Data</button>
            <button class="button" onclick="clearWeek4Data()">üßπ Clear Corrupted Week 4 Data</button>
            <button class="button" onclick="regenerateWeek4()">‚ö° Regenerate Week 4 Scores</button>
            <button class="button" onclick="verifyFix()">‚úÖ Verify Fix</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteField } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteField = deleteField;
        window.auth = auth;

        // Wait for auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`‚úÖ Authenticated as: ${user.email}`, 'success');
            } else {
                log('‚ùå Not authenticated - please sign in first', 'error');
            }
        });
    </script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function analyzeWeek4() {
            log('üîç Analyzing Week 4 data corruption...', 'info');

            try {
                // Get pool members
                const membersRef = window.doc(window.db, 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members');
                const membersSnap = await window.getDoc(membersRef);

                if (!membersSnap.exists()) {
                    log('‚ùå Pool members not found', 'error');
                    return;
                }

                const members = membersSnap.data();
                const userIds = Object.keys(members);
                log(`üìä Found ${userIds.length} pool members`, 'info');

                let corruptedUsers = 0;
                let impossibleScores = [];

                for (const userId of userIds.slice(0, 10)) { // Check first 10 users
                    try {
                        const scoringRef = window.doc(window.db, `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`);
                        const scoringSnap = await window.getDoc(scoringRef);

                        if (scoringSnap.exists()) {
                            const data = scoringSnap.data();
                            const week4Data = data.weeklyPoints?.[4];

                            if (week4Data) {
                                const points = week4Data.totalPoints || 0;
                                const userName = members[userId]?.name || userId.slice(-6);

                                if (points > 136) { // Impossible score for 16 games
                                    impossibleScores.push({ userName, points });
                                    corruptedUsers++;
                                }

                                log(`User ${userName}: ${points} points`, points > 136 ? 'error' : 'info');
                            }
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Error checking user ${userId.slice(-6)}: ${error.message}`, 'warning');
                    }
                }

                log(`üéØ Analysis complete: ${corruptedUsers} users with impossible scores`, corruptedUsers > 0 ? 'error' : 'success');

                if (impossibleScores.length > 0) {
                    log('‚ùå Impossible scores found:', 'error');
                    impossibleScores.forEach(user => {
                        log(`  ${user.userName}: ${user.points} points (max possible: 136)`, 'error');
                    });
                }

            } catch (error) {
                log(`‚ùå Analysis failed: ${error.message}`, 'error');
            }
        }

        async function clearWeek4Data() {
            if (!confirm('‚ö†Ô∏è This will delete ALL Week 4 scoring data. Continue?')) {
                return;
            }

            log('üßπ Clearing corrupted Week 4 data...', 'warning');

            try {
                // Get pool members
                const membersRef = window.doc(window.db, 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members');
                const membersSnap = await window.getDoc(membersRef);

                const members = membersSnap.data();
                const userIds = Object.keys(members);

                let cleared = 0;

                for (const userId of userIds) {
                    try {
                        const scoringRef = window.doc(window.db, `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`);
                        await window.updateDoc(scoringRef, {
                            'weeklyPoints.4': window.deleteField(),
                            lastUpdated: new Date().toISOString()
                        });
                        cleared++;

                        if (cleared % 10 === 0) {
                            log(`‚úÖ Cleared ${cleared}/${userIds.length} users...`, 'info');
                        }
                    } catch (error) {
                        // User probably doesn't have Week 4 data - that's fine
                    }
                }

                log(`‚úÖ Cleared Week 4 data for ${cleared} users`, 'success');

            } catch (error) {
                log(`‚ùå Clear failed: ${error.message}`, 'error');
            }
        }

        async function regenerateWeek4() {
            log('‚ö° Regenerating Week 4 scores with fixed calculator...', 'info');

            try {
                // Load the fixed ScoringCalculator
                if (!window.ScoringCalculator) {
                    log('üì• Loading ScoringCalculator...', 'info');
                    const script = document.createElement('script');
                    script.src = './ScoringCalculator.js';
                    document.head.appendChild(script);

                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                    });
                }

                log('üöÄ Processing Week 4 with fixed calculator...', 'info');
                const results = await window.ScoringCalculator.processWeekScoring(4);

                log(`‚úÖ Week 4 regeneration complete: ${results.usersProcessed} users processed`, 'success');

                if (results.errors && results.errors.length > 0) {
                    log(`‚ö†Ô∏è ${results.errors.length} errors occurred:`, 'warning');
                    results.errors.forEach(error => {
                        log(`  ${error.userId.slice(-6)}: ${error.error}`, 'warning');
                    });
                }

            } catch (error) {
                log(`‚ùå Regeneration failed: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            log('‚úÖ Verifying Week 4 fix...', 'info');

            try {
                // Check a few users to verify scores are now correct
                const membersRef = window.doc(window.db, 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members');
                const membersSnap = await window.getDoc(membersRef);

                const members = membersSnap.data();
                const userIds = Object.keys(members).slice(0, 5); // Check first 5 users

                let allGood = true;

                for (const userId of userIds) {
                    try {
                        const scoringRef = window.doc(window.db, `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`);
                        const scoringSnap = await window.getDoc(scoringRef);

                        if (scoringSnap.exists()) {
                            const data = scoringSnap.data();
                            const week4Data = data.weeklyPoints?.[4];

                            const userName = members[userId]?.name || userId.slice(-6);

                            if (week4Data) {
                                const points = week4Data.totalPoints || 0;

                                if (points > 136) {
                                    log(`‚ùå ${userName}: Still has impossible score: ${points}`, 'error');
                                    allGood = false;
                                } else {
                                    log(`‚úÖ ${userName}: Valid score: ${points}`, 'success');
                                }
                            } else {
                                log(`‚úÖ ${userName}: No Week 4 data (expected for incomplete week)`, 'success');
                            }
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Error checking user ${userId.slice(-6)}: ${error.message}`, 'warning');
                    }
                }

                if (allGood) {
                    log('üéâ Week 4 fix verification PASSED!', 'success');
                } else {
                    log('‚ùå Week 4 fix verification FAILED - issues still exist', 'error');
                }

            } catch (error) {
                log(`‚ùå Verification failed: ${error.message}`, 'error');
            }
        }

        // Initial log
        log('üîß Week 4 Corruption Fix Tool Loaded', 'info');
        log('üìã Steps: 1) Analyze ‚Üí 2) Clear ‚Üí 3) Regenerate ‚Üí 4) Verify', 'info');
    </script>
</body>
</html>