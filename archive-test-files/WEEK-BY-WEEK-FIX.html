<!DOCTYPE html>
<html>
<head>
    <title>üéØ WEEK-BY-WEEK FIX - ALL 16 GAMES</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>üéØ WEEK-BY-WEEK FIX - ALL 16 GAMES</h1>
    <div style="background: #ffeeee; padding: 20px; border: 2px solid red; margin: 20px 0;">
        <h3>üö® MANDATORY: ALL 16 GAMES PER WEEK</h3>
        <p>This will process EACH WEEK separately, ensuring ALL 16 games are counted for EVERY user!</p>
        <p><strong>Results:</strong> <code>artifacts/nerdfootball/public/data/nerdfootball_results/{week}</code></p>
        <p><strong>Picks:</strong> <code>artifacts/nerdfootball/public/data/nerdfootball_picks/{week}/submissions/{userId}</code></p>
    </div>

    <button onclick="runWeek(1)" style="background: red; color: white; padding: 15px; margin: 5px;">üìÖ FIX WEEK 1 ALL USERS</button>
    <button onclick="runWeek(2)" style="background: orange; color: white; padding: 15px; margin: 5px;">üìÖ FIX WEEK 2 ALL USERS</button>
    <button onclick="runWeek(3)" style="background: green; color: white; padding: 15px; margin: 5px;">üìÖ FIX WEEK 3 ALL USERS</button>
    <br><br>
    <button onclick="runAllWeeks()" style="background: purple; color: white; padding: 20px; font-size: 18px;">üö® FIX ALL WEEKS 1-3 SEQUENTIALLY</button>

    <div id="output"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();

        async function autoLogin() {
            return new Promise((resolve) => {
                const unsubscribe = window.auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üîì AUTHENTICATED:', user.email);
                        unsubscribe();
                        resolve(user);
                    } else {
                        console.log('üîê NOT AUTHENTICATED - Signing in...');
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await window.auth.signInWithPopup(provider);
                            console.log('‚úÖ SIGNED IN SUCCESSFULLY');
                        } catch (error) {
                            console.error('‚ùå SIGN IN FAILED:', error);
                        }
                    }
                });
            });
        }

        async function getWeekResults(weekNumber) {
            console.log(`üìñ LOADING WEEK ${weekNumber} RESULTS FROM FIRESTORE`);
            try {
                const resultsPath = `artifacts/nerdfootball/public/data/nerdfootball_results/${weekNumber}`;
                const resultsDoc = await firebase.firestore().doc(resultsPath).get();

                if (!resultsDoc.exists) {
                    console.log(`‚ö†Ô∏è No results data found for week ${weekNumber}`);
                    return null;
                }

                const resultsData = resultsDoc.data();
                console.log(`‚úÖ WEEK ${weekNumber} RESULTS DATA:`, resultsData);

                // Count games (excluding metadata)
                const gameCount = Object.keys(resultsData).filter(key =>
                    key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                ).length;

                console.log(`üéØ WEEK ${weekNumber} HAS ${gameCount} GAMES`);

                return resultsData;
            } catch (error) {
                console.error(`‚ùå ERROR loading results for week ${weekNumber}:`, error);
                return null;
            }
        }

        async function getUserWeekPicks(userId, weekNumber) {
            console.log(`üîç LOADING ${userId} WEEK ${weekNumber} PICKS FROM FIRESTORE`);
            try {
                const picksDocPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${weekNumber}/submissions/${userId}`;
                const picksDoc = await firebase.firestore().doc(picksDocPath).get();

                if (!picksDoc.exists) {
                    console.log(`‚ö†Ô∏è NO PICKS FOUND FOR ${userId} WEEK ${weekNumber}`);
                    return null;
                }

                const picks = picksDoc.data();
                console.log(`‚úÖ ${userId} WEEK ${weekNumber} PICKS:`, picks);

                // Count picks (excluding metadata)
                const pickCount = Object.keys(picks).filter(key =>
                    key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                ).length;

                console.log(`üéØ ${userId} WEEK ${weekNumber} HAS ${pickCount} PICKS`);

                return picks;
            } catch (error) {
                console.error(`‚ùå ERROR loading picks for ${userId} week ${weekNumber}:`, error);
                return null;
            }
        }

        function calculateWeekScore(userPicks, weekResults, weekNumber) {
            if (!userPicks || !weekResults) {
                return {
                    totalPoints: 0,
                    gamesPlayed: 0,
                    gamesWon: 0,
                    gameResults: {},
                    error: `Missing ${!userPicks ? 'picks' : 'results'} for week ${weekNumber}`
                };
            }

            let totalPoints = 0;
            let gamesWon = 0;
            let gamesPlayed = 0;
            const gameResults = {};
            const gameDetails = [];

            console.log(`üßÆ CALCULATING WEEK ${weekNumber} SCORE`);
            console.log(`üìù USER PICKS:`, userPicks);
            console.log(`üìä WEEK RESULTS:`, weekResults);

            // Process every game in user picks
            for (const [gameId, pickData] of Object.entries(userPicks)) {
                if (gameId === 'mnfTotalPoints' || gameId === 'timestamp' || gameId === 'lastUpdated') continue;

                const confidence = pickData.confidence;
                const pickedTeam = pickData.team || pickData.winner; // Handle both formats

                if (!pickedTeam || !confidence) {
                    console.log(`‚ö†Ô∏è INVALID PICK DATA FOR GAME ${gameId}:`, pickData);
                    continue;
                }

                // Find corresponding result
                const gameResult = weekResults[gameId];
                if (!gameResult) {
                    console.log(`‚ö†Ô∏è NO RESULT FOUND FOR GAME ${gameId}`);
                    gameDetails.push(`Game ${gameId}: No result data found`);
                    continue;
                }

                gamesPlayed++;

                if (gameResult.winner) {
                    const isWin = gameResult.winner === pickedTeam;
                    const points = isWin ? confidence : 0;

                    if (isWin) {
                        gamesWon++;
                        totalPoints += points;
                    }

                    gameResults[gameId] = {
                        pickedTeam: pickedTeam,
                        actualWinner: gameResult.winner,
                        confidence: confidence,
                        points: points,
                        result: isWin ? 'win' : 'loss',
                        gameStatus: 'Final'
                    };

                    gameDetails.push(`Game ${gameId}: ${pickedTeam} vs ${gameResult.winner} = ${isWin ? 'WIN' : 'LOSS'} (${points} pts, conf: ${confidence})`);
                    console.log(`üéØ GAME ${gameId}: ${pickedTeam} vs ${gameResult.winner} = ${isWin ? 'WIN' : 'LOSS'} (${points} points)`);
                } else {
                    gameDetails.push(`Game ${gameId}: ${pickedTeam} vs TBD = PENDING`);
                }
            }

            return {
                totalPoints,
                gamesPlayed,
                gamesWon,
                gameResults,
                gameDetails: gameDetails.join('; ')
            };
        }

        async function fixWeekForAllUsers(weekNumber) {
            const output = document.getElementById('output');
            output.innerHTML += `<h3>üìÖ FIXING WEEK ${weekNumber} FOR ALL USERS...</h3>`;

            try {
                // Get week results
                const weekResults = await getWeekResults(weekNumber);
                if (!weekResults) {
                    output.innerHTML += `<p style="color: red;">‚ùå No results data for Week ${weekNumber}</p>`;
                    return;
                }

                const gameCount = Object.keys(weekResults).filter(key =>
                    key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                ).length;

                output.innerHTML += `<p style="color: green;">‚úÖ Week ${weekNumber} results loaded (${gameCount} games)</p>`;

                // Get all users
                const scoringCollectionPath = 'artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users';
                const usersSnapshot = await firebase.firestore().collection(scoringCollectionPath).get();

                if (usersSnapshot.empty) {
                    output.innerHTML += '<p>‚ùå NO USERS FOUND!</p>';
                    return;
                }

                output.innerHTML += `<p>üéØ Processing ${usersSnapshot.size} users for Week ${weekNumber}</p>`;

                let fixedCount = 0;
                let errorCount = 0;

                output.innerHTML += '<table border="1" style="border-collapse: collapse; width: 100%; font-size: 12px;"><tr><th>User</th><th>Picks Found</th><th>Games Played</th><th>Games Won</th><th>Points</th><th>Status</th></tr>';

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const displayName = userData.displayName || userData.email || `User ${userId.slice(-6)}`;

                    try {
                        // Get user's picks for this week
                        const userPicks = await getUserWeekPicks(userId, weekNumber);

                        if (!userPicks) {
                            output.innerHTML += `<tr><td>${displayName}</td><td>‚ùå No picks</td><td>0</td><td>0</td><td>0</td><td style="color: orange;">SKIPPED</td></tr>`;
                            continue;
                        }

                        const pickCount = Object.keys(userPicks).filter(key =>
                            key !== 'timestamp' && key !== 'lastUpdated' && key !== 'mnfTotalPoints'
                        ).length;

                        // Calculate week score
                        const weekScore = calculateWeekScore(userPicks, weekResults, weekNumber);

                        // Get current scoring document
                        const scoringPath = `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`;
                        const scoringDoc = await firebase.firestore().doc(scoringPath).get();

                        let currentData = {};
                        if (scoringDoc.exists) {
                            currentData = scoringDoc.data();
                        }

                        // Update the weeklyPoints for this specific week
                        const updatedWeeklyPoints = currentData.weeklyPoints || {};
                        updatedWeeklyPoints[weekNumber] = weekScore;

                        // Recalculate season totals from all weeks
                        let seasonTotalPoints = 0;
                        let seasonTotalGames = 0;
                        let seasonTotalWins = 0;
                        let weeksPlayed = 0;

                        for (const [week, weekData] of Object.entries(updatedWeeklyPoints)) {
                            if (weekData.gamesPlayed > 0) {
                                seasonTotalPoints += weekData.totalPoints || 0;
                                seasonTotalGames += weekData.gamesPlayed || 0;
                                seasonTotalWins += weekData.gamesWon || 0;
                                weeksPlayed++;
                            }
                        }

                        // Update scoring document
                        const updatedScoringData = {
                            ...currentData,
                            userId: userId,
                            displayName: displayName,
                            totalPoints: seasonTotalPoints,
                            weeklyPoints: updatedWeeklyPoints,
                            seasonStats: {
                                totalGames: seasonTotalGames,
                                gamesWon: seasonTotalWins,
                                weeksPlayed: weeksPlayed,
                                averagePointsPerWeek: weeksPlayed > 0 ? Math.round((seasonTotalPoints / weeksPlayed) * 100) / 100 : 0,
                                winPercentage: seasonTotalGames > 0 ? Math.round((seasonTotalWins / seasonTotalGames) * 10000) / 100 : 0
                            },
                            lastUpdatedWeek: Math.max(weekNumber, currentData.lastUpdatedWeek || 0),
                            lastUpdated: new Date().toISOString(),
                            [`week${weekNumber}Fixed`]: true,
                            [`week${weekNumber}Timestamp`]: new Date().toISOString()
                        };

                        await firebase.firestore().doc(scoringPath).set(updatedScoringData);

                        output.innerHTML += `<tr><td><strong>${displayName}</strong></td><td>‚úÖ ${pickCount}</td><td>${weekScore.gamesPlayed}</td><td>${weekScore.gamesWon}</td><td><strong>${weekScore.totalPoints}</strong></td><td style="color: green;">FIXED</td></tr>`;

                        fixedCount++;

                    } catch (error) {
                        console.error(`‚ùå ERROR fixing ${displayName} week ${weekNumber}:`, error);
                        output.innerHTML += `<tr><td>${displayName}</td><td>‚ùå Error</td><td>-</td><td>-</td><td>-</td><td style="color: red;">ERROR</td></tr>`;
                        errorCount++;
                    }
                }

                output.innerHTML += '</table>';
                output.innerHTML += `<p><strong>Week ${weekNumber} Complete: ${fixedCount} fixed, ${errorCount} errors</strong></p><hr>`;

            } catch (error) {
                console.error(`‚ùå ERROR processing week ${weekNumber}:`, error);
                output.innerHTML += `<p style="color: red;">‚ùå Error processing Week ${weekNumber}: ${error.message}</p>`;
            }
        }

        async function runWeek(weekNumber) {
            const output = document.getElementById('output');
            output.innerHTML = `<h2>üìÖ FIXING WEEK ${weekNumber} FOR ALL USERS</h2>`;

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                await fixWeekForAllUsers(weekNumber);

                output.innerHTML += `<h2 style="color: green;">‚úÖ WEEK ${weekNumber} FIX COMPLETE!</h2>`;

            } catch (error) {
                console.error('‚ùå WEEK FIX ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå WEEK ${weekNumber} FIX FAILED</h2><p>Error: ${error.message}</p>`;
            }
        }

        async function runAllWeeks() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üö® FIXING ALL WEEKS 1-3 SEQUENTIALLY</h2>';

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                for (let week = 1; week <= 3; week++) {
                    await fixWeekForAllUsers(week);
                }

                output.innerHTML += `<h2 style="color: green;">üöÄ ALL WEEKS 1-3 FIXED SUCCESSFULLY!</h2>`;
                output.innerHTML += `<p><strong>All users now have correct scoring for weeks 1, 2, and 3 with ALL 16 games counted!</strong></p>`;

            } catch (error) {
                console.error('‚ùå ALL WEEKS FIX ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå ALL WEEKS FIX FAILED</h2><p>Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>