<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç NerdFootball Scoring Audit Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-purple-800">
            üîç NerdFootball Scoring Audit Tool
        </h1>

        <!-- Auth Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">üîê Authentication</h2>
                <button id="signInBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Sign In with Google
                </button>
            </div>
            <div id="userInfo" class="text-sm text-gray-600 hidden"></div>
        </div>

        <!-- Audit Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üéØ Audit Controls</h2>
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <select id="weekSelector" class="px-3 py-2 border rounded bg-white" disabled>
                    <option value="">Select Week...</option>
                </select>
                <button id="auditWeekBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:bg-gray-400" disabled>
                    üîç Audit Week
                </button>
                <button id="fixWeekBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-400" disabled>
                    üîß Fix Week Scoring
                </button>
                <button id="auditAllBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 disabled:bg-gray-400" disabled>
                    üîç Audit All Weeks
                </button>
            </div>
            <div id="auditStatus" class="text-sm text-gray-600"></div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="space-y-6"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, writeBatch, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentWeek = null;
        let auditResults = [];
        let currentDiscrepancies = []; // Store users with errors for targeted fixing

        // Admin UIDs
        const ADMIN_UIDS = [
            'WxSPmEildJdqs6T5hIpBUZrscwt2', // tonyweeg@gmail.com
            'CX0etIyJbGg33nmHCo4eezPWrsr2',
            'sm17z8ovI8NAGmyQvogD86lIurr1',
            'dN91P1yGG4YBttxeGWmpAM2xhl22'
        ];

        // Initialize
        initializeWeekSelector();

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `‚úÖ Admin: ${user.email}`;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('signInBtn').textContent = 'Signed In';
                document.getElementById('signInBtn').disabled = true;
                enableControls();
            } else {
                currentUser = null;
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('signInBtn').textContent = 'Sign In with Google';
                document.getElementById('signInBtn').disabled = false;
                disableControls();
                if (user && !ADMIN_UIDS.includes(user.uid)) {
                    alert('üö® Access Denied: Admin privileges required');
                }
            }
        });

        document.getElementById('signInBtn').addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                alert(`Sign in error: ${error.message}`);
            }
        });

        function initializeWeekSelector() {
            const selector = document.getElementById('weekSelector');
            for (let i = 1; i <= 18; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Week ${i}`;
                selector.appendChild(option);
            }
        }

        function enableControls() {
            document.getElementById('weekSelector').disabled = false;
            document.getElementById('auditWeekBtn').disabled = false;
            document.getElementById('auditAllBtn').disabled = false;
        }

        function disableControls() {
            document.getElementById('weekSelector').disabled = true;
            document.getElementById('auditWeekBtn').disabled = true;
            document.getElementById('fixWeekBtn').disabled = true;
            document.getElementById('auditAllBtn').disabled = true;
        }

        document.getElementById('weekSelector').addEventListener('change', (e) => {
            currentWeek = parseInt(e.target.value) || null;
            document.getElementById('fixWeekBtn').disabled = !currentWeek;
        });

        document.getElementById('auditWeekBtn').addEventListener('click', () => {
            if (currentWeek) {
                auditSingleWeek(currentWeek);
            }
        });

        document.getElementById('fixWeekBtn').addEventListener('click', () => {
            if (currentWeek && currentDiscrepancies.length > 0) {
                const userList = currentDiscrepancies.map(d => `‚Ä¢ ${d.userName} (${d.uid.slice(-6)})`).join('\n');
                if (confirm(`‚ö†Ô∏è Fix Week ${currentWeek} scoring for ${currentDiscrepancies.length} users with errors?\n\n${userList}\n\nThis will ONLY update users with scoring discrepancies.`)) {
                    fixWeekScoring(currentWeek, currentDiscrepancies);
                }
            } else if (currentWeek && currentDiscrepancies.length === 0) {
                alert('‚úÖ No scoring errors found for this week - nothing to fix!');
            }
        });

        document.getElementById('auditAllBtn').addEventListener('click', () => {
            if (confirm('üîç Audit all weeks? This may take a while...')) {
                auditAllWeeks();
            }
        });

        async function loadBibleData(week) {
            // Load from Firestore (single source of truth)
            const gamesRef = doc(db, `artifacts/nerdfootball/public/data/nerdfootball_games/${week}`);
            const gamesSnap = await getDoc(gamesRef);

            if (!gamesSnap.exists()) {
                throw new Error(`No games found for Week ${week} in Firestore`);
            }

            return gamesSnap.data();
        }

        async function loadPoolMembers() {
            const membersSnap = await getDoc(doc(db, 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members'));
            return membersSnap.exists() ? membersSnap.data() : {};
        }

        async function calculateCorrectScoring(picks, bibleData) {
            // All weeks now use consistent Firestore structure: {"101": {...}, "201": {...}}
            const gameIds = Object.keys(bibleData).filter(k => k !== '_metadata');

            let correctPicks = 0;
            let totalPointsEarned = 0;
            const winningPicks = [];
            const losingPicks = [];

            gameIds.forEach(gameId => {
                const pick = picks[gameId];
                const game = bibleData[gameId];

                if (pick && typeof pick === 'object' && pick.winner && game) {
                    const actualWinner = game.winner;
                    const userPick = pick.winner;

                    // Only count if game has a winner (is finished)
                    if (actualWinner) {
                        const isCorrect = actualWinner === userPick;
                        const confidence = pick.confidence;

                        if (isCorrect) {
                            correctPicks++;
                            if (typeof confidence === 'number' && confidence >= 1 && confidence <= gameIds.length) {
                                totalPointsEarned += confidence;
                                winningPicks.push({ gameId, team: userPick, points: confidence });
                            }
                        } else {
                            losingPicks.push({ gameId, team: userPick, points: confidence, actualWinner });
                        }
                    }
                }
            });

            return {
                correctPicks,
                totalPointsEarned,
                winningPicks,
                losingPicks,
                totalGames: gameIds.length,
                finishedGames: gameIds.filter(id => bibleData[id]?.winner).length
            };
        }

        async function auditSingleWeek(week) {
            const status = document.getElementById('auditStatus');
            const container = document.getElementById('resultsContainer');

            status.textContent = `üîç Auditing Week ${week}...`;
            container.innerHTML = '';

            try {
                // Load bible data and pool members
                const [bibleData, poolMembers] = await Promise.all([
                    loadBibleData(week),
                    loadPoolMembers()
                ]);

                const gameIds = Object.keys(bibleData).filter(k => k !== '_metadata');
                status.textContent = `Loading Week ${week} picks and scoring data...`;

                // Load picks and scoring data
                const picksPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${week}/submissions`;
                const picksSnap = await getDocs(collection(db, picksPath));

                const discrepancies = [];
                let totalUsers = 0;
                let errorCount = 0;

                for (const pickDoc of picksSnap.docs) {
                    const uid = pickDoc.id;
                    const picks = pickDoc.data();
                    const member = poolMembers[uid];

                    if (!member) continue; // Skip non-pool members

                    totalUsers++;

                    // Calculate correct scoring
                    const correct = await calculateCorrectScoring(picks, bibleData);

                    // Get stored scoring
                    const scoringSnap = await getDoc(doc(db, `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${uid}`));
                    let stored = { gamesWon: 0, totalPoints: 0 };

                    if (scoringSnap.exists()) {
                        const weeklyPoints = scoringSnap.data().weeklyPoints || {};
                        stored = weeklyPoints[week.toString()] || { gamesWon: 0, totalPoints: 0 };
                    }

                    // Check for discrepancies
                    const correctPicksMatch = correct.correctPicks === (stored.gamesWon || 0);
                    const pointsMatch = correct.totalPointsEarned === (stored.totalPoints || 0);

                    if (!correctPicksMatch || !pointsMatch) {
                        errorCount++;
                        discrepancies.push({
                            uid,
                            userName: member.displayName || 'Unknown',
                            correct: correct.correctPicks,
                            correctPoints: correct.totalPointsEarned,
                            stored: stored.gamesWon || 0,
                            storedPoints: stored.totalPoints || 0,
                            winningPicks: correct.winningPicks
                        });
                    }
                }

                // Store discrepancies for targeted fixing
                currentDiscrepancies = discrepancies;

                // Display results
                displayAuditResults(week, totalUsers, errorCount, discrepancies);
                status.textContent = `‚úÖ Week ${week} audit complete: ${errorCount}/${totalUsers} users have errors`;

            } catch (error) {
                status.textContent = `‚ùå Error auditing Week ${week}: ${error.message}`;
                console.error('Audit error:', error);
            }
        }

        function displayAuditResults(week, totalUsers, errorCount, discrepancies) {
            const container = document.getElementById('resultsContainer');

            const resultDiv = document.createElement('div');
            resultDiv.className = 'bg-white rounded-lg shadow-lg p-6';

            const errorRate = Math.round((errorCount / totalUsers) * 100);
            const statusClass = errorCount === 0 ? 'text-green-600' : errorCount > totalUsers * 0.1 ? 'text-red-600' : 'text-yellow-600';
            const statusIcon = errorCount === 0 ? '‚úÖ' : errorCount > totalUsers * 0.1 ? 'üö®' : '‚ö†Ô∏è';

            resultDiv.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-bold text-purple-800">Week ${week} Audit Results</h3>
                    <div class="text-right">
                        <div class="text-lg font-semibold ${statusClass}">${statusIcon} ${errorCount}/${totalUsers} Errors</div>
                        <div class="text-sm text-gray-600">${errorRate}% error rate</div>
                    </div>
                </div>

                ${errorCount === 0 ? `
                    <div class="bg-green-50 border border-green-200 rounded p-4 text-center">
                        <h4 class="text-lg font-semibold text-green-800">‚úÖ Perfect Week!</h4>
                        <p class="text-green-700">All ${totalUsers} users have correct scoring data.</p>
                    </div>
                ` : `
                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
                        <h4 class="text-lg font-semibold text-red-800">${statusIcon} Scoring Discrepancies Found</h4>
                        <p class="text-red-700">${errorCount} out of ${totalUsers} users have incorrect scoring data.</p>
                    </div>

                    <div class="space-y-3">
                        ${discrepancies.slice(0, 10).map(d => `
                            <div class="bg-red-50 border border-red-200 rounded p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h5 class="font-semibold text-red-800">${d.userName}</h5>
                                        <div class="text-xs text-gray-600 font-mono">${d.uid.slice(-6)}</div>
                                        <div class="text-sm text-red-700 mt-1">
                                            Should be: ${d.correct} correct, ${d.correctPoints} points
                                        </div>
                                        <div class="text-sm text-red-600">
                                            Stored as: ${d.stored} correct, ${d.storedPoints} points
                                        </div>
                                    </div>
                                    <div class="text-right text-xs">
                                        <div class="text-red-600">Error: ${Math.abs(d.correctPoints - d.storedPoints)} pts</div>
                                    </div>
                                </div>
                                ${d.winningPicks.length > 0 ? `
                                    <div class="text-xs text-green-700 mt-2">
                                        ‚úÖ Wins: ${d.winningPicks.map(p => `${p.team}(${p.points})`).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}

                        ${discrepancies.length > 10 ? `
                            <div class="text-center text-sm text-gray-600 bg-gray-50 p-3 rounded">
                                Showing first 10 of ${discrepancies.length} errors
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            container.appendChild(resultDiv);
        }

        async function fixWeekScoring(week, discrepancies) {
            const status = document.getElementById('auditStatus');
            status.textContent = `üîß Fixing Week ${week} scoring for ${discrepancies.length} users...`;

            try {
                // Load bible data for this week
                const bibleData = await loadBibleData(week);

                const batch = writeBatch(db);
                let fixedCount = 0;

                // Only fix users with discrepancies
                for (const discrepancy of discrepancies) {
                    const uid = discrepancy.uid;

                    // Load this user's picks
                    const picksRef = doc(db, `artifacts/nerdfootball/public/data/nerdfootball_picks/${week}/submissions/${uid}`);
                    const picksSnap = await getDoc(picksRef);

                    if (!picksSnap.exists()) {
                        console.warn(`No picks found for user ${uid} in Week ${week}`);
                        continue;
                    }

                    const picks = picksSnap.data();

                    // Calculate correct scoring
                    const correct = await calculateCorrectScoring(picks, bibleData);

                    // Update scoring document
                    const scoringRef = doc(db, `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${uid}`);
                    const scoringSnap = await getDoc(scoringRef);

                    if (scoringSnap.exists()) {
                        const data = scoringSnap.data();
                        const weeklyPoints = data.weeklyPoints || {};

                        weeklyPoints[week.toString()] = {
                            gamesWon: correct.correctPicks,
                            totalPoints: correct.totalPointsEarned,
                            gamesPlayed: correct.totalGames,
                            lastUpdated: new Date().toISOString(),
                            recalculationApplied: true,
                            auditFixed: true
                        };

                        batch.update(scoringRef, { weeklyPoints });
                        fixedCount++;
                        console.log(`‚úÖ Queued fix for ${discrepancy.userName}: ${correct.correctPicks} correct, ${correct.totalPointsEarned} points`);
                    }
                }

                await batch.commit();
                status.textContent = `‚úÖ Fixed Week ${week} scoring for ${fixedCount} users with errors`;

                // Clear discrepancies and re-audit to show results
                currentDiscrepancies = [];
                setTimeout(() => auditSingleWeek(week), 1000);

            } catch (error) {
                status.textContent = `‚ùå Error fixing Week ${week}: ${error.message}`;
                console.error('Fix error:', error);
            }
        }

        async function auditAllWeeks() {
            const status = document.getElementById('auditStatus');
            const container = document.getElementById('resultsContainer');

            status.textContent = 'üîç Auditing all weeks...';
            container.innerHTML = '';

            for (let week = 1; week <= 4; week++) {
                try {
                    await auditSingleWeek(week);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                } catch (error) {
                    console.error(`Error auditing week ${week}:`, error);
                }
            }

            status.textContent = '‚úÖ All weeks audit complete';
        }
    </script>
</body>
</html>