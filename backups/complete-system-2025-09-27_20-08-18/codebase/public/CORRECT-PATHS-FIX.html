<!DOCTYPE html>
<html>
<head>
    <title>üéØ CORRECT PATHS FIX - FIRESTORE DATA</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>üéØ CORRECT PATHS FIX</h1>
    <div style="background: #eeffee; padding: 20px; border: 2px solid green; margin: 20px 0;">
        <h3>‚úÖ USING CORRECT FIRESTORE PATHS</h3>
        <p><strong>Results:</strong> <code>artifacts/nerdfootball/public/data/nerdfootball_results/{week}</code></p>
        <p><strong>Picks:</strong> <code>artifacts/nerdfootball/public/data/nerdfootball_picks/{week}/submissions/{userId}</code></p>
        <p>This will restore EVERYONE'S scoring with their REAL data from Firestore!</p>
    </div>

    <button onclick="runCorrectPathsFix()" style="background: green; color: white; padding: 20px; font-size: 18px;">üéØ FIX ALL USERS - CORRECT PATHS</button>
    <div id="output"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();

        async function autoLogin() {
            return new Promise((resolve) => {
                const unsubscribe = window.auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üîì AUTHENTICATED:', user.email);
                        unsubscribe();
                        resolve(user);
                    } else {
                        console.log('üîê NOT AUTHENTICATED - Signing in...');
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            await window.auth.signInWithPopup(provider);
                            console.log('‚úÖ SIGNED IN SUCCESSFULLY');
                        } catch (error) {
                            console.error('‚ùå SIGN IN FAILED:', error);
                        }
                    }
                });
            });
        }

        async function getResultsData(weekNumber) {
            console.log(`üìñ LOADING RESULTS DATA FROM FIRESTORE FOR WEEK ${weekNumber}`);
            try {
                // CORRECT: Use Firestore path for results
                const resultsPath = `artifacts/nerdfootball/public/data/nerdfootball_results/${weekNumber}`;
                const resultsDoc = await firebase.firestore().doc(resultsPath).get();

                if (!resultsDoc.exists) {
                    console.log(`‚ö†Ô∏è No results data found for week ${weekNumber}`);
                    return null;
                }

                const resultsData = resultsDoc.data();
                console.log(`‚úÖ RESULTS DATA WEEK ${weekNumber}:`, resultsData);

                // Convert to array format for easier processing
                const gamesArray = [];
                for (const [gameId, gameData] of Object.entries(resultsData)) {
                    if (gameId === 'timestamp' || gameId === 'lastUpdated') continue; // Skip metadata

                    gamesArray.push({
                        gameId: gameId,
                        status: 'Final', // Results data means game is finished
                        winner: gameData.winner,
                        homeTeam: gameData.home || gameData.h,
                        awayTeam: gameData.away || gameData.a,
                        homeScore: gameData.homeScore,
                        awayScore: gameData.awayScore
                    });
                }

                return gamesArray;
            } catch (error) {
                console.log(`‚ùå ERROR loading results data for week ${weekNumber}:`, error);
                return null;
            }
        }

        async function getUserPicks(userId, weekNumber) {
            console.log(`üîç LOADING PICKS FROM FIRESTORE FOR ${userId} WEEK ${weekNumber}`);
            try {
                // CORRECT: Use Firestore path for picks
                const picksDocPath = `artifacts/nerdfootball/public/data/nerdfootball_picks/${weekNumber}/submissions/${userId}`;
                const picksDoc = await firebase.firestore().doc(picksDocPath).get();

                if (!picksDoc.exists) {
                    console.log(`‚ö†Ô∏è NO PICKS FOUND FOR ${userId} WEEK ${weekNumber}`);
                    return null;
                }

                const picks = picksDoc.data();
                console.log(`‚úÖ PICKS FOR ${userId} WEEK ${weekNumber}:`, picks);
                return picks;
            } catch (error) {
                console.error(`‚ùå ERROR LOADING PICKS FOR ${userId} WEEK ${weekNumber}:`, error);
                return null;
            }
        }

        function calculateWeekPoints(picks, resultsData) {
            if (!picks || !resultsData) {
                return { totalPoints: 0, gamesPlayed: 0, gamesWon: 0, gameResults: {} };
            }

            let totalPoints = 0;
            let gamesWon = 0;
            let gamesPlayed = 0;
            const gameResults = {};

            console.log('üßÆ CALCULATING POINTS WITH PICKS:', picks);
            console.log('üìñ RESULTS DATA FOR CALCULATION:', resultsData);

            for (const [gameId, pickData] of Object.entries(picks)) {
                if (gameId === 'mnfTotalPoints') continue; // Skip MNF total points

                const confidence = pickData.confidence;
                const pickedTeam = pickData.team || pickData.winner; // Handle both formats!

                if (!pickedTeam || !confidence) {
                    console.log(`‚ö†Ô∏è INVALID PICK DATA FOR GAME ${gameId}:`, pickData);
                    continue;
                }

                // Find the game in results data
                const resultGame = resultsData.find(game => game.gameId === gameId);
                if (!resultGame) {
                    console.log(`‚ö†Ô∏è NO RESULT DATA FOR GAME ${gameId}`);
                    continue;
                }

                gamesPlayed++;

                if (resultGame.status === 'Final' && resultGame.winner) {
                    const isWin = resultGame.winner === pickedTeam;
                    const points = isWin ? confidence : 0;

                    if (isWin) {
                        gamesWon++;
                        totalPoints += points;
                    }

                    gameResults[gameId] = {
                        pickedTeam: pickedTeam,
                        actualWinner: resultGame.winner,
                        confidence: confidence,
                        points: points,
                        result: isWin ? 'win' : 'loss',
                        gameStatus: 'Final'
                    };

                    console.log(`üéØ GAME ${gameId}: ${pickedTeam} vs ${resultGame.winner} = ${isWin ? 'WIN' : 'LOSS'} (${points} points)`);
                }
            }

            return {
                totalPoints,
                gamesPlayed,
                gamesWon,
                gameResults
            };
        }

        async function fixUserScoring(userId, displayName) {
            console.log(`üîß FIXING SCORING FOR ${displayName} (${userId})`);

            const userWeeklyData = {};
            let seasonTotalPoints = 0;
            let seasonTotalGames = 0;
            let seasonTotalWins = 0;
            let weeksPlayed = 0;

            // Process weeks 1-3 (where we have completed games)
            for (let week = 1; week <= 3; week++) {
                console.log(`üìÖ PROCESSING WEEK ${week} FOR ${displayName}`);

                const resultsData = await getResultsData(week);
                if (!resultsData) {
                    console.log(`‚ùå NO RESULTS DATA FOR WEEK ${week} - SKIPPING`);
                    continue;
                }

                const picks = await getUserPicks(userId, week);
                if (!picks) {
                    console.log(`‚ùå NO PICKS FOR ${displayName} WEEK ${week} - SKIPPING`);
                    continue;
                }

                const weekResults = calculateWeekPoints(picks, resultsData);
                console.log(`üìä WEEK ${week} RESULTS FOR ${displayName}:`, weekResults);

                userWeeklyData[week] = weekResults;
                seasonTotalPoints += weekResults.totalPoints;
                seasonTotalGames += weekResults.gamesPlayed;
                seasonTotalWins += weekResults.gamesWon;

                if (weekResults.gamesPlayed > 0) {
                    weeksPlayed++;
                }
            }

            // Create the corrected scoring document
            const correctedScoringData = {
                userId: userId,
                displayName: displayName,
                totalPoints: seasonTotalPoints,
                weeklyPoints: userWeeklyData,
                seasonStats: {
                    totalGames: seasonTotalGames,
                    gamesWon: seasonTotalWins,
                    weeksPlayed: weeksPlayed,
                    averagePointsPerWeek: weeksPlayed > 0 ? Math.round((seasonTotalPoints / weeksPlayed) * 100) / 100 : 0,
                    winPercentage: seasonTotalGames > 0 ? Math.round((seasonTotalWins / seasonTotalGames) * 10000) / 100 : 0
                },
                lastUpdatedWeek: 3,
                lastUpdated: new Date().toISOString(),
                correctPathsApplied: true,
                correctPathsTimestamp: new Date().toISOString(),
                calculationMethod: 'Firestore picks + Firestore results',
                dataSource: 'artifacts/nerdfootball/public/data'
            };

            console.log(`üíæ SAVING CORRECTED DATA FOR ${displayName}:`, correctedScoringData);

            // Save to Firestore
            const scoringPath = `artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users/${userId}`;
            await firebase.firestore().doc(scoringPath).set(correctedScoringData);

            return correctedScoringData;
        }

        async function runCorrectPathsFix() {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üéØ RUNNING CORRECT PATHS FIX...</h2>';

            try {
                await autoLogin();
                output.innerHTML += '<p>‚úÖ Authenticated successfully</p>';

                // Get all users from scoring collection
                const scoringCollectionPath = 'artifacts/nerdfootball/pools/nerduniverse-2025/scoring-users';
                const usersSnapshot = await firebase.firestore().collection(scoringCollectionPath).get();

                if (usersSnapshot.empty) {
                    output.innerHTML += '<p>‚ùå NO USERS FOUND IN SCORING COLLECTION!</p>';
                    return;
                }

                output.innerHTML += `<h3>üéØ FIXING SCORING FOR ${usersSnapshot.size} USERS</h3>`;

                let fixedCount = 0;
                let errorCount = 0;
                const results = [];

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const displayName = userData.displayName || userData.email || `User ${userId.slice(-6)}`;

                    try {
                        output.innerHTML += `<p>üîß Fixing ${displayName}...</p>`;

                        const correctedData = await fixUserScoring(userId, displayName);

                        results.push({
                            userId,
                            displayName,
                            totalPoints: correctedData.totalPoints,
                            weeksPlayed: correctedData.seasonStats.weeksPlayed,
                            gamesWon: correctedData.seasonStats.gamesWon,
                            status: 'FIXED'
                        });

                        fixedCount++;

                        output.innerHTML += `<p style="color: green;">‚úÖ ${displayName}: ${correctedData.totalPoints} points (${correctedData.seasonStats.gamesWon} wins)</p>`;

                    } catch (error) {
                        console.error(`‚ùå ERROR FIXING ${displayName}:`, error);
                        errorCount++;

                        results.push({
                            userId,
                            displayName,
                            status: 'ERROR',
                            error: error.message
                        });

                        output.innerHTML += `<p style="color: red;">‚ùå ERROR fixing ${displayName}: ${error.message}</p>`;
                    }
                }

                // Show summary
                output.innerHTML += `
                    <hr>
                    <h2>üéØ CORRECT PATHS FIX COMPLETE!</h2>
                    <p><strong>Users Fixed:</strong> ${fixedCount}</p>
                    <p><strong>Errors:</strong> ${errorCount}</p>
                    <h3>üìä Results Summary:</h3>
                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <tr><th>User</th><th>Total Points</th><th>Weeks Played</th><th>Games Won</th><th>Status</th></tr>
                `;

                results.forEach(result => {
                    const statusColor = result.status === 'FIXED' ? 'green' : 'red';
                    output.innerHTML += `
                        <tr>
                            <td><strong>${result.displayName}</strong></td>
                            <td>${result.totalPoints || 'N/A'}</td>
                            <td>${result.weeksPlayed || 'N/A'}</td>
                            <td>${result.gamesWon || 'N/A'}</td>
                            <td style="color: ${statusColor};">${result.status}</td>
                        </tr>
                    `;
                });

                output.innerHTML += '</table>';
                output.innerHTML += '<p><strong>üöÄ All users now have their REAL scoring data from the correct Firestore paths!</strong></p>';

            } catch (error) {
                console.error('‚ùå CORRECT PATHS FIX ERROR:', error);
                output.innerHTML += `<h2 style="color: red;">‚ùå CORRECT PATHS FIX FAILED</h2><p>Error: ${error.message}</p><p>Stack: ${error.stack}</p>`;
            }
        }
    </script>
</body>
</html>