<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Architecture Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .pending { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Firebase Architecture Test</h1>
    <p>Testing bulletproof Firebase initialization and bundle dependency gates</p>
    
    <div id="firebase-status" class="status pending">‚è≥ Initializing Firebase...</div>
    <div id="bundle-status" class="status pending">‚è≥ Waiting for bundles...</div>
    <div id="services-status" class="status pending">‚è≥ Testing Firebase services...</div>
    
    <div id="logs" class="log"></div>
    
    <script src="./firebase-global-init.js"></script>
    <script src="./bundle-dependency-gate.js"></script>
    
    <script>
        const statusElements = {
            firebase: document.getElementById('firebase-status'),
            bundle: document.getElementById('bundle-status'),
            services: document.getElementById('services-status')
        };
        
        const logs = document.getElementById('logs');
        
        function logMessage(message) {
            console.log(message);
            logs.textContent += new Date().toISOString() + ': ' + message + '\n';
            logs.scrollTop = logs.scrollHeight;
        }
        
        function updateStatus(type, message, success = false) {
            const element = statusElements[type];
            element.textContent = message;
            element.className = 'status ' + (success ? 'success' : 'error');
        }
        
        // Test Firebase readiness
        window.addEventListener('firebaseGlobalsReady', (event) => {
            logMessage('‚úÖ Firebase globals ready event received');
            updateStatus('firebase', '‚úÖ Firebase initialized successfully', true);
            
            testFirebaseServices();
        });
        
        window.addEventListener('firebaseInitError', (event) => {
            logMessage('‚ùå Firebase initialization failed: ' + event.detail.error);
            updateStatus('firebase', '‚ùå Firebase initialization failed');
        });
        
        // Test bundle dependency gate
        window.bundleGate.waitForFirebase('test-bundle', () => {
            logMessage('‚úÖ Test bundle executed via dependency gate');
            updateStatus('bundle', '‚úÖ Bundle dependency gate working', true);
        });
        
        // Test Firebase services
        function testFirebaseServices() {
            try {
                const firebase = window.ensureFirebase();
                logMessage('‚úÖ Firebase services available: ' + Object.keys(firebase).join(', '));
                
                // Test specific globals
                const tests = [
                    { name: 'auth', obj: window.auth },
                    { name: 'db', obj: window.db },
                    { name: 'functions', obj: window.functions },
                    { name: 'rtdb', obj: window.rtdb }
                ];
                
                const results = tests.map(test => {
                    const available = test.obj !== undefined;
                    logMessage(`${available ? '‚úÖ' : '‚ùå'} ${test.name}: ${available ? 'Available' : 'Missing'}`);
                    return available;
                });
                
                const allWorking = results.every(Boolean);
                updateStatus('services', 
                    allWorking ? '‚úÖ All Firebase services available' : '‚ùå Some Firebase services missing',
                    allWorking
                );
                
            } catch (error) {
                logMessage('‚ùå Firebase services test failed: ' + error.message);
                updateStatus('services', '‚ùå Firebase services test failed');
            }
        }
        
        logMessage('üöÄ Firebase architecture test started');
        
        // Timeout test
        setTimeout(() => {
            if (!window.firebaseReady) {
                logMessage('‚ö†Ô∏è  Timeout: Firebase not ready after 10 seconds');
                updateStatus('firebase', '‚ö†Ô∏è Firebase initialization timeout');
            }
        }, 10000);
    </script>
</body>
</html>