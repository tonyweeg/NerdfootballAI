<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèà MODAiL THE NERD - Live Game Modal System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ocean': {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <h1 class="text-4xl font-bold text-slate-800">üèà MODAiL THE NERD</h1>
            <p class="text-slate-600 mt-2">Advanced Live Game Modal System with AI Analysis & Real ESPN Data</p>
            <div class="mt-4 text-sm text-blue-600 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                <strong>Branch:</strong> MODAiL-THE-NERD | <strong>Port:</strong> :5003 | <strong>Status:</strong> Local Development
            </div>
        </div>
    </div>

    <!-- Game Cards Grid -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Current Week Games -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">üèÜ Live Game Analysis (Week 3)</h2>
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <!-- Real Game Cards with ESPN Event IDs -->
                <div class="bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="openLiveGameModal('game1', '401772725', 'JAX', 'CIN')">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold text-green-600 bg-green-50 px-2 py-1 rounded">FINAL</span>
                            <span class="text-xs text-slate-500">ESPN: 401772725</span>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-slate-700 mb-2">Week 2 ‚Ä¢ Monday</div>
                            <div class="flex justify-between items-center">
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">JAX</div>
                                    <div class="text-3xl font-bold text-slate-800">27</div>
                                </div>
                                <div class="text-slate-400 text-lg">@</div>
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">CIN</div>
                                    <div class="text-3xl font-bold text-slate-800">31</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                üéØ AI Analysis & Stats ‚Üí
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Live Game Example -->
                <div class="bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="openLiveGameModal('game2', '401772919', 'ATL', 'MIN')">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold text-red-600 bg-red-50 px-2 py-1 rounded animate-pulse">üî¥ LIVE</span>
                            <span class="text-xs text-slate-500">ESPN: 401772919</span>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-slate-700 mb-2">Week 2 ‚Ä¢ Sunday</div>
                            <div class="flex justify-between items-center">
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">ATL</div>
                                    <div class="text-3xl font-bold text-slate-800">14</div>
                                </div>
                                <div class="text-slate-400 text-lg">@</div>
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">MIN</div>
                                    <div class="text-3xl font-bold text-slate-800">21</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                üìä Live Predictions ‚Üí
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Game Example -->
                <div class="bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                     onclick="openLiveGameModal('game3', '401772836', 'PHI', 'KC')">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">SCHEDULED</span>
                            <span class="text-xs text-slate-500">ESPN: 401772836</span>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-slate-700 mb-2">Week 2 ‚Ä¢ Monday</div>
                            <div class="flex justify-between items-center">
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">PHI</div>
                                    <div class="text-lg text-slate-500">-</div>
                                </div>
                                <div class="text-slate-400 text-lg">@</div>
                                <div class="text-center">
                                    <div class="text-sm text-slate-600 font-semibold">KC</div>
                                    <div class="text-lg text-slate-500">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                üîÆ Pre-Game Analysis ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Demo Section -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-8">
            <h3 class="text-2xl font-bold text-blue-800 mb-6">üéØ MODAiL Features</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-3xl mb-3">üéØ</div>
                    <h4 class="font-semibold text-blue-700 mb-2">User Pick Display</h4>
                    <p class="text-sm text-blue-600">Shows your team pick with confidence value in dynamic badge</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-3">ü§ñ</div>
                    <h4 class="font-semibold text-blue-700 mb-2">AI Statistical Analysis</h4>
                    <p class="text-sm text-blue-600">Deep breakdown of offensive efficiency, turnovers, red zone performance</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-3">üèÜ</div>
                    <h4 class="font-semibold text-blue-700 mb-2">Win Prediction Engine</h4>
                    <p class="text-sm text-blue-600">AI-calculated win probability with confidence percentage and reasoning</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-3">üìä</div>
                    <h4 class="font-semibold text-blue-700 mb-2">Real-Time ESPN Data</h4>
                    <p class="text-sm text-blue-600">Live game stats, scores, and play-by-play integration</p>
                </div>
            </div>
        </div>

        <!-- Testing Controls -->
        <div class="mt-8 bg-slate-100 border border-slate-300 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">üß™ Developer Testing Controls</h3>
            <div class="flex flex-wrap gap-4">
                <button onclick="testModalWithMockData()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    Test with Mock Data
                </button>
                <button onclick="testModalWithRealESPN()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                    Test with Real ESPN API
                </button>
                <button onclick="testErrorHandling()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                    Test Error Handling
                </button>
                <button onclick="testUserPickIntegration()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                    Test User Pick Integration
                </button>
            </div>
        </div>
    </div>

    <!-- Live Game Modal -->
    <div id="live-game-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[95vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-purple-50">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">üèà Live Game Analysis</h2>
                    <p class="text-slate-600 text-sm mt-1">AI-powered insights with real-time ESPN data</p>
                </div>
                <button onclick="closeLiveGameModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Loading State -->
            <div id="modal-loading" class="flex items-center justify-center p-16">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto"></div>
                    <p class="text-slate-600 mt-6 text-lg font-medium">Loading ESPN game data...</p>
                    <p class="text-slate-500 text-sm mt-2">Fetching real-time stats and AI analysis</p>
                </div>
            </div>

            <!-- Modal Content -->
            <div id="modal-game-content" class="hidden">
                <div id="game-data-display" class="p-6">
                    <!-- Game data will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize modal system
        console.log('üöÄ MODAiL THE NERD - Modal System Initialized');

        // Mock current user for testing
        const currentUser = { uid: 'test-user-123' };
        const currentWeek = 3;

        // Sample user picks for testing
        const USER_PICKS = {
            "401772725": { team: "CIN", confidence: 8, gameId: "game1" },
            "401772919": { team: "MIN", confidence: 12, gameId: "game2" },
            "401772836": { team: "KC", confidence: 15, gameId: "game3" }
        };

        // Real ESPN Event IDs for Week 2/3 games
        const REAL_ESPN_EVENT_IDS = {
            'Jacksonville Jaguars @ Cincinnati Bengals': '401772725',
            'Atlanta Falcons @ Minnesota Vikings': '401772919',
            'Philadelphia Eagles @ Kansas City Chiefs': '401772836',
            'Tampa Bay Buccaneers @ Houston Texans': '401772715',
            'Los Angeles Chargers @ Las Vegas Raiders': '401772811',
            'New York Giants @ Dallas Cowboys': '401772820',
            'Chicago Bears @ Detroit Lions': '401772726',
            'Los Angeles Rams @ Tennessee Titans': '401772724',
            'New England Patriots @ Miami Dolphins': '401772728',
            'San Francisco 49ers @ New Orleans Saints': '401772833'
        };

        // Main modal opening function
        window.openLiveGameModal = async function(gameId, espnEventId, awayTeam = null, homeTeam = null) {
            console.log(`üöÄ Opening live game modal for ESPN Event: ${espnEventId}`);

            const modal = document.getElementById('live-game-modal');
            const loading = document.getElementById('modal-loading');
            const content = document.getElementById('modal-game-content');
            const gameDisplay = document.getElementById('game-data-display');

            if (!modal) {
                console.error('‚ùå Live game modal not found in DOM');
                return;
            }

            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');

            try {
                console.log('üîÑ Calling Firebase function for game data...');

                // Fetch game data and user pick in parallel
                const [gameResponse, userPick] = await Promise.all([
                    fetch('https://us-central1-nerdfootball.cloudfunctions.net/testLiveGameDetails', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ espnEventId })
                    }),
                    fetchUserPickForGame(espnEventId, awayTeam, homeTeam)
                ]);

                const gameResult = await gameResponse.json();

                console.log('‚úÖ Live game modal result:', gameResult);
                console.log('üë§ User pick:', userPick);

                // Handle ESPN API response
                if (gameResult.success && gameResult.data) {
                    // Display the beautiful data with user pick
                    gameDisplay.innerHTML = createBeautifulGameDisplay(gameResult.data, userPick);
                } else {
                    // Graceful fallback for 404/unavailable games
                    console.log('üìÖ ESPN data unavailable, showing basic game info');
                    gameDisplay.innerHTML = createFallbackGameDisplay(awayTeam, homeTeam, userPick, gameResult.error);
                }

                loading.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (error) {
                console.error('‚ùå Live game modal error:', error);

                gameDisplay.innerHTML = `<div class="text-red-600 p-4 text-center">
                    <h3 class="text-lg font-semibold mb-2">Error Loading Game Data</h3>
                    <p class="text-sm">${error.message}</p>
                    <button onclick="closeLiveGameModal()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Close</button>
                </div>`;
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            }
        };

        window.closeLiveGameModal = function() {
            const modal = document.getElementById('live-game-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Fetch user's pick for this game
        async function fetchUserPickForGame(espnEventId, awayTeam = null, homeTeam = null) {
            try {
                console.log('üîç Fetching user pick for ESPN ID:', espnEventId);

                if (!currentUser) {
                    console.log('No current user, returning null');
                    return null;
                }

                // For testing, use mock data
                const userPick = USER_PICKS[espnEventId];
                if (userPick) {
                    console.log(`‚úÖ Found pick: ${userPick.team} (confidence: ${userPick.confidence})`);
                    return {
                        team: userPick.team,
                        confidence: userPick.confidence,
                        gameId: userPick.gameId,
                        found: true
                    };
                }

                console.log('No pick found for this game');
                return null;

            } catch (error) {
                console.error('Error fetching user pick:', error);
                return null;
            }
        }

        // Create beautiful game display with AI analysis
        function createBeautifulGameDisplay(gameData, userPick = null) {
            if (!gameData) {
                return '<div class="p-6 text-center text-red-600">No game data available</div>';
            }

            console.log('üèà Creating beautiful display for:', gameData);

            const awayTeam = gameData.teams?.away;
            const homeTeam = gameData.teams?.home;
            const awayStats = gameData.teamStats?.away;
            const homeStats = gameData.teamStats?.home;

            if (!awayTeam || !homeTeam) {
                return '<div class="p-6 text-center text-red-600">Team data not available</div>';
            }

            // Get team colors (fallback to default if not available)
            const awayColor = awayTeam.color ? `#${awayTeam.color}` : '#374151';
            const homeColor = homeTeam.color ? `#${homeTeam.color}` : '#374151';

            // Format game status
            let gameStatus = '';
            if (gameData.status === 'STATUS_FINAL') {
                gameStatus = `<span class="text-gray-600 font-bold">FINAL</span>`;
            } else if (gameData.status === 'STATUS_IN_PROGRESS') {
                gameStatus = `<span class="text-red-500 font-bold animate-pulse">üî¥ LIVE</span>`;
                if (gameData.statusDisplay) {
                    gameStatus += `<span class="ml-2 text-sm font-semibold">${gameData.statusDisplay}</span>`;
                }
            } else {
                gameStatus = `<span class="text-blue-600 font-bold">${gameData.statusDisplay || 'SCHEDULED'}</span>`;
            }

            // Calculate AI analysis
            const analysis = calculateDetailedAnalysis(awayStats, homeStats, awayTeam, homeTeam);
            const prediction = calculateWinPrediction(awayStats, homeStats, awayTeam, homeTeam);

            return `
                <div class="space-y-6">
                    <!-- Game Header -->
                    <div class="text-center bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg p-6 border border-slate-200">
                        <div class="text-sm font-medium text-slate-600 mb-3">${gameStatus}</div>
                        <div class="flex justify-center items-center space-x-8">
                            <div class="text-center">
                                <div class="text-xl font-bold mb-2" style="color: ${awayColor}">${awayTeam.abbreviation}</div>
                                <div class="text-4xl font-bold text-slate-800">${awayTeam.score}</div>
                                <div class="text-sm text-slate-500 mt-1">${awayTeam.name}</div>
                                <div class="text-xs text-slate-400">${awayTeam.record || ''}</div>
                            </div>
                            <div class="text-slate-400 text-2xl">@</div>
                            <div class="text-center">
                                <div class="text-xl font-bold mb-2" style="color: ${homeColor}">${homeTeam.abbreviation}</div>
                                <div class="text-4xl font-bold text-slate-800">${homeTeam.score}</div>
                                <div class="text-sm text-slate-500 mt-1">${homeTeam.name}</div>
                                <div class="text-xs text-slate-400">${homeTeam.record || ''}</div>
                            </div>
                        </div>
                    </div>

                    ${userPick ? `
                    <!-- User Pick Display -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                            <span class="mr-2">üéØ</span>Your Pick
                        </h3>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-lg font-bold">
                                    ${userPick.confidence}
                                </div>
                                <div>
                                    <div class="font-bold text-blue-800 text-lg">${userPick.team}</div>
                                    <div class="text-blue-600 text-sm">Confidence Pick</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-blue-600 font-medium">Active Pick</div>
                                <div class="text-xs text-blue-500">Week ${currentWeek}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- AI Statistical Analysis -->
                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center">
                            <span class="mr-2">ü§ñ</span>AI Statistical Analysis
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${analysis.map(stat => `
                                <div class="bg-white rounded-lg p-4 border border-slate-200 hover:shadow-md transition-shadow">
                                    <div class="text-sm font-semibold text-slate-700 mb-3">${stat.category}</div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm" style="color: ${awayColor}">${awayTeam.abbreviation}: ${stat.away}</span>
                                            <span class="text-sm" style="color: ${homeColor}">${homeTeam.abbreviation}: ${stat.home}</span>
                                        </div>
                                        ${stat.advantage ? `
                                            <div class="text-xs text-green-600 font-medium bg-green-50 px-2 py-1 rounded">
                                                ${stat.advantage}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- AI Win Prediction -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                            <span class="mr-2">üèÜ</span>AI Win Prediction
                        </h3>
                        <div class="text-center">
                            <div class="text-3xl font-bold mb-3" style="color: ${prediction.winnerTeam.color ? `#${prediction.winnerTeam.color}` : '#059669'}">
                                ${prediction.winnerTeam.name}
                            </div>
                            <div class="text-2xl font-bold text-green-700 mb-4">
                                ${prediction.confidence}% Confidence
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-green-200">
                                <div class="text-sm font-semibold text-green-800 mb-2">Key Factors:</div>
                                <div class="text-sm text-green-700">${prediction.factors.join(' ‚Ä¢ ')}</div>
                            </div>
                            ${prediction.reasoning ? `
                                <div class="mt-4 text-xs text-green-600 italic">
                                    ${prediction.reasoning}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Calculate detailed statistical analysis
        function calculateDetailedAnalysis(awayStats, homeStats, awayTeam, homeTeam) {
            if (!awayStats || !homeStats) return [];

            const analysis = [];

            // Offensive Efficiency (Yards per Play)
            const awayYPP = parseFloat(awayStats.yards_per_play || '0');
            const homeYPP = parseFloat(homeStats.yards_per_play || '0');
            const yppDiff = Math.abs(awayYPP - homeYPP);
            analysis.push({
                category: "Offensive Efficiency",
                away: `${awayYPP} YPP`,
                home: `${homeYPP} YPP`,
                advantage: yppDiff > 0.5 ?
                    `${awayYPP > homeYPP ? awayTeam.abbreviation : homeTeam.abbreviation} +${yppDiff.toFixed(1)} advantage` : null
            });

            // Total Yards
            const awayYards = parseInt(awayStats.total_yards || '0');
            const homeYards = parseInt(homeStats.total_yards || '0');
            const yardsDiff = Math.abs(awayYards - homeYards);
            analysis.push({
                category: "Total Yards",
                away: awayYards.toString(),
                home: homeYards.toString(),
                advantage: yardsDiff > 50 ?
                    `${awayYards > homeYards ? awayTeam.abbreviation : homeTeam.abbreviation} +${yardsDiff} yards` : null
            });

            // Red Zone Efficiency
            if (awayStats['red_zone_(made-att)'] && homeStats['red_zone_(made-att)']) {
                analysis.push({
                    category: "Red Zone Efficiency",
                    away: awayStats['red_zone_(made-att)'],
                    home: homeStats['red_zone_(made-att)'],
                    advantage: null
                });
            }

            // Turnover Differential
            const awayTurnovers = parseInt(awayStats.turnovers || '0');
            const homeTurnovers = parseInt(homeStats.turnovers || '0');
            analysis.push({
                category: "Turnovers",
                away: awayTurnovers.toString(),
                home: homeTurnovers.toString(),
                advantage: awayTurnovers !== homeTurnovers ?
                    `${awayTurnovers < homeTurnovers ? awayTeam.abbreviation : homeTeam.abbreviation} ball security advantage` : null
            });

            // 3rd Down Conversions
            if (awayStats['3rd_down_efficiency'] && homeStats['3rd_down_efficiency']) {
                analysis.push({
                    category: "3rd Down Conversions",
                    away: awayStats['3rd_down_efficiency'],
                    home: homeStats['3rd_down_efficiency'],
                    advantage: null
                });
            }

            // Time of Possession
            if (awayStats.possession && homeStats.possession) {
                analysis.push({
                    category: "Time of Possession",
                    away: awayStats.possession,
                    home: homeStats.possession,
                    advantage: null
                });
            }

            return analysis;
        }

        // Calculate AI win prediction
        function calculateWinPrediction(awayStats, homeStats, awayTeam, homeTeam) {
            if (!awayStats || !homeStats) {
                return {
                    winnerTeam: awayTeam,
                    confidence: 50,
                    factors: ["Insufficient data for analysis"],
                    reasoning: "Game data not available for prediction"
                };
            }

            let awayScore = 0;
            let homeScore = 0;
            const factors = [];

            // Yards per play (15 points)
            const awayYPP = parseFloat(awayStats.yards_per_play || '0');
            const homeYPP = parseFloat(homeStats.yards_per_play || '0');
            if (Math.abs(awayYPP - homeYPP) > 0.5) {
                if (awayYPP > homeYPP) {
                    awayScore += 15;
                    factors.push("Offensive efficiency");
                } else {
                    homeScore += 15;
                    factors.push("Offensive efficiency");
                }
            }

            // Total yards (10 points)
            const awayYards = parseInt(awayStats.total_yards || '0');
            const homeYards = parseInt(homeStats.total_yards || '0');
            if (Math.abs(awayYards - homeYards) > 50) {
                if (awayYards > homeYards) {
                    awayScore += 10;
                    factors.push("Total yards");
                } else {
                    homeScore += 10;
                    factors.push("Total yards");
                }
            }

            // Turnovers (25 points - most important)
            const awayTurnovers = parseInt(awayStats.turnovers || '0');
            const homeTurnovers = parseInt(homeStats.turnovers || '0');
            if (awayTurnovers !== homeTurnovers) {
                if (awayTurnovers < homeTurnovers) {
                    awayScore += 25;
                    factors.push("Turnover differential");
                } else {
                    homeScore += 25;
                    factors.push("Turnover differential");
                }
            }

            // Red zone efficiency (20 points)
            const awayRZ = awayStats['red_zone_(made-att)'];
            const homeRZ = homeStats['red_zone_(made-att)'];
            if (awayRZ && homeRZ) {
                const awayRZPct = calculateRedZonePercentage(awayRZ);
                const homeRZPct = calculateRedZonePercentage(homeRZ);
                if (Math.abs(awayRZPct - homeRZPct) > 20) {
                    if (awayRZPct > homeRZPct) {
                        awayScore += 20;
                        factors.push("Red zone efficiency");
                    } else {
                        homeScore += 20;
                        factors.push("Red zone efficiency");
                    }
                }
            }

            // Calculate winner and confidence
            const totalScore = awayScore + homeScore;
            const winnerIsAway = awayScore > homeScore;
            const winnerScore = Math.max(awayScore, homeScore);

            // Calculate confidence (55-95% range)
            let confidence = 50;
            if (totalScore > 0) {
                confidence = Math.min(95, Math.max(55, 50 + (winnerScore / 70) * 45));
            }

            const reasoning = factors.length > 0 ?
                `Based on statistical advantages in ${factors.join(', ').toLowerCase()}` :
                "Statistical analysis shows a close matchup";

            return {
                winnerTeam: winnerIsAway ? awayTeam : homeTeam,
                confidence: Math.round(confidence),
                factors: factors.length > 0 ? factors : ["Statistical analysis"],
                reasoning: reasoning
            };
        }

        // Helper function to calculate red zone percentage
        function calculateRedZonePercentage(rzString) {
            if (!rzString || !rzString.includes('-')) return 0;
            const [made, attempts] = rzString.split('-').map(n => parseInt(n));
            return attempts > 0 ? (made / attempts) * 100 : 0;
        }

        // Fallback display for unavailable games
        function createFallbackGameDisplay(awayTeam, homeTeam, userPick, error) {
            return `
                <div class="space-y-6">
                    <div class="text-center bg-slate-50 rounded-lg p-6 border border-slate-200">
                        <div class="text-lg font-semibold text-slate-700 mb-4">Game Data Unavailable</div>
                        <div class="text-2xl font-bold text-slate-800 mb-2">${awayTeam} @ ${homeTeam}</div>
                        <div class="text-sm text-slate-500">${error || 'ESPN data not available'}</div>
                    </div>

                    ${userPick ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">üéØ Your Pick</h3>
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-lg font-bold">
                                ${userPick.confidence}
                            </div>
                            <div>
                                <div class="font-bold text-blue-800 text-lg">${userPick.team}</div>
                                <div class="text-blue-600 text-sm">Confidence Pick</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="text-center p-8">
                        <div class="text-slate-500 mb-4">üìä Statistical analysis will be available when game data loads</div>
                        <button onclick="closeLiveGameModal()" class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
        }

        // Testing functions
        window.testModalWithMockData = function() {
            console.log('üß™ Testing modal with mock data');
            // Use mock data instead of real API
            openLiveGameModal('test1', '401772725', 'JAX', 'CIN');
        };

        window.testModalWithRealESPN = function() {
            console.log('üß™ Testing modal with real ESPN API');
            openLiveGameModal('test2', '401772919', 'ATL', 'MIN');
        };

        window.testErrorHandling = function() {
            console.log('üß™ Testing error handling');
            openLiveGameModal('test3', 'invalid-id', 'TEST', 'ERROR');
        };

        window.testUserPickIntegration = function() {
            console.log('üß™ Testing user pick integration');
            openLiveGameModal('test4', '401772836', 'PHI', 'KC');
        };

        // Close modal when clicking outside
        document.getElementById('live-game-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLiveGameModal();
            }
        });

        console.log('‚úÖ MODAiL THE NERD - Modal System Ready!');
    </script>
</body>
</html>