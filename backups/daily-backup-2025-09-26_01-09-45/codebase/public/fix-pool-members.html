<!DOCTYPE html>
<html>
<head>
    <title>Fix Pool Members</title>
</head>
<body>
    <h1>Fix Pool Members Document</h1>
    <div id="status">Loading...</div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDAF1MbAhL2uPIVUGMDlXvCqtknUUCX5Gw",
            authDomain: "nerdfootball.firebaseapp.com",
            databaseURL: "https://nerdfootball-default-rtdb.firebaseio.com",
            projectId: "nerdfootball",
            storageBucket: "nerdfootball.appspot.com",
            messagingSenderId: "969304790725",
            appId: "1:969304790725:web:892df38db0b0e62bde02ac"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            const statusDiv = document.getElementById('status');

            if (user && user.uid === 'WxSPmEildJdqs6T5hIpBUZrscwt2') {
                statusDiv.innerHTML = `<p>‚úÖ Authenticated as Tony: ${user.uid}</p>`;

                try {
                    // First, verify we can access basic authenticated data
                    const userPath = `artifacts/nerdfootball/public/data/nerdfootball_users/${user.uid}`;
                    const userRef = doc(db, userPath);
                    console.log('üîç Testing basic user data access...');

                    try {
                        const userDoc = await getDoc(userRef);
                        if (userDoc.exists()) {
                            statusDiv.innerHTML += `<p>‚úÖ Can access user data: ${userDoc.data().displayName || 'Unknown'}</p>`;
                        } else {
                            statusDiv.innerHTML += `<p>‚ö†Ô∏è User document doesn't exist, but we can read</p>`;
                        }
                    } catch (userError) {
                        statusDiv.innerHTML += `<p>‚ùå Can't read user data: ${userError.message}</p>`;
                        console.error('User data access failed:', userError);
                    }

                    const poolMembersPath = 'artifacts/nerdfootball/pools/nerduniverse-2025/metadata/members';
                    const membersRef = doc(db, poolMembersPath);

                    console.log('üîç Checking pool members document...');
                    const membersDoc = await getDoc(membersRef);

                    if (membersDoc.exists()) {
                        const currentMembers = membersDoc.data();
                        console.log('üìã Current pool members:', Object.keys(currentMembers));

                        if (!currentMembers[user.uid]) {
                            console.log('‚ûï Adding Tony to pool members...');
                            const updatedMembers = {
                                ...currentMembers,
                                [user.uid]: {
                                    displayName: "Tony Weeg",
                                    email: user.email,
                                    role: "admin",
                                    joinedAt: new Date().toISOString(),
                                    participation: {
                                        confidence: true,
                                        survivor: true
                                    }
                                }
                            };

                            await setDoc(membersRef, updatedMembers);
                            statusDiv.innerHTML += `<p>‚úÖ Added Tony to pool members!</p>`;
                        } else {
                            statusDiv.innerHTML += `<p>‚úÖ Tony already in pool members</p>`;
                            console.log('‚úÖ Tony already exists in pool:', currentMembers[user.uid]);
                        }
                    } else {
                        console.log('‚ûï Creating new pool members document...');
                        const newPoolMembers = {
                            [user.uid]: {
                                displayName: "Tony Weeg",
                                email: user.email,
                                role: "admin",
                                joinedAt: new Date().toISOString(),
                                participation: {
                                    confidence: true,
                                    survivor: true
                                }
                            }
                        };

                        await setDoc(membersRef, newPoolMembers);
                        statusDiv.innerHTML += `<p>‚úÖ Created pool members document with Tony!</p>`;
                    }

                    statusDiv.innerHTML += `<p>üéØ Now try the grid: <a href="/nerd-universe-grid.html">Grid</a></p>`;

                } catch (error) {
                    console.error('‚ùå Error fixing pool members:', error);
                    statusDiv.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                }
            } else {
                statusDiv.innerHTML = '<p>‚ùå Please log in as Tony to fix pool members</p>';
            }
        });
    </script>
</body>
</html>